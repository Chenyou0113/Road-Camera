<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½å¤©æ°£é å ± | Pro Version</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #009688;
            --bg-body: #f0f4f8;
            --bg-card: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --rain-color: #3b82f6;
        }
        body.dark-mode {
            --primary: #2dd4bf;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --rain-color: #60a5fa;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 40px; }
        
        header { background: var(--primary); color: white; padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .back-btn { color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .control-panel { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 200px; }
        .input-group label { font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; margin-top: 5px; background: var(--bg-card); color: var(--text-main); }
        
        .forecast-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        
        .card { background: var(--bg-card); padding: 15px; border-radius: 12px; box-shadow: var(--shadow); text-align: center; position: relative; overflow: hidden; animation: fadeIn 0.5s ease; }
        .card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--primary); }
        .card.is-night { background: #e2e8f0; }
        body.dark-mode .card.is-night { background: #334155; }
        
        .card-date { font-size: 0.85rem; color: var(--text-sub); }
        .card-time { font-weight: bold; margin-bottom: 10px; display: block; font-size: 0.95rem; }
        .card-icon { font-size: 2.5rem; margin: 10px 0; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .card-desc { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 5px; min-height: 2.8em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-temp { font-size: 1.4rem; font-weight: 700; color: var(--primary); margin: 8px 0; }
        .card-rain { font-size: 0.85rem; color: var(--rain-color); display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: 500; }
        
        .status-msg { grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-sub); font-size: 1.1rem; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <h1 style="margin:0; font-size:1.2rem;"><i class="fas fa-cloud-sun"></i> å¤©æ°£é å ± Pro</h1>
        <a href="index.html" class="back-btn">å›é¦–é </a>
    </header>

    <div class="container">
        <div class="control-panel">
            <div class="input-group">
                <label>é å ±æ¨¡å¼</label>
                <select id="datasetSelect">
                    <option value="F-D0047-091" selected>ğŸ“† æœªä¾†ä¸€é€± (é„‰é® 12h)</option>
                    <option value="F-D0047-089">ğŸ•’ æœªä¾†ä¸‰å¤© (æ¯3å°æ™‚)</option>
                    <option value="F-C0032-001">ğŸ‡¹ğŸ‡¼ 36 å°æ™‚ (ç¸£å¸‚)</option>
                </select>
            </div>
            <div class="input-group">
                <label>åœ°é»</label>
                <select id="locationSelect" disabled><option>è¼‰å…¥ä¸­...</option></select>
            </div>
        </div>

        <div id="forecastGrid" class="forecast-grid">
            <div class="status-msg">æº–å‚™è¼‰å…¥è³‡æ–™...</div>
        </div>
        <div id="lastUpdate" style="text-align:center; margin-top:20px; color:#888; font-size:0.8rem;"></div>
    </div>

    <script>
        const WORKER_URL = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev';

        // å°ç£ç¸£å¸‚æ¨™æº–æ’åº (åŒ— -> ä¸­ -> å— -> æ± -> é›¢å³¶)
        const CITY_ORDER = [
            'åŸºéš†å¸‚', 'è‡ºåŒ—å¸‚', 'æ–°åŒ—å¸‚', 'æ¡ƒåœ’å¸‚', 'æ–°ç«¹å¸‚', 'æ–°ç«¹ç¸£', 'è‹—æ —ç¸£',
            'è‡ºä¸­å¸‚', 'å½°åŒ–ç¸£', 'å—æŠ•ç¸£', 'é›²æ—ç¸£', 'å˜‰ç¾©å¸‚', 'å˜‰ç¾©ç¸£',
            'è‡ºå—å¸‚', 'é«˜é›„å¸‚', 'å±æ±ç¸£',
            'å®œè˜­ç¸£', 'èŠ±è“®ç¸£', 'è‡ºæ±ç¸£',
            'æ¾æ¹–ç¸£', 'é‡‘é–€ç¸£', 'é€£æ±Ÿç¸£'
        ];

        const App = {
            currentData: [],
            
            init() {
                if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
                
                document.getElementById('datasetSelect').addEventListener('change', () => this.fetchData());
                document.getElementById('locationSelect').addEventListener('change', () => this.render());
                
                this.fetchData();
            },

            async fetchData() {
                const dataset = document.getElementById('datasetSelect').value;
                const grid = document.getElementById('forecastGrid');
                const locSelect = document.getElementById('locationSelect');
                
                grid.innerHTML = '<div class="status-msg"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨é€£ç·šæ°£è±¡è³‡æ–™åº«...</div>';
                locSelect.disabled = true;

                try {
                    const res = await fetch(`${WORKER_URL}?dataset=${dataset}`);
                    const json = await res.json();

                    this.currentData = DataParser.parse(json);

                    if (this.currentData.length === 0) {
                        throw new Error("API å›å‚³çµæ§‹ä¸ç¬¦æˆ–ç„¡è³‡æ–™");
                    }

                    // *** æ’åºé‚è¼¯ ***
                    this.currentData.sort((a, b) => {
                        const idxA = CITY_ORDER.indexOf(a.name);
                        const idxB = CITY_ORDER.indexOf(b.name);
                        // å¦‚æœéƒ½åœ¨æ¸…å–®å…§ï¼Œç…§æ¸…å–®é †åºï¼›å¦‚æœä¸åœ¨æ¸…å–®å…§ï¼Œæ’åˆ°æœ€å¾Œ
                        if (idxA === -1 && idxB === -1) return a.name.localeCompare(b.name);
                        if (idxA === -1) return 1;
                        if (idxB === -1) return -1;
                        return idxA - idxB;
                    });

                    // å¡«å…¥é¸å–®
                    locSelect.innerHTML = '';
                    this.currentData.forEach((loc, idx) => {
                        const opt = document.createElement('option');
                        opt.value = idx;
                        opt.textContent = loc.name;
                        locSelect.appendChild(opt);
                    });

                    // é è¨­é¸å–å°åŒ—
                    let defIdx = this.currentData.findIndex(l => l.name.includes('è‡ºåŒ—') || l.name.includes('å°åŒ—'));
                    locSelect.value = (defIdx !== -1) ? defIdx : 0;
                    locSelect.disabled = false;

                    this.render();

                } catch (e) {
                    console.error(e);
                    grid.innerHTML = `<div class="status-msg" style="color:red"><i class="fas fa-exclamation-circle"></i> è®€å–å¤±æ•—ï¼š${e.message}</div>`;
                }
            },

            render() {
                const idx = document.getElementById('locationSelect').value;
                const loc = this.currentData[idx];
                const grid = document.getElementById('forecastGrid');

                if (!loc) return;

                const wx = this.findEl(loc.elements, ['å¤©æ°£ç¾è±¡', 'Wx', 'WeatherDescription', 'Weather']);
                const minT = this.findEl(loc.elements, ['æœ€ä½æº«åº¦', 'MinT', 'MinTemperature', 'æº«åº¦', 'Temperature']);
                const maxT = this.findEl(loc.elements, ['æœ€é«˜æº«åº¦', 'MaxT', 'MaxTemperature', 'æº«åº¦', 'Temperature']);
                const pop = this.findEl(loc.elements, ['12å°æ™‚é™é›¨æ©Ÿç‡', '3å°æ™‚é™é›¨æ©Ÿç‡', 'PoP', 'ProbabilityOfPrecipitation', 'é™æ°´æ©Ÿç‡']);

                if (!wx || !wx.time || wx.time.length === 0) {
                    grid.innerHTML = '<div class="status-msg">æ­¤åœ°é»ç„¡å°æ‡‰çš„å¤©æ°£é å ±è³‡æ–™ (æ¬„ä½å°æ‡‰å¤±æ•—)</div>';
                    return;
                }

                let html = '';
                
                for (let i = 0; i < wx.time.length; i++) {
                    const timeObj = wx.time[i];
                    
                    const startTime = timeObj.startTime || timeObj.dataTime;
                    const endTime = timeObj.endTime;
                    
                    const weatherText = this.getValue(timeObj);
                    let tMin = minT ? this.getValue(minT.time[i]) : '--';
                    let tMax = maxT ? this.getValue(maxT.time[i]) : tMin;
                    const rain = pop ? this.getValue(pop.time[i]) : '--';

                    // 3å°æ™‚é å ±è£œé½Š
                    if(tMax === '--' && tMin !== '--') tMax = tMin;
                    if(tMin === '--' && tMax !== '--') tMin = tMax;

                    if (tMin === '--' && weatherText === '--') continue;

                    html += this.buildCard(startTime, endTime, weatherText, tMin, tMax, rain);
                }
                
                grid.innerHTML = html || '<div class="status-msg">ç„¡æœ‰æ•ˆé å ±æ•¸æ“š</div>';
                document.getElementById('lastUpdate').innerText = 'æœ€å¾Œæ›´æ–°: ' + new Date().toLocaleTimeString();
            },

            findEl(list, names) {
                if (!list) return null;
                for (const name of names) {
                    const found = list.find(e => e.elementName === name);
                    if (found) return found;
                }
                return null;
            },

            getValue(timeBlock) {
                if (!timeBlock) return '--';
                if (timeBlock.elementValue && timeBlock.elementValue.length > 0) {
                    const obj = timeBlock.elementValue[0];
                    for (const key in obj) {
                        if (!key.endsWith('Code') && !key.endsWith('Unit') && !key.endsWith('Measures')) {
                            return obj[key];
                        }
                    }
                    return Object.values(obj)[0];
                }
                if (timeBlock.parameter) {
                    return timeBlock.parameter.parameterName;
                }
                return '--';
            },

            buildCard(start, end, weather, min, max, rain) {
                const dateObj = new Date(start);
                const month = dateObj.getMonth() + 1;
                const date = dateObj.getDate();
                const day = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][dateObj.getDay()];
                
                let timeStr = day;
                let isNight = false;
                const h1 = new Date(start).getHours();

                if (end) {
                    const h2 = new Date(end).getHours();
                    timeStr += ` <span style="font-size:0.85em; font-weight:normal;">${h1}~${h2}æ™‚</span>`;
                    if (h1 >= 18 || h1 < 6) isNight = true;
                } else {
                    timeStr += ` <span style="font-size:0.85em; font-weight:normal;">${h1}:00</span>`;
                    if (h1 >= 18 || h1 < 6) isNight = true;
                }

                let icon = '<i class="fas fa-cloud"></i>';
                if (weather.includes('æ™´')) icon = '<i class="fas fa-sun" style="color:orange"></i>';
                if (weather.includes('é›¨')) icon = '<i class="fas fa-umbrella" style="color:#60a5fa"></i>';
                if (weather.includes('å¤šé›²') && weather.includes('æ™´')) icon = '<i class="fas fa-cloud-sun" style="color:#fbbf24"></i>';
                
                let rainHtml = '';
                if (rain && rain !== '--' && rain !== ' ' && rain !== 'null') {
                    rainHtml = `<div class="card-rain"><i class="fas fa-tint"></i> ${rain}%</div>`;
                } else {
                    rainHtml = `<div class="card-rain" style="visibility:hidden">-</div>`;
                }

                let tempHtml = `<div class="card-temp">${min}Â° - ${max}Â°</div>`;
                if(min == max) tempHtml = `<div class="card-temp">${min}Â°</div>`;

                return `
                <div class="card ${isNight ? 'is-night' : ''}">
                    <div class="card-date">${month}/${date}</div>
                    <span class="card-time">${timeStr}</span>
                    <div class="card-icon">${icon}</div>
                    <div class="card-desc">${weather}</div>
                    ${tempHtml}
                    ${rainHtml}
                </div>
                `;
            }
        };

        const DataParser = {
            parse(json) {
                let rawList = [];

                if (json?.records?.Locations) {
                    const root = json.records.Locations[0];
                    rawList = root.Location || root.location;
                } 
                else if (json?.records?.location) {
                    rawList = json.records.location;
                }
                else if (json?.cwaopendata?.dataset?.location) {
                    rawList = json.cwaopendata.dataset.location;
                }

                if (!Array.isArray(rawList)) return [];

                return rawList.map(item => {
                    const name = item.locationName || item.LocationName;
                    let rawEls = item.weatherElement || item.WeatherElement || [];
                    
                    const normEls = rawEls.map(el => {
                        const rawTimes = el.Time || el.time || [];
                        return {
                            elementName: el.elementName || el.ElementName,
                            time: rawTimes.map(t => ({
                                startTime: t.StartTime || t.startTime,
                                endTime: t.EndTime || t.endTime,
                                dataTime: t.DataTime || t.dataTime,
                                elementValue: t.ElementValue || t.elementValue,
                                parameter: t.Parameter || t.parameter
                            }))
                        };
                    });

                    return { name: name, elements: normEls };
                });
            }
        };

        App.init();
    </script>
</body>
</html>