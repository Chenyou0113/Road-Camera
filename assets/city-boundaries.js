// 台灣縣市界線判斷 - 基於 TWD97 經緯度
// 資料來源: 內政部國土測繪中心

/**
 * 判斷座標點是否在多邊形內 (Ray Casting Algorithm)
 * @param {Array} point - [經度, 緯度]
 * @param {Array} polygon - 多邊形頂點陣列 [[lon1, lat1], [lon2, lat2], ...]
 * @returns {boolean}
 */
function isPointInPolygon(point, polygon) {
    const [x, y] = point;
    let inside = false;
    
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
        const [xi, yi] = polygon[i];
        const [xj, yj] = polygon[j];
        
        const intersect = ((yi > y) !== (yj > y)) &&
            (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        
        if (intersect) inside = !inside;
    }
    
    return inside;
}

/**
 * 台灣各縣市的簡化邊界多邊形 (TWD97 經緯度)
 * 使用凸包算法簡化的邊界點
 */
const CITY_BOUNDARIES = {
    '基隆市': {
        priority: 1,
        bbox: { lonMin: 121.65, lonMax: 121.82, latMin: 25.10, latMax: 25.25 },
        polygon: [
            [121.68, 25.24], [121.78, 25.20], [121.80, 25.15],
            [121.78, 25.11], [121.70, 25.10], [121.65, 25.13],
            [121.66, 25.18], [121.68, 25.24]
        ]
    },
    '台北市': {
        priority: 2,
        bbox: { lonMin: 121.45, lonMax: 121.65, latMin: 24.95, latMax: 25.20 },
        polygon: [
            [121.46, 25.19], [121.58, 25.20], [121.64, 25.10],
            [121.62, 25.00], [121.56, 24.96], [121.47, 24.96],
            [121.45, 25.05], [121.46, 25.19]
        ]
    },
    '宜蘭縣': {
        priority: 1,
        bbox: { lonMin: 121.55, lonMax: 122.05, latMin: 24.30, latMax: 25.00 },
        polygon: [
            [121.58, 24.98], [121.72, 24.95], [121.85, 24.85],
            [121.95, 24.70], [122.00, 24.55], [121.98, 24.40],
            [121.90, 24.32], [121.75, 24.30], [121.60, 24.35],
            [121.55, 24.50], [121.56, 24.75], [121.58, 24.98]
        ]
    },
    '新北市': {
        priority: 3,
        bbox: { lonMin: 121.20, lonMax: 121.95, latMin: 24.60, latMax: 25.30 },
        polygon: [
            [121.30, 25.28], [121.45, 25.30], [121.65, 25.25],
            [121.78, 25.20], [121.82, 25.10], [121.75, 24.98],
            [121.65, 24.85], [121.55, 24.75], [121.45, 24.70],
            [121.35, 24.65], [121.25, 24.62], [121.20, 24.68],
            [121.22, 24.85], [121.25, 25.05], [121.28, 25.20],
            [121.30, 25.28]
        ]
    },
    '桃園市': {
        priority: 2,
        bbox: { lonMin: 121.00, lonMax: 121.50, latMin: 24.65, latMax: 25.10 },
        polygon: [
            [121.05, 25.08], [121.25, 25.10], [121.45, 25.05],
            [121.48, 24.95], [121.45, 24.80], [121.35, 24.68],
            [121.20, 24.65], [121.05, 24.68], [121.00, 24.80],
            [121.02, 24.95], [121.05, 25.08]
        ]
    },
    '新竹市': {
        priority: 1,
        bbox: { lonMin: 120.90, lonMax: 121.05, latMin: 24.75, latMax: 24.90 },
        polygon: [
            [120.92, 24.88], [121.03, 24.87], [121.04, 24.80],
            [120.98, 24.76], [120.91, 24.77], [120.90, 24.82],
            [120.92, 24.88]
        ]
    },
    '新竹縣': {
        priority: 2,
        bbox: { lonMin: 120.75, lonMax: 121.35, latMin: 24.40, latMax: 25.00 },
        polygon: [
            [120.80, 24.95], [121.00, 25.00], [121.20, 24.95],
            [121.30, 24.80], [121.32, 24.60], [121.25, 24.45],
            [121.10, 24.40], [120.90, 24.42], [120.78, 24.50],
            [120.75, 24.65], [120.78, 24.85], [120.80, 24.95]
        ]
    },
    '苗栗縣': {
        priority: 2,
        bbox: { lonMin: 120.55, lonMax: 121.20, latMin: 24.20, latMax: 24.75 },
        polygon: [
            [120.60, 24.72], [120.85, 24.75], [121.10, 24.70],
            [121.18, 24.55], [121.15, 24.35], [121.00, 24.22],
            [120.80, 24.20], [120.62, 24.25], [120.55, 24.40],
            [120.58, 24.60], [120.60, 24.72]
        ]
    },
    '台中市': {
        priority: 2,
        bbox: { lonMin: 120.45, lonMax: 121.30, latMin: 24.00, latMax: 24.55 },
        polygon: [
            [120.50, 24.52], [120.75, 24.55], [121.05, 24.50],
            [121.25, 24.35], [121.28, 24.15], [121.20, 24.02],
            [120.95, 24.00], [120.70, 24.05], [120.50, 24.15],
            [120.45, 24.30], [120.48, 24.45], [120.50, 24.52]
        ]
    },
    '彰化縣': {
        priority: 2,
        bbox: { lonMin: 120.30, lonMax: 120.80, latMin: 23.80, latMax: 24.30 },
        polygon: [
            [120.35, 24.28], [120.55, 24.30], [120.75, 24.20],
            [120.78, 24.05], [120.72, 23.88], [120.55, 23.82],
            [120.35, 23.85], [120.30, 24.00], [120.32, 24.18],
            [120.35, 24.28]
        ]
    },
    '南投縣': {
        priority: 2,
        bbox: { lonMin: 120.60, lonMax: 121.30, latMin: 23.45, latMax: 24.30 },
        polygon: [
            [120.70, 24.25], [121.05, 24.28], [121.25, 24.15],
            [121.28, 23.95], [121.22, 23.70], [121.10, 23.50],
            [120.90, 23.48], [120.68, 23.55], [120.60, 23.75],
            [120.65, 24.00], [120.70, 24.25]
        ]
    },
    '雲林縣': {
        priority: 2,
        bbox: { lonMin: 120.10, lonMax: 120.70, latMin: 23.40, latMax: 23.90 },
        polygon: [
            [120.15, 23.88], [120.40, 23.90], [120.65, 23.82],
            [120.68, 23.65], [120.60, 23.45], [120.38, 23.42],
            [120.15, 23.48], [120.10, 23.65], [120.15, 23.88]
        ]
    },
    '嘉義市': {
        priority: 1,
        bbox: { lonMin: 120.40, lonMax: 120.50, latMin: 23.45, latMax: 23.53 },
        polygon: [
            [120.42, 23.52], [120.48, 23.52], [120.49, 23.48],
            [120.46, 23.46], [120.41, 23.46], [120.40, 23.49],
            [120.42, 23.52]
        ]
    },
    '嘉義縣': {
        priority: 2,
        bbox: { lonMin: 120.10, lonMax: 120.80, latMin: 23.10, latMax: 23.70 },
        polygon: [
            [120.15, 23.68], [120.45, 23.70], [120.75, 23.62],
            [120.78, 23.40], [120.70, 23.18], [120.50, 23.12],
            [120.25, 23.15], [120.12, 23.28], [120.10, 23.45],
            [120.15, 23.68]
        ]
    },
    '台南市': {
        priority: 2,
        bbox: { lonMin: 120.00, lonMax: 120.70, latMin: 22.80, latMax: 23.50 },
        polygon: [
            [120.05, 23.45], [120.35, 23.48], [120.65, 23.40],
            [120.68, 23.20], [120.60, 22.95], [120.45, 22.82],
            [120.20, 22.85], [120.05, 23.00], [120.02, 23.25],
            [120.05, 23.45]
        ]
    },
    '高雄市': {
        priority: 2,
        bbox: { lonMin: 120.15, lonMax: 121.00, latMin: 22.40, latMax: 23.20 },
        polygon: [
            [120.20, 23.18], [120.50, 23.20], [120.78, 23.10],
            [120.95, 22.85], [120.98, 22.60], [120.90, 22.45],
            [120.65, 22.42], [120.40, 22.48], [120.22, 22.65],
            [120.18, 22.90], [120.20, 23.18]
        ]
    },
    '屏東縣': {
        priority: 2,
        bbox: { lonMin: 120.25, lonMax: 121.00, latMin: 21.85, latMax: 22.85 },
        polygon: [
            [120.30, 22.82], [120.60, 22.85], [120.88, 22.75],
            [120.95, 22.50], [120.92, 22.20], [120.82, 21.92],
            [120.68, 21.88], [120.45, 21.95], [120.28, 22.15],
            [120.25, 22.45], [120.30, 22.82]
        ]
    },
    '花蓮縣': {
        priority: 1,
        bbox: { lonMin: 121.15, lonMax: 121.75, latMin: 23.00, latMax: 24.50 },
        polygon: [
            [121.20, 24.45], [121.45, 24.48], [121.68, 24.35],
            [121.72, 24.10], [121.68, 23.80], [121.60, 23.50],
            [121.52, 23.20], [121.45, 23.05], [121.35, 23.02],
            [121.22, 23.10], [121.18, 23.35], [121.20, 23.75],
            [121.22, 24.15], [121.20, 24.45]
        ]
    },
    '台東縣': {
        priority: 2,
        bbox: { lonMin: 120.90, lonMax: 121.65, latMin: 22.30, latMax: 23.60 },
        polygon: [
            [121.00, 23.55], [121.30, 23.58], [121.52, 23.45],
            [121.62, 23.15], [121.60, 22.80], [121.50, 22.50],
            [121.35, 22.35], [121.10, 22.32], [120.95, 22.45],
            [120.92, 22.75], [120.95, 23.10], [120.98, 23.40],
            [121.00, 23.55]
        ]
    },
    '澎湖縣': {
        priority: 1,
        bbox: { lonMin: 119.50, lonMax: 119.75, latMin: 23.15, latMax: 23.75 },
        polygon: [
            [119.52, 23.72], [119.68, 23.73], [119.72, 23.60],
            [119.70, 23.40], [119.65, 23.20], [119.55, 23.18],
            [119.50, 23.35], [119.52, 23.60], [119.52, 23.72]
        ]
    },
    '金門縣': {
        priority: 1,
        bbox: { lonMin: 118.30, lonMax: 118.50, latMin: 24.35, latMax: 24.55 },
        polygon: [
            [118.32, 24.52], [118.45, 24.54], [118.48, 24.45],
            [118.42, 24.38], [118.33, 24.37], [118.30, 24.43],
            [118.32, 24.52]
        ]
    },
    '連江縣': {
        priority: 1,
        bbox: { lonMin: 119.90, lonMax: 120.50, latMin: 25.90, latMax: 26.40 },
        polygon: [
            [119.95, 26.35], [120.15, 26.38], [120.35, 26.20],
            [120.45, 26.00], [120.30, 25.95], [120.10, 26.05],
            [119.92, 26.18], [119.95, 26.35]
        ]
    }
};

/**
 * 根據經緯度座標判斷縣市
 * @param {number} lon - 經度
 * @param {number} lat - 緯度
 * @param {string} roadName - 路線名稱 (可選，用於輔助判斷)
 * @returns {string} 縣市名稱
 */
function getCityFromCoordinates(lon, lat, roadName = '') {
    if (!lon || !lat || isNaN(lon) || isNaN(lat)) {
        return '未知';
    }

    const point = [lon, lat];
    const candidates = [];

    // 先用 bounding box 快速篩選可能的縣市
    for (const [cityName, cityData] of Object.entries(CITY_BOUNDARIES)) {
        const { bbox } = cityData;
        if (lon >= bbox.lonMin && lon <= bbox.lonMax &&
            lat >= bbox.latMin && lat <= bbox.latMax) {
            candidates.push({ name: cityName, ...cityData });
        }
    }

    // 如果沒有候選縣市，返回未知
    if (candidates.length === 0) {
        return '未知';
    }

    // 按優先級排序 (priority 越小越優先)
    candidates.sort((a, b) => a.priority - b.priority);

    // 使用多邊形判斷
    for (const candidate of candidates) {
        if (isPointInPolygon(point, candidate.polygon)) {
            return candidate.name;
        }
    }

    // 如果多邊形判斷都失敗，返回第一個候選縣市 (最小 bbox 的)
    return candidates[0].name;
}

// 導出函數供其他模組使用
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { getCityFromCoordinates, isPointInPolygon, CITY_BOUNDARIES };
}
