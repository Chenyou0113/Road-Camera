<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€é€±å¤©æ°£é å ± | è‡ºç£å¤©æ°£è¦–ç•Œ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* å…±ç”¨è®Šæ•¸èˆ‡ä¸»é¡Œ */
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-color: #2196F3;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        body.dark-mode {
            --bg-color: #1a1a2e;
            --card-bg: #2d2d44;
            --text-primary: #e0e0e0;
            --text-secondary: #aaaaaa;
            --accent-color: #64B5F6;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-primary); margin: 0; padding: 0; min-height: 100vh; }
        
        /* å°è¦½åˆ— */
        header { background: linear-gradient(135deg, #1976D2, #1565C0); color: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .back-btn { background: rgba(255,255,255,0.2); color: white; text-decoration: none; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; transition: background 0.3s; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        /* ä¸»å®¹å™¨ */
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        /* é å ±å¡ç‰‡ç¶²æ ¼ */
        .forecast-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .card-header { background: var(--accent-color); color: white; padding: 15px; font-size: 1.2rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 15px; }
        
        .time-slot { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding: 12px 0; }
        .time-slot:last-child { border-bottom: none; }
        .time-label { font-size: 0.9rem; color: var(--text-secondary); width: 80px; }
        .weather-icon { font-size: 1.8rem; width: 40px; text-align: center; }
        .temp-range { font-weight: bold; color: var(--text-primary); font-size: 1.1rem; }
        .rain-prob { font-size: 0.9rem; color: #2196F3; display: flex; align-items: center; gap: 4px; min-width: 50px; justify-content: flex-end; }
        
        /* è¼‰å…¥ä¸­èˆ‡éŒ¯èª¤ */
        .loading { text-align: center; padding: 50px; font-size: 1.2rem; color: var(--text-secondary); }
        .error { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; display: none; }

        @media (max-width: 768px) { .header-title { font-size: 1.2rem; } }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="header-title"><i class="fas fa-calendar-alt"></i> å…¨è‡ºå¤©æ°£é å ± (36å°æ™‚)</div>
            <a href="index.html" class="back-btn">â† è¿”å›é¦–é </a>
        </div>
    </header>

    <div class="container">
        <div id="error-msg" class="error"></div>
        <div id="loading" class="loading"><i class="fas fa-spinner fa-spin"></i> è³‡æ–™è¼‰å…¥ä¸­...</div>
        <div id="forecast-container" class="forecast-grid"></div>
    </div>

    <script>
        const API_URL = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev/?dataset=F-C0032-001';

        async function fetchData() {
            const container = document.getElementById('forecast-container');
            const loading = document.getElementById('loading');
            const errorEl = document.getElementById('error-msg');

            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const json = await response.json();
                
                // ğŸ”¥ è¬èƒ½è³‡æ–™è§£æé‚è¼¯
                let locations = [];
                
                // 1. æ¨™æº–æ ¼å¼ (records.location)
                if (json.records && json.records.location) {
                    locations = json.records.location;
                }
                // 2. è®Šé«”æ ¼å¼ (cwaopendata.dataset.location)
                else if (json.cwaopendata && json.cwaopendata.dataset && json.cwaopendata.dataset.location) {
                    locations = json.cwaopendata.dataset.location;
                }
                // 3. å®¹éŒ¯è™•ç†ï¼šå¯èƒ½æ˜¯å–®ä¸€ç‰©ä»¶
                if (!Array.isArray(locations) && locations) locations = [locations];

                if (locations.length === 0) throw new Error("API å›å‚³çµæ§‹ä¸ç¬¦æˆ–ç„¡è³‡æ–™");

                // æ’åºç¸£å¸‚ (åŒ—->å—->æ±->é›¢å³¶)
                const cityOrder = ["åŸºéš†å¸‚", "è‡ºåŒ—å¸‚", "æ–°åŒ—å¸‚", "æ¡ƒåœ’å¸‚", "æ–°ç«¹å¸‚", "æ–°ç«¹ç¸£", "è‹—æ —ç¸£", "è‡ºä¸­å¸‚", "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£", "å˜‰ç¾©å¸‚", "å˜‰ç¾©ç¸£", "è‡ºå—å¸‚", "é«˜é›„å¸‚", "å±æ±ç¸£", "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "è‡ºæ±ç¸£", "æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"];
                locations.sort((a, b) => {
                    let ia = cityOrder.indexOf(a.locationName);
                    let ib = cityOrder.indexOf(b.locationName);
                    if (ia === -1) ia = 999; if (ib === -1) ib = 999;
                    return ia - ib;
                });

                // æ¸²æŸ“
                container.innerHTML = locations.map(loc => renderCard(loc)).join('');
                loading.style.display = 'none';

            } catch (e) {
                console.error("Fetch Error:", e);
                loading.style.display = 'none';
                errorEl.textContent = `âš ï¸ ç„¡æ³•è¼‰å…¥é å ±è³‡æ–™: ${e.message}`;
                errorEl.style.display = 'block';
            }
        }

        function renderCard(loc) {
            // æ•´ç†å¤©æ°£å› å­
            // Wx: å¤©æ°£ç¾è±¡, MaxT: æœ€é«˜æº«, MinT: æœ€ä½æº«, PoP: é™é›¨æ©Ÿç‡
            const weather = {};
            loc.weatherElement.forEach(el => {
                weather[el.elementName] = el.time;
            });

            // ç”¢ç”Ÿ 3 å€‹æ™‚æ®µçš„ HTML
            const slotsHtml = weather.Wx.map((wx, index) => {
                const startTime = new Date(wx.startTime);
                const endTime = new Date(wx.endTime);
                
                // æ™‚é–“æ¨™ç±¤ (ä¾‹å¦‚ï¼šä»Šæ™šæ˜æ™¨ã€æ˜å¤©ç™½å¤©)
                const timeLabel = formatTimeSlot(startTime);
                
                // å–å¾—å°æ‡‰çš„æ•¸å€¼
                const pop = weather.PoP[index].parameter.parameterName;
                const minT = weather.MinT[index].parameter.parameterName;
                const maxT = weather.MaxT[index].parameter.parameterName;
                const wxText = wx.parameter.parameterName;
                const wxValue = parseInt(wx.parameter.parameterValue);

                return `
                    <div class="time-slot">
                        <div class="time-label">${timeLabel}<br><span style="font-size:0.8em; opacity:0.7">${formatHour(startTime)}-${formatHour(endTime)}</span></div>
                        <div class="weather-icon" title="${wxText}">${getWeatherIcon(wxValue)}</div>
                        <div class="temp-range">${minT}Â° - ${maxT}Â°C</div>
                        <div class="rain-prob"><i class="fas fa-umbrella"></i> ${pop}%</div>
                    </div>
                `;
            }).join('');

            return `
                <div class="card">
                    <div class="card-header">
                        <span>${loc.locationName}</span>
                        <i class="fas fa-map-marker-alt" style="opacity:0.7"></i>
                    </div>
                    <div class="card-body">
                        ${slotsHtml}
                    </div>
                </div>
            `;
        }

        function formatTimeSlot(date) {
            const h = date.getHours();
            if (h >= 5 && h < 18) return "ç™½å¤©";
            return "æ™šä¸Š";
        }

        function formatHour(date) {
            return date.getHours().toString().padStart(2, '0');
        }

        function getWeatherIcon(code) {
            if (code <= 3) return '<i class="fas fa-sun" style="color:orange"></i>'; // æ™´
            if (code <= 7) return '<i class="fas fa-cloud-sun" style="color:#fbc02d"></i>'; // å¤šé›²
            if (code <= 10) return '<i class="fas fa-cloud" style="color:gray"></i>'; // é™°
            if (code > 10) return '<i class="fas fa-cloud-rain" style="color:#42a5f5"></i>'; // é›¨
            return '<i class="fas fa-question"></i>';
        }

        // æ·±è‰²æ¨¡å¼åˆå§‹åŒ–
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }

        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>