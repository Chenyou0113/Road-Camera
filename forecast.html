<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½å¤©æ°£é å ± | Pro Version</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #009688;
            --bg-body: #f0f4f8;
            --bg-card: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        body.dark-mode {
            --primary: #2dd4bf;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
        }
        * { box-sizing: border-box; }
        body { font-family: sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 40px; }
        header { background: var(--primary); color: white; padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .control-panel { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 200px; }
        select { width: 100%; padding: 10px; border-radius: 6px; font-size: 16px; margin-top: 5px; }
        .forecast-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: var(--bg-card); padding: 15px; border-radius: 12px; box-shadow: var(--shadow); text-align: center; position: relative; overflow: hidden; }
        .card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--primary); }
        .card.is-night::before { background: #475569; } /* å¤œæ™šæ¨™ç¤º */
        .card-date { font-size: 0.85rem; color: var(--text-sub); }
        .card-time { font-weight: bold; margin-bottom: 10px; display: block; }
        .card-temp { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .card-desc { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 5px; min-height: 2.4em; }
        .card-rain { font-size: 0.85rem; color: #3b82f6; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .status-msg { grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-sub); }
        .back-btn { color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; }
    </style>
</head>
<body>

    <header>
        <h1 style="margin:0; font-size:1.2rem;"><i class="fas fa-cloud"></i> å¤©æ°£é å ± Pro</h1>
        <a href="index.html" class="back-btn">å›é¦–é </a>
    </header>

    <div class="container">
        <div class="control-panel">
            <div class="input-group">
                <label>é å ±æ¨¡å¼</label>
                <select id="datasetSelect">
                    <option value="F-D0047-091" selected>ğŸ“† æœªä¾†ä¸€é€± (é„‰é® 12h)</option>
                    <option value="F-D0047-089">ğŸ•’ æœªä¾†ä¸‰å¤© (æ¯3å°æ™‚)</option>
                    <option value="F-C0032-001">ğŸ‡¹ğŸ‡¼ 36 å°æ™‚ (ç¸£å¸‚)</option>
                </select>
            </div>
            <div class="input-group">
                <label>åœ°é»</label>
                <select id="locationSelect" disabled><option>è¼‰å…¥ä¸­...</option></select>
            </div>
        </div>

        <div id="forecastGrid" class="forecast-grid">
            <div class="status-msg">æº–å‚™è¼‰å…¥è³‡æ–™...</div>
        </div>
        <div id="lastUpdate" style="text-align:center; margin-top:20px; color:#888; font-size:0.8rem;"></div>
    </div>

    <script>
        // æ‚¨çš„ Worker URL
        const WORKER_URL = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev';

        const App = {
            currentData: [],
            
            init() {
                if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
                
                document.getElementById('datasetSelect').addEventListener('change', () => this.fetchData());
                document.getElementById('locationSelect').addEventListener('change', () => this.render());
                
                this.fetchData();
            },

            async fetchData() {
                const dataset = document.getElementById('datasetSelect').value;
                const grid = document.getElementById('forecastGrid');
                const locSelect = document.getElementById('locationSelect');
                
                grid.innerHTML = '<div class="status-msg"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨é€£ç·šæ°£è±¡è³‡æ–™åº«...</div>';
                locSelect.disabled = true;

                try {
                    const res = await fetch(`${WORKER_URL}?dataset=${dataset}`);
                    const json = await res.json();

                    // å‘¼å«è§£æå™¨
                    this.currentData = DataParser.parse(json);

                    if (this.currentData.length === 0) {
                        throw new Error("è§£æå¾Œç„¡è³‡æ–™ï¼Œè«‹æª¢æŸ¥ API å›å‚³");
                    }

                    // å¡«å…¥åœ°é»é¸å–®
                    locSelect.innerHTML = '';
                    this.currentData.forEach((loc, idx) => {
                        const opt = document.createElement('option');
                        opt.value = idx;
                        opt.textContent = loc.name;
                        locSelect.appendChild(opt);
                    });

                    // é è¨­é¸å°åŒ—æˆ–ç¬¬ä¸€å€‹
                    let defIdx = this.currentData.findIndex(l => l.name.includes('è‡ºåŒ—') || l.name.includes('å°åŒ—'));
                    locSelect.value = (defIdx !== -1) ? defIdx : 0;
                    locSelect.disabled = false;

                    this.render();

                } catch (e) {
                    console.error(e);
                    grid.innerHTML = `<div class="status-msg" style="color:red">è®€å–å¤±æ•—ï¼š${e.message}</div>`;
                }
            },

            render() {
                const idx = document.getElementById('locationSelect').value;
                const loc = this.currentData[idx];
                const grid = document.getElementById('forecastGrid');

                if (!loc) return;

                // 1. æŸ¥æ‰¾é—œéµå…ƒç´  (é‡å° F-D0047-091 çš„ä¸­æ–‡åç¨±)
                // é€™è£¡ä¸€å®šè¦åŒ…å« JSON è£¡å‡ºç¾éçš„ä¸­æ–‡ key
                const wx = this.findEl(loc.elements, ['å¤©æ°£ç¾è±¡', 'Wx', 'WeatherDescription', 'Weather']);
                const minT = this.findEl(loc.elements, ['æœ€ä½æº«åº¦', 'MinT', 'MinTemperature']);
                const maxT = this.findEl(loc.elements, ['æœ€é«˜æº«åº¦', 'MaxT', 'MaxTemperature']);
                const pop = this.findEl(loc.elements, ['12å°æ™‚é™é›¨æ©Ÿç‡', '3å°æ™‚é™é›¨æ©Ÿç‡', 'PoP', 'ProbabilityOfPrecipitation']);

                // 2. æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§ (é—œéµä¿®æ­£ï¼šæ”¹ç”¨ normalized 'time' å±¬æ€§)
                if (!wx || !wx.time || wx.time.length === 0) {
                    console.log("Debug Info:", { wx, minT, maxT });
                    grid.innerHTML = '<div class="status-msg">æ­¤åœ°é»ç„¡å°æ‡‰çš„å¤©æ°£é å ±è³‡æ–™ (æ¬„ä½å°æ‡‰å¤±æ•—)</div>';
                    return;
                }

                let html = '';
                // 3. ç”¢ç”Ÿå¡ç‰‡
                for (let i = 0; i < wx.time.length; i++) {
                    const timeObj = wx.time[i];
                    const startTime = timeObj.startTime || timeObj.dataTime;
                    const endTime = timeObj.endTime;
                    
                    const weatherText = this.getValue(timeObj);
                    const tMin = minT ? this.getValue(minT.time[i]) : '--';
                    const tMax = maxT ? this.getValue(maxT.time[i]) : tMin;
                    const rain = pop ? this.getValue(pop.time[i]) : '--';

                    if (tMin === '--' && tMax === '--') continue;

                    html += this.buildCard(startTime, endTime, weatherText, tMin, tMax, rain);
                }
                
                grid.innerHTML = html;
                document.getElementById('lastUpdate').innerText = 'æœ€å¾Œæ›´æ–°: ' + new Date().toLocaleTimeString();
            },

            // è¼”åŠ©æŸ¥æ‰¾å‡½æ•¸
            findEl(list, names) {
                if (!list) return null;
                for (const name of names) {
                    const found = list.find(e => e.elementName === name);
                    if (found) return found;
                }
                return null;
            },

            // è¼”åŠ©å–å€¼å‡½æ•¸ (éæ¿¾æ‰ Description, Code, Unit ç­‰é›œè¨Š)
            getValue(timeBlock) {
                if (!timeBlock) return '--';
                // å„ªå…ˆè™•ç† ElementValue (F-D0047)
                if (timeBlock.elementValue && timeBlock.elementValue[0]) {
                    const obj = timeBlock.elementValue[0];
                    for (const key in obj) {
                        // æ’é™¤ä¸æ˜¯æ•¸å€¼çš„æ¬„ä½
                        if (!key.endsWith('Code') && !key.endsWith('Unit') && !key.endsWith('Measures')) {
                            return obj[key];
                        }
                    }
                    // å¦‚æœåªå‰© Codeï¼Œåªå¥½å›å‚³ Code (ç•¶ä½œå‚™æ¡ˆ)
                    return Object.values(obj)[0];
                }
                // è™•ç† Parameter (F-C0032)
                if (timeBlock.parameter) return timeBlock.parameter.parameterName;
                return '--';
            },

            buildCard(start, end, weather, min, max, rain) {
                const dateObj = new Date(start);
                const month = dateObj.getMonth() + 1;
                const date = dateObj.getDate();
                const day = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][dateObj.getDay()];
                
                let timeStr = day;
                let isNight = false;

                // åˆ¤æ–·æ˜¯å¦ç‚ºæ™šä¸Šé å ±
                if (end) {
                    const h1 = new Date(start).getHours();
                    const h2 = new Date(end).getHours();
                    timeStr += ` <span style="font-size:0.8em">${h1}~${h2}æ™‚</span>`;
                    if (h1 >= 18 || h1 < 6) isNight = true;
                }

                // ç°¡å–®åœ–ç¤ºå°æ‡‰
                let icon = '<i class="fas fa-cloud"></i>';
                if (weather.includes('æ™´')) icon = '<i class="fas fa-sun" style="color:orange"></i>';
                if (weather.includes('é›¨')) icon = '<i class="fas fa-umbrella" style="color:#60a5fa"></i>';
                
                // é™é›¨é¡¯ç¤º
                let rainHtml = '';
                if (rain && rain !== '--' && rain !== ' ') {
                    rainHtml = `<div class="card-rain"><i class="fas fa-tint"></i> ${rain}%</div>`;
                } else {
                    rainHtml = `<div class="card-rain" style="opacity:0;">-</div>`;
                }

                return `
                <div class="card ${isNight ? 'is-night' : ''}">
                    <div class="card-date">${month}/${date}</div>
                    <span class="card-time">${timeStr}</span>
                    <div class="card-icon">${icon}</div>
                    <div class="card-desc">${weather}</div>
                    <div class="card-temp">${min}Â° - ${max}Â°</div>
                    ${rainHtml}
                </div>
                `;
            }
        };

        // ==========================================
        // æ ¸å¿ƒè§£æå™¨ (è³‡æ–™çµæ§‹æ­£è¦åŒ–)
        // ==========================================
        const DataParser = {
            parse(json) {
                let rawList = [];

                // 1. å˜—è©¦å¾ API å›å‚³çµæ§‹æŠ“å– Locations
                if (json?.records?.Locations) {
                    // F-D0047 çµæ§‹: records.Locations[0].Location
                    const locationData = json.records.Locations[0].Location || json.records.Locations[0].location;
                    if (locationData) rawList = locationData;
                } 
                else if (json?.records?.location) {
                    // F-C0032 çµæ§‹
                    rawList = json.records.location;
                }
                else if (json?.cwaopendata?.dataset?.location) {
                    // OpenData çµæ§‹
                    rawList = json.cwaopendata.dataset.location;
                }

                if (!Array.isArray(rawList)) return [];

                // 2. è³‡æ–™æ¸…æ´—èˆ‡æ­£è¦åŒ– (è§£æ±ºå¤§å°å¯«å•é¡Œ Time vs time)
                return rawList.map(item => {
                    // æŠ“å–åç¨±
                    const name = item.locationName || item.LocationName;
                    
                    // æŠ“å–ä¸¦æ­£è¦åŒ– WeatherElement
                    let rawEls = item.weatherElement || item.WeatherElement || [];
                    
                    // *** é—œéµä¿®æ­£ ***
                    // éæ­·æ‰€æœ‰å¤©æ°£å› å­ï¼Œå¼·åˆ¶æŠŠ Time å±¬æ€§è¤‡è£½ä¸€ä»½è®Šæˆ time (å°å¯«)
                    // é€™æ¨£å¾Œé¢çš„ç¨‹å¼ç¢¼ç”¨ .time å°±èƒ½è®€å–ï¼Œä¸ç”¨ç®¡å®ƒæ˜¯å¤§å¯«é‚„æ˜¯å°å¯«
                    const normEls = rawEls.map(el => {
                        return {
                            elementName: el.elementName || el.ElementName,
                            // å¦‚æœæœ‰ Time å°±ç”¨ Timeï¼Œæ²’æœ‰å°±æ‰¾ timeï¼Œä¸¦çµ±ä¸€å­˜æˆ time
                            time: (el.Time || el.time || []).map(t => ({
                                startTime: t.StartTime || t.startTime,
                                endTime: t.EndTime || t.endTime,
                                dataTime: t.DataTime || t.dataTime,
                                // çµ±ä¸€ ElementValue / parameter
                                elementValue: t.ElementValue || t.elementValue,
                                parameter: t.Parameter || t.parameter
                            }))
                        };
                    });

                    return { name: name, elements: normEls };
                });
            }
        };

        App.init();
    </script>
</body>
</html>