<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°å¤©æ°£å„€è¡¨æ¿</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 1em;
            color: #666;
            font-weight: 500;
        }

        .stat-value {
            font-size: 1.8em;
            color: #667eea;
            font-weight: bold;
            min-width: 120px;
            text-align: right;
        }

        #map {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: 600px;
        }

        .loading {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #667eea;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading p {
            color: #666;
            font-size: 1.1em;
        }

        .error-message {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #856404;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .controls button:hover {
            background: #764ba2;
        }

        .controls button.refresh {
            margin-left: auto;
        }

        .info-box {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 15px;
            color: white;
            margin-bottom: 20px;
            font-size: 0.95em;
        }

        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¤ï¸ å…¨å°å¤©æ°£å„€è¡¨æ¿</h1>
            <p>å³æ™‚æ°£è±¡è³‡æ–™ä¾†è‡ªä¸­å¤®æ°£è±¡ç½² (CWA)</p>
        </div>

        <div class="info-box">
            <i class="fas fa-info-circle"></i> 
            æœ¬å„€è¡¨æ¿æ¯ 5 åˆ†é˜è‡ªå‹•æ›´æ–°ä¸€æ¬¡ã€‚åœ°åœ–ä¸Šçš„å½©è‰²åœ“é»ä»£è¡¨ä¸åŒçš„æº«åº¦å€é–“ï¼Œé»æ“Šå¯æŸ¥çœ‹è©³ç´°è³‡è¨Šã€‚
        </div>

        <div class="error-message" id="error-message"></div>

        <div class="controls">
            <button id="btn-refresh" class="refresh">
                <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
            </button>
        </div>

        <div class="dashboard">
            <div class="stats-card">
                <div class="stat-item">
                    <span class="stat-label">ğŸ“Š ç¸½æ¸¬ç«™æ•¸</span>
                    <span class="stat-value" id="stat-total">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ğŸŒ¡ï¸ å¹³å‡æº«åº¦</span>
                    <span class="stat-value" id="stat-avg-temp">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ğŸ”¥ æœ€é«˜æº«åº¦</span>
                    <span class="stat-value" id="stat-max-temp">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">â„ï¸ æœ€ä½æº«åº¦</span>
                    <span class="stat-value" id="stat-min-temp">--</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ğŸŒ§ï¸ æœ€å¤§é›¨é‡</span>
                    <span class="stat-value" id="stat-max-rain">--</span>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #d62828;"></div>
                        <span>â‰¥35Â°C (æ¥µç†±)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f77f00;"></div>
                        <span>30-35Â°C (ç†±)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fcbf49;"></div>
                        <span>25-30Â°C (èˆ’é©åç†±)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #aacc00;"></div>
                        <span>20-25Â°C (èˆ’é©)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4cc9f0;"></div>
                        <span>15-20Â°C (æ¶¼)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4361ee;"></div>
                        <span>&lt;15Â°C (å†·)</span>
                    </div>
                </div>
            </div>

            <div id="map"></div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨è¼‰å…¥å¤©æ°£è³‡æ–™...</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============ è¨­å®š ============
        const CONFIG = {
            API_URL: '/api/weather-stations',
            REFRESH_INTERVAL: 300000 // 5 åˆ†é˜
        };

        // ============ DOM æ“ä½œè¼”åŠ© ============
        const DOM = {
            loading: document.getElementById('loading'),
            errorMessage: document.getElementById('error-message'),
            statTotal: document.getElementById('stat-total'),
            statAvgTemp: document.getElementById('stat-avg-temp'),
            statMaxTemp: document.getElementById('stat-max-temp'),
            statMinTemp: document.getElementById('stat-min-temp'),
            statMaxRain: document.getElementById('stat-max-rain'),
            btnRefresh: document.getElementById('btn-refresh')
        };

        let map = null;
        let markers = [];
        let stationsData = [];

        // ============ é¡è‰²è¼”åŠ©å‡½å¼ ============
        function getTempColor(temp) {
            if (temp === null) return '#999';
            if (temp >= 35) return '#d62828'; // ç´«ç´… (æ¥µç†±)
            if (temp >= 30) return '#f77f00'; // æ©˜ (ç†±)
            if (temp >= 25) return '#fcbf49'; // é»ƒ (èˆ’é©åç†±)
            if (temp >= 20) return '#aacc00'; // ç¶  (èˆ’é©)
            if (temp >= 15) return '#4cc9f0'; // è— (æ¶¼)
            return '#4361ee'; // æ·±è— (å†·)
        }

        // ============ é¡¯ç¤º/éš±è—å…ƒç´  ============
        function showLoading() {
            DOM.loading.classList.add('show');
        }

        function hideLoading() {
            DOM.loading.classList.remove('show');
        }

        function showError(message) {
            DOM.errorMessage.textContent = 'âŒ ' + message;
            DOM.errorMessage.classList.add('show');
            hideLoading();
        }

        function hideError() {
            DOM.errorMessage.classList.remove('show');
        }

        // ============ åˆå§‹åŒ–åœ°åœ– ============
        function initMap() {
            if (map) return; // å·²åˆå§‹åŒ–
            
            map = L.map('map').setView([23.6, 121.0], 7);
            
            // ä½¿ç”¨æ·ºè‰²åº•åœ–
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: 'Â© OpenStreetMap, Â© CartoDB',
                maxZoom: 18
            }).addTo(map);
        }

        // ============ æ¸…é™¤èˆŠæ¨™è¨˜ ============
        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        // ============ ç¹ªè£½æ¨™è¨˜ ============
        function drawMarkers(stations) {
            clearMarkers();
            
            stations.forEach(st => {
                if (!st.lat || !st.lon) return;

                const color = getTempColor(st.temp);
                const radius = st.temp === null ? 6 : 8;

                // åœ“é»æ¨™è¨˜
                const marker = L.circleMarker([st.lat, st.lon], {
                    radius: radius,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                // å½ˆå‡ºè¦–çª—å…§å®¹
                const popupContent = `
                    <div style="text-align:center; font-size:0.95em;">
                        <b style="font-size:1.2em; color:${color}">${st.name}</b>
                        <br>
                        <small style="color:#666">${st.city} ${st.town}</small>
                        <hr style="margin:8px 0; border:none; border-top:1px solid #ddd;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; text-align:left;">
                            <div>
                                <span style="font-weight:bold; color:${color}; font-size:1.4em;">
                                    ${st.temp !== null ? st.temp.toFixed(1) + 'Â°C' : 'ç„¡è³‡æ–™'}
                                </span>
                                <br>
                                <small style="color:#888">æº«åº¦</small>
                            </div>
                            <div>
                                <span style="font-weight:bold; color:#4361ee; font-size:1.2em;">
                                    ${st.humid !== null ? st.humid.toFixed(0) + '%' : '--'}
                                </span>
                                <br>
                                <small style="color:#888">æ¿•åº¦</small>
                            </div>
                        </div>
                        <hr style="margin:8px 0; border:none; border-top:1px solid #ddd;">
                        <div style="text-align:left; font-size:0.9em;">
                            ğŸ’¨ é¢¨é€Ÿ: ${st.wind_speed !== null ? st.wind_speed.toFixed(1) : '--'} m/s
                            <br>
                            ğŸŒ§ï¸ é›¨é‡: ${st.rain !== null ? st.rain.toFixed(1) : '0'} mm
                            <br>
                            â˜€ï¸ ç´«å¤–ç·š: ${st.uvi !== null ? st.uvi.toFixed(1) : '--'}
                            <br>
                            ğŸ• ${new Date(st.time).toLocaleTimeString('zh-TW')}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                markers.push(marker);
            });

            console.log(`âœ… å·²åœ¨åœ°åœ–ä¸Šç¹ªè£½ ${stations.length} å€‹æ¨™è¨˜`);
        }

        // ============ æ›´æ–°çµ±è¨ˆè³‡æ–™ ============
        function updateStats(stations) {
            // è¨ˆç®—æœ‰æ•ˆæº«åº¦çš„æ¸¬ç«™
            const validTemps = stations
                .filter(s => s.temp !== null)
                .map(s => s.temp);

            const validRains = stations
                .filter(s => s.rain !== null && s.rain > 0)
                .map(s => s.rain);

            const total = stations.length;
            const avgTemp = validTemps.length > 0 
                ? (validTemps.reduce((a, b) => a + b, 0) / validTemps.length).toFixed(1)
                : '--';
            const maxTemp = validTemps.length > 0 ? Math.max(...validTemps).toFixed(1) : '--';
            const minTemp = validTemps.length > 0 ? Math.min(...validTemps).toFixed(1) : '--';
            const maxRain = validRains.length > 0 ? Math.max(...validRains).toFixed(1) : '0';

            DOM.statTotal.textContent = total;
            DOM.statAvgTemp.textContent = avgTemp + (typeof avgTemp === 'number' ? 'Â°C' : '');
            DOM.statMaxTemp.textContent = maxTemp + (typeof maxTemp === 'number' ? 'Â°C' : '');
            DOM.statMinTemp.textContent = minTemp + (typeof minTemp === 'number' ? 'Â°C' : '');
            DOM.statMaxRain.textContent = maxRain + (typeof maxRain === 'number' ? ' mm' : '');
        }

        // ============ è¼‰å…¥å¤©æ°£è³‡æ–™ ============
        async function loadWeatherData() {
            try {
                showLoading();
                hideError();

                console.log('ğŸ”„ æ­£åœ¨å¾ API è¼‰å…¥å¤©æ°£è³‡æ–™...');
                const response = await fetch(CONFIG.API_URL);

                if (!response.ok) {
                    throw new Error(`API è¿”å›ç‹€æ…‹ ${response.status}`);
                }

                const result = await response.json();
                console.log(`âœ… æˆåŠŸè¼‰å…¥ ${result.count} å€‹æ¸¬ç«™çš„è³‡æ–™`);

                if (!result.success || !result.data) {
                    throw new Error('API è¿”å›è³‡æ–™æ ¼å¼éŒ¯èª¤');
                }

                stationsData = result.data;

                // ç¢ºä¿åœ°åœ–å·²åˆå§‹åŒ–
                initMap();

                // ç¹ªè£½æ¨™è¨˜
                drawMarkers(stationsData);

                // æ›´æ–°çµ±è¨ˆè³‡æ–™
                updateStats(stationsData);

                hideLoading();

            } catch (err) {
                console.error('âŒ è¼‰å…¥å¤©æ°£è³‡æ–™æ™‚å‡ºéŒ¯:', err.message);
                showError(err.message);
            }
        }

        // ============ é é¢åˆå§‹åŒ– ============
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ å¤©æ°£å„€è¡¨æ¿æ­£åœ¨åˆå§‹åŒ–...');
            
            // è¼‰å…¥è³‡æ–™
            loadWeatherData();

            // è¨­å®šè‡ªå‹•åˆ·æ–° (5 åˆ†é˜)
            setInterval(loadWeatherData, CONFIG.REFRESH_INTERVAL);

            // æ‰‹å‹•åˆ·æ–°æŒ‰éˆ•
            DOM.btnRefresh.addEventListener('click', loadWeatherData);

            console.log('âœ… å¤©æ°£å„€è¡¨æ¿åˆå§‹åŒ–å®Œæˆ');
        });

        // ============ å…¨å±€éŒ¯èª¤è™•ç† ============
        window.addEventListener('error', (e) => {
            console.error('âŒ å…¨å±€éŒ¯èª¤:', e.message);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('âŒ æœªè™•ç†çš„ Promise æ‹’çµ•:', e.reason);
        });
    </script>
</body>
</html>
