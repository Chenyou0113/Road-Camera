<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµ PIDS (v5.9.5 7ç­è»Šæ»¿ç‰ˆä¿®æ­£)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background-color: #111; color: white; font-family: "Microsoft JhengHei", sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; padding: 8px; gap: 8px; }
        .unified-header { width: 100%; height: 90px; background: #000; border-bottom: 2px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; flex-shrink: 0; }
        .station-branding { display: flex; align-items: center; gap: 15px; }
        .tra-logo-img { height: 50px; border-radius: 50%; border: 2px solid #fff; }
        .station-name { font-size: 3.5rem; font-weight: 900; line-height: 1; text-shadow: 0 0 10px rgba(255,255,255,0.6); }
        .station-sub { font-size: 1.5rem; color: #4fc3f7; font-family: Consolas, sans-serif; font-weight: bold; }
        .time-text { font-size: 3rem; font-weight: bold; font-family: Consolas, monospace; color: #ffeb3b; }
        .date-text { font-size: 2.2rem; color: #ccc; font-family: Consolas, monospace; }

        .unified-marquee-container { width: 100%; height: 55px; background: #e3f2fd; display: flex; align-items: center; overflow: hidden; position: relative; color: #003366; flex-shrink: 0; }
        .unified-marquee-container .marquee-text { position: absolute; white-space: nowrap; height: 55px; line-height: 55px; font-size: 2.2rem; font-weight: 900; left: 100%; }

        .pids-section { display: flex; width: 100%; gap: 10px; flex: 1; overflow: hidden; }
        .pids-column { flex: 1; display: flex; flex-direction: column; background: #000; border: 3px solid #333; border-radius: 8px; overflow: hidden; }
        .direction-header { padding: 10px 15px; font-size: 1.5rem; font-weight: 900; color: white; display: flex; justify-content: space-between; border-bottom: 2px solid #fff; }
        .dir-1 { background: linear-gradient(to right, #000080, #0d47a1); }
        .dir-0 { background: linear-gradient(to right, #bf360c, #e65100); }

        /* ğŸ”¥ 7 ç­æ»¿ç‰ˆï¼šè¡¨æ ¼é«˜åº¦ä½”æ»¿ç©ºé–“ */
        .train-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 1.8rem; font-weight: bold; table-layout: fixed; height: calc(100% - 45px); }
        .train-table th { padding: 5px; color: #fff; border-bottom: 2px solid #fff; height: 45px; font-size: 1.3rem; }
        
        /* ğŸ”¥ 7 ç­åˆ†é…é«˜åº¦ (100% / 7 = 14.28%) */
        .train-table tbody tr { height: 14.28%; border-bottom: 1px solid #333; }
        .train-table td { padding: 0 5px; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .marquee-footer { background: #212121; color: #ffeb3b; height: 50px; position: relative; overflow: hidden; border-top: 3px solid #ff9800; flex-shrink: 0; }
        .marquee-footer .marquee-text { position: absolute; white-space: nowrap; left: 100%; height: 50px; line-height: 50px; font-size: 1.4rem; font-weight: bold; }

        .time-delay-container { display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 8px; height: 100%; }
        .original-time { text-decoration: line-through; color: #777; font-size: 1.2rem; }
        .expected-time { color: #4fc3f7; font-weight: bold; font-size: 1.8rem; }
        .normal-time { font-size: 1.8rem; font-family: Consolas; }
        .train-type-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; color: white; font-size: 1.5rem; min-width: 120px; }
        
        .type-æ–°è‡ªå¼· { background: #333; border: 1px solid #999; } .type-æ™®æ‚ ç‘ª { background: #E91E63; } .type-å€é–“ { background: #2196F3; } .type-è‡ªå¼· { background: #FF5722; }
        .status-ontime { color: #4CAF50; } .status-delay { color: #ff1744; animation: blink 1s infinite alternate; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.6; } }
        @media (max-width: 900px) { .pids-section { flex-direction: column; } #mediaZone { flex-direction: column; height: auto !important; } }
    </style>
    <script src="assets/station-code-mapping.js"></script>
</head>
<body>
    <div class="unified-header">
        <div class="station-branding">
            <img src="https://www.railway.gov.tw/tra-tip-web/static/images/TRA_logo.jpg" class="tra-logo-img">
            <div><div class="station-name" id="unifiedStationName">è‡ºéµè»Šç«™</div><div class="station-sub" id="station-en">TAIPEI STATION</div></div>
        </div>
        <div class="datetime-block"><div class="date-text" id="unifiedDate"></div><div class="time-text" id="unifiedTime"></div></div>
    </div>
    <div class="unified-marquee-container"><div class="marquee-text" id="unifiedTopMarquee">è¼‰å…¥ä¸­...</div></div>
    <div class="pids-section">
        <div class="pids-column">
            <div class="direction-header dir-1"><span>é€†è¡Œ</span><span id="destList1" style="font-size:1rem"></span></div>
            <table class="train-table">
                <thead><tr><th style="width:15%">è»Šæ¬¡</th><th style="width:18%">è»Šç¨®</th><th style="width:30%">é–‹å¾€</th><th style="width:22%">å¯¦éš›é–‹è»Šæ™‚é–“</th><th style="width:15%">ç‹€æ…‹</th></tr></thead>
                <tbody id="body1"></tbody>
            </table>
            <div class="marquee-footer"><div class="marquee-text" id="marquee1">è®€å–ä¸­...</div></div>
        </div>
        <div class="pids-column">
            <div class="direction-header dir-0"><span>é †è¡Œ</span><span id="destList0" style="font-size:1rem"></span></div>
            <table class="train-table">
                <thead><tr><th style="width:15%">è»Šæ¬¡</th><th style="width:18%">è»Šç¨®</th><th style="width:30%">é–‹å¾€</th><th style="width:22%">å¯¦éš›é–‹è»Šæ™‚é–“</th><th style="width:15%">ç‹€æ…‹</th></tr></thead>
                <tbody id="body0"></tbody>
            </table>
            <div class="marquee-footer"><div class="marquee-text" id="marquee0">è®€å–ä¸­...</div></div>
        </div>
    </div>
    <div id="mediaZone" style="height:180px; display:flex; gap:10px;">
        <div id="carouselBox" style="flex:1; border:3px solid #333; border-radius:8px; overflow:hidden; position:relative;"></div>
        <div id="videoBox" style="flex:1; border:3px solid #333; border-radius:8px; overflow:hidden;"></div>
    </div>

    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script>
        const WORKER_URL = "https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev";
        const MAX_ROWS = 7; // ğŸ”¥ æ•¸é‡ç¢ºèªç‚º 7 ç­
        const TRAIN_TYPES = {"1100":"è‡ªå¼·","1101":"å¤ªé­¯é–£","1107":"æ™®æ‚ ç‘ª","110B":"æ–°è‡ªå¼·","1131":"å€é–“","1132":"å€é–“å¿«"};
        const stopsCache = {};

        function getInfo(t) {
            let name = t.TrainTypeName?.Zh_tw || TRAIN_TYPES[t.TrainTypeID] || 'å€é–“';
            let cls = 'å…¶ä»–';
            if(name.includes('æ–°è‡ªå¼·')||name.includes('3000')) { name='æ–°è‡ªå¼·'; cls='æ–°è‡ªå¼·'; }
            else if(name.includes('æ™®æ‚ ç‘ª')) cls='æ™®æ‚ ç‘ª';
            else if(name.includes('å€é–“')) cls='å€é–“';
            else if(name.includes('è‡ªå¼·')) cls='è‡ªå¼·';
            return { name, cls };
        }

        async function fetchStops(no) {
            if(stopsCache[no]) return stopsCache[no];
            try {
                let r = await fetch(`${WORKER_URL}/api/schedule?trainNo=${no}`);
                let d = await r.json();
                if(d.length) { stopsCache[no] = d[0].StopTimes; return d[0].StopTimes; }
            } catch(e){} return [];
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('unifiedTime').innerText = now.toLocaleTimeString('en-GB');
            document.getElementById('unifiedDate').innerText = now.toISOString().split('T')[0].replace(/-/g,'/');
        }
        setInterval(updateClock, 1000);

        function startMarquee(id, speed=100) {
            const el = document.getElementById(id);
            if(!el) return;
            el.style.transition = 'none'; el.style.left = '100%';
            setTimeout(() => {
                const dur = (el.scrollWidth + el.parentElement.offsetWidth) / speed;
                el.style.transition = `left ${dur}s linear`;
                el.style.left = `-${el.scrollWidth}px`;
                el.ontransitionend = () => startMarquee(id, speed);
            }, 100);
        }

        async function updatePids(id) {
            try {
                let r = await fetch(`${WORKER_URL}/api/liveboard/station?station=${id}`);
                let d = await r.json();
                const t1 = d.filter(t=>t.Direction==1), t0 = d.filter(t=>t.Direction==0);
                renderTable('1', t1); renderTable('0', t0);
                updateBottomMarquee('marquee1', t1).then(()=>startMarquee('marquee1'));
                updateBottomMarquee('marquee0', t0).then(()=>startMarquee('marquee0'));
            } catch(e) { }
        }

        function renderTable(dir, list) {
            const tb = document.getElementById(`body${dir}`);
            tb.innerHTML = '';
            list.slice(0, MAX_ROWS).forEach((t, i) => {
                const info = getInfo(t);
                const delay = parseInt(t.DelayTime)||0;
                const timeStr = t.ScheduledDepartureTime.slice(0,5);
                const [h,m] = timeStr.split(':').map(Number);
                const expT = `${String(Math.floor((h*60+m+delay)/60)%24).padStart(2,'0')}:${String((h*60+m+delay)%60).padStart(2,'0')}`;
                
                const timeHtml = delay > 0 ? `<div class="time-delay-container"><span class="original-time">${timeStr}</span><span class="expected-time">${expT}</span></div>` : `<span class="normal-time">${timeStr}</span>`;
                const tr = document.createElement('tr');
                if(i===0) tr.classList.add('highlight-row');
                tr.innerHTML = `<td>${t.TrainNo}</td><td><span class="train-type-badge type-${info.cls}">${info.name}</span></td><td>å¾€ ${t.EndingStationName}</td><td>${timeHtml}</td><td class="${delay>0?'status-delay':'status-ontime'}">${delay>0?`æ™š ${delay} åˆ†`:'æº–é»'}</td>`;
                tb.appendChild(tr);
            });
            for(let i=tb.rows.length; i<MAX_ROWS; i++) tb.innerHTML += '<tr><td>&nbsp;</td><td></td><td></td><td></td><td></td></tr>';
        }

        async function updateBottomMarquee(elId, list) {
            const el = document.getElementById(elId);
            if(!list.length) { el.innerText="ç›®å‰ç„¡åˆ—è»Šè³‡è¨Š"; return; }
            const t = list[0];
            const info = getInfo(t);
            const noteText = t.Note ? `(${t.Note})` : "";
            el.innerHTML = `<span style="color:#ffeb3b;">${t.TrainNo} æ¬¡ ${info.name} å¾€ ${t.EndingStationName} ${noteText}</span> | åˆ—è»Šç›®å‰ä½ç½®ï¼šåµæ¸¬ä¸­ | ç¥æ‚¨æ—…é€”æ„‰å¿«`;
        }

        async function init() {
            const p = new URLSearchParams(location.search);
            const id = p.get('station');
            const name = p.get('name')||'è‡ºéµ';
            document.getElementById('unifiedStationName').innerText = name.replace(/è»Šç«™$|ç«™$/,'')+'è»Šç«™';
            if(window.stationDataMap && stationDataMap[id]) document.getElementById('station-en').innerText = stationDataMap[id].ename.split('_')[0].toUpperCase()+' STATION';
            updateClock();
            if(id) { updatePids(id); setInterval(()=>updatePids(id), 60000); }
            let r = await fetch(`${WORKER_URL}/api/pids/marquee`);
            let d = await r.json();
            document.getElementById('unifiedTopMarquee').innerHTML = d.text;
            startMarquee('unifiedTopMarquee', 150);
            updateMedia();
        }

        async function updateMedia() {
            try {
                const res = await fetch(`${WORKER_URL}/api/pids/assets`);
                const data = await res.json();
                const car = document.getElementById('carouselBox');
                data.images.forEach((src, i) => {
                    const img = document.createElement('img'); img.src = src; img.className = i===0?'carousel-img active':'carousel-img';
                    img.style.width="100%"; img.style.height="100%"; img.style.position="absolute"; img.style.objectFit="contain";
                    car.appendChild(img);
                });
                let idx = 0; setInterval(() => { const imgs = car.querySelectorAll('img'); if(imgs.length<2) return; imgs[idx].classList.remove('active'); idx=(idx+1)%imgs.length; imgs[idx].classList.add('active'); }, 10000);
                const vid = data.video[0];
                const vId = vid.includes('v=') ? vid.split('v=')[1].split('&')[0] : vid.split('/').pop();
                document.getElementById('videoBox').innerHTML = `<iframe class="video-iframe" src="https://www.youtube.com/embed/${vId}?autoplay=1&mute=1&loop=1&playlist=${vId}&controls=0" style="width:100%; height:100%; border:none;"></iframe>`;
            } catch(e){}
        }
        init();
    </script>
</body>
</html>
