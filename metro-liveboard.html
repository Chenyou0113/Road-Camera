<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°æ·é‹æ™ºæ…§å„€è¡¨æ¿ â€§ æ——è‰¦ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=JetBrains+Mono:wght@700;900&display=swap');

        :root {
            --p-500: #00bcd4;
            --surface: #ffffff;
            --background: #f4f7f9;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --radius: 16px;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            --danger: #DC2626;
            --primary: #2563EB;
        }

        body.dark-mode {
            --surface: #1a1d23;
            --background: #0b0e14;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --border: #2d333b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            transition: 0.3s;
        }

        /* --- ğŸš€ ä¸ŠåŠéƒ¨ï¼šæ•¸ä½å„€è¡¨æ¿ --- */
        .hero-section {
            background: linear-gradient(135deg, #1a237e 0%, #00bcd4 100%);
            padding: 20px 0 100px 0;
            color: white;
            text-align: center;
            clip-path: ellipse(150% 100% at 50% 0%);
        }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .back-btn {
            color: white;
            text-decoration: none;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 10px;
            transition: 0.3s;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .hero-content h1 {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .hero-content p {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .stats-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            margin-bottom: -60px;
            position: relative;
            z-index: 10;
        }

        .stat-badge {
            background: var(--surface);
            color: var(--text-main);
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
            min-width: 130px;
            border: 1px solid var(--border);
        }

        .stat-badge .val {
            display: block;
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--p-500);
            font-family: 'JetBrains Mono';
        }

        .stat-badge .label {
            font-size: 0.75rem;
            color: var(--text-sub);
            font-weight: 700;
        }

        /* --- ğŸš‡ ç³»çµ±é¸æ“‡ --- */
        .sys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin: 90px 0 30px 0;
        }

        .sys-card {
            background: var(--surface);
            padding: 20px 10px;
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            border: 3px solid transparent;
            box-shadow: var(--shadow);
        }

        .sys-card i {
            font-size: 1.8rem;
            margin-bottom: 8px;
            display: block;
            color: var(--p-500);
        }

        .sys-card span {
            font-weight: 900;
            font-size: 0.95rem;
        }

        .sys-card.active {
            border-color: var(--p-500);
            background: rgba(0, 188, 212, 0.05);
        }

        /* --- ğŸ” æ§åˆ¶é¢æ¿ --- */
        .control-panel {
            background: var(--surface);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .control-panel select {
            flex: 1;
            min-width: 180px;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #edf2f7;
            background: var(--surface);
            color: var(--text-main);
            font-weight: 700;
        }

        .mode-switcher {
            display: flex;
            background: var(--background);
            padding: 4px;
            border-radius: 10px;
            gap: 4px;
        }

        .mode-btn {
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 900;
            background: transparent;
            color: var(--text-sub);
            transition: 0.2s;
        }

        .mode-btn.active {
            background: var(--surface);
            color: var(--p-500);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-pids {
            background: #9c27b0;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 900;
            cursor: pointer;
        }

        /* --- ğŸ“± çœ‹æ¿å¡ç‰‡ --- */
        .board-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-4px);
        }

        .card-header {
            padding: 14px 20px;
            color: white;
            font-weight: 900;
            font-size: 1.15rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .arrival-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .arrival-row:last-child {
            border-bottom: none;
        }

        .destination {
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .meta {
            font-size: 0.85rem;
            color: var(--text-sub);
            font-weight: 500;
        }

        .time-number {
            font-family: 'JetBrains Mono';
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .time-unit {
            font-size: 0.9rem;
            color: var(--text-sub);
            margin-left: 4px;
            font-weight: 700;
        }

        .arriving-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--danger);
            color: white;
            border-radius: 99px;
            font-weight: 900;
            font-size: 0.95rem;
            animation: pulse 1.5s infinite;
        }

        .arriving-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink-dot 1s infinite;
        }

        /* --- ğŸ“… æ™‚åˆ»è¡¨æ¨£å¼ --- */
        .schedule-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 30px;
            align-items: start;
        }

        .timetable-card {
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .timetable-header {
            padding: 16px 20px;
            color: white;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
        }

        .hour-row {
            display: flex;
            align-items: stretch;
            border-bottom: 1px solid var(--border);
        }

        .hour-row:last-child {
            border-bottom: none;
        }

        .hour-label {
            width: 70px;
            background: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono';
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--p-500);
            border-right: 2px solid var(--border);
        }

        .minute-list {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 12px 20px;
        }

        .min-chip {
            font-family: 'JetBrains Mono';
            font-weight: 700;
            font-size: 1.1rem;
            padding: 4px 8px;
            border-radius: 6px;
            color: var(--text-main);
            background: rgba(100, 116, 139, 0.05);
        }

        .min-chip.next-up {
            background: var(--p-500);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 188, 212, 0.3);
            transform: scale(1.1);
        }

        @keyframes blink-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
            }
        }

        /* --- ğŸ‘¥ æ“æ“ åº¦ UI å‡ç´šç‰ˆ (æ•¸å­— + åŠ å¤§) --- */
        .congestion-container {
            padding: 10px 20px 15px 20px;
            background: rgba(0, 0, 0, 0.2);
            /* å¾®å¾®æ·±åº•ï¼Œçªå‡ºé¡¯ç¤º */
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cong-label-small {
            font-size: 0.75rem;
            color: var(--text-sub);
            font-weight: 700;
            margin-bottom: 8px;
            text-align: left;
        }

        .congestion-bar {
            display: flex;
            gap: 6px;
            /* å¢åŠ é–“è· */
            width: 100%;
        }

        .cong-car {
            flex: 1;
            /* å¹³å‡åˆ†é…å¯¬åº¦ */
            height: 32px;
            /* ğŸ”¥ åŠ é«˜ï¼åŸæœ¬åªæœ‰ 6px */
            border-radius: 6px;
            /* åœ“è§’æ›´æ˜é¡¯ */
            background: #334155;
            /* é è¨­æ·±ç°è‰² */

            /* æ•¸å­—ç½®ä¸­æ¨£å¼ */
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            font-weight: 900;
            font-family: 'JetBrains Mono', monospace;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        /* é¡è‰²å®šç¾© (ç¨å¾®äº®ä¸€é»ï¼Œä¸¦åŠ ä¸Šé‚Šæ¡†å…‰æšˆ) */
        .cong-lvl-1 {
            background: #22c55e;
            border: 1px solid #4ade80;
        }

        /* ç¶  (èˆ’é©) */
        .cong-lvl-2 {
            background: #eab308;
            border: 1px solid #facc15;
            color: #000;
        }

        /* é»ƒ (æ™®é€š) - é»‘å­— */
        .cong-lvl-3 {
            background: #f97316;
            border: 1px solid #fb923c;
        }

        /* æ©˜ (ç•¥æ“ ) */
        .cong-lvl-4 {
            background: #ef4444;
            border: 1px solid #f87171;
        }

        /* ç´… (æ“æ“ ) */

        /* --- â³ æ•¸æ“šæ›´æ–°é€²åº¦æ¢ --- */
        .progress-bar-container {
            width: 100%;
            max-width: 400px;
            height: 4px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            margin: 15px auto 0 auto;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            width: 100%;
            background: #4caf50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            transform-origin: left;
            transform: scaleX(0);
        }

        /* --- ğŸ“¢ ç‡Ÿé‹é€šé˜»å…¬å‘Š --- */
        .news-section {
            margin-bottom: 30px;
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .news-header h3 {
            font-size: 1.2rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-main);
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .news-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 18px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: 0.3s;
        }

        .news-card h4 {
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .news-card.trtc h4 {
            color: #0066cc;
        }

        .news-card.krtc h4 {
            color: #ff6600;
        }

        .news-card.tymc h4 {
            color: #9966cc;
        }

        .news-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed var(--border);
        }

        .news-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .news-item h5 {
            font-size: 0.95rem;
            margin-bottom: 4px;
            font-weight: 800;
        }

        .news-item p {
            font-size: 0.85rem;
            color: var(--text-sub);
            line-height: 1.5;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-sub);
            font-weight: 700;
        }

        .news-link {
            color: var(--p-500);
            text-decoration: none;
        }

        /* --- ğŸƒ è·‘é¦¬ç‡ˆ (æ–°å¢) --- */
        .marquee-fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: #111;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 2px solid var(--p-500);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        }

        .marquee-section {
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0;
            position: relative;
            /* å¿…é ˆç‚ºç›¸å°å®šä½ */
            width: 100%;
            height: 100%;
        }

        .marquee-text {
            white-space: nowrap;
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            position: absolute;
            /* å¿…é ˆç‚ºçµ•å°å®šä½ä¾› JS æ§åˆ¶ */
            left: 100%;
            will-change: transform;
            line-height: 50px;
        }

        </head><body class="dark-mode"><div class="hero-section"><div class="container"><div class="nav-bar"><a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i>è¿”å›</a><button class="theme-toggle" onclick="UI.toggleTheme()"><i class="fas fa-sun" id="themeIcon"></i></button></div><div class="hero-content"><h1>å…¨å°æ·é‹æ™ºæ…§å„€è¡¨æ¿</h1><p>æ•¸ä½æ•´åˆç›£æ¸¬ç³»çµ± â€§ å³æ™‚ç­æ¬¡èˆ‡å…¨æ—¥æ™‚åˆ»</p><div class="progress-bar-container" id="progressBarContainer" style="display:none;"><div class="progress-bar" id="update-progress"></div></div></div></div></div><div class="container"><div class="stats-container"><div class="stat-badge"><span class="val" id="stat-trains">0</span><span class="label">ç·šä¸Šåˆ—è»Š</span></div><div class="stat-badge"><span class="val" id="stat-stations">0</span><span class="label">è»Šç«™ç¸½æ•¸</span></div><div class="stat-badge"><span class="val" style="color:#4caf50">LIVE</span><span class="label">API é€£ç·š</span></div></div><div class="sys-grid"><div class="sys-card" data-sys="TRTC" onclick="Core.selectSystem('TRTC')"><i class="fas fa-subway"></i><span>å°åŒ—æ·é‹</span></div><div class="sys-card" data-sys="KRTC" onclick="Core.selectSystem('KRTC')"><i class="fas fa-train-subway"></i><span>é«˜é›„æ·é‹</span></div><div class="sys-card" data-sys="TYMC" onclick="Core.selectSystem('TYMC')"><i class="fas fa-plane"></i><span>æ¡ƒåœ’æ·é‹</span></div><div class="sys-card" data-sys="TMRT" onclick="Core.selectSystem('TMRT')"><i class="fas fa-train-tram"></i><span>å°ä¸­æ·é‹</span></div><div class="sys-card" data-sys="KLRT" onclick="Core.selectSystem('KLRT')"><i class="fas fa-train"></i><span>é«˜é›„è¼•è»Œ</span></div><div class="sys-card" data-sys="NTMC" onclick="Core.selectSystem('NTMC')"><i class="fas fa-road"></i><span>æ–°åŒ—æ·é‹</span></div></div>< !-- ğŸ“¢ ç‡Ÿé‹é€šé˜»å…¬å‘Šé¢æ¿ --><div class="news-section" id="newsSection"><div class="news-header" onclick="UI.toggleNews()"><h3><i class="fas fa-bullhorn" style="color: #f58220;"></i>æ·é‹ç³»çµ±å³æ™‚å…¬å‘Š / ç‡Ÿé‹é€šé˜»</h3><i class="fas fa-chevron-up" id="newsToggleIcon"></i></div><div class="news-grid" id="newsGrid"><div class="news-card trtc"><h4><i class="fas fa-subway"></i>å°åŒ—æ·é‹ (TRTC)</h4><div id="news-TRTC"><p style="color: #94a3b8; font-size: 0.85rem; text-align: center; padding: 10px;">è¼‰å…¥ä¸­...</p></div></div><div class="news-card krtc"><h4><i class="fas fa-train-subway"></i>é«˜é›„æ·é‹ (KRTC)</h4><div id="news-KRTC"><p style="color: #94a3b8; font-size: 0.85rem; text-align: center; padding: 10px;">åˆ†æä¸­...</p></div></div><div class="news-card tymc"><h4><i class="fas fa-plane"></i>æ¡ƒåœ’æ·é‹ (TYMC)</h4><div id="news-TYMC"><p style="color: #94a3b8; font-size: 0.85rem; text-align: center; padding: 10px;">é€£çµä¸­...</p></div></div></div></div><div class="control-panel" id="stationSelector" style="display:none;"><select id="lineSelect" onchange="Core.onLineChange()"></select><select id="stationSelect" onchange="Core.refresh()"></select><div class="mode-switcher"><button class="mode-btn active" id="modeLive" onclick="Core.setMode('live')">å³æ™‚</button><button class="mode-btn" id="modeSchedule" onclick="Core.setMode('schedule')">æ™‚åˆ»è¡¨</button></div><button class="btn-pids" onclick="Core.openPIDS()"><i class="fas fa-desktop"></i>PIDS</button></div><main id="board" class="board-grid"></main></div>< !-- è·‘é¦¬ç‡ˆå®¹å™¨ --><div class="marquee-fixed-footer"><div class="marquee-section"><div class="marquee-text" id="ui-marquee">ç³»çµ±è¼‰å…¥ä¸­...</div></div></div><script> // ğŸš¨ å¤–éƒ¨ Worker è¨­å®š
        const WORKER_URL_TDX='https://metro-api-worker.weacamm.org/api';
        const WORKER_URL_TRTC='https://trtc-metro-api.weacamm.org';
        const UPDATE_INTERVAL_MS=20000;

        let METRO_STATIONS_LOCAL=null;

        const AppState= {
            sys: '', sid: '', stations: [], mode: 'live', timer: null, localTicker: null, lastFetchTime: 0, currentTrains: []
        }

        ;

        const UI= {
            toggleTheme() {
                const isDark=document.body.classList.toggle('dark-mode');
                document.getElementById('themeIcon').className=isDark ? 'fas fa-sun': 'fas fa-moon';
            }

            ,
            toggleNews() {
                const grid=document.getElementById('newsGrid');
                const icon=document.getElementById('newsToggleIcon');
                const isShow=grid.style.display !=='none';
                grid.style.display=isShow ? 'none': 'grid';
                icon.className=isShow ? 'fas fa-chevron-down': 'fas fa-chevron-up';
            }
        }

        ;

        const Core= {
            stationNameOverrides: {
                'RK1': 'å²¡å±±è»Šç«™', 'R3': 'å°æ¸¯', 'O1': 'å“ˆç‘ªæ˜Ÿ', 'OT1': 'å¤§å¯®', 'R24': 'å²¡å±±é«˜é†«', '103a': 'åŒ—å±¯ç¸½ç«™'
            }

            ,
            globalLineMap: {
                'TRTC': {
                    'BR': 'æ–‡æ¹–ç·š', 'R': 'æ·¡æ°´ä¿¡ç¾©ç·š', 'G': 'æ¾å±±æ–°åº—ç·š', 'O': 'ä¸­å’Œæ–°è˜†ç·š', 'BL': 'æ¿å—ç·š', 'Y': 'ç’°ç‹€ç·š'
                }

                ,
                'KRTC': {
                    'R': 'ç´…ç·š', 'O': 'æ©˜ç·š'
                }

                ,
                'TMRT': {
                    'G': 'ç¶ ç·š'
                }

                ,
                'TYMC': {
                    'A': 'æ©Ÿå ´æ·é‹'
                }

                ,
                'NTMC': {
                    'Y': 'ç’°ç‹€ç·š', 'V': 'æ·¡æµ·è¼•è»Œ', 'K': 'å®‰å‘è¼•è»Œ'
                }
            }

            ,

            // ğŸš€ å•Ÿå‹•å‡½å¼
            async init() {
                try {
                    const res=await fetch('metro-stations-raw.json');
                    METRO_STATIONS_LOCAL=await res.json();
                    console.log("Station DB Loaded");
                }

                catch (e) {
                    console.error("Local JSON load failed");
                }

                this.selectSystem('TRTC');
                this.loadNews();
                setInterval(()=> this.loadNews(), 300000); // 5åˆ†é˜æ›´æ–°ä¸€æ¬¡å…¬å‘Š

                // å•Ÿå‹•è·‘é¦¬ç‡ˆ
                updateMarquee();
                setInterval(updateMarquee, 300000);
            }

            ,

            async loadNews() {
                const systems=['TRTC',
                'KRTC',
                'TYMC'];

                for (const sys of systems) {
                    try {
                        const res=await fetch(`$ {
                                WORKER_URL_TDX
                            }

                            /liveboard?system=$ {
                                sys
                            }

                            &type=Alert`);
                        const alerts=await res.json();

                        const container=document.getElementById(`news-$ {
                                sys
                            }

                            `);
                        if ( !container) continue;

                        if ( !alerts || alerts.length===0) {
                            container.innerHTML=`<p style="color: #94a3b8; font-size: 0.85rem; text-align: center; padding: 10px;">ç›®å‰ç„¡ç‡Ÿé‹é€šé˜»</p>`;
                            continue;
                        }

                        container.innerHTML=alerts.slice(0, 3).map(alert=> {
                                const title=alert.AlertTitle || alert.Title || 'ç³»çµ±å…¬å‘Š';
                                const desc=alert.Description || alert.AlertContent || '';

                                const time=alert.UpdateTime ? new Date(alert.UpdateTime).toLocaleString('zh-TW', {
                                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                                }) : '--:--';

                            const level=alert.AlarmLevel || 'info';
                            let color='#2563EB';
                            if (level==='critical') color='#d32f2f';
                            else if (level==='warning') color='#ff9800';

                            return ` <div class="news-item" > <h5 style="color: ${color};" >$ {
                                title
                            }

                            </h5> <p>$ {
                                desc.substring(0, 60)
                            }

                            $ {
                                desc.length > 60 ? '...' : ''
                            }

                            </p> <div class="news-meta" > <span><i class="far fa-clock" ></i> $ {
                                time
                            }

                            </span> $ {
                                alert.AlertURL ? `<a href="${alert.AlertURL}" target="_blank" class="news-link" ><i class="fas fa-external-link-alt" ></i></a>` : ''
                            }

                            </div> </div> `;
                        }).join('');
                }

                catch (e) {
                    console.error(`Load $ {
                            sys
                        }

                        news failed`, e);
                }
            }
        }

        ,

        async selectSystem(sys) {
            AppState.sys=sys;
            document.querySelectorAll('.sys-card').forEach(c=> c.classList.toggle('active', c.dataset.sys===sys));

            let rawStations=[];

            if (METRO_STATIONS_LOCAL && METRO_STATIONS_LOCAL.systems[sys]) {
                const sysData=METRO_STATIONS_LOCAL.systems[sys];

                rawStations=Object.entries(sysData.stations).map(([id, info])=> ({

                        id: id, name: info.name,
                        line: {
                            id: info.lineId, name: sysData.lines[info.lineId]?.name || info.lineId, color: sysData.lines[info.lineId]?.color || '#808080'
                        }
                    }));
        }

        else {
            try {
                const res=await fetch(`$ {
                        WORKER_URL_TDX
                    }

                    /stations?sys=$ {
                        sys
                    }

                    `);
                rawStations=await res.json();
            }

            catch (e) {
                console.error("API load failed");
            }
        }

        if ( !rawStations || rawStations.length===0) return;

        document.getElementById('stationSelector').style.display='flex';

        AppState.stations=rawStations.map(s=> {
                const sysMap=this.globalLineMap[sys] || {}

                ;
                const mappedName=sysMap[s.line.id] || s.line.name;

                return {
                    ...s, displayLineName: mappedName
                }

                ;
            });

        document.getElementById('stat-stations').textContent=AppState.stations.length;

        const uniqueLines=Array.from(new Set(AppState.stations.map(s=> s.displayLineName)));

        const sortOrder= {
            'æ–‡æ¹–ç·š': 1, 'æ·¡æ°´ä¿¡ç¾©ç·š': 2, 'æ¾å±±æ–°åº—ç·š': 3, 'ä¸­å’Œæ–°è˜†ç·š': 4, 'æ¿å—ç·š': 5, 'ç’°ç‹€ç·š': 6
        }

        ;
        uniqueLines.sort((a, b)=> (sortOrder[a] || 99) - (sortOrder[b] || 99));

        document.getElementById('lineSelect').innerHTML=uniqueLines.map(l=> `<option value="${l}" >$ {
                l
            }

            </option>`).join('');
        this.onLineChange();
        }

        ,

        onLineChange() {
            const selectedLineName=document.getElementById('lineSelect').value;
            const filtered=AppState.stations.filter(s=> s.displayLineName===selectedLineName);

            filtered.sort((a, b)=> {
                    const getNum=(id)=> parseInt(id.replace(/\D/g, '')) || 0;
                    return getNum(a.id) - getNum(b.id);
                });

            document.getElementById('stationSelect').innerHTML=filtered.map(s=> {
                    const displayName=this.stationNameOverrides[s.id] || s.name;

                    return `<option value="${s.id}" >$ {
                        displayName
                    }

                    ($ {
                            s.id
                        })</option>`;
                }).join('');
            this.refresh();
        }

        ,

        setMode(mode) {
            AppState.mode=mode;
            document.getElementById('modeLive').classList.toggle('active', mode==='live');
            document.getElementById('modeSchedule').classList.toggle('active', mode==='schedule');
            this.refresh();
        }

        ,

        refresh() {
            if (AppState.timer) clearInterval(AppState.timer);
            AppState.sid=document.getElementById('stationSelect').value;
            if ( !AppState.sid) return;

            this.fetchData();

            if (AppState.mode==='live') {
                this.startProgressBar();

                AppState.timer=setInterval(()=> {
                        this.fetchData();
                        this.startProgressBar();
                    }

                    , UPDATE_INTERVAL_MS);
            }

            else {
                document.getElementById('progressBarContainer').style.display='none';
            }
        }

        ,

        startProgressBar() {
            const bar=document.getElementById('update-progress');
            const container=document.getElementById('progressBarContainer');
            if ( !bar || !container) return;

            container.style.display='block';
            bar.style.transition='none';
            bar.style.transform='scaleX(1)';

            setTimeout(()=> {
                    bar.style.transition=`transform $ {
                        UPDATE_INTERVAL_MS
                    }

                    ms linear`;
                    bar.style.transform='scaleX(0)';
                }

                , 50);
        }

        ,

        parseTRTCTime(timeStr) {
            if ( !timeStr || timeStr==='åˆ—è»Šé€²ç«™' || timeStr==='è³‡æ–™æ“·å–ä¸­') return 0;

            if (timeStr.includes(':')) {
                const [mm,
                ss]=timeStr.split(':').map(Number);
                return (mm * 60)+ss;
            }

            return 9999;
        }

        ,

        async fetchData() {
            try {
                // å¦‚æœæ˜¯åŒ—æ·æˆ–ç’°ç‹€ç·šï¼Œå³æ™‚æ¨¡å¼èµ° TRTC Worker
                const isTrtcData=(AppState.sys==='TRTC' || (AppState.sys==='NTMC' && AppState.sid.startsWith ('Y')));

                if (isTrtcData && AppState.mode==='live') {
                    await this.fetchTRTCData();
                }

                else {
                    const res=await fetch(`$ {
                            WORKER_URL_TDX
                        }

                        /$ {
                            AppState.mode==='live' ? 'liveboard' : 'schedule'
                        }

                        ?sys=$ {
                            AppState.sys
                        }

                        &sid=$ {
                            AppState.sid
                        }

                        `);
                    const data=await res.json();

                    if (AppState.mode==='live') {
                        document.getElementById('stat-trains').textContent=data.length || 0;
                        this.renderLive(data, []);
                    }

                    else {
                        this.renderSchedule(data);
                    }
                }
            }

            catch (error) {
                console.error(error);
            }
        }

        ,

        // ğŸ”¥ æœ€çµ‚ç‰ˆï¼šå°ˆé–€è™•ç† TRTC è³‡æ–™çš„é‚è¼¯ - ç©©å®šç‰ˆ
        async fetchTRTCData() {
            try {
                const arrivalRes=await fetch(`$ {
                        WORKER_URL_TRTC
                    }

                    /arrival`);
                const rawArrivals=await arrivalRes.json();

                let crowdData=[];

                try {
                    const highCapRes=await fetch(`$ {
                            WORKER_URL_TRTC
                        }

                        /crowdedness/high-capacity`);
                    const wenhuRes=await fetch(`$ {
                            WORKER_URL_TRTC
                        }

                        /crowdedness/wenhu`);
                    crowdData=[...(await highCapRes.json()),
                    ...(await wenhuRes.json())];
                }

                catch(e) {}

                const currentStation=AppState.stations.find(s=> s.id===AppState.sid);
                const targetName=currentStation ? currentStation.name.replace('ç«™', '').trim() : "";

                // è¨˜éŒ„æŠ“å–æ™‚é–“
                AppState.lastFetchTime=Date.now();

                const formattedTrains=rawArrivals .filter(t=> {
                        const apiStationName=(t.StationName || "");
                        const destName=(t.DestinationName || "");

                        // æ¸…æ´—ç«™å
                        const pureApiName=apiStationName .replace(/^BR\s*/, '').replace(/^BL\s*/, '').replace(/^[RGOA]\s*/, '') .replace(/\sBR$/, '').replace(/\sBL$/, '').replace(/\s[RGOA]$/, '') .replace('ç«™', '').replace('è‡º', 'å°').trim();

                        // â˜… é—œéµä¿®æ­£ï¼šæ”¹æˆã€Œå®Œå…¨ç›¸ç­‰ã€ (===)ï¼Œé˜²æ­¢ "ä¸­å±±" åŒ¹é…åˆ° "ä¸­å±±åœ‹ä¸­" â˜…
                        if (pureApiName !==targetName) return false;

                        // 2. ç›®çš„åœ°å¿…é ˆæ˜¯åŒ—æ·çš„ä¸»è¦çµ‚é»ç«™
                        const isMajorDest=['å—æ¸¯', 'å‹•ç‰©åœ’', 'é ‚åŸ”', 'äºæ±é†«é™¢', 'æ·¡æ°´', 'è±¡å±±', 'åŒ—æŠ•', 'æ¾å±±', 'æ–°åº—', 'è¿´é¾', 'è˜†æ´²'].some(d=> destName.includes(d));
                        if ( !isMajorDest) return false;

                        // 3. â˜… ç«¯é»ç«™åš´æ ¼éæ¿¾ï¼šå„ªå…ˆç”¨ StationIDï¼Œå…¶æ¬¡ç›¸ä¿¡ç«™å â˜…
                        const currentLinePrefix=AppState.sid.substring(0, 2);

                        // A. å¦‚æœæœ‰ StationIDï¼Œå¿…é ˆåŒ¹é…ç•¶å‰ç«™æˆ–ç›¸é—œè½‰ä¹˜ç«™
                        if (t.StationID) {
                            const trainLinePrefix=t.StationID.substring(0, 2);
                            // å…è¨±ç•¶å‰ç·šè·¯æˆ–è½‰ä¹˜ç·šè·¯
                            if (trainLinePrefix===currentLinePrefix) return true;
                            if (currentLinePrefix==='BR' && trainLinePrefix==='BL') return true;
                            if (currentLinePrefix==='BL' && trainLinePrefix==='BR') return true;
                            if (currentLinePrefix==='R' && trainLinePrefix==='G') return true;
                            if (currentLinePrefix==='G' && trainLinePrefix==='R') return true;
                            // å…¶ä»–ç·šè·¯ä¸ç¬¦åˆï¼Œéæ¿¾æ‰
                            return false;
                        }

                        // B. æ²’æœ‰ StationIDï¼Œç›¸ä¿¡ç«™ååŒ¹é…å°±æ”¾è¡Œ
                        return true;

                    }) .map(t=> {
                        let linePrefix=null;
                        const dest=t.DestinationName || "";

                        // 2. â˜… æ ¸å¿ƒä¿®æ­£ï¼šç›®çš„åœ°çŸ¯æ­£ (éµå¾‹) â˜…
                        if (dest.includes('å‹•ç‰©åœ’')) {
                            linePrefix='BR'; // æ–‡æ¹–ç·š
                        }

                        else if (dest.includes('é ‚åŸ”') || dest.includes('äºæ±é†«é™¢')) {
                            linePrefix='BL'; // æ¿å—ç·š
                        }

                        else if (dest.includes('æ·¡æ°´') || dest.includes('è±¡å±±') || dest.includes('åŒ—æŠ•') || dest.includes('å¤§å®‰')) {
                            linePrefix='R'; // æ·¡æ°´ä¿¡ç¾©ç·š
                        }

                        else if (dest.includes('æ¾å±±') || dest.includes('æ–°åº—')) {
                            linePrefix='G'; // æ¾å±±æ–°åº—ç·š
                        }

                        else if (dest.includes('è¿´é¾') || dest.includes('è˜†æ´²')) {
                            linePrefix='O'; // ä¸­å’Œæ–°è˜†ç·š
                        }

                        else if (dest.includes('å—æ¸¯å±•è¦½é¤¨')) {

                            // â˜… è™•ç†å—æ¸¯å±•è¦½é¤¨çš„æ­§ç¾©ï¼šå„ªå…ˆç”¨ StationIDï¼Œæ¬¡å„ªå…ˆç”¨ç•¶å‰é¸ç·š â˜…
                            if (t.StationID?.startsWith ('BL')) {
                                linePrefix='BL';
                            }

                            else if (t.StationID?.startsWith ('BR')) {
                                linePrefix='BR';
                            }

                            else {
                                // æ²’æœ‰ StationIDï¼Œä½¿ç”¨ç•¶å‰é¸å–®çš„ç·šè·¯ä¾†åˆ¤æ–·
                                // é€™ç¢ºä¿åœ¨å¿ å­å¾©èˆˆé¸ BR æ™‚ï¼Œå—æ¸¯å±•è¦½é¤¨çš„è»Šæœƒè¢«åˆ¤å®šç‚º BR
                                const currentLinePrefix=AppState.sid.substring(0, 2);
                                if (currentLinePrefix==='BR') linePrefix='BR';
                                else if (currentLinePrefix==='BL') linePrefix='BL';
                                else linePrefix='BL'; // é è¨­ç‚º BLï¼ˆä¿å®ˆä¼°è¨ˆï¼‰
                            }
                        }

                        if ( !linePrefix) return null; // æ·˜æ±°ç„¡æ³•åˆ¤å®š LinePrefix çš„è»Šè¼›

                        return {

                            LinePrefix: linePrefix,
                            DestinationStationName: {
                                Zh_tw: t.DestinationName
                            }

                            ,
                            EstimateTime: this.parseTRTCTime(t.CountDown),
                            CountDown: t.CountDown,
                            TrainNumber: t.TrainNumber,
                            StationID: t.StationID
                        }

                        ;
                    }) .filter(t=> t !==null);

                // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸ï¼Œä¾›æ¯ç§’æ›´æ–°ä½¿ç”¨
                AppState.currentTrains=formattedTrains;

                document.getElementById('stat-trains').textContent=formattedTrains.length;
                this.renderLive(formattedTrains, crowdData);

                // å•Ÿå‹•æœ¬åœ°å€’æ•¸
                this.startLocalTicker();
            }

            catch (e) {
                console.error("fetchTRTCData error:", e);
            }
        }

        ,

        // ç”¢ç”Ÿæ“æ“ åº¦ HTML (ä¿®å¾©åƒæ•¸å‘½åèˆ‡é‚è¼¯)
        generateCongestionHTML(train, crowdData, linePrefix) {
            // 1. æª¢æŸ¥ç³»çµ±èˆ‡æ”¯æ´åº¦
            if (AppState.sys !=='TRTC' || !linePrefix || linePrefix==='Y') return '';

            // å¦‚æœæ²’æ“æ“ åº¦è³‡æ–™ï¼Œä»å›å‚³ç©ºå­—ä¸² (æˆ–è¦–éœ€æ±‚é¡¯ç¤ºç©ºç°æ¢)
            if ( !crowdData || crowdData.length===0) return '';

            // 2. æº–å‚™æ¯”å°åƒæ•¸
            const currentStationMeta=AppState.stations.find(s=> s.id===AppState.sid);
            const currentStationName=(currentStationMeta?.name || '').replace('ç«™', '').replace('è‡º', 'å°').trim();
            const targetTN=train.TrainNumber ? parseInt(train.TrainNumber, 10): null;

            // --- æ¯”å°ç­–ç•¥ (ä¸‰å±¤é˜²è­·) ---
            let match=null;

            // (A) å„ªå…ˆæ¯”å°è»Šè™Ÿ (æœ€æº–)
            if (targetTN) {
                match=crowdData.find(c=> {
                        const crowdNumbers=String(c.TrainNumber).split(',').map(n=> parseInt(n.trim(), 10));
                        return crowdNumbers.includes(targetTN);
                    });
            }

            // (B) è»Šè™Ÿå¤±æ•—ï¼Œæ¯”å° StationID (æ¬¡æº–ï¼Œé‡å°åœé ä¸­çš„è»Š)
            if ( !match) {
                match=crowdData.find(c=> c.StationID===AppState.sid);
            }

            // (C) IDå¤±æ•—ï¼Œæ¯”å°ç«™å (æœ€å¾Œæ‰‹æ®µï¼Œè™•ç† BR å¿ å­å¾©èˆˆ é€™ç¨®å­—ä¸²)
            if ( !match) {
                match=crowdData.find(c=> {
                        const apiStation=(c.StationName || "").replace('BR', '').replace('BL', '').replace('ç«™', '').replace('è‡º', 'å°').trim();
                        return apiStation===currentStationName;
                    });
            }

            // 3. æ¸²æŸ“ç‡ˆè™Ÿ (æ‰¾ä¸åˆ°è³‡æ–™ match ç‚º null æ™‚ï¼Œé¡¯ç¤ºç°è‰²)
            // â˜… é—œéµä¿®æ­£ï¼šä½¿ç”¨å‚³å…¥çš„ linePrefix åˆ¤æ–·è»Šå»‚æ•¸ï¼Œä¸ä¾è³´ AppState.sid â˜…
            const cars=(linePrefix==='BR') ? 4 : 6;
            let carsHtml='';

            for(let i=1; i<=cars; i++) {
                let cls='cong-car'; // é è¨­ç°è‰²
                let levelNum=''; // ç­‰ç´š (1~4)

                if (match) {
                    const level=match[`Car$ {
                        i
                    }

                    `] || match[`Cart$ {
                        i
                    }

                    L`] || 0;

                    if (level >=1 && level <=4) {
                        cls+=` cong-lvl-$ {
                            level
                        }

                        `;
                        levelNum=level; // ç”¨æ–¼æœªä¾†å¯èƒ½çš„ tooltip
                    }
                }

                // æ•¸å­—ç½®ä¸­ï¼šåœ¨ div ä¸­é¡¯ç¤ºè»Šå»‚ç·¨è™Ÿ (i)
                carsHtml+=`<div class="${cls}" title="ç¬¬ ${i} ç¯€è»Šå»‚">$ {
                    i
                }

                </div>`;
            }

            // ç§»é™¤åŸæœ¬çš„å·¦å³æ–‡å­—æ¨™ç±¤ï¼Œæ”¹ç”¨æ›´ç°¡æ½”çš„ä½ˆå±€
            return ` <div class="congestion-container"><div class="cong-label-small">è»Šå»‚æ“æ“ åº¦</div><div class="congestion-bar">$ {
                carsHtml
            }

            </div></div>`;
        }

        ,

        // ğŸ”¥ Liveboard å°ˆæ¥­é‚è¼¯ï¼šå¤§å»³å„€è¡¨æ¿æ¨¡å¼ - å¤šç·šè·¯ä½µç¶²é¡¯ç¤º
        // ğŸ”¥ ä¹˜å®¢ç«™åœ¨å¤§å»³æƒ³çœ‹ã€Œæ‰€æœ‰å¯èƒ½ã€çš„è»Šï¼Œæ–¹ä¾¿é¸æ“‡è¦æ­å“ªä¸€ç­
        // ğŸ”¥ è½‰ä¹˜ç«™ç‰¹è‰²ï¼šåŒæ™‚é¡¯ç¤ºæ‰€æœ‰è·¯ç·šï¼Œä¾‹å¦‚å¿ å­å¾©èˆˆæœƒé¡¯ç¤ºæ–‡æ¹–ç·š+æ¿å—ç·š
        renderLive(trains, crowdData=[]) {
            const grid=document.getElementById('board');

            // 1. å¦‚æœ trains é™£åˆ—ç‚ºç©º (0 ç·šä¸Šåˆ—è»Š)ï¼Œé¡¯ç¤ºç„¡è³‡è¨Š
            if ( !trains || trains.length===0) {
                grid.innerHTML=`<div style="grid-column:1/-1; text-align:center; padding:100px; color:var(--text-sub);">ç›®å‰ç„¡å³æ™‚ç­æ¬¡è³‡è¨Š</div>`;
                return;
            }

            const currentStation=AppState.stations.find(s=> s.id===AppState.sid);
            const defaultColor=currentStation?.line?.color || '#0070bd';

            let groups= {}

            ;

            trains.forEach(t=> {
                    const rawID=t.LinePrefix || t.LineID || "";

                    // 1. æŸ¥æ‰¾ LineName
                    const sysLineMap=Core?.globalLineMap?.[AppState.sys] || {}

                    ;
                    let lineName=sysLineMap[rawID] || t.LineName || "æœªçŸ¥ç·šè·¯";
                    if (typeof lineName==='object') lineName=lineName.Zh_tw || "æœªçŸ¥ç·šè·¯";

                    // 2. â˜… é—œéµä¿®æ­£ï¼šä½¿ç”¨å®Œæ•´çš„ rawID (å¦‚ BR) ä¾†æŸ¥æ‰¾é¡è‰²ï¼Œè€Œä¸æ˜¯åªç”¨ç¬¬ä¸€å€‹å­— â˜…
                    // é€™æ¨£ BR å°±ä¸æœƒè¢«èª¤åˆ¤æˆ BL (å› ç‚ºéƒ½æ˜¯ B é–‹é ­)
                    const lineInfo=AppState.stations.find(s=> s.id.startsWith (rawID));

                    // å¦‚æœæ‰¾ä¸åˆ°ï¼Œæ‰å›é€€åˆ°è»Šç«™åŸæœ¬é¡è‰²
                    const lineColor=t.LineColor || lineInfo?.line?.color || currentStation?.line?.color || '#808080';

                    const dest=(t.DestinationStationName?.Zh_tw) || 'çµ‚é»ç«™';

                    const key=`[$ {
                        lineName
                    }

                    ] å¾€ $ {
                        dest
                    }

                    `;

                    if ( !groups[key]) {
                        groups[key]= {
                            trains: [], linePrefix: rawID, lineColor: lineColor
                        }

                        ;
                    }

                    groups[key].trains.push(t);
                });

            // 2. æ¸²æŸ“é‚è¼¯
            grid.innerHTML=Object.entries(groups).map(([title, group])=> {
                    const sorted=group.trains.sort((a, b)=> a.EstimateTime - b.EstimateTime);

                    // æœ€çµ‚å®¹éŒ¯ï¼šæ¸…é™¤ä»»ä½• undefined æˆ– [object Object] çš„æ®˜ç•™
                    const finalTitle=title .replace(/\[undefined\]/g, '[æœªçŸ¥ç·š]') .replace(/\[object Object\]/g, '[è·¯ç·š]');

                    return ` <div class="card" > <div class="card-header" style="background: ${group.lineColor}" > <i class="fas fa-train" ></i> <span>$ {
                        finalTitle
                    }

                    </span> </div> $ {
                        sorted.slice(0, 3).map((t, idx)=> {
                                const seconds=t.EstimateTime;
                                let timeDisplay=(t.CountDown==='åˆ—è»Šé€²ç«™' || seconds <=10) ? '<span class="arriving-badge">é€²ç«™ä¸­</span>'

                                : `<span class="time-number" style="font-size:2rem;" >$ {
                                    String(Math.floor(seconds/60)).padStart(2, '0')
                                }

                                :$ {
                                    String(seconds%60).padStart(2, '0')
                                }

                                </span>`;

                                // ç¢ºä¿è»Šå»‚æ•¸åˆ¤æ–·æ­£ç¢º
                                const congestionHtml=(AppState.sys==='TRTC' && idx===0) ? this.generateCongestionHTML(t, crowdData, group.linePrefix) : '';

                                return ` <div class="arrival-row" > <div> <div class="destination" >$ {
                                    (t.DestinationStationName?.Zh_tw) || 'çµ‚é»ç«™'
                                }

                                </div> <div class="meta" >åˆ—è»Šç·¨è™Ÿ: $ {
                                    t.TrainNumber || '--'
                                }

                                </div> </div> <div class="arrival-time" data-original="${seconds}" data-raw="${t.CountDown}" >$ {
                                    timeDisplay
                                }

                                </div> </div> $ {
                                    congestionHtml
                                }

                                `;
                            }).join('')
                    }

                    </div> `;
                }).join('');
        }

        ,

        renderSchedule(data) {
            const grid=document.getElementById('board');
            grid.className="schedule-container";
            const now=new Date();

            const currentHHmm=`$ {
                String(now.getHours()).padStart(2, '0')
            }

            :$ {
                String(now.getMinutes()).padStart(2, '0')
            }

            `;
            const dayType=['Sunday',
            'Monday',
            'Tuesday',
            'Wednesday',
            'Thursday',
            'Friday',
            'Saturday'][now.getDay()];

            if ( !data.Timetables) {
                grid.innerHTML="ç„¡è³‡æ–™";
                return;
            }

            grid.innerHTML=data.Timetables.filter(r=> r.ServiceDays[dayType]).map(route=> {
                    const future=route.Timetables.filter(t=> t.ArrivalTime >=currentHHmm);

                    const hours= {}

                    ;

                    future.forEach((trip, i)=> {
                            const hh=trip.ArrivalTime.split(':')[0];
                            if ( !hours[hh]) hours[hh]=[];

                            hours[hh].push({
                                mm: trip.ArrivalTime.split(':')[1], isNext: i===0
                            });
                    });

                const rows=Object.entries(hours).map(([h, m])=> ` <div class="hour-row" ><div class="hour-label" >$ {
                        h
                    }

                    </div><div class="minute-list" > $ {
                        m.map(mm=> `<div class="min-chip ${mm.isNext?'next-up':''}" >$ {
                                mm.mm
                            }

                            </div>`).join('')
                    }

                    </div></div>`).join('');

                return `<div class="timetable-card" ><div class="timetable-header" >å¾€ $ {
                    route.DestinationStationName.Zh_tw
                }

                </div>$ {
                    rows
                }

                </div>`;
            }).join('');
        }

        ,

        // ğŸ”¥ æ–°å¢ï¼šå•Ÿå‹•æœ¬åœ°å€’æ•¸è¨ˆæ™‚å™¨
        startLocalTicker() {
            if (AppState.localTicker) clearInterval(AppState.localTicker);

            // æ¯ç§’åŸ·è¡Œä¸€æ¬¡ UI æ›´æ–°
            AppState.localTicker=setInterval(()=> {
                    this.updateTimeDisplay();
                }

                , 1000);
        }

        ,

        // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°æ™‚é–“é¡¯ç¤ºï¼ˆæœ¬åœ°å€’æ•¸ï¼‰
        updateTimeDisplay() {
            const now=Date.now();
            const elapsedSeconds=Math.floor((now - AppState.lastFetchTime) / 1000); // è·é›¢ä¸Šæ¬¡æŠ“å–éäº†å¹¾ç§’

            // éæ­·æ‰€æœ‰å¡ç‰‡ä¸Šçš„æ™‚é–“å…ƒç´ 
            document.querySelectorAll('.arrival-time').forEach(el=> {
                    const originalSec=parseInt(el.dataset.original);
                    if (isNaN(originalSec)) return;

                    // è¨ˆç®—ç•¶å‰å‰©é¤˜ç§’æ•¸
                    let currentSec=originalSec - elapsedSeconds;

                    // å¦‚æœæ˜¯ "åˆ—è»Šé€²ç«™" ç‹€æ…‹ï¼Œæˆ–ç§’æ•¸æ­¸é›¶ï¼Œä¿æŒé¡¯ç¤ºé€²ç«™ä¸­
                    const rawStatus=el.dataset.raw;

                    if (rawStatus==='åˆ—è»Šé€²ç«™' || currentSec <=10) {
                        el.innerHTML='<span class="arriving-badge">é€²ç«™ä¸­</span>';
                    }

                    else {
                        const mm=String(Math.floor(currentSec / 60)).padStart(2, '0');
                        const ss=String(currentSec % 60).padStart(2, '0');

                        el.innerHTML=`<span class="time-number" style="font-size:2rem;" >$ {
                            mm
                        }

                        :$ {
                            ss
                        }

                        </span>`;
                    }
                });
        }

        ,

        openPIDS() {
            window.open(`metro-pids.html?sys=$ {
                    AppState.sys
                }

                &sid=$ {
                    AppState.sid
                }

                `, '_blank');
        }
        }

        ;

        // ğŸ“¢ å°ˆæ¥­å®˜æ–¹å®£å° + å¾ªç’°æ’­æ”¾é‚è¼¯ (Liveboard é©é…ç‰ˆ)
        async function updateMarquee() {
            try {
                // é©é…: ä½¿ç”¨ AppState.sys
                const system=AppState.sys || 'TRTC';

                // --- 1. å–å¾—ç›®å‰ç³»çµ±åç¨± ---
                const sysMap= {
                    'TRTC': 'å°åŒ—æ·é‹', 'KRTC': 'é«˜é›„æ·é‹', 'TYMC': 'æ¡ƒåœ’æ·é‹', 'TMRT': 'å°ä¸­æ·é‹', 'NTMC': 'æ–°åŒ—æ·é‹', 'KLRT': 'é«˜é›„è¼•è»Œ'
                }

                ;
                const sysName=sysMap[system] || 'æ·é‹ç³»çµ±';

                // --- 2. æŠ“å–æœ€æ–°æ¶ˆæ¯ ---
                let newsContent="";

                try {
                    const res=await fetch(`https: //metro-api-worker.weacamm.org/api/news?sys=${system}`);
                        const data=await res.json();

                        if (Array.isArray(data) && data.length > 0) {
                            newsContent=data.slice(0, 3).map(n=> `ã€$ {
                                    sysName
                                }

                                æœ€æ–°æ¶ˆæ¯ã€‘$ {
                                    n.Title || n.NewsTitle
                                }

                                `).join('ã€€ã€€') + 'ã€€ã€€';
                        }
                    }

                    catch (e) {
                        console.log("News fetch failed");
                    }

                    // --- 3. å®Œæ•´å®˜æ–¹å®£å°å…§å®¹ (åš´æ ¼ä¿ç•™) ---
                    const mandatoryMessages=[ "ã€TPASS 2.0ï¼ˆå…¬å…±é‹è¼¸å¸¸å®¢å„ªæƒ ï¼‰ã€‘æ°‘çœ¾åªè¦æŒè¨˜åé›»å­ç¥¨è­‰ä¸”è‡³å…¬è·¯å±€å…¬å…±é‹è¼¸å¸¸å®¢å„ªæƒ å›é¥‹å°ˆå€å®Œæˆç™»éŒ„ï¼Œæ¯æœˆæ­ä¹˜å…¬å…±é‹è¼¸é”11æ¬¡ä»¥ä¸Šï¼Œå¯äº«ä¸åŒæ¯”ä¾‹ä¹˜è»Šé‡‘é¡å›é¥‹ï¼Œè‡ºéµå’Œæ·é‹ä¹Ÿæœ‰åŠ ç¢¼ã€‚é‡å°91æ¢ä¸­é•·é€”åœ‹é“å®¢é‹è·¯ç·šè¨­è¨ˆè¼ƒæ˜“é”æˆä¹‹å›é¥‹æ¢ä»¶ï¼Œæ°‘çœ¾æ¯æœˆæ­ä¹˜2è‡³3æ¬¡å³å¯äº«æœ‰15%ä¹˜è»Šé‡‘é¡å›é¥‹ï¼Œ4æ¬¡ä»¥ä¸Šå‰‡äº«30%å›é¥‹ã€‚",
                    "é‡ç·Šæ€¥ç‹€æ³ä¿æŒå†·éœå‹¿é©šæ…Œï¼Œè«‹ä½¿ç”¨å°è¬›æ©Ÿé€šçŸ¥æœå‹™äººå“¡è™•ç†ã€‚",
                    "æ·é‹ç³»çµ±å…¨é¢ç¦æ­¢å¸è¸(å«é›»å­ç…™ç­‰é¡è¸å“)ï¼Œé•è€…ä¾æ³•æœ€é«˜å¯è™•æ–°å°å¹£1è¬å…ƒç½°é°ã€‚",
                    "æ­ä¹˜é›»æ‰¶æ¢¯å…©å´çš†å¯ç«™ç«‹ã€é¿å…ä½¿ç”¨æ‰‹æ©Ÿï¼›é›»æ‰¶æ¢¯å‡ºå…¥å£è«‹å‹¿é€—ç•™ã€‚",
                    "ã€Œè·‘ã€èº²ã€å ±ï¼é­é‡çªç™¼å¨è„…ï¼Œä¿å‘½é—œéµä¸‰æ­¥é©Ÿã€ï¼šã€Œè·‘ã€ï¼šç«‹å³è·‘é›¢ç¾å ´ï¼Œä¸åœè§€æ‹ç…§ã€‚ã€Œèº²ã€ï¼šå°‹æ‰¾å®‰å…¨è™•èº²è—ï¼Œä¿æŒå®‰éœã€‚ã€Œå ±ã€ï¼šç¢ºèªå®‰å…¨å¾Œç«‹å³å ±æ¡ˆ(110æˆ–119)ã€‚",
                    "æ™‚æ™‚å°å¿ƒé˜²æ„å¤–ï¼Œè™•è™•ç•™æ„ä¿å¹³å®‰ï¼Œç™¼ç¾ç•°å¸¸é€Ÿé€šå ±ï¼Œä¹˜è»Šå®‰å…¨å¾—ç¢ºä¿ã€‚"
                    ];

                    // --- 4. çµ„åˆæœ€çµ‚å­—ä¸² ---
                    const finalMarqueeText=`$ {
                        newsContent
                    }

                    $ {
                        mandatoryMessages.join('ã€€ã€€')
                    }

                    ç¥æ‚¨æ—…é€”æ„‰å¿«ï¼`;

                    const marqueeEl=document.getElementById('ui-marquee');

                    if (marqueeEl) {
                        marqueeEl.innerText=finalMarqueeText;
                        // å•Ÿå‹•ç„¡é™å¾ªç’°å‹•ç•«
                        runMarqueeLoop('ui-marquee');
                    }

                }

                catch (e) {
                    console.error("Marquee error:", e);
                }
            }

            // ğŸ”¥ ç„¡é™å¾ªç’°è·‘é¦¬ç‡ˆæ§åˆ¶æ ¸å¿ƒ
            function runMarqueeLoop(id) {
                const el=document.getElementById(id);
                if ( !el) return;
                const container=el.parentElement;

                // é‡ç½®ç‹€æ…‹
                el.style.transition='none';
                const containerWidth=container.offsetWidth;

                // èµ·é»ï¼šå®¹å™¨æœ€å³é‚Š
                el.style.left=containerWidth + 'px';

                // è®“ç€è¦½å™¨è¨ˆç®—å¯¬åº¦
                setTimeout(()=> {
                        const textWidth=el.offsetWidth;
                        // è¨­å®šé€Ÿåº¦ï¼šæ¯å€‹å­—ç´„ 0.45 ç§’ (æ•¸å€¼è¶Šå°è¶Šå¿«)
                        const speed=0.006;
                        const duration=(textWidth + containerWidth) * speed;

                        // åŸ·è¡Œå‹•ç•«ï¼šä½ç§»åˆ°æ–‡å­—å¯¬åº¦çš„è² å€¼ï¼ˆå®Œå…¨æ¶ˆå¤±åœ¨å·¦å´ï¼‰
                        el.style.transition=`left $ {
                            duration
                        }

                        s linear`;

                        el.style.left=`-$ {
                            textWidth
                        }

                        px`;

                        // é—œéµï¼šç›£è½å‹•ç•«çµæŸäº‹ä»¶ï¼ŒçµæŸå¾Œç«‹åˆ»é‡å•Ÿ
                        el.ontransitionend=()=> {
                            runMarqueeLoop(id);
                        }

                        ;
                    }

                    , 50);
            }

            // å•Ÿå‹•
            window.onload=()=> Core.init();
            </script> </body> </html>