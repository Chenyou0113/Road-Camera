<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快速道路監視器 - TDX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/responsive-camera.css">
    <script>window.CURRENT_PAGE = 'expressway';</script>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); min-height: 100vh; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #4CAF50; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #4CAF50; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .back-btn:hover { background: #2E7D32; }
        .loading { text-align: center; padding: 50px; color: white; font-size: 1.2rem; }
        .cameras-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        @media (max-width: 1200px) {
            .cameras-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .cameras-grid { grid-template-columns: 1fr; }
        }
        .camera-card { background: white; border-radius: 10px; padding: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.3s; overflow: hidden; }
        .camera-card:hover { transform: translateY(-5px); }
        .camera-info { padding: 15px; }
        .camera-info h3 { color: #4CAF50; margin-bottom: 8px; font-size: 1.1rem; word-wrap: break-word; overflow-wrap: break-word; }
        .camera-info p { color: #666; margin: 4px 0; font-size: 0.9rem; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.5; }
        .camera-image { width: 100%; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .camera-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .camera-image:hover img { transform: scale(1.05); }
        .image-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .camera-image:hover .image-overlay { opacity: 1; }
        .stream-placeholder, .no-image-placeholder, .image-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { position: relative; margin: 2% auto; width: 90%; max-width: 1200px; }
        .close { position: absolute; top: 15px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1001; }
        .close:hover { color: #4CAF50; }
        .modal-image { width: 100%; max-height: 80vh; object-fit: contain; }
        .modal-info { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .modal-info h2 { color: #4CAF50; margin-bottom: 10px; }
        .modal-info p { color: #666; margin: 5px 0; word-wrap: break-word; overflow-wrap: break-word; }
        
        /* 快速道路特色樣式 */
        .expressway-badge { background: #4CAF50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; display: inline-block; margin: 2px; }
        .stats-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: bold; color: #4CAF50; }
        .stat-label { color: #666; margin-top: 5px; }
        
        /* 篩選區域 */
        .filter-section { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 5px; font-weight: bold; color: #333; }
        .filter-group select, .filter-group button { padding: 10px; border-radius: 5px; border: 2px solid #4CAF50; font-size: 1rem; }
        .filter-group button { background: #4CAF50; color: white; cursor: pointer; }
        .filter-group button:hover { background: #2E7D32; }
        
        /* 分頁 */
        .pagination { display: flex; justify-content: center; align-items: center; margin: 20px 0; gap: 10px; }
        .pagination button { padding: 10px 15px; border: none; background: white; color: #4CAF50; border-radius: 5px; cursor: pointer; }
        .pagination button:hover, .pagination button.active { background: #4CAF50; color: white; }
        .pagination button:disabled { background: #ccc; cursor: not-allowed; }
        .pagination span { color: white; font-weight: bold; padding: 10px 15px; }
        
        /* 深色模式下的分頁樣式 */
        body.dark-mode .pagination button { background: rgba(255,255,255,0.1); color: #66BB6A; border: 1px solid rgba(255,255,255,0.2); }
        body.dark-mode .pagination button:hover, body.dark-mode .pagination button.active { background: #66BB6A; color: #1a1a2e; }
        body.dark-mode .pagination button:disabled { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.3); }
        body.dark-mode .pagination span { color: #66BB6A; }
        
        /* 深色模式下的篩選區域和統計面板樣式 */
        body.dark-mode .filter-section { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .filter-section h3 { color: #66BB6A; }
        body.dark-mode .filter-group label { color: rgba(255,255,255,0.9); }
        body.dark-mode .filter-group select { background: rgba(255,255,255,0.1); color: white; border-color: #66BB6A; }
        body.dark-mode .filter-group select option { background: #2a2a3e; color: white; }
        body.dark-mode .filter-group button { background: #66BB6A; color: #1a1a2e; border-color: #66BB6A; }
        body.dark-mode .filter-group button:hover { background: #81C784; }
        body.dark-mode .stat-card { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .stat-number { color: #66BB6A; }
        body.dark-mode .stat-label { color: rgba(255,255,255,0.7); }
        body.dark-mode #infoPanel { background: rgba(40,40,50,0.95); border-left-color: #66BB6A; }
        body.dark-mode #infoPanel h3 { color: #66BB6A; }
        body.dark-mode #infoContent { color: rgba(255,255,255,0.8); }
        body.dark-mode #infoContent a { color: #66BB6A; }
        
        /* 手機版響應式優化 */
        @media (max-width: 768px) {
            .camera-info { padding: 12px; }
            .camera-info h3 { font-size: 1rem; }
            .camera-info p { font-size: 0.85rem; }
            .filter-row { flex-direction: column; align-items: stretch; }
            .stats-panel { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 480px) {
            .stats-panel { grid-template-columns: 1fr; }
        }
    </style>
把這ㄍ    
    <!-- 載入進度條 -->
    <script src="assets/loading-progress.js"></script>
    <script>
        // 快速道路載入設定
        window.AUTO_START_LOADING = false;
        
        window.addEventListener('DOMContentLoaded', () => {
            window.startLoading({
                labelText: '載入快速道路監視器...',
                color: '#9C27B0',
                showLabel: true
            });
        });
    </script>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-road"></i> 快速道路監視器</h1>
            <p style="text-align: center; color: #666;">即時快速道路路況監視器</p>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回首頁</a>
            <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode" style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; cursor: pointer; margin-left: 15px; font-size: 1.2rem;">
                <i class="fas fa-moon"></i>
            </button>
        
        <!-- 快速道路監視器說明 -->
        <div id="infoPanel" style="background: #e8f5e8; border-left: 4px solid #4CAF50; padding: 20px; margin: 20px 0; border-radius: 8px; transition: all 0.3s ease;">
            <h3 style="color: #2E7D32; margin: 0 0 15px 0; display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleInfoPanel()">
                <span>
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    快速道路監視器說明
                </span>
                <i id="toggleIcon" class="fas fa-chevron-up" style="transition: transform 0.3s ease;"></i>
            </h3>
            <div id="infoContent" style="color: #333; line-height: 1.6;">
                <p style="margin: 0 0 10px 0;">
                    快速道路監視器系統提供全台各條快速道路的即時影像資料，包括西濱快速道路(台61)、東西向快速道路等。
                </p>
                
                <div style="margin: 15px 0;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">📍 主要快速道路包括：</p>
                    <div style="margin-left: 20px;">
                        <p style="margin: 5px 0;">• 台61線 - 西濱快速道路</p>
                        <p style="margin: 5px 0;">• 台62-88線 - 各東西向快速道路</p>
                        <p style="margin: 5px 0;">• 資料來源：TDX運輸資料流通服務平台</p>
                    </div>
                </div>
                
                <div style="margin: 15px 0;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">🔗 相關連結：</p>
                    <div style="margin-left: 20px;">
                        <p style="margin: 5px 0;">
                            • <a href="https://tdx.transportdata.tw" target="_blank" style="color: #2E7D32; text-decoration: none;">
                                TDX運輸資料流通服務 <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                        <p style="margin: 5px 0;">
                            • <a href="https://1968.freeway.gov.tw" target="_blank" style="color: #2E7D32; text-decoration: none;">
                                高速公路1968 <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                    </div>
                </div>
                
                <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: #666; font-style: italic;">
                    💡 點擊監視器卡片可查看放大影像和詳細資訊。
                </p>
            </div>
        </div>

        <!-- 統計面板 -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-number" id="totalCameras">0</div>
                <div class="stat-label">監視器總數</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="availableCameras">0</div>
                <div class="stat-label">可用監視器</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="filteredCameras">0</div>
                <div class="stat-label">目前顯示</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expresswayCount">0</div>
                <div class="stat-label">快速道路數</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="directionCount">0</div>
                <div class="stat-label">方向類型</div>
            </div>
        </div>

        <!-- 篩選區域 -->
        <div class="filter-section">
            <h3 style="color: #4CAF50; margin-bottom: 15px;"><i class="fas fa-filter"></i> 篩選快速道路監視器</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="roadSelect">快速道路</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #4CAF50; font-size: 1rem;" id="roadSelect" onchange="applyFilters('road')">
                        <option value="">所有快速道路</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="citySelect">縣市</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #4CAF50; font-size: 1rem;" id="citySelect" onchange="applyFilters('city')">
                        <option value="">所有縣市</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="directionSelect"><i class="fas fa-compass"></i> 方向</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #4CAF50; font-size: 1rem;" id="directionSelect" onchange="applyFilters('direction')">
                        <option value="">所有方向</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button onclick="resetFilters()"><i class="fas fa-refresh"></i> 重置篩選</button>
                </div>
            </div>
        </div>

        <div id="cameras-container" class="loading">
            <i class="fas fa-spinner fa-spin"></i> 載入快速道路監視器資料中...
        </div>

        <!-- 分頁 -->
        <div id="pagination" class="pagination" style="display: none;">
            <button onclick="changePage(-1)" id="prevBtn"><i class="fas fa-chevron-left"></i> 上一頁</button>
            <span id="pageInfo">第 1 頁，共 1 頁</span>
            <button onclick="changePage(1)" id="nextBtn">下一頁 <i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- 影像彈窗 -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img class="modal-image" id="modalImage" alt="監視器影像">
            <div class="modal-info">
                <h2 id="modalTitle">監視器資訊</h2>
                <p id="modalLocation"></p>
                <p id="modalRoad"></p>
                <p id="modalCoords"></p>
            </div>
        </div>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        let allCameras = [];
        let filteredCameras = [];
        let currentPage = 1;
        let itemsPerPage = 30;
        let totalPages = 1;
        
        // 快速道路列表
        const EXPRESSWAYS = [
            '台61', '台62', '台63', '台64', '台65', '台66', '台68', 
            '台72', '台74', '台76', '台78', '台82', '台84', '台86', '台88'
        ];
        
        // 從路段資訊中提取快速道路路線編號
        function extractExpresswayNumber(camera) {
            const roadName = camera.RoadName || '';
            const locationDesc = camera.LocationDescription || '';
            const roadSection = typeof camera.RoadSection === 'string' ? camera.RoadSection : '';
            const allText = `${roadName} ${locationDesc} ${roadSection}`;
            
            // 匹配台61、台62等快速道路格式 - 支援多種格式
            for (const expressway of EXPRESSWAYS) {
                const number = expressway.slice(1); // 取得數字部分
                const patterns = [
                    new RegExp(`[台臺](${number})線?`, 'gi'),           // 台61線 或 台61
                    new RegExp(`台灣省道(${number})線?`, 'gi'),         // 台灣省道61線
                    new RegExp(`快速道路(${number})線?`, 'gi'),         // 快速道路61線
                    new RegExp(`快速公路(${number})線?`, 'gi'),         // 快速公路61線
                    new RegExp(`省道快速公路(${number})線?`, 'gi'),     // 省道快速公路61線
                ];
                
                for (const pattern of patterns) {
                    if (pattern.test(allText)) {
                        return `${expressway}線`;
                    }
                }
            }
            
            // 特殊處理一些別名
            if (allText.includes('西濱') || allText.includes('西部濱海')) {
                return '台61線';
            }
            if (allText.includes('中投')) {
                return '台63線';
            }
            if (allText.includes('萬里瑞濱')) {
                return '台62線';
            }
            
            return '';
        }
        
        // 將英文方向轉換為中文，分為東向、西向、南向、北向
        function convertDirectionToChinese(direction) {
            if (!direction || typeof direction !== 'string') {
                return '未標示';
            }
            
            // 轉換為大寫以便統一處理
            const upperDirection = direction.toUpperCase().trim();
            
            // 判斷北向（優先順序：完整單字 > 單字母）
            if (upperDirection.includes('NORTH') || upperDirection.includes('北')) {
                return '北向';
            }
            
            // 判斷南向
            if (upperDirection.includes('SOUTH') || upperDirection.includes('南')) {
                return '南向';
            }
            
            // 判斷東向
            if (upperDirection.includes('EAST') || upperDirection.includes('東')) {
                return '東向';
            }
            
            // 判斷西向
            if (upperDirection.includes('WEST') || upperDirection.includes('西')) {
                return '西向';
            }
            
            // 單字母判斷（當沒有完整單字時）
            if (upperDirection === 'N' || upperDirection.startsWith('N ') || upperDirection.endsWith(' N')) {
                return '北向';
            }
            if (upperDirection === 'S' || upperDirection.startsWith('S ') || upperDirection.endsWith(' S')) {
                return '南向';
            }
            if (upperDirection === 'E' || upperDirection.startsWith('E ') || upperDirection.endsWith(' E')) {
                return '東向';
            }
            if (upperDirection === 'W' || upperDirection.startsWith('W ') || upperDirection.endsWith(' W')) {
                return '西向';
            }
            
            return '未標示';
        }
        
        // 格式化位置資訊，包含里程、方向和路段
        function formatLocationInfo(camera) {
            let locationParts = [];
            
            // 優先顯示里程（確保是字符串類型）
            if (camera.LocationMile && typeof camera.LocationMile === 'string') {
                locationParts.push(camera.LocationMile);
            } else if (camera.LocationDescription && typeof camera.LocationDescription === 'string') {
                locationParts.push(camera.LocationDescription);
            }
            
            // 添加方向資訊（確保是字符串類型並轉換為中文）
            if (camera.RoadDirection && typeof camera.RoadDirection === 'string') {
                const chineseDirection = convertDirectionToChinese(camera.RoadDirection);
                locationParts.push(chineseDirection);
            }
            
            // 添加路段資訊（確保是字符串類型）
            if (camera.RoadSection && typeof camera.RoadSection === 'string') {
                locationParts.push(camera.RoadSection);
            } else if (camera.LocationDescription && typeof camera.LocationDescription === 'string') {
                // 如果沒有專門的路段欄位，嘗試從位置描述中提取路段信息
                const sectionMatches = camera.LocationDescription.match(/(.*?段|.*?線|.*?交流道|.*?收費站|.*?服務區)/);
                if (sectionMatches) {
                    const sectionInfo = sectionMatches[1];
                    // 只有當sectionInfo不同於已有的LocationMile時才添加
                    if (!camera.LocationMile || !camera.LocationMile.includes(sectionInfo)) {
                        locationParts.push(sectionInfo);
                    }
                }
            }
            
            return locationParts.length > 0 ? locationParts.join(' ') : '未提供位置資訊';
        }

        // 判斷是否為快速道路
        function isExpressway(camera) {
            const expresswayNumber = extractExpresswayNumber(camera);
            return expresswayNumber !== '';
        }
        
        // 切換資訊面板顯示/隱藏
        function toggleInfoPanel() {
            const content = document.getElementById('infoContent');
            const icon = document.getElementById('toggleIcon');
            const panel = document.getElementById('infoPanel');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                icon.style.transform = 'rotate(0deg)';
                panel.style.background = '#e8f5e8';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                icon.style.transform = 'rotate(180deg)';
                panel.style.background = '#f5f5f5';
            }
        }

        // 根據經緯度判斷縣市
        function getCityFromCoordinates(lon, lat, roadName = '') {
            if (!lon || !lat) return '未知';
            
            // 台灣各縣市經緯度範圍
            const cityRanges = [
                { name: '台北市', lonMin: 121.45, lonMax: 121.65, latMin: 24.95, latMax: 25.20 },
                { name: '基隆市', lonMin: 121.65, lonMax: 121.85, latMin: 25.10, latMax: 25.25 },
                { name: '新北市', lonMin: 121.20, lonMax: 121.95, latMin: 24.70, latMax: 25.30 },
                { name: '桃園市', lonMin: 121.05, lonMax: 121.50, latMin: 24.75, latMax: 25.05 },
                { name: '新竹縣', lonMin: 120.80, lonMax: 121.30, latMin: 24.55, latMax: 24.85 },
                { name: '新竹市', lonMin: 120.90, lonMax: 121.05, latMin: 24.75, latMax: 24.85 },
                { name: '苗栗縣', lonMin: 120.55, lonMax: 121.15, latMin: 24.25, latMax: 24.75 },
                { name: '台中市', lonMin: 120.45, lonMax: 121.25, latMin: 24.05, latMax: 24.55 },
                { name: '彰化縣', lonMin: 120.35, lonMax: 120.75, latMin: 23.85, latMax: 24.25 },
                { name: '南投縣', lonMin: 120.65, lonMax: 121.25, latMin: 23.45, latMax: 24.15 },
                { name: '雲林縣', lonMin: 120.15, lonMax: 120.65, latMin: 23.45, latMax: 23.85 },
                { name: '嘉義縣', lonMin: 120.15, lonMax: 120.75, latMin: 23.15, latMax: 23.65 },
                { name: '嘉義市', lonMin: 120.40, lonMax: 120.50, latMin: 23.45, latMax: 23.52 },
                { name: '台南市', lonMin: 120.05, lonMax: 120.65, latMin: 22.85, latMax: 23.45 },
                { name: '高雄市', lonMin: 120.15, lonMax: 120.95, latMin: 22.45, latMax: 23.15 },
                { name: '屏東縣', lonMin: 120.25, lonMax: 120.95, latMin: 21.85, latMax: 22.85 },
                { name: '宜蘭縣', lonMin: 121.55, lonMax: 122.05, latMin: 24.25, latMax: 24.95 },
                { name: '花蓮縣', lonMin: 121.15, lonMax: 121.75, latMin: 23.00, latMax: 24.45 },
                { name: '台東縣', lonMin: 120.95, lonMax: 121.65, latMin: 22.35, latMax: 23.55 }
            ];
            
            for (const city of cityRanges) {
                if (lon >= city.lonMin && lon <= city.lonMax && 
                    lat >= city.latMin && lat <= city.latMax) {
                    return city.name;
                }
            }
            
            return '未知';
        }

        // 處理影像載入錯誤 - 簡化版本
        function handleImageError(img, originalUrl) {
            // 直接顯示錯誤訊息，不再重試
            img.parentNode.innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #f44336;"></i><br><span style="font-size: 0.8rem;">影像載入失敗</span>';
        }

        async function loadCameras() {
            const container = document.getElementById('cameras-container');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 載入快速道路監視器資料中...</div>';
            
            let allCamerasFromSources = [];
            
            try {
                console.log('正在載入快速道路監視器資料...');
                
                // 檢查 TDX API 是否可用
                if (typeof tdxApi === 'undefined') {
                    throw new Error('TDX API 未初始化');
                }
                
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在載入快速道路監視器資料...<br>
                        <small style="margin-top: 10px; display: block;">從 TDX 平台載入全國公路監視器並篩選快速道路...</small>
                    </div>
                `;
                
                // 嘗試多個 TDX 端點載入快速道路監視器資料
                let response = null;
                let usedEndpoint = '';
                
                const endpoints = [
                    '/v2/Road/Traffic/CCTV/Highway?$format=JSON',
                    '/v2/Road/Traffic/CCTV/Road?$format=JSON',
                    '/v2/Road/Traffic/LiveVideo/Highway?$format=JSON'
                ];
                
                for (const endpoint of endpoints) {
                    try {
                        console.log(`📍 嘗試端點: ${endpoint}`);
                        response = await tdxApi.fetchCCTV(endpoint);
                        usedEndpoint = endpoint;
                        console.log(`✅ 成功連接端點: ${endpoint}`);
                        break;
                    } catch (error) {
                        console.warn(`❌ 端點失敗: ${endpoint} - ${error.message}`);
                        continue;
                    }
                }
                
                if (!response) {
                    throw new Error('所有 API 端點都無法連接');
                }
                
                let cameras = [];
                if (Array.isArray(response)) {
                    cameras = response;
                } else if (response && response.CCTVs && Array.isArray(response.CCTVs)) {
                    cameras = response.CCTVs;
                } else if (response && response.data && Array.isArray(response.data)) {
                    cameras = response.data;
                } else {
                    console.warn('未預期的回應格式:', response);
                    cameras = [];
                }
                
                console.log(`📊 TDX 原始資料 (${usedEndpoint}): ${cameras.length} 筆`);
                
                if (cameras.length > 0) {
                    console.log('🔍 開始篩選快速道路監視器...');
                    
                    // 篩選出快速道路監視器
                    allCamerasFromSources = cameras
                        .filter(camera => {
                            const isExpwy = isExpressway(camera);
                            if (isExpwy) {
                                console.log(`✅ 找到快速道路: ${camera.RoadName || 'Unknown'} - ${extractExpresswayNumber(camera)}`);
                            }
                            return isExpwy;
                        })
                        .map(camera => {
                            const expresswayNumber = extractExpresswayNumber(camera);
                            return {...camera, source: 'tdx', RoadNumber: expresswayNumber};
                        });
                    
                    console.log(`🛣️ 篩選結果: ${allCamerasFromSources.length} 個快速道路監視器`);
                }
                
            } catch (error) {
                console.error('載入快速道路監視器資料失敗:', error);
                console.error('錯誤詳細資訊:', {
                    message: error.message,
                    stack: error.stack,
                    tdxApiAvailable: typeof tdxApi !== 'undefined',
                    configAvailable: typeof TDX_CONFIG !== 'undefined'
                });
                
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        載入失敗: ${error.message}<br>
                        <small style="color: #666; margin-top: 10px; display: block;">
                            請檢查網路連線和 TDX API 服務狀態
                        </small><br>
                        <button onclick="loadCameras()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-refresh"></i> 重新載入
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log(`📊 快速道路監視器: ${allCamerasFromSources.length} 筆`);
            
            if (allCamerasFromSources.length === 0) {
                // 顯示一些原始數據樣本以幫助調試
                if (cameras.length > 0) {
                    console.log('📋 原始資料樣本 (前3筆):');
                    cameras.slice(0, 3).forEach((camera, index) => {
                        console.log(`樣本 ${index + 1}:`, {
                            RoadName: camera.RoadName,
                            LocationDescription: camera.LocationDescription,
                            RoadSection: camera.RoadSection,
                            CCTVID: camera.CCTVID
                        });
                    });
                }
                
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-info-circle"></i><br>
                        目前沒有找到快速道路監視器資料<br>
                        <small style="color: #666; margin-top: 10px; display: block;">
                            已載入 ${cameras.length} 筆監視器資料，但未找到快速道路<br>
                            請檢查瀏覽器控制台查看詳細資訊
                        </small><br>
                        <button onclick="loadCameras()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-refresh"></i> 重新載入
                        </button>
                    </div>
                `;
                return;
            }
            
            // 處理監視器資料，並標準化方向資訊
            allCameras = allCamerasFromSources.map(camera => ({
                ...camera,
                City: getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName),
                DirectionChinese: camera.RoadDirection ? convertDirectionToChinese(camera.RoadDirection) : '未標示'
            }));
            
            filteredCameras = allCameras;
            populateFilters();
            updateStats();
            displayCameras(allCameras);
        }

        function populateFilters() {
            updateRoadSelect(allCameras);
            updateCitySelect(allCameras);
            updateDirectionSelect(allCameras);
        }

        function updateStats() {
            document.getElementById('totalCameras').textContent = allCameras.length;
            const available = allCameras.filter(c => c.VideoImageUrl || c.VideoStreamURL).length;
            document.getElementById('availableCameras').textContent = available;
            document.getElementById('filteredCameras').textContent = filteredCameras.length;
            
            // 計算快速道路數量
            const expressways = [...new Set(allCameras.map(c => c.RoadNumber).filter(Boolean))];
            document.getElementById('expresswayCount').textContent = expressways.length;
            
            // 計算方向類型數量
            const directions = [...new Set(allCameras.map(c => c.DirectionChinese).filter(Boolean))];
            document.getElementById('directionCount').textContent = directions.length;
        }

        function applyFilters(changedFilter = null) {
            const roadFilter = document.getElementById('roadSelect').value;
            const cityFilter = document.getElementById('citySelect').value;
            const directionFilter = document.getElementById('directionSelect').value;
            
            if (changedFilter === 'road') {
                if (roadFilter) {
                    const camerasForRoad = allCameras.filter(camera => camera.RoadNumber === roadFilter);
                    
                    // 更新縣市選單
                    const citiesForRoad = [...new Set(camerasForRoad.map(c => c.City).filter(Boolean))].sort();
                    const citySelect = document.getElementById('citySelect');
                    const currentCityValue = citySelect.value;
                    
                    citySelect.innerHTML = '<option value="">所有縣市</option>' + 
                        citiesForRoad.map(city => {
                            const count = camerasForRoad.filter(c => c.City === city).length;
                            return `<option value="${city}">${city} (${count})</option>`;
                        }).join('');
                    
                    if (currentCityValue && citiesForRoad.includes(currentCityValue)) {
                        citySelect.value = currentCityValue;
                    }
                    
                    // 更新方向選單
                    updateDirectionSelect(camerasForRoad, document.getElementById('directionSelect').value);
                } else {
                    updateCitySelect(allCameras);
                    updateDirectionSelect(allCameras);
                }
            } else if (changedFilter === 'city') {
                if (cityFilter) {
                    const camerasForCity = allCameras.filter(camera => camera.City === cityFilter);
                    
                    // 更新快速道路選單
                    const roadsForCity = [...new Set(camerasForCity.map(c => c.RoadNumber).filter(Boolean))].sort((a, b) => {
                        const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                        const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                        return numA - numB;
                    });
                    const roadSelect = document.getElementById('roadSelect');
                    const currentRoadValue = roadSelect.value;
                    
                    roadSelect.innerHTML = '<option value="">所有快速道路</option>' + 
                        roadsForCity.map(road => {
                            const count = camerasForCity.filter(c => c.RoadNumber === road).length;
                            return `<option value="${road}">${road} (${count})</option>`;
                        }).join('');
                    
                    if (currentRoadValue && roadsForCity.includes(currentRoadValue)) {
                        roadSelect.value = currentRoadValue;
                    }
                    
                    // 更新方向選單
                    updateDirectionSelect(camerasForCity, document.getElementById('directionSelect').value);
                } else {
                    updateRoadSelect(allCameras);
                    updateDirectionSelect(allCameras);
                }
            } else if (changedFilter === 'direction') {
                if (directionFilter) {
                    const camerasForDirection = allCameras.filter(camera => camera.DirectionChinese === directionFilter);
                    
                    // 更新快速道路選單
                    updateRoadSelect(camerasForDirection, document.getElementById('roadSelect').value);
                    
                    // 更新縣市選單
                    updateCitySelect(camerasForDirection, document.getElementById('citySelect').value);
                } else {
                    updateRoadSelect(allCameras, document.getElementById('roadSelect').value);
                    updateCitySelect(allCameras, document.getElementById('citySelect').value);
                }
            }
            
            filteredCameras = allCameras.filter(camera => {
                const matchRoad = !roadFilter || camera.RoadNumber === roadFilter;
                const matchCity = !cityFilter || camera.City === cityFilter;
                const matchDirection = !directionFilter || camera.DirectionChinese === directionFilter;
                return matchRoad && matchCity && matchDirection;
            });
            
            currentPage = 1;
            updateStats();
            displayCameras(filteredCameras);
        }
        
        function updateRoadSelect(cameras, selectedValue = '') {
            const roads = [...new Set(cameras.map(c => c.RoadNumber).filter(Boolean))].sort((a, b) => {
                const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                return numA - numB;
            });
            
            const roadSelect = document.getElementById('roadSelect');
            roadSelect.innerHTML = '<option value="">所有快速道路</option>' + 
                roads.map(road => {
                    const count = cameras.filter(c => c.RoadNumber === road).length;
                    return `<option value="${road}">${road} (${count})</option>`;
                }).join('');
            
            if (selectedValue) {
                roadSelect.value = selectedValue;
            }
        }
        
        function updateCitySelect(cameras, selectedValue = '') {
            // 台灣縣市標準排序 - 由北到南，直轄市優先
            const TAIWAN_CITY_ORDER = [
                '台北市', '新北市', '桃園市', '台中市', '台南市', '高雄市',
                '基隆市', '新竹市', '嘉義市',
                '新竹縣', '苗栗縣', '彰化縣', '南投縣', '雲林縣', '嘉義縣', '屏東縣',
                '宜蘭縣', '花蓮縣', '台東縣',
                '澎湖縣', '金門縣', '連江縣'
            ];
            
            const cities = [...new Set(cameras.map(c => c.City).filter(Boolean))];
            // 按照台灣縣市標準順序排列
            const sortedCities = cities.sort((a, b) => {
                const indexA = TAIWAN_CITY_ORDER.indexOf(a);
                const indexB = TAIWAN_CITY_ORDER.indexOf(b);
                // 如果在標準順序中找不到，則放在最後並按字母排序
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            const citySelect = document.getElementById('citySelect');
            
            citySelect.innerHTML = '<option value="">所有縣市</option>' + 
                sortedCities.map(city => {
                    const count = cameras.filter(c => c.City === city).length;
                    return `<option value="${city}">${city} (${count})</option>`;
                }).join('');
            
            if (selectedValue) {
                citySelect.value = selectedValue;
            }
        }

        function updateDirectionSelect(cameras, selectedValue = '') {
            const directions = [...new Set(cameras.map(c => c.DirectionChinese).filter(d => d && d !== '未標示'))];
            
            // 方向排序：東、西、南、北
            const directionOrder = ['東向', '西向', '南向', '北向'];
            const sortedDirections = directions.sort((a, b) => {
                const indexA = directionOrder.indexOf(a);
                const indexB = directionOrder.indexOf(b);
                
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            const directionSelect = document.getElementById('directionSelect');
            directionSelect.innerHTML = '<option value="">所有方向</option>' + 
                sortedDirections.map(direction => {
                    const count = cameras.filter(c => c.DirectionChinese === direction).length;
                    // 添加方向圖標
                    let icon = '🧭';
                    if (direction === '北向') icon = '⬆️';
                    else if (direction === '南向') icon = '⬇️';
                    else if (direction === '東向') icon = '➡️';
                    else if (direction === '西向') icon = '⬅️';
                    
                    return `<option value="${direction}">${icon} ${direction} (${count})</option>`;
                }).join('');
            
            if (selectedValue && sortedDirections.includes(selectedValue)) {
                directionSelect.value = selectedValue;
            }
        }
        
        function resetFilters() {
            document.getElementById('roadSelect').value = '';
            document.getElementById('citySelect').value = '';
            document.getElementById('directionSelect').value = '';
            applyFilters();
        }

        function displayCameras(cameras) {
            const container = document.getElementById('cameras-container');
            const pagination = document.getElementById('pagination');
            
            if (cameras.length === 0) {
                container.innerHTML = '<div class="loading">無符合篩選條件的快速道路監視器</div>';
                pagination.style.display = 'none';
                return;
            }

            // 計算分頁
            totalPages = Math.ceil(cameras.length / itemsPerPage);
            if (currentPage > totalPages) currentPage = 1;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const displayCameras = cameras.slice(startIndex, endIndex);

            const grid = displayCameras.map((camera, index) => {
                const sourceIcon = camera.source === 'tdx' ? '<i class="fas fa-database" title="TDX資料" style="color: #2196F3;"></i>' : '';
                const roadNumber = camera.RoadNumber ? `<span class="expressway-badge">${camera.RoadNumber}</span>` : '';
                
                return `
                    <div class="camera-card" onclick="openModal(${startIndex + index})">
                        <div class="camera-image">
                            ${camera.VideoImageUrl || camera.VideoStreamURL ? 
                                `<img src="${camera.VideoImageUrl || camera.VideoStreamURL}" alt="${camera.CCTVID || '監視器影像'}" 
                                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
                                     onerror="this.parentNode.innerHTML='<div style=&quot;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#999;background:#f5f5f5;border-radius:8px;&quot;><i class=&quot;fas fa-exclamation-triangle&quot; style=&quot;font-size:2rem;margin-bottom:8px;color:#f44336;&quot;></i><span style=&quot;font-size:0.85rem;text-align:center;&quot;>快速道路監視器<br>影像載入失敗</span></div>'">
                                 <div class="image-overlay">
                                     <i class="fas fa-search-plus" style="font-size: 2rem;"></i>
                                 </div>` : 
                                '<div class="no-image-placeholder"><i class="fas fa-video-slash" style="font-size: 2rem; color: #ccc; margin-bottom: 10px;"></i><span style="color: #666;">無影像資料</span></div>'
                            }
                        </div>
                        <div class="camera-info">
                            <h3>${camera.RoadName || '快速道路監視器'} ${roadNumber} ${sourceIcon}</h3>
                            <p><i class="fas fa-map-marker-alt"></i> ${formatLocationInfo(camera)}</p>
                            <p><i class="fas fa-map"></i> ${camera.City || getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName)}</p>
                            ${camera.DirectionChinese && camera.DirectionChinese !== '未標示' ? 
                                `<p><i class="fas fa-compass"></i> 方向：${camera.DirectionChinese}</p>` : ''
                            }
                            <p><i class="fas fa-id-badge"></i> ${camera.CCTVID || '未知編號'}</p>
                            ${camera.PositionLat && camera.PositionLon ? 
                                `<p><i class="fas fa-crosshairs"></i> 
                                  <a href="https://www.google.com/maps?q=${camera.PositionLat},${camera.PositionLon}" 
                                     target="_blank" 
                                     style="color: #4CAF50; text-decoration: none;" 
                                     title="在Google地圖中查看">
                                    ${camera.PositionLat.toFixed(4)}, ${camera.PositionLon.toFixed(4)}
                                    <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-left: 3px;"></i>
                                  </a>
                                </p>` : ''
                            }
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="cameras-grid">${grid}</div>`;
            
            // 更新分頁
            updatePagination();
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            pageInfo.textContent = `第 ${currentPage} 頁，共 ${totalPages} 頁`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayCameras(filteredCameras);
            }
        }

        function openModal(index) {
            const camera = filteredCameras[index];
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalLocation = document.getElementById('modalLocation');
            const modalRoad = document.getElementById('modalRoad');
            const modalCoords = document.getElementById('modalCoords');
            
            modalImg.src = camera.VideoImageUrl || camera.VideoStreamURL || '';
            modalTitle.textContent = camera.RoadName || '快速道路監視器';
            modalLocation.innerHTML = `<i class="fas fa-map-marker-alt"></i> <strong>位置：</strong>${formatLocationInfo(camera)}`;
            modalRoad.innerHTML = `<i class="fas fa-road"></i> <strong>路線：</strong>${camera.RoadNumber || '未知路線'} (${camera.City || getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName)})`;
            
            let coordsHtml = '';
            if (camera.PositionLat && camera.PositionLon) {
                coordsHtml = `<i class="fas fa-crosshairs"></i> <strong>座標：</strong>
                    <a href="https://www.google.com/maps?q=${camera.PositionLat},${camera.PositionLon}" 
                       target="_blank" 
                       style="color: #4CAF50; text-decoration: none;" 
                       title="在Google地圖中查看">
                        ${camera.PositionLat.toFixed(6)}, ${camera.PositionLon.toFixed(6)}
                        <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-left: 3px;"></i>
                    </a>`;
            }
            const imageUrl = camera.VideoImageUrl || camera.VideoStreamURL;
            if (imageUrl) {
                coordsHtml += `<br><i class="fas fa-external-link-alt"></i> <strong>原始影像：</strong><a href="${imageUrl}" target="_blank" style="color: #4CAF50; text-decoration: none;">開啟原始影像連結</a>`;
            }
            modalCoords.innerHTML = coordsHtml;
            
            modal.style.display = 'block';
        }

        // 關閉彈窗
        document.getElementsByClassName('close')[0].onclick = function() {
            document.getElementById('imageModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // 等待 TDX API 初始化
        async function waitForTdxApi() {
            let attempts = 0;
            const maxAttempts = 30; // 最多等待30秒
            
            while (attempts < maxAttempts) {
                if (typeof tdxApi !== 'undefined' && tdxApi && typeof tdxApi.fetchCCTV === 'function') {
                    console.log('✅ TDX API 已就緒');
                    return true;
                }
                console.log(`⏳ 等待 TDX API 初始化... (${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                attempts++;
            }
            
            console.error('❌ TDX API 初始化超時');
            return false;
        }

        // 初始載入
        window.onload = async function() {
            console.log('🚀 快速道路監視器頁面載入完成');
            
            // 等待 TDX API 初始化
            const apiReady = await waitForTdxApi();
            if (!apiReady) {
                document.getElementById('cameras-container').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        TDX API 初始化失敗<br><br>
                        <button onclick="window.location.reload()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-refresh"></i> 重新整理
                        </button>
                    </div>
                `;
                return;
            }
            
            loadCameras();
        };
    </script>

    <!-- Back to Top Button -->
    <div class="back-to-top" id="backToTop" style="position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999; font-size: 1.2rem;">
        <i class="fas fa-arrow-up"></i>
    </div>
</body>
</html>
