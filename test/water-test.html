<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´åˆ©ç½² API æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background: #0056b3;
        }
        .image-test {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .image-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒŠ æ°´åˆ©ç½² API æ¸¬è©¦å·¥å…·</h1>
        <p>æ¸¬è©¦æ°´åˆ©ç½² STA API çš„é€£æ¥ç‹€æ³å’Œå½±åƒè¼‰å…¥æƒ…æ³</p>
        
        <button onclick="testAPI()">æ¸¬è©¦ API é€£ç·š</button>
        <button onclick="testImages()">æ¸¬è©¦å½±åƒè¼‰å…¥</button>
        <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
        
        <div id="results"></div>
        <div id="imageTests"></div>
    </div>

    <script>
        async function testAPI() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">æ­£åœ¨æ¸¬è©¦ API é€£ç·š...</div>';
            
            try {
                console.log('é–‹å§‹æ¸¬è©¦ STA API...');
                
                const response = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%27&$count=true&$top=5');
                
                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                const result = `
                    <div class="test-result success">
                        <h3>âœ… API é€£ç·šæˆåŠŸ</h3>
                        <p><strong>ç¸½ç›£è¦–å™¨æ•¸é‡:</strong> ${data['@iot.count'] || 0}</p>
                        <p><strong>æœ¬æ¬¡æŸ¥è©¢è¿”å›:</strong> ${data.value ? data.value.length : 0} ç­†è³‡æ–™</p>
                        <p><strong>API å›æ‡‰æ™‚é–“:</strong> ${new Date().toLocaleTimeString()}</p>
                    </div>
                `;
                
                resultsDiv.innerHTML = result;
                
                // æª¢æŸ¥å½±åƒURL
                if (data.value && data.value.length > 0) {
                    const withImages = data.value.filter(item => 
                        item.Observations && 
                        item.Observations.length > 0 && 
                        item.Observations[0].result
                    );
                    
                    resultsDiv.innerHTML += `
                        <div class="test-result">
                            <h3>ğŸ“· å½±åƒè³‡æ–™åˆ†æ</h3>
                            <p><strong>æœ‰å½±åƒURLçš„ç›£è¦–å™¨:</strong> ${withImages.length} / ${data.value.length}</p>
                            ${withImages.length > 0 ? `<p><strong>ç¯„ä¾‹å½±åƒURL:</strong><br><small>${withImages[0].Observations[0].result}</small></p>` : ''}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('API æ¸¬è©¦å¤±æ•—:', error);
                resultsDiv.innerHTML = `
                    <div class="test-result error">
                        <h3>âŒ API é€£ç·šå¤±æ•—</h3>
                        <p><strong>éŒ¯èª¤è¨Šæ¯:</strong> ${error.message}</p>
                        <p><strong>å¯èƒ½åŸå› :</strong></p>
                        <ul>
                            <li>ç¶²è·¯é€£ç·šå•é¡Œ</li>
                            <li>CORS è·¨åŸŸé™åˆ¶</li>
                            <li>API æœå‹™æš«æ™‚ä¸å¯ç”¨</li>
                        </ul>
                    </div>
                `;
            }
        }
        
        async function testImages() {
            const imageTestsDiv = document.getElementById('imageTests');
            imageTestsDiv.innerHTML = '<div class="loading">æ­£åœ¨è¼‰å…¥æ¸¬è©¦å½±åƒ...</div>';
            
            try {
                const response = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%27&$count=true&$top=6');
                const data = await response.json();
                
                const withImages = data.value.filter(item => 
                    item.Observations && 
                    item.Observations.length > 0 && 
                    item.Observations[0].result
                );
                
                if (withImages.length === 0) {
                    imageTestsDiv.innerHTML = '<div class="test-result error">æ²’æœ‰æ‰¾åˆ°æœ‰å½±åƒçš„ç›£è¦–å™¨</div>';
                    return;
                }
                
                let html = '<h3>ğŸ–¼ï¸ å½±åƒè¼‰å…¥æ¸¬è©¦</h3><div class="image-test">';
                
                withImages.slice(0, 6).forEach((camera, index) => {
                    const name = camera.Thing?.name || `ç›£è¦–å™¨ ${index + 1}`;
                    const imageUrl = camera.Observations[0].result;
                    const location = camera.Thing?.properties?.location || 'æœªçŸ¥ä½ç½®';
                    
                    html += `
                        <div class="image-card">
                            <img src="${imageUrl}" 
                                 alt="${name}"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                                 onload="console.log('å½±åƒè¼‰å…¥æˆåŠŸ: ${name}')">
                            <div style="display:none; padding:20px; background:#f8d7da; color:#721c24; text-align:center; border-radius:4px;">
                                å½±åƒè¼‰å…¥å¤±æ•—
                            </div>
                            <h4 style="margin:10px 0 5px 0; font-size:14px;">${name}</h4>
                            <p style="margin:0; font-size:12px; color:#666;">${location}</p>
                            <p style="margin:5px 0 0 0; font-size:11px; color:#999; word-break:break-all;">
                                <a href="${imageUrl}" target="_blank" style="color:#007bff;">é–‹å•ŸåŸå§‹å½±åƒ</a>
                            </p>
                        </div>
                    `;
                });
                
                html += '</div>';
                imageTestsDiv.innerHTML = html;
                
            } catch (error) {
                imageTestsDiv.innerHTML = `
                    <div class="test-result error">
                        <h3>å½±åƒæ¸¬è©¦å¤±æ•—</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('imageTests').innerHTML = '';
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
        window.addEventListener('load', function() {
            console.log('æ°´åˆ©ç½² API æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
        });
    </script>
</body>
</html>