<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THSR PIDS Professional</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* --- V3.0 å°ˆæ¥­ç‰ˆé…è‰² (ç§»é™¤å»‰åƒ¹å…‰æšˆï¼Œå¼·èª¿å°æ¯”) --- */
        :root {
            --bg-color: #000000;
            --text-white: #FFFFFF;
            --border-color: #333333;

            /* åŒ—ä¸Šæ¨™æº–è‰²ï¼šæ·±ç´…æ¨™é¡Œ + ç¥ç€æ©˜å­—é«” */
            --north-header-bg: #cc0000; 
            --north-text: #ffaa00; 

            /* å—ä¸‹æ¨™æº–è‰²ï¼šæ·±ç¶ æ¨™é¡Œ + äº®ç¶ å­—é«” */
            --south-header-bg: #008000;
            --south-text: #00ff00;

            /* ç‹€æ…‹è‰² */
            --status-ok: #ffff00; /* é»ƒè‰²é¡¯ç¤ºæº–é» */
            --status-delay: #ff0000;
            
            /* åœé ç«™åœ°åœ– */
            --line-color: #555;
            --dot-inactive: #333;
            --dot-active-north: #ffaa00;
            --dot-active-south: #00ff00;
        }

        body, html {
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Arial', 'Microsoft JhengHei', sans-serif;
            overflow: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ä¸Šä¸‹åŠéƒ¨å®¹å™¨ */
        .board-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid var(--border-color);
            position: relative;
        }

        /* æ¨™é¡Œåˆ— */
        .header {
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: white;
            font-weight: bold;
            font-size: 2rem;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .header.north { background-color: var(--north-header-bg); }
        .header.south { background-color: var(--south-header-bg); }
        
        .clock-area { font-family: 'Consolas', monospace; letter-spacing: 2px; }

        /* è¡¨æ ¼å€åŸŸ */
        .table-container {
            flex: 1;
            overflow: hidden;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        thead {
            background-color: #1a1a1a;
            color: #aaaaaa;
            height: 40px;
            font-size: 1.1rem;
        }
        
        th { text-align: left; padding: 0 10px; font-weight: normal; border-bottom: 1px solid #444; }
        
        tr { height: 16vh; } /* è‡ªå‹•åˆ†é…é«˜åº¦ */
        
        td {
            padding: 0 10px;
            vertical-align: middle;
            font-size: 2rem; /* æ•¸å­—å¤§ä¸€é» */
            font-weight: bold;
            border-bottom: 1px solid #222;
        }

        /* æ¬„ä½å¯¬åº¦è¨­å®š */
        .w-train { width: 10%; font-family: 'Consolas', monospace; }
        .w-dest  { width: 12%; }
        .w-time  { width: 10%; font-family: 'Consolas', monospace; }
        .w-plat  { width: 8%; text-align: center; }
        .w-free  { width: 15%; font-size: 1.5rem; }
        .w-status{ width: 12%; }
        .w-map   { width: 33%; }

        /* é¡è‰²é‚è¼¯ */
        .north-row { color: var(--north-text); }
        .south-row { color: var(--south-text); }
        
        .text-white { color: white; }
        .status-ok { color: var(--status-ok) !important; font-size: 1.6rem; }
        
        /* åœé ç«™åœ°åœ–å„ªåŒ– */
        .station-map {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            height: 60px;
            padding: 0 10px;
        }
        .map-line {
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            height: 4px;
            background-color: var(--line-color);
            z-index: 0;
            transform: translateY(-50%);
        }
        .station-dot {
            position: relative;
            z-index: 1;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #000;
            border: 3px solid var(--dot-inactive);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* åŒ—ä¸Šäº®ç‡ˆ */
        .north-row .station-dot.active {
            background-color: var(--dot-active-north);
            border-color: #fff;
            box-shadow: 0 0 10px var(--dot-active-north);
        }
        
        /* å—ä¸‹äº®ç‡ˆ */
        .south-row .station-dot.active {
            background-color: var(--dot-active-south);
            border-color: #fff;
            box-shadow: 0 0 10px var(--dot-active-south);
        }

        .station-code {
            position: absolute;
            top: 22px;
            font-size: 0.8rem;
            color: #666;
            font-family: 'Arial', sans-serif;
            font-weight: bold;
        }
        .station-dot.active .station-code { color: white; }

        /* è·‘é¦¬ç‡ˆ */
        .marquee-footer {
            height: 40px;
            background-color: #111;
            border-top: 2px solid #cc0000; /* é è¨­ç´…ç·š */
            color: #ffcc00;
            display: flex;
            align-items: center;
            overflow: hidden;
            font-size: 1.5rem;
            white-space: nowrap;
        }
        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 25s linear infinite;
        }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

    </style>
</head>
<body>

<div id="app">
    <div class="board-section">
        <div class="header north">
            <div>åŒ—ä¸Š NORTHBOUND</div>
            <div class="clock-area">{{ currentTime }}</div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="w-train">è»Šæ¬¡ Train</th>
                        <th class="w-dest">é–‹å¾€ Dest.</th>
                        <th class="w-time">æ™‚é–“ Time</th>
                        <th class="w-plat">æœˆå° Plat.</th>
                        <th class="w-free">è‡ªç”±åº§ Non-Reserved</th>
                        <th class="w-status">ç‹€æ…‹ Status</th>
                        <th class="w-map">åœé ç«™ Stopping Stations</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="t in northboundList" :key="t.train_no" class="north-row">
                        <td class="w-train text-white">{{ t.train_no }}</td>
                        <td class="w-dest">{{ t.destination.zh }}</td>
                        <td class="w-time text-white">{{ t.departure_time }}</td>
                        <td class="w-plat text-white">{{ t.platform || '-' }}</td>
                        <td class="w-free text-white">Car {{ t.free_seating_cars }}</td>
                        <td class="w-status status-ok">æº–é» On Time</td>
                        <td class="w-map">
                            <div class="station-map">
                                <div class="map-line"></div>
                                <div v-for="s in stationsReversed" :key="s.id" 
                                     class="station-dot" 
                                     :class="{ 'active': t.stopping_stations.includes(s.id) }">
                                     <span class="station-code">{{ s.code }}</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="board-section">
        <div class="header south">
            <div>å—ä¸‹ SOUTHBOUND</div>
            <div class="station-title">{{ currentStationInfo.zh }} {{ currentStationInfo.code }}</div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="w-train">è»Šæ¬¡ Train</th>
                        <th class="w-dest">é–‹å¾€ Dest.</th>
                        <th class="w-time">æ™‚é–“ Time</th>
                        <th class="w-plat">æœˆå° Plat.</th>
                        <th class="w-free">è‡ªç”±åº§ Non-Reserved</th>
                        <th class="w-status">ç‹€æ…‹ Status</th>
                        <th class="w-map">åœé ç«™ Stopping Stations</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="t in southboundList" :key="t.train_no" class="south-row">
                        <td class="w-train text-white">{{ t.train_no }}</td>
                        <td class="w-dest">{{ t.destination.zh }}</td>
                        <td class="w-time text-white">{{ t.departure_time }}</td>
                        <td class="w-plat text-white">{{ t.platform || '-' }}</td>
                        <td class="w-free text-white">Car {{ t.free_seating_cars }}</td>
                        <td class="w-status status-ok">æº–é» On Time</td>
                        <td class="w-map">
                            <div class="station-map">
                                <div class="map-line"></div>
                                <div v-for="s in stationsNormal" :key="s.id" 
                                     class="station-dot" 
                                     :class="{ 'active': t.stopping_stations.includes(s.id) }">
                                     <span class="station-code">{{ s.code }}</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="marquee-footer">
        <div class="marquee-content">
            {{ marqueeText }}
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // è¨­å®šæ‚¨çš„ Worker API åœ°å€
            const API_URL = "https://thsr-proxy.xiaoyouwu5-fd3.workers.dev";
            
            const urlParams = new URLSearchParams(window.location.search);
            const stationID = ref(urlParams.get('station') || "1000"); // é è¨­å°åŒ—

            const rawData = ref([]);
            const currentTime = ref("");

            // ç«™é»å®šç¾©
            const stations = [
                { id: "0990", name: "å—æ¸¯", code: "NAK" },
                { id: "1000", name: "å°åŒ—", code: "TPE" },
                { id: "1010", name: "æ¿æ©‹", code: "BAC" },
                { id: "1020", name: "æ¡ƒåœ’", code: "TAY" },
                { id: "1030", name: "æ–°ç«¹", code: "HSC" },
                { id: "1035", name: "è‹—æ —", code: "MIL" },
                { id: "1040", name: "å°ä¸­", code: "TAC" },
                { id: "1043", name: "å½°åŒ–", code: "CHA" },
                { id: "1047", name: "é›²æ—", code: "YUL" },
                { id: "1050", name: "å˜‰ç¾©", code: "CHY" },
                { id: "1060", name: "å°å—", code: "TNN" },
                { id: "1070", name: "å·¦ç‡Ÿ", code: "ZUY" }
            ];

            const currentStationInfo = computed(() => {
                const s = stations.find(x => x.id === stationID.value);
                return s ? { zh: s.name, code: s.code } : { zh: "å°åŒ—", code: "TPE" };
            });

            // ä¿®æ­£è³‡æ–™éæ¿¾é‚è¼¯ï¼šç¢ºä¿åªæœ‰ã€Œæœªä¾†æ™‚é–“ã€çš„è»Šæ¬¡
            const futureTrains = computed(() => {
                const now = new Date();
                // æ ¼å¼åŒ–ç‚º HH:MM
                const currentHm = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
                
                return rawData.value.filter(t => t.departure_time >= currentHm);
            });

            // ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šåš´æ ¼å€åˆ†å—ä¸‹åŒ—ä¸Š ğŸ”¥
            // API é€šå¸¸å®šç¾©ï¼šDirection 0 = å—ä¸‹, 1 = åŒ—ä¸Š
            const southboundList = computed(() => {
                return futureTrains.value
                    .filter(t => t.direction === 0) 
                    .slice(0, 4); // åªå–å‰4ç­
            });

            const northboundList = computed(() => {
                return futureTrains.value
                    .filter(t => t.direction === 1)
                    .slice(0, 4); // åªå–å‰4ç­
            });

            // åœ°åœ–é¡¯ç¤ºç”¨çš„ç«™é»é †åº
            const stationsNormal = stations; 
            const stationsReversed = [...stations].reverse();

            // è·‘é¦¬ç‡ˆ
            const marqueeText = computed(() => {
                if (northboundList.value.length === 0 && southboundList.value.length === 0) 
                    return "ç›®å‰ç„¡ç‡Ÿé‹åˆ—è»Š / No Service Available";
                return "æ­¡è¿æ­ä¹˜å°ç£é«˜éµ Welcome to Taiwan High Speed Rail (Simulated PIDS System)";
            });

            // è³‡æ–™æŠ“å–
            const fetchData = async () => {
                try {
                    const res = await fetch(`${API_URL}/?station=${stationID.value}`);
                    const json = await res.json();
                    
                    // ä¿®æ­£ UNK å•é¡Œï¼šç¢ºä¿ train_no å­˜åœ¨
                    if (json.trains) {
                        rawData.value = json.trains.map(t => ({
                            ...t,
                            train_no: t.train_no || t.TrainNo || "UNK", // å¤šé‡æª¢æŸ¥
                            direction: parseInt(t.direction) // ç¢ºä¿æ˜¯æ•¸å­—
                        }));
                    }
                } catch (e) {
                    console.error("API Error:", e);
                }
            };

            // æ™‚é˜æ›´æ–°
            setInterval(() => {
                const now = new Date();
                currentTime.value = now.toLocaleTimeString('en-US', { hour12: false });
            }, 1000);

            // å®šæ™‚æ›´æ–°è³‡æ–™
            setInterval(fetchData, 30000);
            
            onMounted(() => {
                fetchData();
                const now = new Date();
                currentTime.value = now.toLocaleTimeString('en-US', { hour12: false });
            });

            return {
                stationID, currentStationInfo, currentTime,
                stationsNormal, stationsReversed,
                northboundList, southboundList,
                marqueeText
            };
        }
    }).mount('#app');
</script>

</body>
</html>