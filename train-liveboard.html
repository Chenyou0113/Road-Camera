<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>è‡ºéµå³æ™‚çœ‹æ¿ - çœŸå¯¦åˆ—è»Šå‹•æ…‹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <script>window.CURRENT_PAGE = 'train-liveboard';</script>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script src="assets/train-line-classification.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #3575ff 0%, #15bbd8 100%); 
            min-height: 100vh; 
            padding-bottom: 140px;
        }
        
        /* ... (Header & Panel æ¨£å¼ä¿æŒä¸è®Š) ... */
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #D84315; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #016d68; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; transition: background 0.3s; }
        .back-btn:hover { background: #034d64; }
        
        .control-panel { 
            background: linear-gradient(135deg, rgba(53, 134, 255, 0.9) 0%, rgba(21, 144, 216, 0.9) 100%);
            margin: 20px 0; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); border: 1px solid rgba(255,107,53,0.5);
        }
        .control-panel h3 { color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
        .selector-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 15px; align-items: end; }
        .selector-group { display: flex; flex-direction: column; }
        .selector-group label { margin-bottom: 8px; font-weight: 600; color: white; font-size: 0.95rem; }
        .selector-group select, .selector-group input { padding: 12px 15px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.3); background: white; color: #333; font-size: 1rem; }
        .query-btn { padding: 12px 30px; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .query-btn:hover { background: #45a049; transform: translateY(-2px); }
        .query-btn:disabled { background: #ccc; cursor: not-allowed; }

        .train-container { background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; margin: 20px 0; }
        .board-header { background: linear-gradient(135deg, #FF6B35 0%, #D84315 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .board-title h2 { font-size: 1.5rem; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        .pids-btn { display: inline-flex; align-items: center; gap: 8px; background: #212121; color: #ffb74d; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-weight: bold; border: 1px solid #444; transition: all 0.3s; font-size: 0.9rem; }
        .pids-btn:hover { background: #000; color: #fff; transform: translateY(-2px); }
        
        .direction-header { background: #f5f5f5; padding: 15px 20px; font-weight: 600; color: #333; border-left: 4px solid #FF6B35; font-size: 1.05rem; }
        .train-card { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee; }
        .train-card:hover { background: #f9f9f9; }
        .train-info { display: flex; align-items: center; gap: 12px; }
        .train-type-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; color: white; font-size: 0.85rem; font-weight: bold; min-width: 60px; text-align: center; }
        
        .type-è‡ªå¼· { background-color: #FF5722; }
        .type-è‡ªå¼·3000 { background: linear-gradient(135deg, #000000 0%, #333333 100%); border: 1px solid #666; }
        .type-æ™®æ‚ ç‘ª { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); }
        .type-å¤ªé­¯é–£ { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .type-è’å…‰ { background-color: #FF9800; }
        .type-å€é–“å¿« { background-color: #3F51B5; }
        .type-å€é–“ { background-color: #2196F3; }
        .type-å…¶ä»– { background-color: #607D8B; }

        .train-no { font-weight: bold; color: #333; }
        .destination { color: #666; font-size: 0.95rem; }
        .schedule-time { text-align: center; font-weight: 600; color: #333; font-size: 1.1rem; }
        .schedule-label { font-size: 0.75rem; color: #999; }
        .delay-badge { display: inline-block; padding: 6px 10px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .delay-ok { background-color: #E8F5E9; color: #2E7D32; }
        .delay-warn { background-color: #FFEBEE; color: #C62828; }

        .no-data { text-align: center; padding: 60px 20px; color: #999; }
        .no-data i { font-size: 3rem; margin-bottom: 20px; opacity: 0.5; }

        /* === è·‘é¦¬ç‡ˆæ¨£å¼ä¿®æ­£ === */
        .marquee-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; 
            background-color: #1a1a1a; display: flex; align-items: center; z-index: 9999;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.4); border-top: 3px solid #ff9800;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .marquee-info {
            background: #000000; min-width: 140px; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; /* æ”¹å›ç½®ä¸­å°é½Š */
            padding: 5px 15px; border-right: 2px solid #333; z-index: 20; position: relative;
            box-shadow: 5px 0 20px rgba(0,0,0,0.9); flex-shrink: 0;
        }

        .marquee-train-no { font-size: 1.6rem; font-weight: 800; color: #ffeb3b; line-height: 1.2; }
        .marquee-dest { font-size: 1.1rem; color: #ffffff; font-weight: 600; opacity: 0.9; }
        
        .marquee-content-wrapper {
            flex: 1; overflow: hidden; position: relative; height: 100%; background: #1a1a1a;
            mask-image: linear-gradient(to right, transparent, black 20px, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 20px, black 95%, transparent);
            display: flex; align-items: center;
        }

        .marquee-content {
            position: absolute; white-space: nowrap; font-size: 1.3rem; font-weight: bold;
            line-height: 75px; padding-left: 100%; color: #fff; will-change: transform;
        }

        .marquee-close {
            background: #222; border: none; border-left: 1px solid #444; color: #999;
            width: 50px; height: 100%; font-size: 1.8rem; cursor: pointer; z-index: 20;
        }

        .station-stop { color: #ff3d00; }
        .station-arrow { color: #00e676; margin: 0 5px; font-size: 1rem; }

        @keyframes marquee-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* === ğŸ“± æ‰‹æ©Ÿç‰ˆå°ˆç”¨ä¿®æ­£ === */
        @media (max-width: 768px) {
            body { padding-bottom: 140px !important; }
            .selector-row { grid-template-columns: 1fr; }
            .train-card { grid-template-columns: 1fr; gap: 10px; padding: 15px; }
            .train-info { width: 100%; justify-content: flex-start; margin-bottom: 5px; }
            .train-destination { display: flex; align-items: center; gap: 10px; }
            .schedule-time { text-align: left; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; }
            .schedule-label { font-size: 0.9rem; margin-top: 0; }
            .delay-status { text-align: left; }
            .board-title h2 { flex-direction: column; align-items: flex-start; }
            .pids-btn { width: 100%; justify-content: center; margin-top: 10px; }

            .marquee-bar { height: 70px; }
            .marquee-info { min-width: 110px; padding: 0 10px; }
            .marquee-train-no { font-size: 1.3rem; }
            .marquee-dest { font-size: 1rem; }
            .marquee-content { font-size: 1.1rem; line-height: 70px; }
            
            /* ä¸Šæ–¹è·‘é¦¬ç‡ˆä¿®æ­£ */
            .tra-marquee {
                height: auto !important;
                min-height: 65px;
                padding-bottom: calc(15px + env(safe-area-inset-bottom)) !important;
                background-color: #1a1a1a;
            }
            .marquee-wrapper { height: 65px; }
            .marquee-content { line-height: 65px; }
        }

        /* æ·±è‰²æ¨¡å¼ */
        body.dark-mode { background: #121212; color: #e0e0e0; }
        body.dark-mode .header, body.dark-mode .control-panel, body.dark-mode .train-container { background: #1e1e1e; border-color: #333; }
        body.dark-mode .train-card { background-color: #1e1e1e; border-bottom-color: #333; }
        body.dark-mode .train-no { color: #fff; }
        body.dark-mode select, body.dark-mode input { background-color: #2c2c2c; border-color: #444; color: #fff; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é </a>
            <h1><i class="fas fa-train"></i> å°éµå³æ™‚çœ‹æ¿</h1>
        </div>
    </div>

    <div class="container">
        <div class="info-panel rail-news" id="traAlertPanel" style="display: none;">
            <h3>
                <span><i class="fas fa-bullhorn"></i> å°éµç‡Ÿé‹é€šé˜»</span>
                <small style="font-size: 0.8rem; margin-left: 10px; font-weight: normal;">(è¿‘ 5 ç­†)</small>
            </h3>
            <div id="traAlertContent" class="news-content"></div>
        </div>

        <div class="control-panel">
            <h3><i class="fas fa-search"></i> æŸ¥è©¢å³æ™‚çœ‹æ¿</h3>
            <div class="selector-row">
                <div class="selector-group">
                    <label>è·¯ç·šåˆ†é¡</label>
                    <select id="lineSelect" onchange="filterStations()"><option value="all">å…¨éƒ¨è·¯ç·š</option></select>
                </div>
                <div class="selector-group">
                    <label>æœå°‹è»Šç«™</label>
                    <input type="text" id="stationSearch" placeholder="è¼¸å…¥ç«™åæˆ–ä»£ç¢¼" oninput="filterStations()">
                </div>
                <div class="selector-group">
                    <label>é¸æ“‡è»Šç«™</label>
                    <select id="stationSelect"><option value="">è«‹é¸æ“‡è»Šç«™...</option></select>
                </div>
                <div class="selector-group">
                    <label>æ–¹å‘</label>
                    <select id="directionFilter">
                        <option value="">å…¨éƒ¨</option>
                        <option value="0">é †è¡Œ</option>
                        <option value="1">é€†è¡Œ</option>
                    </select>
                </div>
                <button class="query-btn" id="queryBtn" onclick="fetchTrainLiveBoard()"><i class="fas fa-sync-alt"></i> æŸ¥è©¢</button>
            </div>
        </div>

        <div class="tra-marquee">
            <div class="marquee-icon"><i class="fas fa-bell"></i></div>
            <div class="marquee-wrapper">
                <div class="marquee-content" id="marqueeText">
                    <span>æ­¡è¿æ­ä¹˜å°éµã€‚æœ¬çœ‹æ¿è³‡æ–™ç”± TDX æä¾›ï¼Œåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›é‹è¡Œè«‹ä»¥è»Šç«™ç¾å ´ç‚ºä¸»ã€‚</span>
                </div>
            </div>
        </div>

        <div class="data-disclaimer">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>âš ï¸ æ³¨æ„äº‹é …ï¼š</strong>
                æœ¬çœ‹æ¿è³‡æ–™ä¾†æºç‚º TDX å¹³å°åŠ å€¼é‹ç®—ï¼Œèˆ‡è‡ºéµå®˜ç¶²ä¸€è‡´ä½†ç´„æœ‰ <strong>2 åˆ†é˜å»¶é²</strong>ã€‚
                <br>
                <span style="font-size: 0.85em; opacity: 0.9;">
                    (è‹¥æ‚¨å·²é€²å…¥è»Šç«™ï¼Œè«‹ä»¥è»Šç«™å¤§å»³æˆ–æœˆå°ä¸Šçš„é¡¯ç¤ºå™¨è³‡è¨Šç‚ºä¸»ï¼Œä»¥å…å»¶èª¤è¡Œç¨‹ã€‚)
                </span>
            </div>
        </div>

        <div id="trainContainer" class="train-container" style="display: none;">
            <div class="board-header">
                <div class="board-title">
                    <h2 id="stationTitle">å°éµå³æ™‚çœ‹æ¿</h2>
                    <div class="board-info">
                        <span id="stationInfo"></span>
                        <span class="sync-time"><i class="fas fa-clock"></i> <span id="updateTime">--:--:--</span></span>
                    </div>
                </div>
            </div>
            <div id="trainsBoard"></div>
        </div>
    </div>

    <div id="trainMarqueeBar" class="marquee-bar" style="display: none;">
        <div class="marquee-info">
            <span class="marquee-train-no" id="mqTrainNo"></span>
            <span class="marquee-dest" id="mqDest"></span>
        </div>
        <div class="marquee-content-wrapper">
            <div class="marquee-content" id="mqContent"></div>
        </div>
        <button class="marquee-close" onclick="closeMarquee()">Ã—</button>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        let currentStationID = '';
        let currentStationName = '';
        let allStationsFlat = [];
        const trainDataCache = {};
        const WORKER_URL = "https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev"; // æ‚¨çš„ Worker ç¶²å€

        const TRAIN_TYPE_DB = [
          { "id": "1100", "name": "è‡ªå¼·" }, { "id": "1101", "name": "å¤ªé­¯é–£" }, { "id": "1102", "name": "è‡ªå¼·" },
          { "id": "1107", "name": "æ™®æ‚ ç‘ª" }, { "id": "1108", "name": "è‡ªå¼·" }, { "id": "110B", "name": "è‡ªå¼·(3000)" },
          { "id": "110G", "name": "è‡ªå¼·(3000)" }, { "id": "1110", "name": "è’å…‰" }, { "id": "1131", "name": "å€é–“" },
          { "id": "1132", "name": "å€é–“å¿«" }, { "id": "1140", "name": "æ™®å¿«" }
        ];
        const trainTypeMap = new Map();
        TRAIN_TYPE_DB.forEach(item => trainTypeMap.set(item.id, item.name));

        document.addEventListener('DOMContentLoaded', () => {
            initStationControls();
            setInterval(updateTime, 1000);
            loadTraAlerts();
        });

        // ... (è¼‰å…¥å…¬å‘Šèˆ‡åˆå§‹åŒ–æ§åˆ¶é …çš„å‡½å¼ä¿æŒä¸è®Šï¼Œçœç•¥ä»¥ç¯€çœç¯‡å¹…) ...
        async function loadTraAlerts() { /* ç¨‹å¼ç¢¼åŒä¸Šå€‹ç‰ˆæœ¬ */
             try {
                const endpoint = '/v3/Rail/TRA/Alert?$format=JSON&$top=5&$orderby=PublishTime%20desc';
                const response = await tdxApi.fetch(endpoint);
                const panel = document.getElementById('traAlertPanel');
                const content = document.getElementById('traAlertContent');
                const marqueeEl = document.getElementById('marqueeText');
                let alertList = [];
                if (response && response.Alerts && Array.isArray(response.Alerts)) alertList = response.Alerts;
                else if (Array.isArray(response)) alertList = response;

                if (alertList.length === 0) { if (panel) panel.style.display = 'none'; return; }

                if (marqueeEl) {
                    marqueeEl.style.animation = 'none'; marqueeEl.offsetHeight; marqueeEl.innerHTML = '';
                    alertList.forEach(alert => {
                        const span = document.createElement('span');
                        const cleanDesc = (alert.Description || '').replace(/[\r\n]+/g, ' ');
                        span.innerText = `ã€${alert.Title}ã€‘${cleanDesc} `;
                        marqueeEl.appendChild(span);
                    });
                    const footerSpan = document.createElement('span');
                    footerSpan.innerText = "âš ï¸ å¯¦éš›é‹è¡Œè«‹ä»¥ç¾å ´å…¬å‘Šç‚ºä¸»ã€‚";
                    marqueeEl.appendChild(footerSpan);
                    marqueeEl.style.animation = 'marquee 25s linear infinite';
                }
                if (panel && content) {
                    let html = '';
                    alertList.forEach(alert => {
                        let icon = (alert.Status===2||alert.Level>1) ? 'ğŸš¨' : 'â„¹ï¸';
                        let color = (alert.Status===2||alert.Level>1) ? '#d32f2f' : '#e65100';
                        const timeStr = new Date(alert.PublishTime).toLocaleString('zh-TW', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
                        html += `<div class="news-item"><div class="news-title" style="color:${color}"><span>${icon}</span><span>${alert.Title}</span></div><div class="news-desc">${(alert.Description||'').replace(/\n/g, '<br>')}</div><div class="news-time"><i class="far fa-clock"></i> ${timeStr}</div></div>`;
                    });
                    content.innerHTML = html; panel.style.display = 'block';
                }
            } catch (e) {}
        }

        function initStationControls() {
            const lineSelect = document.getElementById('lineSelect');
            for (const [key, data] of Object.entries(trainLineClassification)) {
                const option = document.createElement('option');
                option.value = key; option.textContent = data.name; lineSelect.appendChild(option);
                data.stations.forEach(s => {
                    if(!allStationsFlat.find(x=>x.code===s.code)) allStationsFlat.push({code:s.code, name:s.name, lineKey:key});
                });
            }
            filterStations();
        }

        function filterStations() {
            const line = document.getElementById('lineSelect').value;
            const kw = document.getElementById('stationSearch').value.trim();
            let list = (line === 'all') ? allStationsFlat : trainLineClassification[line].stations;
            if(kw) list = list.filter(s => s.name.includes(kw) || s.code.includes(kw));
            const select = document.getElementById('stationSelect');
            select.innerHTML = '<option value="">è«‹é¸æ“‡è»Šç«™...</option>';
            list.forEach(s => { const opt = document.createElement('option'); opt.value = s.code; opt.text = `${s.code} - ${s.name}`; select.add(opt); });
        }

        async function fetchTrainLiveBoard() {
            const select = document.getElementById('stationSelect');
            currentStationID = select.value;
            if (!currentStationID) return alert('è«‹å…ˆé¸æ“‡è»Šç«™');
            currentStationName = select.options[select.selectedIndex].text.split(' - ')[1];
            document.getElementById('queryBtn').disabled = true;

            try {
                const url = `/v2/Rail/TRA/LiveBoard?$filter=StationID eq '${currentStationID}'&$format=JSON`;
                const response = await tdxApi.fetch(url);
                const trains = Array.isArray(response) ? response : [];

                // å»é™¤é‡è¤‡è»Šæ¬¡
                const uniqueTrains = [];
                const seenTrains = new Set();
                trains.forEach(t => {
                    if (!seenTrains.has(t.TrainNo)) { seenTrains.add(t.TrainNo); uniqueTrains.push(t); }
                });
                renderBoard(uniqueTrains);
            } catch (e) {
                console.error(e);
                document.getElementById('trainsBoard').innerHTML = `<div class="no-data"><p>æŸ¥è©¢å¤±æ•—</p></div>`;
            } finally {
                document.getElementById('queryBtn').disabled = false;
            }
        }

        function renderBoard(trains) {
            const container = document.getElementById('trainContainer');
            const board = document.getElementById('trainsBoard');
            const dirFilter = document.getElementById('directionFilter').value;
            const pidsUrl = `pids-live.html?station=${currentStationID}&name=${encodeURIComponent(currentStationName)}`;
            document.getElementById('stationTitle').innerHTML = `${currentStationName} çœ‹æ¿ <a href="${pidsUrl}" target="_blank" class="pids-btn"><i class="fas fa-desktop"></i> PIDS</a>`;
            document.getElementById('stationInfo').innerText = `ä»£ç¢¼ï¼š${currentStationID}`;

            if(trains.length === 0) {
                board.innerHTML = '<div class="no-data"><p>ç›®å‰ç„¡åˆ—è»Šè³‡è¨Š</p></div>'; container.style.display = 'block'; return;
            }

            const groups = { '0': {t:'é †è¡Œ', list:[]}, '1': {t:'é€†è¡Œ', list:[]} };
            trains.forEach(t => {
                if(dirFilter === '' || String(t.Direction) === dirFilter) {
                    if(groups[String(t.Direction)]) groups[String(t.Direction)].list.push(t);
                }
            });

            let html = '';
            for(const [k, g] of Object.entries(groups)) {
                if(g.list.length === 0) continue;
                g.list.sort((a,b) => (a.ScheduledDepartureTime||'').localeCompare(b.ScheduledDepartureTime||''));
                html += `<div class="direction-header">${g.t}</div>`;
                g.list.forEach(t => {
                    const info = getTrainDisplayInfo(t);
                    const delay = t.DelayTime || 0;
                    const delayHtml = delay===0 ? '<span class="delay-badge delay-ok">æº–é»</span>' : `<span class="delay-badge delay-warn">æ™š ${delay} åˆ†</span>`;
                    html += `
                    <div class="train-card" onclick="showTrainStops('${t.TrainNo}', '${currentStationID}', '${t.EndingStationName}')" 
                         onmouseenter="prefetchTrainData('${t.TrainNo}')">
                        <div class="train-info">
                            <span class="train-type-badge type-${info.class}">${info.name}</span>
                            <div><div class="train-no">${t.TrainNo} æ¬¡</div><div class="destination">å¾€ ${t.EndingStationName}</div></div>
                        </div>
                        <div class="schedule-time">${t.ScheduledDepartureTime?.slice(0,5)} <span class="schedule-label">è¡¨å®š</span></div>
                        <div class="delay-status">${delayHtml}</div>
                    </div>`;
                });
            }
            board.innerHTML = html; container.style.display = 'block';
        }

        async function showTrainStops(trainNo, currentStationID, destName) {
            const bar = document.getElementById('trainMarqueeBar');
            const content = document.getElementById('mqContent');
            bar.style.display = 'flex';
            document.getElementById('mqTrainNo').innerText = `${trainNo} æ¬¡`;
            document.getElementById('mqDest').innerText = `å¾€ ${destName}`;
            content.innerHTML = '<span style="color:#aaa;">è³‡æ–™è®€å–ä¸­...</span>';
            content.style.animation = 'none';

            try {
                let stopTimes, liveData;
                if(trainDataCache[trainNo]) {
                    [stopTimes, liveData] = await trainDataCache[trainNo];
                } else {
                    const p1 = fetch(`${WORKER_URL}/api/schedule?trainNo=${trainNo}`).then(r=>r.json()).then(d=>(d&&d.length>0)?d[0].StopTimes:[]).catch(()=>[]);
                    const p2 = fetch(`${WORKER_URL}/api/live?trainNo=${trainNo}`).then(r=>r.json()).then(d=>(d.TrainLiveBoards&&d.TrainLiveBoards.length>0)?d.TrainLiveBoards[0]:null).catch(()=>null);
                    [stopTimes, liveData] = await Promise.all([p1, p2]);
                    trainDataCache[trainNo] = Promise.resolve([stopTimes, liveData]);
                }

                const delay = (liveData && liveData.DelayTime!==undefined) ? parseInt(liveData.DelayTime) : 0;
                let html = '';

                // 1. ä½ç½®
                if (liveData && liveData.StationName) {
                    const cur = liveData.StationName.Zh_tw;
                    const dTxt = delay<=0 ? '<span style="color:#00e676;">(æº–é»)</span>' : `<span style="color:#ff5252;">(æ™š ${delay} åˆ†)</span>`;
                    let next = '';
                    if(stopTimes.length>0) {
                        const idx = stopTimes.findIndex(s=>s.StationName.Zh_tw===cur);
                        if(idx!==-1 && idx<stopTimes.length-1) next = stopTimes[idx+1].StationName.Zh_tw;
                    }
                    const locTxt = next ? `${cur} â–¶ ${next} å€é–“` : `ä½æ–¼ ${cur}`;
                    html += `<span style="color:#aaa;">ç›®å‰ä½ç½®ï¼š</span><span style="color:#ffeb3b; font-size:1.1rem; font-weight:bold;">${locTxt}</span> ${dTxt}`;
                } else {
                    html += `<span style="color:#aaa;">(æš«ç„¡å³æ™‚è¨Šè™Ÿ)</span>`;
                }

                html += `<span style="margin:0 25px; border-left:2px solid #555;"></span>`;

                // ğŸ”¥ 2. é è¨ˆæŠµé”æ™‚é–“ (ç§»å…¥è·‘é¦¬ç‡ˆ)
                if (stopTimes.length > 0) {
                    const idx = stopTimes.findIndex(s => s.StationID === currentStationID);
                    if (idx !== -1) {
                        const myTime = stopTimes[idx].ArrivalTime || stopTimes[idx].DepartureTime;
                        const predTime = addMinutesToTime(myTime, delay);
                        const color = delay > 0 ? '#ff5252' : '#00e676';
                        html += `<span style="color:#fff;">æœ¬ç«™é è¨ˆï¼š</span><span style="color:${color}; font-weight:bold; font-size:1.2rem;">${predTime}</span><span style="color:#aaa;"> æŠµé”</span><span style="margin:0 25px; border-left:2px solid #555;"></span>`;
                    }
                }

                // 3. å¾ŒçºŒåœé 
                if (stopTimes.length > 0) {
                    const idx = stopTimes.findIndex(s => s.StationID === currentStationID);
                    if (idx !== -1) {
                        const stops = stopTimes.slice(idx + 1).map(s => `<span class="station-stop">${s.StationName.Zh_tw}</span>`).join('<span class="station-arrow">â–¶</span>');
                        if(stops) html += `<span style="color:#aaa;">å¾ŒçºŒåœé ï¼š</span>${stops}`;
                        else html += `<span style="color:#ff9800;">æœ¬åˆ—è»Šå³å°‡æŠµé”çµ‚é»</span>`;
                    }
                }

                content.innerHTML = html;
                void content.offsetHeight; 
                // ğŸš€ é«˜é€Ÿæ»¾å‹•ä¿‚æ•¸ 0.15
                const dur = Math.max(8, content.innerText.length * 0.15);
                content.style.animation = `marquee-scroll ${dur}s linear infinite`;

            } catch(e) { console.error(e); content.innerHTML = 'è®€å–å¤±æ•—'; }
        }

        function prefetchTrainData(no) {
            if(!trainDataCache[no]) {
                const p1 = fetch(`${WORKER_URL}/api/schedule?trainNo=${no}`).then(r=>r.json()).then(d=>(d&&d.length>0)?d[0].StopTimes:[]).catch(()=>[]);
                const p2 = fetch(`${WORKER_URL}/api/live?trainNo=${no}`).then(r=>r.json()).then(d=>(d.TrainLiveBoards&&d.TrainLiveBoards.length>0)?d.TrainLiveBoards[0]:null).catch(()=>null);
                trainDataCache[no] = Promise.all([p1, p2]);
            }
        }

        function closeMarquee() { document.getElementById('trainMarqueeBar').style.display='none'; }
        function addMinutesToTime(t, m) {
            if(!t) return '--:--';
            const [hh, mm] = t.split(':').map(Number);
            const d = new Date(); d.setHours(hh); d.setMinutes(mm+m);
            return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }
        function updateTime() { document.getElementById('updateTime').innerText = new Date().toLocaleTimeString('zh-TW', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'}); }
        function getTrainDisplayInfo(t) {
            let n = t.TrainTypeName?.Zh_tw || 'åˆ—è»Š';
            if(trainTypeMap.has(t.TrainTypeID)) n = trainTypeMap.get(t.TrainTypeID);
            let cls = 'å…¶ä»–';
            if(n.includes('æ™®æ‚ ç‘ª')) cls='æ™®æ‚ ç‘ª'; else if(n.includes('å¤ªé­¯é–£')) cls='å¤ªé­¯é–£'; else if(n.includes('3000')) cls='è‡ªå¼·3000'; else if(n.includes('è‡ªå¼·')) cls='è‡ªå¼·'; else if(n.includes('è’å…‰')) cls='è’å…‰'; else if(n.includes('å€é–“å¿«')) cls='å€é–“å¿«'; else if(n.includes('å€é–“')) cls='å€é–“'; else if(n.includes('æ™®å¿«')) cls='æ™®å¿«';
            return {name:n, class:cls};
        }
    </script>
</body>
</html>