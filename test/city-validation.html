<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç³»çµ±ç¸£å¸‚æ­¸é¡é©—è­‰å·¥å…·</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; text-align: center; }
        .system-card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .system-title { color: #2196F3; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .check-btn { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .check-btn:hover { background: #45a049; }
        .check-btn:disabled { background: #ccc; cursor: not-allowed; }
        .progress-bar { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: #4CAF50; transition: width 0.3s ease; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .status.loading { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status.warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .camera-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 15px; margin-top: 20px; }
        .camera-item { padding: 12px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff; position: relative; }
        .camera-item.correct { border-left-color: #28a745; background: #d4edda; }
        .camera-item.incorrect { border-left-color: #dc3545; background: #f8d7da; }
        .camera-item.suspicious { border-left-color: #ffc107; background: #fff3cd; }
        .camera-name { font-weight: bold; color: #333; margin-bottom: 5px; }
        .camera-details { font-size: 0.9rem; color: #666; }
        .coordinates { font-family: monospace; background: #e9ecef; padding: 2px 4px; border-radius: 3px; }
        .city-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 5px; }
        .city-badge.correct { background: #28a745; color: white; }
        .city-badge.incorrect { background: #dc3545; color: white; }
        .city-badge.suspicious { background: #ffc107; color: black; }
        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: bold; color: #2196F3; }
        .stat-label { color: #666; margin-top: 5px; }
        .export-btn { background: #FF9800; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .export-btn:hover { background: #F57C00; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-map-check"></i> å…¨ç³»çµ±ç¸£å¸‚æ­¸é¡é©—è­‰å·¥å…·</h1>
        
        <div class="system-card">
            <h2 class="system-title">
                <i class="fas fa-cog"></i> é©—è­‰æ§åˆ¶å°
            </h2>
            
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
                <button class="check-btn" onclick="checkHighwaySystem()">
                    <i class="fas fa-highway"></i> æª¢æŸ¥åœ‹é“ç³»çµ±
                </button>
                <button class="check-btn" onclick="checkRoadSystem()">
                    <i class="fas fa-road"></i> æª¢æŸ¥çœé“ç³»çµ±
                </button>
                <button class="check-btn" onclick="checkWaterSystem()">
                    <i class="fas fa-water"></i> æª¢æŸ¥æ°´è³‡æºç³»çµ±
                </button>
                <button class="check-btn" onclick="checkAllSystems()">
                    <i class="fas fa-check-double"></i> æª¢æŸ¥å…¨éƒ¨ç³»çµ±
                </button>
                <button class="export-btn" onclick="exportResults()">
                    <i class="fas fa-download"></i> åŒ¯å‡ºå ±å‘Š
                </button>
            </div>

            <div id="overallProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                <div id="progressText">æº–å‚™æª¢æŸ¥...</div>
            </div>

            <div class="summary-stats" id="summaryStats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalCameras">0</div>
                    <div class="stat-label">ç¸½ç›£è¦–å™¨æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="correctCount" style="color: #28a745;">0</div>
                    <div class="stat-label">æ­£ç¢ºæ­¸é¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="incorrectCount" style="color: #dc3545;">0</div>
                    <div class="stat-label">éŒ¯èª¤æ­¸é¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="suspiciousCount" style="color: #ffc107;">0</div>
                    <div class="stat-label">å¯ç–‘æ­¸é¡</div>
                </div>
            </div>
        </div>

        <div class="system-card" id="highwayResults" style="display: none;">
            <h2 class="system-title">
                <i class="fas fa-highway"></i> åœ‹é“ç›£è¦–å™¨ç³»çµ±æª¢æŸ¥çµæœ
            </h2>
            <div id="highwayStatus"></div>
            <div id="highwayCameras" class="camera-grid"></div>
        </div>

        <div class="system-card" id="roadResults" style="display: none;">
            <h2 class="system-title">
                <i class="fas fa-road"></i> çœé“ç›£è¦–å™¨ç³»çµ±æª¢æŸ¥çµæœ
            </h2>
            <div id="roadStatus"></div>
            <div id="roadCameras" class="camera-grid"></div>
        </div>

        <div class="system-card" id="waterResults" style="display: none;">
            <h2 class="system-title">
                <i class="fas fa-water"></i> æ°´è³‡æºç›£æ§ç³»çµ±æª¢æŸ¥çµæœ
            </h2>
            <div id="waterStatus"></div>
            <div id="waterCameras" class="camera-grid"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="tdx-api.js"></script>
    <script>
        let allResults = {
            highway: [],
            road: [],
            water: []
        };

        // æ”¹è‰¯çš„åº§æ¨™è½‰æ›å‡½æ•¸
        function getCityFromCoordinates(lon, lat, roadName = '') {
            if (!lon || !lat) return 'æœªçŸ¥';
            
            // ç‰¹æ®Šè™•ç†åœ‹é“5è™Ÿ - ä¸»è¦åœ¨å®œè˜­ç¸£
            if (roadName && roadName.includes('åœ‹é“5è™Ÿ')) {
                if (lon >= 121.50 && lat >= 24.50 && lat <= 25.00) {
                    return 'å®œè˜­ç¸£';
                } else if (lon >= 121.30 && lon < 121.50 && lat >= 24.85) {
                    return 'æ–°åŒ—å¸‚';
                }
            }
            
            // å°ç£å„ç¸£å¸‚ç¶“ç·¯åº¦ç¯„åœ - å„ªåŒ–é †åº
            const cityRanges = [
                // å„ªå…ˆåˆ¤æ–·è¼ƒå°çš„ç‰¹æ®Šå€åŸŸ
                { name: 'å°åŒ—å¸‚', lonMin: 121.45, lonMax: 121.65, latMin: 24.95, latMax: 25.20 },
                { name: 'åŸºéš†å¸‚', lonMin: 121.65, lonMax: 121.85, latMin: 25.10, latMax: 25.25 },
                { name: 'æ–°ç«¹å¸‚', lonMin: 120.90, lonMax: 121.05, latMin: 24.75, latMax: 24.85 },
                { name: 'å˜‰ç¾©å¸‚', lonMin: 120.40, lonMax: 120.50, latMin: 23.45, latMax: 23.52 },
                
                // æ±éƒ¨ç¸£å¸‚ - å„ªå…ˆåˆ¤æ–·
                { name: 'å®œè˜­ç¸£', lonMin: 121.50, lonMax: 122.10, latMin: 24.50, latMax: 25.05 },
                { name: 'èŠ±è“®ç¸£', lonMin: 121.30, lonMax: 121.80, latMin: 23.30, latMax: 24.50 },
                { name: 'å°æ±ç¸£', lonMin: 120.90, lonMax: 121.50, latMin: 22.30, latMax: 23.50 },
                
                // å…¶ä»–ç¸£å¸‚
                { name: 'æ¡ƒåœ’å¸‚', lonMin: 121.00, lonMax: 121.50, latMin: 24.80, latMax: 25.10 },
                { name: 'æ–°ç«¹ç¸£', lonMin: 120.70, lonMax: 121.30, latMin: 24.50, latMax: 25.00 },
                { name: 'è‹—æ —ç¸£', lonMin: 120.60, lonMax: 121.20, latMin: 24.20, latMax: 24.80 },
                { name: 'å°ä¸­å¸‚', lonMin: 120.50, lonMax: 121.20, latMin: 24.00, latMax: 24.50 },
                { name: 'å½°åŒ–ç¸£', lonMin: 120.40, lonMax: 120.80, latMin: 23.80, latMax: 24.20 },
                { name: 'å—æŠ•ç¸£', lonMin: 120.60, lonMax: 121.30, latMin: 23.50, latMax: 24.20 },
                { name: 'é›²æ—ç¸£', lonMin: 120.20, lonMax: 120.70, latMin: 23.50, latMax: 23.90 },
                { name: 'å˜‰ç¾©ç¸£', lonMin: 120.10, lonMax: 120.80, latMin: 23.30, latMax: 23.70 },
                { name: 'å°å—å¸‚', lonMin: 120.00, lonMax: 120.50, latMin: 22.90, latMax: 23.40 },
                { name: 'é«˜é›„å¸‚', lonMin: 120.20, lonMax: 120.50, latMin: 22.50, latMax: 23.10 },
                { name: 'å±æ±ç¸£', lonMin: 120.40, lonMax: 120.90, latMin: 22.00, latMax: 22.80 },
                
                // æ–°åŒ—å¸‚ç¯„åœè¼ƒå¤§ï¼Œæ”¾åœ¨æœ€å¾Œ
                { name: 'æ–°åŒ—å¸‚', lonMin: 121.30, lonMax: 121.80, latMin: 24.60, latMax: 25.30 }
            ];
            
            for (const city of cityRanges) {
                if (lon >= city.lonMin && lon <= city.lonMax && lat >= city.latMin && lat <= city.latMax) {
                    return city.name;
                }
            }
            
            return 'å…¶ä»–åœ°å€';
        }

        // é©—è­‰ç¸£å¸‚æ­¸é¡é‚è¼¯
        function validateCityClassification(camera, systemType) {
            const lon = parseFloat(camera.PositionLon);
            const lat = parseFloat(camera.PositionLat);
            const roadName = camera.RoadName || '';
            
            if (!lon || !lat) {
                return {
                    status: 'error',
                    originalCity: camera.City || 'æœªçŸ¥',
                    calculatedCity: 'ç„¡åº§æ¨™',
                    message: 'ç¼ºå°‘åº§æ¨™è³‡è¨Š'
                };
            }
            
            const calculatedCity = getCityFromCoordinates(lon, lat, roadName);
            const originalCity = camera.City || 'æœªçŸ¥';
            
            // åˆ¤æ–·æ­¸é¡æ˜¯å¦æ­£ç¢º
            let status = 'correct';
            let message = 'æ­¸é¡æ­£ç¢º';
            
            if (originalCity !== calculatedCity) {
                // æª¢æŸ¥æ˜¯å¦ç‚ºå·²çŸ¥çš„é‚Šç•Œå•é¡Œ
                const boundaryIssues = [
                    { original: 'æ–°åŒ—å¸‚', calculated: 'å®œè˜­ç¸£', road: 'åœ‹é“5è™Ÿ' },
                    { original: 'æ¡ƒåœ’å¸‚', calculated: 'æ–°ç«¹ç¸£', road: 'åœ‹é“1è™Ÿ' },
                    { original: 'å°ä¸­å¸‚', calculated: 'å½°åŒ–ç¸£', road: 'åœ‹é“1è™Ÿ' }
                ];
                
                const isBoundaryIssue = boundaryIssues.some(issue => 
                    originalCity === issue.original && 
                    calculatedCity === issue.calculated && 
                    roadName.includes(issue.road)
                );
                
                if (isBoundaryIssue) {
                    status = 'suspicious';
                    message = 'å¯èƒ½çš„é‚Šç•Œå•é¡Œ';
                } else {
                    status = 'incorrect';
                    message = 'æ­¸é¡éŒ¯èª¤';
                }
            }
            
            return {
                status,
                originalCity,
                calculatedCity,
                message,
                coordinates: `${lon}, ${lat}`,
                roadName
            };
        }

        async function checkHighwaySystem() {
            const statusElement = document.getElementById('highwayStatus');
            const resultsElement = document.getElementById('highwayCameras');
            const resultCard = document.getElementById('highwayResults');
            
            statusElement.innerHTML = '<div class="status loading"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¼‰å…¥åœ‹é“ç›£è¦–å™¨è³‡æ–™...</div>';
            resultCard.style.display = 'block';
            resultsElement.innerHTML = '';
            
            try {
                // å˜—è©¦è¼‰å…¥ TDX API
                let cameras = [];
                try {
                    const response = await tdxApi.fetchCCTV('/v2/Road/Traffic/CCTV/Freeway?$format=JSON&$top=100');
                    if (response && response.CCTVs && Array.isArray(response.CCTVs)) {
                        cameras = response.CCTVs.map(camera => ({...camera, source: 'tdx'}));
                    } else if (Array.isArray(response)) {
                        cameras = response.map(camera => ({...camera, source: 'tdx'}));
                    }
                } catch (tdxError) {
                    console.warn('TDX API å¤±æ•—ï¼Œå˜—è©¦ XML API:', tdxError);
                    const xmlResponse = await fetch('https://tisvcloud.freeway.gov.tw/history/motc20/CCTV.xml');
                    const xmlText = await xmlResponse.text();
                    cameras = await parseFreewayXMLCameras(xmlText);
                }
                
                if (cameras.length === 0) {
                    throw new Error('ç„¡æ³•è¼‰å…¥ç›£è¦–å™¨è³‡æ–™');
                }
                
                statusElement.innerHTML = `<div class="status loading"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨é©—è­‰ ${cameras.length} å€‹ç›£è¦–å™¨çš„ç¸£å¸‚æ­¸é¡...</div>`;
                
                // ç‚ºæ¯å€‹ç›£è¦–å™¨æ·»åŠ ç¸£å¸‚è³‡è¨Šä¸¦é©—è­‰
                const results = cameras.map(camera => {
                    const cityFromCoord = getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName);
                    const cameraWithCity = {
                        ...camera,
                        City: cityFromCoord,
                        FreewayNumber: getFreewayNumber(camera.RoadName)
                    };
                    
                    return {
                        camera: cameraWithCity,
                        validation: validateCityClassification(cameraWithCity, 'highway')
                    };
                });
                
                allResults.highway = results;
                displayHighwayResults(results);
                
            } catch (error) {
                statusElement.innerHTML = `<div class="status error"><i class="fas fa-exclamation-triangle"></i> è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
        }

        async function parseFreewayXMLCameras(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            const cameras = [];
            const items = xmlDoc.querySelectorAll('CCTV');
            
            items.forEach(item => {
                const camera = {
                    CCTVID: item.querySelector('CCTVID')?.textContent || '',
                    RoadName: item.querySelector('RoadName')?.textContent || '',
                    SurveillanceDescription: item.querySelector('SurveillanceDescription')?.textContent || '',
                    PositionLon: parseFloat(item.querySelector('PositionLon')?.textContent) || 0,
                    PositionLat: parseFloat(item.querySelector('PositionLat')?.textContent) || 0,
                    VideoStreamURL: item.querySelector('VideoStreamURL')?.textContent || '',
                    VideoImageURL: item.querySelector('VideoImageURL')?.textContent || '',
                    RoadDirection: item.querySelector('RoadDirection')?.textContent || '',
                    LocationMile: item.querySelector('LocationMile')?.textContent || '',
                    source: 'xml'
                };
                
                if (camera.CCTVID) {
                    cameras.push(camera);
                }
            });
            
            return cameras;
        }

        function getFreewayNumber(roadName) {
            if (!roadName) return '';
            const match = roadName.match(/åœ‹é“(\d+)è™Ÿ?/);
            return match ? `åœ‹é“${match[1]}` : roadName;
        }

        async function checkRoadSystem() {
            const statusElement = document.getElementById('roadStatus');
            const resultsElement = document.getElementById('roadCameras');
            const resultCard = document.getElementById('roadResults');
            
            statusElement.innerHTML = '<div class="status loading"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¼‰å…¥çœé“ç›£è¦–å™¨è³‡æ–™...</div>';
            resultCard.style.display = 'block';
            resultsElement.innerHTML = '';
            
            try {
                // è¼‰å…¥çœé“ç›£è¦–å™¨è³‡æ–™ï¼ˆå–æ¨£æª¢æŸ¥ï¼‰
                const response = await tdxApi.fetchCCTV('/v2/Road/Traffic/CCTV/Provincial?$format=JSON&$top=50');
                let cameras = [];
                
                if (response && response.CCTVs && Array.isArray(response.CCTVs)) {
                    cameras = response.CCTVs.map(camera => ({...camera, source: 'tdx'}));
                } else if (Array.isArray(response)) {
                    cameras = response.map(camera => ({...camera, source: 'tdx'}));
                }
                
                if (cameras.length === 0) {
                    throw new Error('ç„¡æ³•è¼‰å…¥çœé“ç›£è¦–å™¨è³‡æ–™');
                }
                
                statusElement.innerHTML = `<div class="status loading"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨é©—è­‰ ${cameras.length} å€‹ç›£è¦–å™¨çš„ç¸£å¸‚æ­¸é¡...</div>`;
                
                // ç‚ºæ¯å€‹ç›£è¦–å™¨æ·»åŠ ç¸£å¸‚è³‡è¨Šä¸¦é©—è­‰
                const results = cameras.map(camera => {
                    const cityFromCoord = getCityFromCoordinates(camera.PositionLon, camera.PositionLat);
                    const cameraWithCity = {
                        ...camera,
                        City: cityFromCoord
                    };
                    
                    return {
                        camera: cameraWithCity,
                        validation: validateCityClassification(cameraWithCity, 'road')
                    };
                });
                
                allResults.road = results;
                displayRoadResults(results);
                
            } catch (error) {
                statusElement.innerHTML = `<div class="status error"><i class="fas fa-exclamation-triangle"></i> è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
        }

        function displayHighwayResults(results) {
            const statusElement = document.getElementById('highwayStatus');
            const resultsElement = document.getElementById('highwayCameras');
            
            const correct = results.filter(r => r.validation.status === 'correct').length;
            const incorrect = results.filter(r => r.validation.status === 'incorrect').length;
            const suspicious = results.filter(r => r.validation.status === 'suspicious').length;
            const errors = results.filter(r => r.validation.status === 'error').length;
            
            statusElement.innerHTML = `
                <div class="status success">
                    <i class="fas fa-check-circle"></i> 
                    æª¢æŸ¥å®Œæˆ: ç¸½è¨ˆ ${results.length} å€‹ç›£è¦–å™¨
                    | âœ… æ­£ç¢º ${correct} å€‹
                    | âŒ éŒ¯èª¤ ${incorrect} å€‹  
                    | âš ï¸ å¯ç–‘ ${suspicious} å€‹
                    | ğŸš« ç„¡åº§æ¨™ ${errors} å€‹
                </div>
            `;
            
            // é¡¯ç¤ºæœ‰å•é¡Œçš„ç›£è¦–å™¨
            const problemCameras = results.filter(r => r.validation.status !== 'correct');
            let html = '';
            
            problemCameras.forEach(result => {
                const camera = result.camera;
                const validation = result.validation;
                
                html += `
                    <div class="camera-item ${validation.status}">
                        <div class="camera-name">
                            ${camera.FreewayNumber || camera.RoadName} - ${camera.LocationMile || camera.CCTVID}
                        </div>
                        <div class="camera-details">
                            åº§æ¨™: <span class="coordinates">${validation.coordinates}</span><br>
                            åŸæ­¸é¡: <span class="city-badge ${validation.status}">${validation.originalCity}</span><br>
                            è¨ˆç®—æ­¸é¡: <span class="city-badge correct">${validation.calculatedCity}</span><br>
                            ç‹€æ…‹: ${validation.message}
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div class="status success"><i class="fas fa-thumbs-up"></i> æ‰€æœ‰ç›£è¦–å™¨çš„ç¸£å¸‚æ­¸é¡éƒ½æ­£ç¢ºï¼</div>';
            }
            
            resultsElement.innerHTML = html;
        }

        function displayRoadResults(results) {
            const statusElement = document.getElementById('roadStatus');
            const resultsElement = document.getElementById('roadCameras');
            
            const correct = results.filter(r => r.validation.status === 'correct').length;
            const incorrect = results.filter(r => r.validation.status === 'incorrect').length;
            const suspicious = results.filter(r => r.validation.status === 'suspicious').length;
            const errors = results.filter(r => r.validation.status === 'error').length;
            
            statusElement.innerHTML = `
                <div class="status success">
                    <i class="fas fa-check-circle"></i> 
                    æª¢æŸ¥å®Œæˆ: ç¸½è¨ˆ ${results.length} å€‹ç›£è¦–å™¨
                    | âœ… æ­£ç¢º ${correct} å€‹
                    | âŒ éŒ¯èª¤ ${incorrect} å€‹  
                    | âš ï¸ å¯ç–‘ ${suspicious} å€‹
                    | ğŸš« ç„¡åº§æ¨™ ${errors} å€‹
                </div>
            `;
            
            // é¡¯ç¤ºæœ‰å•é¡Œçš„ç›£è¦–å™¨
            const problemCameras = results.filter(r => r.validation.status !== 'correct');
            let html = '';
            
            problemCameras.forEach(result => {
                const camera = result.camera;
                const validation = result.validation;
                
                html += `
                    <div class="camera-item ${validation.status}">
                        <div class="camera-name">
                            ${camera.RoadName} - ${camera.LocationMile || camera.SurveillanceDescription}
                        </div>
                        <div class="camera-details">
                            åº§æ¨™: <span class="coordinates">${validation.coordinates}</span><br>
                            åŸæ­¸é¡: <span class="city-badge ${validation.status}">${validation.originalCity}</span><br>
                            è¨ˆç®—æ­¸é¡: <span class="city-badge correct">${validation.calculatedCity}</span><br>
                            ç‹€æ…‹: ${validation.message}
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div class="status success"><i class="fas fa-thumbs-up"></i> æ‰€æœ‰ç›£è¦–å™¨çš„ç¸£å¸‚æ­¸é¡éƒ½æ­£ç¢ºï¼</div>';
            }
            
            resultsElement.innerHTML = html;
        }

        async function checkWaterSystem() {
            const statusElement = document.getElementById('waterStatus');
            const resultsElement = document.getElementById('waterCameras');
            const resultCard = document.getElementById('waterResults');
            
            statusElement.innerHTML = '<div class="status loading"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¼‰å…¥æ°´è³‡æºç›£æ§ç«™è³‡æ–™...</div>';
            resultCard.style.display = 'block';
            resultsElement.innerHTML = '';
            
            try {
                // è¼‰å…¥æ°´åˆ©ç½²ç›£æ¸¬ç«™è³‡æ–™ï¼ˆå–æ¨£æª¢æŸ¥ï¼‰
                const wraResponse = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%27&$count=true&$top=30');
                const cooperativeResponse = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%EF%BC%88%E8%88%87%E7%B8%A3%E5%B8%82%E6%94%BF%E5%BA%9C%E5%90%88%E5%BB%BA%EF%BC%89%27&$count=true&$top=30');
                
                const wraData = await wraResponse.json();
                const cooperativeData = await cooperativeResponse.json();
                
                const cameras = [
                    ...(wraData.value || []).map(camera => ({...camera, sourceType: 'wra'})),
                    ...(cooperativeData.value || []).map(camera => ({...camera, sourceType: 'cooperative'}))
                ];
                
                if (cameras.length === 0) {
                    throw new Error('ç„¡æ³•è¼‰å…¥æ°´è³‡æºç›£æ¸¬ç«™è³‡æ–™');
                }
                
                statusElement.innerHTML = `<div class="status loading"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨é©—è­‰ ${cameras.length} å€‹ç›£æ¸¬ç«™çš„åº§æ¨™è³‡è¨Š...</div>`;
                
                // é©—è­‰æ°´è³‡æºç›£æ¸¬ç«™
                const results = cameras.map(camera => {
                    const thing = camera.Thing || {};
                    const location = thing.location;
                    let lon = 0, lat = 0;
                    
                    if (location && location.coordinates) {
                        lon = location.coordinates[0];
                        lat = location.coordinates[1];
                    }
                    
                    const calculatedCity = getCityFromCoordinates(lon, lat);
                    const stationName = thing.properties?.stationName || thing.name || 'æœªå‘½å';
                    
                    return {
                        camera: {
                            ...camera,
                            PositionLon: lon,
                            PositionLat: lat,
                            City: calculatedCity,
                            StationName: stationName
                        },
                        validation: {
                            status: lon && lat ? 'correct' : 'error',
                            originalCity: 'ç„¡åŸå§‹ç¸£å¸‚',
                            calculatedCity: calculatedCity,
                            coordinates: `${lon}, ${lat}`,
                            message: lon && lat ? 'åº§æ¨™æ­£å¸¸' : 'ç¼ºå°‘åº§æ¨™'
                        }
                    };
                });
                
                allResults.water = results;
                displayWaterResults(results);
                
            } catch (error) {
                statusElement.innerHTML = `<div class="status error"><i class="fas fa-exclamation-triangle"></i> è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
        }

        function displayWaterResults(results) {
            const statusElement = document.getElementById('waterStatus');
            const resultsElement = document.getElementById('waterCameras');
            
            const hasCoords = results.filter(r => r.validation.status === 'correct').length;
            const noCoords = results.filter(r => r.validation.status === 'error').length;
            
            statusElement.innerHTML = `
                <div class="status success">
                    <i class="fas fa-check-circle"></i> 
                    æª¢æŸ¥å®Œæˆ: ç¸½è¨ˆ ${results.length} å€‹ç›£æ¸¬ç«™
                    | âœ… æœ‰åº§æ¨™ ${hasCoords} å€‹
                    | ğŸš« ç„¡åº§æ¨™ ${noCoords} å€‹
                </div>
            `;
            
            // é¡¯ç¤ºæ‰€æœ‰ç›£æ¸¬ç«™çš„åº§æ¨™è³‡è¨Š
            let html = '';
            
            results.forEach(result => {
                const camera = result.camera;
                const validation = result.validation;
                
                html += `
                    <div class="camera-item ${validation.status === 'error' ? 'incorrect' : 'correct'}">
                        <div class="camera-name">
                            ${camera.StationName}
                        </div>
                        <div class="camera-details">
                            é¡å‹: ${camera.sourceType === 'wra' ? 'æ°´åˆ©ç½²ç›´è½„' : 'æ°´åˆ©ç½²èˆ‡åœ°æ–¹åˆå»º'}<br>
                            åº§æ¨™: <span class="coordinates">${validation.coordinates}</span><br>
                            æ¨ç®—ç¸£å¸‚: <span class="city-badge ${validation.status === 'error' ? 'incorrect' : 'correct'}">${validation.calculatedCity}</span><br>
                            ç‹€æ…‹: ${validation.message}
                        </div>
                    </div>
                `;
            });
            
            resultsElement.innerHTML = html;
        }

        async function checkAllSystems() {
            const progressElement = document.getElementById('overallProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const summaryStats = document.getElementById('summaryStats');
            
            progressElement.style.display = 'block';
            summaryStats.style.display = 'none';
            
            progressFill.style.width = '0%';
            progressText.textContent = 'é–‹å§‹æª¢æŸ¥åœ‹é“ç³»çµ±...';
            
            // æª¢æŸ¥åœ‹é“ç³»çµ±
            await checkHighwaySystem();
            progressFill.style.width = '33%';
            progressText.textContent = 'é–‹å§‹æª¢æŸ¥çœé“ç³»çµ±...';
            
            // æª¢æŸ¥çœé“ç³»çµ±
            await checkRoadSystem();
            progressFill.style.width = '66%';
            progressText.textContent = 'é–‹å§‹æª¢æŸ¥æ°´è³‡æºç³»çµ±...';
            
            // æª¢æŸ¥æ°´è³‡æºç³»çµ±
            await checkWaterSystem();
            progressFill.style.width = '100%';
            progressText.textContent = 'æª¢æŸ¥å®Œæˆï¼';
            
            // é¡¯ç¤ºç¸½çµçµ±è¨ˆ
            updateSummaryStats();
            summaryStats.style.display = 'grid';
        }

        function updateSummaryStats() {
            const allValidations = [
                ...allResults.highway.map(r => r.validation),
                ...allResults.road.map(r => r.validation),
                ...allResults.water.map(r => r.validation)
            ];
            
            const total = allValidations.length;
            const correct = allValidations.filter(v => v.status === 'correct').length;
            const incorrect = allValidations.filter(v => v.status === 'incorrect').length;
            const suspicious = allValidations.filter(v => v.status === 'suspicious').length;
            
            document.getElementById('totalCameras').textContent = total;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('incorrectCount').textContent = incorrect;
            document.getElementById('suspiciousCount').textContent = suspicious;
        }

        function exportResults() {
            const allValidations = [
                ...allResults.highway.map(r => ({...r, system: 'highway'})),
                ...allResults.road.map(r => ({...r, system: 'road'})),
                ...allResults.water.map(r => ({...r, system: 'water'}))
            ];
            
            const problems = allValidations.filter(r => r.validation.status !== 'correct');
            
            let csv = 'ç³»çµ±,ç›£è¦–å™¨åç¨±,åº§æ¨™,åŸæ­¸é¡,è¨ˆç®—æ­¸é¡,ç‹€æ…‹,è·¯ç·šåç¨±\n';
            
            problems.forEach(result => {
                const camera = result.camera;
                const validation = result.validation;
                csv += `${result.system},${camera.RoadName || ''},${validation.coordinates},${validation.originalCity},${validation.calculatedCity},${validation.message},${validation.roadName}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ç›£è¦–å™¨ç¸£å¸‚æ­¸é¡å•é¡Œå ±å‘Š_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
    </script>
</body>
</html>