<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµ PIDS å…¨è¢å¹•æ™‚åˆ»è¡¨ (5ç­+å¤šåª’é«”)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #111;
            color: white;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 10px; /* å¢åŠ é–“è· */
        }

        /* === 1. Header (ä¿æŒä¸è®Š) === */
        .unified-header {
            width: 100%;
            height: 100px; /* ç¨å¾®ç¸®å° */
            background-color: #000;
            border: 3px solid #333;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        .station-branding { display: flex; align-items: center; gap: 20px; flex: 1; }
        .tra-logo-img { height: 60px; width: auto; border: 2px solid #fff; border-radius: 50%; }
        .station-name-block { display: flex; flex-direction: row; align-items: baseline; gap: 15px; }
        .station-name { font-size: 3.5rem; font-weight: 900; color: #fff; line-height: 1; letter-spacing: 2px; text-shadow: 0 0 10px rgba(255,255,255,0.6); }
        .station-sub { font-size: 1.5rem; font-weight: bold; color: #4fc3f7; letter-spacing: 1px; text-transform: uppercase; font-family: Consolas, sans-serif; }
        .datetime-block { display: flex; align-items: baseline; gap: 15px; text-align: right; }
        .time-text { font-size: 3rem; font-weight: bold; font-family: Consolas, monospace; color: #ffeb3b; line-height: 1; }
        .date-text { font-size: 1.8rem; color: #ccc; font-weight: bold; font-family: Consolas, monospace; }

        /* === 2. Top Marquee (ä¿æŒä¸è®Š) === */
        .unified-marquee-container {
            width: 100%;
            height: 60px;
            background-color: #e3f2fd;
            border: 3px solid #333;
            border-left: 8px solid #0277bd;
            display: flex;
            align-items: center;
            overflow: hidden;
            position: relative;
            color: #01579b;
            flex-shrink: 0;
        }
        .unified-marquee-container .marquee-text { height: 60px; line-height: 60px; font-size: 2.2rem; font-weight: 900; position: absolute; white-space: nowrap; will-change: transform; }

        /* === 3. ä¸»å…§å®¹å€ (PIDS è¡¨æ ¼ + è·‘é¦¬ç‡ˆ) === */
        .pids-section {
            display: flex;
            width: 100%;
            gap: 15px;
            flex: 1; /* ä½”æ“šå‰©é¤˜ç©ºé–“çš„ä¸ŠåŠéƒ¨ */
            overflow: hidden;
            min-height: 0; /* è®“ Flex item å¯ä»¥ç¸®å° */
        }

        .pids-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            border: 3px solid #333;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.6);
        }

        .screen-body { flex: 1; display: flex; flex-direction: column; background: #000; overflow: hidden; }

        /* æ–¹å‘æ¨™é¡Œ */
        .direction-header-1 { background: linear-gradient(to right, #000080, #0d47a1); color: white; padding: 10px 15px; font-size: 1.5rem; font-weight: 900; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #fff; flex-shrink: 0; }
        .direction-header-0 { background: linear-gradient(to right, #bf360c, #e65100); color: white; padding: 10px 15px; font-size: 1.5rem; font-weight: 900; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #fff; flex-shrink: 0; }

        /* è¡¨æ ¼æ¨£å¼ (é‡å° 5 åˆ—å„ªåŒ–) */
        .train-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 1.8rem; font-weight: bold; table-layout: fixed; }
        .train-table th { padding: 8px; font-size: 1.3rem; color: #fff; border-bottom: 2px solid #fff; height: 45px; }
        
        .table-1 th { background-color: #000080; }
        .table-1 tr:nth-child(odd) { background-color: #000; }
        .table-1 tr:nth-child(even) { background-color: #002f4b; }

        .table-0 th { background-color: #bf360c; }
        .table-0 tr:nth-child(odd) { background-color: #000; }
        .table-0 tr:nth-child(even) { background-color: #3e2723; }

        /* ğŸ”¥ åˆ—é«˜è¨­å®šï¼šè®“ 5 åˆ—å¡«æ»¿ç©ºé–“ */
        .train-table tbody tr { height: 16%; /* ç´„ 16% * 5 + header = 100% */ }
        .train-table td { padding: 0 5px; vertical-align: middle; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ä¸‹æ–¹è·‘é¦¬ç‡ˆ (åœ¨è¡¨æ ¼ä¸‹æ–¹) */
        .marquee-footer { background-color: #212121; color: #ffeb3b; height: 50px; position: relative; overflow: hidden; display: block; border-top: 3px solid #ff9800; padding: 0; flex-shrink: 0; }
        .marquee-footer .marquee-text { position: absolute; white-space: nowrap; top: 0; left: 0; height: 50px; line-height: 50px; font-size: 1.4rem; font-weight: bold; will-change: transform; transform: translateX(100vw); }

        /* === 4. åº•éƒ¨åª’é«”å€ (Media Zone) === */
        .media-section {
            height: 320px; /* å›ºå®šé«˜åº¦ï¼Œç´„ä½”è¢å¹• 1/3 */
            display: flex;
            gap: 15px;
            flex-shrink: 0;
        }

        .media-box {
            flex: 1;
            background: #000;
            border: 3px solid #333;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-label {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 5px 10px;
            font-size: 1rem;
            z-index: 10;
            border-bottom-right-radius: 8px;
        }

        /* åœ–ç‰‡è¼ªæ’­ */
        .carousel-img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ä¿æŒæ¯”ä¾‹ */
            background: #000;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        .carousel-img.active { opacity: 1; }

        /* å½±ç‰‡æ’­æ”¾ */
        .video-container {
            width: 100%;
            height: 100%;
            background: #000;
        }
        .video-iframe { width: 100%; height: 100%; border: none; }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* å…¶ä»–è¼”åŠ©æ¨£å¼ */
        .time-delay-container { display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 10px; height: 100%; }
        .original-time { text-decoration: line-through; color: #777; font-size: 1.2rem; }
        .expected-time { color: #4fc3f7; font-weight: bold; font-size: 1.8rem; }
        .normal-time { font-size: 1.8rem; }
        .highlight-row { background-color: rgba(255, 255, 255, 0.15) !important; box-shadow: inset 0 0 15px rgba(255, 235, 59, 0.15); border: 2px solid #ffeb3b !important; }
        
        .train-type-badge { display: inline-block; padding: 4px 12px; border-radius: 4px; color: white; font-size: 1.6rem; font-weight: bold; white-space: nowrap; min-width: 130px; }
        .type-è‡ªå¼· { background-color: #FF5722; }
        .type-è‡ªå¼·3000 { background: linear-gradient(135deg, #222 0%, #444 100%); border: 1px solid #999; }
        .type-æ™®æ‚ ç‘ª { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); }
        .type-å¤ªé­¯é–£ { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .type-è’å…‰ { background-color: #FF9800; }
        .type-è§€å…‰ { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); border: 1px dashed #fff; }
        .type-å€é–“å¿« { background-color: #3F51B5; }
        .type-å€é–“ { background-color: #2196F3; }
        .type-å¾©èˆˆ { background-color: #00BCD4; }
        .type-æ™®å¿« { background-color: #009688; }
        .type-å…¶ä»– { background-color: #607D8B; }

        .status-ontime { color: #ffffff !important; }
        .status-delay { color: #ff1744 !important; }
        .status-cancelled { background-color: #212121; color: #FF5252; border: 1px solid #FF5252; padding: 2px 6px; border-radius: 3px; }
        .train-cancelled-row { opacity: 0.6; filter: grayscale(100%); background-color: #1a1a1a !important; }

        @keyframes dynamic-marquee { from { transform: translateX(var(--start-pos)); } to { transform: translateX(var(--end-pos)); } }

        /* RWD */
        @media (max-width: 900px) {
            body { height: auto !important; overflow-y: auto !important; -webkit-overflow-scrolling: touch; }
            .unified-header { height: 70px; padding: 0 10px; }
            .tra-logo-img { height: 40px; }
            .station-name { font-size: 1.8rem; }
            .station-sub { font-size: 0.8rem; }
            .time-text { font-size: 1.6rem; }
            .date-text { font-size: 0.8rem; }
            
            .pids-section { flex-direction: column; height: auto; display: block; }
            .pids-column { margin-bottom: 15px; height: auto; }
            .screen-body { height: auto; }
            
            /* æ‰‹æ©Ÿç‰ˆè¡¨æ ¼æ–‡å­—ç¸®å° */
            .train-table { font-size: 1.2rem; }
            .train-type-badge { font-size: 1rem; min-width: unset; padding: 2px 5px; }
            .train-table tbody tr { height: 50px; }
            
            /* æ‰‹æ©Ÿç‰ˆåª’é«”å€å †ç–Š */
            .media-section { height: auto; flex-direction: column; margin-bottom: 20px; }
            .media-box { height: 250px; }
        }
    </style>
    <script src="assets/station-code-mapping.js"></script>
</head>
<body>

    <!-- 1. é ‚éƒ¨è³‡è¨Šåˆ— -->
    <div class="unified-header">
        <div class="station-branding">
            <img src="https://www.railway.gov.tw/tra-tip-web/static/images/TRA_logo.jpg" class="tra-logo-img" alt="å°éµ">
            <div class="station-name-block">
                <div class="station-name" id="unifiedStationName">è‡ºéµè»Šç«™</div>
                <div class="station-sub" id="station-en">TRA STATION</div>
            </div>
        </div>
        <div class="datetime-block">
            <div class="date-text" id="unifiedDate">Loading...</div>
            <div class="time-text" id="unifiedTime">--:--:--</div>
        </div>
    </div>

    <!-- 2. é ‚éƒ¨è·‘é¦¬ç‡ˆ -->
    <div class="unified-marquee-container">
        <div class="marquee-text" id="unifiedTopMarquee">
            åœ¨é€šéå¹³äº¤é“å‰ï¼Œåœã€çœ‹ã€è½é›™å‘æœ‰ç„¡ä¾†è»Šã€‚&nbsp;&nbsp;&nbsp;è«‹å‹¿è·¨è¶Šè»Œé“æˆ–åœ¨æœˆå°ä¸Šå¥”è·‘ã€‚
        </div>
    </div>

    <!-- 3. ä¸­é–“ PIDS è¡¨æ ¼å€ (æ”¹ç‚º 5 åˆ—) -->
    <div class="pids-section">
        <!-- é€†è¡Œ (å·¦å´) -->
        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-1">
                    <span id="dirTitle1"><i class="fas fa-arrow-left"></i> é€†è¡Œ (Counter-Clockwise)</span>
                    <span style="font-size: 1rem;" id="destList1">è¼‰å…¥ä¸­...</span>
                </div>
                <table class="train-table table-1">
                    <thead>
                        <tr>
                            <th style="width:18%">è»Šæ¬¡</th>
                            <th style="width:22%">è»Šç¨®</th>
                            <th style="width:25%">é–‹å¾€</th>
                            <th style="width:22%">æ™‚é–“</th>
                            <th style="width:13%">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="body1"></tbody>
                </table>
            </div>
            <!-- å·¦å´è¡¨æ ¼è·‘é¦¬ç‡ˆ -->
            <div class="marquee-footer">
                <div class="marquee-text" id="marquee1">âš ï¸ è³‡æ–™è®€å–ä¸­...</div>
            </div>
        </div>

        <!-- é †è¡Œ (å³å´) -->
        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-0">
                    <span id="dirTitle0"><i class="fas fa-arrow-right"></i> é †è¡Œ (Clockwise)</span>
                    <span style="font-size: 1rem;" id="destList0">è¼‰å…¥ä¸­...</span>
                </div>
                <table class="train-table table-0">
                    <thead>
                        <tr>
                            <th style="width:18%">è»Šæ¬¡</th>
                            <th style="width:22%">è»Šç¨®</th>
                            <th style="width:25%">é–‹å¾€</th>
                            <th style="width:22%">æ™‚é–“</th>
                            <th style="width:13%">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="body0"></tbody>
                </table>
            </div>
            <!-- å³å´è¡¨æ ¼è·‘é¦¬ç‡ˆ -->
            <div class="marquee-footer">
                <div class="marquee-text" id="marquee0">âš ï¸ è³‡æ–™è®€å–ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- 4. åº•éƒ¨åª’é«”å€ (å®£å°åœ– + å½±ç‰‡) -->
    <div class="media-section">
        <!-- åœ–ç‰‡è¼ªæ’­ -->
        <div class="media-box" id="carouselBox">
            <div class="media-label">å®£å°è³‡è¨Š</div>
            <!-- åœ–ç‰‡å°‡ç”± JS å‹•æ…‹æ’å…¥ -->
            <img src="https://www.railway.gov.tw/tra-tip-web/static/images/hero-bg-01.jpg" class="carousel-img active" alt="Default">
        </div>
        
        <!-- å½±ç‰‡æ’­æ”¾ -->
        <div class="media-box" id="videoBox">
            <div class="media-label">å½±éŸ³å°ˆå€</div>
            <div id="videoContainer" class="video-container">
                <!-- é è¨­å½±ç‰‡ (å°éµå¹³äº¤é“å®£å°) -->
                <iframe class="video-iframe" 
                    src="https://www.youtube.com/embed/5k5x-8s81kQ?autoplay=1&mute=1&loop=1&playlist=5k5x-8s81kQ&controls=0" 
                    title="TRA Video" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
        </div>
    </div>

    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script>
        // ============ 0. è¨­å®š ============
        const TRA_WORKER_URL = "https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev";
        let GLOBAL_STATION_ID = "";
        const MAX_ROWS = 5; // ğŸ”¥ ä¿®æ”¹ç‚º 5 ç­

        // ============ 1. æ ¸å¿ƒé‚è¼¯ ============
        const TRAIN_TYPE_DB = [
          { "id": "1100", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1101", "name": "å¤ªé­¯é–£", "code": "1" },
          { "id": "1102", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1107", "name": "æ™®æ‚ ç‘ª", "code": "2" },
          { "id": "110B", "name": "æ–°è‡ªå¼·", "code": "11" },
          { "id": "1110", "name": "è’å…‰", "code": "4" },
          { "id": "1131", "name": "å€é–“", "code": "6" },
          { "id": "1132", "name": "å€é–“å¿«", "code": "6" },
          { "id": "1140", "name": "æ™®å¿«", "code": "7" }
        ];
        const trainTypeMap = new Map();
        TRAIN_TYPE_DB.forEach(item => trainTypeMap.set(item.id, item.name));
        const stopsCache = {};

        // æ¨ç´å°æ‡‰ (ç°¡åŒ–ç‰ˆ)
        const majorHubMap = { "åŸºéš†":"åŸºéš†", "è‡ºåŒ—":"è‡ºåŒ—", "æ¿æ©‹":"è‡ºåŒ—", "æ¡ƒåœ’":"æ¡ƒåœ’", "æ–°ç«¹":"æ–°ç«¹", "è‡ºä¸­":"è‡ºä¸­", "å˜‰ç¾©":"å˜‰ç¾©", "è‡ºå—":"è‡ºå—", "é«˜é›„":"é«˜é›„", "å±æ±":"å±æ±", "å®œè˜­":"å®œè˜­", "èŠ±è“®":"èŠ±è“®", "è‡ºæ±":"è‡ºæ±" };

        function updateEnglishStationName(stationID) {
            const enElement = document.getElementById('station-en');
            if (enElement && typeof stationDataMap !== 'undefined' && stationDataMap[stationID]) {
                enElement.innerText = `${stationDataMap[stationID].ename.split('_')[0].toUpperCase()} STATION`;
            }
        }

        function getTrainDisplayInfo(train) {
            let name = train.TrainTypeName?.Zh_tw || train.TrainTypeName || 'åˆ—è»Š';
            const typeID = train.TrainTypeID || train.TrainType;
            if (typeID && trainTypeMap.has(typeID)) name = trainTypeMap.get(typeID);
            
            let cssClass = 'å…¶ä»–';
            if (name.includes('æ–°è‡ªå¼·') || name.includes('3000')) { name = 'æ–°è‡ªå¼·'; cssClass = 'è‡ªå¼·3000'; }
            else if (name.includes('æ™®æ‚ ç‘ª')) { name = 'æ™®æ‚ ç‘ª'; cssClass = 'æ™®æ‚ ç‘ª'; }
            else if (name.includes('å¤ªé­¯é–£')) { name = 'å¤ªé­¯é–£'; cssClass = 'å¤ªé­¯é–£'; }
            else if (name.includes('è‡ªå¼·')) { name = 'è‡ªå¼·'; cssClass = 'è‡ªå¼·'; }
            else if (name.includes('è’å…‰')) { name = 'è’å…‰'; cssClass = 'è’å…‰'; }
            else if (name.includes('å€é–“å¿«')) { name = 'å€é–“å¿«'; cssClass = 'å€é–“å¿«'; }
            else if (name.includes('å€é–“')) { name = 'å€é–“'; cssClass = 'å€é–“'; }
            else if (name.includes('æ™®å¿«')) { name = 'æ™®å¿«'; cssClass = 'æ™®å¿«'; }
            
            return { name: name, class: cssClass };
        }

        async function fetchTrainStops(trainNo) {
            if (stopsCache[trainNo]) return stopsCache[trainNo];
            try {
                const res = await fetch(`${TRA_WORKER_URL}/api/schedule?trainNo=${trainNo}`);
                if (res.ok) {
                    const data = await res.json();
                    if(data.length) { stopsCache[trainNo] = data[0].StopTimes; return data[0].StopTimes; }
                }
            } catch(e){}
            return [];
        }

        function getExpectedTime(timeStr, delayMins) {
            if (!timeStr || delayMins === 0) return timeStr;
            const [h, m] = timeStr.split(':').map(Number);
            const total = h * 60 + m + delayMins;
            const newH = Math.floor(total / 60) % 24;
            const newM = total % 60;
            return `${String(newH).padStart(2,'0')}:${String(newM).padStart(2,'0')}`;
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('unifiedTime').textContent = now.toLocaleTimeString('en-GB');
            document.getElementById('unifiedDate').textContent = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;
        }
        setInterval(updateClock, 1000);

        // ============ 2. å¤šåª’é«”è³‡æº (Worker Assets API) ============
        async function updateMediaAssets() {
            try {
                const res = await fetch(`${TRA_WORKER_URL}/api/pids/assets`);
                if (res.ok) {
                    const data = await res.json();
                    
                    // 1. æ›´æ–°è¼ªæ’­åœ–
                    if (data.images && Array.isArray(data.images) && data.images.length > 0) {
                        setupCarousel(data.images);
                    }
                    
                    // 2. æ›´æ–°å½±ç‰‡
                    if (data.video) {
                        setupVideo(data.video);
                    }
                }
            } catch (e) {
                console.warn("ç„¡æ³•è¼‰å…¥å¤šåª’é«”è³‡æº", e);
                // å¤±æ•—æ™‚ä½¿ç”¨é è¨­åœ–ç‰‡è¼ªæ’­
                setupCarousel([
                    "https://www.railway.gov.tw/tra-tip-web/static/images/hero-bg-01.jpg",
                    "https://www.railway.gov.tw/tra-tip-web/static/images/hero-bg-02.jpg",
                    "https://www.railway.gov.tw/tra-tip-web/static/images/hero-bg-03.jpg"
                ]);
            }
        }

        let carouselInterval;
        function setupCarousel(images) {
            const box = document.getElementById('carouselBox');
            // æ¸…é™¤èˆŠåœ–
            box.querySelectorAll('img').forEach(img => img.remove());
            
            // æ’å…¥æ–°åœ–
            images.forEach((src, idx) => {
                const img = document.createElement('img');
                img.src = src;
                img.className = idx === 0 ? 'carousel-img active' : 'carousel-img';
                box.appendChild(img);
            });

            // å•Ÿå‹•è¼ªæ’­
            let currentIdx = 0;
            if (carouselInterval) clearInterval(carouselInterval);
            carouselInterval = setInterval(() => {
                const imgs = box.querySelectorAll('.carousel-img');
                if (imgs.length > 1) {
                    imgs[currentIdx].classList.remove('active');
                    currentIdx = (currentIdx + 1) % imgs.length;
                    imgs[currentIdx].classList.add('active');
                }
            }, 10000); // æ¯ 10 ç§’åˆ‡æ›
        }

        function setupVideo(videoUrl) {
            const container = document.getElementById('videoContainer');
            // åˆ¤æ–·æ˜¯ YouTube é‚„æ˜¯ MP4
            if (videoUrl.includes('youtube') || videoUrl.includes('youtu.be')) {
                // ç°¡æ˜“è½‰æ› YouTube ID
                let videoId = videoUrl.split('v=')[1];
                if (!videoId && videoUrl.includes('youtu.be')) videoId = videoUrl.split('/').pop();
                const ampersandPosition = videoId ? videoId.indexOf('&') : -1;
                if (ampersandPosition !== -1) videoId = videoId.substring(0, ampersandPosition);

                container.innerHTML = `
                    <iframe class="video-iframe" 
                        src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=0" 
                        allow="autoplay; encrypted-media">
                    </iframe>`;
            } else {
                container.innerHTML = `
                    <video src="${videoUrl}" autoplay muted loop playsinline></video>`;
            }
        }

        // ============ 3. PIDS é‚è¼¯ ============
        async function updatePidsData(stationID) {
            try {
                const res = await fetch(`${TRA_WORKER_URL}/api/liveboard/station?station=${stationID}`);
                if (!res.ok) throw new Error();
                let trains = await res.json();
                
                // å»é‡èˆ‡æ’åº (ç°¡å–®ç‰ˆ)
                const seen = new Set();
                trains = trains.filter(t => {
                    if (seen.has(t.TrainNo)) return false;
                    seen.add(t.TrainNo);
                    return true;
                });
                
                // ç°¡å–®æ’åºï¼šå°‡æ˜æ—¥ç­æ¬¡å¾€å¾Œæ’
                trains.forEach(t => {
                    const [h, m] = (t.ScheduledDepartureTime || "00:00").split(':').map(Number);
                    let min = h * 60 + m;
                    if (t.IsTomorrow) min += 1440;
                    t._sortKey = min + (parseInt(t.DelayTime||0));
                });
                trains.sort((a,b) => a._sortKey - b._sortKey);

                const t1 = trains.filter(t => String(t.Direction) === '1');
                const t0 = trains.filter(t => String(t.Direction) === '0');

                renderScreen('1', t1, 'é€†è¡Œ');
                renderScreen('0', t0, 'é †è¡Œ');
                updateBottomMarquee('marquee1', t1);
                updateBottomMarquee('marquee0', t0);

            } catch (e) {
                console.error(e);
                renderScreen('1', [], 'é€†è¡Œ');
                renderScreen('0', [], 'é †è¡Œ');
            }
        }

        function generateDirectionTitle(trains, defaultTitle) {
            // ç°¡æ˜“ç‰ˆæ–¹å‘åˆ¤æ–·ï¼šæ ¹æ“šç¬¬ä¸€ç­è»Šçµ‚é»ç«™çŒœæ¸¬
            if (!trains || trains.length === 0) return defaultTitle;
            const dest = trains[0].EndingStationName;
            // é€™è£¡å¯ä»¥åŠ å…¥æ›´è¤‡é›œçš„é‚è¼¯ï¼Œç›®å‰å…ˆå›å‚³é è¨­
            return defaultTitle; 
        }

        function renderScreen(dirCode, trains, dirName) {
            const tbody = document.getElementById(`body${dirCode}`);
            const destLabel = document.getElementById(`destList${dirCode}`);
            tbody.innerHTML = '';
            
            // æ–¹å‘é¡¯ç¤º (ç°¡æ˜“é‚è¼¯ï¼šé€†è¡Œ=åŒ—ä¸Š/æ±è¡Œï¼Œé †è¡Œ=å—ä¸‹/è¥¿è¡Œ)
            const title = dirName === 'é€†è¡Œ' ? (GLOBAL_STATION_ID >= 1800 && GLOBAL_STATION_ID <= 7000 ? 'åŒ—ä¸Š (Northbound)' : 'åŒ—ä¸Š (Northbound)') : (GLOBAL_STATION_ID >= 1800 && GLOBAL_STATION_ID <= 7000 ? 'å—ä¸‹ (Southbound)' : 'å—ä¸‹ (Southbound)');
            destLabel.textContent = title; 

            trains.slice(0, MAX_ROWS).forEach((train, index) => {
                const info = getTrainDisplayInfo(train);
                const delay = parseInt(train.DelayTime || 0);
                const isCancelled = String(train.TrainStatus) === '2';
                
                let delayText = 'æº–é»';
                let statusClass = 'status-ontime';
                if (isCancelled) { delayText = 'åœé§›'; statusClass = 'status-cancelled'; }
                else if (train.IsTomorrow) { delayText = 'æœªç™¼è»Š'; statusClass = 'status-future'; }
                else if (delay > 0) { delayText = `æ™š ${delay} åˆ†`; statusClass = 'status-delay'; }

                const timeStr = (train.ScheduledDepartureTime || train.DepartureTime || "").slice(0,5);
                let timeHtml = `<span class="normal-time" style="font-family: Consolas;">${timeStr}</span>`;
                if (delay > 0 && !isCancelled && !train.IsTomorrow) {
                    timeHtml = `
                        <div class="time-delay-container">
                            <span class="original-time" style="font-family: Consolas;">${timeStr}</span>
                            <span class="expected-time" style="font-family: Consolas;">${getExpectedTime(timeStr, delay)}</span>
                        </div>`;
                }

                const row = document.createElement('tr');
                if (index === 0) row.classList.add('highlight-row');
                if (isCancelled) row.classList.add('train-cancelled-row');
                
                row.innerHTML = `
                    <td style="font-family:Consolas;">${train.TrainNo}</td>
                    <td><span class="train-type-badge type-${info.class}">${info.name}</span></td>
                    <td>${train.EndingStationName}</td>
                    <td>${timeHtml}</td>
                    <td class="${statusClass}">${delayText}</td>
                `;
                tbody.appendChild(row);
            });

            // è£œç©ºè¡Œ
            for(let i = Math.min(trains.length, MAX_ROWS); i < MAX_ROWS; i++) {
                tbody.innerHTML += `<tr><td></td><td></td><td></td><td></td><td></td></tr>`;
            }
        }

        async function updateBottomMarquee(elId, trains) {
            const el = document.getElementById(elId);
            const container = el.parentElement;
            if (!trains || trains.length === 0) {
                el.innerHTML = "ç›®å‰ç„¡åˆ—è»Šè³‡è¨Š";
                return;
            }
            
            const train = trains[0];
            const info = getTrainDisplayInfo(train);
            const delay = parseInt(train.DelayTime||0);
            
            let msg = `<span style="color:#ffeb3b; font-weight:bold;">${train.TrainNo} æ¬¡ ${info.name} å¾€ ${train.EndingStationName}</span>`;
            msg += `<span style="margin:0 15px; color:#555;">|</span>`;
            
            // å˜—è©¦å–å¾—åœé ç«™
            let stops = await fetchTrainStops(train.TrainNo);
            if (stops && stops.length > 0) {
                const currentIdx = stops.findIndex(s => String(s.StationID) === GLOBAL_STATION_ID);
                if (currentIdx !== -1) {
                    const nextStops = stops.slice(currentIdx + 1).map(s => s.StationName.Zh_tw).join('ã€');
                    if (nextStops) msg += `æ²¿é€”åœé ï¼š${nextStops}`;
                    else msg += `æœ¬ç«™ç‚ºçµ‚é»ç«™`;
                }
            } else {
                msg += `æº–é»ç‡ 99%`;
            }
            
            el.innerHTML = msg;
            // é‡è¨­å‹•ç•«
            el.style.animation = 'none';
            void el.offsetWidth;
            const duration = Math.max(8, el.innerText.length * 0.25);
            el.style.animation = `dynamic-marquee ${duration}s linear infinite`;
        }
        
        // é ‚éƒ¨è·‘é¦¬ç‡ˆæª¢æŸ¥
        async function checkTopMarquee() {
            try {
                const res = await fetch(`${TRA_WORKER_URL}/api/pids/marquee`);
                const data = await res.json();
                const el = document.getElementById('unifiedTopMarquee');
                if (data.text && el.innerHTML !== data.text) {
                    el.innerHTML = data.text;
                }
            } catch(e){}
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const stationID = params.get('station');
            GLOBAL_STATION_ID = stationID;
            
            let name = params.get('name') || 'è‡ºéµ';
            document.getElementById('unifiedStationName').textContent = name.replace(/è»Šç«™$|ç«™$/g, '') + 'è»Šç«™';
            updateEnglishStationName(stationID);
            updateClock();
            
            // å•Ÿå‹•å¤šåª’é«”
            updateMediaAssets();

            if (stationID) {
                updatePidsData(stationID);
                setInterval(() => updatePidsData(stationID), 60000);
            }
            setInterval(checkTopMarquee, 60000);
            checkTopMarquee();
        });
    </script>
</body>
</html>
