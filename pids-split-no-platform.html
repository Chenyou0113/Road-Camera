<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµ PIDS é›™è¢å¹•çœ‹æ¿ (ç„¡æœˆå°ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #111;
            color: white;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }

        /* è¢å¹•å¤–æ¡† */
        .pids-screen {
            flex: 1;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            border: 10px solid #333;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        /* è·‘é¦¬ç‡ˆ */
        .marquee-header {
            background-color: #e3f2fd;
            color: #01579b;
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 2px solid #000;
            white-space: nowrap;
            overflow: hidden;
        }
        .marquee-text {
            display: inline-block;
            animation: scroll-left 20s linear infinite;
            padding-left: 100%;
        }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* å…§å®¹å€ */
        .screen-body {
            flex: 1;
            display: flex;
        }

        /* å·¦å´è³‡è¨Šæ¬„ */
        .sidebar {
            width: 25%;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #333;
        }

        .info-box {
            padding: 10px;
            color: #000;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }

        .date-box { background-color: #fff; flex: 1; font-size: 1.1rem; border-bottom: 2px solid #000; }
        .time-large { font-size: 2rem; font-weight: 900; margin-top: 5px; color: #000; font-family: Consolas, monospace; }
        
        .current-train { background-color: #ffe082; flex: 1.5; border-bottom: 2px solid #000; }
        .next-train { background-color: #f5f5f5; flex: 1.5; }

        .box-label { font-size: 1rem; color: #555; }
        .box-dest { font-size: 2.2rem; color: #000; font-weight: 900; line-height: 1.2; }
        .box-time { font-size: 1.8rem; color: #d32f2f; font-weight: bold; margin-top: 5px; }

        /* å³å´åˆ—è¡¨ */
        .schedule-list {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* åŒ—ä¸Šæ¨£å¼ */
        .north-header {
            background: linear-gradient(to right, #000080, #0d47a1);
            color: white;
            padding: 10px;
            font-size: 1.5rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .north-table th { background-color: #000080; color: #fff; }
        .north-table tr:nth-child(odd) { background-color: #000; color: #4fc3f7; }
        .north-table tr:nth-child(even) { background-color: #006064; color: #fff; }

        /* å—ä¸‹æ¨£å¼ */
        .south-header {
            background: linear-gradient(to right, #bf360c, #e65100);
            color: white;
            padding: 10px;
            font-size: 1.5rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .south-table th { background-color: #bf360c; color: #fff; }
        .south-table tr:nth-child(odd) { background-color: #000; color: #ffcc80; }
        .south-table tr:nth-child(even) { background-color: #e65100; color: #fff; }

        /* è¡¨æ ¼é€šç”¨ */
        .train-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            font-size: 1.5rem; /* å­—é«”ç¨å¾®æ”¾å¤§ */
            font-weight: bold;
            flex: 1;
        }
        .train-table th { padding: 8px; font-size: 1.3rem; border-bottom: 2px solid #fff; }
        .train-table td { padding: 12px 5px; }

        /* ç‹€æ…‹è‰² */
        .status-ontime { color: #00e676 !important; }
        .status-delay { color: #ff1744 !important; }
        .type-tze { color: #ffeb3b; } 
        .type-local { color: #fff; }

        /* RWD */
        @media (max-width: 1024px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            .pids-screen { width: 100%; height: 600px; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

    <!-- å·¦è¢å¹•ï¼šåŒ—ä¸Š -->
    <div class="pids-screen">
        <div class="marquee-header">
            <div class="marquee-text">
                [åŒ—ä¸Šé€šçŸ¥] 238 æ¬¡è‡ªå¼·è™Ÿæº–é»ã€‚ å¤©é›¨è·¯æ»‘è«‹å°å¿ƒè¡Œèµ°ã€‚
            </div>
        </div>
        <div class="screen-body">
            <div class="sidebar">
                <div class="info-box date-box">
                    <div id="dateN">11/24</div>
                    <div class="time-large" id="timeN">15:47</div>
                </div>
                <div class="info-box current-train">
                    <div class="box-label">æœ¬ç­é–‹å¾€</div>
                    <div class="box-dest">ä¸ƒå µ</div>
                    <div class="box-time">16:09</div>
                </div>
                <div class="info-box next-train">
                    <div class="box-label">ä¸‹ç­é–‹å¾€</div>
                    <div class="box-dest">åŸºéš†</div>
                    <div class="box-time">16:17</div>
                </div>
            </div>
            <div class="schedule-list">
                <div class="north-header">
                    <span><i class="fas fa-arrow-up"></i> åŒ—ä¸Š</span>
                    <span style="font-size: 1rem;">North Bound</span>
                </div>
                <table class="train-table north-table">
                    <thead>
                        <tr>
                            <th>è»Šæ¬¡</th>
                            <th>è»Šç¨®</th>
                            <th>é–‹å¾€</th>
                            <th>æ™‚é–“</th>
                            <!-- æœˆå°æ¬„ä½å·²ç§»é™¤ -->
                            <th>å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>238</td>
                            <td class="type-tze">è‡ªå¼·</td>
                            <td>ä¸ƒå µ</td>
                            <td>16:09</td>
                            <td class="status-ontime">æº–é»</td>
                        </tr>
                        <tr>
                            <td>1244</td>
                            <td class="type-local">å€é–“</td>
                            <td>åŸºéš†</td>
                            <td>16:17</td>
                            <td class="status-ontime">æº–é»</td>
                        </tr>
                        <tr>
                            <td>608</td>
                            <td class="type-tze">æ™®æ‚ ç‘ª</td>
                            <td>èŠ±è“®</td>
                            <td>16:22</td>
                            <td class="status-ontime">æº–é»</td>
                        </tr>
                        <tr>
                            <td>1245</td>
                            <td class="type-local">å€é–“</td>
                            <td>åŸºéš†</td>
                            <td>16:25</td>
                            <td class="status-delay">æ™š1åˆ†</td>
                        </tr>
                        <tr><td>&nbsp;</td><td></td><td></td><td></td><td></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å³è¢å¹•ï¼šå—ä¸‹ -->
    <div class="pids-screen">
        <div class="marquee-header">
            <div class="marquee-text">
                [å—ä¸‹é€šçŸ¥] 521 æ¬¡è‡ªå¼·è™Ÿå³å°‡é€²ç«™ã€‚ è«‹å‹¿ä¾é æœˆå°é–€ã€‚
            </div>
        </div>
        <div class="screen-body">
            <div class="sidebar">
                <div class="info-box date-box">
                    <div id="dateS">11/24</div>
                    <div class="time-large" id="timeS">15:47</div>
                </div>
                <div class="info-box current-train">
                    <div class="box-label">æœ¬ç­é–‹å¾€</div>
                    <div class="box-dest">é«˜é›„</div>
                    <div class="box-time">16:15</div>
                </div>
                <div class="info-box next-train">
                    <div class="box-label">ä¸‹ç­é–‹å¾€</div>
                    <div class="box-dest">æ–°ç«¹</div>
                    <div class="box-time">16:25</div>
                </div>
            </div>
            <div class="schedule-list">
                <div class="south-header">
                    <span><i class="fas fa-arrow-down"></i> å—ä¸‹</span>
                    <span style="font-size: 1rem;">South Bound</span>
                </div>
                <table class="train-table south-table">
                    <thead>
                        <tr>
                            <th>è»Šæ¬¡</th>
                            <th>è»Šç¨®</th>
                            <th>é–‹å¾€</th>
                            <th>æ™‚é–“</th>
                            <!-- æœˆå°æ¬„ä½å·²ç§»é™¤ -->
                            <th>å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>521</td>
                            <td class="type-tze">è‡ªå¼·</td>
                            <td>é«˜é›„</td>
                            <td>16:15</td>
                            <td class="status-ontime">å³å°‡é€²ç«™</td>
                        </tr>
                        <tr>
                            <td>1217</td>
                            <td class="type-local">å€é–“</td>
                            <td>æ–°ç«¹</td>
                            <td>16:25</td>
                            <td class="status-ontime">æº–é»</td>
                        </tr>
                        <tr>
                            <td>273</td>
                            <td class="type-tze">è‡ªå¼·</td>
                            <td>æ¨¹æ—</td>
                            <td>16:34</td>
                            <td class="status-ontime">æº–é»</td>
                        </tr>
                        <tr>
                            <td>1234</td>
                            <td class="type-local">å€é–“</td>
                            <td>æ–°ç«¹</td>
                            <td>16:45</td>
                            <td class="status-delay">æ™š2åˆ†</td>
                        </tr>
                        <tr><td>&nbsp;</td><td></td><td></td><td></td><td></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š
        const CONFIG = {
            STATION_ID: '1000', // é è¨­å°åŒ—ç«™ï¼Œå¯ä¿®æ”¹
            REFRESH_INTERVAL: 30000, // 30ç§’æ›´æ–°ä¸€æ¬¡
            MAX_ROWS: 4, // æ¯å€‹è¢å¹•é¡¯ç¤ºçš„åˆ—è»Šæ•¸
            API_URL: 'https://tra-schedule-worker.weacamm.org/api/schedule'
        };

        // æ™‚é˜æ›´æ–°
        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            const dateStr = (now.getMonth()+1) + '/' + now.getDate();
            document.getElementById('timeN').textContent = `${h}:${m}`;
            document.getElementById('timeS').textContent = `${h}:${m}`;
            document.getElementById('dateN').textContent = dateStr;
            document.getElementById('dateS').textContent = dateStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // æ ¼å¼åŒ–æ™‚é–“ (HH:MM)
        function formatTime(timeStr) {
            if (!timeStr) return '--:--';
            const match = timeStr.match(/(\d{2}):(\d{2})/);
            return match ? `${match[1]}:${match[2]}` : '--:--';
        }

        // è¨ˆç®—å»¶èª¤ç‹€æ…‹
        function getDelayStatus(delayTime) {
            if (!delayTime || delayTime === 0) return { text: 'æº–é»', color: 'status-ontime' };
            if (delayTime < 0) return { text: `æ—©${Math.abs(delayTime)}åˆ†`, color: 'status-ontime' };
            if (delayTime === 1) return { text: 'æ™š1åˆ†', color: 'status-delay' };
            return { text: `æ™š${delayTime}åˆ†`, color: 'status-delay' };
        }

        // å–å¾—è»Šç¨®ä¸­æ–‡åç¨±
        function getTrainTypeName(trainType) {
            const typeMap = {
                '1100': 'æ™®æ‚ ç‘ª', '1200': 'å¤ªé­¯é–£', '2100': 'è‡ªå¼·', 
                '2200': 'è’å…‰', '2300': 'å¾©èˆˆ', '3100': 'å€é–“'
            };
            return typeMap[trainType] || 'æœªçŸ¥';
        }

        // å¾ API å–å¾—åˆ—è»Šè³‡æ–™
        async function fetchTrainData() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?stationId=${CONFIG.STATION_ID}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.Infos && Array.isArray(data.Infos)) {
                    return data.Infos;
                }
                return [];
            } catch (error) {
                console.warn('âš ï¸ API å–å¾—å¤±æ•—:', error);
                return [];
            }
        }

        // ç¯©é¸ä¸¦æ’åºåˆ—è»Š
        function filterAndSortTrains(trains, direction) {
            // direction: 0 = å—ä¸‹, 1 = åŒ—ä¸Š
            const now = new Date();
            const currentTime = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');

            return trains
                .filter(train => train.Direction === direction && train.DepartureTime >= currentTime)
                .sort((a, b) => a.DepartureTime.localeCompare(b.DepartureTime))
                .slice(0, CONFIG.MAX_ROWS);
        }

        // æ›´æ–°åˆ—è»Šè¡¨æ ¼
        function updateTrainTable(trains, tableSelector) {
            const tbody = document.querySelector(tableSelector);
            if (!tbody) return;

            tbody.innerHTML = ''; // æ¸…ç©º

            if (trains.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">æš«ç„¡å¾ŒçºŒç­æ¬¡</td></tr>';
                return;
            }

            trains.forEach((train, idx) => {
                const delay = train.Delay || 0;
                const delayStatus = getDelayStatus(delay);
                const trainType = getTrainTypeName(train.TrainType);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${train.TrainNo}</td>
                    <td class="type-tze">${trainType}</td>
                    <td>${train.EndingStationName}</td>
                    <td>${formatTime(train.DepartureTime)}</td>
                    <td class="${delayStatus.color}">${delayStatus.text}</td>
                `;
                tbody.appendChild(row);
            });

            // å¡«å……ç©ºç™½åˆ—ä¿æŒé«˜åº¦
            while (tbody.rows.length < CONFIG.MAX_ROWS) {
                const emptyRow = tbody.insertRow();
                emptyRow.innerHTML = '<td>&nbsp;</td><td></td><td></td><td></td><td></td>';
            }
        }

        // æ›´æ–°å´é‚Šæ¬„è³‡è¨Šï¼ˆæœ¬ç­/ä¸‹ç­ï¼‰
        function updateSidebarInfo(trains, sidebarSelector) {
            const currentTrain = trains[0];
            const nextTrain = trains[1];

            const sidebar = document.querySelector(sidebarSelector);
            if (!sidebar) return;

            // æœ¬ç­åˆ—è»Š
            const currentBox = sidebar.querySelector('.current-train');
            if (currentTrain && currentBox) {
                currentBox.querySelector('.box-dest').textContent = currentTrain.EndingStationName || 'æœªçŸ¥';
                currentBox.querySelector('.box-time').textContent = formatTime(currentTrain.DepartureTime);
            }

            // ä¸‹ç­åˆ—è»Š
            const nextBox = sidebar.querySelector('.next-train');
            if (nextTrain && nextBox) {
                nextBox.querySelector('.box-dest').textContent = nextTrain.EndingStationName || 'æœªçŸ¥';
                nextBox.querySelector('.box-time').textContent = formatTime(nextTrain.DepartureTime);
            }
        }

        // ä¸»æ›´æ–°å‡½æ•¸
        async function refreshAllData() {
            console.log('ğŸ”„ æ›´æ–°åˆ—è»Šè³‡æ–™...');
            const allTrains = await fetchTrainData();

            if (allTrains.length === 0) {
                console.warn('âš ï¸ æœªå–å¾—åˆ—è»Šè³‡æ–™');
                return;
            }

            // åŒ—ä¸Š (Direction = 1)
            const northTrains = filterAndSortTrains(allTrains, 1);
            updateTrainTable(northTrains, '.north-table tbody');
            updateSidebarInfo(northTrains, '.pids-screen:nth-child(1) .sidebar');

            // å—ä¸‹ (Direction = 0)
            const southTrains = filterAndSortTrains(allTrains, 0);
            updateTrainTable(southTrains, '.south-table tbody');
            updateSidebarInfo(southTrains, '.pids-screen:nth-child(2) .sidebar');

            console.log(`âœ… æ›´æ–°å®Œæˆ - åŒ—ä¸Š: ${northTrains.length} ç­, å—ä¸‹: ${southTrains.length} ç­`);
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            refreshAllData();
            setInterval(refreshAllData, CONFIG.REFRESH_INTERVAL);
        });
    </script>
</body>
</html>
