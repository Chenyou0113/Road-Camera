# 🚌 公车追踪系统 - 问题解答

## ❓ 问题1：为什么车辆位置不显示？

### 可能原因：

#### 1. **目前该路线没有车辆在运行**
   - 早班车尚未发车
   - 已过末班车时间
   - 该方向暂时没有车辆

#### 2. **TDX API 数据延迟**
   - API 可能有 1-3 分钟延迟
   - 部分路线数据更新频率较低

#### 3. **Worker 数据过滤**
   - Worker 会过滤掉 5 分钟以上未更新的车辆位置
   - 确保显示的都是真实在线车辆

### 🔍 如何检查？

1. **打开浏览器控制台**（按 F12）
2. 切换到 **Console** 标签
3. 点击「开始追踪」后查看输出：

```
📡 正在获取动态资料: https://bus-worker.weacamm.org/...
📦 收到的数据: {buses: Array(3), estimates: Object}
🚌 车辆数据: (3) [{…}, {…}, {…}]
   总车辆数: 3
   筛选方向: 去程
   符合方向的车辆: 2 台
   车辆 1: {车牌: "ABC-1234", 纬度: 25.04, 经度: 121.51, ...}
✅ 已在地图上标记 2 台车辆
```

### ✅ 解决方法：

#### 如果看到「目前无车辆资料」：
- **切换方向**：点击「返程」试试
- **换个时间**：在营运时段内测试
- **换条路线**：试试热门路线如 307、红5、棕1

#### 如果看到「连线失败」：
- 检查 Worker 是否正常运行
- 确认 TDX API 金钥配置正确

---

## ❓ 问题2：为什么不能一开始就显示所有站点？

### 技术限制说明：

#### 1. **API 设计限制**
TDX 公车 API 的设计是**基于路线的**：
```
需要提供: 城市 + 路线编号 → 才能获取: 站点列表
```

**无法实现**：
- ❌ 一次性获取全台湾所有路线
- ❌ 获取某城市的所有站点（不指定路线）
- ❌ 随机显示站点

#### 2. **数据量问题**

| 范围 | 路线数 | 站点数 | 预估请求数 |
|------|--------|--------|------------|
| 台北市 | ~300条 | ~8,000个 | 300+ 次 |
| 全台湾 | ~3,000条 | ~50,000个 | 3,000+ 次 |

**后果**：
- 🔥 API 被限流封锁
- 💥 浏览器崩溃（内存不足）
- 🐢 地图卡死（标记过多）

#### 3. **用户体验问题**
即使技术可行：
- 地图上密密麻麻几千个站点，根本看不清
- 加载时间过长（3-5 分钟）
- 无法找到想要的路线

---

## 💡 建议的替代方案

### 方案1：热门路线快速选择
我可以为您添加一个「热门路线」下拉菜单：

```javascript
台北市热门路线：
- 307（内湖、南港）
- 红5（师大、台电大楼）
- 棕1（内科、民生社区）
- 市民小巴（中山区）
```

### 方案2：最近查询记录
使用 `localStorage` 记住用户最近查询的 5 条路线：

```
最近查询：
[307] [红5] [棕1] [307区] [新店客运]
```

### 方案3：我的最爱路线
让用户标记常用路线，下次一键加载：

```
★ 我的最爱：
[307] [捷运接驳1] [棕18]
```

### 方案4：附近路线（需要 GPS）
使用浏览器定位，显示附近 1 公里内的路线：

```javascript
📍 您目前在：市政府站
附近路线：
- 307（距离 50m）
- 红5（距离 120m）
- 蓝5（距离 200m）
```

---

## 🚀 立即调试步骤

### 1. 清除缓存并刷新
```
Ctrl + Shift + Delete → 清除缓存
Ctrl + F5 → 强制刷新
```

### 2. 测试标准流程
1. 打开 `bus-liveboard.html`
2. 按 `F12` 打开控制台
3. 输入 **307**，选择**台北市**，点击**开始追踪**
4. 观察控制台输出：
   - ✅ 有车辆数据 → 地图上应该显示红色箭头
   - ⚠️ 无车辆数据 → 尝试切换方向或换路线

### 3. 检查 Worker
在浏览器输入：
```
https://bus-worker.weacamm.org/?category=CityBus&city=Taipei&route=307
```

应该看到：
```json
{
  "buses": [
    {"plate": "ABC-1234", "lat": 25.04, "lon": 121.51, "dir": 0, "azi": 90}
  ],
  "estimates": { ... }
}
```

---

## 📞 需要进一步协助？

如果问题仍未解决，请提供：
1. 浏览器控制台的完整输出（截图）
2. 测试的路线号码和时间
3. Worker API 的返回结果

我会根据实际情况为您调整代码！
