<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹é“ç›£è¦–å™¨ - TDX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <link rel="stylesheet" href="assets/responsive-camera.css">
    <script>window.CURRENT_PAGE = 'highway';</script>
    <script src="assets/config.js"></script>
    <script src="assets/coordinate-validator.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script src="assets/city-boundaries.js"></script>
    <script src="assets/image-handler-simple.js"></script>
    <script src="assets/camera-statistics.js"></script>
    <script src="assets/camera-tracker.js"></script>
    <script src="assets/lazy-load-cameras.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #1e40af 0%, #0891b2 100%); min-height: 100vh; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #1e40af; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #1e40af; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .back-btn:hover { background: #0891b2; }
        .loading { text-align: center; padding: 50px; color: white; font-size: 1.2rem; }
        
        /* åœ°åœ–å’Œç›£è¦–å™¨åˆ—è¡¨å·¦å³ä½ˆå±€ */
        .cameras-map-wrapper { display: grid; grid-template-columns: 1fr 3fr; gap: 20px; margin: 20px 0; }
        
        /* æ‰‹æ©Ÿç‰ˆæ”¹ç‚ºä¸Šä¸‹ä½ˆå±€ï¼šåœ°åœ–åœ¨ä¸Šï¼Œç›£è¦–å™¨åœ¨ä¸‹ */
        @media (max-width: 768px) {
            .cameras-map-wrapper { 
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }
        }
        
        .cameras-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        @media (max-width: 1400px) {
            .cameras-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 1200px) {
            .cameras-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .cameras-grid { grid-template-columns: 1fr; }
        }
        .camera-card { background: white; border-radius: 10px; padding: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.3s; overflow: hidden; }
        .camera-card:hover { transform: translateY(-5px); }
        .camera-info { padding: 15px; background: white; position: relative; z-index: 2; }
        .camera-info h3 { color: #1e40af; margin-bottom: 8px; font-size: 1.1rem; word-wrap: break-word; overflow-wrap: break-word; font-weight: 600; }
        .camera-info p { color: #666; margin: 4px 0; font-size: 0.9rem; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.5; }
        .camera-image { width: 100%; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .camera-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .camera-image:hover img { transform: scale(1.05); }
        .image-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .camera-image:hover .image-overlay { opacity: 1; }
        .stream-placeholder, .no-image-placeholder, .image-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { position: relative; margin: 2% auto; width: 90%; max-width: 1200px; }
        .close { position: absolute; top: 15px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1001; }
        .close:hover { color: #1e40af; }
        .modal-image { width: 100%; max-height: 80vh; object-fit: contain; }
        .modal-info { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .modal-info h2 { color: #1e40af; margin-bottom: 10px; }
        .modal-info p { color: #666; margin: 5px 0; word-wrap: break-word; overflow-wrap: break-word; }
        
        /* åœ‹é“ç‰¹è‰²æ¨£å¼ */
        .highway-badge { background: #1e40af; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; display: inline-block; margin: 2px; font-weight: 600; vertical-align: middle; }
        .loading-text { color: #333 !important; font-weight: 500; }
        .stats-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: bold; color: #1e40af; }
        .stat-label { color: #666; margin-top: 5px; }
        
        /* ç¯©é¸å€åŸŸ */
        .filter-section { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 5px; font-weight: bold; color: #333; }
        .filter-group select, .filter-group button { padding: 10px; border-radius: 5px; border: 2px solid #1e40af; font-size: 1rem; }
        .filter-group button { background: #1e40af; color: white; cursor: pointer; }
        .filter-group button:hover { background: #0891b2; }
        
        /* åœ°åœ–å®¹å™¨ */
        #map {
            width: 100%;
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 0;
            z-index: 1;
        }
        
        .map-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .map-section h3 {
            color: #1e40af;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* åˆ†é  */
        .pagination { display: flex; justify-content: center; align-items: center; margin: 20px 0; gap: 10px; }
        .pagination button { padding: 10px 15px; border: none; background: white; color: #1e40af; border-radius: 5px; cursor: pointer; }
        .pagination button:hover, .pagination button.active { background: #1e40af; color: white; }
        .pagination button:disabled { background: #ccc; cursor: not-allowed; }
        .pagination span { color: white; font-weight: bold; padding: 10px 15px; }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„åˆ†é æ¨£å¼ */
        body.dark-mode .pagination button { background: rgba(255,255,255,0.1); color: #66BB6A; border: 1px solid rgba(255,255,255,0.2); }
        body.dark-mode .pagination button:hover, body.dark-mode .pagination button.active { background: #66BB6A; color: #1a1a2e; }
        body.dark-mode .pagination button:disabled { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.3); }
        body.dark-mode .pagination span { color: #66BB6A; }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„ç¯©é¸å€åŸŸå’Œçµ±è¨ˆé¢æ¿æ¨£å¼ */
        body.dark-mode .filter-section { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .filter-section h3 { color: #66BB6A; }
        body.dark-mode .filter-group label { color: rgba(255,255,255,0.9); }
        body.dark-mode .filter-group select { background: rgba(255,255,255,0.1); color: white; border-color: #66BB6A; }
        body.dark-mode .filter-group select option { background: #000000; color: white; }
        body.dark-mode .filter-group button { background: #66BB6A; color: #1a1a2e; border-color: #66BB6A; }
        body.dark-mode .filter-group button:hover { background: #81C784; }
        body.dark-mode .stat-card { background: #000000; border: 1px solid rgba(255,255,255,0.15); }
        body.dark-mode .stat-number { color: #66BB6A; }
        body.dark-mode .stat-label { color: rgba(255,255,255,0.7); }
        body.dark-mode #infoPanel { background: #000000; border-left-color: #66BB6A; border: 1px solid rgba(255,255,255,0.15); }
        body.dark-mode #infoPanel h3 { color: #66BB6A; }
        body.dark-mode #infoContent { color: rgba(255,255,255,0.8); }
        body.dark-mode #infoContent a { color: #66BB6A; }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„ç™½è‰²èƒŒæ™¯å…ƒç´  */
        body.dark-mode .header { background: linear-gradient(135deg, rgba(30,30,40,0.95) 0%, rgba(25,25,35,0.95) 100%); border-bottom: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .header h1 { color: #66BB6A; }
        body.dark-mode .camera-card { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(35,35,45,0.95) 100%); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        body.dark-mode .camera-info { background: linear-gradient(135deg, rgba(35,35,45,0.95) 0%, rgba(30,30,40,0.95) 100%); }
        body.dark-mode .camera-info h3 { color: #66BB6A; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        body.dark-mode .camera-info p { color: rgba(255,255,255,0.7); }
        body.dark-mode .loading-text { color: rgba(255,255,255,0.85) !important; }
        body.dark-mode .camera-image { background: rgba(20,20,30,0.6); }
        body.dark-mode .stream-placeholder, body.dark-mode .no-image-placeholder, body.dark-mode .image-placeholder { background: rgba(20,20,30,0.8); color: rgba(255,255,255,0.5); }
        body.dark-mode .modal-info { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(35,35,45,0.95) 100%); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .modal-info h2 { color: #66BB6A; }
        body.dark-mode .modal-info p { color: rgba(255,255,255,0.8); }
        body.dark-mode .map-section { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(35,35,45,0.95) 100%); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        body.dark-mode .map-section h3 { color: #66BB6A; }
        body.dark-mode .back-btn { background: #66BB6A; color: #1a1a2e; }
        body.dark-mode .back-btn:hover { background: #81C784; }
        
        /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼å„ªåŒ– */
        @media (max-width: 768px) {
            .camera-info { padding: 12px; }
            .camera-info h3 { font-size: 1rem; }
            .camera-info p { font-size: 0.85rem; }
            .filter-row { flex-direction: column; align-items: stretch; }
            .stats-panel { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 480px) {
            .stats-panel { grid-template-columns: 1fr; }
        }
    </style>
    
    <!-- è¼‰å…¥é€²åº¦æ¢ -->
    <script src="assets/loading-progress.js"></script>
    <script>
        // åœ‹é“ç›£è¦–å™¨è¼‰å…¥è¨­å®š
        window.AUTO_START_LOADING = false; // æ‰‹å‹•æ§åˆ¶
        
        window.addEventListener('DOMContentLoaded', () => {
            window.startLoading({
                labelText: 'è¼‰å…¥åœ‹é“ç›£è¦–å™¨...',
                color: '#1e40af',
                showLabel: true
            });
        });
    </script>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-road"></i> åœ‹é“ç›£è¦–å™¨</h1>
            <p style="text-align: center; color: #666;">å³æ™‚åœ‹é“è·¯æ³ç›£è¦–å™¨</p>
        </div>
    </div>

    <div class="container">
        <div style="display: flex; gap: 10px; align-items: center;">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é </a>
            <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode" style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; cursor: pointer; font-size: 1.2rem;">
                <i class="fas fa-moon"></i>
            </button>
        </div>
        
        <!-- åœ‹é“ç›£è¦–å™¨èªªæ˜ -->
        <div id="infoPanel" style="background: #e8f5e8; border-left: 4px solid #1e40af; padding: 20px; margin: 20px 0; border-radius: 8px; transition: all 0.3s ease;">
            <h3 style="color: #0891b2; margin: 0 0 15px 0; display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleInfoPanel()">
                <span>
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    TDX äº¤é€šè³‡æ–™æœå‹™èªªæ˜
                </span>
                <i id="toggleIcon" class="fas fa-chevron-up" style="transition: transform 0.3s ease;"></i>
            </h3>
            <div id="infoContent" style="color: #333; line-height: 1.6;">
                <p style="margin: 0 0 10px 0;">
                    æœ¬ç³»çµ±ä½¿ç”¨äº¤é€šéƒ¨ TDX äº¤é€šè³‡æ–™æµé€šæœå‹™å¹³å°æä¾›çš„å³æ™‚åœ‹é“ç›£è¦–å™¨è³‡æ–™ï¼Œä¸¦è¼”ä»¥å‚™æ´APIç¢ºä¿è³‡æ–™ç©©å®šæ€§ã€‚
                </p>
                
                <div style="margin: 15px 0;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">ğŸ”— ç›¸é—œè³‡æºé€£çµï¼š</p>
                    <div style="margin-left: 20px;">
                        <p style="margin: 5px 0;">
                            â€¢ <a href="https://tdx.transportdata.tw" target="_blank" style="color: #0891b2; text-decoration: none;">
                                TDX äº¤é€šè³‡æ–™æµé€šæœå‹™å¹³å° <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                        <p style="margin: 5px 0;">
                            â€¢ <a href="https://1968.freeway.gov.tw" target="_blank" style="color: #0891b2; text-decoration: none;">
                                é«˜é€Ÿå…¬è·¯1968 <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                    </div>
                </div>
                
                <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: #666;">
                    ğŸ“Š æœ¬ç³»çµ±æ•´åˆä¸»è¦èˆ‡å‚™æ´è³‡æ–™æºï¼Œæä¾›æ›´å¯é çš„ç›£è¦–å™¨è³‡æ–™æŸ¥è©¢æœå‹™ã€‚
                </p>
            </div>
        </div>

        <!-- çµ±è¨ˆé¢æ¿ -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-number" id="totalCameras">0</div>
                <div class="stat-label">ç›£è¦–å™¨ç¸½æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="availableCameras">0</div>
                <div class="stat-label">å¯ç”¨ç›£è¦–å™¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="filteredCameras">0</div>
                <div class="stat-label">ç›®å‰é¡¯ç¤º</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highwayCount">0</div>
                <div class="stat-label">åœ‹é“æ•¸</div>
            </div>
        </div>

        <!-- ç¯©é¸å€åŸŸ -->
        <div class="filter-section">
            <h3 style="color: #1e40af; margin-bottom: 15px;"><i class="fas fa-filter"></i> ç¯©é¸åœ‹é“ç›£è¦–å™¨</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="roadSelect">åœ‹é“</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #1e40af; font-size: 1rem;" id="roadSelect" onchange="applyFilters('road')">
                        <option value="">æ‰€æœ‰åœ‹é“</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="citySelect">ç¸£å¸‚</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #1e40af; font-size: 1rem;" id="citySelect" onchange="applyFilters('city')">
                        <option value="">æ‰€æœ‰ç¸£å¸‚</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="directionSelect">æ–¹å‘</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #1e40af; font-size: 1rem;" id="directionSelect" onchange="applyFilters('direction')">
                        <option value="">æ‰€æœ‰æ–¹å‘</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button onclick="resetFilters()"><i class="fas fa-refresh"></i> é‡ç½®ç¯©é¸</button>
                </div>
            </div>
        </div>

        <!-- åœ°åœ–å’Œç›£è¦–å™¨åˆ—è¡¨ä¸¦æ’å¸ƒå±€ -->
        <div class="cameras-map-wrapper">
            <!-- å·¦å´ï¼šåœ°åœ–å®šä½ -->
            <div class="map-section">
                <h3><i class="fas fa-map"></i> ç›£è¦–å™¨åœ°ç†åˆ†ä½ˆåœ–</h3>
                <div id="map"></div>
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                    ğŸ’¡ æç¤ºï¼šé»æ“Šåœ°åœ–ä¸Šçš„æ¨™è¨˜å¯æŸ¥çœ‹ç›£è¦–å™¨è©³ç´°è³‡è¨Šå’Œåæ¨™ä½ç½®
                </p>
            </div>

            <!-- å³å´ï¼šç›£è¦–å™¨å¡ç‰‡åˆ—è¡¨ -->
            <div id="cameras-container" class="loading">
                <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥åœ‹é“ç›£è¦–å™¨è³‡æ–™ä¸­...
            </div>
        </div>

        <!-- åˆ†é  -->
        <div id="pagination" class="pagination" style="display: none;">
            <button onclick="changePage(-1)" id="prevBtn"><i class="fas fa-chevron-left"></i> ä¸Šä¸€é </button>
            <span id="pageInfo">ç¬¬ 1 é ï¼Œå…± 1 é </span>
            <button onclick="changePage(1)" id="nextBtn">ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- å½±åƒå½ˆçª— -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img class="modal-image" id="modalImage" alt="ç›£è¦–å™¨å½±åƒ">
            <div class="modal-info">
            <h2 id="modalTitle">åœ‹é“ç›£è¦–å™¨è³‡è¨Š</h2>
                <p id="modalLocation"></p>
                <p id="modalRoad"></p>
                <p id="modalCoords"></p>
            </div>
        </div>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="assets/camera-map-manager.js"></script>
    <script>
        let allCameras = [];
        let filteredCameras = [];
        let currentPage = 1;
        let itemsPerPage = 12;  // å„ªåŒ–ï¼šæ¸›å°‘æ¯é é¡¯ç¤ºæ•¸é‡ä»¥æå‡åˆå§‹åŠ è¼‰é€Ÿåº¦
        let totalPages = 1;
        
        // åœ°åœ–ç®¡ç†å™¨
        let cameraMapManager = null;
        
        // å°‡è‹±æ–‡æ–¹å‘è½‰æ›ç‚ºä¸­æ–‡
        function convertDirectionToChinese(direction) {
            if (!direction || typeof direction !== 'string') return direction;
            
            const directionMap = {
                'S': 'å—',
                'N': 'åŒ—',  
                'E': 'æ±',
                'W': 'è¥¿',
                'South': 'å—',
                'North': 'åŒ—',
                'East': 'æ±', 
                'West': 'è¥¿',
                'southbound': 'å—ä¸‹',
                'northbound': 'åŒ—ä¸Š',
                'eastbound': 'æ±å‘',
                'westbound': 'è¥¿å‘',
                'Southbound': 'å—ä¸‹',
                'Northbound': 'åŒ—ä¸Š',
                'Eastbound': 'æ±å‘',
                'Westbound': 'è¥¿å‘'
            };
            
            // ç›´æ¥æ˜ å°„
            if (directionMap[direction]) {
                return directionMap[direction];
            }
            
            // è™•ç†åŒ…å«æ–¹å‘è©çš„å­—ç¬¦ä¸²
            let result = direction;
            for (const [english, chinese] of Object.entries(directionMap)) {
                result = result.replace(new RegExp(english, 'gi'), chinese);
            }
            
            return result;
        }
        
        // æ ¼å¼åŒ–ä½ç½®è³‡è¨Šï¼ŒåŒ…å«é‡Œç¨‹ã€æ–¹å‘å’Œè·¯æ®µ
        function formatLocationInfo(camera) {
            // å„ªå…ˆé¡¯ç¤ºé‡Œç¨‹æ•¸ï¼ˆä¸»è¦è³‡è¨Šï¼‰
            if (camera.LocationMile && typeof camera.LocationMile === 'string' && camera.LocationMile.trim()) {
                return camera.LocationMile.trim();
            }
            
            // å…¶æ¬¡é¡¯ç¤ºä½ç½®æè¿°
            if (camera.LocationDescription && typeof camera.LocationDescription === 'string' && camera.LocationDescription.trim()) {
                return camera.LocationDescription.trim();
            }
            
            // å¦‚æœéƒ½æ²’æœ‰,è¿”å›æœªæä¾›
            return 'æœªæä¾›ä½ç½®è³‡è¨Š';
        }

        // åœ‹é“åˆ—è¡¨
        const highwayS = [
            'å°61', 'å°62', 'å°63', 'å°64', 'å°65', 'å°66', 'å°68', 
            'å°72', 'å°74', 'å°76', 'å°78', 'å°82', 'å°84', 'å°86', 'å°88'
        ];
        
        // å¾è·¯æ®µè³‡è¨Šä¸­æå–åœ‹é“è·¯ç·šç·¨è™Ÿ
        function extracthighwayNumber(camera) {
            const roadName = camera.RoadName || '';
            const locationDesc = camera.LocationDescription || '';
            const roadSection = typeof camera.RoadSection === 'string' ? camera.RoadSection : '';
            const allText = `${roadName} ${locationDesc} ${roadSection}`;
            
            // åŒ¹é…å°61ã€å°62ç­‰åœ‹é“æ ¼å¼
            for (const highway of highwayS) {
                const pattern = new RegExp(`[å°è‡º](${highway.slice(1)})ç·š?`, 'g');
                if (pattern.test(allText)) {
                    return `${highway}ç·š`;
                }
            }
            
            // ç‰¹æ®Šè™•ç†ä¸€äº›åˆ¥å
            if (allText.includes('è¥¿æ¿±') || allText.includes('è¥¿éƒ¨æ¿±æµ·')) {
                return 'åœ‹é“1è™Ÿ';
            }
            if (allText.includes('ä¸­æŠ•')) {
                return 'å°63ç·š';
            }
            if (allText.includes('è¬é‡Œç‘æ¿±')) {
                return 'å°62ç·š';
            }
            
            return '';
        }
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºåœ‹é“
        function ishighway(camera) {
            const highwayNumber = extracthighwayNumber(camera);
            return highwayNumber !== '';
        }
        
        // åˆ‡æ›è³‡è¨Šé¢æ¿é¡¯ç¤º/éš±è—
        function toggleInfoPanel() {
            const content = document.getElementById('infoContent');
            const icon = document.getElementById('toggleIcon');
            const panel = document.getElementById('infoPanel');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                icon.style.transform = 'rotate(0deg)';
                panel.style.background = '#e8f5e8';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                icon.style.transform = 'rotate(180deg)';
                panel.style.background = '#f5f5f5';
            }
        }

        // æ ¹æ“šç¶“ç·¯åº¦åˆ¤æ–·ç¸£å¸‚
        // ç¸£å¸‚åˆ¤æ–·å‡½æ•¸å·²ç§»è‡³ assets/city-boundaries.js

        // ï¼ˆç§»é™¤èˆŠçš„ç°¡åŒ–éŒ¯èª¤è™•ç†ï¼Œæ”¹ç”¨å¾Œæ–¹é€²éšç‰ˆæœ¬ï¼‰

        // ç¢ºä¿é€²åº¦æ¢å‡½æ•¸å¯ç”¨çš„è¼”åŠ©å‡½æ•¸
        function ensureProgressFunctions() {
            if (typeof window.setLoadingProgress !== 'function') {
                window.setLoadingProgress = function() { console.warn('setLoadingProgress not available'); };
            }
            if (typeof window.updateLoadingLabel !== 'function') {
                window.updateLoadingLabel = function() { console.warn('updateLoadingLabel not available'); };
            }
            if (typeof window.finishLoading !== 'function') {
                window.finishLoading = function() { console.warn('finishLoading not available'); };
            }
        }

        async function loadCameras() {
            const container = document.getElementById('cameras-container');
            container.innerHTML = '';
            
            // ç¢ºä¿é€²åº¦æ¢å‡½æ•¸å¯ç”¨
            ensureProgressFunctions();
            
            // æ›´æ–°é€²åº¦ - æ¸›å°‘é »ç‡
            window.setLoadingProgress(25);
            window.updateLoadingLabel('é€£æ¥å¾Œç«¯ API...');
            
            let allCamerasFromSources = [];
            
            try {
                console.log('æ­£åœ¨è¼‰å…¥åœ‹é“ç›£è¦–å™¨è³‡æ–™...');
                
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¼‰å…¥åœ‹é“ç›£è¦–å™¨è³‡æ–™...<br>
                        <small style="margin-top: 10px; display: block;">å¾å¾Œç«¯ä»£ç†å®‰å…¨åœ°è¼‰å…¥å…¨åœ‹åœ‹é“ç›£è¦–å™¨...</small>
                    </div>
                `;
                
                // å»¶é²é€²åº¦æ›´æ–°ä»¥æ¸›å°‘é »ç¹èª¿ç”¨
                setTimeout(() => {
                    window.setLoadingProgress(50);
                    window.updateLoadingLabel('è¼‰å…¥åœ‹é“ç›£è¦–å™¨è³‡æ–™...');
                }, 100);
                
                // ã€æ–°æ–¹å¼ã€‘ä½¿ç”¨å¾Œç«¯ä»£ç† API è€Œä¸æ˜¯ç›´æ¥å‘¼å« TDX
                // å„ªé»ï¼š
                // - API å¯†é‘°å®‰å…¨ï¼ˆåªåœ¨ä¼ºæœå™¨ç«¯ï¼‰
                // - CDN è‡ªå‹•å¿«å– 60 ç§’
                // - è§£æ±º CORS å•é¡Œ
                // - ç¯€çœ API é¡åº¦
                console.log('ğŸ“¡ å¾å¾Œç«¯ä»£ç†è¼‰å…¥ Freeway ç›£è¦–å™¨è³‡æ–™...');
                
                // âœ¨ ä¿®æ”¹ï¼šå°‡ä¸Šé™æé«˜åˆ° 3500ï¼Œç¢ºä¿æŠ“å–æ‰€æœ‰åœ‹é“ç›£è¦–å™¨
                const response = await tdxApi.fetchCCTVData('Freeway', 3500);
                
                // æ›´æ–°é€²åº¦
                window.setLoadingProgress(75);
                window.updateLoadingLabel('è™•ç†ç›£è¦–å™¨è³‡æ–™...');
                
                let cameras = [];
                if (Array.isArray(response)) {
                    cameras = response;
                } else if (response && response.CCTVs && Array.isArray(response.CCTVs)) {
                    cameras = response.CCTVs;
                } else if (response && response.data && Array.isArray(response.data)) {
                    cameras = response.data;
                } else {
                    console.warn('æœªé æœŸçš„å›æ‡‰æ ¼å¼:', response);
                    cameras = [];
                }
                
                console.log(`ğŸ“Š TDX Freeway åŸå§‹è³‡æ–™: ${cameras.length} ç­†`);
                
                if (cameras.length > 0) {
                    // Freeway API ç›´æ¥è¿”å›åœ‹é“è³‡æ–™ï¼Œä¸éœ€ç¯©é¸
                    allCamerasFromSources = cameras.map(camera => ({
                        ...camera, 
                        source: 'tdx',
                        RoadNumber: camera.RoadName || 'æœªçŸ¥åœ‹é“'
                    }));
                }
                
            } catch (error) {
                console.error('è¼‰å…¥åœ‹é“ç›£è¦–å™¨è³‡æ–™å¤±æ•—:', error);
                window.finishLoading();
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        è¼‰å…¥å¤±æ•—: ${error.message}<br><br>
                        <button onclick="loadCameras()" style="padding: 10px 20px; background: #1e40af; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-refresh"></i> é‡æ–°è¼‰å…¥
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log(`ğŸ“Š åœ‹é“ç›£è¦–å™¨: ${allCamerasFromSources.length} ç­†`);
            
            // èª¿è©¦: æª¢æŸ¥ç¬¬ä¸€ç­†è³‡æ–™çš„å½±åƒæ¬„ä½
            if (allCamerasFromSources.length > 0) {
                const firstCamera = allCamerasFromSources[0];
                console.log('ğŸ” ç¬¬ä¸€ç­†ç›£è¦–å™¨è³‡æ–™:');
                console.log('  - VideoImageUrl:', firstCamera.VideoImageUrl);
                console.log('  - VideoImageURL:', firstCamera.VideoImageURL);
                console.log('  - VideoStreamURL:', firstCamera.VideoStreamURL);
                console.log('  - PictureURL:', firstCamera.PictureURL);
                console.log('  - æ‰€æœ‰æ¬„ä½:', Object.keys(firstCamera));
            }
            
            // æœ€çµ‚é€²åº¦æ›´æ–°
            window.setLoadingProgress(100);
            window.updateLoadingLabel('è¼‰å…¥ç›£è¦–å™¨å½±åƒ...');
            
            if (allCamerasFromSources.length === 0) {
                window.finishLoading();
                container.innerHTML = '<div class="loading">ç›®å‰æ²’æœ‰å¯ç”¨çš„åœ‹é“ç›£è¦–å™¨è³‡æ–™</div>';
                return;
            }
            
            // è™•ç†ç›£è¦–å™¨è³‡æ–™
            allCameras = allCamerasFromSources.map(camera => ({
                ...camera,
                City: getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName)
            }));
            
            filteredCameras = allCameras;
            populateFilters();
            updateStats();
            displayCameras(allCameras);
            
            // å»¶é²åˆå§‹åŒ–åœ°åœ–ï¼Œç¢ºä¿ Leaflet å·²å®Œå…¨åŠ è¼‰
            setTimeout(() => {
                console.log('æª¢æŸ¥ Leaflet åŠ è¼‰ç‹€æ…‹...');
                if (typeof L !== 'undefined') {
                    console.log('âœ… Leaflet å·²å°±ä½ï¼Œç¾åœ¨åˆå§‹åŒ–åœ°åœ–');
                    initializeMap();
                } else {
                    console.error('âŒ Leaflet ä»æœªåŠ è¼‰ï¼Œå˜—è©¦é‡æ–°åŠ è¼‰...');
                    // é‡æ–°æª¢æŸ¥
                    setTimeout(() => {
                        if (typeof L !== 'undefined') {
                            initializeMap();
                        } else {
                            console.error('âŒ Leaflet åŠ è¼‰å¤±æ•—ï¼');
                        }
                    }, 1000);
                }
            }, 500);
            
            // å®Œæˆè¼‰å…¥é€²åº¦
            setTimeout(() => {
                window.finishLoading();
            }, 200);
        }

        function populateFilters() {
            console.log('ğŸ”„ é–‹å§‹å¡«å……ç¯©é¸ä¸‹æ‹‰é¸å–®...');
            updateRoadSelect(allCameras);
            console.log('âœ… åœ‹é“ç¯©é¸å·²å¡«å……');
            updateCitySelect(allCameras);
            console.log('âœ… ç¸£å¸‚ç¯©é¸å·²å¡«å……');
            updateDirectionSelect(allCameras);
            console.log('âœ… æ–¹å‘ç¯©é¸å·²å¡«å……');
            console.log('âœ… æ‰€æœ‰ç¯©é¸ä¸‹æ‹‰é¸å–®å·²å®Œæˆåˆå§‹åŒ–');
        }

        function updateStats() {
            document.getElementById('totalCameras').textContent = allCameras.length;
            const available = allCameras.filter(c => c.VideoImageUrl || c.VideoImageURL || c.VideoStreamURL || c.PictureURL).length;
            document.getElementById('availableCameras').textContent = available;
            document.getElementById('filteredCameras').textContent = filteredCameras.length;
            
            // è¨ˆç®—åœ‹é“æ•¸é‡
            const highways = [...new Set(allCameras.map(c => c.RoadNumber).filter(Boolean))];
            document.getElementById('highwayCount').textContent = highways.length;
        }

        function applyFilters(changedFilter = null) {
            const roadFilter = document.getElementById('roadSelect').value;
            const cityFilter = document.getElementById('citySelect').value;
            const directionFilter = document.getElementById('directionSelect').value;
            
            if (changedFilter === 'road') {
                if (roadFilter) {
                    const camerasForRoad = allCameras.filter(camera => camera.RoadNumber === roadFilter);
                    const citiesForRoad = [...new Set(camerasForRoad.map(c => c.City).filter(Boolean))].sort();
                    const citySelect = document.getElementById('citySelect');
                    const currentCityValue = citySelect.value;
                    
                    citySelect.innerHTML = '<option value="">æ‰€æœ‰ç¸£å¸‚</option>' + 
                        citiesForRoad.map(city => {
                            const count = camerasForRoad.filter(c => c.City === city).length;
                            return `<option value="${city}">${city} (${count})</option>`;
                        }).join('');
                    
                    if (currentCityValue && citiesForRoad.includes(currentCityValue)) {
                        citySelect.value = currentCityValue;
                    }
                    
                    // æ›´æ–°æ–¹å‘é¸æ“‡å™¨
                    updateDirectionSelect(camerasForRoad);
                } else {
                    updateCitySelect(allCameras);
                    updateDirectionSelect(allCameras);
                }
            } else if (changedFilter === 'city') {
                if (cityFilter) {
                    const camerasForCity = allCameras.filter(camera => camera.City === cityFilter);
                    const roadsForCity = [...new Set(camerasForCity.map(c => c.RoadNumber).filter(Boolean))].sort((a, b) => {
                        const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                        const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                        return numA - numB;
                    });
                    const roadSelect = document.getElementById('roadSelect');
                    const currentRoadValue = roadSelect.value;
                    
                    roadSelect.innerHTML = '<option value="">æ‰€æœ‰åœ‹é“</option>' + 
                        roadsForCity.map(road => {
                            const count = camerasForCity.filter(c => c.RoadNumber === road).length;
                            return `<option value="${road}">${road} (${count})</option>`;
                        }).join('');
                    
                    if (currentRoadValue && roadsForCity.includes(currentRoadValue)) {
                        roadSelect.value = currentRoadValue;
                    }
                    
                    // æ›´æ–°æ–¹å‘é¸æ“‡å™¨
                    updateDirectionSelect(camerasForCity);
                } else {
                    updateRoadSelect(allCameras);
                    updateDirectionSelect(allCameras);
                }
            } else if (changedFilter === 'direction') {
                if (directionFilter) {
                    const camerasForDirection = allCameras.filter(camera => 
                        convertDirectionToChinese(camera.RoadDirection) === directionFilter
                    );
                    
                    // æ›´æ–°åœ‹é“é¸æ“‡å™¨
                    const roadsForDirection = [...new Set(camerasForDirection.map(c => c.RoadNumber).filter(Boolean))].sort((a, b) => {
                        const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                        const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                        return numA - numB;
                    });
                    const roadSelect = document.getElementById('roadSelect');
                    const currentRoadValue = roadSelect.value;
                    
                    roadSelect.innerHTML = '<option value="">æ‰€æœ‰åœ‹é“</option>' + 
                        roadsForDirection.map(road => {
                            const count = camerasForDirection.filter(c => c.RoadNumber === road).length;
                            return `<option value="${road}">${road} (${count})</option>`;
                        }).join('');
                    
                    if (currentRoadValue && roadsForDirection.includes(currentRoadValue)) {
                        roadSelect.value = currentRoadValue;
                    }
                    
                    // æ›´æ–°ç¸£å¸‚é¸æ“‡å™¨
                    updateCitySelect(camerasForDirection);
                } else {
                    updateRoadSelect(allCameras);
                    updateCitySelect(allCameras);
                }
            }
            
            filteredCameras = allCameras.filter(camera => {
                const matchRoad = !roadFilter || camera.RoadNumber === roadFilter;
                const matchCity = !cityFilter || camera.City === cityFilter;
                const matchDirection = !directionFilter || convertDirectionToChinese(camera.RoadDirection) === directionFilter;
                return matchRoad && matchCity && matchDirection;
            });
            
            currentPage = 1;
            updateStats();
            displayCameras(filteredCameras);
            updateMapMarkers();
        }
        
        function updateRoadSelect(cameras, selectedValue = '') {
            const roads = [...new Set(cameras.map(c => c.RoadNumber).filter(Boolean))].sort((a, b) => {
                const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                return numA - numB;
            });
            
            const roadSelect = document.getElementById('roadSelect');
            roadSelect.innerHTML = '<option value="">æ‰€æœ‰åœ‹é“</option>' + 
                roads.map(road => {
                    const count = cameras.filter(c => c.RoadNumber === road).length;
                    return `<option value="${road}">${road} (${count})</option>`;
                }).join('');
            
            if (selectedValue) {
                roadSelect.value = selectedValue;
            }
        }
        
        function updateCitySelect(cameras, selectedValue = '') {
            // å°ç£ç¸£å¸‚æ¨™æº–æ’åº - ç”±åŒ—åˆ°å—ï¼Œç›´è½„å¸‚å„ªå…ˆ
            const TAIWAN_CITY_ORDER = [
                'å°åŒ—å¸‚', 'æ–°åŒ—å¸‚', 'æ¡ƒåœ’å¸‚', 'å°ä¸­å¸‚', 'å°å—å¸‚', 'é«˜é›„å¸‚',
                'åŸºéš†å¸‚', 'æ–°ç«¹å¸‚', 'å˜‰ç¾©å¸‚',
                'æ–°ç«¹ç¸£', 'è‹—æ —ç¸£', 'å½°åŒ–ç¸£', 'å—æŠ•ç¸£', 'é›²æ—ç¸£', 'å˜‰ç¾©ç¸£', 'å±æ±ç¸£',
                'å®œè˜­ç¸£', 'èŠ±è“®ç¸£', 'å°æ±ç¸£',
                'æ¾æ¹–ç¸£', 'é‡‘é–€ç¸£', 'é€£æ±Ÿç¸£'
            ];
            
            const cities = [...new Set(cameras.map(c => c.City).filter(Boolean))];
            // æŒ‰ç…§å°ç£ç¸£å¸‚æ¨™æº–é †åºæ’åˆ—
            const sortedCities = cities.sort((a, b) => {
                const indexA = TAIWAN_CITY_ORDER.indexOf(a);
                const indexB = TAIWAN_CITY_ORDER.indexOf(b);
                // å¦‚æœåœ¨æ¨™æº–é †åºä¸­æ‰¾ä¸åˆ°ï¼Œå‰‡æ”¾åœ¨æœ€å¾Œä¸¦æŒ‰å­—æ¯æ’åº
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            const citySelect = document.getElementById('citySelect');
            
            citySelect.innerHTML = '<option value="">æ‰€æœ‰ç¸£å¸‚</option>' + 
                sortedCities.map(city => {
                    const count = cameras.filter(c => c.City === city).length;
                    return `<option value="${city}">${city} (${count})</option>`;
                }).join('');
            
            if (selectedValue) {
                citySelect.value = selectedValue;
            }
        }

        function updateDirectionSelect(cameras, selectedValue = '') {
            const directions = [...new Set(cameras
                .map(c => c.RoadDirection)
                .filter(Boolean)
                .map(d => convertDirectionToChinese(d))
            )].sort();
            
            const directionSelect = document.getElementById('directionSelect');
            directionSelect.innerHTML = '<option value="">æ‰€æœ‰æ–¹å‘</option>' + 
                directions.map(direction => {
                    const count = cameras.filter(c => 
                        convertDirectionToChinese(c.RoadDirection) === direction
                    ).length;
                    return `<option value="${direction}">${direction} (${count})</option>`;
                }).join('');
            
            if (selectedValue) {
                directionSelect.value = selectedValue;
            }
        }

        function resetFilters() {
            document.getElementById('roadSelect').value = '';
            document.getElementById('citySelect').value = '';
            document.getElementById('directionSelect').value = '';
            applyFilters();
        }

        function displayCameras(cameras) {
            const container = document.getElementById('cameras-container');
            const pagination = document.getElementById('pagination');
            
            if (cameras.length === 0) {
                container.innerHTML = '<div class="loading">ç„¡ç¬¦åˆç¯©é¸æ¢ä»¶çš„åœ‹é“ç›£è¦–å™¨</div>';
                pagination.style.display = 'none';
                return;
            }

            // è¨ˆç®—åˆ†é 
            totalPages = Math.ceil(cameras.length / itemsPerPage);
            if (currentPage > totalPages) currentPage = 1;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const displayCameras = cameras.slice(startIndex, endIndex);

            // é¿å…è·¯ç·šé‡è¤‡é¡¯ç¤ºï¼ˆä¾‹å¦‚ "å°62ç·š å°62ç·š"ï¼‰
            function buildRoadTitle(camera) {
                const roadName = (camera.RoadName || '').trim();
                const roadNumber = (camera.RoadNumber || '').trim();
                if (!roadName && !roadNumber) return 'åœ‹é“ç›£è¦–å™¨';
                if (roadName && roadNumber) {
                    // å»é™¤ç›¸åŒæˆ–åŒ…å«é—œä¿‚çš„é‡è¤‡ï¼ˆå¿½ç•¥ã€Œç·šã€å­—å·®ç•°ï¼‰
                    const normalizedName = roadName.replace(/ç·š$/,'');
                    const normalizedNumber = roadNumber.replace(/ç·š$/,'');
                    if (normalizedName === normalizedNumber) return roadName || roadNumber;
                    return `${roadName} ${roadNumber}`;
                }
                return roadName || roadNumber || 'åœ‹é“ç›£è¦–å™¨';
            }

            const grid = displayCameras.map((camera, index) => {
                const sourceIcon = camera.source === 'tdx' ? '<i class="fas fa-database" title="TDXè³‡æ–™" style="color: #1e40af;"></i>' : '';
                const badge = camera.RoadNumber ? `<span class="highway-badge">${camera.RoadNumber}</span>` : '';
                const imageId = `img-${startIndex + index}-${Date.now()}`;
                const imageUrl = camera.VideoImageUrl || camera.VideoImageURL || camera.VideoStreamURL || camera.PictureURL;
                const roadTitle = buildRoadTitle(camera);
                return `
                    <div class="camera-card" onclick="openModal(${startIndex + index})">
                        <div class="camera-image" id="container-${imageId}">
                            ${imageUrl ? 
                                `<div class="image-loading-placeholder" style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;background:#f5f5f5;border-radius:8px;">
                                    <i class="fas fa-spinner fa-pulse" style="font-size:2rem;margin-bottom:8px;color:#667eea;"></i>
                                    <span class="loading-text" style="font-size:0.85rem;color:#444;">è¼‰å…¥ä¸­...</span>
                                </div>
                                <img id="${imageId}" data-src="${imageUrl}" alt="${camera.CCTVID || 'ç›£è¦–å™¨å½±åƒ'}" 
                                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; display: none;"
                                     onload="handleImageLoad(this)"
                                     onerror="handleImageError(this, '${imageUrl}')">
                                 <div class="image-overlay" style="display: none;">
                                     <i class="fas fa-search-plus" style="font-size: 2rem;"></i>
                                 </div>` : 
                                '<div class="no-image-placeholder" style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;background:#f5f5f5;border-radius:8px;"><i class="fas fa-video-slash" style="font-size: 2rem; color: #ccc; margin-bottom: 10px;"></i><span style="color: #666;">ç„¡å½±åƒè³‡æ–™</span></div>'
                            }
                        </div>
                        <div class="camera-info">
                            <h3>${roadTitle} ${badge} ${sourceIcon}</h3>
                            ${camera.LocationMile || camera.LocationDescription ? `
                                <p><i class="fas fa-map-marker-alt"></i> 
                                   ${camera.LocationMile || camera.LocationDescription}
                                   ${camera.DirectionChinese && camera.DirectionChinese !== 'æœªæ¨™ç¤º' ? 
                                       `<span style="margin-left: 8px; color: #2196F3;"><i class="fas fa-compass"></i> ${camera.DirectionChinese}</span>` : ''
                                   }
                                </p>
                            ` : ''}
                            <p><i class="fas fa-map"></i> ${camera.City || getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName)}</p>
                            <p><i class="fas fa-id-badge"></i> ${camera.CCTVID || 'æœªçŸ¥ç·¨è™Ÿ'}</p>
                            ${camera.PositionLat && camera.PositionLon ? 
                                `<p><i class="fas fa-crosshairs"></i> 
                                  <a href="https://www.google.com/maps?q=${camera.PositionLat},${camera.PositionLon}" 
                                     target="_blank" 
                                     style="color: #667eea; text-decoration: none;" 
                                     title="åœ¨Googleåœ°åœ–ä¸­æŸ¥çœ‹">
                                    ${camera.PositionLat.toFixed(4)}, ${camera.PositionLon.toFixed(4)}
                                    <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-left: 3px;"></i>
                                  </a>
                                </p>` : ''
                            }
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="cameras-grid">${grid}</div>`;
            
            // æ›´æ–°åˆ†é 
            updatePagination();
            
            // ä½¿ç”¨æ¼¸é€²å¼è¼‰å…¥åœ–ç‰‡,é¿å…HTTP/2é€£ç·šéè¼‰
            setTimeout(() => {
                progressiveImageLoading();
            }, 100);
        }

        // æ¼¸é€²å¼åœ–ç‰‡è¼‰å…¥ - ä¿®å¾© HTTP/2 å”è­°éŒ¯èª¤
        let imageLoadQueue = [];
        let currentLoadingCount = 0;
        // å›ºå®šä¿å®ˆåƒæ•¸ï¼Œé¿å…ä¼ºæœå™¨é€£ç·šé‡ç½®
        const MAX_CONCURRENT_LOADS = 2; // å›ºå®šç‚º 2ï¼Œä¸å†å‹•æ…‹èª¿æ•´
        const LOAD_DELAY = 800; // å›ºå®šå»¶é² 800msï¼Œçµ¦ä¼ºæœå™¨è¶³å¤ ç·©è¡æ™‚é–“
        const MAX_RETRIES = 3; // æœ€å¤§é‡è©¦æ¬¡æ•¸
        const RETRY_DELAY = 2000; // é‡è©¦å»¶é² 2 ç§’
        const COOLDOWN_DURATION = 10 * 60 * 1000; // å†·å»æ™‚é–“ 10 åˆ†é˜
        const cameraCooldown = new Map(); // cameraId -> timestamp until available
        const imageRetryAttempts = new Map(); // imageId -> retry count

        function progressiveImageLoading() {
            // æ”¶é›†æ‰€æœ‰å¾…è¼‰å…¥çš„åœ–ç‰‡
            const images = document.querySelectorAll('img[data-src]:not([src])');
            imageLoadQueue = Array.from(images);
            
            console.log(`ğŸ–¼ï¸ é–‹å§‹æ¼¸é€²å¼è¼‰å…¥ ${imageLoadQueue.length} å¼µåœ–ç‰‡ (ä½µç™¼: ${MAX_CONCURRENT_LOADS}, å»¶é²: ${LOAD_DELAY}ms)`);
            
            // é–‹å§‹è¼‰å…¥ä½‡åˆ—
            processImageQueue();
        }

        function processImageQueue() {
            // éæ¿¾æ‰è™•æ–¼å†·å»ä¸­çš„ç›¸æ©Ÿ
            const now = Date.now();
            imageLoadQueue = imageLoadQueue.filter(img => {
                const camId = img.dataset.src?.match(/camera=(\d+)/)?.[1];
                if (!camId) return true;
                const cooldownUntil = cameraCooldown.get(camId);
                return !cooldownUntil || cooldownUntil <= now;
            });

            while (currentLoadingCount < MAX_CONCURRENT_LOADS && imageLoadQueue.length > 0) {
                const img = imageLoadQueue.shift();
                if (img && img.dataset.src) {
                    loadImageWithDelay(img);
                }
            }
        }

        function loadImageWithDelay(img) {
            currentLoadingCount++;
            setTimeout(() => {
                const container = img.closest('.camera-image');
                const loadingPlaceholder = container?.querySelector('.image-loading-placeholder');
                const overlay = container?.querySelector('.image-overlay');
                const src = img.dataset.src;
                const camId = src?.match(/camera=(\d+)/)?.[1];
                const imgId = img.id || src;

                img.onload = function() {
                    handleImageLoad(this);
                    if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
                    if (overlay) overlay.style.display = 'flex';
                    this.style.display = 'block';
                    // æ¸…é™¤é‡è©¦è¨ˆæ•¸
                    imageRetryAttempts.delete(imgId);
                    currentLoadingCount--;
                    processImageQueue();
                };

                img.onerror = function(e) {
                    console.warn(`âŒ åœ–ç‰‡è¼‰å…¥å¤±æ•—: camera=${camId}`);
                    const retryCount = imageRetryAttempts.get(imgId) || 0;
                    
                    if (retryCount < MAX_RETRIES) {
                        // é‡è©¦é‚è¼¯
                        imageRetryAttempts.set(imgId, retryCount + 1);
                        console.log(`ğŸ”„ é‡è©¦è¼‰å…¥ (${retryCount + 1}/${MAX_RETRIES}): camera=${camId}`);
                        
                        setTimeout(() => {
                            // é‡è©¦æ™‚æ›´æ–°æ™‚é–“æˆ³è¨˜
                            if (this.src.includes('weserv.nl')) {
                                const currentSrc = this.src;
                                const newUrl = currentSrc.replace(/&t=\d+/, `&t=${Date.now()}`);
                                this.src = newUrl;
                            } else {
                                this.src = `${src}${src.includes('?') ? '&' : '?'}retry=${retryCount + 1}&t=${Date.now()}`;
                            }
                        }, RETRY_DELAY);
                    } else {
                        // è¶…éé‡è©¦æ¬¡æ•¸ï¼Œé€²å…¥å†·å»
                        if (camId) {
                            cameraCooldown.set(camId, Date.now() + COOLDOWN_DURATION);
                            console.log(`â¸ï¸ ç›¸æ©Ÿ ${camId} é€²å…¥å†·å»ï¼Œæ™‚é•·: ${COOLDOWN_DURATION / 1000 / 60} åˆ†é˜`);
                        }
                        
                        handleImageError(this, src);
                        imageRetryAttempts.delete(imgId);
                    }
                    
                    currentLoadingCount--;
                    processImageQueue();
                };

                // ç›´æ¥ä½¿ç”¨ data-src ä¸­å„²å­˜çš„å®Œæ•´ VideoStreamURL
                let imageUrl = src;
                
                if (!imageUrl) {
                    console.warn('âš ï¸ ç¼ºå°‘å½±åƒç¶²å€');
                    currentLoadingCount--;
                    processImageQueue();
                    return;
                }
                
                // ç¢ºä¿ä½¿ç”¨ HTTPS å’Œæ­£ç¢ºçš„ä¼ºæœå™¨
                if (imageUrl.includes('freeway.gov.tw')) {
                    imageUrl = imageUrl.replace(/^http:/, 'https:')
                                      .replace('cctv.freeway.gov.tw', 'cctvn.freeway.gov.tw')
                                      .replace('cctvs.freeway.gov.tw', 'cctvn.freeway.gov.tw');
                    
                    // åŠ ä¸Šæ™‚é–“æˆ³è¨˜é¿å…å¿«å–
                    imageUrl = `${imageUrl}${imageUrl.includes('?') ? '&' : '?'}t=${Date.now()}`;
                    
                    // ä½¿ç”¨ corsproxy.io ä»£ç† (è§£æ±º HTTP/2 Protocol Error)
                    img.src = `https://corsproxy.io/?${encodeURIComponent(imageUrl)}`;
                    console.log(`ğŸ–¼ï¸ è¼‰å…¥: ${imageUrl.substring(0, 60)}...`);
                } else {
                    // éé«˜å…¬å±€ä¾†æºï¼Œç›´æ¥ä½¿ç”¨
                    img.src = imageUrl;
                }
            }, LOAD_DELAY);
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            pageInfo.textContent = `ç¬¬ ${currentPage} é ï¼Œå…± ${totalPages} é `;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayCameras(filteredCameras);
            }
        }

        // è™•ç†åœ–ç‰‡è¼‰å…¥éŒ¯èª¤ - é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
        function handleImageError(imgElement, originalSrc) {
            const camId = originalSrc.match(/camera=(\d+)/)?.[1];
            
            if (imgElement.parentNode) {
                const cooldownMinutes = Math.floor(COOLDOWN_DURATION / 1000 / 60);
                imgElement.parentNode.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#999;background:#f5f5f5;border-radius:8px;">
                    <i class="fas fa-exclamation-triangle" style="font-size:2rem;margin-bottom:8px;color:#f44336;"></i>
                    <span style="font-size:0.85rem;text-align:center;">å½±åƒæš«æ™‚ç„¡æ³•è¼‰å…¥<br>${camId ? `ç›¸æ©Ÿ ${camId}` : ''}<br>å†·å»ä¸­ (${cooldownMinutes}åˆ†é˜)</span>
                </div>`;
            }
        }
        
        // åœ–ç‰‡è¼‰å…¥æˆåŠŸè™•ç†
        function handleImageLoad(imgElement) {
            // è¼‰å…¥æˆåŠŸï¼Œä¸éœ€è¦ç‰¹åˆ¥è™•ç†
            console.log(`âœ… åœ–ç‰‡è¼‰å…¥æˆåŠŸ:`, imgElement.id);
        }

        function openModal(index) {
            const camera = filteredCameras[index];
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalLocation = document.getElementById('modalLocation');
            const modalRoad = document.getElementById('modalRoad');
            const modalCoords = document.getElementById('modalCoords');
            
            modalImg.src = camera.VideoImageUrl || camera.VideoImageURL || camera.VideoStreamURL || camera.PictureURL || '';
            modalTitle.textContent = camera.RoadName || 'åœ‹é“ç›£è¦–å™¨';
            
            // é¡¯ç¤ºé‡Œç¨‹è³‡è¨Š - å„ªå…ˆä½¿ç”¨ LocationMileï¼Œæ ¼å¼åŒ–ç‚º"ç¬¬XXk+XXX"
            modalLocation.innerHTML = `<i class="fas fa-map-marker-alt"></i> <strong>ä½ç½®ï¼š</strong>${formatLocationInfo(camera)}`;
            
            modalRoad.innerHTML = `<i class="fas fa-road"></i> <strong>è·¯ç·šï¼š</strong>${camera.RoadNumber || 'æœªçŸ¥è·¯ç·š'} (${camera.City || getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName)})`;
            
            // åº§æ¨™å’ŒåŸå§‹å½±åƒé€£çµ
            let coordsHtml = '';
            if (camera.PositionLat && camera.PositionLon) {
                coordsHtml = `<i class="fas fa-crosshairs"></i> <strong>åº§æ¨™ï¼š</strong>
                    <a href="https://www.google.com/maps?q=${camera.PositionLat},${camera.PositionLon}" 
                       target="_blank" 
                       style="color: #667eea; text-decoration: none;" 
                       title="åœ¨Googleåœ°åœ–ä¸­æŸ¥çœ‹">
                        ${camera.PositionLat.toFixed(6)}, ${camera.PositionLon.toFixed(6)}
                        <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-left: 3px;"></i>
                    </a>`;
            }
            
            const imageUrl = camera.VideoImageUrl || camera.VideoImageURL || camera.VideoStreamURL || camera.PictureURL;
            if (imageUrl) {
                coordsHtml += `<br><i class="fas fa-external-link-alt"></i> <a href="${imageUrl}" target="_blank" style="color: #1e40af; text-decoration: none; margin-left: 5px;">æŸ¥çœ‹åŸå§‹å½±åƒ</a>`;
            }
            
            modalCoords.innerHTML = coordsHtml;
            
            modal.style.display = 'block';

            // ğŸ¥ è¨˜éŒ„ç›£è¦–å™¨ç€è¦½çµ±è¨ˆ
            const cameraId = camera.CCTVID || camera.CCTVId || `highway-${index}`;
            const locationName = `${camera.RoadName || 'åœ‹é“'}${formatLocationInfo(camera)}`;
            recordCameraView(cameraId, locationName, 'highway');
        }

        // æ ¹æ“šç›¸æ©ŸIDæŸ¥æ‰¾ä¸¦æ‰“é–‹è©³ç´°è³‡è¨Š
        function openCameraDetails(cameraId) {
            // åœ¨æ‰€æœ‰ç›¸æ©Ÿä¸­æœç´¢åŒ¹é…çš„ID
            const index = allCameras.findIndex(camera => {
                return (camera.CCTVID === cameraId || 
                        camera.RoadName === cameraId ||
                        camera.LocationDescription === cameraId);
            });
            
            if (index !== -1) {
                // å¦‚æœæ‰¾åˆ°ï¼Œæ‰“é–‹è©²ç›¸æ©Ÿçš„è©³æƒ…å½ˆçª—
                openModal(index);
            } else {
                console.warn('æ‰¾ä¸åˆ°ç›¸æ©Ÿ:', cameraId);
            }
        }

        // é—œé–‰å½ˆçª—
        document.getElementsByClassName('close')[0].onclick = function() {
            document.getElementById('imageModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // åˆå§‹åŒ–åœ°åœ–
        function initializeMap() {
            console.log('é–‹å§‹åˆå§‹åŒ–åœ°åœ–...');
            
            // æª¢æŸ¥ Leaflet æ˜¯å¦å·²è¼‰å…¥
            if (typeof L === 'undefined') {
                console.error('âŒ Leaflet æœªæˆåŠŸè¼‰å…¥ï¼Œç„¡æ³•åˆå§‹åŒ–åœ°åœ–');
                console.log('window.L:', window.L);
                return;
            }
            
            // æª¢æŸ¥åœ°åœ–å®¹å™¨
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.error('âŒ æ‰¾ä¸åˆ°åœ°åœ–å®¹å™¨ #map');
                return;
            }
            
            console.log('âœ… Leaflet å·²è¼‰å…¥ï¼Œåœ°åœ–å®¹å™¨å­˜åœ¨');
            console.log('åœ°åœ–å®¹å™¨å¤§å°:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);
            
            try {
                if (cameraMapManager) {
                    console.log('éŠ·æ¯€èˆŠçš„åœ°åœ–ç®¡ç†å™¨...');
                    cameraMapManager.destroy();
                }
                
                console.log('å»ºç«‹æ–°çš„ CameraMapManagerï¼Œç›£è¦–å™¨æ•¸é‡:', allCameras.length);
                cameraMapManager = new CameraMapManager('map', allCameras, {
                    center: [23.5, 121],
                    zoom: 7,
                    onMarkerClick: (camera) => {
                        console.log('é»æ“Šç›£è¦–å™¨:', camera);
                    }
                });
                
                console.log('âœ… åœ°åœ–åˆå§‹åŒ–æˆåŠŸï¼');
            } catch (error) {
                console.error('âŒ åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', error.message, error.stack);
            }
        }

        // æ›´æ–°åœ°åœ–æ¨™è¨˜
        function updateMapMarkers() {
            if (cameraMapManager) {
                console.log('æ›´æ–°åœ°åœ–æ¨™è¨˜ï¼Œç›£è¦–å™¨æ•¸é‡:', filteredCameras.length);
                cameraMapManager.updateMarkers(filteredCameras);
            } else {
                console.warn('âš ï¸ cameraMapManager æœªåˆå§‹åŒ–');
            }
        }

        // ç•¶æ‡‰ç”¨ç¯©é¸æ™‚æ›´æ–°åœ°åœ–
        function updateCameraMap() {
            updateMapMarkers();
        }

        // åˆå§‹è¼‰å…¥
        window.onload = function() {
            // ç¢ºä¿é€²åº¦æ¢å·²åˆå§‹åŒ–å†é–‹å§‹è¼‰å…¥
            setTimeout(() => {
                loadCameras();
            }, 100);
        };
    </script>

    <!-- Back to Top Button -->
    <div class="back-to-top" id="backToTop" style="position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999; font-size: 1.2rem;">
        <i class="fas fa-arrow-up"></i>
    </div>
</body>
</html>
