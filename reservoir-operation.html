<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ºç£æ°´åº«å³æ™‚æˆ°æƒ…å®¤</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* =========================================
           ğŸ¨ è‰²å½©è®Šæ•¸ç³»çµ± (CSS Variables)
           ========================================= */
        :root {
            /* --- äº®è‰²æ¨¡å¼ (é è¨­) --- */
            --primary-color: #0077b6;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --water-container-bg: #eef5f9; /* æ°´ä½åœ–çš„ç©ºèƒŒæ™¯è‰² */
            --input-bg: #ffffff;
            --border-color: rgba(0,0,0,0.05);
            --shadow-color: rgba(0,0,0,0.05);
            
            /* ç‹€æ…‹è‰² */
            --status-good: #444b33;
            --status-fair: #f1c40f;
            --status-poor: #e74c3c;
            
            /* æ¨™ç±¤åº•è‰² */
            --badge-bg-good: #e8f8f5;
            --badge-text-good: #2ecc71;
            --badge-bg-fair: #fef9e7;
            --badge-text-fair: #f1c40f;
            --badge-bg-poor: #fdedec;
            --badge-text-poor: #e74c3c;
        }

        /* --- ğŸŒ™ æ·±è‰²æ¨¡å¼è¦†å¯« --- */
        [data-theme="dark"] {
            --primary-color: #48cae4; /* æ·±è‰²æ¨¡å¼ä¸‹ä¸»è‰²èª¿äº®ä¸€é» */
            --bg-color: #121212;      /* æ¥µæ·±ç° */
            --card-bg: #1e1e1e;       /* å¡ç‰‡æ·±ç° */
            --text-main: #e0e0e0;     /* äº®ç°ç™½ */
            --text-sub: #a0a0a0;      /* ä¸­ç° */
            --water-container-bg: #2c3e50; /* æ·±è—ç°ä½œç‚ºæ°´çš„ç©ºèƒŒæ™¯ */
            --input-bg: #2d2d2d;
            --border-color: #333333;
            --shadow-color: #000000;

            /* æ·±è‰²æ¨¡å¼ä¸‹çš„ç‹€æ…‹æ¨™ç±¤ (é™ä½äº®åº¦ä»¥å…åˆºçœ¼) */
            --badge-bg-good: rgba(46, 204, 113, 0.2);
            --badge-text-good: #2ecc71;
            --badge-bg-fair: rgba(241, 196, 15, 0.2);
            --badge-text-fair: #f1c40f;
            --badge-bg-poor: rgba(231, 76, 60, 0.2);
            --badge-text-poor: #e74c3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === é ‚éƒ¨æ¨™é¡Œå€ === */
        .header {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
            margin-bottom: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--text-main);
            font-size: 2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .header h1 i { color: var(--primary-color); }
        .header p { color: var(--text-sub); }

        .back-btn {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            text-decoration: none;
            color: var(--text-sub);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .back-btn:hover { color: var(--primary-color); }

        /* === æ·±è‰²æ¨¡å¼åˆ‡æ›æŒ‰éˆ• === */
        .theme-toggle {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .theme-toggle:hover { color: var(--primary-color); }

        /* === æ§åˆ¶å€ === */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }

        .region-filter {
            display: flex;
            background: var(--card-bg);
            padding: 5px;
            border-radius: 30px;
            box-shadow: 0 2px 10px var(--shadow-color);
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        .region-btn {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: var(--text-sub);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }
        .region-btn:hover { color: var(--primary-color); background: var(--bg-color); }
        
        .region-btn.active {
            background: var(--primary-color);
            color: #fff; /* æŒ‰éˆ•æ–‡å­—åœ¨é¸ä¸­æ™‚æ°¸é æ˜¯ç™½è‰² */
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px 12px 40px;
            border: 1px solid var(--border-color);
            border-radius: 30px;
            background: var(--card-bg);
            color: var(--text-main);
            font-size: 0.95rem;
            outline: none;
            box-shadow: 0 2px 10px var(--shadow-color);
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-sub);
        }

        /* === ç‹€æ…‹èªªæ˜å€ === */
        .status-legend {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: var(--text-sub);
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

        /* === å¡ç‰‡ç¶²æ ¼ === */
        .reservoir-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        /* === æ°´åº«å¡ç‰‡ === */
        .reservoir-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
            position: relative;
            transition: transform 0.3s;
        }

        .reservoir-card:hover { transform: translateY(-5px); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .res-name { font-size: 1.25rem; font-weight: 700; color: var(--text-main); }
        .res-location { font-size: 0.8rem; color: var(--text-sub); margin-top: 4px; }

        .status-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* æ°´ä½åœ–è¦–è¦º */
        .water-container {
            height: 140px;
            background: var(--water-container-bg);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.1); 
        }

        .water-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            /* è¢å…‰è—æ¼¸å±¤ï¼Œåœ¨æ·±è‰²æ¨¡å¼ä¸‹æœƒå¾ˆæ¼‚äº® */
            background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%);
            opacity: 0.85;
            transition: height 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* æ³¢æµªå‹•ç•« SVG */
        .water-wave::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 0;
            right: 0;
            height: 10px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%234facfe' fill-opacity='1' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: 200% 100%;
            animation: wave 10s linear infinite;
        }

        @keyframes wave {
            0% { background-position-x: 0; }
            100% { background-position-x: 200%; }
        }

        .percentage-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            z-index: 2;
        }
        .percentage-text span { font-size: 1rem; color: var(--text-sub); margin-left: 2px; text-shadow: none; font-weight: normal; }

        .data-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9rem; }
        .data-item { display: flex; flex-direction: column; gap: 4px; }
        .data-label { color: var(--text-sub); font-size: 0.8rem; }
        .data-val { font-weight: 600; color: var(--text-main); }

        /* === åœ–è¡¨å€ === */
        .charts-section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
            margin-top: 40px;
            border: 1px solid var(--border-color);
        }

        .loading { text-align: center; padding: 60px; color: var(--text-sub); }
        .loading i { font-size: 2rem; margin-bottom: 15px; color: var(--primary-color); animation: spin 1s linear infinite; }

        @media (max-width: 768px) {
            .back-btn { position: static; margin-bottom: 15px; display: inline-flex; }
            .theme-toggle { top: 20px; right: 20px; transform: none; }
            .header { text-align: left; padding: 20px; padding-top: 60px; }
            .header h1 { justify-content: flex-start; }
            .controls { flex-direction: column; align-items: stretch; }
            .search-box { max-width: 100%; }
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> é¦–é </a>
            
            <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ›æ·±è‰²æ¨¡å¼">
                <i class="fas fa-moon"></i>
            </button>

            <h1><i class="fas fa-tint"></i> è‡ºç£æ°´åº«å³æ™‚æˆ°æƒ…å®¤</h1>
            <p>å³æ™‚ç›£æ§å…¨å°æ°´åº«è“„æ°´ç‹€æ…‹èˆ‡ç‡Ÿé‹æ•¸æ“š</p>
        </div>

        <div class="controls">
            <div class="region-filter">
                <button class="region-btn active" onclick="filterByRegion('all')">å…¨éƒ¨</button>
                <button class="region-btn" onclick="filterByRegion('10')">åŒ—éƒ¨</button>
                <button class="region-btn" onclick="filterByRegion('20')">ä¸­éƒ¨</button>
                <button class="region-btn" onclick="filterByRegion('30')">å—éƒ¨</button>
                <button class="region-btn" onclick="filterByRegion('40')">æ±éƒ¨</button>
                <button class="region-btn" onclick="filterByRegion('50')">é›¢å³¶</button>
            </div>
            
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="æœå°‹æ°´åº«åç¨±..." onkeyup="filterReservoirs()">
            </div>
        </div>

        <div class="status-legend">
            <div class="legend-item"><div class="dot" style="background:var(--status-good)"></div>æ­£å¸¸ (>50%)</div>
            <div class="legend-item"><div class="dot" style="background:var(--status-fair)"></div>ç¨ä½ (25-50%)</div>
            <div class="legend-item"><div class="dot" style="background:var(--status-poor)"></div>åƒç·Š (<25%)</div>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-circle-notch"></i>
            <p>æ­£åœ¨åŒæ­¥æ°´åˆ©ç½²è³‡æ–™...</p>
        </div>

        <div id="reservoir-grid" class="reservoir-grid" style="display: none;"></div>

        <div class="charts-section" id="charts-section" style="display: none;">
            <h2 style="margin-bottom: 20px; color: var(--text-main); font-size: 1.2rem; border-left: 4px solid var(--primary-color); padding-left: 10px;">
                é‡é»æ°´åº«è“„æ°´ç‡æ’è¡Œ
            </h2>
            <div style="height: 350px;">
                <canvas id="capacityChart"></canvas>
            </div>
        </div>
        
        <p style="text-align: center; color: var(--text-sub); font-size: 0.8rem; margin-top: 30px;" id="updateTime"></p>
    </div>

    <script>
        const API_URL = 'https://reservoir-api.weacamm.org/';
        let allReservoirs = [];
        let currentRegion = 'all';
        let capacityChart = null;

        const regionMap = {
            '10': 'åŒ—éƒ¨åœ°å€', '20': 'ä¸­éƒ¨åœ°å€', '30': 'å—éƒ¨åœ°å€',
            '40': 'æ±éƒ¨åœ°å€', '50': 'é›¢å³¶åœ°å€'
        };

        // === æ·±è‰²æ¨¡å¼é‚è¼¯ ===
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon(next);
            
            // å¼·åˆ¶æ›´æ–°åœ–è¡¨é¡è‰²
            if(capacityChart) {
                // é‡æ–°æ¸²æŸ“åœ–è¡¨ä»¥é©æ‡‰æ–°æ–‡å­—é¡è‰²
                renderUI(); 
            }
        }

        function updateThemeIcon(theme) {
            const btn = document.querySelector('.theme-toggle i');
            if(theme === 'dark') {
                btn.className = 'fas fa-sun';
            } else {
                btn.className = 'fas fa-moon';
            }
        }

        // å•Ÿå‹•
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadReservoirData();
        });

        async function loadReservoirData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                allReservoirs = data.sort((a, b) => a.reservoiridentifier.localeCompare(b.reservoiridentifier));
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('reservoir-grid').style.display = 'grid';
                document.getElementById('charts-section').style.display = 'block';
                
                renderUI();
                
                if (data.length > 0) {
                    const date = new Date(data[0].datetime);
                    document.getElementById('updateTime').textContent = `æœ€å¾Œæ›´æ–°ï¼š${date.toLocaleString('zh-TW')}`;
                }

            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerHTML = `<span style="color:var(--status-poor)">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†</span>`;
            }
        }

        function renderUI() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = allReservoirs.filter(r => {
                const regionMatch = currentRegion === 'all' || r.reservoiridentifier.startsWith(currentRegion);
                const nameMatch = !searchText || r.reservoirname.toLowerCase().includes(searchText);
                return regionMatch && nameMatch;
            });

            const grid = document.getElementById('reservoir-grid');
            if(filtered.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--text-sub); padding:40px;">æ‰¾ä¸åˆ°ç›¸é—œæ°´åº«</div>`;
            } else {
                grid.innerHTML = filtered.map(createCardHTML).join('');
            }

            updateChart(filtered);
        }

        function createCardHTML(res) {
            const capacity = res.capacity || 0;
            const full = res.effectivecapacity || 1;
            let percentage = (capacity / full * 100).toFixed(1);
            if(percentage > 100) percentage = 100;
            
            // ç‹€æ…‹è®Šæ•¸ä½¿ç”¨ CSS Variable åƒç…§
            let badgeBg = 'var(--badge-bg-good)';
            let badgeColor = 'var(--badge-text-good)';
            let textColorVar = 'var(--status-good)'; 
            let statusText = 'ğŸ’§ æ°´æƒ…æ­£å¸¸';

            if (percentage < 25) {
                badgeBg = 'var(--badge-bg-poor)';
                badgeColor = 'var(--badge-text-poor)';
                textColorVar = 'var(--status-poor)';
                statusText = 'ğŸ”¥ åš´é‡ç¼ºæ°´';
            } else if (percentage < 50) {
                badgeBg = 'var(--badge-bg-fair)';
                badgeColor = 'var(--badge-text-fair)';
                textColorVar = 'var(--status-fair)';
                statusText = 'âš ï¸ éœ€ç¯€ç´„';
            }

            const regionName = regionMap[res.reservoiridentifier.substring(0, 2)] || 'å…¶ä»–';
            const volStr = (capacity / 10000).toFixed(2);
            const inflowStr = (res.inflow / 10000).toFixed(2);
            
            return `
            <div class="reservoir-card">
                <div class="card-header">
                    <div>
                        <div class="res-name">${res.reservoirname}</div>
                        <div class="res-location">${regionName}</div>
                    </div>
                    <div class="status-badge" style="background:${badgeBg}; color:${badgeColor}">
                        ${statusText}
                    </div>
                </div>

                <div class="water-container">
                    <div class="water-wave" style="height: ${percentage}%"></div>
                    <div class="percentage-text" style="color: ${textColorVar}">
                        ${percentage}<span>%</span>
                    </div>
                </div>

                <div class="data-row">
                    <div class="data-item">
                        <span class="data-label">æœ‰æ•ˆè“„æ°´é‡</span>
                        <span class="data-val">${volStr} å„„å™¸</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">æ˜¨æ—¥é€²æ°´é‡</span>
                        <span class="data-val">${inflowStr} å„„å™¸</span>
                    </div>
                </div>
            </div>
            `;
        }

        function updateChart(data) {
            let chartData = [...data].sort((a,b) => b.effectivecapacity - a.effectivecapacity).slice(0, 15);
            
            const ctx = document.getElementById('capacityChart').getContext('2d');
            if(capacityChart) capacityChart.destroy();

            // åˆ¤æ–·ç›®å‰æ˜¯å¦ç‚ºæ·±è‰²æ¨¡å¼ï¼Œèª¿æ•´åœ–è¡¨æ–‡å­—é¡è‰²
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const gridColor = isDark ? '#333' : '#f0f0f0';
            const textColor = isDark ? '#a0a0a0' : '#666';

            capacityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(r => r.reservoirname),
                    datasets: [{
                        label: 'è“„æ°´ç‡ (%)',
                        data: chartData.map(r => {
                            let p = (r.capacity / (r.effectivecapacity||1) * 100);
                            return p > 100 ? 100 : p.toFixed(1);
                        }),
                        backgroundColor: chartData.map(r => {
                            let p = (r.capacity / (r.effectivecapacity||1) * 100);
                            if(p < 25) return '#e74c3c';
                            if(p < 50) return '#f1c40f';
                            return '#2ecc71';
                        }),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100, 
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: textColor }
                        }
                    }
                }
            });
        }

        function filterByRegion(r) {
            currentRegion = r;
            document.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
            // é‡æ–°é«˜äº®æŒ‰éˆ•
            const btns = document.querySelectorAll('.region-btn');
            // æ ¹æ“š onclick å±¬æ€§å…§å®¹åŒ¹é…
            btns.forEach(b => {
                if(b.getAttribute('onclick').includes(`'${r}'`)) b.classList.add('active');
            });
            renderUI();
        }
        
        function filterReservoirs() { renderUI(); }
    </script>
</body>
</html>
