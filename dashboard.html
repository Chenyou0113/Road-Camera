<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>監視器儀表板 - 台灣即時監控系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/responsive-camera.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>window.CURRENT_PAGE = 'dashboard';</script>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #667eea; text-align: center; margin-bottom: 10px; }
        .header-subtitle { text-align: center; color: #666; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .back-btn:hover { background: #5a6fd8; }

        /* 區域標題樣式 */
        .status-section h3,
        .chart-section h3 {
            color: #333;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .status-section h3 i,
        .chart-section h3 i {
            color: #667eea;
            margin-right: 8px;
        }

        /* 儀表板統計面板 */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-trend {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .trend-up { color: #4CAF50; }
        .trend-down { color: #f44336; }
        .trend-stable { color: #FF9800; }

        /* 系統狀態表格 */
        .status-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .status-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .status-table th,
        .status-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .status-table th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #4CAF50; }
        .status-offline { background: #f44336; }
        .status-warning { background: #FF9800; }

        /* 圖表區域 */
        .chart-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        /* 圖表控制按鈕 */
        .chart-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            color: #666;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .chart-btn:hover {
            background: #e0e0e0;
            border-color: #ccc;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .chart-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .chart-btn.active:hover {
            background: #5a6fd8;
            transform: scale(1.05) translateY(-1px);
        }

        /* 按鈕點擊波紋效果 */
        .chart-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
            pointer-events: none;
        }

        .chart-btn:active::after {
            width: 120px;
            height: 120px;
        }

        /* 圖表容器縮放動畫 */
        .chart-container {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }

        .chart-container.scaling {
            transform: scale(0.95);
            opacity: 0.7;
        }

        .chart-container.zoom-in {
            animation: chartZoomIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes chartZoomIn {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* 圖表加載動畫 */
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: #667eea;
            font-weight: 500;
            z-index: 10;
        }

        .chart-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(102, 126, 234, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 即時更新指示器 */
        .update-indicator {
            position: fixed;
            top: 20px;
            right: 80px; /* 向左移動，避免與深色切換按鈕重疊 */
            background: white;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 999; /* 降低層級，避免遮擋深色切換按鈕 */
            color: #333;
            font-weight: 500;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        /* 響應式設計 - 小螢幕調整 */
        @media (max-width: 768px) {
            .update-indicator {
                position: static;
                margin: 10px auto;
                width: fit-content;
                order: -1; /* 讓更新指示器顯示在頂部 */
            }
            
            .container {
                position: relative;
            }
        }

        @media (max-width: 480px) {
            .update-indicator {
                font-size: 0.8rem;
                padding: 8px 12px;
                right: 60px; /* 在小螢幕上進一步向左移動 */
            }
        }

        /* 載入動畫 */
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2rem;
        }

        .loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .dashboard-stats { grid-template-columns: repeat(2, 1fr); }
            .stat-card { padding: 15px; }
            .stat-number { font-size: 1.5rem; }
            .status-table { font-size: 0.9rem; }
        }

        @media (max-width: 480px) {
            .dashboard-stats { grid-template-columns: 1fr; }
        }

        /* 深色模式 */
        body.dark-mode .header-subtitle {
            color: rgba(255,255,255,0.7) !important;
        }
        
        body.dark-mode .stat-card,
        body.dark-mode .status-section,
        body.dark-mode .chart-section {
            background: rgba(40,40,50,0.95);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* 深色模式下的標題樣式 */
        body.dark-mode .status-section h3,
        body.dark-mode .chart-section h3 {
            color: #e0e0e0 !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(102, 126, 234, 0.3);
            border-bottom: 2px solid rgba(102, 126, 234, 0.5);
            padding-bottom: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        body.dark-mode .status-section h3 i,
        body.dark-mode .chart-section h3 i {
            color: #667eea;
            margin-right: 8px;
            text-shadow: 0 0 8px rgba(102, 126, 234, 0.5);
        }

        body.dark-mode .stat-number { color: #e0e0e0; }
        body.dark-mode .stat-label { color: rgba(255,255,255,0.7); }
        body.dark-mode .status-table th { background: rgba(255,255,255,0.05); color: #e0e0e0; }
        body.dark-mode .status-table td { color: rgba(255,255,255,0.8); border-bottom-color: rgba(255,255,255,0.1); }
        body.dark-mode .chart-container { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7); }
        body.dark-mode .update-indicator { 
            background: rgba(40,40,50,0.98); 
            border: 2px solid rgba(76, 175, 80, 0.5); 
            color: rgba(255,255,255,0.95);
            text-shadow: 0 2px 4px rgba(0,0,0,0.8), 0 0 8px rgba(76, 175, 80, 0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 1px rgba(76, 175, 80, 0.2);
        }
        
        body.dark-mode .update-indicator span {
            font-weight: 600;
            color: rgba(255,255,255,0.95);
            text-shadow: 0 1px 3px rgba(0,0,0,0.9);
        }
        
        /* 暗色模式圖表按鈕 */
        body.dark-mode .chart-btn {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.8);
        }
        
        body.dark-mode .chart-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        body.dark-mode .chart-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        body.dark-mode .chart-btn.active:hover {
            background: #5a6fd8;
            transform: scale(1.05) translateY(-1px);
        }
        
        /* 深色模式下的加載指示器 */
        body.dark-mode .chart-loading {
            color: #667eea;
            background: rgba(40, 40, 50, 0.8);
            backdrop-filter: blur(5px);
            padding: 20px;
            border-radius: 10px;
        }
        
        body.dark-mode .chart-loading .spinner {
            border-color: rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
        }
        
        /* 深色模式下圖表標籤樣式 */
        body.dark-mode label {
            color: rgba(255,255,255,0.9) !important;
            background: rgba(40,40,50,0.9) !important;
        }
        
        body.dark-mode div[style*="background: rgba(255,255,255,0.9)"] {
            background: rgba(40,40,50,0.9) !important;
            color: rgba(255,255,255,0.9) !important;
        }
    </style>
    
    <!-- 載入進度條 -->
    <script src="assets/loading-progress.js"></script>
    <script>
        // 儀表板載入設定
        window.AUTO_START_LOADING = true;
        
        // 自訂載入進度追蹤
        let dashboardLoadingSteps = 0;
        const totalSteps = 5; // TDX API, 國道數據, 省道數據, 其他數據, 圖表初始化
        
        function updateDashboardProgress(step, label) {
            dashboardLoadingSteps = Math.min(step, totalSteps);
            const progress = (dashboardLoadingSteps / totalSteps) * 90; // 保留10%給最終完成
            window.setLoadingProgress(progress);
            if (label) window.updateLoadingLabel(label);
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            window.startLoading({
                labelText: '初始化儀表板...',
                color: '#667eea',
                showLabel: true
            });
            updateDashboardProgress(1, '檢查API狀態...');
        });
    </script>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-tachometer-alt"></i> 監視器儀表板</h1>
            <p class="header-subtitle">即時監控系統狀態與統計分析</p>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回首頁</a>
            <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode" style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; cursor: pointer; margin-left: 15px; font-size: 1.2rem;">
                <i class="fas fa-moon"></i>
            </button>

        <!-- 即時更新指示器 -->
        <div class="update-indicator">
            <div class="pulse"></div>
            <span>即時更新中</span>
        </div>

        <!-- 統計面板 -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-video"></i></div>
                <div class="stat-number" id="totalCameras">載入中...</div>
                <div class="stat-label">監視器總數</div>
                <div class="stat-trend trend-up" id="totalTrend"><i class="fas fa-arrow-up"></i> +0</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-number" id="onlineCameras">載入中...</div>
                <div class="stat-label">線上監視器</div>
                <div class="stat-trend trend-up" id="onlineTrend"><i class="fas fa-arrow-up"></i> 95.2%</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-number" id="offlineCameras">載入中...</div>
                <div class="stat-label">離線監視器</div>
                <div class="stat-trend trend-down" id="offlineTrend"><i class="fas fa-arrow-down"></i> 4.8%</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-number" id="lastUpdate">載入中...</div>
                <div class="stat-label">最後更新</div>
                <div class="stat-trend trend-stable" id="updateTrend"><i class="fas fa-sync-alt"></i> 自動</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-road"></i></div>
                <div class="stat-number" id="highwayCameras">載入中...</div>
                <div class="stat-label">國道監視器</div>
                <div class="stat-trend trend-stable" id="highwayTrend"><i class="fas fa-minus"></i> 穩定</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-traffic-light"></i></div>
                <div class="stat-number" id="roadCameras">載入中...</div>
                <div class="stat-label">省道監視器</div>
                <div class="stat-trend trend-stable" id="roadTrend"><i class="fas fa-minus"></i> 穩定</div>
            </div>
        </div>

        <!-- 系統狀態表格 -->
        <div class="status-section">
            <h3><i class="fas fa-list"></i> 系統狀態概覽</h3>
            <table class="status-table">
                <thead>
                    <tr>
                        <th>系統名稱</th>
                        <th>狀態</th>
                        <th>監視器數量</th>
                        <th>可用率</th>
                        <th>最後檢查</th>
                    </tr>
                </thead>
                <tbody id="systemStatusTable">
                    <tr>
                        <td><i class="fas fa-road"></i> 國道監視器</td>
                        <td><span class="status-indicator status-online"></span>線上</td>
                        <td id="highwayCount">載入中...</td>
                        <td><span class="trend-up">98.5%</span></td>
                        <td id="highwayLastCheck">載入中...</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-traffic-light"></i> 省道監視器</td>
                        <td><span class="status-indicator status-online"></span>線上</td>
                        <td id="roadCount">載入中...</td>
                        <td><span class="trend-up">96.2%</span></td>
                        <td id="roadLastCheck">載入中...</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-tachometer-alt"></i> 快速道路監視器</td>
                        <td><span class="status-indicator status-online"></span>線上</td>
                        <td id="expresswayCount">載入中...</td>
                        <td><span class="trend-up">94.7%</span></td>
                        <td id="expresswayLastCheck">載入中...</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-droplet"></i> 水資源監控</td>
                        <td><span class="status-indicator status-warning"></span>部分</td>
                        <td id="waterCount">載入中...</td>
                        <td><span class="trend-stable">89.3%</span></td>
                        <td id="waterLastCheck">載入中...</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-mountain"></i> 土石流監測</td>
                        <td><span class="status-indicator status-online"></span>線上</td>
                        <td id="debrisCount">載入中...</td>
                        <td><span class="trend-up">92.1%</span></td>
                        <td id="debrisLastCheck">載入中...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 圖表區域 -->
        <div class="chart-section">
            <h3><i class="fas fa-chart-line"></i> 監視器狀態趨勢</h3>
            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px;">
                        <button id="chart-1h" class="chart-btn" onclick="switchChartPeriod('1h')">1小時</button>
                        <button id="chart-3h" class="chart-btn" onclick="switchChartPeriod('3h')">3小時</button>
                        <button id="chart-6h" class="chart-btn" onclick="switchChartPeriod('6h')">6小時</button>
                        <button id="chart-12h" class="chart-btn" onclick="switchChartPeriod('12h')">12小時</button>
                        <button id="chart-24h" class="chart-btn active" onclick="switchChartPeriod('24h')">24小時</button>
                        <button id="chart-7d" class="chart-btn" onclick="switchChartPeriod('7d')">7天</button>
                        <button id="chart-30d" class="chart-btn" onclick="switchChartPeriod('30d')">30天</button>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: #333; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                            <input type="checkbox" id="autoRefresh" checked> 自動更新
                        </label>
                        <button onclick="refreshChart()" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-sync-alt"></i> 更新
                        </button>
                    </div>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="availabilityChart"></canvas>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
                    <div style="color: #333; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                        <span id="chartLastUpdate">最後更新: --</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                        <span style="color: #4CAF50;">●</span> 國道監視器
                        <span style="color: #FF9800; margin-left: 15px;">●</span> 省道監視器
                        <span style="color: #2196F3; margin-left: 15px;">●</span> 快速道路
                        <span style="color: #9C27B0; margin-left: 15px;">●</span> 縣市監視器
                    </div>
                </div>
            </div>
        </div>

        <!-- API 狀態監控圖表 -->
        <div class="chart-section">
            <h3><i class="fas fa-server"></i> API 服務運行狀態</h3>
            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="api-chart-1h" class="chart-btn" onclick="switchApiChartPeriod('1h')">1小時</button>
                        <button id="api-chart-3h" class="chart-btn" onclick="switchApiChartPeriod('3h')">3小時</button>
                        <button id="api-chart-6h" class="chart-btn" onclick="switchApiChartPeriod('6h')">6小時</button>
                        <button id="api-chart-12h" class="chart-btn" onclick="switchApiChartPeriod('12h')">12小時</button>
                        <button id="api-chart-24h" class="chart-btn active" onclick="switchApiChartPeriod('24h')">24小時</button>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: #333; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                            <input type="checkbox" id="apiAutoRefresh" checked> API自動檢測
                        </label>
                        <button onclick="refreshApiChart()" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-sync-alt"></i> 檢測
                        </button>
                    </div>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="apiStatusChart"></canvas>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
                    <div style="color: #333; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                        <span id="apiChartLastUpdate">最後檢測: --</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                        <span style="color: #4CAF50;">●</span> TDX API
                        <span style="color: #FF5722; margin-left: 15px;">●</span> 水利署 API
                        <span style="color: #2196F3; margin-left: 15px;">●</span> 環保署 API
                        <span style="color: #FF9800; margin-left: 15px;">●</span> 農委會 API
                        <span style="color: #9C27B0; margin-left: 15px;">●</span> 國科會 API
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        let allSystemsData = {
            highway: { total: 0, online: 0, lastUpdate: null },
            road: { total: 0, online: 0, lastUpdate: null },
            expressway: { total: 0, online: 0, lastUpdate: null },
            water: { total: 0, online: 0, lastUpdate: null },
            debris: { total: 0, online: 0, lastUpdate: null }
        };

        // 數字動畫效果
        function animateNumber(elementId, targetValue, duration = 1000) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const startValue = parseInt(element.textContent) || 0;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // 使用緩動函數
                const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                const currentValue = Math.round(startValue + (targetValue - startValue) * easeOutCubic);
                
                element.textContent = currentValue;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        // 更新時間顯示
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW');
            document.getElementById('lastUpdate').textContent = timeString;
        }

        // 載入國道監視器數據
        async function loadHighwayData() {
            try {
                console.log('載入國道監視器數據...');
                
                // 顯示載入中狀態
                document.getElementById('highwayCameras').textContent = '載入中...';
                document.getElementById('highwayCount').textContent = '載入中...';
                document.getElementById('highwayLastCheck').textContent = '檢查中...';
                
                // 檢查 tdxApi 是否可用
                if (typeof tdxApi === 'undefined' || !tdxApi) {
                    throw new Error('TDX API 尚未初始化');
                }
                
                // 使用 TDX API 載入國道監視器，增加重試機制
                const endpoint = '/v2/Road/Traffic/CCTV/Freeway?$format=JSON';
                let response = null;
                let retries = 0;
                const maxRetries = 3;
                
                while (retries < maxRetries && !response) {
                    try {
                        response = await tdxApi.fetchCCTV(endpoint);
                        break;
                    } catch (fetchError) {
                        retries++;
                        console.warn(`國道數據載入重試 ${retries}/${maxRetries}:`, fetchError);
                        if (retries < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * retries)); // 遞增延遲
                        }
                    }
                }
                
                if (response && Array.isArray(response) && response.length > 0) {
                    allSystemsData.highway.total = response.length;
                    allSystemsData.highway.online = response.filter(c => c.VideoImageURL || c.PictureURL).length;
                    allSystemsData.highway.lastUpdate = new Date();
                    
                    // 添加動畫效果
                    animateNumber('highwayCameras', allSystemsData.highway.total);
                    animateNumber('highwayCount', allSystemsData.highway.total);
                    document.getElementById('highwayLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
                    
                    console.log(`✅ 國道監視器載入成功: ${allSystemsData.highway.total} 個`);
                } else if (response && Array.isArray(response) && response.length === 0) {
                    // API 成功但無數據
                    allSystemsData.highway.total = 0;
                    allSystemsData.highway.online = 0;
                    document.getElementById('highwayCameras').textContent = '0';
                    document.getElementById('highwayCount').textContent = '0';
                    document.getElementById('highwayLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
                    console.log('⚠️ 國道監視器：API 回應成功但無資料');
                } else {
                    throw new Error('無效的回應格式');
                }
            } catch (error) {
                console.error('載入國道數據錯誤:', error);
                // 使用模擬數據作為備用
                const fallbackTotal = 1250;
                allSystemsData.highway.total = fallbackTotal;
                allSystemsData.highway.online = Math.floor(fallbackTotal * 0.985); // 98.5% 可用率
                
                animateNumber('highwayCameras', fallbackTotal);
                animateNumber('highwayCount', fallbackTotal);
                document.getElementById('highwayLastCheck').textContent = `${new Date().toLocaleTimeString('zh-TW')} (備用數據)`;
                
                console.log(`🔄 使用備用數據: ${fallbackTotal} 個國道監視器`);
            }
        }

        // 載入省道監視器數據
        async function loadRoadData() {
            try {
                console.log('載入省道監視器數據...');
                
                // 顯示載入中狀態
                document.getElementById('roadCameras').textContent = '載入中...';
                document.getElementById('roadCount').textContent = '載入中...';
                document.getElementById('roadLastCheck').textContent = '檢查中...';
                
                // 檢查 tdxApi 是否可用
                if (typeof tdxApi === 'undefined' || !tdxApi) {
                    throw new Error('TDX API 尚未初始化');
                }
                
                // 使用 TDX API 載入省道監視器，增加重試機制
                const endpoint = '/v2/Road/Traffic/CCTV/Road?$format=JSON';
                let response = null;
                let retries = 0;
                const maxRetries = 3;
                
                while (retries < maxRetries && !response) {
                    try {
                        response = await tdxApi.fetchCCTV(endpoint);
                        break;
                    } catch (fetchError) {
                        retries++;
                        console.warn(`省道數據載入重試 ${retries}/${maxRetries}:`, fetchError);
                        if (retries < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * retries)); // 遞增延遲
                        }
                    }
                }
                
                if (response && Array.isArray(response) && response.length > 0) {
                    allSystemsData.road.total = response.length;
                    allSystemsData.road.online = response.filter(c => c.VideoImageURL || c.PictureURL).length;
                    allSystemsData.road.lastUpdate = new Date();
                    
                    // 添加動畫效果
                    animateNumber('roadCameras', allSystemsData.road.total);
                    animateNumber('roadCount', allSystemsData.road.total);
                    document.getElementById('roadLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
                    
                    console.log(`✅ 省道監視器載入成功: ${allSystemsData.road.total} 個`);
                } else if (response && Array.isArray(response) && response.length === 0) {
                    // API 成功但無數據
                    allSystemsData.road.total = 0;
                    allSystemsData.road.online = 0;
                    document.getElementById('roadCameras').textContent = '0';
                    document.getElementById('roadCount').textContent = '0';
                    document.getElementById('roadLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
                    console.log('⚠️ 省道監視器：API 回應成功但無資料');
                } else {
                    throw new Error('無效的回應格式');
                }
            } catch (error) {
                console.error('載入省道數據錯誤:', error);
                // 使用模擬數據作為備用
                const fallbackTotal = 2180;
                allSystemsData.road.total = fallbackTotal;
                allSystemsData.road.online = Math.floor(fallbackTotal * 0.962); // 96.2% 可用率
                
                animateNumber('roadCameras', fallbackTotal);
                animateNumber('roadCount', fallbackTotal);
                document.getElementById('roadLastCheck').textContent = `${new Date().toLocaleTimeString('zh-TW')} (備用數據)`;
                
                console.log(`🔄 使用備用數據: ${fallbackTotal} 個省道監視器`);
            }
        }

        // 模擬其他系統數據（因為API可能不同）
        function loadOtherSystemsData() {
            // 快速道路
            allSystemsData.expressway = { total: 156, online: 148, lastUpdate: new Date() };
            
            // 水資源
            allSystemsData.water = { total: 200, online: 178, lastUpdate: new Date() };
            
            // 土石流
            allSystemsData.debris = { total: 89, online: 82, lastUpdate: new Date() };
            
            // 更新顯示（使用動畫效果）
            animateNumber('expresswayCount', allSystemsData.expressway.total);
            document.getElementById('expresswayLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
            
            animateNumber('waterCount', allSystemsData.water.total);
            document.getElementById('waterLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
            
            animateNumber('debrisCount', allSystemsData.debris.total);
            document.getElementById('debrisLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
            
            console.log('✅ 其他系統數據載入完成');
        }

        // 更新總體統計
        function updateOverallStats() {
            const totalCameras = Object.values(allSystemsData).reduce((sum, system) => sum + system.total, 0);
            const totalOnline = Object.values(allSystemsData).reduce((sum, system) => sum + system.online, 0);
            const totalOffline = totalCameras - totalOnline;
            
            // 使用動畫效果更新數字
            animateNumber('totalCameras', totalCameras, 1500);
            animateNumber('onlineCameras', totalOnline, 1500);
            animateNumber('offlineCameras', totalOffline, 1500);
            
            // 更新可用率
            const onlineRate = totalCameras > 0 ? ((totalOnline / totalCameras) * 100).toFixed(1) : 0;
            document.getElementById('onlineTrend').innerHTML = `<i class="fas fa-arrow-up"></i> ${onlineRate}%`;
            
            const offlineRate = totalCameras > 0 ? ((totalOffline / totalCameras) * 100).toFixed(1) : 0;
            document.getElementById('offlineTrend').innerHTML = `<i class="fas fa-arrow-down"></i> ${offlineRate}%`;
            
            console.log(`📊 總體統計更新: 總數 ${totalCameras}, 線上 ${totalOnline}, 離線 ${totalOffline}`);
        }

        // 等待 TDX API 初始化
        async function waitForTdxApi() {
            let attempts = 0;
            const maxAttempts = 30; // 最多等待30秒
            
            while (attempts < maxAttempts) {
                if (typeof tdxApi !== 'undefined' && tdxApi && typeof tdxApi.fetchCCTV === 'function') {
                    console.log('TDX API 已就緒');
                    return true;
                }
                console.log(`等待 TDX API 初始化... (${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
                attempts++;
            }
            
            console.error('TDX API 初始化超時');
            return false;
        }

        // 載入所有數據
        async function loadAllData() {
            console.log('🚀 開始載入儀表板數據...');
            
            try {
                // 等待 TDX API 初始化
                updateDashboardProgress(2, '初始化API連線...');
                const apiReady = await waitForTdxApi();
                
                if (!apiReady) {
                    console.warn('⚠️ TDX API 未就緒，使用備用數據');
                    updateDashboardProgress(3, '載入備用數據...');
                    loadFallbackData();
                } else {
                    // 並行載入所有數據
                    updateDashboardProgress(3, '載入交通監視器數據...');
                    await Promise.all([
                        loadHighwayData(),
                        loadRoadData()
                    ]);
                }
                
                updateDashboardProgress(4, '載入其他系統數據...');
                loadOtherSystemsData();
                updateOverallStats();
                updateLastUpdateTime();
                
                updateDashboardProgress(5, '初始化圖表...');
                console.log('✅ 儀表板數據載入完成');
                
                // 完成載入
                setTimeout(() => {
                    window.finishLoading();
                }, 500);
                
            } catch (error) {
                console.error('❌ 儀表板數據載入失敗:', error);
                updateDashboardProgress(3, '載入備用數據...');
                loadFallbackData();
                setTimeout(() => {
                    window.finishLoading();
                }, 500);
            }
        }

        // 載入備用數據
        function loadFallbackData() {
            console.log('🔄 載入備用數據...');
            
            // 國道備用數據
            allSystemsData.highway.total = 1250;
            allSystemsData.highway.online = Math.floor(1250 * 0.985);
            animateNumber('highwayCameras', allSystemsData.highway.total);
            animateNumber('highwayCount', allSystemsData.highway.total);
            document.getElementById('highwayLastCheck').textContent = `${new Date().toLocaleTimeString('zh-TW')} (備用)`;
            
            // 省道備用數據
            allSystemsData.road.total = 2180;
            allSystemsData.road.online = Math.floor(2180 * 0.962);
            animateNumber('roadCameras', allSystemsData.road.total);
            animateNumber('roadCount', allSystemsData.road.total);
            document.getElementById('roadLastCheck').textContent = `${new Date().toLocaleTimeString('zh-TW')} (備用)`;
            
            console.log('✅ 備用數據載入完成');
        }

        // 圖表相關變數
        let availabilityChart = null;
        let apiStatusChart = null;
        let currentChartPeriod = '24h';
        let currentApiChartPeriod = '24h';
        let chartData = {
            labels: [],
            datasets: [
                {
                    label: '國道監視器',
                    data: [],
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '省道監視器',
                    data: [],
                    borderColor: '#FF9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '快速道路',
                    data: [],
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '縣市監視器',
                    data: [],
                    borderColor: '#9C27B0',
                    backgroundColor: 'rgba(156, 39, 176, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        };

        // API狀態圖表數據
        let apiChartData = {
            labels: [],
            datasets: [
                {
                    label: 'TDX API',
                    data: [],
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '水利署 API',
                    data: [],
                    borderColor: '#FF5722',
                    backgroundColor: 'rgba(255, 87, 34, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '環保署 API',
                    data: [],
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '農委會 API',
                    data: [],
                    borderColor: '#FF9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '國科會 API',
                    data: [],
                    borderColor: '#9C27B0',
                    backgroundColor: 'rgba(156, 39, 176, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        };

        // 初始化圖表
        function initChart() {
            const ctx = document.getElementById('availabilityChart').getContext('2d');
            
            availabilityChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '24小時監視器可用率趨勢',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '時間'
                            },
                            grid: {
                                color: 'rgba(200, 200, 200, 0.3)'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: '可用率 (%)'
                            },
                            min: 0,
                            max: 100,
                            grid: {
                                color: 'rgba(200, 200, 200, 0.3)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            // 生成初始數據
            generateChartData(currentChartPeriod);
        }

        // 初始化API狀態圖表
        function initApiChart() {
            const ctx = document.getElementById('apiStatusChart').getContext('2d');
            
            apiStatusChart = new Chart(ctx, {
                type: 'line',
                data: apiChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '24小時 API 服務可用率',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '時間'
                            },
                            grid: {
                                color: 'rgba(200, 200, 200, 0.3)'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'API 可用率 (%)'
                            },
                            min: 0,
                            max: 100,
                            grid: {
                                color: 'rgba(200, 200, 200, 0.3)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            // 生成初始API數據
            generateApiChartData(currentApiChartPeriod);
        }

        // 生成圖表數據
        function generateChartData(period) {
            const now = new Date();
            let labels = [];
            let dataPoints = 4; // 4個系統的數據
            
            // 根據時間週期生成標籤
            if (period === '1h') {
                // 1小時，每5分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 5 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '3h') {
                // 3小時，每15分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 15 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '6h') {
                // 6小時，每30分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 30 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '12h') {
                // 12小時，每小時一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 60 * 60 * 1000);
                    labels.push(time.getHours() + ':00');
                }
            } else if (period === '24h') {
                // 24小時，每2小時一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 2 * 60 * 60 * 1000);
                    labels.push(time.getHours() + ':00');
                }
            } else if (period === '7d') {
                // 7天，每天一個點
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(now - i * 24 * 60 * 60 * 1000);
                    labels.push((date.getMonth() + 1) + '/' + date.getDate());
                }
            } else if (period === '30d') {
                // 30天，每天一個點
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(now - i * 24 * 60 * 60 * 1000);
                    labels.push((date.getMonth() + 1) + '/' + date.getDate());
                }
            }

            // 為每個系統生成模擬數據
            chartData.labels = labels;
            
            // 國道監視器數據（高可用率）
            chartData.datasets[0].data = labels.map((_, index) => {
                const base = 95 + Math.random() * 4; // 95-99%
                const trend = Math.sin(index * 0.3) * 2; // 輕微波動
                return Math.min(100, Math.max(90, base + trend));
            });

            // 省道監視器數據
            chartData.datasets[1].data = labels.map((_, index) => {
                const base = 88 + Math.random() * 8; // 88-96%
                const trend = Math.sin(index * 0.4) * 3;
                return Math.min(100, Math.max(80, base + trend));
            });

            // 快速道路數據
            chartData.datasets[2].data = labels.map((_, index) => {
                const base = 91 + Math.random() * 6; // 91-97%
                const trend = Math.sin(index * 0.2) * 2;
                return Math.min(100, Math.max(85, base + trend));
            });

            // 縣市監視器數據（稍低可用率）
            chartData.datasets[3].data = labels.map((_, index) => {
                const base = 82 + Math.random() * 12; // 82-94%
                const trend = Math.sin(index * 0.5) * 4;
                return Math.min(100, Math.max(75, base + trend));
            });

            // 更新圖表
            if (availabilityChart) {
                availabilityChart.update();
            }

            // 更新最後更新時間
            updateChartLastUpdate();
        }

        // 切換圖表時間週期
        function switchChartPeriod(period) {
            currentChartPeriod = period;
            
            // 獲取圖表容器
            const chartContainer = document.querySelector('.chart-section');
            const canvas = document.getElementById('availabilityChart');
            
            // 添加縮放動畫
            chartContainer.classList.add('scaling');
            
            // 顯示加載指示器
            showChartLoading();
            
            // 更新按鈕狀態（帶動畫效果）
            document.querySelectorAll('[id^="chart-"]').forEach(btn => {
                btn.classList.remove('active');
                btn.style.transform = 'scale(1)';
            });
            
            const activeBtn = document.getElementById(`chart-${period}`);
            activeBtn.classList.add('active');
            
            // 按鈕動畫
            activeBtn.style.transform = 'scale(0.95)';
            setTimeout(() => {
                activeBtn.style.transform = 'scale(1.05)';
            }, 100);
            
            // 更新圖表標題
            let title = '';
            if (period === '1h') title = '1小時監視器可用率趨勢';
            else if (period === '3h') title = '3小時監視器可用率趨勢';
            else if (period === '6h') title = '6小時監視器可用率趨勢';
            else if (period === '12h') title = '12小時監視器可用率趨勢';
            else if (period === '24h') title = '24小時監視器可用率趨勢';
            else if (period === '7d') title = '7天監視器可用率趨勢';
            else if (period === '30d') title = '30天監視器可用率趨勢';
            
            // 延遲更新圖表以配合動畫
            setTimeout(() => {
                if (availabilityChart) {
                    availabilityChart.options.plugins.title.text = title;
                    generateChartData(period);
                }
                
                // 動畫完成後移除縮放效果
                setTimeout(() => {
                    chartContainer.classList.remove('scaling');
                    chartContainer.classList.add('zoom-in');
                    hideChartLoading();
                    
                    // 清理動畫類
                    setTimeout(() => {
                        chartContainer.classList.remove('zoom-in');
                    }, 600);
                }, 300);
            }, 200);
        }
        
        // 顯示圖表加載指示器
        function showChartLoading() {
            const chartContainer = document.querySelector('.chart-section');
            const existing = chartContainer.querySelector('.chart-loading');
            if (!existing) {
                const loading = document.createElement('div');
                loading.className = 'chart-loading';
                loading.innerHTML = `
                    <div class="spinner"></div>
                    <div>載入${currentChartPeriod}數據中...</div>
                `;
                chartContainer.style.position = 'relative';
                chartContainer.appendChild(loading);
            }
        }
        
        // 隱藏圖表加載指示器
        function hideChartLoading() {
            const loading = document.querySelector('.chart-loading');
            if (loading) {
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.remove();
                }, 300);
            }
        }

        // 刷新圖表
        function refreshChart() {
            generateChartData(currentChartPeriod);
            
            // 顯示刷新動畫
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            icon.style.animation = 'spin 1s linear';
            setTimeout(() => {
                icon.style.animation = '';
            }, 1000);
        }

        // 生成API圖表數據
        function generateApiChartData(period) {
            const now = new Date();
            let labels = [];
            
            // 根據時間週期生成標籤
            if (period === '1h') {
                // 1小時，每5分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 5 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '3h') {
                // 3小時，每15分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 15 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '6h') {
                // 6小時，每30分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 30 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '12h') {
                // 12小時，每小時一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 60 * 60 * 1000);
                    labels.push(time.getHours() + ':00');
                }
            } else if (period === '24h') {
                // 24小時，每2小時一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 2 * 60 * 60 * 1000);
                    labels.push(time.getHours() + ':00');
                }
            }

            // 更新標籤
            apiChartData.labels = labels;
            
            // TDX API數據（高可用率）
            apiChartData.datasets[0].data = labels.map((_, index) => {
                const base = 96 + Math.random() * 3; // 96-99%
                const trend = Math.sin(index * 0.2) * 1;
                return Math.min(100, Math.max(90, base + trend));
            });

            // 水利署 API數據（中等可用率）
            apiChartData.datasets[1].data = labels.map((_, index) => {
                const base = 85 + Math.random() * 10; // 85-95%
                const trend = Math.sin(index * 0.3) * 3;
                return Math.min(100, Math.max(70, base + trend));
            });

            // 環保署 API數據
            apiChartData.datasets[2].data = labels.map((_, index) => {
                const base = 90 + Math.random() * 8; // 90-98%
                const trend = Math.sin(index * 0.25) * 2;
                return Math.min(100, Math.max(80, base + trend));
            });

            // 農委會 API數據
            apiChartData.datasets[3].data = labels.map((_, index) => {
                const base = 88 + Math.random() * 7; // 88-95%
                const trend = Math.sin(index * 0.4) * 4;
                return Math.min(100, Math.max(75, base + trend));
            });

            // 國科會 API數據
            apiChartData.datasets[4].data = labels.map((_, index) => {
                const base = 93 + Math.random() * 5; // 93-98%
                const trend = Math.sin(index * 0.35) * 2;
                return Math.min(100, Math.max(85, base + trend));
            });

            // 更新圖表
            if (apiStatusChart) {
                apiStatusChart.update();
            }

            // 更新最後檢測時間
            updateApiChartLastUpdate();
        }

        // 切換API圖表時間週期
        function switchApiChartPeriod(period) {
            currentApiChartPeriod = period;
            
            // 獲取API圖表容器
            const apiChartContainers = document.querySelectorAll('.chart-section');
            const apiChartContainer = apiChartContainers[1]; // 第二個圖表容器
            
            // 添加縮放動畫
            apiChartContainer.classList.add('scaling');
            
            // 顯示API圖表加載指示器
            showApiChartLoading();
            
            // 更新按鈕狀態（帶動畫效果）
            document.querySelectorAll('[id^="api-chart-"]').forEach(btn => {
                btn.classList.remove('active');
                btn.style.transform = 'scale(1)';
            });
            
            const activeBtn = document.getElementById(`api-chart-${period}`);
            activeBtn.classList.add('active');
            
            // 按鈕動畫
            activeBtn.style.transform = 'scale(0.95)';
            setTimeout(() => {
                activeBtn.style.transform = 'scale(1.05)';
            }, 100);
            
            // 更新圖表標題
            let title = '';
            if (period === '1h') title = '1小時 API 服務可用率';
            else if (period === '3h') title = '3小時 API 服務可用率';
            else if (period === '6h') title = '6小時 API 服務可用率';
            else if (period === '12h') title = '12小時 API 服務可用率';
            else if (period === '24h') title = '24小時 API 服務可用率';
            
            // 延遲更新圖表以配合動畫
            setTimeout(() => {
                if (apiStatusChart) {
                    apiStatusChart.options.plugins.title.text = title;
                    generateApiChartData(period);
                }
                
                // 動畫完成後移除縮放效果
                setTimeout(() => {
                    apiChartContainer.classList.remove('scaling');
                    apiChartContainer.classList.add('zoom-in');
                    hideApiChartLoading();
                    
                    // 清理動畫類
                    setTimeout(() => {
                        apiChartContainer.classList.remove('zoom-in');
                    }, 600);
                }, 300);
            }, 200);
        }
        
        // 顯示API圖表加載指示器
        function showApiChartLoading() {
            const apiChartContainers = document.querySelectorAll('.chart-section');
            const apiChartContainer = apiChartContainers[1];
            const existing = apiChartContainer.querySelector('.chart-loading');
            if (!existing) {
                const loading = document.createElement('div');
                loading.className = 'chart-loading';
                loading.innerHTML = `
                    <div class="spinner"></div>
                    <div>載入API ${currentApiChartPeriod}數據中...</div>
                `;
                apiChartContainer.style.position = 'relative';
                apiChartContainer.appendChild(loading);
            }
        }
        
        // 隱藏API圖表加載指示器
        function hideApiChartLoading() {
            const apiChartContainers = document.querySelectorAll('.chart-section');
            const apiChartContainer = apiChartContainers[1];
            const loading = apiChartContainer.querySelector('.chart-loading');
            if (loading) {
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.remove();
                }, 300);
            }
        }

        // 刷新API圖表
        function refreshApiChart() {
            generateApiChartData(currentApiChartPeriod);
            
            // 顯示刷新動畫
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            icon.style.animation = 'spin 1s linear';
            setTimeout(() => {
                icon.style.animation = '';
            }, 1000);
        }

        // 更新API圖表最後檢測時間
        function updateApiChartLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW');
            const element = document.getElementById('apiChartLastUpdate');
            if (element) {
                element.textContent = `最後檢測: ${timeString}`;
            }
        }

        // 自動更新API圖表（如果啟用）
        function autoUpdateApiChart() {
            const autoRefresh = document.getElementById('apiAutoRefresh');
            if (autoRefresh && autoRefresh.checked) {
                generateApiChartData(currentApiChartPeriod);
            }
        }

        // 更新圖表最後更新時間
        function updateChartLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW');
            const element = document.getElementById('chartLastUpdate');
            if (element) {
                element.textContent = `最後更新: ${timeString}`;
            }
        }

        // 自動更新圖表（如果啟用）
        function autoUpdateChart() {
            const autoRefresh = document.getElementById('autoRefresh');
            if (autoRefresh && autoRefresh.checked) {
                generateChartData(currentChartPeriod);
            }
        }

        // 添加旋轉動畫CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // 定期更新數據
        function startAutoUpdate() {
            setInterval(() => {
                loadAllData();
                autoUpdateChart(); // 更新監視器可用率圖表
                autoUpdateApiChart(); // 更新API狀態圖表
            }, 60000); // 每分鐘更新一次
            
            setInterval(() => {
                updateLastUpdateTime();
            }, 1000); // 每秒更新時間
        }

        // 頁面載入完成後執行
        window.onload = function() {
            console.log('🎯 頁面載入完成，開始初始化...');
            console.log('TDX_CONFIG:', typeof TDX_CONFIG !== 'undefined' ? '✅ OK' : '❌ MISSING');
            console.log('tdxApi:', typeof tdxApi !== 'undefined' ? '✅ OK' : '❌ MISSING');
            
            // 立即載入數據
            loadAllData();
            
            // 初始化圖表
            setTimeout(() => {
                try {
                    initChart(); // 初始化監視器可用率圖表
                    initApiChart(); // 初始化API狀態圖表
                    console.log('📊 圖表初始化完成');
                } catch (error) {
                    console.error('📊 圖表初始化失敗:', error);
                }
            }, 2000);
            
            // 開始自動更新
            startAutoUpdate();
        };

        // 如果頁面在載入過程中，立即執行基本初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM 載入完成，準備顯示初始狀態...');
            
            // 立即顯示載入狀態
            const elements = [
                'highwayCount', 'roadCount', 'expresswayCount', 'waterCount', 'debrisCount',
                'highwayLastCheck', 'roadLastCheck', 'expresswayLastCheck', 'waterLastCheck', 'debrisLastCheck'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element && element.textContent.includes('載入中')) {
                    element.textContent = '準備中...';
                }
            });
        });
    </script>

    <!-- Back to Top Button -->
    <div class="back-to-top" id="backToTop" style="position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999; font-size: 1.2rem;">
        <i class="fas fa-arrow-up"></i>
    </div>
</body>
</html>
