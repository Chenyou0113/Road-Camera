<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro PIDS - TPASS 2.0 Edition</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&family=Roboto:wght@700;900&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --theme-color: #8246af; } /* é è¨­ç‚ºæ¡ƒåœ’æ·é‹ç´«è‰² */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
        body { background-color: #000; height: 100vh; width: 100vw; display: flex; overflow: hidden; }
        
        .pids-wrapper { display: grid; grid-template-columns: 24% 76%; grid-template-rows: 90% 10%; width: 100%; height: 100%; background-color: #f0f0f0; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { display: flex; flex-direction: column; border-right: 2px solid #ccc; background-color: #fff; height: 100%; overflow: hidden; }
        
        .station-header { height: 10%; min-height: 60px; background-color: var(--theme-color); color: white; display: flex; align-items: center; padding: 0 15px; gap: 12px; }
        .st-badge { background: #fff; color: var(--theme-color); font-weight: 900; padding: 4px 10px; border-radius: 6px; font-size: 1.4vw; }
        .st-name-zh { font-size: 1.8vw; font-weight: 900; }

        .arrival-info { flex: 1; padding: 1vh 1vw; display: flex; flex-direction: column; border-bottom: 2px solid #eee; justify-content: center; }
        .arrival-info.secondary { background-color: #fcfcfc; }
        .dir-label { font-size: 0.9vw; font-weight: 900; color: #555; margin-bottom: 2px; }
        .line-tag-row { display: flex; align-items: center; gap: 8px; }
        .line-badge-small { background: var(--theme-color); color: white; padding: 2px 8px; border-radius: 4px; font-size: 1vw; font-weight: 900; min-width: 45px; text-align: center; }
        .dest-zh { font-size: 2.2vw; font-weight: 900; color: #000; line-height: 1.2; }
        .dest-en { font-size: 0.8vw; color: #888; }
        
        .time-box { background-color: var(--theme-color); color: white; margin-top: 5px; text-align: center; font-size: 3.5vw; font-weight: 700; border-radius: 8px; padding: 0.5vh 0; font-family: 'Roboto', sans-serif; width: 95%; align-self: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .time-box.arriving { background-color: #d32f2f; animation: pulse 1s infinite; }
        .time-box.approaching { background-color: #f58220; }

        /* æ°£è±¡ */
        .weather-box { 
            height: 18%; 
            background: #fff; 
            border-top: 2px solid #ccc; 
            display: grid;
            grid-template-columns: 1fr 2.5fr;
            grid-template-rows: 1fr 1fr;
            align-items: stretch;
        }
        .w-icon-area { grid-row: 1 / span 2; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; background: #f4f7f9; border-right: 1px solid #eee; }
        .w-icon-large { font-size: 4vw; color: #607d8b; }
        .w-desc { font-size: 1.3vw; font-weight: 700; color: #555; }
        .w-top-info { display: flex; justify-content: center; align-items: center; padding: 0 1vw; border-bottom: 1px solid #eee; }
        .w-bottom-info { display: flex; justify-content: center; align-items: center; padding: 0 1vw; }
        .w-range-text { font-size: 2vw; font-weight: 900; color: #d32f2f; }
        .w-rain-text { font-size: 2vw; font-weight: 900; color: #5a9fd4; }

        /* å³å´ä¸»é¡¯ç¤ºå€ - ä¿®æ­£å½±ç‰‡æ’­æ”¾å™¨ */
        .main-display { display: grid; grid-template-rows: 1fr 130px; background-color: #000; position: relative; }
        .video-container { width: 100%; height: 100%; position: relative; overflow: hidden; background: #000; }
        #video-iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: none;
            /* è®“å½±ç‰‡ç›¡å¯èƒ½å¡«æ»¿ */
            transform: scale(1.01); 
        }
        
        /* --- ğŸ‘¥ æ“æ“ åº¦é¡¯ç¤ºå€ (åŒ—æ·å°ˆç”¨) --- */
        .congestion-area { 
            background: #fff; 
            border-top: 2px solid #ccc; 
            padding: 10px 25px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .cong-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 8px;
        }
        .cong-row:last-child { margin-bottom: 0; }

        .cong-label {
            font-size: 1.1vw;
            font-weight: 900;
            color: #333;
            width: 180px; 
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }

        .cong-bar-container {
            flex: 1;
            display: flex;
            gap: 4px;
            height: 20px;
            background: #e2e8f0;
            padding: 2px;
            border-radius: 4px;
        }

        .cong-car {
            flex: 1;
            background-color: #cbd5e1; /* é è¨­ç°è‰² (ç„¡è³‡æ–™) */
            border-radius: 2px;
            transition: 0.3s;
        }

        /* ğŸŸ¢ğŸŸ¡ğŸŸ ğŸ”´ åŒ—æ· 1~4 ç´šæ¨™æº–è‰² */
        .cong-lvl-1 { background-color: #32b900; box-shadow: 0 0 5px #32b90080; } /* èˆ’é© (ç¶ ) */
        .cong-lvl-2 { background-color: #ffcc00; box-shadow: 0 0 5px #ffcc0080; } /* æ™®é€š (é»ƒ) */
        .cong-lvl-3 { background-color: #f58220; box-shadow: 0 0 5px #f5822080; } /* ç•¥æ“  (æ©˜) */
        .cong-lvl-4 { background-color: #d32f2f; box-shadow: 0 0 5px #d32f2f80; } /* æ“æ“  (ç´…) */
        
        .cong-no-data {
            color: #94a3b8;
            font-size: 1vw;
            font-weight: 700;
            text-align: center;
            width: 100%;
        }

        /* åº•éƒ¨ */
        .footer { grid-column: 1/3; display: grid; grid-template-columns: 24% 76%; background: #1a1a1a; color: #fff; }
        .clock-section { background: #d32f2f; display: flex; justify-content: center; align-items: center; font-size: 1.6vw; font-weight: 900; font-family: 'Roboto', sans-serif; }
        .marquee-section { overflow: hidden; display: flex; align-items: center; padding: 0 20px; }
        .marquee-text { white-space: nowrap; font-size: 1.7vw; animation: scroll 40s linear infinite; font-weight: 700; }

        @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>

    <div class="pids-wrapper">
        <div class="sidebar">
            <div class="station-header" id="ui-header">
                <div class="st-badge" id="ui-st-id">A8</div>
                <div class="st-name-zh" id="ui-st-name">é•·åºšé†«é™¢ç«™</div>
            </div>

            <div class="arrival-info" id="block-dir0">
                <div class="dir-label">ç¬¬ä¸€æœˆå° Platform 1</div>
                <div class="line-tag-row">
                    <div class="line-badge-small" id="ui-line-tag-1">A</div>
                    <div class="dest-zh" id="dir0-dest">å°åŒ—è»Šç«™</div>
                </div>
                <div class="dest-en" id="dir0-en">Taipei Main Station</div>
                <div class="time-box arriving" id="dir0-time">é€²ç«™ä¸­</div>
            </div>

            <div class="arrival-info secondary" id="block-dir1">
                <div class="dir-label">ç¬¬äºŒæœˆå° Platform 2</div>
                <div class="line-tag-row">
                    <div class="line-badge-small" id="ui-line-tag-2">A</div>
                    <div class="dest-zh" id="dir1-dest">æ©Ÿå ´ç¬¬äºŒèˆªå»ˆç«™</div>
                </div>
                <div class="dest-en" id="dir1-en">Airport Terminal 2 Station</div>
                <div class="time-box" id="dir1-time">-- : --</div>
            </div>

            <div class="weather-box">
                <div class="w-icon-area">
                    <div class="w-icon-large" id="ui-weather-icon"><i class="fas fa-cloud-sun"></i></div>
                    <div class="w-desc" id="ui-weather-text">å¤šé›²æ™‚æ™´</div>
                </div>
                <div class="w-top-info"><span class="w-range-text" id="ui-range-display">12Â°C ~ 14Â°C</span></div>
                <div class="w-bottom-info"><span class="w-rain-text" id="ui-rain-display"><i class="fas fa-umbrella"></i> 10%</span></div>
            </div>
        </div>

        <div class="main-display">
            <div class="video-container">
                <!-- æ›´æ–°å¾Œçš„å½±ç‰‡ IDï¼šY_siE2Wsp38 (äº¤é€šéƒ¨å®˜æ–¹ TPASS 2.0 å»£å‘Š) -->
                <iframe id="video-iframe" 
                    src="https://www.youtube.com/embed/Y_siE2Wsp38?autoplay=1&mute=1&loop=1&playlist=Y_siE2Wsp38&controls=0&modestbranding=1&rel=0&iv_load_policy=3&showinfo=0" 
                    allow="autoplay; encrypted-media">
                </iframe>
            </div>
            <div class="congestion-area">
                <!-- æ¡ƒæ·æš«ä¸æ”¯æ´æ“æ“ åº¦ï¼Œæ­¤è™•ç•™ç™½ç¬¦åˆå¯¦æ³ -->
            </div>
        </div>

        <div class="footer">
            <div class="clock-section" id="clock">01/28 04:11 PM</div>
            <div class="marquee-section">
                <div class="marquee-text" id="ui-marquee">TPASS 2.0 å…¬é‹å¸¸å®¢å„ªæƒ æ­£å¼ä¸Šç·šï¼æ­è¶Šå¤šå›é¥‹è¶Šå¤šï¼Œæœ€é«˜å›é¥‹ 40%ï¼è«‹è¸´èºä½¿ç”¨é›»å­ç¥¨è­‰æ­ä¹˜å¤§çœ¾é‹è¼¸å·¥å…·...</div>
            </div>
        </div>
    </div>

    <script>
        // ğŸš‡ æœ¬åœ°ç«™é»è³‡æ–™åº« (å¾ metro-stations-raw.json å°å…¥) - ç«‹å³é–‹å§‹è¼‰å…¥
        const METRO_STATIONS = fetch('metro-stations-raw.json')
            .then(r => r.json())
            .catch(() => {
                console.log('æœ¬åœ°ç«™é»è³‡æ–™æœªè¼‰å…¥ï¼Œå°‡ä½¿ç”¨ API ç«™å');
                return null;
            });
        
        const METRO_API = 'https://metro-api-worker.xiaoyouwu5-fd3.workers.dev/api';
        const WEATHER_API = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev';

        const params = new URLSearchParams(window.location.search);
        const system = params.get('sys') || params.get('system') || 'TYMC';
        const station = params.get('sid') || params.get('station') || 'A8';

        let countdownSecs = { dir0: -1, dir1: -1 };

        // èˆ‡ Worker å…§éƒ¨çš„ METRO_CONFIG é¡è‰²ä¿æŒåŒæ­¥
        const sysColors = { 
            'TRTC': '#0070bd', 'KRTC': '#f58220', 'TYMC': '#8246af', 
            'TMRT': '#b2d235', 'NTMC': '#0096cc', 'KLRT': '#008010' 
        };

        // â° æ™‚é˜æ›´æ–°å‡½æ•¸
        function updateClock() {
            const n = new Date();
            const d = `${String(n.getMonth()+1).padStart(2,'0')}/${String(n.getDate()).padStart(2,'0')}`;
            const t = n.toLocaleTimeString('en-US', {hour12:true, hour:'2-digit', minute:'2-digit'}).toUpperCase();
            document.getElementById('clock').innerText = `${d} ${t}`;
        }

        async function init() {
            // ğŸ¨ ç«‹å³è¨­ç½®åŸºæœ¬ UI
            document.documentElement.style.setProperty('--theme-color', sysColors[system] || '#333');
            document.getElementById('ui-st-id').innerText = station;
            document.getElementById('ui-st-name').innerText = "è¼‰å…¥ä¸­...";

            // âš¡ ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è³‡æºï¼ˆä¸é˜»å¡ï¼‰
            Promise.allSettled([
                // 1. è¼‰å…¥æœ¬åœ°ç«™é»è³‡æ–™ä¸¦æ›´æ–° UI
                METRO_STATIONS.then(stationsData => {
                    if (stationsData?.systems[system]?.stations[station]) {
                        const stationInfo = stationsData.systems[system].stations[station];
                        document.getElementById('ui-st-name').innerText = stationInfo.name;
                        
                        const lineInfo = stationsData.systems[system].lines[stationInfo.lineId];
                        if (lineInfo?.color) {
                            document.documentElement.style.setProperty('--theme-color', lineInfo.color);
                        }
                    }
                }),
                // 2. ç«‹å³è¼‰å…¥åˆ—è»Šè³‡æ–™
                updateData(),
                // 3. è¼‰å…¥å¤©æ°£è³‡æ–™
                updateWeather(),
                // 4. è¼‰å…¥è·‘é¦¬ç‡ˆ
                updateMarquee()
            ]);

            // ğŸ”„ è¨­ç½®å®šæ™‚æ›´æ–°
            setInterval(updateData, 15000);        // æ¯ 15 ç§’æ›´æ–°åˆ—è»Š
            setInterval(updateWeather, 600000);   // æ¯ 10 åˆ†é˜æ›´æ–°å¤©æ°£
            setInterval(updateMarquee, 300000);   // æ¯ 5 åˆ†é˜æ›´æ–°è·‘é¦¬ç‡ˆ
            
            // â° æ™‚é˜æ›´æ–°
            updateClock(); // ç«‹å³é¡¯ç¤ºæ™‚é–“
            setInterval(updateClock, 1000);

            // â±ï¸ å€’æ•¸è¨ˆæ™‚å™¨
            setInterval(() => {
                [0, 1].forEach(i => {
                    if(countdownSecs[`dir${i}`] > 0) {
                        countdownSecs[`dir${i}`]--;
                        renderTime(i);
                    }
                });
            }, 1000);
        }

        // ğŸ‘¥ æ›´æ–°æ“æ“ åº¦è³‡è¨Š (TRTC å°ˆç”¨)
        async function updateCongestion(nextTrains) {
            // åªæœ‰å°åŒ—æ·é‹ (TRTC) æœ‰æ“æ“ åº¦è³‡æ–™
            if (system !== 'TRTC') {
                document.querySelector('.congestion-area').innerHTML = `<div class="cong-no-data">æœ¬ç³»çµ±æš«ç„¡æ“æ“ åº¦è³‡è¨Š</div>`;
                return;
            }

            try {
                // 1. å–å¾—è·¯ç·šä»£è™Ÿ (ä¾‹å¦‚ BL, R)
                const lineId = station.replace(/[0-9]/g, ''); 
                
                // 2. å‘¼å« Worker API
                const res = await fetch(`${METRO_API}/trtc/crowd?line=${lineId}`);
                const data = await res.json(); 

                if (!data || data.length === 0) {
                    document.querySelector('.congestion-area').innerHTML = `<div class="cong-no-data">ç›®å‰ç„¡æ“æ“ åº¦è¨Šè™Ÿ</div>`;
                    return;
                }

                let html = '';
                
                // é‡å° PIDS ä¸Šé¡¯ç¤ºçš„å…©ç­è»Š (æœˆå°1, æœˆå°2)
                [0, 1].forEach(idx => {
                    const train = nextTrains[idx];
                    if (!train) return; // æ²’è»Šå°±ä¸é¡¯ç¤º

                    // ğŸ¯ æ¯”å°é‚è¼¯ï¼šå°‹æ‰¾ç›®çš„åœ°ç›¸åŒä¸”ä½ç½®æœ€æ¥è¿‘çš„åˆ—è»Š
                    // é€™è£¡ä½¿ç”¨ç›®çš„åœ°åç¨±é€²è¡Œæ¨¡ç³Šæ¯”å°
                    const carData = data.find(c => c.DestinationStationID === train.DestinationStationID || c.Destination === train.DestinationStationName.Zh_tw);

                    const label = `å¾€ ${train.DestinationStationName.Zh_tw}`;
                    let barsHtml = '';

                    // åˆ¤æ–·è»Šå»‚æ•¸ (æ–‡æ¹–ç·š BR æ˜¯ 4 ç¯€ï¼Œå…¶ä»–æ˜¯ 6 ç¯€)
                    const carCount = (lineId === 'BR') ? 4 : 6;

                    if (carData) {
                        // æœ‰æŠ“åˆ°è³‡æ–™ï¼Œä¾åºå¡«å…¥é¡è‰²
                        for (let i = 1; i <= carCount; i++) {
                            const level = carData[`Car${i}`]; // å–å¾— API å›å‚³çš„ç­‰ç´š (1~4)
                            let cls = 'cong-car';
                            
                            // å°æ‡‰é¡è‰² Class
                            if (level == 1) cls += ' cong-lvl-1'; // ç¶ 
                            else if (level == 2) cls += ' cong-lvl-2'; // é»ƒ
                            else if (level == 3) cls += ' cong-lvl-3'; // æ©˜
                            else if (level == 4) cls += ' cong-lvl-4'; // ç´…
                            
                            barsHtml += `<div class="${cls}" title="ç¬¬ ${i} ç¯€: ç­‰ç´š ${level}"></div>`;
                        }
                    } else {
                        // è©²åˆ—è»Šç„¡è³‡æ–™ (é¡¯ç¤ºç°è‰²)
                        for (let i = 1; i <= carCount; i++) {
                            barsHtml += `<div class="cong-car"></div>`;
                        }
                    }

                    html += `
                        <div class="cong-row">
                            <div class="cong-label">
                                <span style="background:${train.LineColor}; width:12px; height:12px; border-radius:50%; display:inline-block;"></span>
                                ${label}
                            </div>
                            <div class="cong-bar-container">${barsHtml}</div>
                        </div>
                    `;
                });

                document.querySelector('.congestion-area').innerHTML = html || `<div class="cong-no-data">ç›®å‰ç„¡æ“æ“ åº¦è³‡æ–™</div>`;

            } catch (e) {
                console.error("æ“æ“ åº¦æ›´æ–°å¤±æ•—", e);
            }
        }

        // ğŸŒ™ åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºã€Œæœ«ç­è»Šå·²é§›é›¢ã€
        function getOfflineStatus() {
            const h = new Date().getHours();
            // è¨­å®šåˆ¤å®šæ™‚æ®µï¼šæ·±å¤œ 23:00 åˆ° å‡Œæ™¨ 06:00 è¦–ç‚ºç‡Ÿé‹çµæŸ
            // é«˜é›„è¼•è»Œé€šå¸¸ 22:00-23:00 æ”¶ç­ï¼Œå…¶ä»–æ·é‹ç´„ 00:00-01:00
            const isLateNight = (h >= 23 || h < 6);
            
            return isLateNight 
                ? { zh: "æœ«ç­è»Šå·²é§›é›¢", en: "Last Train Departed" }
                : { zh: "æš«ç„¡åˆ—è»Š", en: "No Service" };
        }

        async function updateData() {
            try {
                const res = await fetch(`${METRO_API}/liveboard?sys=${system}&sid=${station.toUpperCase()}`);
                const sData = await res.json();
                
                // æº–å‚™ä¸€å€‹é™£åˆ—å­˜æ”¾å³å°‡é¡¯ç¤ºåœ¨ PIDS ä¸Šçš„å…©ç­è»Š
                let nextTrains = [null, null];

                if (!sData || sData.length === 0) {
                    setOfflineUI(0);
                    setOfflineUI(1);
                    // æ¸…ç©ºæ“æ“ åº¦
                    updateCongestion([null, null]);
                    return;
                }

                // === ğŸš¦ æ™ºæ…§æœˆå°åˆ†æµé‚è¼¯ ===
                
                if (system === 'TYMC') {
                    // ã€æ¡ƒåœ’æ·é‹å°ˆç”¨é‚è¼¯ã€‘
                    const toTaipei = sData.find(t => t.DestinationStationName.Zh_tw.includes('å°åŒ—è»Šç«™'));
                    const toSouth = sData.find(t => !t.DestinationStationName.Zh_tw.includes('å°åŒ—è»Šç«™'));

                    updateUI(0, toSouth);
                    updateUI(1, toTaipei);
                    nextTrains = [toSouth, toTaipei];

                } else if (system === 'KLRT') {
                    // ã€é«˜é›„è¼•è»Œå°ˆç”¨é‚è¼¯ã€‘
                    const t1 = sData[0];
                    const t2 = sData.length > 1 ? sData[1] : null;
                    updateUI(0, t1);
                    updateUI(1, t2);
                    nextTrains = [t1, t2];

                } else {
                    // ã€å°åŒ—æ·é‹ / é«˜é›„æ·é‹ / å°ä¸­æ·é‹ é€šç”¨é‚è¼¯ã€‘
                    const dests = [...new Set(sData.map(item => item.DestinationStationName.Zh_tw))];
                    let t1, t2;
                    
                    if (dests.length >= 2) {
                        t1 = sData.find(t => t.DestinationStationName.Zh_tw === dests[0]);
                        t2 = sData.find(t => t.DestinationStationName.Zh_tw === dests[1]);
                    } else {
                        t1 = sData[0];
                        t2 = sData.length > 1 ? sData[1] : null;
                    }
                    updateUI(0, t1);
                    updateUI(1, t2);
                    nextTrains = [t1, t2];
                }
                
                // â˜…â˜…â˜… é—œéµï¼šå‘¼å«æ›´æ–°æ“æ“ åº¦ â˜…â˜…â˜…
                // åªæœ‰åŒ—æ·æœƒçœŸæ­£å»æŠ“è³‡æ–™ï¼Œå…¶ä»–ç³»çµ±æœƒé¡¯ç¤ºæš«ç„¡è³‡æ–™
                updateCongestion(nextTrains);

            } catch(e) { 
                console.error("è³‡æ–™æ›´æ–°å¤±æ•—:", e);
                setOfflineUI(0);
                setOfflineUI(1);
                updateCongestion([null, null]);
            }
        }

        function updateUI(idx, item) {
            const destZh = document.getElementById(`dir${idx}-dest`);
            const destEn = document.getElementById(`dir${idx}-en`);
            const timeBox = document.getElementById(`dir${idx}-time`);
            const lineBadge = document.getElementById(`ui-line-tag-${idx+1}`);

            // âš ï¸ å¦‚æœæ²’æœ‰åˆ—è»Šè³‡æ–™ (item ç‚º null)
            if(!item) {
                const status = getOfflineStatus(); // å–å¾—ç‹€æ…‹æ–‡å­—
                destZh.innerText = status.zh;
                destEn.innerText = status.en;
                timeBox.innerText = "-- : --";
                timeBox.className = "time-box";
                // éš±è—è·¯ç·šç·¨è™Ÿæ¨™ç±¤ï¼Œè®“ç•«é¢æ›´ä¹¾æ·¨
                lineBadge.style.opacity = '0'; 
                return;
            }

            // æ­£å¸¸é¡¯ç¤ºåˆ—è»Šè³‡è¨Š
            lineBadge.style.opacity = '1';
            destZh.innerText = item.DestinationStationName.Zh_tw;
            destEn.innerText = item.DestinationStationName.En || "";
            lineBadge.innerText = item.LineID || system.substring(0,1);
            
            // ä½¿ç”¨ Worker æä¾›çš„é¡è‰² (å¦‚æœæœ‰çš„è©±)ï¼Œå¦å‰‡ç”¨é è¨­
            if (item.LineColor) {
                lineBadge.style.background = item.LineColor;
            } else {
                lineBadge.style.background = "#808080";
            }
            
            // â˜…â˜…â˜… è™•ç† null æ™‚é–“ï¼šå¦‚æœ API è¿”å› null æˆ– undefinedï¼Œè¦–ç‚º 0 (é€²ç«™ä¸­)
            const estimateTime = item.EstimateTime != null ? item.EstimateTime : 0;
            countdownSecs[`dir${idx}`] = estimateTime;
            renderTime(idx);
        }

        // ç•¶å®Œå…¨æŠ“ä¸åˆ°è³‡æ–™æ™‚ (ä¾‹å¦‚ API éŒ¯èª¤æˆ–ç©ºé™£åˆ—)
        function setOfflineUI(idx) {
            const status = getOfflineStatus();
            document.getElementById(`dir${idx}-dest`).innerText = status.zh;
            document.getElementById(`dir${idx}-en`).innerText = status.en;
            document.getElementById(`dir${idx}-time`).innerText = "-- : --";
            document.getElementById(`dir${idx}-time`).className = "time-box";
            document.getElementById(`ui-line-tag-${idx+1}`).style.opacity = '0';
        }

        function renderTime(idx) {
            const el = document.getElementById(`dir${idx}-time`);
            const s = countdownSecs[`dir${idx}`];
            
            // â˜…â˜…â˜… è™•ç† null/undefined/NaN
            if (s == null || isNaN(s) || s < 0) {
                el.innerText = "-- : --";
                el.className = "time-box";
                return;
            }

            if(s <= 40) { // 40ç§’å…§é¡¯ç¤ºé€²ç«™ä¸­
                el.innerText = "é€²ç«™ä¸­";
                el.className = "time-box arriving";
            } else if (s <= 120) { // 2åˆ†é˜å…§é¡¯ç¤ºæ©˜è‰²
                const m = Math.floor(s/60);
                el.innerText = `${m} : ${String(s%60).padStart(2,'0')}`;
                el.className = "time-box approaching";
            } else {
                const m = Math.floor(s/60);
                el.innerText = `${m} : ${String(s%60).padStart(2,'0')}`;
                el.className = "time-box";
            }
        }

        async function updateWeather() {
            try {
                const res = await fetch(`${WEATHER_API}?dataset=F-C0032-001`);
                const json = await res.json();
                const county = system === 'TYMC' ? 'æ¡ƒåœ’å¸‚' : 'è‡ºåŒ—å¸‚';
                const loc = json.records.location.find(l => l.locationName === county);
                if(loc) {
                    const wx = loc.weatherElement.find(e => e.elementName === 'Wx').time[0].parameter.parameterName;
                    const pop = loc.weatherElement.find(e => e.elementName === 'PoP').time[0].parameter.parameterName;
                    const minT = loc.weatherElement.find(e => e.elementName === 'MinT').time[0].parameter.parameterName;
                    const maxT = loc.weatherElement.find(e => e.elementName === 'MaxT').time[0].parameter.parameterName;
                    
                    document.getElementById('ui-weather-text').innerText = wx;
                    document.getElementById('ui-range-display').innerText = `${minT}Â°C ~ ${maxT}Â°C`;
                    document.getElementById('ui-rain-display').innerHTML = `<i class="fas fa-umbrella"></i> ${pop}%`;
                }
            } catch(e) {}
        }

        // æ–°èå¿«å–
        let newsCache = { data: null, timestamp: 0 };
        const NEWS_CACHE_TIME = 300000; // 5 åˆ†é˜å¿«å–

        async function updateMarquee() {
            // é è¨­çš„å›ºå®šå®£å‚³èª
            const tpassSummary = "ã€TPASS 2.0+ å‡ç´šã€‘å¸¸å®¢å„ªæƒ æ­£å¼ä¸Šç·šï¼æ­ä¹˜11æ¬¡ä»¥ä¸Šæœ€é«˜äº«30%å›é¥‹ï¼Œåœ‹é“å®¢é‹é è¡Œå†äº«å„ªæƒ ï¼Œè©³æƒ…è«‹è¦‹å®˜ç¶²ã€‚";
            const safetyPsas = "ã€å®‰å…¨å®£å°ã€‘æœˆå°å€™è»Šè«‹å‹¿è¶…è¶Šé»ƒç·šã€‚é‡ç·Šæ€¥ç‹€æ³è«‹ä¿æŒå†·éœï¼Œä½¿ç”¨å°è¬›æ©Ÿæ±‚åŠ©ã€‚æ·é‹ç³»çµ±å…¨é¢ç¦è¸ã€‚";
            
            let finalMarquee = "";

            try {
                let data = null;
                
                // æª¢æŸ¥å¿«å–
                if (newsCache.data && (Date.now() - newsCache.timestamp) < NEWS_CACHE_TIME) {
                    data = newsCache.data;
                } else {
                    // 1. å‘ Worker è«‹æ±‚æœ€æ–°æ¶ˆæ¯
                    const res = await fetch(`${METRO_API}/news?sys=${system}`);
                    data = await res.json();
                    newsCache = { data, timestamp: Date.now() };
                }
                
                let newsContent = "";
                
                // 2. å¦‚æœæœ‰æ–°èè³‡æ–™ï¼ŒæŠ“å–å‰ 3 æ¢æ¨™é¡Œ
                if (Array.isArray(data) && data.length > 0) {
                    newsContent = data.slice(0, 3).map(n => {
                        // æœ‰äº› API å›å‚³æ¬„ä½æ˜¯ Titleï¼Œæœ‰äº›æ˜¯ NewsTitle
                        const title = n.Title || n.NewsTitle || "æœ€æ–°æ¶ˆæ¯";
                        return `ã€æœ€æ–°æ¶ˆæ¯ã€‘${title}`;
                    }).join('ã€€ã€€') + 'ã€€ã€€';
                }

                // 3. çµ„åˆï¼š[æ–°è] + [TPASS] + [å®‰å…¨å®£å°]
                finalMarquee = newsContent + tpassSummary + 'ã€€ã€€' + safetyPsas + 'ã€€ã€€ç¥æ‚¨æ—…é€”æ„‰å¿«ï¼';
                
                // 4. æ›´æ–°åˆ°ç•«é¢
                const marqueeEl = document.getElementById('ui-marquee');
                marqueeEl.innerText = finalMarquee;

                // 5. å‹•æ…‹èª¿æ•´æ»¾å‹•é€Ÿåº¦ (æ ¹æ“šæ–‡å­—é•·åº¦è¨ˆç®—ç§’æ•¸ï¼Œé¿å…å­—å¤šè·‘å¤ªå¿«)
                const charCount = finalMarquee.length;
                const newDuration = Math.max(30, charCount * 0.4); // æ¯ 1 å€‹å­—çµ¦ 0.4 ç§’ï¼Œæœ€å°‘ 30 ç§’
                marqueeEl.style.animationDuration = `${newDuration}s`;

            } catch (e) {
                console.error("æ–°èæŠ“å–å¤±æ•—:", e);
                // å¤±æ•—æ™‚é¡¯ç¤ºé è¨­å…§å®¹
                document.getElementById('ui-marquee').innerText = tpassSummary + 'ã€€ã€€' + safetyPsas;
            }
        }

        init();
    </script>
</body>
</html>
