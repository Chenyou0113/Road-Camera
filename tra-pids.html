<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台鐵 PIDS (經典版+多媒體)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #111; color: white; font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            padding: 10px; gap: 10px;
        }

        /* === 1. Header === */
        .unified-header {
            width: 100%; height: 100px; background: #000; border: 3px solid #333; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; padding: 0 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); flex-shrink: 0;
        }
        .station-branding { display: flex; align-items: center; gap: 20px; flex: 1; }
        .tra-logo-img { height: 60px; border-radius: 50%; border: 2px solid #fff; }
        .station-name { font-size: 3.5rem; font-weight: 900; line-height: 1; letter-spacing: 2px; text-shadow: 0 0 10px rgba(255,255,255,0.6); }
        .station-sub { font-size: 1.5rem; color: #4fc3f7; font-family: Consolas, sans-serif; letter-spacing: 1px; font-weight: bold; }
        .datetime-block { text-align: right; }
        .time-text { font-size: 3rem; font-weight: bold; font-family: Consolas, monospace; color: #ffeb3b; line-height: 1; }
        .date-text { font-size: 1.5rem; color: #ccc; font-weight: bold; font-family: Consolas, monospace; }

        /* === 2. Top Marquee (經典滾動) === */
        .unified-marquee-container {
            width: 100%; height: 60px; background: #e3f2fd; border: 3px solid #333; border-left: 8px solid #0277bd;
            display: flex; align-items: center; overflow: hidden; position: relative; color: #01579b; flex-shrink: 0;
        }
        .unified-marquee-container .marquee-text {
            position: absolute; white-space: nowrap; height: 60px; line-height: 60px; 
            font-size: 2.2rem; font-weight: 900; left: 100%; will-change: transform;
        }

        /* === 3. PIDS Section === */
        .pids-section { display: flex; width: 100%; gap: 15px; flex: 1; overflow: hidden; min-height: 0; }
        .pids-column { flex: 1; display: flex; flex-direction: column; background: #000; border: 3px solid #333; border-radius: 8px; overflow: hidden; }
        .screen-body { flex: 1; display: flex; flex-direction: column; background: #000; overflow: hidden; }

        .direction-header-1 { background: linear-gradient(to right, #000080, #0d47a1); color: white; padding: 10px 15px; font-size: 1.5rem; font-weight: 900; display: flex; justify-content: space-between; border-bottom: 2px solid #fff; }
        .direction-header-0 { background: linear-gradient(to right, #bf360c, #e65100); color: white; padding: 10px 15px; font-size: 1.5rem; font-weight: 900; display: flex; justify-content: space-between; border-bottom: 2px solid #fff; }

        /* 表格設定 (無月台, 5欄) */
        .train-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 1.8rem; font-weight: bold; table-layout: fixed; }
        .train-table th { padding: 8px; color: #fff; border-bottom: 2px solid #fff; height: 45px; font-size: 1.3rem; }
        .train-table tbody tr { height: 16%; border-bottom: 1px solid #333; } /* 讓5列填滿 */
        .train-table td { padding: 0 5px; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .table-1 th { background: #000080; } .table-1 tr:nth-child(odd) { background: #000; } .table-1 tr:nth-child(even) { background: #002f4b; }
        .table-0 th { background: #bf360c; } .table-0 tr:nth-child(odd) { background: #000; } .table-0 tr:nth-child(even) { background: #3e2723; }

        /* 底部跑馬燈 */
        .marquee-footer { background: #212121; color: #ffeb3b; height: 50px; position: relative; overflow: hidden; border-top: 3px solid #ff9800; flex-shrink: 0; }
        .marquee-footer .marquee-text { position: absolute; white-space: nowrap; left: 100%; height: 50px; line-height: 50px; font-size: 1.4rem; font-weight: bold; }

        /* === 4. Media Section === */
        .media-section { height: 320px; display: flex; gap: 15px; flex-shrink: 0; }
        .media-box { flex: 1; background: #000; border: 3px solid #333; border-radius: 8px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
        .media-label { position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.7); color: #fff; padding: 5px 10px; font-size: 1rem; z-index: 10; border-bottom-right-radius: 8px; }
        .carousel-img { width: 100%; height: 100%; object-fit: contain; position: absolute; opacity: 0; transition: opacity 1s; }
        .carousel-img.active { opacity: 1; }
        .video-iframe { width: 100%; height: 100%; border: none; }

        /* === 5. 車種顏色 (找回原本的設定) === */
        .train-type-badge { display: inline-block; padding: 4px 12px; border-radius: 4px; color: white; font-size: 1.6rem; font-weight: bold; white-space: nowrap; min-width: 130px; }
        .type-自強 { background-color: #FF5722; }
        .type-自強3000 { background: linear-gradient(135deg, #222 0%, #444 100%); border: 1px solid #999; }
        .type-普悠瑪 { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); }
        .type-太魯閣 { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .type-莒光 { background-color: #FF9800; }
        .type-觀光 { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); border: 1px dashed #fff; }
        .type-區間快 { background-color: #3F51B5; }
        .type-區間 { background-color: #2196F3; }
        .type-復興 { background-color: #00BCD4; }
        .type-普快 { background-color: #009688; }
        .type-其他 { background-color: #607D8B; }

        /* 狀態與時間 */
        .status-ontime { color: #ffffff !important; }
        .status-delay { color: #ff1744 !important; }
        .status-cancelled { color: #FF5252; background: #222; border: 1px solid #FF5252; padding: 0 5px; border-radius: 4px; }
        .train-cancelled-row { opacity: 0.6; background-color: #1a1a1a !important; filter: grayscale(1); }
        
        .time-delay-container { display: flex; justify-content: center; gap: 10px; align-items: center; }
        .original-time { text-decoration: line-through; color: #777; font-size: 1.2rem; }
        .expected-time { color: #4fc3f7; font-weight: bold; font-size: 1.8rem; }
        .normal-time { font-size: 1.8rem; font-family: Consolas; }
        .highlight-row { background-color: rgba(255, 255, 255, 0.15) !important; border: 2px solid #ffeb3b !important; }

        /* 動畫定義 */
        @keyframes dynamic-marquee { from { transform: translateX(var(--start-pos)); } to { transform: translateX(var(--end-pos)); } }

        @media (max-width: 900px) {
            body { height: auto; overflow-y: auto; }
            .pids-section { flex-direction: column; display: block; }
            .pids-column { margin-bottom: 15px; }
            .media-section { flex-direction: column; height: auto; }
            .media-box { height: 250px; margin-bottom: 10px; }
        }
    </style>
    <script src="assets/station-code-mapping.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="unified-header">
        <div class="station-branding">
            <img src="https://www.railway.gov.tw/tra-tip-web/static/images/TRA_logo.jpg" class="tra-logo-img">
            <div class="station-name-block">
                <div class="station-name" id="unifiedStationName">臺鐵車站</div>
                <div class="station-sub" id="station-en">TRA STATION</div>
            </div>
        </div>
        <div class="datetime-block">
            <div class="date-text" id="unifiedDate">Loading...</div>
            <div class="time-text" id="unifiedTime">--:--:--</div>
        </div>
    </div>

    <!-- Top Marquee -->
    <div class="unified-marquee-container">
        <div class="marquee-text" id="unifiedTopMarquee">
            在通過平交道前，停、看、聽雙向有無來車。&nbsp;&nbsp;&nbsp;請勿跨越軌道或在月台上奔跑。
        </div>
    </div>

    <!-- PIDS Tables (5班, 無月台) -->
    <div class="pids-section">
        <!-- 逆行 -->
        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-1"><span id="dirTitle1">逆行</span><span id="destList1" style="font-size:1rem"></span></div>
                <table class="train-table table-1">
                    <thead>
                        <tr>
                            <th style="width:18%">車次</th>
                            <th style="width:22%">車種</th>
                            <th style="width:25%">開往</th>
                            <th style="width:22%">時間</th>
                            <th style="width:13%">狀態</th>
                        </tr>
                    </thead>
                    <tbody id="body1"></tbody>
                </table>
            </div>
            <div class="marquee-footer"><div class="marquee-text" id="marquee1">資料讀取中...</div></div>
        </div>
        <!-- 順行 -->
        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-0"><span id="dirTitle0">順行</span><span id="destList0" style="font-size:1rem"></span></div>
                <table class="train-table table-0">
                    <thead>
                        <tr>
                            <th style="width:18%">車次</th>
                            <th style="width:22%">車種</th>
                            <th style="width:25%">開往</th>
                            <th style="width:22%">時間</th>
                            <th style="width:13%">狀態</th>
                        </tr>
                    </thead>
                    <tbody id="body0"></tbody>
                </table>
            </div>
            <div class="marquee-footer"><div class="marquee-text" id="marquee0">資料讀取中...</div></div>
        </div>
    </div>

    <!-- Media -->
    <div class="media-section">
        <div class="media-box" id="carouselBox">
            <div class="media-label">宣導資訊</div>
            <img src="https://www.railway.gov.tw/tra-tip-web/static/images/hero-bg-01.jpg" class="carousel-img active">
        </div>
        <div class="media-box" id="videoBox">
            <div class="media-label">影音專區</div>
            <div id="videoContainer" style="width:100%;height:100%"></div>
        </div>
    </div>

    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script>
        const TRA_WORKER_URL = "https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev";
        let GLOBAL_STATION_ID = "";
        const MAX_ROWS = 5;

        // 車種對應與顏色邏輯
        const TRAIN_TYPE_DB = [
          { "id": "1100", "name": "自強", "code": "3" }, { "id": "1101", "name": "太魯閣", "code": "1" }, 
          { "id": "1102", "name": "自強", "code": "3" }, { "id": "1107", "name": "普悠瑪", "code": "2" }, 
          { "id": "110B", "name": "新自強", "code": "11" }, { "id": "1110", "name": "莒光", "code": "4" },
          { "id": "1131", "name": "區間", "code": "6" }, { "id": "1132", "name": "區間快", "code": "6" }, 
          { "id": "1140", "name": "普快", "code": "7" }
        ];
        const trainTypeMap = new Map();
        TRAIN_TYPE_DB.forEach(item => trainTypeMap.set(item.id, item.name));
        const stopsCache = {};

        function getTrainDisplayInfo(train) {
            let name = train.TrainTypeName?.Zh_tw || train.TrainTypeName || '列車';
            const typeID = train.TrainTypeID || train.TrainType;
            
            // 嘗試從 ID 對應
            if (typeID && trainTypeMap.has(typeID)) name = trainTypeMap.get(typeID);
            
            // 關鍵：依據名稱決定 CSS Class (恢復原本的豐富顏色)
            let cssClass = '其他';
            if (name.includes('新自強') || name.includes('3000')) { name = '新自強'; cssClass = '自強3000'; }
            else if (name.includes('普悠瑪')) { cssClass = '普悠瑪'; }
            else if (name.includes('太魯閣')) { cssClass = '太魯閣'; }
            else if (name.includes('自強')) { cssClass = '自強'; }
            else if (name.includes('莒光')) { cssClass = '莒光'; }
            else if (name.includes('觀光')) { cssClass = '觀光'; }
            else if (name.includes('區間快')) { cssClass = '區間快'; }
            else if (name.includes('區間')) { cssClass = '區間'; }
            else if (name.includes('復興')) { cssClass = '復興'; }
            else if (name.includes('普快')) { cssClass = '普快'; }
            
            return { name: name, class: cssClass };
        }

        async function fetchTrainStops(trainNo) {
            if (stopsCache[trainNo]) return stopsCache[trainNo];
            try {
                let r = await fetch(`${TRA_WORKER_URL}/api/schedule?trainNo=${trainNo}`);
                let d = await r.json();
                if(d.length) { stopsCache[trainNo] = d[0].StopTimes; return d[0].StopTimes; }
            } catch(e){} return [];
        }

        function getExpectedTime(timeStr, delayMins) {
            if (!timeStr || delayMins === 0) return timeStr;
            const [h, m] = timeStr.split(':').map(Number);
            const total = h * 60 + m + delayMins;
            const newH = Math.floor(total / 60) % 24;
            const newM = total % 60;
            return `${String(newH).padStart(2,'0')}:${String(newM).padStart(2,'0')}`;
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('unifiedTime').textContent = now.toLocaleTimeString('en-GB');
            document.getElementById('unifiedDate').textContent = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;
        }
        setInterval(updateClock, 1000);

        // ============ Media (Worker API) ============
        async function updateMediaAssets() {
            try {
                const res = await fetch(`${TRA_WORKER_URL}/api/pids/assets`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.images && data.images.length > 0) setupCarousel(data.images);
                    if (data.video) setupVideo(data.video);
                }
            } catch (e) {
                // Fallback
                setupCarousel(["https://www.railway.gov.tw/tra-tip-web/static/images/hero-bg-01.jpg"]);
                setupVideo("https://www.youtube.com/watch?v=5k5x-8s81kQ");
            }
        }

        let carTimer;
        function setupCarousel(imgs) {
            const box = document.getElementById('carouselBox');
            box.querySelectorAll('img').forEach(i=>i.remove());
            imgs.forEach((src,i) => {
                const img = document.createElement('img');
                img.src = src; img.className = i===0?'carousel-img active':'carousel-img';
                box.appendChild(img);
            });
            let idx = 0;
            if(carTimer) clearInterval(carTimer);
            carTimer = setInterval(() => {
                const list = box.querySelectorAll('img');
                if(list.length>1) {
                    list[idx].classList.remove('active');
                    idx = (idx+1)%list.length;
                    list[idx].classList.add('active');
                }
            }, 10000);
        }

        function setupVideo(url) {
            const con = document.getElementById('videoContainer');
            let vid = "";
            let urls = Array.isArray(url) ? url : [url];
            let vIds = [];
            urls.forEach(u => {
                if(u.includes('youtube')||u.includes('youtu.be')) {
                    if(u.includes('v=')) vid=u.split('v=')[1];
                    else if(u.includes('embed/')) vid=u.split('embed/')[1];
                    else vid=u.split('/').pop();
                    vid=vid.split('&')[0];
                    if(vid.length===11) vIds.push(vid);
                }
            });

            if(vIds.length>0) {
                let first = vIds[0];
                let pl = vIds.join(',');
                con.innerHTML = `<iframe class="video-iframe" src="https://www.youtube.com/embed/${first}?autoplay=1&mute=1&loop=1&playlist=${pl}&controls=0&rel=0" allow="autoplay; encrypted-media;"></iframe>`;
            } else if (typeof url === 'string') {
                con.innerHTML = `<video src="${url}" autoplay muted loop playsinline style="width:100%;height:100%;object-fit:contain;"></video>`;
            }
        }

        // ============ PIDS Logic ============
        async function updatePidsData(id) {
            try {
                let r = await fetch(`${TRA_WORKER_URL}/api/liveboard/station?station=${id}`);
                let d = await r.json();
                
                const seen = new Set();
                d = d.filter(t => { if(seen.has(t.TrainNo)) return false; seen.add(t.TrainNo); return true; });

                d.forEach(t => {
                    let [h,m] = (t.ScheduledDepartureTime||"00:00").split(':').map(Number);
                    t._sort = (h*60+m) + (t.IsTomorrow?1440:0) + (parseInt(t.DelayTime||0));
                });
                d.sort((a,b) => a._sort - b._sort);

                let t1 = d.filter(t=>String(t.Direction)==='1');
                let t0 = d.filter(t=>String(t.Direction)==='0');

                renderScreen('1', t1, '逆行');
                renderScreen('0', t0, '順行');
                
                // 恢復：使用原始動畫邏輯
                updateBottomMarquee('marquee1', t1).then(() => startMarquee('marquee1'));
                updateBottomMarquee('marquee0', t0).then(() => startMarquee('marquee0'));

            } catch(e) { renderScreen('1',[],''); renderScreen('0',[],''); }
        }

        function renderScreen(code, list, dirName) {
            const tb = document.getElementById(`body${code}`);
            const lbl = document.getElementById(`destList${code}`);
            tb.innerHTML = '';
            // 簡易方向判斷
            lbl.textContent = dirName==='逆行' ? (GLOBAL_STATION_ID>=1800&&GLOBAL_STATION_ID<=7000?'北上 (Northbound)':'北上 (Northbound)') : (GLOBAL_STATION_ID>=1800&&GLOBAL_STATION_ID<=7000?'南下 (Southbound)':'南下 (Southbound)');

            list.slice(0, MAX_ROWS).forEach((t, i) => {
                let info = getTrainDisplayInfo(t);
                let delay = parseInt(t.DelayTime||0);
                let isCancel = String(t.TrainStatus)==='2';
                let status = '準點', cls = 'status-ontime';
                
                if(isCancel) { status='停駛'; cls='status-cancelled'; }
                else if(t.IsTomorrow) { status='未發車'; cls='status-future'; }
                else if(delay>0) { status=`晚 ${delay} 分`; cls='status-delay'; }

                let timeStr = (t.ScheduledDepartureTime||"").slice(0,5);
                let timeHtml = `<span class="normal-time">${timeStr}</span>`;
                
                if(delay>0 && !isCancel && !t.IsTomorrow) {
                    timeHtml = `<div class="time-delay-container"><span class="original-time">${timeStr}</span><span class="expected-time">${getExpectedTime(timeStr, delay)}</span></div>`;
                }

                // 山海線顯示
                let dest = t.EndingStationName;
                if(t.TripLine==1) dest+=' (山)';
                if(t.TripLine==2) dest+=' (海)';

                let tr = document.createElement('tr');
                if(i===0) tr.classList.add('highlight-row');
                if(isCancel) tr.classList.add('train-cancelled-row');

                tr.innerHTML = `
                    <td style="font-family:Consolas">${t.TrainNo}</td>
                    <td><span class="train-type-badge type-${info.class}">${info.name}</span></td>
                    <td>${dest}</td>
                    <td>${timeHtml}</td>
                    <td class="${cls}">${status}</td>
                `;
                tb.appendChild(tr);
            });
            for(let i=Math.min(list.length, MAX_ROWS); i<MAX_ROWS; i++) tb.innerHTML += `<tr><td></td><td></td><td></td><td></td><td></td></tr>`;
        }

        // 恢復：詳細的底部跑馬燈邏輯 (顯示停靠站)
        async function updateBottomMarquee(elId, list) {
            const el = document.getElementById(elId);
            if(!list || list.length===0) { el.innerHTML = "目前無列車資訊"; return; }
            
            let t = list[0];
            let info = getTrainDisplayInfo(t);
            let delay = parseInt(t.DelayTime||0);
            let isCancel = String(t.TrainStatus)==='2';

            if(isCancel) {
                el.innerHTML = `<span style="color:#FF5252;font-weight:bold">${t.TrainNo} 次 ${info.name} 本日停駛</span>`;
                return;
            }

            let msg = `<span style="color:#ffeb3b;font-weight:bold">${t.TrainNo} 次 ${info.name} 往 ${t.EndingStationName}</span>`;
            msg += `<span style="margin:0 15px;color:#555">|</span>`;

            // 抓取停靠站
            let stops = await fetchTrainStops(t.TrainNo);
            if(stops && stops.length>0) {
                let idx = stops.findIndex(s => String(s.StationID) === GLOBAL_STATION_ID);
                if(idx !== -1) {
                    // 顯示接下來的停靠站
                    let nextStops = stops.slice(idx+1).map(s => s.StationName.Zh_tw).join('、');
                    if(nextStops) msg += `沿途停靠：${nextStops}`;
                    else msg += `本站為終點站`;
                } else {
                    msg += `準點率 99% (本列車不停靠本站)`;
                }
            } else {
                msg += `準點率 99%`;
            }
            el.innerHTML = msg;
        }

        // 恢復：跑馬燈動畫控制
        function startMarquee(id) {
            const el = document.getElementById(id);
            if(!el) return;
            const container = el.parentElement;
            el.style.animation = 'none';
            void el.offsetWidth; // trigger reflow
            
            const w = el.scrollWidth;
            const cw = container.clientWidth;
            
            el.style.setProperty('--start-pos', `${cw}px`);
            el.style.setProperty('--end-pos', `-${w}px`);
            
            const dur = Math.max(8, w * 0.015); // 調整速度
            el.style.animation = `dynamic-marquee ${dur}s linear infinite`;
        }

        async function checkTopMarquee() {
            try {
                const res = await fetch(`${TRA_WORKER_URL}/api/pids/marquee`);
                const data = await res.json();
                const el = document.getElementById('unifiedTopMarquee');
                if (data.text && el.innerHTML !== data.text) {
                    el.innerHTML = data.text;
                    startMarquee('unifiedTopMarquee');
                }
            } catch(e){}
        }

        document.addEventListener('DOMContentLoaded', () => {
            const p = new URLSearchParams(location.search);
            GLOBAL_STATION_ID = p.get('station');
            let name = p.get('name') || '臺鐵';
            document.getElementById('unifiedStationName').innerText = name.replace(/車站$|站$/,'') + '車站';
            updateEnglishStationName(GLOBAL_STATION_ID);
            updateClock();
            updateMediaAssets();
            
            if(GLOBAL_STATION_ID) { updatePidsData(GLOBAL_STATION_ID); setInterval(()=>updatePidsData(GLOBAL_STATION_ID), 60000); }
            
            // 啟動跑馬燈
            checkTopMarquee();
            setTimeout(()=>startMarquee('unifiedTopMarquee'), 1000);
            setInterval(checkTopMarquee, 60000);
        });
    </script>
</body>
</html>
