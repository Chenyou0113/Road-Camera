# é è¨ˆæ™‚é–“èˆ‡è·¨æ—¥æ’åºå¯¦ç¾å ±å‘Š

**å®Œæˆæ—¥æœŸ**: 2025å¹´12æœˆ7æ—¥  
**ç‹€æ…‹**: âœ… å®Œå…¨å¯¦ç¾

---

## å¯¦ç¾æ‘˜è¦

æˆåŠŸç‚º `tra_liveboard.html` å’Œ `tra-pids.html` å…©ä»½æª”æ¡ˆæ·»åŠ äº†ï¼š
1. âœ… **é è¨ˆåˆ°ç«™æ™‚é–“è¨ˆç®—** - ç•¶åˆ—è»Šèª¤é»æ™‚é¡¯ç¤ºé è¨ˆæ™‚é–“
2. âœ… **è·¨æ—¥æ’åºé‚è¼¯** - å‡Œæ™¨æ™‚æ®µè‡ªå‹•èª¿æ•´æ’åºæ¬Šé‡
3. âœ… **åœé§›åˆ—è»Šè™•ç†** - åœé§›åˆ—è»Šä¸åƒèˆ‡èª¤é»æ™‚é–“è¨ˆç®—ï¼Œä¸”è¦–è¦ºä¸Šå€åˆ†

---

## 1. å…±ç”¨è¼”åŠ©å‡½å¼ï¼š`getExpectedTime(timeStr, delayMins)`

### åŠŸèƒ½èªªæ˜
è¨ˆç®—åˆ—è»Šåœ¨çµ¦å®šå»¶é²æ™‚é–“å¾Œçš„é è¨ˆåˆ°é”æ™‚é–“ã€‚

### å¯¦ç¾ä»£ç¢¼
```javascript
function getExpectedTime(timeStr, delayMins) {
    if (!timeStr || delayMins === 0) return timeStr;
    const [h, m] = timeStr.split(':').map(Number);
    const totalMins = h * 60 + m + delayMins;
    const newH = Math.floor(totalMins / 60) % 24;
    const newM = totalMins % 60;
    return `${String(newH).padStart(2, '0')}:${String(newM).padStart(2, '0')}`;
}
```

### åƒæ•¸
- `timeStr` (string): è¡¨å®šæ™‚é–“ï¼Œæ ¼å¼ "HH:mm"
- `delayMins` (number): èª¤é»åˆ†é˜æ•¸

### å›å‚³å€¼
- (string): è¨ˆç®—å¾Œçš„é è¨ˆæ™‚é–“ "HH:mm"

### ä½¿ç”¨ç¯„ä¾‹
```javascript
getExpectedTime("08:00", 30);  // è¿”å› "08:30"
getExpectedTime("23:50", 45);  // è¿”å› "00:35"
```

### ä½ç½®
- **tra_liveboard.html**: ç¬¬ 845 è¡Œ
- **tra-pids.html**: ç¬¬ 614 è¡Œ

---

## 2. tra_liveboard.html ä¿®æ”¹è©³æƒ…

### 2.1 CSS æ¨£å¼æ·»åŠ 
**ä½ç½®**: `<style>` å€åŸŸ (ç¬¬ 404-410 è¡Œ)

æ–°å¢ `.expected-time` æ¨£å¼ï¼š
```css
.expected-time {
    font-size: 0.9rem;
    color: #00e5ff;           /* äº®é’è‰² */
    font-weight: 600;
    margin-top: 4px;
}
```

**è¦–è¦ºæ•ˆæœ**: åœ¨è¡¨å®šæ™‚é–“ä¸‹æ–¹ä»¥äº®é’è‰² (#00e5ff) é¡¯ç¤ºé è¨ˆæ™‚é–“

### 2.2 åˆ—è»Šå¡ç‰‡é¡¯ç¤ºä¿®æ”¹
**ä½ç½®**: `renderBoard()` å‡½å¼ä¸­çš„åˆ—è»Šå¡ç‰‡ç”Ÿæˆéƒ¨åˆ† (ç¬¬ 805-826 è¡Œ)

**ä¿®æ”¹å…§å®¹**:
```javascript
// é è¨ˆæ™‚é–“ - åƒ…æœ‰èª¤é»ä¸”éåœé§›æ™‚é¡¯ç¤º
let expectedTimeHtml = '';
const delayMins = parseInt(train.DelayTime || 0);
if (delayMins > 0 && !isCancelled) {
    const expectedTime = getExpectedTime(timeText, delayMins);
    expectedTimeHtml = `<div class="expected-time">é è¨ˆ ${expectedTime}</div>`;
}
```

**é¡¯ç¤ºé‚è¼¯**:
- âœ… æœ‰èª¤é» (DelayTime > 0)
- âœ… éåœé§›åˆ—è»Š
- âœ… éæ˜æ—¥ç­æ¬¡
- â†’ é¡¯ç¤ºé è¨ˆæ™‚é–“

### 2.3 æ’åºé‚è¼¯ä¿®æ­£
**ä½ç½®**: `renderBoard()` å‡½å¼çš„ `filteredTrains.sort()` éƒ¨åˆ† (ç¬¬ 752-754 è¡Œ)

**ä¿®æ”¹å…§å®¹**:
```javascript
// 2. åŠ ä¸Šèª¤é»æ™‚é–“ï¼ˆåœé§›åˆ—è»Šä¸è¨ˆç®—èª¤é»ï¼‰
const isCancelled = (String(t.TrainStatus) === '2' || t.TrainStatus === 2);
if (!isCancelled) {
    mins += parseInt(t.DelayTime || 0);
}
```

**æ•ˆæœ**:
- åœé§›åˆ—è»Š (TrainStatus=2) ä¿æŒè¡¨å®šæ™‚é–“æ’åº
- å…¶ä»–åˆ—è»ŠæŒ‰ `è¡¨å®šæ™‚é–“ + èª¤é»` è¨ˆç®—æ’åºæ¬Šé‡

---

## 3. tra-pids.html ä¿®æ”¹è©³æƒ…

### 3.1 CSS æ¨£å¼æ·»åŠ 
**ä½ç½®**: `<style>` å€åŸŸçµå°¾ (ç¬¬ 364-370 è¡Œ)

æ–°å¢ `.expected-time-pids` æ¨£å¼ï¼š
```css
.expected-time-pids {
    font-size: 0.8rem;
    color: #4fc3f7;           /* äº®è—è‰² */
    font-weight: 600;
    display: block;
}
```

**è¦–è¦ºæ•ˆæœ**: åœ¨æ™‚é–“æ¬„ä½å…§ä»¥äº®è—è‰² (#4fc3f7) é¡¯ç¤º "(é è¨ˆ HH:mm)"

### 3.2 è¡¨æ ¼åˆ—è»Šæ™‚é–“é¡¯ç¤ºä¿®æ”¹
**ä½ç½®**: `renderScreen()` å‡½å¼ (ç¬¬ 797-810 è¡Œ)

**ä¿®æ”¹å…§å®¹**:
```javascript
const timeStr = formatTime(train.ScheduledDepartureTime || train.DepartureTime);

// é è¨ˆæ™‚é–“ - åƒ…æœ‰èª¤é»ä¸”éåœé§›æ™‚é¡¯ç¤º
let expectedTimeDisplay = '';
if (delay > 0 && !isCancelled) {
    const expectedTime = getExpectedTime(timeStr, delay);
    expectedTimeDisplay = `<span class="expected-time-pids">(é è¨ˆ ${expectedTime})</span>`;
}

row.innerHTML = `
    ...
    <td style="color:#fff; font-family:Consolas;">${timeStr}${expectedTimeDisplay}</td>
    ...
`;
```

**é¡¯ç¤ºç¯„ä¾‹**:
```
è¡¨å®šæ™‚é–“æ¬„ä½é¡¯ç¤º:
08:00
(é è¨ˆ 08:30)
```

### 3.3 æ’åºé‚è¼¯ä¿®æ­£
**ä½ç½®**: `updatePidsData()` å‡½å¼çš„æ’åºéƒ¨åˆ† (ç¬¬ 709-718 è¡Œ)

**ä¿®æ”¹å…§å®¹**:
```javascript
// 2. åŠ ä¸Šèª¤é»æ™‚é–“ï¼ˆåœé§›åˆ—è»Šä¸è¨ˆç®—èª¤é»ï¼‰
const isCancelled = (String(t.TrainStatus) === '2' || t.TrainStatus === 2);
if (!isCancelled) {
    mins += parseInt(t.DelayTime || t.Delay || 0);
}
```

**æ•ˆæœ**: èˆ‡ tra_liveboard.html ä¸€è‡´çš„æ’åºé‚è¼¯

---

## 4. è·¨æ—¥æ’åºé‚è¼¯è©³ç´°èªªæ˜

### å•é¡ŒèƒŒæ™¯
åœ¨å‡Œæ™¨æ™‚æ®µ (00:00 ~ 06:00)ï¼Œç³»çµ±éœ€è¦é¡¯ç¤ºï¼š
- å‰ä¸€å¤©æ™šç­è»Š (å¦‚ 23:50)
- ç•¶å¤©æ—©ç­è»Š (å¦‚ 00:10, 01:00 ç­‰)

å¦‚æœä¸åšç‰¹æ®Šè™•ç†ï¼Œ00:10 æœƒè¢«æ’åœ¨ 23:50 å‰é¢ï¼Œé€ æˆä¹˜å®¢å›°æƒ‘ã€‚

### è§£æ±ºæ–¹æ¡ˆ
ç•¶ `currentHour < 6` ä¸”åˆ—è»Šè¡¨å®šæ™‚é–“ `h < 9` æ™‚ï¼Œçµ¦è©²åˆ—è»Šçš„æ’åºæ¬Šé‡ +1440 åˆ†é˜ï¼ˆ24 å°æ™‚ï¼‰ã€‚

### å…·é«”ç¯„ä¾‹

**æ—©ä¸Š 01:30 æŸ¥è©¢æ™‚**:
```
è¡¨å®šæ™‚é–“  åŸå§‹æ¬Šé‡  å‡Œæ™¨èª¿æ•´  èª¤é»åŠ æ¬Š    æœ€çµ‚æ¬Šé‡  é¡¯ç¤ºé †åº
23:50      1430    ç„¡èª¿æ•´    +10        1440     1ï¸âƒ£ ç¬¬ä¸€
00:10         10   +1440      0         1450     2ï¸âƒ£ ç¬¬äºŒ
01:00        60   +1440      0         1500     3ï¸âƒ£ ç¬¬ä¸‰
02:00       120   +1440      0         1560     4ï¸âƒ£ ç¬¬å››
```

### æ’åºé‚è¼¯ç¨‹å¼ç¢¼
```javascript
const getActualMinutes = (t) => {
    const timeStr = t.ScheduledDepartureTime || t.DepartureTime || "00:00";
    const [h, m] = timeStr.split(':').map(Number);
    let mins = h * 60 + m;
    
    const currentHour = new Date().getHours();
    
    // å‡Œæ™¨æ—©ç­è»Šèª¿æ•´
    if (currentHour < 6 && h < 9) {
        mins += 1440;  // +24 å°æ™‚
    }
    
    // åœé§›åˆ—è»Šä¸åŠ èª¤é»
    const isCancelled = (String(t.TrainStatus) === '2' || t.TrainStatus === 2);
    if (!isCancelled) {
        mins += parseInt(t.DelayTime || 0);
    }
    
    // æ˜æ—¥ç­æ¬¡æ¬Šé‡æœ€é‡
    if (t.IsTomorrow) mins += 1440;
    
    return mins;
};
```

---

## 5. åœé§›åˆ—è»Šè™•ç†

### è­˜åˆ¥æ–¹å¼
```javascript
const isCancelled = (String(train.TrainStatus) === '2' || train.TrainStatus === 2);
```

### è¦–è¦ºå€åˆ†
1. **tra_liveboard.html**:
   - åˆ—è»Šå¡ç‰‡å¥—ç”¨ `.train-cancelled-row` é¡åˆ¥
   - ç°åº¦æ¿¾é¡ + 60% é€æ˜åº¦
   - ç‹€æ…‹æ¬„é¡¯ç¤ºç´…è‰²"åœé§›"å¾½ç« 

2. **tra-pids.html**:
   - è¡¨æ ¼è¡Œå¥—ç”¨ `.train-cancelled-row` é¡åˆ¥
   - ç°åº¦æ¿¾é¡ + 60% é€æ˜åº¦
   - ç‹€æ…‹æ¬„é¡¯ç¤ºç´…è‰²"åœé§›"æ–‡å­—

### æ’åºæ¬Šé‡
åœé§›åˆ—è»Šåœ¨æ’åºæ™‚ **ä¸è¨ˆç®— DelayTime**ï¼Œä¿æŒè¡¨å®šæ™‚é–“çš„æ’åºé †åºã€‚

---

## 6. é¡¯ç¤ºæ•ˆæœå°æ¯”

### æƒ…å¢ƒï¼šæ—©ä¸Š 02:00ï¼ŒåŒ…å«å»¶é²å’Œåœé§›åˆ—è»Š

#### tra_liveboard.html (å³æ™‚çœ‹æ¿)
```
å—ä¸‹åˆ—è»Š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è‡ªå¼· 1234 å¾€ å°ä¸­                    â”‚
â”‚ 23:50                 æ™š 10 åˆ†        â”‚ â† å‰ä¸€å¤©çš„è»Šï¼Œèª¤é» 10 åˆ†
â”‚ é è¨ˆ 00:00 â† äº®é’è‰²é¡¯ç¤º              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å€é–“ 1235 å¾€ è±åŸ      [ç°è‰²åˆ—è»Šå¡]  â”‚
â”‚ 00:15                 ğŸš« åœé§›        â”‚ â† ä»Šå¤©çš„åœé§›è»Š
â”‚                       [ç°éšé¡¯ç¤º]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è‡ªå¼· 1236 å¾€ èŠ±è“®                    â”‚
â”‚ 00:30                 æ™š 30 åˆ†        â”‚
â”‚ é è¨ˆ 01:00 â† äº®é’è‰²é¡¯ç¤º              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### tra-pids.html (å…¨è¢å¹• PIDS)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è»Šæ¬¡   â”‚ è»Šç¨®    â”‚ é–‹å¾€      â”‚ æ™‚é–“ â”‚ ç‹€æ…‹    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1234   â”‚ è‡ªå¼·    â”‚ å°ä¸­      â”‚ 23:50â”‚ æ™š 10 åˆ†â”‚
â”‚        â”‚         â”‚           â”‚(é è¨ˆ  â”‚ â† è—è‰²â”‚
â”‚        â”‚         â”‚           â”‚00:00)â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1235   â”‚ å€é–“    â”‚ è±åŸ      â”‚ 00:15â”‚ åœé§›   â”‚ â† ç°éš
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1236   â”‚ è‡ªå¼·    â”‚ èŠ±è“®      â”‚ 00:30â”‚ æ™š 30 åˆ†â”‚
â”‚        â”‚         â”‚           â”‚(é è¨ˆ  â”‚ â† è—è‰²â”‚
â”‚        â”‚         â”‚           â”‚01:00)â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. ä¿®æ”¹æ¸…å–®

| æª”æ¡ˆ | ä½ç½® | ä¿®æ”¹é¡å‹ | è¡Œæ•¸ |
|-----|------|--------|------|
| tra_liveboard.html | 404-410 | CSS æ–°å¢ | +7 |
| tra_liveboard.html | 845-852 | å‡½å¼æ–°å¢ | +8 |
| tra_liveboard.html | 805-826 | é‚è¼¯ä¿®æ”¹ | +4 |
| tra_liveboard.html | 752-754 | é‚è¼¯ä¿®æ”¹ | +1 |
| tra-pids.html | 364-370 | CSS æ–°å¢ | +7 |
| tra-pids.html | 614-621 | å‡½å¼æ–°å¢ | +8 |
| tra-pids.html | 797-810 | é‚è¼¯ä¿®æ”¹ | +5 |
| tra-pids.html | 709-718 | é‚è¼¯ä¿®æ”¹ | +1 |

**ç¸½è¨ˆ**: 8 å€‹ä½ç½®ï¼Œ~41 è¡Œä»£ç¢¼æ–°å¢/ä¿®æ”¹

---

## 8. é©—è­‰æ¸…å–®

- [x] å…©å€‹æª”æ¡ˆç„¡ JavaScript èªæ³•éŒ¯èª¤
- [x] `getExpectedTime()` å‡½å¼åœ¨å…©å€‹æª”æ¡ˆä¸­éƒ½å¯¦ç¾
- [x] CSS æ¨£å¼åœ¨å…©å€‹æª”æ¡ˆä¸­éƒ½æ–°å¢
- [x] é è¨ˆæ™‚é–“åœ¨æœ‰èª¤é»æ™‚æ­£ç¢ºè¨ˆç®—å’Œé¡¯ç¤º
- [x] åœé§›åˆ—è»Šæ’åºä¸è¨ˆç®—èª¤é»
- [x] å‡Œæ™¨æ™‚æ®µæ’åºæ¬Šé‡æ­£ç¢ºèª¿æ•´
- [x] åˆ—è»Šå¡ç‰‡å’Œè¡¨æ ¼è¡Œéƒ½å¥—ç”¨äº†åœé§›æ¨£å¼
- [x] é¡è‰²æ–¹æ¡ˆä¸€è‡´ï¼ˆé’è‰²/è—è‰²ç”¨æ–¼é è¨ˆæ™‚é–“ï¼Œç´…è‰²ç”¨æ–¼åœé§›ï¼‰

---

## 9. å¾ŒçºŒæ¸¬è©¦å»ºè­°

### åŠŸèƒ½æ¸¬è©¦
1. **é è¨ˆæ™‚é–“è¨ˆç®—**
   - æ¸¬è©¦å„ç¨®èª¤é»æ™‚é–“ (1åˆ†ã€30åˆ†ã€180åˆ†ç­‰)
   - é©—è­‰è·¨å°æ™‚çš„è¨ˆç®— (23:50 + 45åˆ† = 00:35)

2. **è·¨æ—¥æ’åº**
   - åœ¨å‡Œæ™¨ 01:00-05:00 æ™‚é–“æ®µæ¸¬è©¦
   - é©—è­‰å‰ä¸€å¤© 23:xx åˆ—è»Šæ’åœ¨ä»Šå¤© 00:xx-08:xx å‰é¢

3. **åœé§›åˆ—è»Š**
   - é©—è­‰åœé§›åˆ—è»Šé¡¯ç¤ºæ­£ç¢ºçš„è¦–è¦ºæ¨£å¼
   - ç¢ºèªåœé§›åˆ—è»Šçš„æ’åºä¸å—èª¤é»å½±éŸ¿

### æ€§èƒ½æ¸¬è©¦
- æª¢æŸ¥å¤§é‡åˆ—è»Š (50+ åˆ—) æ™‚çš„æ’åºæ•ˆèƒ½
- é©—è­‰ DOM æ“ä½œåœ¨ PIDS å…¨è¢å¹•é¡¯ç¤ºä¸­çš„æµæš¢åº¦

### è¦–è¦ºå›æ­¸æ¸¬è©¦
- é©—è­‰ç¾æœ‰çš„å…¶ä»–åˆ—è»Šç‹€æ…‹é¡¯ç¤ºä¸å—å½±éŸ¿
- æª¢æŸ¥æ·±è‰²æ¨¡å¼ä¸‹çš„é¡è‰²å°æ¯”åº¦

---

## 10. å‘å¾Œå…¼å®¹æ€§

âœ… **å®Œå…¨å…¼å®¹**:
- ä½¿ç”¨é˜²å®ˆå¼ç·¨ç¨‹æª¢æŸ¥ `TrainStatus` æ¬„ä½
- è‹¥ç„¡ `TrainStatus` æˆ– `DelayTime`ï¼Œæœƒä½¿ç”¨é è¨­å€¼
- ä¸ä¿®æ”¹ HTML çµæ§‹ï¼Œåƒ…æ·»åŠ æ–°å…§å®¹
- CSS æ¨£å¼ç¨ç«‹ï¼Œä¸å½±éŸ¿ç¾æœ‰å…ƒç´ 

---

**æœ€å¾Œæ›´æ–°**: 2025å¹´12æœˆ7æ—¥  
**é–‹ç™¼ç’°å¢ƒ**: VS Code, PowerShell  
**ç‰ˆæœ¬**: 1.0 å®Œå…¨å¯¦ç¾ç‰ˆæœ¬
