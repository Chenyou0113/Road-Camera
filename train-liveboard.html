<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµå³æ™‚çœ‹æ¿ - çœŸå¯¦åˆ—è»Šå‹•æ…‹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <script>window.CURRENT_PAGE = 'train-liveboard';</script>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script src="assets/train-line-classification.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #3575ff 0%, #15bbd8 100%); 
            min-height: 100vh; 
            padding-bottom: 80px;
        }
        
        .header { 
            background: white; 
            padding: 20px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 20px; 
        }
        
        .header h1 { 
            color: #D84315; 
            text-align: center; 
            margin-bottom: 10px; 
        }
        
        .back-btn { 
            display: inline-block; 
            padding: 10px 20px; 
            background: #016d68; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px; 
            margin: 20px 0; 
            transition: background 0.3s;
        }
        
        .back-btn:hover { 
            background: #034d64; 
        }
        
        .control-panel { 
            background: linear-gradient(135deg, rgba(53, 134, 255, 0.9) 0%, rgba(21, 144, 216, 0.9) 100%);
            margin: 20px 0; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,107,53,0.5);
        }
        
        .control-panel h3 { 
            color: white; 
            margin-bottom: 20px; 
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .selector-row { 
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 15px; 
            align-items: end;
        }
        
        .selector-group { 
            display: flex; 
            flex-direction: column; 
        }
        
        .selector-group label { 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: white; 
            font-size: 0.95rem;
        }
        
        .selector-group select { 
            padding: 12px 15px; 
            border-radius: 10px; 
            border: 2px solid rgba(255,255,255,0.3); 
            background: white;
            color: #333;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .selector-group input { 
            padding: 12px 15px; 
            border-radius: 10px; 
            border: 2px solid rgba(255,255,255,0.3); 
            background: white;
            color: #333;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .selector-group input:focus { 
            outline: none;
            border-color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.95);
        }
        
        .selector-group input::placeholder {
            color: #999;
        }
        
        .query-btn {
            padding: 12px 30px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .query-btn:hover { 
            background: #45a049; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        .query-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* åˆ—è»Šåˆ—è¡¨å®¹å™¨ */
        .train-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 20px 0;
        }
        
        .board-header {
            background: linear-gradient(135deg, #FF6B35 0%, #D84315 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .board-title h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .board-info {
            font-size: 0.9rem;
            opacity: 0.9;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .sync-time {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }
        
        .direction-section {
            border-bottom: 2px solid #eee;
        }
        
        .direction-section:last-child {
            border-bottom: none;
        }
        
        .direction-header {
            background: #f5f5f5;
            padding: 15px 20px;
            font-weight: 600;
            color: #333;
            border-left: 4px solid #FF6B35;
            font-size: 1.05rem;
        }
        
        .train-card {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
        }
        
        .train-card:hover {
            background: #f9f9f9;
        }
        
        .train-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .train-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* ğŸ”´ è‡ªå¼·è¨Šç³» */
        .type-è‡ªå¼· { background-color: #FF5722; } /* ä¸€èˆ¬è‡ªå¼· (æ©˜) */
        .type-è‡ªå¼·3000 { background: linear-gradient(135deg, #000000 0%, #333333 100%); border: 1px solid #666; } /* EMU3000 (é»‘/æ·±ç°) */
        .type-æ™®æ‚ ç‘ª { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); } /* æ™®æ‚ ç‘ª (æ¡ƒç´…) */
        .type-å¤ªé­¯é–£ { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); } /* å¤ªé­¯é–£ (ç´«) */
        
        /* ğŸŸ  è’å…‰è¨Šç³» */
        .type-è’å…‰ { background-color: #FF9800; } /* è’å…‰ (æ©™é»ƒ) */
        .type-è§€å…‰ { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); border: 1px dashed #fff; } /* é³³æ—¥/éƒµè¼ªå¼ */
        
        /* ğŸ”µ å€é–“è»Šç³» */
        .type-å€é–“å¿« { background-color: #3F51B5; } /* å€é–“å¿« (æ·±è—) */
        .type-å€é–“ { background-color: #2196F3; } /* å€é–“ (è—) */
        .type-å¾©èˆˆ { background-color: #00BCD4; } /* å¾©èˆˆ (é’) */
        .type-æ™®å¿« { background-color: #009688; } /* æ™®å¿« (æ·±ç¶ ) */
        
        /* âšª å…¶ä»– */
        .type-å…¶ä»– { background-color: #607D8B; }
        
        .train-destination {
            flex-grow: 1;
        }
        
        .train-no {
            font-weight: bold;
            color: #333;
            margin-right: 8px;
        }
        
        .destination {
            color: #666;
            font-size: 0.95rem;
        }
        
        .schedule-time {
            text-align: center;
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }
        
        .schedule-label {
            font-size: 0.75rem;
            color: #999;
            margin-top: 2px;
        }
        
        .delay-status {
            text-align: center;
            min-width: 80px;
        }
        
        .delay-badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .delay-ok {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        
        .delay-warn {
            background-color: #FFEBEE;
            color: #C62828;
        }
        
        .delay-cancel {
            background-color: #F3E5F5;
            color: #6A1B9A;
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .no-data i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1024px) {
            .selector-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .train-card {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .selector-row {
                grid-template-columns: 1fr;
            }
            
            .train-card {
                grid-template-columns: 1fr;
            }
            
            .train-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .board-info {
                flex-direction: column;
                gap: 10px;
            }
        }        /* åŠ è¼‰å‹•ç•« */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF6B35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* =========================================
           âœ¨ çœŸæ­£çš„æ·±è‰²æ¨¡å¼ (Real Dark Mode) 
           ========================================= */
        
        /* 1. å…¨å±€èƒŒæ™¯èˆ‡æ–‡å­— */
        body.dark-mode {
            background: #121212; /* æ¥µè‡´é»‘èƒŒæ™¯ */
            color: #e0e0e0;
        }

        /* 2. é ‚éƒ¨å°è¦½åˆ— (åŸæœ¬æ˜¯ç™½è‰²) */
        body.dark-mode .header {
            background: #1e1e1e; /* æ·±ç° */
            border-bottom: 1px solid #333;
        }
        body.dark-mode .header h1 { color: #ffab91; } /* æ¨™é¡Œæ”¹ç‚ºæŸ”å’Œæ©˜ */
        body.dark-mode .header p { color: #b0bec5; }

        /* 3. æ§åˆ¶é¢æ¿ (åŸæœ¬æ˜¯äº®è—è‰²æ¼¸å±¤ -> æ”¹ç‚ºæ·±è‰²å¡ç‰‡) */
        body.dark-mode .control-panel {
            background: #1e1e1e;
            border: 1px solid #333;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        body.dark-mode .control-panel h3 { color: #90caf9; } /* æ¨™é¡Œæ”¹ç‚ºæŸ”å’Œè— */
        body.dark-mode .selector-group label { color: #cfd8dc; }

        /* è¼¸å…¥æ¡†èˆ‡ä¸‹æ‹‰é¸å–® (åŸæœ¬æ˜¯ç™½è‰² -> æ”¹ç‚ºæ·±ç°åº•ç™½å­—) */
        body.dark-mode select, 
        body.dark-mode input {
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: #fff;
        }
        body.dark-mode select:focus, 
        body.dark-mode input:focus {
            border-color: #90caf9;
            background-color: #383838;
        }

        /* 4. åˆ—è»Šåˆ—è¡¨å®¹å™¨ (åŸæœ¬æ˜¯ç™½è‰² -> æ”¹ç‚ºæ·±è‰²) */
        body.dark-mode .train-container {
            background: #1e1e1e;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        /* çœ‹æ¿æ¨™é¡Œå€å¡Š (æ©˜è‰²æ¼¸å±¤ -> ç¨å¾®èª¿æš—ï¼Œé¿å…å¤ªåˆºçœ¼) */
        body.dark-mode .board-header {
            background: linear-gradient(135deg, #bf360c 0%, #d84315 100%);
            border-bottom: 1px solid #333;
        }
        body.dark-mode .board-info { color: rgba(255,255,255,0.85); }

        /* æ–¹å‘åˆ†éš”æ¢ (é †è¡Œ/é€†è¡Œ) */
        body.dark-mode .direction-header {
            background-color: #263238; /* æ·±è—ç° */
            color: #eceff1;
            border-bottom: 1px solid #37474f;
            border-left-color: #ff7043;
        }

        /* 5. åˆ—è»Šå¡ç‰‡ (åŸæœ¬æ˜¯ç™½è‰² -> æ”¹ç‚ºæ·±è‰²) */
        body.dark-mode .train-card {
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
        }
        
        /* æ»‘é¼ ç§»éå»çš„æ•ˆæœ (Hover) */
        body.dark-mode .train-card:hover {
            background-color: #2c2c2c;
        }

        /* åˆ—è»Šè©³ç´°è³‡è¨Šæ–‡å­—é¡è‰² */
        body.dark-mode .train-no { color: #fff; } /* è»Šæ¬¡ç™½å­— */
        body.dark-mode .destination { color: #b0bec5; } /* çµ‚é»ç«™æ·ºç° */
        body.dark-mode .schedule-time { color: #fff; } /* æ™‚é–“ç™½å­— */
        body.dark-mode .schedule-label { color: #78909c; } /* "è¡¨å®š"å…©å­—æ·±ç° */

        /* 6. ç‹€æ…‹æ¨™ç±¤å„ªåŒ– (æº–é»/èª¤é» -> é™ä½äº®åº¦èˆ‡é£½å’Œåº¦) */
        body.dark-mode .delay-ok {
            background-color: rgba(76, 175, 80, 0.15); /* æ·±ç¶ èƒŒæ™¯é€æ˜ */
            color: #81c784; /* æ·ºç¶ å­— */
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        body.dark-mode .delay-warn {
            background-color: rgba(244, 67, 54, 0.15); /* æ·±ç´…èƒŒæ™¯é€æ˜ */
            color: #e57373; /* æ·ºç´…å­— */
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        /* 7. ç„¡è³‡æ–™ç‹€æ…‹ */
        body.dark-mode .no-data {
            color: #757575;
        }
        body.dark-mode .no-data i {
            opacity: 0.3;
        }

        /* === âœ¨ æ–°å¢ï¼šè³‡æ–™æº–ç¢ºæ€§å…è²¬è²æ˜æ¨£å¼ === */
        .data-disclaimer {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .data-disclaimer i {
            font-size: 1.2rem;
            color: #856404;
            margin-top: 2px;
        }

        /* æ·±è‰²æ¨¡å¼é©é… */
        body.dark-mode .data-disclaimer {
            background-color: #2c2208; /* æ·±å’–å•¡è‰²èƒŒæ™¯ */
            color: #ffecb3; /* æ·ºé»ƒè‰²æ–‡å­— */
            border-color: #443610;
        }
        
        body.dark-mode .data-disclaimer i {
            color: #ffc107; /* äº®é»ƒè‰²åœ–ç¤º */
        }

        /* === å°éµå…¬å‘Šæ¨£å¼ === */
        .info-panel {
            background: #fff3e0; /* æ·ºæ©˜è‰²èƒŒæ™¯ */
            border-left: 5px solid #ff9800; /* æ©˜è‰²é‚Šæ¡† */
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .info-panel h3 {
            color: #e65100;
            margin-bottom: 15px;
            display: flex;
            align-items: baseline;
        }

        .news-item {
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .news-item:last-child { border-bottom: none; }

        .news-title {
            font-weight: bold;
            color: #bf360c;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .news-desc {
            color: #5d4037;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .news-time {
            font-size: 0.85rem;
            color: #8d6e63;
            margin-top: 5px;
        }

        /* æ·±è‰²æ¨¡å¼é©é… */
        body.dark-mode .info-panel {
            background: #3e2723; /* æ·±å’–å•¡è‰² */
            border-left-color: #ffb74d;
        }
        body.dark-mode .info-panel h3 { color: #ffcc80; }
        body.dark-mode .news-item { border-bottom-color: rgba(255,255,255,0.1); }
        body.dark-mode .news-title { color: #ffab91; }
        body.dark-mode .news-desc { color: #d7ccc8; }
        body.dark-mode .news-time { color: #a1887f; }

        /* === å°éµè·‘é¦¬ç‡ˆæ¨£å¼ (æ·ºè‰²/æ·±è‰²è‡ªå‹•åˆ‡æ›ç‰ˆ) === */
        .tra-marquee {
            /* â˜€ï¸ æ·ºè‰²æ¨¡å¼é è¨­å€¼ï¼šç™½åº•ã€æ·±ç°å­— */
            background: #ffffff;
            color: #333333;
            border: 1px solid #e0e0e0; /* æ·ºç°é‚Šæ¡† */
            
            display: flex;
            align-items: center;
            padding: 12px 20px;
            font-size: 1.1rem; /* å­—é«”å¤§å°å¾®èª¿ */
            font-weight: 600;
            font-family: 'Microsoft JhengHei', sans-serif;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); /* é™°å½±è®Šæ·¡ */
            
            position: relative;
            min-height: 60px;
            width: 100%;
            transition: background 0.3s, color 0.3s; /* åŠ å…¥åˆ‡æ›æ¨¡å¼çš„éæ¸¡å‹•ç•« */
        }

        /* æ·ºè‰²æ¨¡å¼ä¸‹çš„åœ–ç¤ºé¡è‰² (æ·±æ©˜è‰²ï¼Œå°æ¯”åº¦è¼ƒé«˜) */
        .marquee-icon {
            margin-right: 15px;
            color: #e65100;
            font-size: 1.4rem;
            animation: flash 2s infinite;
            flex-shrink: 0;
        }

        /* ğŸŒ™ æ·±è‰²æ¨¡å¼è¦†å¯« (ç¶­æŒåŸæœ¬çš„ LED é¢¨æ ¼ï¼šé»‘åº•é»ƒå­—) */
        body.dark-mode .tra-marquee {
            background: #212121; /* æ·±ç°/é»‘åº• */
            color: #ffeb3b;      /* äº®é»ƒå­— */
            border-color: #424242;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹çš„åœ–ç¤ºé¡è‰² (äº®æ©˜è‰²) */
        body.dark-mode .marquee-icon {
            color: #ff9800;
        }

        /* --- ä»¥ä¸‹æ˜¯ä¿®å¾©è·‘é¦¬ç‡ˆä¸æœƒå‹•çš„é—œéµçµæ§‹ (ç§»é™¤ flex) --- */
        .marquee-wrapper {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            margin-left: 15px;
            position: relative;
            height: 100%;
            /* âŒ ç§»é™¤ display: flex; ç¢ºä¿å‹•ç•«æ­£å¸¸ */
        }

        .marquee-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: marquee 25s linear infinite;
            line-height: 1.5; /* èª¿æ•´è¡Œé«˜ä»¥å‚ç›´ç½®ä¸­ */
            
            /* è®“æ–‡å­—å‚ç›´ç½®ä¸­çš„å°æŠ€å·§ (å› ç‚ºå¤–å±¤ç§»é™¤äº† flex) */
            position: relative;
            top: 2px;
        }

        .marquee-content span {
            margin-right: 80px; /* å…¬å‘Šä¹‹é–“çš„é–“è· */
        }

        /* å‹•ç•«å®šç¾© */
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* æ»‘é¼ ç§»ä¸Šå»æš«åœ */
        .tra-marquee:hover .marquee-content {
            animation-play-state: paused;
        }

        /* æ‰‹æ©Ÿç‰ˆé©é… */
        @media (max-width: 768px) {
            .tra-marquee {
                font-size: 0.95rem;
                padding: 10px;
                min-height: 50px;
            }
            .marquee-icon {
                font-size: 1.1rem;
                margin-right: 8px;
            }
            /* æ‰‹æ©Ÿç‰ˆè¡Œé«˜å¾®èª¿ */
            .marquee-content {
                top: 4px;
            }
        }

        /* === åˆ—è»Šåœé ç«™è·‘é¦¬ç‡ˆæ¨£å¼ (ä»¿å°éµ LED) === */
        .marquee-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: #000000;
            color: #ff3d00; /* å°éµç¶“å…¸ç´…æ©˜è‰² */
            display: flex;
            align-items: center;
            z-index: 9999;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
            border-top: 2px solid #333;
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        /* å·¦å´å›ºå®šè³‡è¨Š (è»Šæ¬¡) */
        .marquee-info {
            background: #1a1a1a;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 15px;
            min-width: 100px;
            border-right: 1px solid #333;
            z-index: 2;
            flex-shrink: 0;
        }

        .marquee-train-no {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ffeb3b; /* é»ƒè‰²è»Šæ¬¡ */
        }

        .marquee-dest {
            font-size: 0.85rem;
            color: #fff;
        }

        /* è·‘é¦¬ç‡ˆæ²å‹•å€ */
        .marquee-content-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .marquee-content {
            position: absolute;
            white-space: nowrap;
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 2px;
            animation: marquee-scroll 45s linear infinite;
            will-change: transform;
            padding-right: 50px;
        }

        /* åœé ç«™æ–‡å­—é¡è‰² */
        .station-stop { color: #ff3d00; }
        .station-arrow { color: #00e676; margin: 0 5px; font-size: 1rem; } /* ç¶ è‰²ç®­é ­ */

        /* é—œé–‰æŒ‰éˆ• */
        .marquee-close {
            background: #333;
            border: none;
            color: white;
            width: 40px;
            height: 100%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 2;
        }
        .marquee-close:hover { background: #555; }

        /* è·‘é¦¬ç‡ˆæ²å‹•å‹•ç•« */
        @keyframes marquee-scroll {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }

        /* æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
        @media (max-width: 768px) {
            .marquee-bar { height: 50px; }
            .marquee-content { font-size: 1.1rem; }
            .marquee-info { padding: 0 10px; min-width: 80px; }
            body { padding-bottom: 70px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é </a>
            <h1><i class="fas fa-train"></i> å°éµå³æ™‚çœ‹æ¿</h1>
            <p style="text-align: center; color: #666; font-size: 0.95rem;">
                å…¨å°éµè·¯å³æ™‚åˆ—è»Šå‹•æ…‹ã€èª¤é»è³‡è¨ŠæŸ¥è©¢
            </p>
        </div>
    </div>

    <div class="container">
        <!-- âœ¨ æ–°å¢ï¼šå°éµç‡Ÿé‹é€šé˜»å…¬å‘Š -->
        <div class="info-panel rail-news" id="traAlertPanel" style="display: none;">
            <h3>
                <span><i class="fas fa-bullhorn"></i> å°éµç‡Ÿé‹é€šé˜»</span>
                <small style="font-size: 0.8rem; margin-left: 10px; font-weight: normal;">(è¿‘ 5 ç­†)</small>
            </h3>
            <div id="traAlertContent" class="news-content">
                <!-- å…¬å‘Šå…§å®¹å°‡ç”± JS å‹•æ…‹æ’å…¥ -->
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <h3>
                <i class="fas fa-search"></i> æŸ¥è©¢å³æ™‚çœ‹æ¿
            </h3>
            <div class="selector-row">
                <div class="selector-group">
                    <label for="lineSelect">è·¯ç·šåˆ†é¡</label>
                    <select id="lineSelect" onchange="filterStations()">
                        <option value="all">å…¨éƒ¨è·¯ç·š</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label for="stationSearch">æœå°‹è»Šç«™</label>
                    <input type="text" id="stationSearch" placeholder="è¼¸å…¥ç«™åæˆ–ä»£ç¢¼ (å¦‚: å°åŒ—, 1000)" oninput="filterStations()">
                </div>
                <div class="selector-group">
                    <label for="stationSelect">é¸æ“‡è»Šç«™</label>
                    <select id="stationSelect">
                        <option value="">è«‹é¸æ“‡è»Šç«™...</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label for="directionFilter">æ–¹å‘</label>
                    <select id="directionFilter">
                        <option value="">å…¨éƒ¨</option>
                        <option value="0">é †è¡Œ</option>
                        <option value="1">é€†è¡Œ</option>
                    </select>
                </div>
                <button class="query-btn" id="queryBtn" onclick="fetchTrainLiveBoard()">
                    <i class="fas fa-sync-alt"></i> æŸ¥è©¢
                </button>
            </div>
        </div>

        <!-- âœ¨ 1. å°éµé¢¨æ ¼è·‘é¦¬ç‡ˆ (å³æ™‚å…¬å‘Š) -->
        <div class="tra-marquee">
            <div class="marquee-icon"><i class="fas fa-bell"></i></div>
            <div class="marquee-wrapper">
                <div class="marquee-content" id="marqueeText">
                    <!-- é è¨­å…§å®¹ï¼ŒJS è¼‰å…¥å¾Œæœƒè¦†è“‹ -->
                    <span>æ­¡è¿æ­ä¹˜å°éµã€‚æœ¬çœ‹æ¿è³‡æ–™ç”± TDX æä¾›ï¼Œåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›é‹è¡Œè«‹ä»¥è»Šç«™ç¾å ´ç‚ºä¸»ã€‚</span>
                </div>
            </div>
        </div>

        <!-- âœ¨ 2. å°éµè³‡æ–™èªªæ˜èˆ‡å…è²¬è²æ˜ -->
        <div class="data-disclaimer">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>âš ï¸ æ³¨æ„äº‹é …ï¼š</strong>
                æœ¬çœ‹æ¿è³‡æ–™ä¾†æºç‚º TDX å¹³å°åŠ å€¼é‹ç®—ï¼Œèˆ‡è‡ºéµå®˜ç¶²ä¸€è‡´ä½†ç´„æœ‰ <strong>2 åˆ†é˜å»¶é²</strong>ã€‚
                æ­¤è³‡æ–™éç›´æ¥ä»‹æ¥è»Šç«™ç¾å ´ç³»çµ±ï¼Œè«‹å‹¿ç›´æ¥èˆ‡æœˆå° TIDS çœ‹æ¿æ¯”å°ã€‚
                <br>
                <span style="font-size: 0.85em; opacity: 0.9;">
                    (è‹¥æ‚¨å·²é€²å…¥è»Šç«™ï¼Œè«‹ä»¥è»Šç«™å¤§å»³æˆ–æœˆå°ä¸Šçš„é¡¯ç¤ºå™¨è³‡è¨Šç‚ºä¸»ï¼Œä»¥å…å»¶èª¤è¡Œç¨‹ã€‚)
                </span>
            </div>
        </div>

        <!-- åˆ—è»Šçœ‹æ¿ -->
        <div id="trainContainer" class="train-container" style="display: none;">
            <div class="board-header">
                <div class="board-title">
                    <h2 id="stationTitle">å°éµå³æ™‚çœ‹æ¿</h2>
                    <div class="board-info">
                        <span id="stationInfo">é¸æ“‡è»Šç«™é€²è¡ŒæŸ¥è©¢</span>
                        <span class="sync-time">
                            <i class="fas fa-clock"></i> 
                            <span id="updateTime">--:--:--</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <div id="trainsBoard">
                <div class="no-data">
                    <i class="fas fa-inbox"></i>
                    <p>è«‹é¸æ“‡è»Šç«™æŸ¥è©¢</p>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ¨ æ–°å¢ï¼šåº•éƒ¨åˆ—è»Šåœé ç«™è·‘é¦¬ç‡ˆ -->
    <div id="trainMarqueeBar" class="marquee-bar" style="display: none;">
        <div class="marquee-info">
            <span class="marquee-train-no" id="mqTrainNo"></span>
            <span class="marquee-dest" id="mqDest"></span>
        </div>
        <div class="marquee-content-wrapper">
            <div class="marquee-content" id="mqContent">
                <!-- é€™è£¡æœƒå‹•æ…‹å¡«å…¥åœé ç«™ -->
            </div>
        </div>
        <button class="marquee-close" onclick="closeMarquee()">Ã—</button>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        // ============ å…¨å±€è®Šæ•¸ ============
        let currentStationID = '';
        let currentStationName = '';
        let allStationsFlat = []; // æ‰å¹³åŒ–çš„æ‰€æœ‰è»Šç«™åˆ—è¡¨

        // ============ âœ¨ æ–°å¢ï¼šåˆ—è»Šè»Šç¨®è©³ç´°å°ç…§è¡¨ (ä¾†æºï¼šå®Œæ•´è³‡æ–™) ============
        const TRAIN_TYPE_DB = [
          { "id": "1100", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1101", "name": "å¤ªé­¯é–£", "code": "1" },
          { "id": "1102", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1103", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1107", "name": "æ™®æ‚ ç‘ª", "code": "2" },
          { "id": "1108", "name": "è‡ªå¼·", "code": "3" },
          { "id": "110G", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "110H", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "110K", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "110M", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "1110", "name": "è’å…‰", "code": "4" },
          { "id": "1111", "name": "è’å…‰", "code": "4" },
          { "id": "1114", "name": "è’å…‰", "code": "4" },
          { "id": "1115", "name": "è’å…‰", "code": "4" },
          { "id": "1120", "name": "å¾©èˆˆ", "code": "5" },
          { "id": "1131", "name": "å€é–“", "code": "6" },
          { "id": "1132", "name": "å€é–“å¿«", "code": "6" },
          { "id": "1140", "name": "æ™®å¿«", "code": "7" }
        ];

        // å»ºç«‹å¿«é€Ÿæœå°‹ Map
        const trainTypeMap = new Map();
        TRAIN_TYPE_DB.forEach(item => {
            trainTypeMap.set(item.id, item.name);
        });

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš‚ å°éµå³æ™‚çœ‹æ¿é é¢å·²åŠ è¼‰ (V2 API) - æ•´åˆæœå°‹èˆ‡åˆ†é¡ç³»çµ±');
            initStationControls();
            
            // âœ¨ å‘¼å«è¼‰å…¥å…¬å‘Š
            loadTraAlerts();
        });

        // ============ âœ¨ æ–°å¢ï¼šè¼‰å…¥å°éµç‡Ÿé‹é€šé˜» ============
        // âœ¨ æ›´æ–°ï¼šè¼‰å…¥å°éµç‡Ÿé‹é€šé˜» (é©é… V3 Alert API)
        // âœ¨ ä¿®æ­£ç‰ˆï¼šè¼‰å…¥å°éµç‡Ÿé‹é€šé˜» (ç§»é™¤ CONFIG ä¾è³´ï¼Œå¢å¼·å®¹éŒ¯)
        async function loadTraAlerts() {
            try {
                // ç›´æ¥å®šç¾© API è·¯å¾‘
                const endpoint = '/v3/Rail/TRA/Alert?$format=JSON&$top=5&$orderby=PublishTime%20desc';
                
                // ä½¿ç”¨ tdxApi.fetch (å®ƒæœƒè‡ªå‹•è™•ç† Token å’Œ Base URL)
                const response = await tdxApi.fetch(endpoint);

                const panel = document.getElementById('traAlertPanel');
                const content = document.getElementById('traAlertContent');
                const marqueeEl = document.getElementById('marqueeText');

                // è§£æè³‡æ–™çµæ§‹ (V3 API å›å‚³çš„æ˜¯ { Alerts: [...] })
                let alertList = [];
                if (response && response.Alerts && Array.isArray(response.Alerts)) {
                    alertList = response.Alerts;
                } else if (Array.isArray(response)) {
                    alertList = response;
                }

                // å¦‚æœæ²’æœ‰å…¬å‘Š
                if (alertList.length === 0) {
                    if (panel) panel.style.display = 'none';
                    console.log('â„¹ï¸ å°éµç›®å‰ç„¡é‡å¤§ç‡Ÿé‹é€šé˜»');
                    return;
                }

                // === 1. æ›´æ–°è·‘é¦¬ç‡ˆå…§å®¹ ===
                if (marqueeEl) {
                    // 1. å…ˆæš«åœå‹•ç•«
                    marqueeEl.style.animation = 'none';
                    marqueeEl.offsetHeight; /* è§¸ç™¼ Reflow (é—œéµï¼šå¼·åˆ¶ç€è¦½å™¨é‡ç¹ª) */
                    
                    marqueeEl.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
                    
                    alertList.forEach(alert => {
                        const span = document.createElement('span');
                        // ç§»é™¤æ›è¡Œç¬¦è™Ÿï¼Œé¿å…è·‘é¦¬ç‡ˆæ–·è¡Œ
                        const cleanDesc = (alert.Description || '').replace(/[\r\n]+/g, ' ');
                        const scopeText = alert.Scope?.LineSections?.[0]?.Description 
                                        ? ` (${alert.Scope.LineSections[0].Description})` 
                                        : '';
                        
                        span.innerText = `ã€${alert.Title}ã€‘${cleanDesc}${scopeText}`;
                        marqueeEl.appendChild(span);
                    });
                    
                    // æœ€å¾Œè£œä¸Šå…è²¬è²æ˜
                    const footerSpan = document.createElement('span');
                    footerSpan.innerText = "âš ï¸ å¯¦éš›é‹è¡Œç‹€æ³è«‹ä»¥è»Šç«™ç¾å ´å…¬å‘Šç‚ºä¸»ã€‚";
                    marqueeEl.appendChild(footerSpan);
                    
                    // 2. é‡æ–°å•Ÿå‹•å‹•ç•«
                    marqueeEl.style.animation = 'marquee 25s linear infinite';
                }

                // === 2. æ›´æ–°å…¬å‘Šé¢æ¿å…§å®¹ (å¦‚æœæœ‰) ===
                if (panel && content) {
                    let html = '';
                    alertList.forEach(alert => {
                        // ç‹€æ…‹åˆ¤æ–· (Status: 0æ­£å¸¸, 1ä¸€èˆ¬, 2ç•°å¸¸/åš´é‡)
                        let icon = 'â„¹ï¸';
                        let titleColor = '#e65100';
                        if (alert.Status === 2 || alert.Level > 1) {
                            icon = 'ğŸš¨'; 
                            titleColor = '#d32f2f'; // ç´…è‰²
                        }

                        // æ™‚é–“æ ¼å¼åŒ–
                        const timeStr = new Date(alert.PublishTime).toLocaleString('zh-TW', {
                            month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                        });
                        
                        // å—å½±éŸ¿å€é–“
                        let scopeInfo = '';
                        if (alert.Scope && alert.Scope.LineSections && alert.Scope.LineSections.length > 0) {
                            const section = alert.Scope.LineSections[0];
                            scopeInfo = `<br><span style="color:#d84315; font-size:0.9rem;">ğŸ›‘ å—å½±éŸ¿å€é–“ï¼š${section.StartingStationName} â†” ${section.EndingStationName}</span>`;
                        }

                        html += `
                            <div class="news-item">
                                <div class="news-title" style="color: ${titleColor}">
                                    <span>${icon}</span>
                                    <span>${alert.Title}</span>
                                </div>
                                <div class="news-desc">
                                    ${(alert.Description || '').replace(/\n/g, '<br>')}
                                    ${scopeInfo}
                                </div>
                                <div class="news-time">
                                    <i class="far fa-clock"></i> ç™¼å¸ƒæ™‚é–“ï¼š${timeStr}
                                    ${alert.AlertURL ? ` | <a href="${alert.AlertURL}" target="_blank" style="color:#1e88e5;">è©³æƒ…é€£çµ</a>` : ''}
                                </div>
                            </div>
                        `;
                    });

                    content.innerHTML = html;
                    panel.style.display = 'block';
                }
                
                console.log('âœ… å°éµé€šé˜»å…¬å‘Šè¼‰å…¥æˆåŠŸ:', alertList.length, 'ç­†');

            } catch (error) {
                console.warn('âš ï¸ ç„¡æ³•è¼‰å…¥å°éµé€šé˜»å…¬å‘Š:', error);
                // å¤±æ•—æ™‚ä¿æŒéš±è—ï¼Œä¸å½±éŸ¿ä¸»åŠŸèƒ½
            }
        }

        // ============ 1. åˆå§‹åŒ–ï¼šè¼‰å…¥è·¯ç·šé¸å–® & å»ºç«‹æ‰å¹³åˆ—è¡¨ ============
        function initStationControls() {
            const lineSelect = document.getElementById('lineSelect');
            
            // æŒ‰å¤§åˆ†é¡åˆ†çµ„è·¯ç·š
            const categories = {};
            for (const [key, data] of Object.entries(trainLineClassification)) {
                const category = data.category || 'å…¶ä»–';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push({ key, ...data });
            }

            // å¡«å…¥è·¯ç·šé¸é …ï¼ˆæŒ‰åˆ†é¡åˆ†çµ„ï¼‰
            for (const [category, routes] of Object.entries(categories)) {
                if (Object.keys(categories).length > 1) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category;
                    
                    routes.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.key;
                        option.textContent = route.name;
                        optgroup.appendChild(option);
                    });
                    
                    lineSelect.appendChild(optgroup);
                } else {
                    routes.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.key;
                        option.textContent = route.name;
                        lineSelect.appendChild(option);
                    });
                }

                // å°‡æ‰€æœ‰è»Šç«™åŠ å…¥æ‰å¹³åˆ—è¡¨ (æ–¹ä¾¿æœå°‹)
                routes.forEach(route => {
                    route.stations.forEach(station => {
                        if (!allStationsFlat.find(s => s.code === station.code)) {
                            allStationsFlat.push({
                                code: station.code,
                                name: station.name,
                                lineKey: route.key
                            });
                        }
                    });
                });
            }
            
            // åˆå§‹é¡¯ç¤ºæ‰€æœ‰è»Šç«™
            filterStations();
        }

        // ============ 2. æ ¸å¿ƒç¯©é¸é‚è¼¯ (åŒæ™‚è™•ç†ã€Œè·¯ç·šã€èˆ‡ã€Œé—œéµå­—ã€) ============
        function filterStations() {
            const selectedLine = document.getElementById('lineSelect').value;
            const keyword = document.getElementById('stationSearch').value.toLowerCase().trim();
            
            let filtered = [];

            // ç¬¬ä¸€å±¤ï¼šè·¯ç·šéæ¿¾
            if (selectedLine === 'all') {
                // é¡¯ç¤ºæ‰€æœ‰è»Šç«™
                filtered = allStationsFlat;
            } else if (trainLineClassification[selectedLine]) {
                // åªé¡¯ç¤ºè©²è·¯ç·šçš„è»Šç«™
                filtered = trainLineClassification[selectedLine].stations.map(s => ({
                    code: s.code,
                    name: s.name,
                    lineKey: selectedLine
                }));
            }

            // ç¬¬äºŒå±¤ï¼šé—œéµå­—æœå°‹ (æ”¯æ´ç«™åæˆ–ä»£ç¢¼)
            if (keyword) {
                filtered = filtered.filter(s => 
                    s.name.includes(keyword) || 
                    s.code.includes(keyword)
                );
            }

            // æ¸²æŸ“çµæœ
            renderStationOptions(filtered);
        }

        // ============ 3. æ¸²æŸ“è»Šç«™é¸å–® ============
        function renderStationOptions(stations) {
            const select = document.getElementById('stationSelect');
            select.innerHTML = ''; // æ¸…ç©º

            if (stations.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.text = "æŸ¥ç„¡ç¬¦åˆè»Šç«™";
                select.add(option);
                return;
            }

            // é è¨­æç¤ºé¸é …
            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.text = `è«‹é¸æ“‡è»Šç«™ (${stations.length} å€‹çµæœ)`;
            select.add(defaultOpt);

            stations.forEach(s => {
                const option = document.createElement('option');
                option.value = s.code;
                option.text = `${s.code} - ${s.name}`;
                select.add(option);
            });
            
            // å¦‚æœåªæœ‰ä¸€å€‹çµæœï¼Œè‡ªå‹•é¸å–
            if (stations.length === 1) {
                select.selectedIndex = 1; // è·³éé è¨­é¸é …
            }
        }

        // ============ 4. æŸ¥è©¢å³æ™‚çœ‹æ¿ (ä½¿ç”¨ V2 API) ============
        async function fetchTrainLiveBoard() {
            const stationSelect = document.getElementById('stationSelect');
            const queryBtn = document.getElementById('queryBtn');
            currentStationID = stationSelect.value;

            if (!currentStationID) {
                alert('è«‹å…ˆé¸æ“‡è»Šç«™');
                return;
            }

            const selectedOption = stationSelect.options[stationSelect.selectedIndex];
            currentStationName = selectedOption.text.split(' - ')[1];

            showLoading();
            queryBtn.disabled = true;

            try {
                console.log(`ğŸ” æ­£åœ¨æŸ¥è©¢ ${currentStationName} (${currentStationID}) çš„å³æ™‚çœ‹æ¿ (V2)...`);
                
                // âœ¨ ä¿®æ”¹é‡é»ï¼šä½¿ç”¨ V2 LiveBoard API ä¸¦åŠ ä¸Š StationID ç¯©é¸
                const endpoint = `/v2/Rail/TRA/LiveBoard?$filter=StationID eq '${currentStationID}'&$format=JSON`;
                const response = await tdxApi.fetch(endpoint);

                console.log('ğŸ“¦ API å›æ‡‰:', response);

                // V2 å›å‚³çš„æ˜¯ç›´æ¥çš„é™£åˆ—ï¼Œä¸éœ€è¦åƒ V3 ä¸€æ¨£è™•ç† StationLiveBoards
                let trains = Array.isArray(response) ? response : [];

                console.log(`âœ… æˆåŠŸå–å¾—çœ‹æ¿è³‡æ–™ï¼Œå…± ${trains.length} ç­åˆ—è»Š`);

                if (trains.length > 0) {
                    renderBoard(trains);
                } else {
                    showNoData('ç›®å‰ç„¡åˆ—è»Šé€²å‡ºç«™è³‡è¨Š');
                }

            } catch (error) {
                console.error('âŒ æŸ¥è©¢å¤±æ•—:', error);
                showError('æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦');
            } finally {
                queryBtn.disabled = false;
            }
        }

        // ============ 5. æ¸²æŸ“çœ‹æ¿ ============
        function renderBoard(trains) {
            const container = document.getElementById('trainContainer');
            const trainsBoard = document.getElementById('trainsBoard');
            const directionFilter = document.getElementById('directionFilter').value;

            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('stationTitle').textContent = `${currentStationName} å³æ™‚çœ‹æ¿`;
            document.getElementById('stationInfo').textContent = `è»Šç«™ä»£ç¢¼ï¼š${currentStationID}`;
            updateTime();

            // ç¯©é¸æ–¹å‘
            let filteredTrains = trains;
            if (directionFilter !== '') {
                filteredTrains = trains.filter(t => String(t.Direction) === directionFilter);
            }

            // ä¾æ–¹å‘åˆ†çµ„
            const grouped = {
                '0': { title: 'é †è¡Œ (å—ä¸‹/è¥¿è¡Œ/æ±è¡Œ)', trains: [] },
                '1': { title: 'é€†è¡Œ (åŒ—ä¸Š/æ±ä¸Š/è¥¿ä¸Š)', trains: [] }
            };

            filteredTrains.forEach(train => {
                const dir = String(train.Direction); // V2 å›å‚³çš„æ˜¯æ•¸å­— 0 æˆ– 1
                if (grouped[dir]) {
                    grouped[dir].trains.push(train);
                }
            });

            // æ’åºï¼šä¾è¡¨å®šé›¢ç«™æ™‚é–“ (V2 æ¬„ä½æ˜¯ ScheduledDepartureTime)
            Object.values(grouped).forEach(g => {
                g.trains.sort((a, b) => 
                    (a.ScheduledDepartureTime || '').localeCompare(b.ScheduledDepartureTime || '')
                );
            });

            // ç”Ÿæˆ HTML
            let html = '';
            Object.entries(grouped).forEach(([dir, data]) => {
                if (data.trains.length === 0) return;

                html += `<div class="direction-section">
                    <div class="direction-header">
                        <i class="fas fa-arrow-right"></i> ${data.title}
                    </div>`;

                data.trains.forEach(train => {
                    // âœ¨ æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„è»Šç¨®åˆ¤æ–·é‚è¼¯
                    const timeText = formatTime(train.ScheduledDepartureTime);
                    const delayStatus = getDelayStatus(train);
                    const endStation = train.EndingStationName?.Zh_tw || train.EndingStationName || 'æœªçŸ¥';
                    
                    const trainInfo = getTrainDisplayInfo(train);

                    html += `
                        <div class="train-card" 
                             style="cursor: pointer;" 
                             onclick="showTrainStops('${train.TrainNo}', '${currentStationID}', '${endStation}')"
                             title="é»æ“ŠæŸ¥çœ‹æ²¿é€”åœé ç«™">
                            <div class="train-info">
                                <span class="train-type-badge type-${trainInfo.class}">${trainInfo.name}</span>
                                <div class="train-destination">
                                    <div class="train-no">${train.TrainNo} æ¬¡</div>
                                    <div class="destination">å¾€ ${endStation}</div>
                                </div>
                            </div>
                            <div class="schedule-time">
                                ${timeText}
                                <div class="schedule-label">è¡¨å®š</div>
                            </div>
                            <div class="delay-status">
                                ${delayStatus}
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            if (html === '') {
                showNoData('è©²æ–¹å‘ç„¡åˆ—è»Šè³‡è¨Š');
                return;
            }

            trainsBoard.innerHTML = html;
            container.style.display = 'block';
        }

        // ============ 6. è¼”åŠ©å‡½æ•¸ ============

        // ============ âœ¨ æ–°å¢ï¼šæ™ºæ…§åˆ¤æ–·è»Šç¨®åç¨±èˆ‡æ¨£å¼ ============
        function getTrainDisplayInfo(train) {
            let name = train.TrainTypeName?.Zh_tw || 'åˆ—è»Š';
            let cssClass = 'å…¶ä»–';
            const typeID = train.TrainTypeID;

            // 1. å„ªå…ˆä½¿ç”¨ TrainTypeID æŸ¥è¡¨ (æœ€æº–ç¢º)
            if (typeID && trainTypeMap.has(typeID)) {
                name = trainTypeMap.get(typeID);
            } 
            // 2. å¦‚æœæŸ¥ä¸åˆ° IDï¼Œæ‰‹å‹•è™•ç†å¸¸è¦‹é—œéµå­—
            else {
                if (name.includes('æ™®æ‚ ç‘ª')) name = 'æ™®æ‚ ç‘ª';
                else if (name.includes('å¤ªé­¯é–£')) name = 'å¤ªé­¯é–£';
                else if (name.includes('3000')) name = 'è‡ªå¼·(3000)';
                else if (name.includes('å€é–“å¿«')) name = 'å€é–“å¿«';
                else if (name.includes('å€é–“')) name = 'å€é–“';
                else if (name.includes('è‡ªå¼·')) name = 'è‡ªå¼·';
                else if (name.includes('è’å…‰')) name = 'è’å…‰';
                else if (name.includes('å¾©èˆˆ')) name = 'å¾©èˆˆ';
            }

            // 3. æ ¹æ“šæœ€çµ‚åç¨±æ±ºå®š CSS Class
            if (name.includes('è‡ªå¼·(3000)') || name.includes('EMU3000')) cssClass = 'è‡ªå¼·3000';
            else if (name.includes('æ™®æ‚ ç‘ª')) cssClass = 'æ™®æ‚ ç‘ª';
            else if (name.includes('å¤ªé­¯é–£')) cssClass = 'å¤ªé­¯é–£';
            else if (name.includes('è‡ªå¼·')) cssClass = 'è‡ªå¼·';
            else if (name.includes('è’å…‰')) cssClass = 'è’å…‰';
            else if (name.includes('å€é–“å¿«')) cssClass = 'å€é–“å¿«';
            else if (name.includes('å€é–“')) cssClass = 'å€é–“';
            else if (name.includes('å¾©èˆˆ')) cssClass = 'å¾©èˆˆ';
            else if (name.includes('è§€å…‰') || name.includes('éƒµè¼ª')) cssClass = 'è§€å…‰';

            return { name: name, class: cssClass };
        }

        function formatTime(timeStr) {
            if (!timeStr || timeStr.length < 5) return '--:--';
            return timeStr.substring(0, 5);
        }

        function getDelayStatus(train) {
            // V2 æ¬„ä½ï¼šDelayTime (åˆ†é˜)
            const delayTime = train.DelayTime || 0;
            
            if (delayTime === 0) {
                return '<span class="delay-badge delay-ok"><i class="fas fa-check"></i> æº–é»</span>';
            } else {
                return `<span class="delay-badge delay-warn"><i class="fas fa-clock"></i> æ™š ${delayTime} åˆ†</span>`;
            }
        }

        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const updateTimeEl = document.getElementById('updateTime');
            if (updateTimeEl) updateTimeEl.textContent = timeStr;
        }

        function showLoading() {
            const trainsBoard = document.getElementById('trainsBoard');
            trainsBoard.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨æŸ¥è©¢åˆ—è»Šè³‡è¨Š...</p>
                </div>
            `;
            document.getElementById('trainContainer').style.display = 'block';
        }

        function showNoData(message = 'ç„¡è³‡æ–™') {
            const trainsBoard = document.getElementById('trainsBoard');
            trainsBoard.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-inbox"></i>
                    <p>${message}</p>
                </div>
            `;
            document.getElementById('trainContainer').style.display = 'block';
        }

        function showError(message) {
            const trainsBoard = document.getElementById('trainsBoard');
            trainsBoard.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-exclamation-triangle" style="color: #f44336;"></i>
                    <p style="color: #f44336;">${message}</p>
                </div>
            `;
            document.getElementById('trainContainer').style.display = 'block';
        }

        // è‡ªå‹•æ›´æ–°æ™‚é–“
        setInterval(updateTime, 1000);

        // ============ âœ¨ æ–°å¢ï¼šè·‘é¦¬ç‡ˆåŠŸèƒ½é‚è¼¯ ============

        // é¡¯ç¤ºåˆ—è»Šåœé ç«™è·‘é¦¬ç‡ˆ
        async function showTrainStops(trainNo, currentStationID, destName) {
            const bar = document.getElementById('trainMarqueeBar');
            const content = document.getElementById('mqContent');
            const mqTrainNo = document.getElementById('mqTrainNo');
            const mqDest = document.getElementById('mqDest');

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            bar.style.display = 'flex';
            mqTrainNo.textContent = `${trainNo} æ¬¡`;
            mqDest.textContent = `å¾€ ${destName}`;
            content.innerHTML = '<span style="color:#aaa; font-size:1rem;">è¼‰å…¥åœé ç«™è³‡è¨Šä¸­...</span>';
            
            // é‡ç½®å‹•ç•« (é¿å…åˆ‡æ›æ™‚æ–‡å­—è·³å‹•)
            content.style.animation = 'none';
            void content.offsetHeight; /* trigger reflow */
            content.style.animation = 'marquee-scroll 45s linear infinite';

            try {
                // å‘¼å« API å–å¾—è©²è»Šæ¬¡è©³ç´°æ™‚åˆ»è¡¨
                const endpoint = `/v2/Rail/TRA/DailyTrainInfo/TrainNo/${trainNo}?$format=JSON`;
                const data = await tdxApi.fetch(endpoint);

                if (!data || data.length === 0) {
                    content.innerHTML = '<span style="color:#ff9800;">ç„¡åœé ç«™è³‡è¨Š</span>';
                    return;
                }

                const stopTimes = data[0].StopTimes;
                
                // æ‰¾åˆ°ç•¶å‰è»Šç«™åœ¨æ™‚åˆ»è¡¨ä¸­çš„é †åº
                const currentIndex = stopTimes.findIndex(s => s.StationID === currentStationID);
                
                let stopsToShow = [];
                
                if (currentIndex !== -1) {
                    // åªé¡¯ç¤ºã€Œç•¶å‰è»Šç«™ä¹‹å¾Œã€çš„åœé ç«™
                    stopsToShow = stopTimes.slice(currentIndex + 1);
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°ç•¶å‰ç«™ï¼ˆæ¥µå°‘è¦‹ï¼‰ï¼Œé¡¯ç¤ºå…¨éƒ¨
                    stopsToShow = stopTimes;
                }

                if (stopsToShow.length === 0) {
                    content.innerHTML = '<span style="color:#ff9800;">æœ¬åˆ—è»Šå³å°‡æŠµé”çµ‚é»</span>';
                } else {
                    // ç”¢ç”Ÿè·‘é¦¬ç‡ˆ HTML
                    const prefixText = 'æœ¬åˆ—è»Šæ²¿é€”åœé ï¼š';
                    const html = stopsToShow.map(s => {
                        return `<span class="station-stop">${s.StationName.Zh_tw}</span>`;
                    }).join('<span class="station-arrow">â–¶</span>');

                    const fullText = `<span style="color:#00e676; margin-right:10px;">${prefixText}</span>${html}`;
                    content.innerHTML = fullText;
                    
                    // è¨ˆç®—ç¸½å­—æ•¸ä¸¦å‹•æ…‹èª¿æ•´å‹•ç•«é€Ÿåº¦
                    const totalChars = prefixText.length + stopsToShow.reduce((acc, s) => acc + s.StationName.Zh_tw.length, 0);
                    // æ¯å€‹å­— 1.2 ç§’ï¼Œæœ€å°‘ 25 ç§’
                    const duration = Math.max(25, totalChars * 1.2);
                    content.style.animationDuration = `${duration}s`;
                    
                    console.log(`ğŸš‚ è·‘é¦¬ç‡ˆï¼š${trainNo} æ¬¡ï¼Œåœé  ${stopsToShow.length} ç«™ï¼Œå‹•ç•«æ™‚é–“ ${duration.toFixed(1)} ç§’`);
                }

            } catch (error) {
                console.error('âŒ å–å¾—åœé ç«™å¤±æ•—:', error);
                content.innerHTML = '<span style="color:#ff5252;">ç„¡æ³•å–å¾—åœé è³‡è¨Š</span>';
            }
        }

        // é—œé–‰è·‘é¦¬ç‡ˆ
        function closeMarquee() {
            document.getElementById('trainMarqueeBar').style.display = 'none';
        }
    </script>
</body>
</html>
