<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬è·¯ç›£è¦–å™¨ç¶œåˆå¹³å°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="assets/modern-theme.css">
    <script src="assets/config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode header {
            background: rgba(26, 26, 46, 0.95);
            color: #e0e0e0;
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            letter-spacing: -0.5px;
        }

        body.dark-mode header h1 {
            color: #fff;
        }

        header .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .theme-toggle {
            background: none;
            border: 2px solid #667eea;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: #667eea;
            color: white;
        }

        body.dark-mode .theme-toggle {
            border-color: #764ba2;
        }

        body.dark-mode .theme-toggle:hover {
            background: #764ba2;
        }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 2rem;
            padding: 2rem;
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        body.dark-mode .card {
            background: #252d48;
            color: #e0e0e0;
        }

        .card:hover {
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        body.dark-mode .card h2 {
            color: #fff;
            border-bottom-color: #764ba2;
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #555;
        }

        body.dark-mode .filter-group label {
            color: #aaa;
        }

        .filter-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        body.dark-mode .filter-group select {
            background: #1a2a3a;
            border-color: #444;
            color: #e0e0e0;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #reset-filters {
            flex: 1;
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        body.dark-mode #reset-filters {
            background: #3a4555;
            color: #e0e0e0;
            border-color: #555;
        }

        #reset-filters:hover {
            background: #e0e0e0;
        }

        body.dark-mode #reset-filters:hover {
            background: #4a5565;
        }

        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box .label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.3rem;
        }

        .stat-box .value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        #map-container {
            width: 100%;
            height: 350px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .camera-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            overflow-y: auto;
            max-height: 600px;
            padding-right: 0.5rem;
        }

        .camera-grid::-webkit-scrollbar {
            width: 8px;
        }

        .camera-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        body.dark-mode .camera-grid::-webkit-scrollbar-track {
            background: #1a2a3a;
        }

        .camera-grid::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .camera-grid::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .camera-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        body.dark-mode .camera-card {
            background: #252d48;
            color: #e0e0e0;
        }

        .camera-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-4px);
        }

        .camera-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #f0f0f0;
        }

        body.dark-mode .camera-image {
            background: #1a2a3a;
        }

        .camera-info {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .camera-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
            line-height: 1.3;
            color: #333;
        }

        body.dark-mode .camera-name {
            color: #fff;
        }

        .camera-details {
            font-size: 0.8rem;
            color: #666;
            flex: 1;
        }

        body.dark-mode .camera-details {
            color: #aaa;
        }

        .road-type-badge {
            display: inline-block;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            width: fit-content;
        }

        .badge-national {
            background: #1e40af;
            color: white;
        }

        .badge-expressway {
            background: #0891b2;
            color: white;
        }

        .badge-provincial {
            background: #14b8a6;
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 0.5rem 0.75rem;
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            font-size: 0.9rem;
            min-width: 40px;
        }

        body.dark-mode .pagination button {
            background: #3a4555;
            color: #e0e0e0;
            border-color: #555;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        footer {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            text-align: center;
            color: #666;
            margin-top: auto;
            backdrop-filter: blur(10px);
        }

        body.dark-mode footer {
            background: rgba(26, 26, 46, 0.95);
            color: #aaa;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        body.dark-mode .loading {
            color: #aaa;
        }

        .error {
            background: #fee;
            color: #c00;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        @media (max-width: 1400px) {
            .camera-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1200px) {
            main {
                grid-template-columns: 1fr;
            }

            .left-panel {
                order: 2;
            }

            .right-panel {
                order: 1;
            }

            .stats-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            main {
                padding: 1rem;
                gap: 1rem;
            }

            header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            header h1 {
                font-size: 1.4rem;
            }

            .camera-grid {
                grid-template-columns: 1fr;
                max-height: 400px;
            }

            .stats-container {
                grid-template-columns: 1fr 1fr;
            }

            #map-container {
                height: 250px;
            }

            .card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ›£ï¸ å…¬è·¯ç›£è¦–å™¨ç¶œåˆå¹³å°</h1>
        <div class="controls">
            <button class="theme-toggle" id="theme-toggle" title="åˆ‡æ›æš—é»‘æ¨¡å¼">ğŸŒ™</button>
        </div>
    </header>

    <main>
        <!-- å·¦å´é¢æ¿ï¼šç¯©é¸å’Œçµ±è¨ˆ -->
        <div class="left-panel">
            <!-- ç¯©é¸å¡ç‰‡ -->
            <div class="card">
                <h2>ç¯©é¸æ¢ä»¶</h2>
                <div class="filter-group">
                    <label for="road-type-filter">é“è·¯é¡å‹ï¼š</label>
                    <select id="road-type-filter">
                        <option value="all">æ‰€æœ‰é¡å‹</option>
                        <option value="national">åœ‹é“</option>
                        <option value="expressway">å¿«é€Ÿå…¬è·¯</option>
                        <option value="provincial">çœé“</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="city-filter">ç¸£å¸‚ï¼š<span style="color: red;">*</span></label>
                    <select id="city-filter">
                        <option value="" disabled selected>è«‹é¸æ“‡ç¸£å¸‚</option>
                    </select>
                </div>
                <div class="button-group">
                    <button id="reset-filters">é‡ç½®ç¯©é¸</button>
                </div>
            </div>

            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="card">
                <h2>ç›£è¦–å™¨çµ±è¨ˆ</h2>
                <div class="stats-container">
                    <div class="stat-box">
                        <div class="label">åœ‹é“</div>
                        <div class="value" id="stat-national">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">å¿«é€Ÿå…¬è·¯</div>
                        <div class="value" id="stat-expressway">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">çœé“</div>
                        <div class="value" id="stat-provincial">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´é¢æ¿ï¼šåœ°åœ–å’Œåˆ—è¡¨ -->
        <div class="right-panel">
            <!-- åœ°åœ–å¡ç‰‡ -->
            <div class="card">
                <h2>ç›£è¦–å™¨åœ°ç†åˆ†ä½ˆåœ–</h2>
                <div id="map-container"></div>
            </div>

            <!-- ç›£è¦–å™¨åˆ—è¡¨å¡ç‰‡ -->
            <div class="card">
                <h2>ç›£è¦–å™¨åˆ—è¡¨</h2>
                <div id="loading" class="loading">è¼‰å…¥ä¸­...</div>
                <div id="error-container"></div>
                <div id="city-selection-grid" style="display: none; padding: 1rem;">
                    <p style="color: #666; margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-map-marked-alt"></i> è«‹é¸æ“‡è¦æŸ¥çœ‹çš„ç¸£å¸‚ï¼š
                    </p>
                    <div id="city-buttons" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem;"></div>
                </div>
                <div class="camera-grid" id="camera-list" style="display: none;"></div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 å…¬è·¯ç›£è¦–å™¨ç¶œåˆå¹³å° | ç”± TDX API æä¾›æ•¸æ“š</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script src="assets/camera-map-manager.js"></script>
    <script src="assets/dark-mode.js"></script>

    <script>
        // å…¨å±€è®Šæ•¸ï¼ˆtdxApi å·²åœ¨ tdx-api.js ä¸­åˆå§‹åŒ–ï¼‰
        let allCameras = [];
        let filteredCameras = [];
        let map = null;
        let markers = [];
        const ITEMS_PER_PAGE = 12;
        let currentPage = 1;

        // è¨ˆç®—çµæœå¿«å–ç³»çµ±
        const computationCache = {
            directionsByCamera: new Map(),
            mileageByCamera: new Map(),
            citiesByType: new Map(),
            clear() {
                this.directionsByCamera.clear();
                this.mileageByCamera.clear();
                this.citiesByType.clear();
            }
        };

        // æ ¹æ“šç¶“ç·¯åº¦åˆ¤æ–·ç¸£å¸‚
        function getCityFromCoordinates(lon, lat) {
            if (!lon || !lat || lon === 0 || lat === 0) return 'æœªçŸ¥';
            
            const cityRanges = [
                { name: 'å°åŒ—å¸‚', lonMin: 121.45, lonMax: 121.65, latMin: 24.95, latMax: 25.20 },
                { name: 'åŸºéš†å¸‚', lonMin: 121.65, lonMax: 121.85, latMin: 25.10, latMax: 25.25 },
                { name: 'æ–°ç«¹å¸‚', lonMin: 120.90, lonMax: 121.05, latMin: 24.75, latMax: 24.85 },
                { name: 'å˜‰ç¾©å¸‚', lonMin: 120.40, lonMax: 120.50, latMin: 23.45, latMax: 23.52 },
                { name: 'å®œè˜­ç¸£', lonMin: 121.50, lonMax: 122.10, latMin: 24.50, latMax: 25.05 },
                { name: 'èŠ±è“®ç¸£', lonMin: 121.30, lonMax: 121.80, latMin: 23.30, latMax: 24.50 },
                { name: 'å°æ±ç¸£', lonMin: 120.90, lonMax: 121.50, latMin: 22.30, latMax: 23.50 },
                { name: 'æ¡ƒåœ’å¸‚', lonMin: 121.00, lonMax: 121.50, latMin: 24.80, latMax: 25.10 },
                { name: 'æ–°ç«¹ç¸£', lonMin: 120.70, lonMax: 121.30, latMin: 24.50, latMax: 25.00 },
                { name: 'è‹—æ —ç¸£', lonMin: 120.60, lonMax: 121.20, latMin: 24.20, latMax: 24.80 },
                { name: 'å°ä¸­å¸‚', lonMin: 120.50, lonMax: 121.20, latMin: 24.00, latMax: 24.50 },
                { name: 'å½°åŒ–ç¸£', lonMin: 120.40, lonMax: 120.80, latMin: 23.80, latMax: 24.20 },
                { name: 'å—æŠ•ç¸£', lonMin: 120.60, lonMax: 121.30, latMin: 23.50, latMax: 24.20 },
                { name: 'é›²æ—ç¸£', lonMin: 120.20, lonMax: 120.70, latMin: 23.50, latMax: 23.90 },
                { name: 'å˜‰ç¾©ç¸£', lonMin: 120.10, lonMax: 120.80, latMin: 23.30, latMax: 23.70 },
                { name: 'å°å—å¸‚', lonMin: 120.00, lonMax: 120.50, latMin: 22.90, latMax: 23.40 },
                { name: 'é«˜é›„å¸‚', lonMin: 120.20, lonMax: 120.50, latMin: 22.50, latMax: 23.10 },
                { name: 'å±æ±ç¸£', lonMin: 120.40, lonMax: 120.90, latMin: 22.00, latMax: 22.80 },
                { name: 'æ–°åŒ—å¸‚', lonMin: 121.30, lonMax: 121.80, latMin: 24.60, latMax: 25.30 }
            ];
            
            for (const city of cityRanges) {
                if (lon >= city.lonMin && lon <= city.lonMax && lat >= city.latMin && lat <= city.latMax) {
                    return city.name;
                }
            }
            
            return 'å…¶ä»–åœ°å€';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ¬ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            try {
                console.log('ğŸ—ºï¸ åˆå§‹åŒ–åœ°åœ–...');
                initializeMap();
                
                console.log('ğŸ›ï¸ è¨­ç½®äº‹ä»¶ç›£è½...');
                setupEventListeners();
                
                console.log('ğŸ“¥ é–‹å§‹è¼‰å…¥ç›£è¦–å™¨è³‡æ–™...');
                await loadAllCameras();
                
                console.log('ğŸ–¼ï¸ é¡¯ç¤ºç›£è¦–å™¨åˆ—è¡¨...');
                displayCameras(filteredCameras, 1);
                
                console.log('âœ… åˆå§‹åŒ–å®Œæˆï¼');
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-container').innerHTML = 
                    '<div class="error">é é¢åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message + '</div>';
            }
        });

        // è¼‰å…¥æ‰€æœ‰ç›£è¦–å™¨è³‡æ–™
        async function loadAllCameras() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error-container');
            const listEl = document.getElementById('camera-list');
            
            try {
                console.log('ğŸš€ é–‹å§‹è¼‰å…¥ä¸‰ç¨®é“è·¯ç›£è¦–å™¨è³‡æ–™...');
                loadingEl.textContent = 'æ­£åœ¨é€£æ¥ TDX API...';
                
                // è¼‰å…¥åœ‹é“è³‡æ–™
                console.log('ğŸ“ è¼‰å…¥åœ‹é“è³‡æ–™...');
                loadingEl.textContent = 'è¼‰å…¥åœ‹é“ç›£è¦–å™¨è³‡æ–™...';
                let nationalResponse = await tdxApi.fetchCCTV('/v2/Road/Traffic/CCTV/Freeway?$format=JSON');
                console.log('ğŸ“¦ åœ‹é“ API åŸå§‹å›æ‡‰:', nationalResponse);
                
                // è™•ç†å¯èƒ½çš„è³‡æ–™çµæ§‹ï¼šç›´æ¥é™£åˆ—æˆ– {CCTVs: [...]}
                let nationalData = [];
                if (Array.isArray(nationalResponse)) {
                    nationalData = nationalResponse;
                } else if (nationalResponse && nationalResponse.CCTVs && Array.isArray(nationalResponse.CCTVs)) {
                    nationalData = nationalResponse.CCTVs;
                }
                console.log('âœ… åœ‹é“è³‡æ–™:', nationalData.length, 'ç­†');
                
                // è¼‰å…¥ Highway è³‡æ–™ï¼ˆåŒ…å«åœ‹é“ã€å¿«é€Ÿå…¬è·¯ã€çœé“ï¼‰
                console.log('ğŸ“ è¼‰å…¥ Highway è³‡æ–™ï¼ˆåŒ…å«å¿«é€Ÿå…¬è·¯å’Œçœé“ï¼‰...');
                loadingEl.textContent = 'è¼‰å…¥çœé“å’Œå¿«é€Ÿå…¬è·¯ç›£è¦–å™¨è³‡æ–™...';
                let highwayResponse = await tdxApi.fetchCCTV('/v2/Road/Traffic/CCTV/Highway?$format=JSON');
                console.log('ğŸ“¦ Highway API åŸå§‹å›æ‡‰:', highwayResponse);
                
                // è™•ç†å¯èƒ½çš„è³‡æ–™çµæ§‹ï¼šç›´æ¥é™£åˆ—æˆ– {CCTVs: [...]}
                let highwayData = [];
                if (Array.isArray(highwayResponse)) {
                    highwayData = highwayResponse;
                } else if (highwayResponse && highwayResponse.CCTVs && Array.isArray(highwayResponse.CCTVs)) {
                    highwayData = highwayResponse.CCTVs;
                }
                console.log('âœ… Highway åŸå§‹è³‡æ–™:', highwayData.length, 'ç­†');
                
                // å¾ Highway è³‡æ–™ä¸­ç¯©é¸å‡ºçœé“å’Œå¿«é€Ÿå…¬è·¯ï¼ˆæ’é™¤åœ‹é“ï¼‰
                const provincialData = highwayData.filter(c => {
                    const roadName = c.RoadName || c.RoadID || '';
                    const roadId = c.RoadID || '';
                    // æ’é™¤åœ‹é“ï¼ˆåœ‹é“1è™Ÿã€åœ‹é“3è™Ÿç­‰ï¼‰
                    if (roadName.includes('åœ‹é“') || roadId.includes('åœ‹é“')) {
                        return false;
                    }
                    return true;
                });
                console.log('âœ… ç¯©é¸å¾Œçš„çœé“+å¿«é€Ÿå…¬è·¯è³‡æ–™:', provincialData.length, 'ç­†');

                // åˆ†é›¢å¿«é€Ÿå…¬è·¯å’Œä¸€èˆ¬çœé“
                loadingEl.textContent = 'è™•ç†è³‡æ–™ä¸­...';
                const expressways = provincialData.filter(c => 
                    c.RoadID?.includes('å¿«') || c.RoadName?.includes('å¿«é€Ÿ') || c.RoadName?.includes('å¿«é€Ÿé“è·¯')
                );
                
                const regularProvincial = provincialData.filter(c => 
                    !c.RoadID?.includes('å¿«') && !c.RoadName?.includes('å¿«é€Ÿ')
                );

                console.log('âœ… å¿«é€Ÿå…¬è·¯:', expressways.length, 'ç­†');
                console.log('âœ… ä¸€èˆ¬çœé“:', regularProvincial.length, 'ç­†');

                // åˆä½µä¸¦æ¨™æº–åŒ–è³‡æ–™
                allCameras = [
                    ...nationalData.map(c => {
                        const lat = c.PositionLat || c.Latitude || 0;
                        const lon = c.PositionLon || c.Longitude || 0;
                        return {
                            ...c, 
                            type: 'national', 
                            typeName: 'åœ‹é“',
                            CameraName: c.LocationName || c.RoadName || c.RoadID || 'æœªå‘½å',
                            VideoImageUrl: c.VideoImageUrl || c.ImageUrl || '',
                            Latitude: lat,
                            Longitude: lon,
                            City: c.LocationCity || c.City || getCityFromCoordinates(lon, lat)
                        };
                    }),
                    ...expressways.map(c => {
                        const lat = c.PositionLat || c.Latitude || 0;
                        const lon = c.PositionLon || c.Longitude || 0;
                        return {
                            ...c, 
                            type: 'expressway', 
                            typeName: 'å¿«é€Ÿå…¬è·¯',
                            CameraName: c.LocationName || c.RoadName || c.RoadID || 'æœªå‘½å',
                            VideoImageUrl: c.VideoImageUrl || c.ImageUrl || '',
                            Latitude: lat,
                            Longitude: lon,
                            City: c.LocationCity || c.City || getCityFromCoordinates(lon, lat)
                        };
                    }),
                    ...regularProvincial.map(c => {
                        const lat = c.PositionLat || c.Latitude || 0;
                        const lon = c.PositionLon || c.Longitude || 0;
                        return {
                            ...c, 
                            type: 'provincial', 
                            typeName: 'çœé“',
                            CameraName: c.LocationName || c.RoadName || c.RoadID || 'æœªå‘½å',
                            VideoImageUrl: c.VideoImageUrl || c.ImageUrl || '',
                            Latitude: lat,
                            Longitude: lon,
                            City: c.LocationCity || c.City || getCityFromCoordinates(lon, lat)
                        };
                    })
                ];

                console.log('ğŸ‰ ç¸½è¨ˆè¼‰å…¥ç›£è¦–å™¨:', allCameras.length, 'ç­†');
                console.log('ğŸ“Š åˆ†é¡çµ±è¨ˆ:', {
                    åœ‹é“: allCameras.filter(c => c.type === 'national').length,
                    å¿«é€Ÿå…¬è·¯: allCameras.filter(c => c.type === 'expressway').length,
                    çœé“: allCameras.filter(c => c.type === 'provincial').length
                });

                filteredCameras = [...allCameras];
                
                console.log('ğŸ”§ å¡«å……ç¯©é¸é¸é …...');
                populateFilters();
                
                console.log('ğŸ“Š æ›´æ–°çµ±è¨ˆè³‡è¨Š...');
                updateStatistics();
                
                if (map) {
                    console.log('ğŸ—ºï¸ æ·»åŠ åœ°åœ–æ¨™è¨˜...');
                    loadingEl.textContent = 'æ·»åŠ åœ°åœ–æ¨™è¨˜...';
                    addMarkersToMap(filteredCameras);
                }

                loadingEl.style.display = 'none';
                document.getElementById('city-selection-grid').style.display = 'block';
                
                console.log('âœ… è³‡æ–™è¼‰å…¥å®Œæˆ');
            } catch (error) {
                console.error('âŒ è¼‰å…¥ç›£è¦–å™¨è³‡æ–™å¤±æ•—:', error);
                loadingEl.style.display = 'none';
                errorEl.innerHTML = 
                    '<div class="error">ç„¡æ³•è¼‰å…¥ç›£è¦–å™¨è³‡æ–™ï¼š' + error.message + '<br><small>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚é–‹å•Ÿç€è¦½å™¨æ§åˆ¶å° (F12) æŸ¥çœ‹è©³ç´°éŒ¯èª¤è³‡è¨Šã€‚</small></div>';
            }
        }

        // å¡«å……ç¯©é¸é¸é …å’Œç¸£å¸‚æŒ‰éˆ•
        function populateFilters() {
            const citySet = new Set();
            allCameras.forEach(camera => {
                if (camera.City) citySet.add(camera.City);
            });

            const citySelect = document.getElementById('city-filter');
            const cityButtonsContainer = document.getElementById('city-buttons');
            const sortedCities = Array.from(citySet).sort();
            
            // å¡«å……ä¸‹æ‹‰é¸å–®
            sortedCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
            
            // ç”Ÿæˆç¸£å¸‚æŒ‰éˆ•
            cityButtonsContainer.innerHTML = '';
            sortedCities.forEach(city => {
                const button = document.createElement('button');
                button.className = 'city-button';
                button.textContent = city;
                button.style.cssText = `
                    padding: 0.75rem 1rem;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 0.95rem;
                    font-weight: 500;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                button.onmouseover = function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                };
                button.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                };
                button.onclick = function() {
                    selectCity(city);
                };
                cityButtonsContainer.appendChild(button);
            });
        }
        
        // é¸æ“‡ç¸£å¸‚
        function selectCity(city) {
            document.getElementById('city-filter').value = city;
            document.getElementById('city-selection-grid').style.display = 'none';
            applyFilters();
        }

        // è¨­å®šäº‹ä»¶ç›£è½
        function setupEventListeners() {
            document.getElementById('road-type-filter').addEventListener('change', applyFilters);
            document.getElementById('city-filter').addEventListener('change', function() {
                const cityValue = this.value;
                if (cityValue && cityValue !== '') {
                    document.getElementById('city-selection-grid').style.display = 'none';
                    applyFilters();
                }
            });
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
        }

        // å¥—ç”¨ç¯©é¸
        function applyFilters() {
            const roadType = document.getElementById('road-type-filter').value;
            const city = document.getElementById('city-filter').value;
            
            // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡ç¸£å¸‚
            if (!city || city === '') {
                document.getElementById('city-selection-grid').style.display = 'block';
                document.getElementById('camera-list').style.display = 'none';
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            filteredCameras = allCameras.filter(camera => {
                const matchType = roadType === 'all' || camera.type === roadType;
                const matchCity = camera.City === city;
                return matchType && matchCity;
            });

            currentPage = 1;
            updateStatistics();
            addMarkersToMap(filteredCameras);
            displayCameras(filteredCameras, 1);
        }

        // é‡ç½®ç¯©é¸
        function resetFilters() {
            document.getElementById('road-type-filter').value = 'all';
            document.getElementById('city-filter').value = '';
            filteredCameras = [...allCameras];
            currentPage = 1;
            updateStatistics();
            addMarkersToMap(filteredCameras);
            displayCameras(filteredCameras, 1);
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStatistics() {
            const stats = {
                national: filteredCameras.filter(c => c.type === 'national').length,
                expressway: filteredCameras.filter(c => c.type === 'expressway').length,
                provincial: filteredCameras.filter(c => c.type === 'provincial').length
            };

            document.getElementById('stat-national').textContent = stats.national;
            document.getElementById('stat-expressway').textContent = stats.expressway;
            document.getElementById('stat-provincial').textContent = stats.provincial;
        }

        // åˆå§‹åŒ–åœ°åœ–
        function initializeMap() {
            const mapContainer = document.getElementById('map-container');
            map = L.map(mapContainer).setView([23.5, 121], 7);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }

        // å–å¾—æ¨™è¨˜é¡è‰²
        function getMarkerColor(type) {
            const colors = {
                national: '#1e40af',
                expressway: '#0891b2',
                provincial: '#14b8a6'
            };
            return colors[type] || '#666';
        }

        // åœ¨åœ°åœ–ä¸Šæ·»åŠ æ¨™è¨˜
        function addMarkersToMap(cameras) {
            // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // æ·»åŠ æ–°æ¨™è¨˜
            cameras.forEach(camera => {
                if (camera.Latitude && camera.Longitude) {
                    const color = getMarkerColor(camera.type);
                    const html = `<div style="width: 20px; height: 20px; background: ${color}; border-radius: 50%; border: 2px solid white;"></div>`;
                    const icon = L.divIcon({ html, iconSize: [20, 20] });

                    const marker = L.marker([camera.Latitude, camera.Longitude], { icon }).addTo(map);
                    marker.bindPopup(`<strong>${camera.CameraName}</strong><br>${camera.typeName}<br>${camera.City || ''}`);
                    markers.push(marker);
                }
            });

            // èª¿æ•´åœ°åœ–è¦–åœ–
            if (cameras.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
            }
        }

        // é¡¯ç¤ºç›£è¦–å™¨ï¼ˆæŒ‰ç¸£å¸‚åˆ†çµ„ï¼‰
        function displayCameras(cameras, page = 1) {
            console.log('ğŸ“º displayCameras è¢«èª¿ç”¨:', {
                ç¸½æ•¸: cameras.length,
                é ç¢¼: page,
                æ¯é æ•¸é‡: ITEMS_PER_PAGE
            });
            
            const cameraList = document.getElementById('camera-list');
            
            if (!cameras || cameras.length === 0) {
                console.warn('âš ï¸ æ²’æœ‰ç›£è¦–å™¨è³‡æ–™å¯é¡¯ç¤º');
                cameraList.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #666;">ç›®å‰æ²’æœ‰ç›£è¦–å™¨è³‡æ–™</div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageCameras = cameras.slice(start, end);
            
            console.log('ğŸ“„ ç•¶å‰é é¢é¡¯ç¤º:', pageCameras.length, 'å€‹ç›£è¦–å™¨');

            cameraList.innerHTML = '';

            // æŒ‰ç¸£å¸‚åˆ†çµ„
            const camerasByCity = {};
            pageCameras.forEach(camera => {
                const city = camera.City || 'æœªçŸ¥';
                if (!camerasByCity[city]) {
                    camerasByCity[city] = [];
                }
                camerasByCity[city].push(camera);
            });

            // æŒ‰ç¸£å¸‚åç¨±æ’åº
            const sortedCities = Object.keys(camerasByCity).sort();

            // ç‚ºæ¯å€‹ç¸£å¸‚å»ºç«‹åˆ†çµ„å€å¡Š
            sortedCities.forEach(city => {
                // å»ºç«‹ç¸£å¸‚æ¨™é¡Œ
                const cityHeader = document.createElement('div');
                cityHeader.style.gridColumn = '1 / -1';
                cityHeader.style.padding = '1rem 0 0.5rem 0';
                cityHeader.style.borderBottom = '2px solid #e0e0e0';
                cityHeader.style.marginBottom = '1rem';
                cityHeader.innerHTML = `
                    <h3 style="margin: 0; color: #333; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-map-marker-alt" style="color: #2196F3;"></i>
                        ${city}
                        <span style="font-size: 0.9rem; color: #666; font-weight: normal;">(${camerasByCity[city].length} å€‹ç›£è¦–å™¨)</span>
                    </h3>
                `;
                cameraList.appendChild(cityHeader);

                // é¡¯ç¤ºè©²ç¸£å¸‚çš„ç›£è¦–å™¨
                camerasByCity[city].forEach((camera, index) => {
                    try {
                        const card = document.createElement('div');
                        card.className = 'camera-card';
                        card.innerHTML = `
                            <img src="${camera.VideoImageUrl || 'assets/placeholder.jpg'}" 
                                 alt="${camera.CameraName}" 
                                 class="camera-image" 
                                 loading="lazy"
                                 onerror="this.src='assets/placeholder.jpg'">
                            <div class="camera-info">
                                <div class="camera-name">${camera.CameraName}</div>
                                <div class="camera-details">
                                    <div>${extractDirection(camera)}</div>
                                </div>
                                <span class="road-type-badge badge-${camera.type}">${camera.typeName}</span>
                            </div>
                        `;
                        cameraList.appendChild(card);
                    } catch (error) {
                        console.error('âŒ æ¸²æŸ“ç›£è¦–å™¨å¡ç‰‡å¤±æ•—:', camera, error);
                    }
                });
            });

            renderPagination(cameras.length, page);
            console.log('âœ… displayCameras å®Œæˆ');
        }

        // æ¸²æŸ“åˆ†é 
        function renderPagination(total, currentPage) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = Math.ceil(total / ITEMS_PER_PAGE);

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = i === currentPage ? 'active' : '';
                button.addEventListener('click', () => {
                    displayCameras(filteredCameras, i);
                });
                pagination.appendChild(button);
            }
        }

        // æå–æ–¹å‘
        function extractDirection(camera) {
            const cameraId = camera.CCTVID || camera.VideoImageUrl;
            if (cameraId && computationCache.directionsByCamera.has(cameraId)) {
                return computationCache.directionsByCamera.get(cameraId);
            }

            let direction = 'æœªçŸ¥';
            if (camera.Direction) {
                direction = camera.Direction;
            }

            if (cameraId) {
                computationCache.directionsByCamera.set(cameraId, direction);
            }

            return direction;
        }
    </script>
</body>
</html>
