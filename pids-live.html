<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台鐵 PIDS 全螢幕時刻表</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #111;
            color: white;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
                async function fetchScheduleWithFallback(trainNo) {
                    try {
                        const myApiUrl = `https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev/api/schedule?trainNo=${trainNo}`;
                        const response = await fetch(myApiUrl);
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.length > 0 && data[0].StopTimes) return data[0].StopTimes;
                        }
                    } catch (e) {
                        console.warn(`D1 查詢失敗`, e);
                    }

                    try {
                        const v2Data = await tdxApi.fetch(`/v2/Rail/TRA/DailyTrainInfo/TrainNo/${trainNo}?$format=JSON`);
                        if (v2Data && v2Data.length > 0) return v2Data[0].StopTimes;
                    } catch (e) {}

                    return [];
                }

                async function updateLiveMarquee(elementId, train) {
                    const el = document.getElementById(elementId);
                    const trainNo = train.TrainNo;
                    const currentStationID = train.StationID;
                    el.textContent = `載入 ${trainNo} 次列車資訊中...`;

                    try {
                        const [liveDataArray, stopTimes] = await Promise.all([
                            tdxApi.fetch(`/v3/Rail/TRA/TrainLiveBoard/TrainNo/${trainNo}?$format=JSON`).catch(() => null),
                            fetchScheduleWithFallback(trainNo)
                        ]);

                        let locationText = "(訊號微弱，依時刻表行駛)";
                        const liveData = (liveDataArray && liveDataArray.length > 0) ? liveDataArray[0] : null;

                        if (liveData && liveData.StationName) {
                            const status = liveData.TrainStationStatus === 0 ? "進站中" : "已離開";
                            locationText = `${status} ${liveData.StationName.Zh_tw}`;
                        }

                        let nextStopsText = "";
                        if (stopTimes && stopTimes.length > 0) {
                            const currentIndex = stopTimes.findIndex(s => s.StationID === currentStationID);
                            if (currentIndex !== -1 && currentIndex < stopTimes.length - 1) {
                                const nextStops = stopTimes.slice(currentIndex + 1);
                                const displayStops = nextStops.slice(0, 10).map(s => s.StationName.Zh_tw).join('▶');
                                nextStopsText = ` | 後續停靠：${displayStops}`;
                                if (nextStops.length > 10) nextStopsText += "...";
                            } else {
                                nextStopsText = " | 本列車即將抵達終點";
                            }
                        }

                        const delay = train.Delay == 0 ? "準點" : `晚 ${train.Delay} 分`;
                        const typeName = train.TrainTypeName?.Zh_tw || '列車';
                        const destination = train.EndingStationName?.Zh_tw || train.EndingStationName || '';
                        const departureTime = train.ScheduledDepartureTime?
                            train.ScheduledDepartureTime.slice(0,5) : formatTime(train.DepartureTime);

                        const text = `本班列車：${trainNo} 次 ${typeName} 往 ${destination} (${delay}) | 目前位置：${locationText} | 本站預計 ${departureTime} 開車${nextStopsText}`;
                        el.textContent = text;

                        const duration = Math.max(10, text.length * 0.25);
                        el.style.animationDuration = `${duration}s`;
                    } catch (e) {
                        console.warn("Marquee Error", e);
                        el.textContent = `${trainNo} 次 往 ${train.EndingStationName} (資料讀取中...)`;
                    }
                }
        .pids-screen {
            flex: 1;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            border: 8px solid #333;
            border-radius: 8px;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        /* === 1. 頂部站名與時間列 === */
        .pids-top-bar {
            background-color: #000;
            color: #fff;
            height: 80px; /* 增高以容納圖片 Logo */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #333;
        }

        .station-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .station-title-block {
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-left: 20px;
        }

        /* 圓形圖片 Logo 樣式 */
        .tra-logo-img {
            height: 55px;
            width: auto;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
        }

        .station-name {
            font-size: 3.5rem;
            font-weight: 900;
            letter-spacing: 5px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.6);
            line-height: 1;
            margin-bottom: 5px;
        }

        .sub-title {
            font-size: 1.4rem;
            font-weight: bold;
            letter-spacing: 2px;
            opacity: 0.9;
        }

        #stationNameN + .sub-title { color: #4fc3f7; }
        #stationNameS + .sub-title { color: #ffcc80; }

        .datetime-info {
            text-align: right;
            line-height: 1.2;
        }

        .date-text { font-size: 1.1rem; color: #ccc; }
        .time-text { font-size: 2.2rem; font-weight: bold; font-family: Consolas, monospace; color: #ffeb3b; }

        /* === 2. 公告跑馬燈 === */
        .marquee-header {
            background-color: #e3f2fd;
            color: #01579b;
            height: 45px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 1.3rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
        }

        /* === 3. 時刻表區域 (滿版) === */
        .screen-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            overflow: auto;
        }

        /* 北上 Header */
        .north-header {
            background: linear-gradient(to right, #000080, #0d47a1);
            color: white;
            padding: 12px 20px;
            font-size: 1.8rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #fff;
        }

        /* 南下 Header */
        .south-header {
            background: linear-gradient(to right, #bf360c, #e65100);
            color: white;
            padding: 12px 20px;
            font-size: 1.8rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #fff;
        }

        /* 表格設定 */
        .train-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .train-table th {
            padding: 10px;
            font-size: 1.4rem;
            color: #fff;
            border-bottom: 2px solid #fff;
        }
        
        /* 北上配色 */
        .north-table th { background-color: #000080; }
        .north-table tr:nth-child(odd) { background-color: #000; color: #4fc3f7; }
        .north-table tr:nth-child(even) { background-color: #002f4b; color: #fff; }

        /* 南下配色 */
        .south-table th { background-color: #bf360c; }
        .south-table tr:nth-child(odd) { background-color: #000; color: #ffcc80; }
        .south-table tr:nth-child(even) { background-color: #3e2723; color: #fff; }

        .train-table td { padding: 15px 5px; }

        .highlight-row {
            background-color: rgba(255, 255, 255, 0.15) !important;
            box-shadow: inset 0 0 15px rgba(255, 235, 59, 0.15);
            border: 2px solid #ffeb3b !important;
        }

        .highlight-row td {
            font-size: 2rem;
            padding: 15px 5px;
        }

        /* === 4. 底部動態跑馬燈 === */
        .marquee-footer {
            background-color: #212121;
            color: #ffeb3b;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 1.5rem;
            font-weight: bold;
            border-top: 4px solid #ff9800;
            white-space: nowrap;
            overflow: hidden;
        }

        .marquee-text {
            display: inline-block;
            animation: scroll-left 15s linear infinite;
            padding-left: 100%;
        }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .status-ontime { color: #00e676 !important; }
        .status-delay { color: #ff1744 !important; }
        .type-tze { color: #ffeb3b; } 
        .type-local { color: #fff; }

        @media (max-width: 1024px) { 
            body { flex-direction: column; height: auto; overflow-y: auto; } 
            .pids-screen { width: 100%; height: 700px; margin-bottom: 20px; } 
        }
    </style>
</head>
<body>

    <!-- 左螢幕：北上 -->
    <div class="pids-screen">
        <!-- 1. 頂部站名時間列 -->
        <div class="pids-top-bar">
            <div class="station-info">
                <img src="https://www.railway.gov.tw/tra-tip-web/static/images/TRA_logo.jpg" class="tra-logo-img" alt="台鐵">
                <div class="station-title-block">
                    <div class="station-name" id="stationNameN">臺鐵車站</div>
                    <div class="sub-title">北上 最近時刻表</div>
                </div>
            </div>
            <div class="datetime-info">
                <div class="date-text" id="dateN">--/--</div>
                <div class="time-text" id="timeN">--:--</div>
            </div>
        </div>

        <!-- 2. 公告跑馬燈 -->
        <div class="marquee-header">
            <div class="marquee-text">[北上公告] 本站北上列車運轉正常，感謝您的搭乘。</div>
        </div>

        <!-- 3. 時刻表內容 (滿版) -->
        <div class="screen-body">
            <div class="north-header">
                <span><i class="fas fa-arrow-up"></i> 北上</span>
                <span style="font-size: 1.2rem;">North Bound</span>
            </div>
            <table class="train-table north-table">
                <thead>
                    <tr>
                        <th style="width:15%">車次</th>
                        <th style="width:20%">車種</th>
                        <th style="width:25%">開往</th>
                        <th style="width:20%">時間</th>
                        <th style="width:20%">備註</th>
                    </tr>
                </thead>
                <tbody id="northBody">
                    <!-- JS 自動填入 -->
                </tbody>
            </table>
        </div>

        <!-- 4. 底部即時動態 -->
        <div class="marquee-footer">
            <div class="marquee-text" id="marqueeN">⚠️ 連線異常，請稍候...</div>
        </div>
    </div>

    <!-- 右螢幕：南下 -->
    <div class="pids-screen">
        <!-- 1. 頂部站名時間列 -->
        <div class="pids-top-bar">
            <div class="station-info">
                <img src="https://www.railway.gov.tw/tra-tip-web/static/images/TRA_logo.jpg" class="tra-logo-img" alt="台鐵">
                <div class="station-title-block">
                    <div class="station-name" id="stationNameS">臺鐵車站</div>
                    <div class="sub-title">南下 最近時刻表</div>
                </div>
            </div>
            <div class="datetime-info">
                <div class="date-text" id="dateS">--/--</div>
                <div class="time-text" id="timeS">--:--</div>
            </div>
        </div>

        <!-- 2. 公告跑馬燈 -->
        <div class="marquee-header">
            <div class="marquee-text">[南下公告] 本站南下列車運轉正常，感謝您的搭乘。</div>
        </div>

        <!-- 3. 時刻表內容 (滿版) -->
        <div class="screen-body">
            <div class="south-header">
                <span><i class="fas fa-arrow-down"></i> 南下</span>
                <span style="font-size: 1.2rem;">South Bound</span>
            </div>
            <table class="train-table south-table">
                <thead>
                    <tr>
                        <th style="width:15%">車次</th>
                        <th style="width:20%">車種</th>
                        <th style="width:25%">開往</th>
                        <th style="width:20%">時間</th>
                        <th style="width:20%">備註</th>
                    </tr>
                </thead>
                <tbody id="southBody">
                    <!-- JS 自動填入 -->
                </tbody>
            </table>
        </div>

        <!-- 4. 底部即時動態 -->
        <div class="marquee-footer">
            <div class="marquee-text" id="marqueeS">⚠️ 連線異常，請稍候...</div>
        </div>
    </div>

    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script>
        // 1. 時鐘功能
        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            const y = now.getFullYear();
            const mo = String(now.getMonth()+1).padStart(2,'0');
            const d = String(now.getDate()).padStart(2,'0');
            const dateStr = `${y}/${mo}/${d}`;
            
            document.getElementById('timeN').textContent = `${h}:${m}`;
            document.getElementById('timeS').textContent = `${h}:${m}`;
            document.getElementById('dateN').textContent = dateStr;
            document.getElementById('dateS').textContent = dateStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // 2. 工具函式
        function getTrainTypeName(train) {
            if (train.TrainTypeName && train.TrainTypeName.Zh_tw) {
                return train.TrainTypeName.Zh_tw.replace(/\(.*\)/, '');
            }

            const trainType = train.TrainTypeID || train.TrainType;
            const typeMap = {
                '1100': '自強', '1101': '太魯閣', '1102': '太魯閣',
                '1107': '普悠瑪', '1108': '自強', '1109': '自強', '110A': '自強',
                '110B': '自強(3000)', '110C': '自強(3000)',
                '1110': '莒光', '1111': '莒光', '1114': '莒光', '1115': '莒光',
                '1120': '復興', '1131': '區間', '1132': '區間快', '1140': '普快'
            };

            return typeMap[trainType] || '一般';
        }

        function formatTime(timeStr) {
            if (!timeStr) return '--:--';
            return timeStr.slice(0, 5);
        }

        function getDelayStatus(delay) {
            if (!delay || delay === 0) return { text: '準點', class: 'status-ontime' };
            return { text: `晚${delay}分`, class: 'status-delay' };
        }

        // 3. 初始化：從網址取得車站 ID
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const stationID = params.get('station');
            const stationName = params.get('name') || '臺鐵車站';

            // 設定站名
            document.getElementById('stationNameN').textContent = stationName;
            document.getElementById('stationNameS').textContent = stationName;

            if (stationID) {
                updatePidsData(stationID);
                setInterval(() => updatePidsData(stationID), 60000); // 每分鐘更新
            } else {
                renderScreen('north', []);
                renderScreen('south', []);
            }
        });

        // 4. 資料更新 (直接呼叫 TDX V2 API)
        async function updatePidsData(stationID) {
            try {
                const data = await tdxApi.fetch(`/v2/Rail/TRA/LiveBoard?$filter=StationID eq '${stationID}'&$format=JSON`);
                
                if (!data || data.length === 0) {
                    document.getElementById('marqueeN').textContent = "目前無列車資訊";
                    document.getElementById('marqueeS').textContent = "目前無列車資訊";
                    renderScreen('north', []);
                    renderScreen('south', []);
                    return;
                }

                const standardizedData = data.map(t => ({
                    TrainNo: t.TrainNo,
                    TrainType: t.TrainTypeID,
                    TrainTypeName: t.TrainTypeName,
                    EndingStationName: t.EndingStationName,
                    EndingStationDisplay: t.EndingStationName?.Zh_tw || t.EndingStationName,
                    DepartureTime: t.ScheduledDepartureTime,
                    ScheduledDepartureTime: t.ScheduledDepartureTime,
                    Delay: t.DelayTime || 0,
                    DelayTime: t.DelayTime || 0,
                    Direction: t.Direction,
                    StationID: t.StationID
                }));

                const northTrains = standardizedData
                    .filter(t => t.Direction == 1)
                    .sort((a, b) => a.DepartureTime.localeCompare(b.DepartureTime));
                
                const southTrains = standardizedData
                    .filter(t => t.Direction == 0)
                    .sort((a, b) => a.DepartureTime.localeCompare(b.DepartureTime));

                renderScreen('north', northTrains);
                renderScreen('south', southTrains);

                if (northTrains.length > 0) updateLiveMarquee('marqueeN', northTrains[0]);
                else document.getElementById('marqueeN').textContent = "目前無北上列車";

                if (southTrains.length > 0) updateLiveMarquee('marqueeS', southTrains[0]);
                else document.getElementById('marqueeS').textContent = "目前無南下列車";

            } catch (e) {
                console.error("API Error", e);
                document.getElementById('marqueeN').textContent = "⚠️ 連線異常，請稍候...";
                document.getElementById('marqueeS').textContent = "⚠️ 連線異常，請稍候...";
            }
        }

        // 5. 渲染表格 (顯示 6 列以填滿畫面)
        function renderScreen(dir, trains) {
            const tbody = document.getElementById(`${dir}Body`);
            tbody.innerHTML = '';
            const maxRows = 6;

            trains.slice(0, maxRows).forEach((train, index) => {
                const delay = train.Delay || 0;
                let delayText = '準點';
                let statusClass = 'status-ontime';

                if (delay > 0) {
                    delayText = `晚${delay}分`;
                    statusClass = 'status-delay';
                }

                const typeName = getTrainTypeName(train);
                const typeClass = (typeName.includes('自強') || typeName.includes('普悠瑪') || typeName.includes('太魯閣')) ? 'type-tze' : 'type-local';

                const row = document.createElement('tr');
                if (index === 0) row.classList.add('highlight-row');
                row.innerHTML = `
                    <td style="color:#fff;">${train.TrainNo}</td>
                    <td class="${typeClass}">${typeName}</td>
                    <td style="color:#fff;">${train.EndingStationDisplay || ''}</td>
                    <td style="color:#ffb74d;">${formatTime(train.DepartureTime)}</td>
                    <td class="${statusClass}">${delayText}</td>
                `;
                tbody.appendChild(row);
            });

            // 補空行
            for(let i=trains.length; i<maxRows; i++) {
                const emptyRow = tbody.insertRow();
                emptyRow.innerHTML = '<td>&nbsp;</td><td></td><td></td><td></td><td></td>';
            }
        }

        async function fetchScheduleWithFallback(trainNo) {
            try {
                const myApiUrl = `https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev/api/schedule?trainNo=${trainNo}`;
                const response = await fetch(myApiUrl);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0 && data[0].StopTimes) return data[0].StopTimes;
                }
            } catch (e) {
                console.warn(`D1 查詢失敗`, e);
            }

            try {
                const v2Data = await tdxApi.fetch(`/v2/Rail/TRA/DailyTrainInfo/TrainNo/${trainNo}?$format=JSON`);
                if (v2Data && v2Data.length > 0) return v2Data[0].StopTimes;
            } catch (e) {}

            return [];
        }

        async function updateLiveMarquee(elementId, train) {
            const el = document.getElementById(elementId);
            const trainNo = train.TrainNo;
            const currentStationID = train.StationID;
            el.textContent = `載入 ${trainNo} 次列車資訊中...`;

            try {
                const [liveDataArray, stopTimes] = await Promise.all([
                    tdxApi.fetch(`/v3/Rail/TRA/TrainLiveBoard/TrainNo/${trainNo}?$format=JSON`).catch(() => null),
                    fetchScheduleWithFallback(trainNo)
                ]);

                let locationText = "(訊號微弱，依時刻表行駛)";
                const liveData = (liveDataArray && liveDataArray.length > 0) ? liveDataArray[0] : null;

                if (liveData && liveData.StationName) {
                    const status = liveData.TrainStationStatus === 0 ? "進站中" : "已離開";
                    locationText = `${status} ${liveData.StationName.Zh_tw}`;
                }

                let nextStopsText = "";
                if (stopTimes && stopTimes.length > 0) {
                    const currentIndex = stopTimes.findIndex(s => s.StationID === currentStationID);
                    if (currentIndex !== -1 && currentIndex < stopTimes.length - 1) {
                        const nextStops = stopTimes.slice(currentIndex + 1);
                        const displayStops = nextStops.slice(0, 10).map(s => s.StationName.Zh_tw).join('▶');
                        nextStopsText = ` | 後續停靠：${displayStops}`;
                        if (nextStops.length > 10) nextStopsText += "...";
                    } else {
                        nextStopsText = " | 本列車即將抵達終點";
                    }
                }

                const delay = train.Delay == 0 ? "準點" : `晚 ${train.Delay} 分`;
                const typeName = train.TrainTypeName?.Zh_tw || '列車';
                const destination = train.EndingStationName?.Zh_tw || train.EndingStationName || '';
                const departureTime = train.ScheduledDepartureTime?
                    train.ScheduledDepartureTime.slice(0,5) : formatTime(train.DepartureTime);

                const text = `本班列車：${trainNo} 次 ${typeName} 往 ${destination} (${delay}) | 目前位置：${locationText} | 本站預計 ${departureTime} 開車${nextStopsText}`;
                el.textContent = text;

                const duration = Math.max(10, text.length * 0.25);
                el.style.animationDuration = `${duration}s`;
            } catch (e) {
                console.warn("Marquee Error", e);
                el.textContent = `${trainNo} 次 往 ${train.EndingStationName} (資料讀取中...)`;
            }
        }
    </script>
</body>
</html>
