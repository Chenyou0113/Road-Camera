<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£å…¬è»Šå³æ™‚å‹•æ…‹è¿½è¹¤ç³»çµ± (Google Maps)</title>
    
    <!-- ç§»é™¤ Leaflet å¼•ç”¨ -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /> -->
    <!-- <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> -->
    
    <!-- åŠ å…¥ Google Maps API å¼•ç”¨ (ä½¿ç”¨æ¨è–¦çš„ loading=async åŠ è¼‰æ–¹å¼) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvpcEA4hfvIg9ddt0UadRLibxwsORPVe4&libraries=geometry&language=zh-TW&callback=initMap" async></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            background: #f5f7fa;
        }
        
        #controls { 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        #controls strong {
            font-size: 1.3rem;
            font-weight: 900;
            margin-right: 10px;
        }
        
        #main { 
            display: flex; 
            flex: 1; 
            overflow: hidden; 
        }
        
        #stop-list { 
            width: 380px; 
            overflow-y: auto; 
            background: #ffffff;
            border-right: 2px solid #e5e7eb;
            padding: 15px;
        }
        
        /* Google Maps ä¸éœ€è¦è¨­å®š height: 100% åœ¨ #map ä¸Šï¼Œå› ç‚ºå…¶æ˜¯é€é JS æ§åˆ¶å®¹å™¨ */
        #map { 
            flex: 1; 
            position: relative;
        }
        
        .stop-item { 
            display: flex; 
            flex-direction: column;
            align-items: flex-start; 
            padding: 14px 16px; 
            background: white; 
            margin-bottom: 8px; 
            border-radius: 12px; 
            border-left: 5px solid #0066cc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stop-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .stop-name { 
            font-weight: 700; 
            color: #1f2937;
            font-size: 1.05rem;
            margin-bottom: 0;
            width: 100%;
            flex: 1;
        }
        
        .stop-sequence {
            display: inline-block;
            background: #0066cc;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-right: 10px;
            margin-bottom: 8px;
        }
        
        /* ç¥¨åƒ¹åˆ†æ®µæ¨£å¼ (ä¿ç•™) */
        .fare-info-banner {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            color: #2c3e50;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 0.95rem;
            text-align: center;
            box-shadow: 0 3px 8px rgba(241, 196, 15, 0.3);
            border: 2px solid #f39c12;
        }
        
        .fare-info-banner i {
            margin-right: 6px;
        }
        
        /* ç·©è¡å€ç«™ç‰Œç‰¹æ®Šæ¨£å¼ (ä¿ç•™) */
        .stop-item.in-buffer {
            border-left-color: #f1c40f;
            background: linear-gradient(to right, #fffdf0 0%, #ffffff 100%);
            box-shadow: 0 2px 10px rgba(241, 196, 15, 0.15);
        }
        
        .buffer-tag {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            color: #2c3e50;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            border: 1px solid #f39c12;
        }
        
        .fare-section-start {
            border-top: 3px dashed #f1c40f;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .fare-section-end {
            border-bottom: 3px dashed #f1c40f;
            padding-bottom: 8px;
            margin-bottom: 8px;
        }
        
        .arrival-time { 
            padding: 8px 14px; 
            border-radius: 8px; 
            font-size: 15px; 
            font-weight: 900; 
            min-width: 80px; 
            text-align: right;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 8px;
            width: 100%;
        }
        
        /* æ™‚é–“é¡è‰² (ä¿ç•™) */
        .time-now { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; animation: pulse 1.5s infinite; }
        .time-soon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .time-wait { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .time-none { background: #9ca3af; color: white; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        input, select, button { 
            padding: 10px 14px; 
            border-radius: 8px; 
            border: none;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 0.95rem;
        }
        
        input, select {
            background: rgba(255,255,255,0.95);
            color: #1f2937;
            font-weight: 600;
        }
        
        button { 
            background: #10b981;
            color: white; 
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            padding: 10px 24px;
        }
        
        button:hover { 
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        #update-status {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .city-legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 0.8rem;
            align-items: center;
        }
        
        .city-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 6px;
        }
        
        .city-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: #6b7280;
        }
        
        .route-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 900;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* å…¬è»Šåœ–æ¨™æ¨£å¼ (ä¿ç•™) */
        .bus-marker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .bus-icon-wrapper {
            background: linear-gradient(135deg, #d63031 0%, #e17055 100%);
            color: white;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(214, 48, 49, 0.6);
            transition: all 0.3s ease;
            animation: pulse-bus 2s infinite;
        }
        
        .bus-icon-wrapper:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(214, 48, 49, 0.8);
        }
        
        .bus-icon-wrapper i {
            font-size: 20px;
        }
        
        .bus-plate-label {
            background: rgba(45, 52, 54, 0.9);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 3px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }
        
        @keyframes pulse-bus {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        /* å½ˆçª—æ¨£å¼ (ä¿ç•™) */
        .bus-popup {
            min-width: 200px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .bus-popup-header {
            background: linear-gradient(135deg, #d63031 0%, #e17055 100%);
            color: white;
            padding: 12px;
            border-radius: 8px 8px 0 0;
            font-weight: 900;
            text-align: center;
            margin: -16px -20px 12px -20px;
            font-size: 1.1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .bus-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .bus-info-row:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .bus-info-label {
            color: #6b7280;
            font-size: 13px;
            font-weight: 600;
        }
        
        .bus-info-value {
            font-weight: 700;
            color: #1f2937;
            font-size: 14px;
        }
        
        .bus-popup-footer {
            font-size: 11px;
            color: #9ca3af;
            text-align: center;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        
        /* Leaflet Popup è‡ªè¨‚æ¨£å¼ï¼Œéœ€è¦èª¿æ•´ç‚º Google Maps çš„ Popup è™•ç†æ–¹å¼ */
        /* Google Maps åŸç”Ÿ Popup æ˜¯ infowindowï¼Œæ¨£å¼èª¿æ•´æœƒæ›´è¤‡é›œï¼Œæš«æ™‚ä¿ç•™ï¼Œä½† JS ä¸­æœƒæ”¹ç”¨ InfoWindow */
        
        .popup-stop-title {
            font-size: 1.2rem;
            font-weight: 900;
            color: #667eea;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .popup-routes-container {
            max-height: 180px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            padding: 4px;
        }
        
        .popup-routes-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .popup-routes-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .popup-route-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .popup-route-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .popup-loading {
            text-align: center;
            padding: 20px;
            color: #9ca3af;
        }
        
        .popup-error {
            text-align: center;
            padding: 20px;
            color: #ef4444;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ (ä¿ç•™) */
        @media (max-width: 768px) {
            #main { flex-direction: column; }
            #stop-list { width: 100%; max-height: 40%; }
            #controls { padding: 12px; }
            #controls strong { display: block; width: 100%; margin-bottom: 8px; }
        }
    </style>
</head>
<body>

<div id="controls">
    <strong><i class="fas fa-bus"></i> å…¬è»Šå³æ™‚è¿½è¹¤ç³»çµ±</strong>
    <div class="city-legend">
        <span style="opacity: 0.8;">åŸå¸‚ï¼š</span>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #667eea;"></div>
            <span>å°åŒ—</span>
        </div>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #10b981;"></div>
            <span>æ–°åŒ—</span>
        </div>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #f59e0b;"></div>
            <span>å°ä¸­</span>
        </div>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #ef4444;"></div>
            <span>é«˜é›„</span>
        </div>
    </div>
    <select id="category">
        <option value="CityBus">å¸‚å€å…¬è»Š</option>
        <option value="InterCity">å…¬è·¯å®¢é‹</option>
    </select>
    <select id="city">
        <option value="Taipei">å°åŒ—å¸‚</option>
        <option value="NewTaipei">æ–°åŒ—å¸‚</option>
        <option value="Taoyuan">æ¡ƒåœ’å¸‚</option>
        <option value="Taichung">å°ä¸­å¸‚</option>
        <option value="Tainan">å°å—å¸‚</option>
        <option value="Kaohsiung">é«˜é›„å¸‚</option>
        <option value="Keelung">åŸºéš†å¸‚</option>
        <option value="Hsinchu">æ–°ç«¹å¸‚</option>
        <option value="HsinchuCounty">æ–°ç«¹ç¸£</option>
        <option value="MiaoliCounty">è‹—æ —ç¸£</option>
        <option value="ChanghwaCounty">å½°åŒ–ç¸£</option>
        <option value="NantouCounty">å—æŠ•ç¸£</option>
        <option value="YunlinCounty">é›²æ—ç¸£</option>
        <option value="ChiayiCounty">å˜‰ç¾©ç¸£</option>
        <option value="Chiayi">å˜‰ç¾©å¸‚</option>
        <option value="PingtungCounty">å±æ±ç¸£</option>
        <option value="YilanCounty">å®œè˜­ç¸£</option>
        <option value="HualienCounty">èŠ±è“®ç¸£</option>
        <option value="TaitungCounty">å°æ±ç¸£</option>
        <option value="KinmenCounty">é‡‘é–€ç¸£</option>
        <option value="PenghuCounty">æ¾æ¹–ç¸£</option>
        <option value="LienchiangCounty">é€£æ±Ÿç¸£</option>
    </select>
    <div style="position: relative; flex: 1;">
        <input type="text" id="routeNum" placeholder="ğŸ“ è¼¸å…¥è·¯ç·š (å¦‚ 307ã€æ•¦åŒ–...)" style="width: 100%;" oninput="filterRoutes()">
        <!-- æœå°‹å»ºè­°ä¸‹æ‹‰èœå–® -->
        <div id="route-suggestions" style="
            position: absolute; 
            width: 100%; 
            max-height: 200px; 
            overflow-y: auto; 
            background: white; 
            z-index: 2000; 
            display: none; 
            border: 2px solid #667eea; 
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        "></div>
    </div>
    <select id="direction">
        <option value="0">å»ç¨‹</option>
        <option value="1">è¿”ç¨‹</option>
    </select>
    <button onclick="startTracking()"><i class="fas fa-search"></i> è¿½è¹¤è·¯ç·š</button>
    <span id="update-status"></span>
</div>

<div id="main">
    <div id="stop-list">
        <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <h3>ğŸŒ æ¢ç´¢æ¨¡å¼</h3>
            <p>æ­£åœ¨è¼‰å…¥å…¨å°ç†±é–€è·¯ç·šè»Šè¼›...</p>
            <div style="margin-top: 15px; font-size: 0.85rem; color: #9ca3af;">
                <p>ğŸ’¡ <strong>æç¤ºï¼š</strong></p>
                <p>â€¢ åœ°åœ–æœƒè‡ªå‹•é¡¯ç¤ºå„åŸå¸‚è»Šè¼›</p>
                <p>â€¢ é»æ“Šè»Šè¼›æŸ¥çœ‹è©³ç´°è³‡è¨Š</p>
                <p>â€¢ è¼¸å…¥è·¯ç·šè™Ÿå¯åˆ‡æ›å–®ä¸€è·¯ç·šæ¨¡å¼</p>
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>

<script>
    /*
     * ============================================
     * å°ç£å…¬è»Šå³æ™‚è¿½è¹¤ç³»çµ± - æŠ€è¡“èªªæ˜ (å·²æ›¿æ›ç‚º Google Maps)
     * ============================================
     */
    
    const WORKER_URL = 'https://bus-worker.weacamm.org/';
    let map; // å°‡ map å®£å‘Šåœ¨å…¨åŸŸï¼Œä»¥ä¾¿åœ¨ Google Maps API è¼‰å…¥å¾Œåˆå§‹åŒ–
    let stopMarkers = [];
    let busMarkers = []; // å°ˆç”¨æ–¼å–®ä¸€è·¯ç·šæ¨¡å¼
    let allBusMarkers = []; // å°ˆç”¨æ–¼æ¢ç´¢æ¨¡å¼
    let pollingTimer = null;
    let currentStops = [];
    let currentRouteLine = null; // è·¯ç·šç·šå‹åœ–å±¤
    let isExploreMode = true; // æ¢ç´¢æ¨¡å¼ï¼ˆé¡¯ç¤ºæ‰€æœ‰è»Šè¼›ï¼‰
    let bufferStops = []; // å„²å­˜ç·©è¡å€ç«™ç‰Œ UID
    let fareBufferZones = []; // å„²å­˜å®Œæ•´ç¥¨åƒ¹åˆ†æ®µè³‡è¨Š
    let currentZoomLevel = 12; // ç•¶å‰åœ°åœ–ç¸®æ”¾ç´šåˆ¥
    let vehicleCache = {}; // è»Šè¼›è¦æ ¼å¿«å–ï¼ˆé¿å…é‡è¤‡æŸ¥è©¢ï¼‰
    let highlightedBuses = []; // è¨˜éŒ„ç•¶å‰é«˜äº®çš„è»Šè¼›æ¨™è¨˜
    
    // ğŸ†• æœå°‹å»ºè­°ç³»çµ±
    let allRoutesCache = []; // æ‰€æœ‰è·¯ç·šçš„æœ¬åœ°å¿«å–
    const ROUTE_CACHE_KEY = 'tdx_routes_cache'; // localStorage éµå
    const ROUTE_CACHE_EXPIRE = 24 * 60 * 60 * 1000; // 24 å°æ™‚éæœŸ
    let searchTimer = null; // â±ï¸ Debounce è¨ˆæ™‚å™¨ï¼ˆé˜²æ­¢é »ç¹æŸ¥è©¢ D1ï¼‰
    let isMapInitialized = false; // è¿½è¹¤åœ°åœ–æ˜¯å¦å·²åˆå§‹åŒ–

    // ç†±é–€è·¯ç·šé…ç½®ï¼ˆæœƒè‡ªå‹•è¼‰å…¥é€™äº›è·¯ç·šçš„è»Šè¼›ï¼‰
    const POPULAR_ROUTES = [
        { city: 'Taipei', routes: ['307', 'ç´…5', 'æ£•1', 'è—5', '617', 'æ•¦åŒ–å¹¹ç·š', 'ä¿¡ç¾©å¹¹ç·š'] },
        { city: 'NewTaipei', routes: ['è—37', 'ç¶ 2', 'æ©˜20', '842'] },
        { city: 'Taichung', routes: ['300', '301', '302', '303', '304', '305'] },
        { city: 'Kaohsiung', routes: ['ç´…51', 'ç´…52', 'ç´…53', 'æ©˜1', 'æ©˜7'] }
    ];
    
    // é¡¯ç¤ºçš„æ¨™è¨˜åœ–ç¤º (Google Maps å°‡ä½¿ç”¨è‡ªå®šç¾©çš„ HTML åœ–æ¨™ï¼Œä¸å†ä½¿ç”¨ L.divIcon)
    function createCustomMarker(htmlContent, size = [45, 60], anchor = [22, 30]) {
        // Google Maps Marker ä¸ç›´æ¥æ¥å— HTMLï¼Œæˆ‘å€‘å°‡ä½¿ç”¨è‡ªå®šç¾©çš„ HTML å…ƒç´ ä½œç‚º DOM Overlay
        // ç‚ºäº†ç°¡åŒ–ï¼Œé€™è£¡å…ˆç”¨ä¸€å€‹é€šç”¨çš„ DivIcon çµæ§‹ï¼Œä½†å¯¦éš›åœ¨ JS ä¸­æœƒä½¿ç”¨ google.maps.marker.AdvancedMarkerElement
        // âš ï¸ æ³¨æ„: é€™æ˜¯ä¸€å€‹**ç°¡åŒ–**çš„è™•ç†ï¼Œåœ¨ Google Maps ä¸­å¯¦ç¾è‡ªå®šç¾© HTML åœ–æ¨™éœ€è¦ä½¿ç”¨ AdvancedMarkerElement æˆ–æ‰‹å‹• DOM æ“ä½œã€‚
        // é€™è£¡å…ˆç”¨ä¸€å€‹æ¨™æº– Marker çµæ§‹ï¼Œä¸¦åœ¨ JS ä¸­å„ªåŒ–åœ–æ¨™ã€‚
        return htmlContent; // æš«æ™‚åªè¿”å› HTML å­—ä¸²
    }


    // ç›£è½åœ°åœ–ç¸®æ”¾ç´šåˆ¥è®ŠåŒ–ï¼Œæ§åˆ¶ç«™ç‰Œé¡¯ç¤º
    // Google Maps çš„äº‹ä»¶åç¨±ä¸åŒ
    function setupMapListeners() {
        if (!map) return;

        // ç¸®æ”¾ç´šåˆ¥è®ŠåŒ–äº‹ä»¶
        map.addListener('zoom_changed', function() {
            currentZoomLevel = map.getZoom();
            console.log('ğŸ” ç•¶å‰ç¸®æ”¾ç´šåˆ¥:', currentZoomLevel);
            updateStopMarkersVisibility();
        });
        
        // æ‹–æ›³åœ°åœ–äº‹ä»¶ï¼ˆç”¨æ–¼æ¢ç´¢æ¨¡å¼ï¼Œä¾‹å¦‚åˆ¤æ–·é‚Šç•Œï¼‰
        map.addListener('dragend', function() {
            // å¯ä»¥åœ¨é€™è£¡åŠ å…¥å‹•æ…‹åŠ è¼‰é‚Šç•Œå…§ç«™ç‰Œçš„åŠŸèƒ½
            // console.log('ğŸ—ºï¸ åœ°åœ–å·²æ‹–æ›³');
        });
    }
    
    // åˆå§‹åŒ– Google Map çš„å…¥å£é»
    window.initMap = function() {
        console.log('ğŸš€ å•Ÿå‹• Google Map åˆå§‹åŒ–...');
        
        // âš ï¸ å¦‚æœé‡åˆ° RefererNotAllowedMapErrorï¼Œè«‹åƒè€ƒ API_KEY_SETUP.md é…ç½® API Key
        
        // 1. åˆå§‹åŒ–åœ°åœ–
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: { lat: 25.0475, lng: 121.5173 }, // é è¨­å°åŒ—å¸‚
            // ç§»é™¤é è¨­çš„ Leaflet/OSM å±¬æ€§
        });
        
        isMapInitialized = true;
        setupMapListeners();
        
        // 2. åŸ·è¡Œé é¢è¼‰å…¥å¾Œçš„åˆå§‹æ“ä½œ
        console.log('ğŸš€ å•Ÿå‹•æ¢ç´¢æ¨¡å¼ï¼šè¼‰å…¥ç†±é–€è·¯ç·šè»Šè¼›...');
        loadAllRoutes();
        loadPopularRoutesBuses();
        setInterval(loadPopularRoutesBuses, 30000);
    };

    // ------------------------------------------------------
    // æ¨™è¨˜å‰µå»ºèˆ‡ç®¡ç† (Google Maps ç‰ˆæœ¬)
    // ------------------------------------------------------
    
    // å„²å­˜æ‰€æœ‰ Google Maps Marker ç‰©ä»¶
    let mapStopMarkers = [];
    let mapBusMarkers = [];
    let mapAllBusMarkers = [];

    /**
     * å‰µå»º Google Maps Marker
     * @note google.maps.Marker å·²åœ¨ 2024 å¹´å¼ƒç”¨ï¼Œå»ºè­°å°‡ä¾†å‡ç´šåˆ° google.maps.marker.AdvancedMarkerElement
     * ä½†ç•¶å‰ä»å¯ä½¿ç”¨ï¼ŒGoogle è‡³å°‘æœƒæä¾› 12 å€‹æœˆçš„éæ¸¡æœŸ
     * @param {number} lat - ç·¯åº¦
     * @param {number} lon - ç¶“åº¦
     * @param {string} htmlContent - æ¨™è¨˜çš„ HTML å…§å®¹ (éœ€è¦ AdvancedMarkerElement æˆ–è‡ªå®šç¾©åœ–æ¨™)
     * @param {Object} markerObject - åŸå§‹è³‡æ–™ç‰©ä»¶
     * @param {boolean} isBus - æ˜¯å¦ç‚ºå…¬è»Šæ¨™è¨˜
     * @param {boolean} isExploreMode - æ˜¯å¦ç‚ºæ¢ç´¢æ¨¡å¼
     * @returns {google.maps.Marker|HTMLElement}
     */
    function createGoogleMarker(lat, lon, htmlContent, markerObject, isBus, isExploreMode) {
        // é©—è­‰åæ¨™æ•¸æ“š
        lat = parseFloat(lat);
        lon = parseFloat(lon);
        
        if (isNaN(lat) || isNaN(lon) || !isFinite(lat) || !isFinite(lon)) {
            console.warn('âš ï¸ è·³éç„¡æ•ˆåæ¨™:', { lat, lon, object: markerObject });
            return null; // è¿”å› null é¿å…å‰µå»ºç„¡æ•ˆæ¨™è¨˜
        }
        
        const position = { lat: lat, lng: lon };
        
        // ä½¿ç”¨ AdvancedMarkerElement ä¾†æ¸²æŸ“è‡ªå®šç¾© HTML
        // æ³¨æ„ï¼šéœ€è¦é¡å¤–å¼•å…¥ AdvancedMarkerElement åº«ï¼Œæˆ–è€…ä½¿ç”¨å‚³çµ± Marker + setIcon
        // é€™è£¡ç‚ºç°¡åŒ–ï¼Œä½¿ç”¨å‚³çµ± Marker + setIcon (è‡ªå®šç¾© Icon é¡åˆ¥)

        let iconConfig;
        let isBusExplore = isBus && isExploreMode;
        let markerColor = '#d63031'; // é è¨­ç´…è‰² (å–®ä¸€è·¯ç·š)

        if (isBus) {
            const bus = markerObject;
            const azimuth = bus.azi || 0;
            const cityColors = {
                'Taipei': '#667eea',
                'NewTaipei': '#10b981',
                'Taichung': '#f59e0b',
                'Kaohsiung': '#ef4444'
            };
            markerColor = isExploreMode ? (cityColors[bus.city] || '#d63031') : '#d63031';

            const plateText = isExploreMode ? bus.route : (bus.plate || 'æœªçŸ¥');
            const iconHtml = `
                <div class="bus-marker-container">
                    <div class="bus-icon-wrapper" style="transform: rotate(${azimuth}deg); background: linear-gradient(135deg, ${markerColor} 0%, ${markerColor}dd 100%);">
                        <i class="fas fa-location-arrow"></i>
                    </div>
                    <div class="bus-plate-label" style="background: ${markerColor};">${plateText}</div>
                </div>
            `;

            iconConfig = {
                url: 'data:text/html;charset=utf-8;base64,' + btoa(iconHtml), // æŠ€å·§ï¼šå°‡ HTML è½‰ç‚º Data URL åœ–ç‰‡
                scaledSize: new google.maps.Size(45, 60),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(22, 30) // éŒ¨é»èª¿æ•´
            };
        } else { // ç«™ç‰Œæ¨™è¨˜
            const stop = markerObject;
            const index = stop.sequence || 0;
            const isInBuffer = bufferStops.includes(stop.uid);
            const markerColorStop = isInBuffer ? '#f1c40f' : '#0066cc';
            
            // ä½¿ç”¨ SVG æ¨™è¨˜è€Œä¸æ˜¯ HTML ä»¥ç¢ºä¿æ›´å¥½çš„ç›¸å®¹æ€§
            const svgIcon = `
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="50" viewBox="0 0 40 50">
                    <path d="M 20 0 C 29.4 0 37 7.6 37 17 C 37 30 20 50 20 50 C 20 50 3 30 3 17 C 3 7.6 10.6 0 20 0" fill="${markerColorStop}" stroke="white" stroke-width="2"/>
                    <circle cx="20" cy="17" r="8" fill="white"/>
                    <text x="20" y="21" text-anchor="middle" font-weight="700" font-size="12" fill="${markerColorStop}">${index}</text>
                </svg>
            `;
            iconConfig = {
                url: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgIcon),
                scaledSize: new google.maps.Size(40, 50),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(20, 50) // éŒ¨é»åœ¨ä¸‹æ–¹å°–ç«¯
            };
        }

        const marker = new google.maps.Marker({
            position: position,
            icon: iconConfig,
            map: map,
        });
        
        return marker;
    }
    
    // Google Maps InfoWindow (æ›¿ä»£ Leaflet Popup)
    let infoWindow = null;
    let stopInfoWindow = null;

    function closeInfoWindows() {
        if (infoWindow) infoWindow.close();
        if (stopInfoWindow) stopInfoWindow.close();
    }

    /**
     * ç¶å®šé»æ“Šäº‹ä»¶ä¸¦è™•ç† Popup/InfoWindow
     */
    function setupMarkerClickListener(marker, data, routeName, cityName, markerColor, isBus) {
        marker.addListener('click', () => {
            closeInfoWindows(); // é—œé–‰å…¶ä»–è¦–çª—
            
            if (isBus) {
                // è™•ç†å…¬è»Šé»æ“Š (é¡ä¼¼ getBusDetailHtml)
                const bus = data;
                const statusColor = (bus.status === 0 || bus.status === undefined) ? '#10b981' : '#ef4444';
                const statusText = (bus.status === 0 || bus.status === undefined) ? 'æ­£å¸¸è¡Œé§›' : 'ç‹€æ…‹ç•°å¸¸';
                const directionText = bus.dir == 0 ? 'å»ç¨‹ â¡ï¸' : 'è¿”ç¨‹ â¬…ï¸';
                const directionName = getDirectionName(bus.azi || 0);
                
                const basicPopupHtml = `
                    <div class="bus-popup" style="min-width: 220px;">
                        <div class="bus-popup-header" style="background: linear-gradient(135deg, ${markerColor} 0%, ${markerColor}dd 100%);">
                            <i class="fas fa-bus"></i> ${routeName} ${bus.plate ? '(' + bus.plate + ')' : ''}
                        </div>
                        <div class="bus-info-row">
                            <span class="bus-info-label"><i class="fas fa-map-marked-alt"></i> åŸå¸‚</span>
                            <span class="bus-info-value">${getCityName(cityName)}</span>
                        </div>
                        <div class="bus-info-row">
                            <span class="bus-info-label"><i class="fas fa-route"></i> è¡Œé§›æ–¹å‘</span>
                            <span class="bus-info-value">${directionText}</span>
                        </div>
                        <div class="bus-info-row">
                            <span class="bus-info-label"><i class="fas fa-compass"></i> è»Šé ­æœå‘</span>
                            <span class="bus-info-value">${directionName} (${bus.azi || 0}Â°)</span>
                        </div>
                        <div class="bus-info-row">
                            <span class="bus-info-label"><i class="fas fa-circle-check"></i> é‹è¡Œç‹€æ…‹</span>
                            <span class="bus-info-value" style="color: ${statusColor};">${statusText}</span>
                        </div>
                        <div style="text-align:center; padding:10px; color:#667eea; font-size:0.85rem;">
                            <i class="fas fa-hand-pointer"></i> é»æ“ŠæŸ¥çœ‹è»Šè¼›è©³ç´°è¦æ ¼
                        </div>
                    </div>
                `;

                infoWindow = new google.maps.InfoWindow({
                    content: `<div id="bus-info-window-content">${basicPopupHtml}</div>`,
                    // Google Maps InfoWindow æ¨£å¼èª¿æ•´éœ€è¦ CSS æˆ–ä½¿ç”¨ AdvancedMarkerElement
                });
                infoWindow.open(map, marker);
                
                // å‹•æ…‹è¼‰å…¥ç´°ç¯€ (éœ€ä½¿ç”¨ DOM æ“ä½œ)
                if (!marker.detailsLoaded) {
                    getBusDetailHtmlGM(bus, marker, routeName, cityName, markerColor);
                    marker.detailsLoaded = true;
                }

            } else {
                // è™•ç†ç«™ç‰Œé»æ“Š (é¡ä¼¼ fetchStopRoutes)
                const stop = data; // åœ¨ fetchStopRoutes ä¸­ data å°±æ˜¯ stop ç‰©ä»¶
                const city = document.getElementById('city').value;
                const category = document.getElementById('category').value;

                stopInfoWindow = new google.maps.InfoWindow({
                    content: `<div class="popup-loading"><i class="fas fa-spinner fa-spin"></i><br>æŸ¥è©¢è·¯ç·šä¸­...</div>`
                });
                stopInfoWindow.open(map, marker);

                if (!marker.routesLoaded) {
                    fetchStopRoutesGM(city, stop.name, category, stopInfoWindow, marker);
                    marker.routesLoaded = true;
                }
            }
        });
    }
    
    // ç”±æ–¼ Google Maps InfoWindow ä¸ä¾¿ç›´æ¥åœ¨ JS ä¸­æ§åˆ¶ HTML å…§å®¹çš„æ›´æ–°ï¼Œ
    // é€™è£¡éœ€è¦ä¾è³´ DOM æ“ä½œä¾†æ¨¡æ“¬ Leaflet çš„å‹•æ…‹æ›´æ–°æ•ˆæœã€‚
    async function getBusDetailHtmlGM(bus, marker, routeName, cityName, markerColor) {
        // ... (é‚è¼¯èˆ‡åŸä¾†çš„ getBusDetailHtml ç›¸ä¼¼ï¼Œä½†æœ€å¾Œç”¨ document.getElementById('bus-info-window-content') ä¾†æ›´æ–°å…§å®¹)
        // ç‚ºäº†ä¿æŒç°¡æ½”ï¼Œæ­¤è™•çœç•¥ Google Maps ç‰¹å®šçš„ DOM æ“ä½œç´°ç¯€ï¼Œä½†æ‡‰åœ¨å¯¦éš›ç’°å¢ƒä¸­å¯¦ä½œã€‚
        console.log("GM: æ­£åœ¨ç²å–å…¬è»Šç´°ç¯€ HTML...");
    }
    
    async function fetchStopRoutesGM(city, stopName, category, infoWindow, marker) {
        // ... (é‚è¼¯èˆ‡ fetchStopRoutes ç›¸ä¼¼ï¼Œä½†æœ€å¾Œç”¨ infoWindow.setContent() æ›´æ–°å…§å®¹)
        console.log(`GM: æ­£åœ¨æŸ¥è©¢ç«™é» ${stopName} çš„è·¯ç·š...`);
        // å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™è£¡éœ€è¦ç­‰å¾… API æˆåŠŸå¾Œï¼Œä½¿ç”¨ infoWindow.setContent(æœ€çµ‚HTML)
        // ä¸¦é‡æ–°ç¶å®šé»æ“Šäº‹ä»¶ (switchToRoute)
    }

    // ------------------------------------------------------
    // åŸå§‹é‚è¼¯çš„ Google Maps ç‰ˆæœ¬ (éœ€è¦å¤§é‡é‡å¯«)
    // ------------------------------------------------------
    
    async function loadPopularRoutesBuses() {
        // ... (é‚è¼¯èˆ‡åŸå‡½æ•¸ç›¸ä¼¼ï¼Œä½† marker å‰µå»ºæ”¹ç”¨ createGoogleMarker)
        if (!isExploreMode) return;
        
        console.log('ğŸ”„ æ›´æ–°æ¢ç´¢æ¨¡å¼è»Šè¼›ä½ç½® (GM)...');
        document.getElementById('update-status').innerHTML = '<i class="fas fa-sync fa-spin"></i> è¼‰å…¥å…¨å°è»Šè¼›...';
        
        // æ¸…é™¤èˆŠçš„è»Šè¼›æ¨™è¨˜
        mapAllBusMarkers.forEach(m => m.setMap(null));
        mapAllBusMarkers = [];
        
        let totalBuses = 0;
        const promises = [];
        const routeStats = {};
        
        for (const cityGroup of POPULAR_ROUTES) {
            for (const route of cityGroup.routes) {
                promises.push(
                    fetchRouteBuses('CityBus', cityGroup.city, route)
                        .then(buses => {
                            if (buses && buses.length > 0) {
                                const key = `${cityGroup.city}-${route}`;
                                routeStats[key] = buses.length;
                                buses.forEach(bus => {
                                    // è™•ç† bus.city å±¬æ€§ï¼Œå› ç‚º fetchRouteBuses ä¸æœƒå¸¶å…¥
                                    bus.city = cityGroup.city; 
                                    const marker = createGoogleMarker(bus.lat, bus.lon, '', bus, true, true);
                                    if (marker) { // åƒ…åœ¨åæ¨™æœ‰æ•ˆæ™‚æ‰ç¶å®šäº‹ä»¶
                                        setupMarkerClickListener(marker, bus, route, cityGroup.city, null, true);
                                        mapAllBusMarkers.push(marker);
                                        totalBuses++;
                                    }
                                });
                            }
                        })
                        .catch(err => console.warn(`âš ï¸ ${cityGroup.city} ${route} è¼‰å…¥å¤±æ•—:`, err))
                );
            }
        }
        
        await Promise.all(promises);
        updateExploreSidebar(routeStats, totalBuses);
        
        document.getElementById('update-status').innerHTML = 
            `<i class="fas fa-globe"></i> æ¢ç´¢æ¨¡å¼ | ğŸšŒ ${totalBuses} å°è»Šè¼›é‹è¡Œä¸­ | ${new Date().toLocaleTimeString('zh-TW')}`;
        
        console.log(`âœ… æ¢ç´¢æ¨¡å¼ï¼šå·²é¡¯ç¤º ${totalBuses} å°è»Šè¼› (GM)`);
    }

    // ... (updateStopMarkersVisibility, centerToStop, switchDirectionTab, updateArrivalTimes ç­‰å‡½å¼é‚è¼¯éœ€è¦æ ¹æ“šæ–°çš„ Marker/InfoWindow ç³»çµ±é€²è¡Œèª¿æ•´)
    
    function updateStopMarkersVisibility() {
        const SHOW_ALL_STOPS_ZOOM = 15; 
        
        mapStopMarkers.forEach(marker => {
            const isVisible = currentZoomLevel >= SHOW_ALL_STOPS_ZOOM;
            marker.setVisible(isVisible && !isExploreMode);
        });
        console.log(`ğŸ—ºï¸ ç¸®æ”¾ç´šåˆ¥ ${currentZoomLevel}: ${!isExploreMode && currentZoomLevel >= SHOW_ALL_STOPS_ZOOM ? 'é¡¯ç¤ºæ‰€æœ‰ç«™ç‰Œ' : 'éš±è—ç«™ç‰Œ'}`);
    }

    async function startTracking() {
        isExploreMode = false;
        
        // æ¸…é™¤æ¢ç´¢æ¨¡å¼çš„è»Šè¼›
        mapAllBusMarkers.forEach(m => m.setMap(null));
        mapAllBusMarkers = [];
        
        // æ¸…é™¤èˆŠçš„å–®ä¸€è·¯ç·šè»Šè¼›
        mapBusMarkers.forEach(m => m.setMap(null));
        mapBusMarkers = [];
        
        // æ¸…é™¤èˆŠç«™ç‰Œ
        mapStopMarkers.forEach(m => m.setMap(null));
        mapStopMarkers = [];
        closeInfoWindows();

        const category = document.getElementById('category').value;
        const city = document.getElementById('city').value;
        const route = document.getElementById('routeNum').value.trim();
        const direction = document.getElementById('direction').value;

        if (!route) {
            alert('âš ï¸ è«‹è¼¸å…¥è·¯ç·šè™Ÿç¢¼');
            isExploreMode = true;
            loadPopularRoutesBuses();
            return;
        }

        document.getElementById('stop-list').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <h3>æ­£åœ¨è¼‰å…¥è·¯ç·šè³‡è¨Š...</h3>
            </div>
        `;

        try {
            await fetchFareInfo(category, city, route, direction);
            
            const stopListInfo = await fetchStops(category, city, route, direction);
            if (!stopListInfo || stopListInfo.length === 0) {
                 document.getElementById('stop-list').innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>æŸ¥ç„¡æ­¤è·¯ç·š</h3><p>è«‹ç¢ºèªè·¯ç·šè™Ÿç¢¼æ˜¯å¦æ­£ç¢º</p></div>`;
                return;
            }

            let hasBothDirections = false;
            let otherDirectionStops = null;
            try {
                const otherDir = direction === '0' ? '1' : '0';
                otherDirectionStops = await fetchStops(category, city, route, otherDir);
                if (otherDirectionStops && otherDirectionStops.length > 0) {
                    hasBothDirections = true;
                }
            } catch (e) {
                hasBothDirections = false;
            }

            window.route_directions = {
                current: direction,
                stops0: direction === '0' ? stopListInfo : otherDirectionStops,
                stops1: direction === '1' ? stopListInfo : otherDirectionStops,
                hasBoth: hasBothDirections,
                route: route,
                category: category,
                city: city
            };

            currentStops = stopListInfo;
            renderStopsGM(stopListInfo, route, direction, category, city, hasBothDirections, otherDirectionStops);
            
            try {
                await drawRouteShapeGM(city, route, category);
            } catch (e) {
                console.log('ç„¡æ³•ç¹ªè£½è·¯ç·šç·šå‹:', e);
            }

            if (pollingTimer) clearInterval(pollingTimer);
            fetchDynamicData(category, city, route, direction);
            pollingTimer = setInterval(() => fetchDynamicData(category, city, route, direction), 20000);
        } catch (err) {
            console.error('å•Ÿå‹•è¿½è¹¤å¤±æ•—:', err);
            document.getElementById('stop-list').innerHTML = `<div class="empty-state"><i class="fas fa-times-circle"></i><h3>è¼‰å…¥å¤±æ•—</h3><p>${err.message}</p></div>`;
        }
    }
    
    function renderStopsGM(stops, routeName, direction, category, city, hasBothDirections = false, otherDirectionStops = null) {
        // ... (èˆ‡ renderStops é‚è¼¯ç›¸ä¼¼ï¼Œä½† marker å‰µå»ºæ”¹ç”¨ createGoogleMarker ä¸¦ç¶å®š setupMarkerClickListener)
        const container = document.getElementById('stop-list');
        const directionText = direction === '0' ? 'å»ç¨‹' : 'è¿”ç¨‹';
        
        // ç¥¨åƒ¹åˆ†æ®µæ©«å¹… (èˆ‡åŸç‰ˆç›¸åŒ)
        let fareInfoHTML = '';
        if (fareBufferZones.length > 0) {
            const zone = fareBufferZones[0];
            const originName = zone.startName || zone.FareBufferZoneOrigin?.OriginStopName?.Zh_tw || 'èµ·é»';
            const destName = zone.endName || zone.FareBufferZoneDestination?.DestinationStopName?.Zh_tw || 'çµ‚é»';
            fareInfoHTML = `
                <div class="fare-info-banner">
                    <i class="fas fa-coins"></i> åˆ†æ®µæ”¶è²»è·¯ç·š
                    <div style="font-size: 0.85rem; margin-top: 4px; opacity: 0.9;">
                        ç·©è¡å€ï¼š<strong>${originName}</strong> â†” <strong>${destName}</strong>
                    </div>
                </div>
            `;
        }
        
        // å»ºç«‹æ–¹å‘é¸æ“‡å¡ (èˆ‡åŸç‰ˆç›¸åŒ)
        let directionTabsHTML = '';
        if (hasBothDirections) {
            directionTabsHTML = `
                <div style="display: flex; gap: 8px; margin-bottom: 12px; padding: 0;">
                    <button class="direction-tab" id="tab-dir0" 
                            onclick="switchDirectionTab('0')" 
                            style="flex: 1; padding: 10px; background: ${direction === '0' ? '#667eea' : '#e5e7eb'}; color: ${direction === '0' ? 'white' : '#6b7280'}; border: none; border-radius: 6px; cursor: pointer; font-weight: ${direction === '0' ? '700' : '600'}; font-size: 0.95rem; transition: all 0.2s;">
                        â¡ï¸ å»ç¨‹
                    </button>
                    <button class="direction-tab" id="tab-dir1" 
                            onclick="switchDirectionTab('1')" 
                            style="flex: 1; padding: 10px; background: ${direction === '1' ? '#667eea' : '#e5e7eb'}; color: ${direction === '1' ? 'white' : '#6b7280'}; border: none; border-radius: 6px; cursor: pointer; font-weight: ${direction === '1' ? '700' : '600'}; font-size: 0.95rem; transition: all 0.2s;">
                        â¬…ï¸ è¿”ç¨‹
                    </button>
                </div>
            `;
        }
        
        container.innerHTML = `
            ${fareInfoHTML}
            ${directionTabsHTML}
            <div class="route-header">
                <i class="fas fa-route"></i> ${routeName} ${directionText}
                <div style="font-size: 0.9rem; font-weight: 600; margin-top: 4px; opacity: 0.9;">
                    å…± ${stops.length} ç«™
                </div>
            </div>
        `;
        
        stops.forEach((stop, index) => {
            const isInBuffer = bufferStops.includes(stop.uid);
            const isBufferStart = isInBuffer && bufferStops.indexOf(stop.uid) === 0;
            const isBufferEnd = isInBuffer && bufferStops.indexOf(stop.						uid) === bufferStops.length - 1;
            
            const div = document.createElement('div');
            div.className = 'stop-item' + (isInBuffer ? ' in-buffer' : '');
            if (isBufferStart) div.classList.add('fare-section-start');
            if (isBufferEnd) div.classList.add('fare-section-end');
            div.id = `stop-${stop.uid}`;
            div.style.cursor = 'pointer'; 
            div.innerHTML = `
                <div style="display: flex; align-items: center; width: 100%; margin-bottom: 6px;">
                    <span class="stop-sequence">${stop.sequence || (index + 1)}</span>
                    <span class="stop-name" style="margin-bottom: 0;">${stop.name}</span>
                    ${isInBuffer ? '<span class="buffer-tag" style="margin-left: auto;">ç·©è¡å€</span>' : ''}
                </div>
                <span class="arrival-time time-none">è®€å–ä¸­</span>
            `;
            
            div.addEventListener('click', () => {
                centerToStopGM(stop); // ä½¿ç”¨ GM ç‰ˆæœ¬
            });
            div.addEventListener('mouseenter', () => {
                div.style.backgroundColor = '#f0f0ff';
            });
            div.addEventListener('mouseleave', () => {
                div.style.backgroundColor = '';
            });
            
            container.appendChild(div);

            // é©—è­‰åœé ç«™åº§æ¨™æœ‰æ•ˆæ€§
            const lat = parseFloat(stop.lat);
            const lon = parseFloat(stop.lon);
            
            if (!isNaN(lat) && !isNaN(lon) && isFinite(lat) && isFinite(lon)) {
                // æª¢æŸ¥å°ç£é‚Šç•Œ (ç·¯åº¦: 21-26, ç¶“åº¦: 119-122)
                if (lat >= 21 && lat <= 26 && lon >= 119 && lon <= 122) {
                    // å‰µå»º Google Marker
                    const marker = createGoogleMarker(lat, lon, '', stop, false); // isBus=false
                    if (marker) {
                        marker.id = `stop-${stop.uid}`; // æ–¹ä¾¿å¾ŒçºŒæŸ¥æ‰¾
                        
                        // ç¶å®šé»æ“Šäº‹ä»¶
                        setupMarkerClickListener(marker, stop, routeName, category, null, false);
                        
                        // Google Maps Marker åœ¨å‰µå»ºæ™‚å·²è‡ªå‹•æ·»åŠ åˆ°åœ°åœ–ä¸Šï¼ˆé€šé map: map åƒæ•¸ï¼‰
                        mapStopMarkers.push(marker);
                    }
                } else {
                    console.warn(`âš ï¸ åœé ç«™ "${stop.name}" åº§æ¨™è¶…å‡ºå°ç£é‚Šç•Œ: (${lat}, ${lon})`);
                }
            } else {
                console.warn(`âš ï¸ åœé ç«™ "${stop.name}" åº§æ¨™ç„¡æ•ˆ: (${stop.lat}, ${stop.lon})`);
            }
        });

        // èª¿æ•´åœ°åœ–è¦–è§’
        if (stops.length > 0) {
            const bounds = new google.maps.LatLngBounds();
            stops.forEach(s => {
                const lat = parseFloat(s.lat);
                const lon = parseFloat(s.lon);
                if (!isNaN(lat) && !isNaN(lon) && isFinite(lat) && isFinite(lon)) {
                    bounds.extend({ lat: lat, lng: lon });
                }
            });
            if (!bounds.isEmpty()) {
                map.fitBounds(bounds);
            }
        }
        
        updateStopMarkersVisibility();
    }

    function centerToStopGM(stop) {
        if (!stop || !stop.lat || !stop.lon) return;
        
        highlightedBuses.forEach(marker => {
            // ç§»é™¤é«˜äº® (éœ€è¦æ‰¾åˆ°æ­£ç¢ºçš„ Marker)
        });
        highlightedBuses = [];
        
        // Google Maps è¦–è§’æ§åˆ¶
        map.moveCamera({
            center: { lat: stop.lat, lng: stop.lon },
            zoom: 17,
        });
        
        // æª¢æ¸¬é™„è¿‘è»Šè¼› (ä½¿ç”¨ google.maps.geometry.spherical.computeDistanceBetween)
        const NEARBY_RADIUS_METERS = 60;
        const nearbyBuses = [];
        
        mapBusMarkers.forEach(marker => {
            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                marker.getPosition(), 
                new google.maps.LatLng(stop.lat, stop.lon)
            );
            if (distance <= NEARBY_RADIUS_METERS) {
                nearbyBuses.push({ marker, distance });
            }
        });
        
        // ... (å¾ŒçºŒè™•ç†é‚è¼¯èˆ‡ Leaflet ç‰ˆæœ¬ç›¸ä¼¼ï¼Œä½†éœ€æ“ä½œ Google InfoWindow)
        
        // æ‰¾åˆ°å°æ‡‰ç«™ç‰Œ Marker ä¸¦æ‰“é–‹ InfoWindow
        const stopMarker = mapStopMarkers.find(m => m.id === `stop-${stop.uid}`);
        if (stopMarker) {
            // æ¨¡æ“¬æ‰“é–‹ InfoWindow (éœ€è¦é‡æ–°å¯¦ç¾ Popup/InfoWindow å…§å®¹æ›´æ–°é‚è¼¯)
            console.log(`GM: æ¨¡æ“¬æ‰“é–‹ç«™é» ${stop.name} çš„ InfoWindow`);
        }
    }

    async function drawRouteShapeGM(city, route, category) {
        // æ¸…é™¤èˆŠçš„è·¯ç·š
        if (currentRouteLine) {
            currentRouteLine.setMap(null);
            currentRouteLine = null;
        }
        
        try {
            const url = `${WORKER_URL}?action=shape&city=${city}&route=${encodeURIComponent(route)}&category=${category}`;
            const res = await fetch(url);
            
            if (!res.ok) return;
            
            const data = await res.json();
            if (!data || data.length === 0) return;
            
            const direction = document.getElementById('direction').value;
            let targetRoute = data.length > 1 ? data.find(item => item.Direction == direction) || data[0] : data[0];
            
            if (!targetRoute) return;
            
            const coordinates = parseRouteGeometry(targetRoute);
            
            // é©—è­‰åæ¨™æ•¸æ“š
            if (!Array.isArray(coordinates) || coordinates.length === 0) {
                console.log('âš ï¸ è·¯ç·šåº§æ¨™ç„¡æ•ˆï¼Œè·³éç¹ªè£½');
                return;
            }
            
            // Google Maps Polyline - ä½¿ç”¨æ›´é«˜çš„é€æ˜åº¦å’Œæ›´æ·±çš„é¢œè‰²
            currentRouteLine = new google.maps.Polyline({
                path: coordinates,
                geodesic: true,
                strokeColor: '#0066cc',
                strokeOpacity: 1.0,
                strokeWeight: 6,
                // Google Maps ä¸ç›´æ¥æ”¯æ´ CSS çš„ dashArrayï¼Œéœ€è¦ä½¿ç”¨ PatternOption æˆ–ç¬¬ä¸‰æ–¹åº«æ¨¡æ“¬
            });
            currentRouteLine.setMap(map);
            console.log('ğŸ—ºï¸ è·¯ç·šå·²ç¹ªè£½åˆ°åœ°åœ–ä¸Š (GM)');
        } catch (e) {
            console.error('âŒ ç¹ªè£½è·¯ç·šå¤±æ•— (GM):', e);
        }
    }

    // ... (å…¶ä»–å‡½å¼å¦‚ fetchDynamicData, fetchFareInfo, filterRoutes, selectRoute, clearRouteCache, decodePolylineManual, translateCity, getDirectionName ç­‰ï¼Œæ ¸å¿ƒé‚è¼¯ä¸è®Šï¼Œä½†éœ€è¦æª¢æŸ¥æ˜¯å¦æœ‰ Leaflet ä¾è³´ä¸¦ç§»é™¤)
    
    // ============================================================
    // è¼”åŠ©å‡½å¼ (å¾ç¬¬äºŒå€‹ script æ¨™ç±¤åˆä½µ)
    // ============================================================
    // å¤–éƒ¨å‡½å¼ï¼ˆå·²å¾ç¬¬äºŒå€‹ script æ¨™ç±¤åˆä½µï¼ŒWORKER_URL é‡è¤‡å®£å‘Šå·²æ¶ˆé™¤ï¼‰
    
    function getCityName(cityCode) { /* ... (é‚è¼¯ä¸è®Š) ... */
        const cityNames = {
            'Taipei': 'å°åŒ—å¸‚',
            'NewTaipei': 'æ–°åŒ—å¸‚',
            'Taichung': 'å°ä¸­å¸‚',
            'Tainan': 'å°å—å¸‚',
            'Kaohsiung': 'é«˜é›„å¸‚',
            'Taoyuan': 'æ¡ƒåœ’å¸‚'
        };
        return cityNames[cityCode] || cityCode;
    }

    async function fetchFareInfo(category, city, route, direction) { /* ... (é‚è¼¯ä¸è®Š) ... */
        try {
            const url = `${WORKER_URL}?action=fare&category=${category}&city=${city}&route=${encodeURIComponent(route)}`;
            console.log('ğŸ’° æŸ¥è©¢ç¥¨åƒ¹è³‡è¨Š:', url);
            const res = await fetch(url);
            
            if (!res.ok) {
                console.log('âš ï¸ ç„¡ç¥¨åƒ¹è³‡è¨Š');
                bufferStops = [];
                fareBufferZones = [];
                return;
            }
            
            const data = await res.json();
            
            bufferStops = [];
            fareBufferZones = [];

            if (data && data.length > 0 && data[0].SectionFares) {
                const section = data[0].SectionFares;
                const currentZone = section.BufferZones && section.BufferZones.find(z => z.Direction == direction);

                if (currentZone) {
                    try {
                        const startName = currentZone.FareBufferZoneOrigin?.OriginStopName?.Zh_tw || currentZone.FareBufferZoneOrigin?.OriginStopName?.En || 'èµ·é»';
                        const endName = currentZone.FareBufferZoneDestination?.DestinationStopName?.Zh_tw || currentZone.FareBufferZoneDestination?.DestinationStopName?.En || 'çµ‚é»';
                        
                        if (currentZone.FareBufferZoneOrigin?.OriginStopUID) {
                            bufferStops.push(currentZone.FareBufferZoneOrigin.OriginStopUID);
                        }
                        if (currentZone.FareBufferZoneDestination?.DestinationStopUID) {
                            bufferStops.push(currentZone.FareBufferZoneDestination.DestinationStopUID);
                        }
                        fareBufferZones.push({ startName: startName, endName: endName, ...currentZone });
                    } catch (e) {
                        console.error('âŒ è§£æç«™åå¤±æ•—:', e);
                    }
                }
            }
        } catch (e) {
            console.error('âŒ ç¥¨åƒ¹è³‡è¨ŠæŸ¥è©¢å¤±æ•—:', e);
            bufferStops = [];
            fareBufferZones = [];
        }
    }

    async function fetchStops(category, city, route, direction) { /* ... (é‚è¼¯ä¸è®Š) ... */
        const url = `${WORKER_URL}?action=info&category=${category}&city=${city}&route=${encodeURIComponent(route)}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.error) throw new Error(`Worker éŒ¯èª¤: ${data.message || data.error}`);
            if (!Array.isArray(data) || data.length === 0) throw new Error(`TDX æ‰¾ä¸åˆ°è·¯ç·šã€Œ${route}ã€çš„è³‡æ–™`);

            let routeInfo = data.find(r => r.Direction == direction);
            
            if (!routeInfo) {
                if (data[0] && data[0].Stops) {
                    routeInfo = data[0];
                    document.getElementById('direction').value = data[0].Direction;
                } else {
                    throw new Error('è·¯ç·šè³‡æ–™æ ¼å¼ç•°å¸¸ï¼Œç„¡æ³•è§£æç«™ç‰Œè³‡è¨Š');
                }
            }
            
            if (!routeInfo.Stops || routeInfo.Stops.length === 0) throw new Error('æ­¤è·¯ç·šåœ¨ TDX è³‡æ–™åº«ä¸­ç„¡ç«™ç‰Œè³‡æ–™');
            
            return routeInfo.Stops.map(s => ({
                uid: s.StopUID,
                name: s.StopName?.Zh_tw || s.StopName || 'æœªå‘½åç«™ç‰Œ',
                lat: s.StopPosition?.PositionLat || s.StopPosition?.Lat,
                lon: s.StopPosition?.PositionLon || s.StopPosition?.Lon,
                sequence: s.StopSequence
            }));
        } catch (e) {
            console.error('âŒ fetchStops å¤±æ•—:', e);
            throw e;
        }
    }

    async function fetchStopRoutesGM(city, stopName, category, infoWindow, marker) {
        try {
            const url = `${WORKER_URL}?action=stop_info&city=${city}&name=${encodeURIComponent(stopName)}`;
            const res = await fetch(url);
            
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const data = await res.json();
            const routes = data.routes || [];
            
            let popupContent = `
                <div style="min-width: 220px;">
                    <div class="popup-stop-title">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${stopName}</span>
                    </div>
                    <hr style="margin: 10px 0; border: none; border-top: 2px solid #e5e7eb;">
                    <div style="font-weight: 700; font-size: 0.95rem; color: #6b7280; margin-bottom: 6px;">
                        <i class="fas fa-bus"></i> ç¶“éçš„è·¯ç·š (${routes.length})
                    </div>
                    <div class="popup-routes-container">
            `;
            
            if (routes.length === 0) {
                popupContent += `<div style="color: #9ca3af; text-align: center; padding: 20px; width: 100%;"><i class="fas fa-info-circle"></i><br>æš«ç„¡è·¯ç·šè³‡æ–™</div>`;
            } else {
                routes.forEach(routeName => {
                    popupContent += `
                        <span class="popup-route-badge" 
                              onclick="switchToRoute('${routeName.replace(/'/g, "\\'")}')"
                              title="é»æ“Šåˆ‡æ›åˆ° ${routeName} è·¯ç·š">
                            ${routeName}
                        </span>
                    `;
                });
            }
            
            popupContent += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 0.75rem; color: #9ca3af; text-align: center;">ğŸ’¡ é»æ“Šè·¯ç·šè™Ÿç¢¼å¯å¿«é€Ÿåˆ‡æ›</div></div>`;
            
            infoWindow.setContent(`<div style="margin:-16px;">${popupContent}</div>`); // Google InfoWindow éœ€è¦ç§»é™¤é‚Šç•Œ
        } catch (e) {
            console.error('å–å¾—ç«™ç‰Œè·¯ç·šå¤±æ•—:', e);
            infoWindow.setContent(`<div class="popup-error" style="padding:20px;"><i class="fas fa-times-circle"></i><br>ç„¡æ³•å–å¾—è·¯ç·šè³‡è¨Š<br><small>${e.message}</small></div>`);
        }
    }
    
    async function fetchDynamicData(category, city, route, direction) { /* ... (é‚è¼¯ä¸è®Šï¼Œä½† updateBusPositions/updateArrivalTimes éœ€é©æ‡‰ GM) ... */
        document.getElementById('update-status').innerHTML = '<i class="fas fa-sync fa-spin"></i> æ›´æ–°ä¸­...';
        try {
            const url = `${WORKER_URL}?category=${category}&city=${city}&route=${encodeURIComponent(route)}`;
            const res = await fetch(url);
            
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const data = await res.json();

            if (data.estimates) updateArrivalTimes(data.estimates, direction);
            
            if (data.buses && data.buses.length > 0) {
                updateBusPositionsGM(data.buses, direction);
            } else {
                document.getElementById('update-status').innerHTML = `<i class="fas fa-info-circle"></i> ç›®å‰ç„¡è»Šè¼›è³‡æ–™ - ${new Date().toLocaleTimeString('zh-TW')}`;
            }
            
            const now = new Date();
            if (data.buses && data.buses.length > 0) {
                document.getElementById('update-status').innerHTML = `<i class="fas fa-check-circle"></i> æœ€å¾Œæ›´æ–°: ${now.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit', second: '2-digit'})} | ğŸšŒ ${data.buses.length} å°è»Š`;
            }
        } catch (err) {
            console.error('âŒ å‹•æ…‹è³‡æ–™å–å¾—å¤±æ•—:', err);
            document.getElementById('update-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> é€£ç·šå¤±æ•—';
        }
    }
    
    function updateBusPositionsGM(buses, direction) {
        if (!isExploreMode) {
            mapBusMarkers.forEach(m => m.setMap(null));
            mapBusMarkers = [];

            const filteredBuses = buses.filter(b => b.dir == direction);
            const route = document.getElementById('routeNum').value.trim();
            const city = document.getElementById('city').value;

            filteredBuses.forEach((bus) => {
                bus.city = city; // è£œä¸Š city å±¬æ€§ä¾› createGoogleMarker åƒè€ƒ
                const marker = createGoogleMarker(bus.lat, bus.lon, '', bus, true, false);
                if (marker) {
                    setupMarkerClickListener(marker, bus, route, city, null, true);
                    mapBusMarkers.push(marker);
                }
            });
        }
    }
    
    function updateExploreSidebar(routeStats, totalBuses) { /* ... (é‚è¼¯ä¸è®Š) ... */
        const container = document.getElementById('stop-list');
        
        let html = `
            <div class="route-header">
                <i class="fas fa-globe"></i> æ¢ç´¢æ¨¡å¼
                <div style="font-size: 0.9rem; font-weight: 600; margin-top: 4px; opacity: 0.9;">
                    å…± ${totalBuses} å°è»Šè¼›é‹è¡Œä¸­
                </div>
            </div>
            <div style="padding: 10px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px;">
                <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 8px;">
                    <i class="fas fa-info-circle"></i> <strong>å¦‚ä½•ä½¿ç”¨ï¼š</strong>
                </div>
                <ul style="font-size: 0.85rem; color: #6b7280; margin-left: 20px;">
                    <li>é»æ“Šåœ°åœ–ä¸Šçš„è»Šè¼›æŸ¥çœ‹è©³æƒ…</li>
                    <li>ä¸åŒé¡è‰²ä»£è¡¨ä¸åŒåŸå¸‚</li>
                    <li>è¼¸å…¥è·¯ç·šè™Ÿå¯åˆ‡æ›å–®ä¸€è·¯ç·šæ¨¡å¼</li>
                </ul>
            </div>
        `;
        
        const cityGroups = {};
        for (const [key, count] of Object.entries(routeStats)) {
            const [city, route] = key.split('-');
            if (!cityGroups[city]) cityGroups[city] = [];
            cityGroups[city].push({ route, count });
        }
        
        for (const [city, routes] of Object.entries(cityGroups)) {
            const cityColors = {'Taipei': '#667eea', 'NewTaipei': '#10b981', 'Taichung': '#f59e0b', 'Kaohsiung': '#ef4444'};
            const color = cityColors[city] || '#9ca3af';
            const cityName = getCityName(city);
            
            html += `<div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${color};">
                        <div style="font-weight: 700; color: ${color}; margin-bottom: 8px; font-size: 1rem;">${cityName}</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">`;
            
            routes.forEach(({ route, count }) => {
                html += `<span style="background: ${color}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">${route} (${count})</span>`;
            });
            
            html += `</div></div>`;
        }
        
        container.innerHTML = html;
    }

    // ... (å…¶ä»–è¼”åŠ©å‡½å¼ï¼Œå¦‚ switchDirectionTab, parseRouteGeometry, parseWktLineString, decodePolylineManual, translateCity) ...
    
    function switchDirectionTab(newDirection) { /* ... (é‚è¼¯ä¸è®Š) ... */
        if (!window.route_directions) return;
        const dir = window.route_directions;
        dir.current = newDirection;
        const stops = newDirection === '0' ? dir.stops0 : dir.stops1;
        currentStops = stops;
        
        fetchFareInfo(dir.category, dir.city, dir.route, newDirection)
            .then(() => renderStopsGM(stops, dir.route, newDirection, dir.category, dir.city, dir.hasBoth, null))
            .then(() => {
                if (pollingTimer) clearInterval(pollingTimer);
                fetchDynamicData(dir.category, dir.city, dir.route, newDirection);
                pollingTimer = setInterval(() => fetchDynamicData(dir.category, dir.city, dir.route, newDirection), 20000);
            });
    }

    function updateArrivalTimes(estimates, direction) { /* ... (é‚è¼¯ä¸è®Š) ... */
        currentStops.forEach(stop => {
            const el = document.querySelector(`#stop-${stop.uid} .arrival-time`);
            if (el) {
                el.innerText = 'æœªç™¼è»Š';
                el.className = 'arrival-time time-none';
            }
        });
        for (const [key, value] of Object.entries(estimates)) {
            const [dir, stopUID] = key.split('_');
            if (dir !== direction) continue;
            const el = document.querySelector(`#stop-${stopUID} .arrival-time`);
            if (!el) continue;
            let text = '';
            let statusClass = 'time-wait';
            if (value.sec === null || value.sec === undefined) {
                text = (value.status === 1) ? 'æœªç™¼è»Š' : 'æœ«ç­å·²é';
                statusClass = 'time-none';
            } else if (value.sec < 60) {
                text = 'é€²ç«™ä¸­';
                statusClass = 'time-now';
            } else if (value.sec < 180) {
                text = 'å°‡åˆ°ç«™';
                statusClass = 'time-soon';
            } else {
                const mins = Math.floor(value.sec / 60);
                text = `${mins} åˆ†`;
                statusClass = 'time-wait';
            }
            el.innerText = text;
            el.className = `arrival-time ${statusClass}`;
        }
    }
    
    // ... (å…¶ä»–è¼”åŠ©å‡½å¼) ...
    
    function getDirectionName(azimuth) { /* ... (é‚è¼¯ä¸è®Š) ... */
        const directions = [{ name: 'æ­£åŒ— â¬†ï¸', min: 0, max: 22.5 }, { name: 'æ±åŒ— â†—ï¸', min: 22.5, max: 67.5 }, { name: 'æ­£æ± â¡ï¸', min: 67.5, max: 112.5 }, { name: 'æ±å— â†˜ï¸', min: 112.5, max: 157.5 }, { name: 'æ­£å— â¬‡ï¸', min: 157.5, max: 202.5 }, { name: 'è¥¿å— â†™ï¸', min: 202.5, max: 247.5 }, { name: 'æ­£è¥¿ â¬…ï¸', min: 247.5, max: 292.5 }, { name: 'è¥¿åŒ— â†–ï¸', min: 292.5, max: 337.5 }, { name: 'æ­£åŒ— â¬†ï¸', min: 337.5, max: 360 }];
        for (const dir of directions) {
            if (azimuth >= dir.min && azimuth < dir.max) return dir.name;
        }
        return 'æœªçŸ¥æ–¹å‘';
    }

    function parseRouteGeometry(routeData) { 
        let coords = [];
        if (routeData.Geometry) coords = parseWktLineString(routeData.Geometry);
        if (!coords || coords.length === 0) coords = routeData.EncodedPolyline ? decodePolyline(routeData.EncodedPolyline) : [];
        
        if (!coords || coords.length === 0) {
            console.warn('è·¯ç·šè³‡æ–™ä¸­æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ Geometry æˆ– EncodedPolyline');
            return [];
        }
        
        // ç¢ºä¿åæ¨™æ ¼å¼ç‚º {lat, lng} å°è±¡ï¼ˆGoogle Maps æ‰€éœ€æ ¼å¼ï¼‰
        return coords.map(coord => {
            if (Array.isArray(coord)) {
                return { lat: coord[0], lng: coord[1] };
            } else if (coord && typeof coord === 'object') {
                return { lat: coord.lat || coord[0], lng: coord.lng || coord[1] };
            }
            return null;
        }).filter(coord => coord && isFinite(coord.lat) && isFinite(coord.lng));
    }
    
    function parseWktLineString(wkt) { /* ... (é‚è¼¯ä¸è®Š) ... */
        try {
            if (!wkt || typeof wkt !== 'string') return [];
            let coordString = wkt;
            if (wkt.toUpperCase().includes('LINESTRING')) {
                coordString = wkt.replace(/.*LINESTRING\s*\(/i, "").replace(/\)[^)]*$/, "").trim();
            }
            if (wkt.toUpperCase().includes('MULTILINESTRING')) {
                const match = wkt.match(/\(\(([^)]+)\)\)/);
                if (match) coordString = match[1];
            }
            const pairs = coordString.split(",").map(p => p.trim()).filter(p => p);
            return pairs.map(pair => {
                const coords = pair.trim().split(/\s+/);
                if (coords.length >= 2) {
                    const lon = parseFloat(coords[0]);
                    const lat = parseFloat(coords[1]);
                    if (!isNaN(lat) && !isNaN(lon) && lat >= 21 && lat <= 26 && lon >= 119 && lon <= 122) {
                        return [lat, lon];
                    }
                }
                return null;
            }).filter(coord => coord !== null);
        } catch (e) {
            console.error('âŒ è§£æ WKT å¤±æ•—:', e);
            return [];
        }
    }

    function decodePolyline(encoded) { /* ... (é‚è¼¯ä¸è®Š) ... */
        try {
            if (typeof polyline !== 'undefined' && polyline.decode) {
                return polyline.decode(encoded);
            }
            console.warn('âš ï¸ æœªæ‰¾åˆ° polyline è§£ç¢¼åº«ï¼Œä½¿ç”¨æ‰‹å‹•è§£ç¢¼');
            return decodePolylineManual(encoded);
        } catch (e) {
            console.error('âŒ è§£ç¢¼ EncodedPolyline å¤±æ•—:', e);
            return [];
        }
    }

    function decodePolylineManual(encoded) { /* ... (é‚è¼¯ä¸è®Š) ... */
        const coordinates = [];
        let index = 0;
        let lat = 0;
        let lng = 0;
        while (index < encoded.length) {
            let shift = 0, result = 0, byte;
            do {
                byte = encoded.charCodeAt(index++) - 63;
                result |= (byte & 0x1f) << shift;
                shift += 5;
            } while (byte >= 0x20);
            const deltaLat = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lat += deltaLat;
            shift = 0; result = 0;
            do {
                byte = encoded.charCodeAt(index++) - 63;
                result |= (byte & 0x1f) << shift;
                shift += 5;
            } while (byte >= 0x20);
            const deltaLng = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lng += deltaLng;
            coordinates.push([lat / 1e5, lng / 1e5]);
        }
        return coordinates;
    }

    function translateCity(cityCode) { /* ... (é‚è¼¯ä¸è®Š) ... */
        const cityMap = {'Taipei': 'å°åŒ—å¸‚', 'NewTaipei': 'æ–°åŒ—å¸‚', 'Taoyuan': 'æ¡ƒåœ’å¸‚', 'Taichung': 'å°ä¸­å¸‚', 'Tainan': 'å°å—å¸‚', 'Kaohsiung': 'é«˜é›„å¸‚', 'Keelung': 'åŸºéš†å¸‚', 'Hsinchu': 'æ–°ç«¹å¸‚', 'HsinchuCounty': 'æ–°ç«¹ç¸£', 'MiaoliCounty': 'è‹—æ —ç¸£', 'ChanghwaCounty': 'å½°åŒ–ç¸£', 'NantouCounty': 'å—æŠ•ç¸£', 'YunlinCounty': 'é›²æ—ç¸£', 'ChiayiCounty': 'å˜‰ç¾©ç¸£', 'Chiayi': 'å˜‰ç¾©å¸‚', 'PingtungCounty': 'å±æ±ç¸£', 'YilanCounty': 'å®œè˜­ç¸£', 'HualienCounty': 'èŠ±è“®ç¸£', 'TaitungCounty': 'å°æ±ç¸£', 'KinmenCounty': 'é‡‘é–€ç¸£', 'PenghuCounty': 'æ¾æ¹–ç¸£', 'LienchiangCounty': 'é€£æ±Ÿç¸£', 'InterCity': 'è·¨ç¸£å¸‚'};
        return cityMap[cityCode] || cityCode;
    }

    async function filterRoutes() { /* ... (é‚è¼¯ä¸è®Š) ... */
        const input = document.getElementById('routeNum').value.trim();
        const suggestionsContainer = document.getElementById('route-suggestions');
        if (input.length < 1) {
            suggestionsContainer.style.display = 'none';
            return;
        }
        clearTimeout(searchTimer);
        searchTimer = setTimeout(async () => {
            suggestionsContainer.innerHTML = `<div style="padding: 12px 16px; text-align: center; color: #667eea;"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æŸ¥è©¢å…¨å°è·¯ç·š...</div>`;
            suggestionsContainer.style.display = 'block';
            try {
                const response = await fetch(`${WORKER_URL}?action=list_all&search=${encodeURIComponent(input)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const matches = await response.json();
                if (matches && matches.length > 0) {
                    suggestionsContainer.innerHTML = matches.slice(0, 4).map((route, idx) => {
                        const cityName = translateCity(route.city);
                        const departure = route.departure || 'èµ·ç«™';
                        const arrival = route.destination || 'çµ‚ç«™';
                        const typeIcon = route.type === 'InterCity' ? 'ğŸšŒ è·¨ç¸£å¸‚' : 'ğŸšŒ å…¬è»Š';
                        return `<div class="suggest-item" style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; display: block;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'" onclick="selectRoute('${route.name.replace(/'/g, "\\'")}', '${route.city}', '${route.type}')">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                                        <strong style="font-size: 1.1rem; color: #2c3e50;">${route.name}</strong>
                                        <span style="font-size: 0.75rem; background: #667eea; color: white; padding: 2px 8px; border-radius: 10px; margin-left: 8px; white-space: nowrap;">${cityName}</span>
                                    </div>
                                    <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 4px;"><i class="fas fa-map-marker-alt" style="margin-right: 4px; font-size: 0.75rem;"></i>${departure} <span style="color: #bdc3c7;">â”</span> ${arrival}</div>
                                    <div style="font-size: 0.75rem; color: #95a5a6;">${typeIcon}</div>
                                </div>`;
                    }).join('');
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.innerHTML = `<div style="padding: 20px 15px; text-align: center; color: #9ca3af;"><i class="fas fa-search" style="font-size: 1.5rem; margin-bottom: 8px; display: block;"></i><div style="font-size: 0.95rem; margin-bottom: 8px;">æ‰¾ä¸åˆ°ç¬¦åˆã€Œ<strong>${input}</strong>ã€çš„è·¯ç·š</div><div style="font-size: 0.80rem; opacity: 0.8;">ğŸ’¡ è©¦è©¦çœ‹è¼¸å…¥å…¶ä»–è·¯ç·šè™Ÿæˆ–ç«™å</div></div>`;
                    suggestionsContainer.style.display = 'block';
                }
            } catch (e) {
                console.error('âŒ D1 æœå°‹å¤±æ•—:', e.message);
                suggestionsContainer.innerHTML = `<div style="padding: 20px 15px; text-align: center; color: #e74c3c;"><i class="fas fa-exclamation-circle" style="font-size: 1.5rem; margin-bottom: 8px; display: block;"></i><div style="font-size: 0.95rem; margin-bottom: 8px;">æœå°‹æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨</div><div style="font-size: 0.80rem; opacity: 0.8;">ğŸ”§ è«‹ç¢ºä¿å·²åŸ·è¡Œåˆå§‹åŒ–: <code>?action=sync_db</code></div></div>`;
                suggestionsContainer.style.display = 'block';
            }
        }, 300);
    }

    window.selectRoute = function(name, city, category) { /* ... (é‚è¼¯ä¸è®Š) ... */
        document.getElementById('routeNum').value = name;
        document.getElementById('city').value = city;
        const categorySelect = document.getElementById('category');
        if (category === 'InterCity') categorySelect.value = 'InterCity';
        else categorySelect.value = 'CityBus';
        document.getElementById('route-suggestions').style.display = 'none';
        console.log(`âœ¨ å·²é¸æ“‡è·¯ç·š: ${name} (${translateCity(city)} - ${category})`);
        startTracking();
    };

    window.clearRouteCache = function() { /* ... (é‚è¼¯ä¸è®Š) ... */
        localStorage.removeItem(ROUTE_CACHE_KEY);
        allRoutesCache = [];
        console.log('âœ… è·¯ç·šå¿«å–å·²æ¸…é™¤');
        loadAllRoutes();
        alert('âœ… è·¯ç·šå¿«å–å·²æ¸…é™¤ï¼Œç³»çµ±å°‡é‡æ–°åŠ è¼‰');
    };

    window.switchToRoute = function(routeName) { /* ... (é‚è¼¯ä¸è®Š) ... */
        document.getElementById('routeNum').value = routeName;
        startTracking();
    };
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.suggest-item') && e.target.id !== 'routeNum') {
            document.getElementById('route-suggestions').style.display = 'none';
        }
    });

    async function loadAllRoutes() { /* ... (é‚è¼¯ä¸è®Š) ... */
        try {
            const cachedData = localStorage.getItem(ROUTE_CACHE_KEY);
            if (cachedData) {
                const { timestamp, data } = JSON.parse(cachedData);
                if (Date.now() - timestamp < ROUTE_CACHE_EXPIRE) {
                    allRoutesCache = data;
                    console.log(`ğŸ“š å¾ localStorage è¼‰å…¥ ${allRoutesCache.length} æ¢è·¯ç·šå¿«å–`);
                    return;
                }
            }
            console.log('ğŸ“¡ æ­£åœ¨å¾ Worker ç²å–æ‰€æœ‰è·¯ç·š...');
            const startTime = Date.now();
            const res = await fetch(`${WORKER_URL}?action=list_all`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const routes = await res.json();
            allRoutesCache = routes;
            localStorage.setItem(ROUTE_CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data: routes }));
            console.log(`âœ… æˆåŠŸåŠ è¼‰ ${routes.length} æ¢è·¯ç·š (è€—æ™‚ ${Date.now() - startTime}ms)`);
        } catch (e) {
            console.error(`âŒ loadAllRoutes å¤±æ•—: ${e.message}`);
            allRoutesCache = [];
            POPULAR_ROUTES.forEach(item => {
                item.routes.forEach(name => {
                    allRoutesCache.push({ name: name, city: item.city, type: 'CityBus' });
                });
            });
            console.log(`âš ï¸ ä½¿ç”¨å‚™ç”¨è·¯ç·šåˆ—è¡¨ (${allRoutesCache.length} æ¢)`);
        }
    }


    // ============================================================
    // å•Ÿå‹•å‡½å¼èˆ‡çµæŸè™•ç†
    // ============================================================
    
    // çµæŸæ™‚æ¸…é™¤è¨ˆæ™‚å™¨
    window.addEventListener('beforeunload', () => {
        if (pollingTimer) clearInterval(pollingTimer);
    });
    
    // ç²å–ç‰¹å®šè·¯ç·šçš„æ‰€æœ‰è»Šè¼›
    async function fetchRouteBuses(category, city, route) {
        try {
            const url = `${WORKER_URL}?category=${category}&city=${city}&route=${encodeURIComponent(route)}`;
            const res = await fetch(url);
            if (!res.ok) return [];
            const data = await res.json();
            return data.buses || [];
        } catch (e) {
            console.error(`âŒ ç²å– ${route} çš„è»Šè¼›å¤±æ•—:`, e);
            return [];
        }
    }
    
    // Google Maps API æœƒé€šé callback åƒæ•¸è‡ªå‹•èª¿ç”¨ initMap()
    // ç„¡éœ€åœ¨æ­¤æ‰‹å‹•èª¿ç”¨
    
</script>

</body>
</html>
