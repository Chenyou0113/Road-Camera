<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro PIDS - TPASS 2.0 Edition</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&family=Roboto:wght@700;900&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --theme-color: #8246af;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
        }

        body {
            background-color: #000;
            height: 100vh;
            width: 100vw;
            display: flex;
            overflow: hidden;
        }

        .pids-wrapper {
            display: grid;
            grid-template-columns: 24% 76%;
            grid-template-rows: 1fr 80px;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            border-right: 2px solid #ccc;
            background-color: #fff;
            height: 100%;
            overflow: hidden;
        }

        .station-header {
            height: 10%;
            min-height: 60px;
            background-color: var(--theme-color);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 12px;
        }

        .home-link {
            color: #fff;
            font-size: 1.5vw;
            text-decoration: none;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: -5px;
        }

        .home-link:hover {
            transform: scale(1.1);
        }

        .st-badge {
            background: #fff;
            color: var(--theme-color);
            font-weight: 900;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 1.4vw;
        }

        .st-name-zh {
            font-size: 1.8vw;
            font-weight: 900;
        }

        .st-name-en {
            font-size: 1.0vw;
            font-weight: 700;
            margin-left: 4px;
            opacity: 0.9;
        }

        .st-title-group {
            display: flex;
            flex-direction: column;
            justify-content: center;
            line-height: 1.1;
        }

        .arrival-info {
            flex: 1;
            padding: 1vh 1vw;
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid #eee;
            justify-content: center;
        }

        .arrival-info.secondary {
            background-color: #fcfcfc;
        }

        .dir-label {
            font-size: 1.2vw;
            font-weight: 900;
            color: #555;
            margin-bottom: 2px;
        }

        .line-tag-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .line-badge-small {
            background: var(--theme-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 1vw;
            font-weight: 900;
            min-width: 45px;
            text-align: center;
        }

        .dest-zh {
            font-size: 2.2vw;
            font-weight: 900;
            color: #000;
            line-height: 1.2;
        }

        .dest-en {
            font-size: 1.1vw;
            color: #888;
            font-weight: 700;
        }

        /* --- ÊôÇÈñìÊ°ÜÊ®£ÂºèÂÑ™Âåñ --- */
        .time-box {
            background-color: var(--theme-color);
            color: white;
            margin-top: 5px;
            text-align: center;
            font-size: 3.5vw;
            font-weight: 700;
            border-radius: 8px;
            padding: 0.5vh 0;
            font-family: 'Roboto', sans-serif;
            width: 95%;
            align-self: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            transition: 0.3s;
            /* Á¢∫‰øùÊñáÂ≠óÂûÇÁõ¥ÁΩÆ‰∏≠ */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 6vh;
        }

        .time-box.arriving {
            background-color: #d32f2f;
            animation: pulse 1s infinite;
        }

        .time-box.approaching {
            background-color: #f58220;
        }

        /* üî• Êú´Áè≠ËªäÂ∑≤ÈßõÈõ¢ (Â≠óÈ´îÁ∏ÆÂ∞è‰ª•Â°ûÂÖ•Ê°ÜÂÖß) */
        .time-box.end-service {
            font-size: 1.8vw;
            /* Á∏ÆÂ∞èÂ≠óÈ´î */
            background-color: #444;
            /* Ê∑±ÁÅ∞Â∫ïËâ≤ */
            font-family: 'Noto Sans TC', sans-serif;
            /* ÊîπÂõû‰∏≠ÊñáÈ´î */
            padding: 0 10px;
        }

        .weather-box {
            height: 18%;
            background: #fff;
            border-top: 2px solid #ccc;
            display: grid;
            grid-template-columns: 1fr 2.5fr;
            grid-template-rows: 1fr 1fr;
            align-items: stretch;
        }

        .w-icon-area {
            grid-row: 1 / span 2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
            background: #f4f7f9;
            border-right: 1px solid #eee;
        }

        .w-icon-large {
            font-size: 4vw;
            color: #607d8b;
        }

        .w-desc {
            font-size: 1.3vw;
            font-weight: 700;
            color: #555;
        }

        .w-top-info {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 1vw;
            border-bottom: 1px solid #eee;
        }

        .w-bottom-info {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 1vw;
        }

        .w-range-text {
            font-size: 2vw;
            font-weight: 900;
            color: #d32f2f;
        }

        .w-rain-text {
            font-size: 2vw;
            font-weight: 900;
            color: #5a9fd4;
        }

        .time-marquee-section {
            background: #000;
            color: #fff;
            padding: 0;
            display: grid;
            grid-template-columns: 24% 76%;
            height: 80px;
            border-top: 2px solid #ccc;
            grid-column: 1/3;
        }

        .clock-section {
            background: #d32f2f;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2vw;
            font-weight: 900;
            font-family: 'Roboto', sans-serif;
            padding: 0 15px;
            white-space: nowrap;
        }

        .marquee-section {
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0;
            position: relative;
            width: 100%;
        }

        .marquee-text {
            white-space: nowrap;
            font-size: 1.7vw;
            font-weight: 700;
            position: absolute;
            left: 100%;
            will-change: transform;
        }

        .main-display {
            display: grid;
            grid-template-rows: 1fr;
            background-color: #000;
            position: relative;
        }

        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        #video-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            transform: scale(1.01);
        }

        /* --- PIDS ÊìÅÊì†Â∫¶ÂÑ™ÂåñÁâà (Âä†Â§ß + Êï∏Â≠ó) --- */
        .congestion-area {
            background: #fff;
            border-top: 2px solid #ccc;
            padding: 15px 30px;
            /* Â¢ûÂä†ÂÖßË∑ù */
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
            /* Â¢ûÂä†È´òÂ∫¶ */
            gap: 15px;
            /* ÂÖ©Âàó‰πãÈñìÁöÑË∑ùÈõ¢ */
        }

        .cong-row {
            display: flex;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .cong-label {
            font-size: 1.5vw;
            /* Â≠óÈ´îÂä†Â§ß */
            font-weight: 900;
            color: #333;
            width: 250px;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
        }

        .cong-bar-container {
            flex: 1;
            display: flex;
            gap: 6px;
            /* ÊñπÂ°äÈñìË∑ù */
            height: 40px;
            /* ÊñπÂ°äÈ´òÂ∫¶Âä†Â§ß */
            background: #e2e8f0;
            padding: 4px;
            border-radius: 8px;
        }

        .cong-car {
            flex: 1;
            border-radius: 4px;
            background-color: #cbd5e1;
            /* È†êË®≠ÁÅ∞ */

            /* Êï∏Â≠óÁΩÆ‰∏≠ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.2rem;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            transition: 0.3s;
        }

        /* È°èËâ≤ÂÆöÁæ© (Á®çÂæÆ‰∫Æ‰∏ÄÈªû) */
        .cong-lvl-1 {
            background-color: #32b900;
        }

        .cong-lvl-2 {
            background-color: #ffcc00;
            color: #000;
            text-shadow: none;
        }

        /* ÈªÉËâ≤ÈªëÂ≠ó */
        .cong-lvl-3 {
            background-color: #f58220;
        }

        .cong-lvl-4 {
            background-color: #d32f2f;
        }

        .cong-no-data {
            color: #94a3b8;
            font-size: 1vw;
            font-weight: 700;
            text-align: center;
            width: 100%;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* --- Mobile Responsive Optimizer --- */
        @media (max-width: 850px) {
            body {
                overflow: auto;
                height: auto;
            }

            .pids-wrapper {
                display: flex;
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 3px solid #ccc;
                height: auto;
                overflow: visible;
            }

            .station-header {
                height: 70px;
                padding: 10px 15px;
                gap: 10px;
            }

            .home-link {
                font-size: 1.5rem;
                margin-right: 2px;
            }

            .st-badge {
                font-size: 1.3rem;
                padding: 3px 8px;
            }

            .st-name-zh {
                font-size: 1.6rem;
            }

            .st-name-en {
                font-size: 0.9rem;
            }

            .arrival-info {
                padding: 20px 15px;
                border-bottom: 2px solid #eee;
                min-height: 160px;
            }

            .dir-label {
                font-size: 1.1rem;
                margin-bottom: 5px;
            }

            .line-badge-small {
                font-size: 1.2rem;
                min-width: 60px;
                padding: 4px 10px;
                border-radius: 6px;
            }

            .dest-zh {
                font-size: 1.8rem;
            }

            .dest-en {
                font-size: 1rem;
            }

            .time-box {
                font-size: 2.8rem;
                width: 100%;
                margin: 12px 0 0 0;
                min-height: 75px;
                border-radius: 10px;
            }

            .time-box.end-service {
                font-size: 1.4rem;
            }

            .weather-box {
                height: auto;
                min-height: 110px;
                grid-template-rows: 55px 55px;
            }

            .w-icon-large {
                font-size: 3.2rem;
            }

            .w-desc {
                font-size: 1.1rem;
            }

            .w-range-text,
            .w-rain-text {
                font-size: 1.6rem;
            }

            .main-display {
                display: flex;
                flex-direction: column;
                height: auto;
                background: #000;
            }

            .video-container {
                aspect-ratio: 16/9;
                width: 100%;
                height: auto !important;
                min-height: 200px;
            }

            .congestion-area {
                padding: 20px 15px;
                min-height: auto;
                background: #fff;
            }

            .cong-label {
                width: 100%;
                font-size: 1.1rem;
                justify-content: flex-start;
                margin-bottom: 8px;
                text-align: left;
            }

            .cong-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                margin-bottom: 15px;
            }

            .cong-row:last-child {
                margin-bottom: 0;
            }

            .cong-bar-container {
                width: 100%;
                height: 32px !important;
            }

            .footer {
                display: flex;
                flex-direction: column;
                height: auto;
                background: #1a1a1a;
            }

            .clock-section {
                height: 45px;
                font-size: 1.6rem;
                padding: 5px 0;
                background: #d32f2f;
            }

            .marquee-section {
                height: 40px;
                background: #000;
                position: relative;
                overflow: hidden;
            }

            .marquee-text {
                font-size: 1.1rem;
                line-height: 40px;
            }

            .time-marquee-section {
                height: 60px;
                grid-template-columns: 80px 1fr;
            }

            .clock-section {
                height: 60px;
                font-size: 1.4rem;
                padding: 0;
            }
        }
    </style>
</head>

<body>

    <div class="pids-wrapper">
        <div class="sidebar">
            <div class="station-header" id="ui-header">
                <a href="metro-liveboard.html" class="home-link" title="ÂõûÈ¶ñÈ†Å"><i class="fas fa-house"></i></a>
                <div class="st-badge" id="ui-st-id">--</div>
                <div class="st-title-group">
                    <div class="st-name-zh" id="ui-st-name">ËºâÂÖ•‰∏≠...</div>
                    <div class="st-name-en" id="ui-st-name-en"></div>
                </div>
            </div>

            <div class="arrival-info" id="block-dir0">
                <div class="dir-label">Á¨¨‰∏ÄÊúàÂè∞ Platform 1</div>
                <div class="line-tag-row">
                    <div class="line-badge-small" id="ui-line-tag-1"></div>
                    <div class="dest-zh" id="dir0-dest">--</div>
                </div>
                <div class="dest-en" id="dir0-en"></div>
                <!-- ÈÄôË£°ÁöÑÊôÇÈñìÊ°ÜÊúÉÁî®‰æÜÈ°ØÁ§∫„ÄåÊú´Áè≠ËªäÂ∑≤ÈßõÈõ¢„Äç -->
                <div class="time-box" id="dir0-time">-- : --</div>
                <div class="congestion-box" id="cong-dir0"></div>
            </div>

            <div class="arrival-info secondary" id="block-dir1">
                <div class="dir-label">Á¨¨‰∫åÊúàÂè∞ Platform 2</div>
                <div class="line-tag-row">
                    <div class="line-badge-small" id="ui-line-tag-2"></div>
                    <div class="dest-zh" id="dir1-dest">--</div>
                </div>
                <div class="dest-en" id="dir1-en"></div>
                <div class="time-box" id="dir1-time">-- : --</div>
                <div class="congestion-box" id="cong-dir1"></div>
            </div>

            <div class="weather-box">
                <div class="w-icon-area">
                    <div class="w-icon-large" id="ui-weather-icon"><i class="fas fa-cloud-sun"></i></div>
                    <div class="w-desc" id="ui-weather-text">--</div>
                </div>
                <div class="w-top-info"><span class="w-range-text" id="ui-range-display">--¬∞C ~ --¬∞C</span></div>
                <div class="w-bottom-info"><span class="w-rain-text" id="ui-rain-display"><i
                            class="fas fa-umbrella"></i> --%</span></div>
            </div>
        </div>

        <div class="main-display">
            <div class="video-container">
                <iframe id="video-iframe"
                    src="https://www.youtube.com/embed/Y_siE2Wsp38?autoplay=1&mute=1&loop=1&playlist=Y_siE2Wsp38&controls=0&modestbranding=1&rel=0"
                    allow="autoplay; encrypted-media">
                </iframe>
            </div>
        </div>

        <div class="time-marquee-section">
            <div class="clock-section" id="clock">00:00</div>
            <div class="marquee-section">
                <div class="marquee-text" id="ui-marquee">TPASS 2.0 ÂÖ¨ÈÅãÂ∏∏ÂÆ¢ÂÑ™ÊÉ†Ê≠£Âºè‰∏äÁ∑öÔºÅÊê≠Ë∂äÂ§öÂõûÈ•ãË∂äÂ§ö...</div>
            </div>
        </div>
    </div>

    <script>
        const METRO_STATIONS = fetch('metro-stations-raw.json').then(r => r.json()).catch(() => null);

        // üö® ÈÄôÊòØ TDX Worker (Áµ¶ÈùûÂåóÊç∑Á≥ªÁµ±Áî®)
        const METRO_API_TDX = 'https://metro-api-worker.weacamm.org/api';

        // üî• ÈÄôÊòØÊÇ®Êñ∞ÈÉ®ÁΩ≤ÁöÑ TRTC Â∞àÂ±¨ Worker (Ê≥®ÊÑèÔºöÂéªÊéâ‰∫Ü /api)
        const METRO_API_TRTC = 'https://trtc-metro-api.weacamm.org';

        const WEATHER_API = 'https://cwa-weather-proxy.weacamm.org';

        const params = new URLSearchParams(window.location.search);
        const system = params.get('sys') || params.get('system') || 'TYMC';
        const station = params.get('sid') || params.get('station') || 'A8';

        let countdownSecs = { dir0: -1, dir1: -1 };
        const sysColors = { 'TRTC': '#0070bd', 'KRTC': '#f58220', 'TYMC': '#8246af', 'TMRT': '#b2d235', 'NTMC': '#0096cc', 'KLRT': '#008010' };
        let GLOBAL_STATIONS = null;

        function updateClock() {
            const n = new Date();
            const d = `${String(n.getMonth() + 1).padStart(2, '0')}/${String(n.getDate()).padStart(2, '0')}`;
            const h = String(n.getHours()).padStart(2, '0');
            const m = String(n.getMinutes()).padStart(2, '0');
            const s = String(n.getSeconds()).padStart(2, '0');
            document.getElementById('clock').innerText = `${d} ${h}:${m}:${s}`;
        }

        async function init() {
            // ÈùûÂåóÊç∑Á≥ªÁµ±Èö±ËóèÊìÅÊì†Â∫¶ÂçÄÂ°ä‰∏¶Ë™øÊï¥ÁâàÈù¢
            if (system !== 'TRTC') {
                document.getElementById('cong-dir0').classList.add('hidden');
                document.getElementById('cong-dir1').classList.add('hidden');
            }

            document.documentElement.style.setProperty('--theme-color', sysColors[system] || '#333');
            document.getElementById('ui-st-id').innerText = station;

            Promise.allSettled([
                METRO_STATIONS.then(data => {
                    GLOBAL_STATIONS = data;
                    if (data?.systems[system]) {
                        // Â∞ãÊâæËªäÁ´ô (Êñ∞Êû∂ÊßãÔºösystems[sys] ÊòØ Array)
                        const lines = data.systems[system];
                        let foundStation = null;
                        let foundLine = null;

                        for (const line of lines) {
                            const s = line.stations.find(st => st.sid === station);
                            if (s) {
                                foundStation = s;
                                foundLine = line;
                                break;
                            }
                        }

                        if (foundStation) {
                            document.getElementById('ui-st-name').innerText = foundStation.name_zh;
                            document.getElementById('ui-st-name-en').innerText = foundStation.name_en; // Á¢∫‰øùÈÄôË£°‰πüÊúâËã±Êñá

                            let themeColor = foundLine.color;
                            if (system === 'TRTC') {
                                if (station.startsWith('GA')) themeColor = '#8fc31f';
                                if (station.startsWith('RA')) themeColor = '#fd92a3';
                            }
                            if (system === 'KRTC') {
                                if (station.startsWith('R')) themeColor = '#e3002c';
                                if (station.startsWith('O')) themeColor = '#f8b61c';
                            }
                            if (themeColor) document.documentElement.style.setProperty('--theme-color', themeColor);
                        }
                    }
                }),
                updateData(),
                updateWeather(),
                updateMarquee()
            ]);

            setInterval(updateData, 15000);
            setInterval(updateWeather, 600000);
            setInterval(updateMarquee, 300000);
            updateClock();
            setInterval(updateClock, 1000);

            setInterval(() => {
                [0, 1].forEach(i => {
                    if (countdownSecs[`dir${i}`] > 0) {
                        countdownSecs[`dir${i}`]--;
                        renderTime(i);
                    }
                });
            }, 1000);
        }

        function getOfflineStatus() {
            const h = new Date().getHours();
            const isLateNight = (h >= 23 || h < 6);
            if (isLateNight) {
                return {
                    destZh: "ÁáüÈÅãÁµêÊùü", destEn: "Service Ended",
                    timeText: "Êú´Áè≠ËªäÂ∑≤ÈßõÈõ¢", timeClass: "time-box end-service"
                };
            }
            return {
                destZh: "Êö´ÁÑ°ÂàóËªä", destEn: "No Service",
                timeText: "-- : --", timeClass: "time-box"
            };
        }

        async function updateData() {
            try {
                let nextTrains = [null, null];

                // --- 1. ÂåóÊç∑ (TRTC) Â∞àÁî®ÈÇèËºØ ---
                if (system === 'TRTC') {
                    nextTrains = await fetchTRTCData();
                }
                // --- 2. ÂÖ∂‰ªñÊç∑ÈÅã (TDX) ÈÇèËºØ ---
                else {
                    const res = await fetch(`${METRO_API_TDX}/liveboard?sys=${system}&sid=${station.toUpperCase()}`);
                    const sData = await res.json();

                    if (sData && sData.length > 0) {
                        if (system === 'TYMC') {
                            const toTaipei = sData.find(t => t.DestinationStationName.Zh_tw.includes('Âè∞ÂåóËªäÁ´ô'));
                            const toSouth = sData.find(t => !t.DestinationStationName.Zh_tw.includes('Âè∞ÂåóËªäÁ´ô'));
                            nextTrains = [toSouth, toTaipei];
                        } else if (system === 'KLRT') {
                            nextTrains = [sData[0], sData.length > 1 ? sData[1] : null];
                        } else {
                            const dests = [...new Set(sData.map(item => item.DestinationStationName.Zh_tw))];
                            if (dests.length >= 2) {
                                nextTrains[0] = sData.find(t => t.DestinationStationName.Zh_tw === dests[0]);
                                nextTrains[1] = sData.find(t => t.DestinationStationName.Zh_tw === dests[1]);
                            } else {
                                nextTrains[0] = sData[0];
                                nextTrains[1] = sData.length > 1 ? sData[1] : null;
                            }
                        }

                        // Êõ¥Êñ∞ËªäÁ´ôËã±Êñá
                        if (sData[0].StationName) {
                            if (sData[0].StationName.En) document.getElementById('ui-st-name-en').innerText = sData[0].StationName.En;
                            // ÈáùÂ∞ç KRTC ËçâË°ôÁ´ôËàáÂÖ∂‰ªñÂèØËÉΩÁº∫Êºè
                            if (station === 'R4A' && system === 'KRTC') document.getElementById('ui-st-name-en').innerText = 'Caoya';
                        }
                    }
                }

                updateUI(0, nextTrains[0]);
                updateUI(1, nextTrains[1]);
                updateCongestion(nextTrains);

            } catch (e) {
                console.error("Fetch Data Error:", e);
                setOfflineUI(0); setOfflineUI(1);
            }
        }

        // üî• Â∞àÊ•≠Ê®°ÂºèÔºöPIDS Â∞àÁî®Ë≥áÊñôÊäìÂèñ (Âê´Áí∞ÁãÄÁ∑öÊîØÊè¥)
        async function fetchTRTCData() {
            const res = await fetch(`${METRO_API_TRTC}/arrival`);
            const rawData = await res.json();

            const targetStationID = station.toUpperCase().trim(); // ‰æãÂ¶Ç Y11
            const stNameEl = document.getElementById('ui-st-name');
            const targetName = stNameEl.innerText.replace('Á´ô', '');

            // 1. Âà§Êñ∑Áï∂ÂâçÊòØÂì™Ê¢ùÁ∑ö
            let currentLine = '';
            if (targetStationID.startsWith('BR')) currentLine = 'BR';
            else if (targetStationID.startsWith('BL')) currentLine = 'BL';
            else if (targetStationID.startsWith('Y')) currentLine = 'Y';
            else if (targetStationID.startsWith('GA')) currentLine = 'GA';
            else if (targetStationID.startsWith('RA')) currentLine = 'RA';
            else currentLine = targetStationID.substring(0, 1); // R, G, O

            // 2. ÂÆöÁæ©ÂêÑË∑ØÁ∑öÁöÑÂêàÊ≥ïÁõÆÁöÑÂú∞ (ÁôΩÂêçÂñÆ)
            const VALID_DESTINATIONS = {
                'BR': ['ÂãïÁâ©Âúí', 'ÂçóÊ∏ØÂ±ïË¶ΩÈ§®'],
                'BL': ['ÂçóÊ∏ØÂ±ïË¶ΩÈ§®', 'È†ÇÂüî', '‰∫ûÊù±ÈÜ´Èô¢', 'ÊòÜÈôΩ'],
                'R': ['Ê∑°Ê∞¥', 'Ë±°Â±±', 'ÂåóÊäï', 'Â§ßÂÆâ', 'Êñ∞ÂåóÊäï'],
                'G': ['ÊùæÂ±±', 'Êñ∞Â∫ó', 'Âè∞ÈõªÂ§ßÊ®ì', 'Â∞èÁ¢ßÊΩ≠'],
                'O': ['Ëø¥Èæç', 'ÂçóÂã¢Ëßí', 'ËòÜÊ¥≤'],
                'Y': ['Â§ßÂù™Êûó', 'Êñ∞ÂåóÁî¢Ê•≠ÂúíÂçÄ'],
                'GA': ['Â∞èÁ¢ßÊΩ≠', '‰∏ÉÂºµ'],
                'RA': ['Êñ∞ÂåóÊäï', 'ÂåóÊäï']
            };

            const allowedDests = VALID_DESTINATIONS[currentLine] || [];

            // 3. Âö¥Ê†ºÁØ©ÈÅ∏
            const stationTrains = rawData.filter(t => {
                // A. Â¶ÇÊûú ID ÂÆåÂÖ®ÂêªÂêàÔºåÁõ¥Êé•ÊîæË°å
                if (t.StationID && t.StationID === targetStationID) return true;

                // B. ÈáùÂ∞çËΩâ‰πòÁ´ô (Â¶ÇÊôØÂÆâ)ÔºöÂÖÅË®± Y Á∑öÂíå O Á∑öÂÖ±Â≠òÔºå‰ΩÜÂè™ÊäìÂ±¨ÊñºÊú¨ÊúàÂè∞ÁöÑ
                const apiName = (t.StationName || "").replace('Á´ô', '').trim();
                if (apiName === targetName) {
                    const dest = t.DestinationName || "";
                    // Ê™¢Êü•ÈÄôÁè≠ËªäÁöÑÁõÆÁöÑÂú∞ÔºåÊòØ‰∏çÊòØÂ±¨ÊñºÈÄôÊ¢ùÁ∑ö
                    return allowedDests.some(d => dest.includes(d));
                }
                return false;
            });

            if (stationTrains.length === 0) return [null, null];

            // 4. ÁáüÈÅãÊ®°ÂºèÊñπÂêëÂÆöÁæ© (Ê±∫ÂÆöÂì™ÈÇäÊòØ‰∏äË°å/Á¨¨‰∏ÄÊúàÂè∞)
            const TRTC_UPSTREAM_DESTS = {
                'BR': ['ÂçóÊ∏ØÂ±ïË¶ΩÈ§®'],
                'R': ['Ê∑°Ê∞¥', 'ÂåóÊäï', 'Êñ∞ÂåóÊäï'],
                'G': ['ÊùæÂ±±'],
                'O': ['Ëø¥Èæç', 'ËòÜÊ¥≤'],
                'BL': ['ÂçóÊ∏ØÂ±ïË¶ΩÈ§®'],
                'Y': ['Êñ∞ÂåóÁî¢Ê•≠ÂúíÂçÄ'],
                'GA': ['Â∞èÁ¢ßÊΩ≠'],
                'RA': ['Êñ∞ÂåóÊäï']
            };

            const upstreamList = TRTC_UPSTREAM_DESTS[currentLine] || [];

            // 5. ËΩâÊèõ‰∏¶Ê®ôË®ªÊñπÂêë
            const formatted = stationTrains.map(t => {
                const dest = t.DestinationName.replace('Á´ô', '');
                const isUpstream = upstreamList.some(d => dest.includes(d));
                return {
                    DestinationStationName: { Zh_tw: t.DestinationName, En: '' },
                    EstimateTime: parseTRTCTime(t.CountDown),
                    TrainNumber: t.TrainNumber,
                    LineColor: ({ 'GA': '#8fc31f', 'RA': '#fd92a3' }[currentLine]) || getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim(),
                    platformSide: isUpstream ? 0 : 1
                };
            });

            const t1 = formatted.filter(t => t.platformSide === 0).sort((a, b) => a.EstimateTime - b.EstimateTime)[0] || null;
            const t2 = formatted.filter(t => t.platformSide === 1).sort((a, b) => a.EstimateTime - b.EstimateTime)[0] || null;

            return [t1, t2];
        }

        function parseTRTCTime(timeStr) {
            if (!timeStr || timeStr === 'ÂàóËªäÈÄ≤Á´ô' || timeStr === 'Ë≥áÊñôÊì∑Âèñ‰∏≠') return 0;
            if (timeStr.includes(':')) {
                const [mm, ss] = timeStr.split(':').map(Number);
                return (mm * 60) + ss;
            }
            return 9999;
        }

        function updateUI(idx, item) {
            const destZh = document.getElementById(`dir${idx}-dest`);
            const destEn = document.getElementById(`dir${idx}-en`);
            const timeBox = document.getElementById(`dir${idx}-time`);
            const lineBadge = document.getElementById(`ui-line-tag-${idx + 1}`);

            if (!item) {
                const status = getOfflineStatus();
                destZh.innerText = status.destZh;
                destEn.innerText = status.destEn;
                timeBox.innerText = status.timeText;
                timeBox.className = status.timeClass;
                lineBadge.style.opacity = '0';
                return;
            }

            lineBadge.style.opacity = '1';
            destZh.innerText = item.DestinationStationName.Zh_tw;
            // destEn.innerText Ë®≠ÂÆöÁßªÂà∞‰∏ãÊñπÔºåÁ¢∫‰øùËÉΩÂèñÂà∞Êú¨Âú∞Ë≥áÊñôË£úÂÆå

            let lbText = item.LineID || system.substring(0, 1);
            let destID = null;

            // ÂòóË©¶Â∞ãÊâæËªäÁ´ôÁ∑®Ëôü
            // ÂòóË©¶Â∞ãÊâæËªäÁ´ôÁ∑®Ëôü
            if (GLOBAL_STATIONS && GLOBAL_STATIONS.systems[system]) {
                const lines = GLOBAL_STATIONS.systems[system];
                const destName = item.DestinationStationName.Zh_tw.replace('Á´ô', '').trim();

                let found = null;

                // 1. ÂÑ™ÂÖàÊêúÂ∞ãÊú¨Ë∑ØÁ∑ö (Current Line Priority)
                // ÊâæÂá∫ÂåÖÂê´ÁõÆÂâçËªäÁ´ô(station)ÁöÑÈÇ£ÂÄãË∑ØÁ∑öÁâ©‰ª∂
                const currentLineObj = lines.find(l => l.stations.some(s => s.sid === station));

                if (currentLineObj) {
                    found = currentLineObj.stations.find(s => s.name_zh === destName);
                }

                // 2. Â¶ÇÊûúÊú¨Ë∑ØÁ∑öÊâæ‰∏çÂà∞ (‰æãÂ¶ÇË∑®Á∑öÊàñËΩâ‰πòË≥áË®ä)ÔºåÂâáÊêúÂ∞ãÊâÄÊúâË∑ØÁ∑ö
                if (!found) {
                    for (const line of lines) {
                        if (currentLineObj && line.line_id === currentLineObj.line_id) continue; // Â∑≤Á∂ìÊâæÈÅé‰∫Ü

                        // Á≤æÁ¢∫ÊØîÂ∞ç
                        found = line.stations.find(s => s.name_zh === destName);

                        // Ê®°Á≥äÊØîÂ∞ç (KRTC)
                        if (!found && system === 'KRTC') {
                            found = line.stations.find(s => destName.includes(s.name_zh) || s.name_zh.includes(destName));
                        }

                        if (found) {
                            break;
                        }
                    }
                }

                if (found) {
                    destID = found.sid;
                }
            }

            // üî• ‰øÆÊ≠£ÔºöÂ¶ÇÊûú API Ê≤íÊúâÂõûÂÇ≥Ëã±ÊñáÔºåÂâáÂòóË©¶ÂæûÊú¨Âú∞Ë≥áÊñôÂ∫´ÊäìÂèñËã±ÊñáÁ´ôÂêç
            let finalEnName = item.DestinationStationName.En || "Train";
            if (!item.DestinationStationName.En && destID && GLOBAL_STATIONS.systems[system]) {
                const lines = GLOBAL_STATIONS.systems[system];
                for (const line of lines) {
                    const s = line.stations.find(st => st.sid === destID);
                    if (s && s.name_en) {
                        finalEnName = s.name_en;
                        break;
                    }
                }
            }
            destEn.innerText = finalEnName;

            if (destID) {
                lbText = destID;
            } else {
                // Êâæ‰∏çÂà∞Á∑®ËôüÂâáÂõûÈÄÄÂéüÊú¨ÈÇèËºØ
                if (system === 'KRTC' && (lbText === 'RA' || lbText === 'R')) lbText = 'R';
            }

            lineBadge.innerText = lbText;

            // Â≠óÈ´îÂ§ßÂ∞èËá™ÂãïË™øÊï¥
            if (lbText.length >= 4) lineBadge.style.fontSize = '1.0vw';
            else if (lbText.length >= 3) lineBadge.style.fontSize = '1.2vw';
            else lineBadge.style.fontSize = '1.5vw';

            lineBadge.style.background = item.LineColor || "#808080";

            const estimateTime = item.EstimateTime != null ? item.EstimateTime : 0;
            countdownSecs[`dir${idx}`] = estimateTime;
            renderTime(idx);
        }

        function setOfflineUI(idx) {
            const status = getOfflineStatus();
            document.getElementById(`dir${idx}-dest`).innerText = status.destZh;
            document.getElementById(`dir${idx}-en`).innerText = status.destEn;
            const timeBox = document.getElementById(`dir${idx}-time`);
            timeBox.innerText = status.timeText;
            timeBox.className = status.timeClass;
            document.getElementById(`ui-line-tag-${idx + 1}`).style.opacity = '0';
        }

        function renderTime(idx) {
            const el = document.getElementById(`dir${idx}-time`);
            const s = countdownSecs[`dir${idx}`];

            if (s == null || isNaN(s) || s < 0) {
                const status = getOfflineStatus();
                el.innerText = status.timeText;
                el.className = status.timeClass;
                return;
            }

            if (s <= 40) {
                el.innerText = "ÈÄ≤Á´ô‰∏≠";
                el.className = "time-box arriving";
            } else if (s <= 120) {
                // È°ØÁ§∫ MM : SS
                const m = Math.floor(s / 60);
                const secs = String(s % 60).padStart(2, '0');
                el.innerText = `${m} : ${secs}`;
                el.className = "time-box approaching";
            } else {
                const m = Math.floor(s / 60);
                const secs = String(s % 60).padStart(2, '0');
                el.innerText = `${m} : ${secs}`;
                el.className = "time-box";
            }
        }

        // üë• Êõ¥Êñ∞ÊìÅÊì†Â∫¶Ë≥áË®ä (TRTC Â∞àÁî® - ÂÖ®Êñ∞ÈÇèËºØ)
        async function updateCongestion(nextTrains) {
            if (system !== 'TRTC') {
                document.getElementById('cong-dir0').classList.add('hidden');
                document.getElementById('cong-dir1').classList.add('hidden');
                return;
            }

            if (!nextTrains[0] && !nextTrains[1]) {
                document.getElementById('cong-dir0').innerHTML = `<div style="text-align:center; color:#999; padding:5px;">ÂæÖÂàóËªäÈÄ≤Á´ôÂæåÈ°ØÁ§∫ÊìÅÊì†Â∫¶</div>`;
                document.getElementById('cong-dir1').innerHTML = `<div style="text-align:center; color:#999; padding:5px;">ÂæÖÂàóËªäÈÄ≤Á´ôÂæåÈ°ØÁ§∫ÊìÅÊì†Â∫¶</div>`;
                return;
            }

            // ÂèñÂæóË∑ØÁ∑ö‰ª£Ëôü
            let lineId = station.replace(/[0-9]/g, '');
            if (system === 'KRTC' && lineId === 'RA') lineId = 'R';

            // ‚òÖ‚òÖ‚òÖ Â¶ÇÊûúÊòØÁí∞ÁãÄÁ∑ö(Y)ÔºåÈö±ËóèÊìÅÊì†Â∫¶ ‚òÖ‚òÖ‚òÖ
            if (lineId === 'Y') {
                document.getElementById('cong-dir0').classList.add('hidden');
                document.getElementById('cong-dir1').classList.add('hidden');
                return;
            }

            try {
                let endpoint = '';

                if (lineId === 'BR') {
                    endpoint = '/crowdedness/wenhu';
                } else if (lineId === 'Y') {
                    endpoint = '/crowdedness/high-capacity';
                } else {
                    endpoint = '/crowdedness/high-capacity';
                }

                const res = await fetch(`${METRO_API_TRTC}${endpoint}`);
                let data = await res.json();

                if (data.error || !Array.isArray(data)) {
                    document.getElementById('cong-dir0').innerHTML = `<div style="text-align:center; color:#999; padding:5px;">ÁõÆÂâçÁÑ°ÊìÅÊì†Â∫¶Ë®äËôü</div>`;
                    document.getElementById('cong-dir1').innerHTML = `<div style="text-align:center; color:#999; padding:5px;">ÁõÆÂâçÁÑ°ÊìÅÊì†Â∫¶Ë®äËôü</div>`;
                    return;
                }

                const stNameEl = document.getElementById('ui-st-name');
                const currentStationName = stNameEl.innerText.replace('Á´ô', '').replace('Ëá∫', 'Âè∞').trim();

                // ‚òÖ‚òÖ‚òÖ ÈóúÈçµ‰øÆÊîπÔºöÊñáÊπñÁ∑ö(BR) Ëàá Áí∞ÁãÄÁ∑ö(Y) ÈÉΩÊòØ 4 ÁØÄËªäÂªÇÔºõÊîØÁ∑öÁÇ∫ 3 ÁØÄ ‚òÖ‚òÖ‚òÖ
                let carCount = 6;
                if (lineId === 'BR' || lineId === 'Y') carCount = 4;
                if (lineId === 'GA' || lineId === 'RA') carCount = 3;

                [0, 1].forEach(idx => {
                    const train = nextTrains[idx];
                    const congContainer = idx === 0 ? document.getElementById('cong-dir0') : document.getElementById('cong-dir1');

                    if (!train) {
                        congContainer.innerHTML = '';
                        return;
                    }

                    // --- Á≠ñÁï• AÔºöËªäËôüÊØîÂ∞ç ---
                    let match = null;
                    if (train.TrainNumber) {
                        const targetTN = parseInt(train.TrainNumber, 10);
                        match = data.find(c => {
                            const crowdNumbers = String(c.TrainNumber).split(',').map(n => parseInt(n.trim(), 10));
                            return crowdNumbers.includes(targetTN);
                        });
                    }

                    // --- Á≠ñÁï• BÔºöÁ´ôÂêçÊØîÂ∞ç (Á´ØÈªûÁ´ôÂÇôÊ°à) ---
                    if (!match) {
                        match = data.find(c => {
                            const apiStation = (c.StationName || "").replace('BR', '').replace('Á´ô', '').replace('Ëá∫', 'Âè∞').trim();
                            return apiStation === currentStationName;
                        });
                    }

                    const label = `ÂæÄ ${train.DestinationStationName.Zh_tw}`;
                    let barsHtml = '';

                    if (match) {
                        for (let i = 1; i <= carCount; i++) {
                            const level = match[`Car${i}`] || match[`Cart${i}L`] || 0;
                            let cls = 'cong-car-inline';

                            if (level == 1) cls += ' cong-lvl-1';
                            else if (level == 2) cls += ' cong-lvl-2';
                            else if (level == 3) cls += ' cong-lvl-3';
                            else if (level >= 4) cls += ' cong-lvl-4';

                            if (!level) cls = 'cong-car-inline'; // ÁÑ°Ë≥áÊñôÈ°ØÁ§∫ÁÅ∞Ëâ≤

                            // üî• ‰øÆÊ≠£ÔºöÂä†ÂÖ•ËªäÂªÇËôüÁ¢º i
                            barsHtml += `<div class="${cls}">${i}</div>`;
                        }
                    } else {
                        // ÁÅ∞Ëâ≤ÁãÄÊÖã‰πüË¶ÅÊúâÊï∏Â≠ó
                        for (let i = 1; i <= carCount; i++) {
                            barsHtml += `<div class="cong-car-inline">${i}</div>`;
                        }
                    }

                    congContainer.innerHTML = `
                        <div class="cong-row-inline">
                            <div class="cong-label-inline">
                                <span style="background:${train.LineColor}; width:10px; height:10px; border-radius:50%; display:inline-block;"></span>
                                ${label}
                            </div>
                            <div class="cong-bar-inline">${barsHtml}</div>
                        </div>
                    `;
                });

            } catch (e) {
                console.error("ÊìÅÊì†Â∫¶Êõ¥Êñ∞Â§±Êïó", e);
            }
        }

        async function updateWeather() {
            try {
                const res = await fetch(`${WEATHER_API}?dataset=F-C0032-001`);
                const json = await res.json();
                const county = system === 'TYMC' ? 'Ê°ÉÂúíÂ∏Ç' : 'Ëá∫ÂåóÂ∏Ç';
                const loc = json.records.location.find(l => l.locationName === county);
                if (loc) {
                    const wx = loc.weatherElement.find(e => e.elementName === 'Wx').time[0].parameter.parameterName;
                    const minT = loc.weatherElement.find(e => e.elementName === 'MinT').time[0].parameter.parameterName;
                    const maxT = loc.weatherElement.find(e => e.elementName === 'MaxT').time[0].parameter.parameterName;
                    const pop = loc.weatherElement.find(e => e.elementName === 'PoP').time[0].parameter.parameterName;
                    document.getElementById('ui-weather-text').innerText = wx;
                    document.getElementById('ui-range-display').innerText = `${minT}¬∞C ~ ${maxT}¬∞C`;
                    document.getElementById('ui-rain-display').innerHTML = `<i class="fas fa-umbrella"></i> ${pop}%`;
                }
            } catch (e) { }
        }

        // üì¢ Â∞àÊ•≠ÂÆòÊñπÂÆ£Â∞é + Âæ™Áí∞Êí≠ÊîæÈÇèËºØ
        async function updateMarquee() {
            try {
                // --- 1. ÂèñÂæóÁõÆÂâçÁ≥ªÁµ±ÂêçÁ®± ---
                const sysMap = { 'TRTC': 'Âè∞ÂåóÊç∑ÈÅã', 'KRTC': 'È´òÈõÑÊç∑ÈÅã', 'TYMC': 'Ê°ÉÂúíÊç∑ÈÅã', 'TMRT': 'Âè∞‰∏≠Êç∑ÈÅã', 'NTMC': 'Êñ∞ÂåóÊç∑ÈÅã', 'KLRT': 'È´òÈõÑËºïËªå' };
                const sysName = sysMap[system] || 'Êç∑ÈÅãÁ≥ªÁµ±';

                // --- 2. ÊäìÂèñÊúÄÊñ∞Ê∂àÊÅØ ---
                let newsContent = "";
                try {
                    const res = await fetch(`https://metro-api-worker.weacamm.org/api/news?sys=${system}`);
                    const data = await res.json();
                    if (Array.isArray(data) && data.length > 0) {
                        newsContent = data.slice(0, 3).map(n => `„Äê${sysName}ÊúÄÊñ∞Ê∂àÊÅØ„Äë${n.Title || n.NewsTitle}`).join('„ÄÄ„ÄÄ') + '„ÄÄ„ÄÄ';
                    }
                } catch (e) { console.log("News fetch failed"); }

                // --- 3. ÂÆåÊï¥ÂÆòÊñπÂÆ£Â∞éÂÖßÂÆπ (Âö¥Ê†º‰øùÁïô) ---
                const mandatoryMessages = [
                    "„ÄêTPASS 2.0ÔºàÂÖ¨ÂÖ±ÈÅãËº∏Â∏∏ÂÆ¢ÂÑ™ÊÉ†Ôºâ„ÄëÊ∞ëÁúæÂè™Ë¶ÅÊåÅË®òÂêçÈõªÂ≠êÁ•®Ë≠â‰∏îËá≥ÂÖ¨Ë∑ØÂ±ÄÂÖ¨ÂÖ±ÈÅãËº∏Â∏∏ÂÆ¢ÂÑ™ÊÉ†ÂõûÈ•ãÂ∞àÂçÄÂÆåÊàêÁôªÈåÑÔºåÊØèÊúàÊê≠‰πòÂÖ¨ÂÖ±ÈÅãËº∏ÈÅî11Ê¨°‰ª•‰∏äÔºåÂèØ‰∫´‰∏çÂêåÊØî‰æã‰πòËªäÈáëÈ°çÂõûÈ•ãÔºåËá∫ÈêµÂíåÊç∑ÈÅã‰πüÊúâÂä†Á¢º„ÄÇÈáùÂ∞ç91Ê¢ù‰∏≠Èï∑ÈÄîÂúãÈÅìÂÆ¢ÈÅãË∑ØÁ∑öË®≠Ë®àËºÉÊòìÈÅîÊàê‰πãÂõûÈ•ãÊ¢ù‰ª∂ÔºåÊ∞ëÁúæÊØèÊúàÊê≠‰πò2Ëá≥3Ê¨°Âç≥ÂèØ‰∫´Êúâ15%‰πòËªäÈáëÈ°çÂõûÈ•ãÔºå4Ê¨°‰ª•‰∏äÂâá‰∫´30%ÂõûÈ•ã„ÄÇ",
                    "ÈÅáÁ∑äÊÄ•ÁãÄÊ≥Å‰øùÊåÅÂÜ∑ÈùúÂãøÈ©öÊÖåÔºåË´ã‰ΩøÁî®Â∞çË¨õÊ©üÈÄöÁü•ÊúçÂãô‰∫∫Âì°ËôïÁêÜ„ÄÇ",
                    "Êç∑ÈÅãÁ≥ªÁµ±ÂÖ®Èù¢Á¶ÅÊ≠¢Âê∏Ëè∏(Âê´ÈõªÂ≠êÁÖôÁ≠âÈ°ûËè∏ÂìÅ)ÔºåÈÅïËÄÖ‰æùÊ≥ïÊúÄÈ´òÂèØËôïÊñ∞Âè∞Âπ£1Ëê¨ÂÖÉÁΩ∞Èç∞„ÄÇ",
                    "Êê≠‰πòÈõªÊâ∂Ê¢ØÂÖ©ÂÅ¥ÁöÜÂèØÁ´ôÁ´ã„ÄÅÈÅøÂÖç‰ΩøÁî®ÊâãÊ©üÔºõÈõªÊâ∂Ê¢ØÂá∫ÂÖ•Âè£Ë´ãÂãøÈÄóÁïô„ÄÇ",
                    "„ÄåË∑ë„ÄÅË∫≤„ÄÅÂ†±ÔºÅÈÅ≠ÈÅáÁ™ÅÁôºÂ®ÅËÑÖÔºå‰øùÂëΩÈóúÈçµ‰∏âÊ≠•È©ü„ÄçÔºö„ÄåË∑ë„ÄçÔºöÁ´ãÂç≥Ë∑ëÈõ¢ÁèæÂ†¥Ôºå‰∏çÂúçËßÄÊãçÁÖß„ÄÇ„ÄåË∫≤„ÄçÔºöÂ∞ãÊâæÂÆâÂÖ®ËôïË∫≤ËóèÔºå‰øùÊåÅÂÆâÈùú„ÄÇ„ÄåÂ†±„ÄçÔºöÁ¢∫Ë™çÂÆâÂÖ®ÂæåÁ´ãÂç≥Â†±Ê°à(110Êàñ119)„ÄÇ",
                    "Êµ∑Â§ñÊâìÂ∑•È†àË¨πÊÖéÔºåÂ∞èÂøÉËêΩÂÖ•ÂúàÂ•óÊúâÂéªÁÑ°Âõû„ÄÇ",
                    "ÊäïË≥áÁêÜË≤°ÈùûÁõ≤ÁõÆÊäïÊ©üÔºåÂãøËºï‰ø°ËÇ°Â∏ÇÊòéÁâå„ÄÇ",
                    "ÊèêÊ¨æÊ©ü‰∏çËÉΩËß£Èô§Êâ£Ê¨æË®≠ÂÆöÔºå‰∏çËÉΩËæ®Ë≠òË∫´ÂàÜÔºå‰∏çËÉΩÈÄÄÊ¨æ„ÄÇ",
                    "Ê™¢Ë≠¶Ë¶ÅÈå¢ÂøÖË©êÈ®ôÔºåÁõ£ÁÆ°Â∏≥Êà∂ÈÉΩÊòØÈ®ôÔºåÊ™¢Ë≠¶Ê©üÈóú‰∏çÊúÉË¶ÅÊ±ÇÊ∞ëÁúæÂ¢ÉÂ§ñÂåØÊ¨æ„ÄÇ",
                    "ÊÖéÈò≤Ë©êÈ®ôÈõÜÂúòÂ∏∏ÂÜíÁî®ÊîøÂ∫úÊ©üÈóúÂêçÁæ©Ë°åÈ®ôÔºåË¨äÁ®±Ë¢´ÂÆ≥‰∫∫Ë∫´ÂàÜÈÅ≠ÂÜíÁî®ÔºåË´ãÊèêÈ´òË≠¶Ë¶∫ÔºåÂ¶ÇÊúâÁñëÂïèÊ≠°ËøéÊí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑ö„ÄÇ",
                    "Âàë‰∫ãË≠¶ÂØüÂ±ÄÁ∂≤Á´ôÂª∫ÁΩÆ„ÄåÈÄöÁ∑ù‰ª§ËøΩËøΩËøΩÔºçÊ™¢ËàâË©êÊ¨∫ËªäÊâãÂ∞àÂçÄ„ÄçÔºåÂÖ®Ê∞ë‰∏ÄËµ∑ÊäìËªäÊâãÈ†òÁçéÈáë„ÄÇ",
                    "Ê±ÇËÅ∑„ÄÅË≤∏Ê¨æÂàáÂãø‰∫§Âá∫Ë∫´ÂàÜË≠â‰ª∂„ÄÅÂ≠òÊë∫„ÄÅÂç∞Á´†„ÄÅÊèêÊ¨æÂç°ÂèäÂØÜÁ¢ºÔºå ÈÅøÂÖçÊ∑™ÁÇ∫Ë©êÊ¨∫ÂÖ±ÁäØ„ÄÇ",
                    "Èò≤Ë©êÂ∞èÊíáÊ≠•Ôºö‰øùÊåÅÂÜ∑ÈùúÂ§öÊü•Ë≠âÔºå‰∏çÂêÉËôßÊâçÂÆâÂøÉÔºÅ",
                    "ÊôÇÊôÇÂ∞èÂøÉÈò≤ÊÑèÂ§ñÔºåËôïËôïÁïôÊÑè‰øùÂπ≥ÂÆâÔºåÁôºÁèæÁï∞Â∏∏ÈÄüÈÄöÂ†±Ôºå‰πòËªäÂÆâÂÖ®ÂæóÁ¢∫‰øù„ÄÇ"
                ];

                // --- 4. ÁµÑÂêàÊúÄÁµÇÂ≠ó‰∏≤ ---
                const finalMarqueeText = `${newsContent}${mandatoryMessages.join('„ÄÄ„ÄÄ')}„ÄÄ„ÄÄÁ•ùÊÇ®ÊóÖÈÄîÊÑâÂø´ÔºÅ`;

                const marqueeEl = document.getElementById('ui-marquee');
                if (marqueeEl) {
                    marqueeEl.innerText = finalMarqueeText;
                    // ÂïüÂãïÁÑ°ÈôêÂæ™Áí∞ÂãïÁï´
                    runMarqueeLoop('ui-marquee');
                }

            } catch (e) { console.error("Marquee error:", e); }
        }

        // üî• ÁÑ°ÈôêÂæ™Áí∞Ë∑ëÈ¶¨ÁáàÊéßÂà∂Ê†∏ÂøÉ
        function runMarqueeLoop(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const container = el.parentElement;

            // ÈáçÁΩÆÁãÄÊÖã
            el.style.transition = 'none';
            const containerWidth = container.offsetWidth;

            // Ëµ∑ÈªûÔºöÂÆπÂô®ÊúÄÂè≥ÈÇä
            el.style.left = containerWidth + 'px';

            // ËÆìÁÄèË¶ΩÂô®Ë®àÁÆóÂØ¨Â∫¶
            setTimeout(() => {
                const textWidth = el.offsetWidth;
                // Ë®≠ÂÆöÈÄüÂ∫¶ÔºöÊØèÂÄãÂ≠óÁ¥Ñ 0.45 Áßí (Êï∏ÂÄºË∂äÂ∞èË∂äÂø´)
                const speed = 0.006;
                const duration = (textWidth + containerWidth) * speed;

                // Âü∑Ë°åÂãïÁï´Ôºö‰ΩçÁßªÂà∞ÊñáÂ≠óÂØ¨Â∫¶ÁöÑË≤†ÂÄºÔºàÂÆåÂÖ®Ê∂àÂ§±Âú®Â∑¶ÂÅ¥Ôºâ
                el.style.transition = `left ${duration}s linear`;
                el.style.left = `-${textWidth}px`;

                // ÈóúÈçµÔºöÁõ£ËÅΩÂãïÁï´ÁµêÊùü‰∫ã‰ª∂ÔºåÁµêÊùüÂæåÁ´ãÂàªÈáçÂïü
                el.ontransitionend = () => {
                    runMarqueeLoop(id);
                };
            }, 50);
        }

        init();
    </script>
</body>

</html>