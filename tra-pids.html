<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµ PIDS (V6.0 Master Class - PWA + å¤§å¸«ç´šæ¶æ§‹)</title>

    <!-- ğŸ”¥ PWA æ”¯æ´ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å°éµPIDS">
    <link rel="apple-touch-icon" href="assets/icon-192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ============ CSS è®Šæ•¸ç³»çµ± (Design Tokens) ============ */
        :root {
            --pids-bg-primary: #000000;
            --pids-bg-secondary: #111111;
            --pids-text-primary: #ffffff;
            --pids-text-secondary: #cccccc;
            --pids-border: #333333;
            --accent-yellow: #ffeb3b;
            --accent-blue: #4fc3f7;
            --accent-red: #ff1744;
            --accent-orange: #ff9800;
            --header-inbound: linear-gradient(to right, #000080, #0d47a1);
            --header-outbound: linear-gradient(to right, #bf360c, #e65100);
            --row-odd-bg-inbound: #000;
            --row-even-bg-inbound: #002f4b;
            --row-odd-bg-outbound: #000;
            --row-even-bg-outbound: #3e2723;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* ============ ç„¡éšœç¤™è¨­è¨ˆï¼šè¢å¹•é–±è®€å™¨å°ˆç”¨ ============ */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        body {
            background-color: var(--pids-bg-secondary);
            color: var(--pids-text-primary);
            font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 8px;
        }

        /* Header */
        .unified-header {
            width: 100%;
            height: 90px;
            background: #000;
            border: none;
            /* ğŸ”¥ ä¿®æ­£: ç§»é™¤é‚Šæ¡† */
            border-radius: 0;
            /* ğŸ”¥ ä¿®æ­£: ç§»é™¤åœ“è§’ */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: none;
            /* ç§»é™¤é™°å½± */
            flex-shrink: 0;
            border-bottom: 2px solid #333;
            /* åŠ ä¸Šåº•éƒ¨ç·šæ¢ä»¥åˆ†éš” */
        }

        .station-branding {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            line-height: 1;
        }

        .tra-logo-img {
            height: 3.5rem;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        .station-name-block {
            display: flex;
            flex-direction: row;
            align-items: baseline;
            gap: 10px;
            line-height: 1;
        }

        .station-name {
            font-size: 3.5rem;
            font-weight: 900;
            line-height: 1;
            margin: 0;
        }

        .station-sub {
            font-size: 3.5rem;
            color: #4fc3f7;
            font-family: Consolas, sans-serif;
            letter-spacing: 0px;
            font-weight: bold;
            line-height: 1;
            margin: 0;
        }

        .datetime-block {
            text-align: right;
            display: flex;
            flex-direction: row;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            line-height: 1;
        }

        .date-text {
            font-size: 3rem;
            color: #ccc;
            font-weight: bold;
            font-family: Consolas, monospace;
            line-height: 1;
            margin: 0;
        }

        .time-text {
            font-size: 3rem;
            font-weight: bold;
            font-family: Consolas, monospace;
            color: #ffeb3b;
            line-height: 1;
            margin: 0;
        }

        /* å…¨è¢å¹•æŒ‰éˆ• */
        .fullscreen-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            font-size: 1.5rem;
            width: 48px;
            height: 48px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-left: 12px;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .fullscreen-btn:active {
            transform: scale(0.95);
        }

        /* Top Marquee */
        .unified-marquee-container {
            width: 100%;
            height: 60px;
            background: #e3f2fd;
            border: none;
            display: flex;
            align-items: center;
            overflow: hidden;
            position: relative;
            color: #003366;
            flex-shrink: 0;
            margin-top: 0;
            /* ä¿®æ­£: ç§»é™¤è² é‚Šè·ï¼Œè®“å®ƒç·Šè²¼ Header */
            margin-left: -8px;
            margin-right: -8px;
            padding: 0 8px;
        }

        .unified-marquee-container .marquee-text {
            position: absolute;
            white-space: nowrap;
            height: 60px;
            line-height: 60px;
            font-size: 2.5rem;
            font-weight: 900;
            left: 100%;
            will-change: transform;
            letter-spacing: 1px;
        }

        /* ğŸ”¥ ç§»é™¤: ä¸å†è‡ªå‹•æ·»åŠ ç®­é ­ï¼Œå®Œå…¨ä½¿ç”¨ D1 ä¸­çš„å…§å®¹ */

        /* PIDS Section */
        .pids-section {
            display: flex;
            width: 100%;
            gap: 10px;
            flex: 0 0 auto;
            /* âœ… ä¸è‡ªå‹•å¢é•·ï¼Œç”±å…§å®¹æ±ºå®š */
            min-height: 0;
            overflow: hidden;
        }

        .pids-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--pids-bg-primary);
            border: 3px solid var(--pids-border);
            border-radius: 8px;
            overflow: hidden;
        }

        .screen-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--pids-bg-primary);
            overflow: hidden;
        }

        .direction-header-1 {
            background: var(--header-inbound);
            color: var(--pids-text-primary);
            padding: 10px 15px;
            font-size: 1.5rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid var(--pids-text-primary);
            flex-shrink: 0;
        }

        .direction-header-0 {
            background: var(--header-outbound);
            color: var(--pids-text-primary);
            padding: 10px 15px;
            font-size: 1.5rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid var(--pids-text-primary);
            flex-shrink: 0;
        }

        .dest-list {
            font-size: 1.5rem;
        }

        /* è¡¨æ ¼è¨­å®š (5æ¬„ + 7ç­è»Š) */
        .train-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            font-size: 1.6rem;
            font-weight: bold;
            table-layout: fixed;
        }

        .train-table th {
            padding: 8px;
            color: #fff;
            border-bottom: 2px solid #fff;
            height: 40px;
            font-size: 1.3rem;
        }

        .train-table tbody tr {
            border-bottom: 1px solid #333;
        }

        /* 5ç­è»Š */
        .train-table td {
            padding: 0 5px;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 65px;
            /* âœ… 5ç­è»Šå°ˆç”¨ï¼šç¨å¾®åŠ é«˜ï¼Œè®“æ¯ç­è»Šæ›´æ¸…æ™° */
            font-size: 1.8rem;
            /* åŠ å¤§å­—é«” */
        }

        .table-1 th {
            background: #000080;
        }

        .table-1 tr:nth-child(odd) {
            background: var(--row-odd-bg-inbound);
        }

        .table-1 tr:nth-child(even) {
            background: var(--row-even-bg-inbound);
        }

        .table-0 th {
            background: #bf360c;
        }

        .table-0 tr:nth-child(odd) {
            background: var(--row-odd-bg-outbound);
        }

        .table-0 tr:nth-child(even) {
            background: var(--row-even-bg-outbound);
        }

        .marquee-footer {
            background: #212121;
            color: #ffeb3b;
            height: 50px;
            position: relative;
            overflow: hidden;
            border-top: 3px solid #ff9800;
            flex-shrink: 0;
        }

        .marquee-footer .marquee-text {
            position: absolute;
            white-space: nowrap;
            left: 100%;
            height: 50px;
            line-height: 50px;
            font-size: 1.4rem;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        /* Media Section - âœ… V6.1 é»ƒé‡‘æ¯”ä¾‹ï¼šè‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ */
        .media-section {
            flex: 1;
            /* âœ… é—œéµï¼šè‡ªå‹•ä½”æ»¿ç•«é¢å‚ç›´å‰©é¤˜çš„æ‰€æœ‰ç©ºé–“ */
            display: flex;
            gap: 10px;
            min-height: 150px;
            /* ç¢ºä¿æœ€å°é«˜åº¦ */
            margin-top: 4px;
        }

        .media-box {
            flex: 1;
            height: 100%;
            /* âœ… å¡«æ»¿çˆ¶å®¹å™¨ */
            background: #000;
            border: 3px solid #333;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-label {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 4px 10px;
            font-size: 1rem;
            z-index: 10;
            border-bottom-right-radius: 8px;
        }

        .carousel-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
            opacity: 0;
            transition: opacity 1s;
        }

        .carousel-img.active {
            opacity: 1;
        }

        .video-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* è»Šç¨®é¡è‰² */
        .train-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 1.5rem;
            font-weight: 500;
            white-space: nowrap;
            min-width: 90px;
            max-width: 130px;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        .type-è‡ªå¼· {
            background-color: #FF5722;
        }

        .type-æ–°è‡ªå¼· {
            background: linear-gradient(135deg, #222 0%, #444 100%);
            border: 1px solid #999;
        }

        .type-æ™®æ‚ ç‘ª {
            background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%);
        }

        .type-å¤ªé­¯é–£ {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        }

        .type-è’å…‰ {
            background-color: #FF9800;
        }

        .type-å€é–“å¿« {
            background-color: #3F51B5;
        }

        .type-å€é–“ {
            background-color: #2196F3;
        }

        .type-å…¶ä»– {
            background-color: #607D8B;
        }

        /* ç‹€æ…‹èˆ‡æ™‚é–“ */
        .status-ontime {
            color: #FFFFFF !important;
        }

        .status-delay {
            color: #ff1744 !important;
            animation: blink 1s infinite alternate;
        }

        .status-cancelled {
            color: #FF5252;
            font-weight: 900;
        }

        /* å»¶èª¤æ™‚é–“å®¹å™¨ -> æ©«å‘ä¸¦æ’é¡¯ç¤º */
        .time-delay-container {
            display: flex;
            flex-direction: row;
            /* æ©«å‘æ’åˆ— */
            justify-content: flex-end;
            /* é å³å°é½Š */
            align-items: center;
            /* å‚ç›´ç½®ä¸­ */
            height: 100%;
            padding-right: 5px;
            gap: 8px;
            /* å…©å€‹æ™‚é–“ä¹‹é–“çš„é–“éš” */
        }

        .original-time {
            text-decoration: line-through;
            color: #777;
            font-size: 1.2rem;
            line-height: 1.8rem;
            /* èˆ‡é è¨ˆæ™‚é–“å°é½ */
        }

        .expected-time {
            color: #4fc3f7;
            font-weight: bold;
            font-size: 1.8rem;
        }

        .normal-time {
            font-size: 1.8rem;
            font-family: Consolas;
            text-align: right;
            padding-right: 5px;
        }

        .highlight-row {
            background-color: rgba(255, 255, 255, 0.15) !important;
            border: 2px solid #ffeb3b !important;
        }

        @keyframes dynamic-marquee {
            from {
                transform: translateX(var(--start-pos));
            }

            to {
                transform: translateX(var(--end-pos));
            }
        }

        /* ğŸ”¥ ä¸­å‹å¹³æ¿å„ªåŒ– (1024px-1280pxï¼Œå¦‚ 1280Ã—800 å¹³æ¿) */
        @media (max-width: 1280px) and (min-width: 901px) {
            .unified-header {
                height: 75px;
                padding: 0 12px;
            }

            .tra-logo-img {
                height: 2.8rem;
            }

            .station-name {
                font-size: 2.8rem;
            }

            .station-sub {
                font-size: 2.8rem;
            }

            .datetime-block {
                gap: 10px;
            }

            .date-text {
                font-size: 2.3rem;
            }

            .time-text {
                font-size: 2.3rem;
            }

            /* ä¸­å‹å¹³æ¿å…¨è¢å¹•æŒ‰éˆ• */
            .fullscreen-btn {
                width: 44px;
                height: 44px;
                font-size: 1.3rem;
                margin-left: 10px;
            }

            .unified-marquee-container {
                height: 50px;
            }

            .unified-marquee-container .marquee-text {
                line-height: 50px;
                font-size: 1.5rem;
            }

            .direction-header-0,
            .direction-header-1 {
                font-size: 1.2rem;
                padding: 8px 12px;
            }

            .dest-list {
                font-size: 1rem;
            }

            .train-table {
                font-size: 1.1rem;
            }

            .train-table th {
                font-size: 0.95rem;
                padding: 5px 2px;
                height: 30px;
            }

            .train-table td {
                height: 58px;
                padding: 0 3px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* è»Šæ¬¡æ¬„ä½ç‰¹åˆ¥ç¸®å° */
            .train-table td:nth-child(1) {
                font-size: 0.9rem;
            }

            /* ç‹€æ…‹æ¬„ä½ç‰¹åˆ¥ç¸®å° */
            .train-table td:nth-child(5) {
                font-size: 0.9rem;
            }

            .train-type-badge {
                font-size: 0.8rem;
                min-width: 55px;
                max-width: 75px;
            }

            .normal-time,
            .expected-time {
                font-size: 1.2rem;
            }

            .original-time {
                font-size: 0.9rem;
            }
        }

        /* ğŸ”¥ å°å¹³æ¿å…¨è¢å¹•å„ªåŒ– (800px-900pxï¼Œå¦‚ 800Ã—600 æˆ– 1024Ã—768 å°å¹³æ¿) */
        @media (max-width: 900px) and (min-width: 700px) {
            .unified-header {
                height: 60px;
                padding: 0 10px;
            }

            .tra-logo-img {
                height: 2.2rem;
            }

            .station-branding {
                gap: 8px;
            }

            .station-name {
                font-size: 2.2rem;
            }

            .station-sub {
                font-size: 2.2rem;
            }

            .datetime-block {
                gap: 8px;
            }

            .date-text {
                font-size: 1.8rem;
            }

            .time-text {
                font-size: 1.8rem;
            }

            /* å°å¹³æ¿å…¨è¢å¹•æŒ‰éˆ• */
            .fullscreen-btn {
                width: 38px;
                height: 38px;
                font-size: 1.1rem;
                margin-left: 8px;
            }

            .unified-marquee-container {
                height: 42px;
            }

            .unified-marquee-container .marquee-text {
                line-height: 42px;
                font-size: 1.2rem;
            }

            .direction-header-0,
            .direction-header-1 {
                font-size: 1rem;
                padding: 6px 8px;
            }

            .dest-list {
                font-size: 0.85rem;
            }

            .train-table {
                font-size: 0.75rem;
            }

            .train-table th {
                font-size: 0.7rem;
                padding: 3px 1px;
                height: 22px;
            }

            .train-table td {
                height: 48px;
                padding: 0 1px;
                font-size: 0.75rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* è»Šæ¬¡æ¬„ä½ç‰¹åˆ¥ç¸®å° */
            .train-table td:nth-child(1) {
                font-size: 0.65rem;
            }

            /* ç‹€æ…‹æ¬„ä½ç‰¹åˆ¥ç¸®å° */
            .train-table td:nth-child(5) {
                font-size: 0.65rem;
            }

            .train-type-badge {
                font-size: 0.75rem;
                min-width: 48px;
                max-width: 68px;
                padding: 2px 3px;
            }

            .normal-time,
            .expected-time {
                font-size: 0.8rem;
            }

            .original-time {
                font-size: 0.6rem;
            }

            .marquee-footer {
                height: 36px;
            }

            .marquee-footer .marquee-text {
                font-size: 0.9rem;
                line-height: 36px;
            }
        }

        /* ğŸ”¥ RWD ä¿®æ­£å€å¡Š (é‡å°å°è¢å¹•ï¼Œå¦‚æ‰‹æ©Ÿ/å¹³æ¿) */
        @media (max-width: 699px) {
            body {
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
            }
            .unified-header {
                height: 65px;
                padding: 0 8px;
                gap: 8px;
            }

            .tra-logo-img {
                height: 2.3rem;
            }

            .station-branding {
                gap: 8px;
            }

            .station-name-block {
                flex-direction: column;
                gap: 0;
                align-items: flex-start;
            }

            .station-name {
                font-size: 1.5rem;
            }

            .station-sub {
                font-size: 1.3rem;
            }

            .datetime-block {
                gap: 6px;
            }

            .date-text {
                font-size: 1.1rem;
            }

            .time-text {
                font-size: 1.4rem;
            }

            /* å¹³æ¿ç‰ˆå…¨è¢å¹•æŒ‰éˆ• */
            .fullscreen-btn {
                width: 34px;
                height: 34px;
                font-size: 1rem;
                margin-left: 6px;
            }

            .unified-marquee-container {
                height: 38px;
                margin-left: -8px;
                margin-right: -8px;
            }

            .unified-marquee-container .marquee-text {
                line-height: 38px;
                font-size: 1rem;
            }

            .pids-section {
                flex-direction: column;
                gap: 8px;
                overflow-y: auto;
            }

            .pids-column {
                min-height: 240px;
                flex-shrink: 0;
            }

            .direction-header-0,
            .direction-header-1 {
                font-size: 0.9rem;
                padding: 5px 8px;
            }

            .dest-list {
                font-size: 0.75rem;
            }

            .train-table {
                font-size: 0.85rem;
            }

            .train-table th {
                font-size: 0.75rem;
                padding: 3px 2px;
                height: 24px;
            }

            .train-table td {
                height: 46px;
                padding: 0 3px;
                font-size: 0.85rem;
            }

            /* è»Šæ¬¡æ¬„ä½ç‰¹åˆ¥ç¸®å°ï¼Œé¿å…æˆªæ–·æˆçœç•¥è™Ÿ */
            .train-table td:nth-child(1) {
                font-size: 0.7rem;
            }

            /* ç‹€æ…‹æ¬„ä½ç‰¹åˆ¥ç¸®å° */
            .train-table td:nth-child(5) {
                font-size: 0.7rem;
            }

            /* æ‰‹æ©Ÿç‰ˆ5ç­è»Šä½”æ»¿ç©ºé–“ */

            .train-type-badge {
                font-size: 0.65rem;
                min-width: 42px;
                max-width: 60px;
                padding: 2px 3px;
            }

            .normal-time,
            .expected-time {
                font-size: 0.85rem;
            }

            .original-time {
                font-size: 0.65rem;
            }

            .marquee-footer {
                height: 32px;
            }

            .marquee-footer .marquee-text {
                font-size: 0.8rem;
                line-height: 32px;
            }

            /* ğŸ”¥ ä¿®æ­£: æ‰‹æ©Ÿç‰ˆåª’é«”å€å¡Šæ”¹ç‚ºå‚ç›´å †ç–Šä¸¦å¯æ»‘å‹• */
            .media-section {
                flex-direction: column;
                gap: 8px;
                overflow-y: auto;
            }

            .media-box {
                height: 120px;
                /* æ¯å€‹ç›’å­å›ºå®šé«˜åº¦ */
                flex: 0 0 auto;
                /* ä¸è‡ªå‹•ä¼¸ç¸® */
            }
        }

        @media (max-width: 480px) {
            body {
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
            }
            .unified-header {
                height: 60px;
                padding: 0 5px;
            }

            .tra-logo-img {
                height: 1.8rem;
            }

            .station-name-block {
                flex-direction: column;
                gap: 0;
                align-items: flex-start;
            }

            .station-name {
                font-size: 1.3rem;
            }

            .station-sub {
                font-size: 0.65rem;
            }

            .date-text {
                font-size: 0.6rem;
            }

            .time-text {
                font-size: 1.2rem;
            }

            /* æ‰‹æ©Ÿç‰ˆå…¨è¢å¹•æŒ‰éˆ• */
            .fullscreen-btn {
                width: 28px;
                height: 28px;
                font-size: 0.85rem;
                margin-left: 4px;
                border-radius: 6px;
            }

            .unified-marquee-container {
                height: 32px;
            }

            .unified-marquee-container .marquee-text {
                line-height: 32px;
                font-size: 0.85rem;
            }

            .direction-header-0,
            .direction-header-1 {
                font-size: 0.8rem;
                padding: 3px 6px;
            }

            .dest-list {
                font-size: 0.65rem;
            }

            .pids-section {
                overflow-y: auto;
            }

            .pids-column {
                min-height: 210px;
                flex-shrink: 0;
            }

            .train-table {
                font-size: 0.75rem;
            }

            .train-table th {
                font-size: 0.65rem;
                height: 22px;
                padding: 2px 1px;
            }

            .train-table td {
                height: 42px;
                padding: 0 2px;
                font-size: 0.75rem;
            }

            /* è»Šæ¬¡æ¬„ä½ç‰¹åˆ¥ç¸®å°ï¼Œé¿å…æˆªæ–·æˆçœç•¥è™Ÿ */
            .train-table td:nth-child(1) {
                font-size: 0.6rem;
            }

            /* ç‹€æ…‹æ¬„ä½ç‰¹åˆ¥ç¸®å° */
            .train-table td:nth-child(5) {
                font-size: 0.6rem;
            }

            .train-type-badge {
                font-size: 0.6rem;
                min-width: 38px;
                padding: 1px 2px;
            }

            .normal-time,
            .expected-time {
                font-size: 0.75rem;
            }

            .marquee-footer {
                height: 28px;
            }

            .marquee-footer .marquee-text {
                font-size: 0.7rem;
                line-height: 28px;
            }

            /* æ‰‹æ©Ÿç‰ˆåª’é«”å€ç¶­æŒå‚ç›´å †ç–Šæ¨¡å¼ */
            #videoBox {
                display: none;
            }

            #carouselBox {
                height: 100%;
            }
        }
    </style>
    <script src="assets/station-code-mapping.js"></script>
</head>

<body>
    <!-- Header -->
    <div class="unified-header">
        <div class="station-branding">
            <img src="assets/TRA_logo.jpg" class="tra-logo-img">
            <div class="station-name-block">
                <div class="station-name" id="unifiedStationName">è‡ºéµè»Šç«™</div>
                <div class="station-sub" id="station-en">TRA STATION</div>
            </div>
        </div>
        <div class="datetime-block">
            <div class="date-text" id="unifiedDate">Loading...</div>
            <div class="time-text" id="unifiedTime">--:--:--</div>
            <button class="fullscreen-btn" id="fullscreenBtn" title="åˆ‡æ›å…¨è¢å¹•" aria-label="åˆ‡æ›å…¨è¢å¹•">
                <i class="fas fa-expand"></i>
            </button>
        </div>
    </div>

    <!-- Top Marquee -->
    <div class="unified-marquee-container">
        <div class="marquee-text" id="unifiedTopMarquee">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- PIDS Tables -->
    <div class="pids-section">
        <!-- é€†è¡Œ -->
        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-1"><span id="dirTitle1">é€†è¡Œ</span><span id="destList1"
                        class="dest-list"></span></div>
                <table class="train-table table-1" role="grid" aria-live="polite" aria-label="é€†è¡Œåˆ—è»Šå³æ™‚è³‡è¨Š">
                    <caption class="sr-only">é€†è¡Œåˆ—è»Šå‡ºç™¼è³‡è¨Šè¡¨æ ¼</caption>
                    <thead>
                        <tr>
                            <th scope="col" id="col-no-1" style="width:15%">è»Šæ¬¡</th>
                            <th scope="col" id="col-type-1" style="width:20%">è»Šç¨®</th>
                            <th scope="col" id="col-dest-1" style="width:28%">é–‹å¾€</th>
                            <th scope="col" id="col-time-1" style="width:20%">å¯¦éš›é–‹è»Šæ™‚é–“</th>
                            <th scope="col" id="col-status-1" style="width:17%">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="body1"></tbody>
                </table>
            </div>
            <div class="marquee-footer">
                <div class="marquee-text" id="marquee1">è®€å–ä¸­...</div>
            </div>
        </div>
        <!-- é †è¡Œ -->
        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-0"><span id="dirTitle0">é †è¡Œ</span><span id="destList0"
                        class="dest-list"></span></div>
                <table class="train-table table-0" role="grid" aria-live="polite" aria-label="é †è¡Œåˆ—è»Šå³æ™‚è³‡è¨Š">
                    <caption class="sr-only">é †è¡Œåˆ—è»Šå‡ºç™¼è³‡è¨Šè¡¨æ ¼</caption>
                    <thead>
                        <tr>
                            <th scope="col" id="col-no-0" style="width:15%">è»Šæ¬¡</th>
                            <th scope="col" id="col-type-0" style="width:20%">è»Šç¨®</th>
                            <th scope="col" id="col-dest-0" style="width:28%">é–‹å¾€</th>
                            <th scope="col" id="col-time-0" style="width:20%">å¯¦éš›é–‹è»Šæ™‚é–“</th>
                            <th scope="col" id="col-status-0" style="width:17%">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="body0"></tbody>
                </table>
            </div>
            <div class="marquee-footer">
                <div class="marquee-text" id="marquee0">è®€å–ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Media -->
    <div class="media-section">
        <div class="media-box" id="carouselBox">
            <div class="media-label">å®£å°è³‡è¨Š</div>
            <img src="https://www.railway.gov.tw/tra-tip-web/static/images/hero-bg-01.jpg" class="carousel-img active">
        </div>
        <div class="media-box" id="videoBox">
            <div class="media-label">å½±éŸ³å°ˆå€</div>
            <div id="videoContainer" style="width:100%;height:100%"></div>
        </div>
    </div>

    <!-- ğŸ”¥ HTML Templates (è³‡æ–™é©…å‹• UIï¼Œå¾æºé ­æœçµ• XSS) -->
    <template id="train-row-template">
        <tr role="row">
            <td role="gridcell" class="train-no-cell" style="font-family:Consolas"></td>
            <td role="gridcell" class="train-type-cell"></td>
            <td role="gridcell" class="train-dest-cell"></td>
            <td role="gridcell" class="train-time-cell"></td>
            <td role="gridcell" class="train-status-cell"></td>
        </tr>
    </template>

    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script>
        // ============ PIDS æ‡‰ç”¨ç¨‹å¼æ¶æ§‹ ============
        const PIDS_APP = {
            // é…ç½®å¸¸æ•¸ï¼ˆè§£æ±ºç¡¬ç·¨ç¢¼å•é¡Œï¼‰
            CONFIG: {
                API_BASE: "https://tra-schedule-worker.weacamm.org",
                INTERVALS: {
                    CLOCK: 1000,            // æ™‚é˜æ›´æ–°é–“éš”
                    PIDS_UPDATE: 60000,     // PIDS æ•¸æ“šæ›´æ–°é–“éš” (1åˆ†é˜)
                    LANG_SWITCH: 80000,     // èªè¨€è‡ªå‹•åˆ‡æ›é–“éš” (80ç§’)
                    TOP_MARQUEE_CHECK: 60000,  // é ‚éƒ¨è·‘é¦¬ç‡ˆæª¢æŸ¥é–“éš” (1åˆ†é˜)
                    CAROUSEL: 10000         // è¼ªæ’­åœ–åˆ‡æ›é–“éš”
                },
                ROWS: {
                    DESKTOP: 5,  // âœ… é»ƒé‡‘æ¯”ä¾‹ï¼š5 è¡Œåˆ—è»Šï¼Œæ¯è¡Œæ›´å¤§æ›´æ¸…æ™°
                    MOBILE: 5
                },
                TRAIN_TYPES: {
                    "1100": "\u81ea\u5f37", "1101": "\u592a\u9b6f\u95a3", "1102": "\u81ea\u5f37", "1103": "\u81ea\u5f37", "1107": "\u666e\u60a0\u746a",
                    "1108": "\u81ea\u5f37", "110B": "\u65b0\u81ea\u5f37", "110G": "\u65b0\u81ea\u5f37", "110H": "\u65b0\u81ea\u5f37", "110K": "\u65b0\u81ea\u5f37", "110M": "\u65b0\u81ea\u5f37",
                    "1110": "\u838e\u5149", "1111": "\u838e\u5149", "1112": "\u838e\u5149", "1113": "\u838e\u5149", "1114": "\u838e\u5149", "1115": "\u838e\u5149", "1120": "\u5fa9\u8208",
                    "1131": "\u5340\u9593", "1132": "\u5340\u9593\u5feb", "1140": "\u666e\u5feb", "1150": "\u67f4\u5feb", "1270": "\u666e\u901a", "1280": "\u5340\u9593", "1281": "\u5340\u9593", "1282": "\u5340\u9593"
                }
            },

            // æ‡‰ç”¨ç‹€æ…‹ï¼ˆä½¿ç”¨ Proxy å¯¦ç¾éŸ¿æ‡‰å¼ï¼‰
            STATE: new Proxy({
                currentLang: localStorage.getItem('pids_lang') || 'zh',
                stationID: '',
                stationName: '',
                lastTrainData: [],
                stopsCache: {},
                autoSwitchTimer: null,
                isVideoLoaded: false,
                _observers: new Set()
            }, {
                set(target, prop, value) {
                    // å¿½ç•¥å…§éƒ¨å±¬æ€§
                    if (prop.startsWith('_')) {
                        target[prop] = value;
                        return true;
                    }

                    const oldValue = target[prop];
                    target[prop] = value;

                    // é€šçŸ¥æ‰€æœ‰è§€å¯Ÿè€…
                    target._observers.forEach(callback => {
                        try {
                            callback(prop, value, oldValue);
                        } catch (error) {
                            console.error('Observer callback failed:', error);
                        }
                    });

                    // ç‰¹å®šå±¬æ€§çš„è‡ªå‹•é€£å‹•é‚è¼¯
                    if (prop === 'stationID' && value) {
                        console.log(`ğŸ”„ Station changed to: ${value}`);
                        PIDS_APP.updatePids();
                    }
                    if (prop === 'lastTrainData') {
                        console.log(`ğŸ“Š Train data updated: ${value.length} trains`);
                        refreshDisplay();
                    }

                    return true;
                }
            }),

            // è¨‚é–±ç‹€æ…‹è®ŠåŒ–
            subscribe(callback) {
                this.STATE._observers.add(callback);
                return () => this.STATE._observers.delete(callback); // è¿”å›å–æ¶ˆè¨‚é–±å‡½æ•¸
            },

            // åˆå§‹åŒ–
            init() {
                const params = new URLSearchParams(location.search);
                this.STATE.stationID = params.get('station');
                this.STATE.stationName = params.get('name') || '\u81fa\u9435';

                this.ui.updateStationName();
                this.ui.updateEnglishStationName();
                this.ui.updateUIStrings();
                this.startTimers();
                this.loadInitialData();
            },

            // UI æ–¹æ³•
            ui: {
                updateStationName() {
                    const el = document.getElementById('unifiedStationName');
                    if (el) {
                        const cleanName = PIDS_APP.STATE.stationName.replace(/è»Šç«™$|ç«™$/, '');
                        el.textContent = cleanName + 'è»Šç«™';
                    }
                },

                updateEnglishStationName() {
                    const enElement = document.getElementById('station-en');
                    const stationID = PIDS_APP.STATE.stationID;
                    if (enElement && typeof stationDataMap !== 'undefined' && stationDataMap[stationID]) {
                        const rawName = stationDataMap[stationID].ename;
                        const formattedName = rawName.split('_')[0].toUpperCase();
                        enElement.textContent = `${formattedName} STATION`;
                    } else if (enElement) {
                        enElement.textContent = "TRA STATION";
                    }
                },

                updateUIStrings() {
                    const lang = i18n[PIDS_APP.STATE.currentLang];

                    const dir1Title = document.getElementById('dirTitle1');
                    const dir0Title = document.getElementById('dirTitle0');
                    if (dir1Title) dir1Title.textContent = lang.inbound;
                    if (dir0Title) dir0Title.textContent = lang.outbound;

                    const headHtml = `
                        <tr>
                            <th scope="col" style="width:15%">${lang.trainNo}</th>
                            <th scope="col" style="width:20%">${lang.type}</th>
                            <th scope="col" style="width:28%">${lang.dest}</th>
                            <th scope="col" style="width:20%">${lang.time}</th>
                            <th scope="col" style="width:17%">${lang.status}</th>
                        </tr>`;

                    const table1Head = document.querySelector('.table-1 thead');
                    const table0Head = document.querySelector('.table-0 thead');
                    if (table1Head) table1Head.innerHTML = headHtml;
                    if (table0Head) table0Head.innerHTML = headHtml;
                }
            },

            startTimers() {
                setInterval(() => this.updateClock(), this.CONFIG.INTERVALS.CLOCK);
                if (this.STATE.stationID) {
                    this.updatePids();
                    setInterval(() => this.updatePids(), this.CONFIG.INTERVALS.PIDS_UPDATE);
                }
                this.checkTopMarquee();
                setTimeout(() => startMarquee('unifiedTopMarquee'), 1500);
                setInterval(() => this.checkTopMarquee(), this.CONFIG.INTERVALS.TOP_MARQUEE_CHECK);
                this.startAutoLangSwitch();
            },

            loadInitialData() {
                this.updateClock();
                updateMediaAssets();
                this.initKeyboardNavigation();
                console.log('âœ… PIDS ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
            },

            // ğŸ”¥ éµç›¤å°èˆªæ”¯æ´ï¼ˆæ”¿åºœå°ˆæ¡ˆç„¡éšœç¤™æª¢æ¸¬è¦æ±‚ï¼‰
            initKeyboardNavigation() {
                // ç‚ºæ‰€æœ‰äº’å‹•å…ƒç´ æ·»åŠ éµç›¤æ”¯æ´
                const interactiveElements = [
                    '#station-select',
                    '#languageSwitchBtn',
                    '#fullscreenBtn'
                ];

                interactiveElements.forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el && !el.hasAttribute('tabindex')) {
                        el.setAttribute('tabindex', '0');
                        el.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                el.click();
                            }
                        });
                    }
                });

                // ç‚ºè¡¨æ ¼æ·»åŠ éµç›¤å°èˆª
                this.subscribe((prop) => {
                    if (prop === 'lastTrainData') {
                        setTimeout(() => {
                            document.querySelectorAll('.train-table tbody').forEach((tbody, tableIndex) => {
                                tbody.setAttribute('tabindex', '0');
                                tbody.setAttribute('aria-label', `ä½¿ç”¨æ–¹å‘éµç€è¦½åˆ—è»Šè³‡è¨Š - ${tableIndex === 0 ? 'åŒ—ä¸Š' : 'å—ä¸‹'}æ–¹å‘`);

                                // ç§»é™¤èˆŠç›£è½å™¨é¿å…é‡è¤‡
                                const newTbody = tbody.cloneNode(true);
                                tbody.parentNode.replaceChild(newTbody, tbody);

                                newTbody.addEventListener('keydown', (e) => {
                                    const rows = Array.from(newTbody.querySelectorAll('tr'));
                                    const currentRow = document.activeElement.closest('tr');
                                    const currentIndex = currentRow ? rows.indexOf(currentRow) : -1;

                                    switch (e.key) {
                                        case 'ArrowDown':
                                            e.preventDefault();
                                            if (currentIndex < rows.length - 1) {
                                                rows[currentIndex + 1].focus();
                                            }
                                            break;
                                        case 'ArrowUp':
                                            e.preventDefault();
                                            if (currentIndex > 0) {
                                                rows[currentIndex - 1].focus();
                                            }
                                            break;
                                        case 'Home':
                                            e.preventDefault();
                                            rows[0]?.focus();
                                            break;
                                        case 'End':
                                            e.preventDefault();
                                            rows[rows.length - 1]?.focus();
                                            break;
                                        case 'Tab':
                                            // å…è¨± Tab é›¢é–‹è¡¨æ ¼
                                            break;
                                        default:
                                            return;
                                    }
                                });

                                // ç‚ºæ¯ä¸€è¡Œæ·»åŠ  tabindex
                                newTbody.querySelectorAll('tr').forEach((row, index) => {
                                    row.setAttribute('tabindex', '0');
                                    row.setAttribute('aria-rowindex', String(index + 2)); // +2 å› ç‚º header æ˜¯ row 1
                                });
                            });
                        }, 200); // å¢åŠ å»¶é²ç¢ºä¿ DOM æ›´æ–°å®Œæˆ
                    }
                });

                console.log('âŒ¨ï¸ éµç›¤å°èˆªå·²å•Ÿç”¨ï¼šä½¿ç”¨ Tab/æ–¹å‘éµç€è¦½');
            },

            startAutoLangSwitch() {
                if (this.STATE.autoSwitchTimer) clearInterval(this.STATE.autoSwitchTimer);
                this.STATE.autoSwitchTimer = setInterval(() => {
                    toggleLanguage(true);
                }, this.CONFIG.INTERVALS.LANG_SWITCH);
                console.log('\u2705 \u81ea\u52d5\u8a9e\u8a00\u5207\u63db\u5df2\u555f\u52d5 (\u6bcf 80 \u79d2)');
            },

            updateClock() {
                const now = new Date();
                UI_Helper.setText('unifiedTime', now.toLocaleTimeString('en-GB'));
                UI_Helper.setText('unifiedDate', now.toISOString().split('T')[0].replace(/-/g, '/'));
            },

            async updatePids() {
                // ğŸ”¥ å–æ¶ˆä¸Šä¸€æ¬¡è«‹æ±‚ï¼Œé˜²æ­¢ Race Condition
                if (this._currentFetchController) {
                    this._currentFetchController.abort();
                    console.log('âš ï¸ å·²å–æ¶ˆä¸Šä¸€æ¬¡è«‹æ±‚');
                }

                this._currentFetchController = new AbortController();
                const signal = this._currentFetchController.signal;

                try {
                    const url = `${this.CONFIG.API_BASE}/api/liveboard/station?station=${this.STATE.stationID}`;
                    const response = await fetch(url, {
                        signal,
                        // æ·»åŠ è¶…æ™‚ä¿è­·
                        timeout: 15000
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    const now = new Date();
                    const currentHours = now.getHours();
                    const currentMins = now.getMinutes();
                    const nowTotalMinutes = currentHours * 60 + currentMins;

                    let filtered = data.filter(t => {
                        const [h, m] = (t.ScheduledDepartureTime || "00:00").split(':').map(Number);
                        const schedMins = h * 60 + m;
                        const delayMins = parseInt(t.DelayTime || 0);
                        const actualMins = schedMins + delayMins;
                        const isCancelled = String(t.TrainStatus) === '2';
                        return actualMins >= nowTotalMinutes || isCancelled;
                    });

                    filtered.forEach(t => {
                        let [h, m] = (t.ScheduledDepartureTime || "00:00").split(':').map(Number);
                        let delayMins = parseInt(t.DelayTime || 0);
                        let actualMins = (h * 60 + m) + delayMins;
                        t._sort = actualMins % 1440;
                    });
                    filtered.sort((a, b) => a._sort - b._sort);

                    this.STATE.lastTrainData = filtered;
                    refreshDisplay();

                } catch (error) {
                    // å¿½ç•¥è¢«å–æ¶ˆçš„è«‹æ±‚ï¼ˆæ­£å¸¸è¡Œç‚ºï¼‰
                    if (error.name === 'AbortError') {
                        console.log('ğŸ”„ è«‹æ±‚å·²è¢«æ–°è«‹æ±‚å–ä»£');
                        return;
                    }

                    console.error("âŒ PIDS æ›´æ–°å¤±æ•—:", error);
                    UI_Helper.showErrorOverlay('åˆ—è»Šè³‡è¨Šå‚³è¼¸æš«æ™‚ä¸­æ–·ï¼Œè«‹ä»¥è»Šç«™ç¾å ´è³‡è¨Šç‚ºä¸»ã€‚');
                    renderTable('1', []);
                    renderTable('0', []);
                } finally {
                    this._currentFetchController = null;
                }
            },

            async checkTopMarquee() {
                try {
                    let url = `${this.CONFIG.API_BASE}/api/pids/marquee`;
                    if (this.STATE.stationID) url += `?station=${this.STATE.stationID}`;

                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Marquee fetch failed');

                    const data = await response.json();
                    const el = document.getElementById('unifiedTopMarquee');

                    if (data.text !== undefined && data.text !== null) {
                        let cleanText = data.text
                            .replace(/<[^>]*>/g, "") // å¼·åˆ¶ç§»é™¤æ‰€æœ‰ HTML æ¨™ç±¤
                            .replace(/\\n/g, "     ")
                            .replace(/[\r\n]+/g, "     ")
                            .replace(/\s{2,}/g, "     ") // åˆä½µå¤šé¤˜ç©ºç™½
                            .replace(/&nbsp;/g, " ")
                            .replace(/&amp;/g, "&")
                            .trim();

                        if (el && el.innerHTML !== cleanText) {
                            el.innerHTML = cleanText;
                            startMarquee('unifiedTopMarquee');
                        }
                    }
                } catch (error) {
                    console.warn("âš ï¸ è·‘é¦¬ç‡ˆè¼‰å…¥å¤±æ•—:", error);
                }
            }
        };

        // ============ UI å®‰å…¨å·¥å…·ï¼ˆé˜² XSSï¼‰ ============
        const UI_Helper = {
            escape: (str) => {
                if (!str) return "";
                return String(str).replace(/[&<>"']/g, m => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                })[m]);
            },

            setText: (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text || '';
            },

            showErrorOverlay: (message) => {
                console.error('ğŸš¨ PIDS Data Error:', message);

                // ğŸ¯ ç²¾æº–é–å®šä¸­å¤®è¡¨æ ¼å€åŸŸ
                const pidsSection = document.querySelector('.pids-section');
                if (!pidsSection || document.getElementById('pids-data-error')) return;

                // ç¢ºä¿çˆ¶å®¹å™¨æœ‰ç›¸å°å®šä½ï¼Œä»¥ä¾¿è“‹å­ç²¾æº–å°é½Š
                pidsSection.style.position = 'relative';

                const errorHTML = `
                    <div id="pids-data-error" style="
                        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                        background: linear-gradient(135deg, #b71c1c 0%, #880e4f 100%);
                        color: white; z-index: 2000; border-radius: 8px;
                        display: flex; flex-direction: column; justify-content: center; align-items: center;
                        border: 4px solid #ffeb3b; box-sizing: border-box;
                        animation: fadeIn 0.3s ease-in;
                    ">
                        <i class="fas fa-exclamation-triangle" style="font-size: 8rem; margin-bottom: 20px; color: #ffeb3b;"></i>
                        
                        <div style="text-align: center; padding: 0 40px;">
                            <h2 style="font-size: 4rem; font-weight: 900; margin-bottom: 15px; text-shadow: 2px 2px 10px rgba(0,0,0,0.5);">
                                åˆ—è»Šè³‡è¨Šæš«æ™‚ä¸­æ–·
                            </h2>
                            <p style="font-size: 2.2rem; font-weight: 500; opacity: 0.9; line-height: 1.4;">
                                ${UI_Helper.escape(message)}<br>
                                <span style="background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 5px; margin-top: 15px; display: inline-block;">
                                    è«‹åƒè€ƒè»Šç«™æœˆå°å»£æ’­æˆ–ç¾å ´å¯¦é«”çœ‹æ¿
                                </span>
                            </p>
                        </div>

                        <style>
                            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                        </style>
                    </div>
                `;

                // å°‡éŒ¯èª¤é®ç½©æ’å…¥åˆ°è¡¨æ ¼å€åŸŸä¸­
                pidsSection.insertAdjacentHTML('beforeend', errorHTML);

                // ğŸ¨ åŒæ­¥æŠŠå…©å€‹ Column çš„å…§å®¹è®Šæš—+æ¨¡ç³Šï¼Œç¢ºä¿è¦–è¦ºæ•´æ½”
                document.querySelectorAll('.pids-column').forEach(col => {
                    col.style.opacity = '0.3';
                    col.style.filter = 'blur(2px)';
                    col.style.transition = 'all 0.3s ease';
                });
            }
        };

        // --- èªè¨€å­—å…¸ ---
        const i18n = {
            zh: {
                inbound: "é€†è¡Œ", outbound: "é †è¡Œ",
                trainNo: "è»Šæ¬¡", type: "è»Šç¨®", dest: "é–‹å¾€", time: "å¯¦éš›é–‹è»Šæ™‚é–“", status: "ç‹€æ…‹",
                onTime: "æº–é»", delay: "æ™š {min} åˆ†", cancelled: "åœé§›",
                toward: "å¾€", curPos: "åˆ—è»Šç›®å‰ä½ç½®ï¼š", nextPos: " â¡ ", expected: "æœ¬ç«™é è¨ˆï¼š", arrive: " æŠµé”",
                adv: "å®£å°è³‡è¨Š", video: "å½±éŸ³å°ˆå€", noTrain: "ç›®å‰ç„¡åˆ—è»Šè³‡è¨Š",
                notDeparted: "åˆ—è»Šå°šæœªç™¼è»Š", detecting: "åˆ—è»Šè¨Šè™Ÿåµæ¸¬ä¸­",
                types: {
                    "æ–°è‡ªå¼·": "æ–°è‡ªå¼·", "è‡ªå¼·": "è‡ªå¼·", "æ™®æ‚ ç‘ª": "æ™®æ‚ ç‘ª",
                    "å¤ªé­¯é–£": "å¤ªé­¯é–£", "è’å…‰": "è’å…‰", "å€é–“å¿«": "å€é–“å¿«", "å€é–“": "å€é–“", "å°ˆè»Š": "å°ˆè»Š", "å…¶ä»–": "åˆ—è»Š"
                }
            },
            en: {
                inbound: "Northbound", outbound: "Southbound",
                trainNo: "Train No.", type: "Type", dest: "Destination", time: "Departure", status: "Status",
                onTime: "On Time", delay: "{min} Min Late", cancelled: "Cancelled",
                toward: "To ", curPos: "Current Location: ", nextPos: " â¡ ", expected: "ETA at Station: ", arrive: "",
                adv: "Information", video: "Media Center", noTrain: "No Train Information",
                notDeparted: "Not Yet Departed", detecting: "Signal Detecting",
                types: {
                    "æ–°è‡ªå¼·": "New T.C.", "è‡ªå¼·": "T.C.", "æ™®æ‚ ç‘ª": "Puyuma",
                    "å¤ªé­¯é–£": "Taroko", "è’å…‰": "C.K.", "å€é–“å¿«": "Fast Local", "å€é–“": "Local", "å°ˆè»Š": "Special Train", "å…¶ä»–": "Train"
                },
                notes: {
                    "æ¯æ—¥è¡Œé§›": "Daily",
                    "é€¢é€±äº”è‡³æ—¥è¡Œé§›": "Fri-Sun Only",
                    "é€¢é€±å…­ã€æ—¥è¡Œé§›": "Sat & Sun Only",
                    "é€¢é€±å…­æ—¥è¡Œé§›": "Weekends Only",
                    "åœ¨å½°åŒ–è·¨ç·š": "Via Changhua",
                    "è·¨ç·šåˆ—è»Š": "Cross-line",
                    "æœ¬è»Šæ¬¡ä¸ç™¼å”®ç„¡åº§ç¥¨": "Reserved Only",
                    "åƒ…åœé å¤§ç«™": "Major Stops Only",
                    "ä¸åœé éƒ¨åˆ†å°ç«™": "Express Service"
                }
            }
        };

        // ============ å‘å¾Œå…¼å®¹å±¤ï¼ˆBackward Compatibility Layerï¼‰ ============
        // é€™äº›è®Šæ•¸å’Œå‡½æ•¸ä¿æŒèˆ‡èˆŠä»£ç¢¼çš„å…¼å®¹æ€§ï¼Œä½†å…§éƒ¨ä½¿ç”¨æ–°æ¶æ§‹
        let currentLang = PIDS_APP.STATE.currentLang;
        let lastTrainData = PIDS_APP.STATE.lastTrainData;
        let autoSwitchTimer = PIDS_APP.STATE.autoSwitchTimer;
        let isVideoLoaded = PIDS_APP.STATE.isVideoLoaded;
        const SWITCH_INTERVAL = PIDS_APP.CONFIG.INTERVALS.LANG_SWITCH;

        const TRA_WORKER_URL = PIDS_APP.CONFIG.API_BASE;
        let GLOBAL_STATION_ID = "";
        const MAX_ROWS = PIDS_APP.CONFIG.ROWS.DESKTOP;
        const RWD_MAX_ROWS = PIDS_APP.CONFIG.ROWS.MOBILE;

        const TRAIN_TYPES = PIDS_APP.CONFIG.TRAIN_TYPES;
        const stopsCache = PIDS_APP.STATE.stopsCache;

        // åŒ…è£å‡½æ•¸ - ä½¿ç”¨æ–°æ¶æ§‹ä½†ä¿æŒèˆŠ API
        function updateClock() { PIDS_APP.updateClock(); }
        function updatePids(id) {
            PIDS_APP.STATE.stationID = id;
            return PIDS_APP.updatePids();
        }
        function checkTopMarquee() { return PIDS_APP.checkTopMarquee(); }

        // å¸¸ç”¨è»Šç«™è‹±è­¯å­—å…¸ (ä½œç‚ºå‚™æ´ï¼Œç¢ºä¿ 100% æœ‰è‹±æ–‡)
        const stationEnMap = {
            "åŸºéš†": "Keelung", "ä¸ƒå µ": "Qidu", "å—æ¸¯": "Nangang", "æ¾å±±": "Songshan", "è‡ºåŒ—": "Taipei",
            "å°åŒ—": "Taipei", "æ¿æ©‹": "Banqiao", "æ¨¹æ—": "Shulin", "æ¡ƒåœ’": "Taoyuan", "ä¸­å£¢": "Zhongli",
            "æ–°ç«¹": "Hsinchu", "ç«¹å—": "Zhunan", "è‹—æ —": "Miaoli", "è±åŸ": "Fengyuan", "è‡ºä¸­": "Taichung",
            "å°ä¸­": "Taichung", "å½°åŒ–": "Changhua", "å“¡æ—": "Yuanlin", "æ–—å…­": "Douliu", "å˜‰ç¾©": "Chiayi",
            "æ–°ç‡Ÿ": "Xinying", "è‡ºå—": "Tainan", "å°å—": "Tainan", "å²¡å±±": "Gangshan", "æ–°å·¦ç‡Ÿ": "Xinzuoying",
            "å·¦ç‡Ÿ": "Zuoying", "é«˜é›„": "Kaohsiung", "å±æ±": "Pingtung", "æ½®å·": "Chaozhou", "æ‹å¯®": "Fangliao",
            "è‡ºæ±": "Taitung", "å°æ±": "Taitung", "ç‰é‡Œ": "Yuli", "èŠ±è“®": "Hualien", "è˜‡æ¾³æ–°": "Su'aoxin",
            "è˜‡æ¾³": "Su'ao", "å®œè˜­": "Yilan", "ç¾…æ±": "Luodong", "ç‘èŠ³": "Ruifang", "ç¦éš†": "Fulong",
            "å…«å µ": "Badu", "æ±æ­¢": "Xizhi", "è¬è¯": "Wanhua", "é¶¯æ­Œ": "Yingge", "æ¥Šæ¢…": "Yangmei",
            "æ¹–å£": "Hukou", "ç«¹åŒ—": "Zhubei", "é¦™å±±": "Xiangshan", "å´é ‚": "Qiding", "è«‡æ–‡": "Tanwen",
            "å¤§ç”²": "Dajia", "æ¸…æ°´": "Qingshui", "æ²™é¹¿": "Shalu", "é¾äº•": "Longjing", "å¤§è‚š": "Dadu",
            "è¿½åˆ†": "Zhuifen", "çƒæ—¥": "Wuri", "æˆåŠŸ": "Chenggong", "ç”°ä¸­": "Tianzhong", "äºŒæ°´": "Ershui",
            "æ—å…§": "Linnei", "æ–—å—": "Dounan", "çŸ³æ¦´": "Shiliu", "å¤§æ—": "Dalin", "æ°‘é›„": "Minxiong",
            "æ°´ä¸Š": "Shuishang", "å—é–": "Nanjing", "å¾Œå£": "Houbi", "æ—é³³ç‡Ÿ": "Linfengying", "éš†ç”°": "Longtian",
            "æ‹”æ—": "Balin", "å–„åŒ–": "Shanhua", "æ°¸åº·": "Yongkang", "å¤§æ©‹": "Daqiao", "ä¿å®‰": "Baoan",
            "ä¸­æ´²": "Zhongzhou", "æ©‹é ­": "Qiaotou", "æ¥ æ¢“": "Nanzi", "æ–°å·¦ç‡Ÿ": "Xinzuoying", "é³³å±±": "Fengshan",
            "å¾Œåº„": "Houzhuang", "ä¹æ›²å ‚": "Jiuqutang", "å…­å¡Šå": "Liukuaicuo", "æ­¸ä¾†": "Guilai", "éºŸæ´›": "Linluo",
            "è¥¿å‹¢": "Xishi", "ç«¹ç”°": "Zhutian", "å…§ç…": "Neishi", "æ‹å±±": "Fangshan", "åŠ ç¥¿": "Jialu",
            "å¤ªéº»é‡Œ": "Taimali", "çŸ¥æœ¬": "Zhiben", "åº·æ¨‚": "Kangle", "é¹¿é‡": "Luye", "ç‘å’Œ": "Ruihe",
            "ç‘ç©—": "Ruisui", "å…‰å¾©": "Guangfu", "è¬æ¦®": "Wanrong", "é³³æ—": "Fenglin", "å—å¹³": "Nanping",
            "å£½è±": "Shoufeng", "å¿—å­¸": "Zhixue", "å¹³å’Œ": "Pinghe", "æ–°åŸ": "Xincheng", "æ™¯ç¾": "Jingmei",
            "å’Œå¹³": "Heping", "å’Œä»": "Heren", "å´‡å¾·": "Chongde", "å—æ¾³": "Nan'ao", "æ±æ¾³": "Dong'ao",
            "æ°¸æ¨‚": "Yongle", "è˜‡æ¾³æ–°ç«™": "Su'aoxin", "å†¬å±±": "Dongshan", "ä¸‰è²‚å¶º": "Sandiaolin", "ç‰¡ä¸¹": "Mudan",
            "é›™æºª": "Shuangxi", "è²¢å¯®": "Gongliao", "æµ·å±±": "Mountain Line", "å±±ç·š": "Mountain Line", "æµ·ç·š": "Coast Line"
        };

        // ç¿»è­¯è»Šç«™åç¨±çš„å‡½å¼
        function translateStation(zhName) {
            // âœ… ä½¿ç”¨ PIDS_APP.STATE.currentLang
            if (PIDS_APP.STATE.currentLang === 'zh') return zhName;

            // ç§»é™¤æ‹¬è™Ÿå…§çš„æ–‡å­— (å¦‚ å±±ã€æµ·) ç¨ç«‹ç¿»è­¯
            let cleanName = zhName.replace(/\s*\(å±±\)/g, "").replace(/\s*\(æµ·\)/g, "").replace(/è»Šç«™$/g, "").trim();
            let suffix = "";
            if (zhName.includes("(å±±)")) suffix = " (MT)";
            if (zhName.includes("(æµ·)")) suffix = " (CO)";

            // å…ˆæ‰¾ stationDataMap (å¦‚æœä½ å¼•å…¥çš„ mapping.js æœ‰è³‡æ–™)
            if (typeof stationDataMap !== 'undefined') {
                for (let code in stationDataMap) {
                    if (stationDataMap[code].name === cleanName || stationDataMap[code].name === cleanName + "ç«™") {
                        return stationDataMap[code].ename.split('_')[0] + suffix;
                    }
                }
            }

            // å†æ‰¾æ‰‹å‹•å­—å…¸
            return (stationEnMap[cleanName] || cleanName) + suffix;
        }

        // ç¿»è­¯å‚™è¨»çš„å‡½å¼
        function translateNote(note) {
            // âœ… ä½¿ç”¨ PIDS_APP.STATE.currentLang
            if (PIDS_APP.STATE.currentLang === 'zh' || !note || note.trim() === '') return note;
            const lang = i18n[PIDS_APP.STATE.currentLang];
            // æª¢æŸ¥æ˜¯å¦æœ‰é è¨­ç¿»è­¯ï¼Œå¦å‰‡å›å‚³åŸå­—
            return lang.notes?.[note.trim()] || note;
        }

        // --- èªè¨€åˆ‡æ›åŠŸèƒ½ ---
        function toggleLanguage(isAuto = false) {
            // âœ… ç›´æ¥æ”¹ STATEï¼Œé€™æœƒè§¸ç™¼ Proxy æ”å–å™¨ï¼Œé€²è€ŒåŸ·è¡Œ refreshDisplay()
            PIDS_APP.STATE.currentLang = PIDS_APP.STATE.currentLang === 'zh' ? 'en' : 'zh';
            localStorage.setItem('pids_lang', PIDS_APP.STATE.currentLang);

            console.log(`[èªè¨€åˆ‡æ›] ç›®å‰èªè¨€: ${PIDS_APP.STATE.currentLang.toUpperCase()} ${isAuto ? '(è‡ªå‹•)' : '(æ‰‹å‹•)'}`);

            // æ›´æ–°æ¨™é¡Œèˆ‡éœæ…‹æ–‡å­—
            PIDS_APP.ui.updateUIStrings();

            // å¦‚æœæ˜¯æ‰‹å‹•é»æ“Šï¼Œé‡è¨­è¨ˆæ™‚å™¨
            if (!isAuto) {
                PIDS_APP.startAutoLangSwitch(); // ä½¿ç”¨ PIDS_APP çš„æ–¹æ³•
            }
        }

        function startAutoSwitch() {
            if (autoSwitchTimer) clearInterval(autoSwitchTimer);
            autoSwitchTimer = setInterval(() => {
                toggleLanguage(true);
            }, SWITCH_INTERVAL);
        }

        function updateUIStrings() {
            // âœ… ä½¿ç”¨ PIDS_APP.STATE.currentLang
            const lang = i18n[PIDS_APP.STATE.currentLang];

            // æ›´æ–°æ–¹å‘æ¨™é¡Œ
            const dir1Title = document.getElementById('dirTitle1');
            const dir0Title = document.getElementById('dirTitle0');
            if (dir1Title) dir1Title.innerText = lang.inbound;
            if (dir0Title) dir0Title.innerText = lang.outbound;

            // æ›´æ–°è¡¨é ­
            const headHtml = `
                <tr>
                    <th style="width:15%">${lang.trainNo}</th>
                    <th style="width:20%">${lang.type}</th>
                    <th style="width:28%">${lang.dest}</th>
                    <th style="width:20%">${lang.time}</th>
                    <th style="width:17%">${lang.status}</th>
                </tr>`;

            const table1Head = document.querySelector('.table-1 thead');
            const table0Head = document.querySelector('.table-0 thead');
            if (table1Head) table1Head.innerHTML = headHtml;
            if (table0Head) table0Head.innerHTML = headHtml;
        }

        function updateEnglishStationName(stationID) {
            const enElement = document.getElementById('station-en');
            if (enElement && typeof stationDataMap !== 'undefined' && stationDataMap[stationID]) {
                const rawName = stationDataMap[stationID].ename;
                const formattedName = rawName.split('_')[0].toUpperCase();
                enElement.innerText = `${formattedName} STATION`;
            } else {
                enElement.innerText = "TRA STATION";
            }
        }

        function getInfo(t) {
            // ğŸ”¥ ä¿®æ­£: å¢å¼·åç¨±åˆ¤æ–·ï¼Œæ”¯æ´ç‰©ä»¶å‹èˆ‡å­—ä¸²å‹ TrainTypeNameï¼Œä¸¦è£œä¸Š missing ID çš„é˜²è­·
            let rawName = t.TrainTypeName?.Zh_tw || t.TrainTypeName || '';
            let name = String(TRAIN_TYPES[t.TrainTypeID] || rawName || 'åˆ—è»Š');
            let cls = 'å…¶ä»–';

            if (name.includes('æ–°è‡ªå¼·') || name.includes('3000')) {
                name = 'æ–°è‡ªå¼·';
                cls = 'æ–°è‡ªå¼·';
            }
            else if (name.includes('è‡ªå¼·') || name.includes('æ¨æ‹‰å¼è‡ªå¼·')) {
                name = 'è‡ªå¼·';
                cls = 'è‡ªå¼·';
            }
            else if (name.includes('æ™®æ‚ ç‘ª')) { cls = 'æ™®æ‚ ç‘ª'; }
            else if (name.includes('å¤ªé­¯é–£')) { cls = 'å¤ªé­¯é–£'; }
            else if (name.includes('è’å…‰')) { cls = 'è’å…‰'; }
            else if (name.includes('å€é–“å¿«')) { cls = 'å€é–“å¿«'; }
            else if (name.includes('å€é–“')) { cls = 'å€é–“'; }
            else if (name.includes('å°ˆè»Š')) { cls = 'å°ˆè»Š'; }
            else if (name === 'åˆ—è»Š') {
                cls = 'å€é–“';
            }

            // å¤šèªè¨€æ”¯æ´
            // âœ… ä½¿ç”¨ PIDS_APP.STATE.currentLang
            const lang = i18n[PIDS_APP.STATE.currentLang];
            const displayName = lang.types[cls] || name;

            return { name: displayName, cls };
        }

        async function fetchTrainStops(trainNo) {
            if (stopsCache[trainNo]) return stopsCache[trainNo];

            // ğŸ”¥ æ–°å¢ï¼š15ç§’è¶…æ™‚ä¿è­·
            const abortController = new AbortController();
            const timeoutId = setTimeout(() => {
                abortController.abort();
                console.warn(`âš ï¸ [${trainNo}] è«‹æ±‚è¶…æ™‚ï¼Œå·²å–æ¶ˆ`);
            }, 15000);

            try {
                // å˜—è©¦æ–¹æ¡ˆ 1: å¾ Worker çš„ /api/schedule å–å¾—
                let r = await fetch(`${TRA_WORKER_URL}/api/schedule?trainNo=${trainNo}`, {
                    signal: abortController.signal
                });
                clearTimeout(timeoutId);
                let d = await r.json();
                console.log(`[${trainNo}] Worker /api/schedule çµæœ:`, d);
                if (Array.isArray(d) && d.length && d[0].StopTimes) {
                    console.log(`âœ… [${trainNo}] å–å¾— ${d[0].StopTimes.length} ç­†åœé ç«™ (Worker é™£åˆ—)`);
                    stopsCache[trainNo] = d[0].StopTimes;
                    return d[0].StopTimes;
                }
                if (d && d.StopTimes) {
                    console.log(`âœ… [${trainNo}] å–å¾— ${d.StopTimes.length} ç­†åœé ç«™ (Worker ç›´æ¥)`);
                    stopsCache[trainNo] = d.StopTimes;
                    return d.StopTimes;
                }
            } catch (e) {
                clearTimeout(timeoutId);
                if (e.name === 'AbortError') {
                    console.warn(`âš ï¸ [${trainNo}] Worker API è¶…æ™‚`);
                } else {
                    console.warn(`[${trainNo}] Worker API å¤±æ•—:`, e);
                }
            }

            try {
                // å˜—è©¦æ–¹æ¡ˆ 2: ç›´æ¥å¾ TDX V3 å–å¾—
                const abortController2 = new AbortController();
                const timeoutId2 = setTimeout(() => abortController2.abort(), 15000);

                let r = await fetch(`https://tdx.transportdata.tw/api/basic/v3/Rail/TRA/DailyTrainTimetable/Today?$filter=TrainInfo/TrainNo eq '${trainNo}'&$format=JSON`, {
                    signal: abortController2.signal
                });
                clearTimeout(timeoutId2);
                let d = await r.json();
                console.log(`[${trainNo}] TDX V3 çµæœ:`, d);
                if (d?.value?.[0]?.StopTimes) {
                    console.log(`âœ… [${trainNo}] å–å¾— ${d.value[0].StopTimes.length} ç­†åœé ç«™ (TDX V3)`);
                    stopsCache[trainNo] = d.value[0].StopTimes;
                    return d.value[0].StopTimes;
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    console.warn(`âš ï¸ [${trainNo}] TDX V3 API è¶…æ™‚`);
                } else {
                    console.warn(`[${trainNo}] TDX V3 API å¤±æ•—:`, e);
                }
            }

            console.error(`âŒ [${trainNo}] ç„¡æ³•å¾ä»»ä½•ä¾†æºå–å¾—åœé ç«™è³‡æ–™`);
            return [];
        }

        function getExpectedTime(timeStr, delayMins) {
            if (!timeStr || delayMins === 0) return timeStr;
            const [h, m] = timeStr.split(':').map(Number);
            const total = h * 60 + m + delayMins;
            const newH = Math.floor(total / 60) % 24;
            const newM = total % 60;
            return `${String(newH).padStart(2, '0')}:${String(newM).padStart(2, '0')}`;
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('unifiedTime').innerText = now.toLocaleTimeString('en-GB');
            document.getElementById('unifiedDate').innerText = now.toISOString().split('T')[0].replace(/-/g, '/');
        }
        setInterval(updateClock, 1000);

        async function updateMediaAssets() {
            try {
                const res = await fetch(`${TRA_WORKER_URL}/api/pids/assets`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.images && data.images.length > 0) setupCarousel(data.images);

                    // é¿å…èªè¨€åˆ‡æ›æ™‚é‡è¤‡è¼‰å…¥å½±ç‰‡ï¼ˆæœƒå°è‡´å½±ç‰‡é‡æ–°é–‹å§‹ï¼‰
                    if (!isVideoLoaded) {
                        const videos = Array.isArray(data.video) ? data.video : (data.video ? [data.video] : []);
                        setupVideo(videos); // å‚³ç©ºé™£åˆ—ä¹Ÿé¡¯ç¤º placeholderï¼Œä¸å†å¡ä½
                        isVideoLoaded = true;
                    }
                } else {
                    // API å›æ‡‰é 2xxï¼Œä»åˆå§‹åŒ–å½±ç‰‡å€ï¼ˆé¡¯ç¤º placeholderï¼‰
                    if (!isVideoLoaded) { setupVideo([]); isVideoLoaded = true; }
                }
            } catch (e) {
                console.warn("Media Load Error", e);
                // ç¶²è·¯éŒ¯èª¤æ™‚ä¹Ÿåˆå§‹åŒ–å½±ç‰‡å€ï¼Œé¿å…å…¨ç©ºç™½
                if (!isVideoLoaded) { setupVideo([]); isVideoLoaded = true; }
            }
        }

        let carTimer;
        function setupCarousel(imgs) {
            const box = document.getElementById('carouselBox');
            box.querySelectorAll('img').forEach(i => i.remove());
            imgs.forEach((src, i) => {
                const img = document.createElement('img');
                img.src = src; img.className = i === 0 ? 'carousel-img active' : 'carousel-img';
                box.appendChild(img);
            });
            let idx = 0;
            if (carTimer) clearInterval(carTimer);
            carTimer = setInterval(() => {
                const list = box.querySelectorAll('img');
                if (list.length > 1) {
                    list[idx].classList.remove('active');
                    idx = (idx + 1) % list.length;
                    list[idx].classList.add('active');
                }
            }, 10000);
        }

        // å½±ç‰‡æ’­æ”¾ç‹€æ…‹
        let _videoIds = [];
        let _videoIdx = 0;
        let _videoRetryTimer = null;

        function setupVideo(urls) {
            const con = document.getElementById('videoContainer');
            _videoIds = [];

            // å¼·åŒ–çš„ YouTube ID æ“·å–é‚è¼¯ (æ”¯æ´ Shorts, æ‰‹æ©Ÿç‰ˆé€£çµ)
            urls.forEach(url => {
                const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]{11}).*/;
                const match = url.match(regExp);
                if (match && match[2].length === 11) {
                    _videoIds.push(match[2]);
                }
            });

            if (_videoIds.length > 0) {
                // å¾ç¬¬ä¸€éƒ¨é–‹å§‹é †åºæ’­æ”¾
                _videoIdx = 0;
                _playVideoAt(_videoIdx);
            } else if (urls.length > 0 && typeof urls[0] === 'string' && !urls[0].includes('youtube')) {
                // åŸç”Ÿå½±ç‰‡æª”æ¡ˆ (.mp4)
                con.innerHTML = `<video src="${urls[0]}" autoplay muted loop playsinline style="width:100%;height:100%;object-fit:contain;"></video>`;
                console.log(`âœ… æœ¬åœ°å½±ç‰‡å·²è¼‰å…¥: ${urls[0]}`);
            } else {
                con.innerHTML = `<div style="padding:20px; color:#666; text-align:center; font-size:1.2rem;">ğŸ“¹ æš«ç„¡å½±éŸ³å…§å®¹</div>`;
            }
        }

        function _playVideoAt(idx) {
            const con = document.getElementById('videoContainer');
            if (!con || _videoIds.length === 0) return;

            // å¾ idx é–‹å§‹ï¼ŒæŠŠæ¸…å–®é‡æ’ï¼ˆidx å¾Œé¢çš„ + idx å‰é¢çš„ï¼‰ï¼Œè®“ YouTube å¾é€™éƒ¨é–‹å§‹é †åºæ’­
            const ordered = [..._videoIds.slice(idx), ..._videoIds.slice(0, idx)];
            const first = ordered[0];
            const playlist = ordered.join(',');
            const originParam = location.protocol.startsWith('http')
                ? `&origin=${location.origin}` : '';

            con.innerHTML = `
                <iframe
                    id="ytFrame"
                    class="video-iframe"
                    src="https://www.youtube.com/embed/${first}?autoplay=1&mute=1&loop=1&playlist=${playlist}&controls=0&rel=0&enablejsapi=1${originParam}"
                    allow="autoplay; fullscreen; encrypted-media; picture-in-picture"
                    allowfullscreen
                    style="width:100%; height:100%; border:none;">
                </iframe>`;
            console.log(`â–¶ï¸ å¾ç¬¬ [${idx + 1}/${_videoIds.length}] éƒ¨é–‹å§‹æ’­æ”¾ï¼Œæ¸…å–®å…± ${_videoIds.length} éƒ¨`);

            if (_videoRetryTimer) clearTimeout(_videoRetryTimer);

            // iframe è¼‰å…¥å®Œæˆå³å–æ¶ˆè·³éè¨ˆæ™‚å™¨
            const frame = document.getElementById('ytFrame');
            let hasLoaded = false;
            if (frame) {
                frame.addEventListener('load', () => {
                    hasLoaded = true;
                    clearTimeout(_videoRetryTimer);
                }, { once: true });
            }

            // é€¾æ™‚ä¿è­·ï¼š20 ç§’å…§ iframe å®Œå…¨æ²’è¼‰å…¥æ‰è·³éï¼ˆå½±ç‰‡è¢«å°é–æ™‚ï¼‰
            _videoRetryTimer = setTimeout(() => {
                if (!hasLoaded && _videoIds.length > 1) {
                    console.warn(`âš ï¸ å½±ç‰‡ ${first} ç„¡æ³•è¼‰å…¥ï¼Œè·³é`);
                    _advanceVideo();
                }
            }, 20000);
        }

        function _advanceVideo() {
            _videoIdx = (_videoIdx + 1) % _videoIds.length;
            _playVideoAt(_videoIdx);
        }

        function startMarquee(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const container = el.parentElement;

            // æ¸…é™¤èˆŠçš„ç›£è½èˆ‡ç‹€æ…‹
            el.ontransitionend = null;
            el.style.transition = 'none';

            // è®“ç€è¦½å™¨æœ‰æ™‚é–“æ¸²æŸ“æ–‡å­—å¾Œå†å–å¯¬åº¦
            setTimeout(() => {
                const textWidth = el.scrollWidth;
                const containerWidth = container.clientWidth;

                // èµ·å§‹ä½ç½®ï¼šå®¹å™¨æœ€å³é‚Š
                el.style.left = containerWidth + 'px';

                // è¨ˆç®—é€Ÿåº¦ï¼šè¨­å®šæ¯åƒç´ è·‘å¤šå°‘ç§’ (æ•¸å€¼è¶Šå°è¶Šå¿«)
                // é›»è…¦ç‰ˆè¶…åŠ é€Ÿã€æ‰‹æ©Ÿç‰ˆæ­£å¸¸é€Ÿåº¦
                const isMobileScreen = window.innerWidth <= 900;
                let speed;
                if (id === 'unifiedTopMarquee') {
                    speed = isMobileScreen ? 0.010 : 0.006;  // é›»è…¦ç‰ˆå…¬å‘Šè¶…åŠ é€Ÿ
                } else {
                    speed = isMobileScreen ? 0.008 : 0.006;  // åˆ—è»Šè³‡æ–™ç¶­æŒ
                }
                const duration = Math.max(10, (textWidth + containerWidth) * speed);

                // å¼·åˆ¶é‡ç¹ª
                void el.offsetWidth;

                // é–‹å§‹å‹•ç•«ï¼šä½ç§»åˆ°æ–‡å­—å¯¬åº¦çš„è² å€¼ï¼ˆç¢ºä¿å®Œå…¨æ¶ˆå¤±ï¼‰
                el.style.transition = `left ${duration}s linear`;
                el.style.left = `-${textWidth}px`;

                // çµæŸå¾Œé‡å•Ÿ
                el.ontransitionend = () => {
                    startMarquee(id);
                };
            }, 100);
        }

        async function updatePids(id) {
            try {
                let r = await fetch(`${TRA_WORKER_URL}/api/liveboard/station?station=${id}`);
                let d = await r.json();

                // ğŸ”¥ æ–°å¢ï¼šç¯©é¸å·²é–‹å‡ºçš„åˆ—è»Š (é è¨ˆç™¼è»Šæ™‚é–“ < ç¾åœ¨æ™‚é–“)
                const now = new Date();
                const currentHours = now.getHours();
                const currentMins = now.getMinutes();
                const nowTotalMinutes = currentHours * 60 + currentMins;

                let filtered = d.filter(t => {
                    const [h, m] = (t.ScheduledDepartureTime || "00:00").split(':').map(Number);
                    const schedMins = h * 60 + m;
                    const delayMins = parseInt(t.DelayTime || 0);
                    const actualMins = schedMins + delayMins;

                    // åœé§›åˆ—è»Šä¿ç•™ï¼Œæœªä¾†ç­æ¬¡ä¹Ÿä¿ç•™
                    const isCancelled = String(t.TrainStatus) === '2';
                    const shouldShow = actualMins >= nowTotalMinutes || isCancelled;

                    console.log(`[${t.TrainNo}] ${t.ScheduledDepartureTime} å¯¦éš›=${actualMins}åˆ† ç¾åœ¨=${nowTotalMinutes}åˆ† åœé§›=${isCancelled} é¡¯ç¤º=${shouldShow}`);
                    return shouldShow;
                });

                // ğŸ”¥ ä¿®æ­£: æŒ‰ã€Œå¯¦éš›é–‹è»Šæ™‚é–“ã€æ’åºï¼ˆç´”ç²¹æŒ‰åˆ†é˜æ•¸ï¼‰
                filtered.forEach(t => {
                    let [h, m] = (t.ScheduledDepartureTime || "00:00").split(':').map(Number);
                    let delayMins = parseInt(t.DelayTime || 0);
                    // å¯¦éš›æ™‚é–“ = è¡¨å®šæ™‚é–“ + èª¤é»
                    let actualMins = (h * 60 + m) + delayMins;
                    // åªæŒ‰å¯¦éš›æ™‚é–“çš„ç›¸å°åˆ†é˜æ•¸æ’åºï¼ˆå– mod 1440 ç¢ºä¿å‡Œæ™¨ç­æ¬¡æ’åœ¨å‰é¢ï¼‰
                    t._sort = actualMins % 1440;
                });
                filtered.sort((a, b) => a._sort - b._sort);

                // å„²å­˜åˆ°å¿«å–
                lastTrainData = filtered;

                refreshDisplay();

            } catch (e) {
                console.error("æ›´æ–°PIDSå¤±æ•—:", e);
                renderTable('1', []);
                renderTable('0', []);
            }
        }

        // è² è²¬æŠŠ lastTrainData ç•«åˆ°ç•«é¢ä¸Š
        function refreshDisplay() {
            // âœ… æ”¹ç‚ºç›´æ¥å¾ STATE è®€å–ï¼Œç¢ºä¿æŠ“åˆ° Proxy æ›´æ–°å¾Œçš„è³‡æ–™
            const data = PIDS_APP.STATE.lastTrainData;

            let t1 = data.filter(t => t.Direction == 1);
            let t0 = data.filter(t => t.Direction == 0);

            renderTable('1', t1);
            renderTable('0', t0);
            updateMarquee('marquee1', t1);
            updateMarquee('marquee0', t0);

            // ğŸ”¥ ä¿®æ­£: é¡¯ç¤ºå‰ 3 å€‹ç›®çš„åœ°
            populateDestinationMarquee('destList1', t1, 1);
            populateDestinationMarquee('destList0', t0, 0);
        }

        // ğŸ”¥ æ–°å¢: è™•ç†æ–¹å‘æ¨™é¡Œä¸‹çš„ç«™ååˆ—è¡¨é¡¯ç¤º
        function populateDestinationMarquee(id, list, direction) {
            const el = document.getElementById(id);
            const lang = i18n[PIDS_APP.STATE.currentLang]; // âœ… çµ±ä¸€ä½¿ç”¨ STATE

            if (!list || list.length === 0) {
                // âœ… ä¿®æ­£ï¼šé¡¯ç¤ºã€Œç„¡åˆ—è»Šè³‡è¨Šã€è€Œéä¸€ç›´ Loading
                el.innerText = lang.noTrain;
                return;
            }

            // ç²å–å‰ 3 ç­†åˆ—è»Šçš„æœ€çµ‚ç›®çš„åœ°
            let destinations = list.slice(0, 3).map(t => {
                return translateStation(t.EndingStationName);
            });
            let uniqueDestinations = [...new Set(destinations)].join(PIDS_APP.STATE.currentLang === 'zh' ? 'ã€' : ', ');

            if (uniqueDestinations.length > 0) {
                const prefix = PIDS_APP.STATE.currentLang === 'zh' ? 'é–‹å¾€: ' : 'To: ';
                el.innerText = prefix + uniqueDestinations;
            } else {
                el.innerText = lang.noTrain;
            }
        }

        // ğŸ”¥ å¤§å¸«ç´šå„ªåŒ–ï¼šä½¿ç”¨ DocumentFragment å–ä»£ innerHTML æ‹¼æ¥ï¼ˆå¾æºé ­æœçµ• XSSï¼‰
        function renderTable(dir, list) {
            const tb = document.getElementById(`body${dir}`);
            // âœ… é—œéµä¿®æ­£ï¼šç›´æ¥è®€å– STATEï¼Œç¢ºä¿èªè¨€åŒæ­¥
            const lang = i18n[PIDS_APP.STATE.currentLang];
            const template = document.getElementById('train-row-template');

            // æ¸…ç©ºè¡¨æ ¼ï¼ˆä½¿ç”¨ textContent æ¯” innerHTML = '' æ›´å®‰å…¨ï¼‰
            while (tb.firstChild) {
                tb.removeChild(tb.firstChild);
            }

            const isMobile = window.innerWidth <= 900;
            const currentMaxRows = isMobile ? RWD_MAX_ROWS : MAX_ROWS;

            // ğŸ”¥ ä½¿ç”¨ DocumentFragment æå‡æ€§èƒ½ï¼ˆä¸€æ¬¡æ€§æ’å…¥æ‰€æœ‰å…ƒç´ ï¼‰
            const fragment = document.createDocumentFragment();

            list.slice(0, currentMaxRows).forEach((t, i) => {
                let info = getInfo(t);
                let delay = parseInt(t.DelayTime || 0);
                let isCancel = String(t.TrainStatus) === '2';

                // å¤šèªè¨€ç‹€æ…‹é¡¯ç¤º
                let status = isCancel ? lang.cancelled : (delay > 0 ? lang.delay.replace('{min}', delay) : lang.onTime);
                let cls = isCancel ? 'status-cancelled' : (delay > 0 ? 'status-delay' : 'status-ontime');

                let timeStr = (t.ScheduledDepartureTime || "").slice(0, 5);
                let timeDisplay = timeStr;
                let isDelayed = false;

                if (delay > 0 && !isCancel) {
                    let [h, m] = timeStr.split(':').map(Number);
                    let min = h * 60 + m + delay;
                    timeDisplay = `${String(Math.floor(min / 60) % 24).padStart(2, '0')}:${String(min % 60).padStart(2, '0')}`;
                    isDelayed = true;
                }

                // ç›®çš„åœ°è™•ç†
                let dest = translateStation(t.EndingStationName);
                // âœ… ä½¿ç”¨ PIDS_APP.STATE.currentLang
                if (t.TripLine == 1) dest += PIDS_APP.STATE.currentLang === 'zh' ? ' (å±±)' : ' (MT)';
                else if (t.TripLine == 2) dest += PIDS_APP.STATE.currentLang === 'zh' ? ' (æµ·)' : ' (CO)';

                // ğŸ”¥ ä½¿ç”¨ Template å…‹éš†ï¼ˆå®Œå…¨é¿å… innerHTMLï¼‰
                const clone = template.content.cloneNode(true);
                const tr = clone.querySelector('tr');

                // è¨­ç½®å±¬æ€§
                if (i === 0) tr.classList.add('highlight-row');
                tr.setAttribute('aria-label', `è»Šæ¬¡ ${t.TrainNo}, ${info.name}, é–‹å¾€ ${dest}, ${status}`);

                // ğŸ”¥ ä½¿ç”¨ textContent å®‰å…¨è¨­ç½®å…§å®¹ï¼ˆå®Œå…¨é˜²æ­¢ XSSï¼‰
                const cells = tr.querySelectorAll('td');
                cells[0].textContent = String(t.TrainNo);

                // è»Šç¨® badgeï¼ˆå”¯ä¸€éœ€è¦ HTML çš„åœ°æ–¹ï¼Œä½†å…§å®¹å·²è¢« textContent ä¿è­·ï¼‰
                const badge = document.createElement('span');
                badge.className = `train-type-badge type-${info.cls}`;
                badge.textContent = info.name;
                cells[1].appendChild(badge);

                cells[2].textContent = dest;

                // æ™‚é–“é¡¯ç¤º
                const timeSpan = document.createElement('span');
                timeSpan.className = isDelayed ? 'expected-time' : 'normal-time';
                timeSpan.textContent = timeDisplay;
                cells[3].appendChild(timeSpan);

                cells[4].textContent = status;
                cells[4].className = cls;
                cells[4].setAttribute('role', 'gridcell');

                fragment.appendChild(clone);
            });

            // å¡«å……ç©ºè¡Œ
            for (let i = Math.min(list.length, currentMaxRows); i < currentMaxRows; i++) {
                const clone = template.content.cloneNode(true);
                fragment.appendChild(clone);
            }

            // ğŸ”¥ ä¸€æ¬¡æ€§æ’å…¥ï¼ˆæ€§èƒ½æœ€ä½³ï¼‰
            tb.appendChild(fragment);
        }

        async function updateMarquee(elId, list) {
            const el = document.getElementById(elId);
            // âœ… é—œéµä¿®æ­£ï¼šç›´æ¥è®€å– STATE
            const lang = i18n[PIDS_APP.STATE.currentLang];

            if (!list || list.length === 0) {
                el.textContent = lang.noTrain; // ä½¿ç”¨ textContent æ›´å®‰å…¨
                startMarquee(elId);
                return;
            }

            let t = list[0];
            let info = getInfo(t);
            let delay = parseInt(t.DelayTime || 0);
            let isCancel = String(t.TrainStatus) === '2';

            if (isCancel) {
                const destName = translateStation(t.EndingStationName);
                // âœ… ä½¿ç”¨ PIDS_APP.STATE.currentLang
                const cancelMsg = PIDS_APP.STATE.currentLang === 'zh'
                    ? `ğŸš« ${t.TrainNo} æ¬¡ ${info.name} å¾€ ${destName} æœ¬æ—¥åœé§›`
                    : `ğŸš« Train ${t.TrainNo} ${info.name} to ${destName} CANCELLED`;
                el.textContent = cancelMsg; // ä½¿ç”¨ textContent æ›´å®‰å…¨
                startMarquee(elId);
                return;
            }

            // å¤šèªè¨€ç›®çš„åœ°
            let destName = translateStation(t.EndingStationName);

            let msg = `<span style="color:#ffeb3b;font-weight:bold">${t.TrainNo} ${info.name} ${lang.toward}${destName}</span>`;
            msg += `<span style="margin:0 15px;color:#555">|</span>`;

            let liveData = null;
            try {
                const liveWorkerPromise = fetch(`${TRA_WORKER_URL}/api/live?trainNo=${t.TrainNo}`).then(r => r.json()).catch(() => null);
                liveData = await liveWorkerPromise;

                if (liveData?.TrainLiveBoards?.length > 0) liveData = liveData.TrainLiveBoards[0];
                else if (liveData?.StationName) liveData = liveData;
                else liveData = null;
            } catch (e) { }

            let locationText = "";
            let liveDelay = 0;
            if (liveData && liveData.StationName) {
                const lastStationName = liveData.StationName.Zh_tw || liveData.StationName;
                const lastStationNameTranslated = translateStation(lastStationName);
                liveDelay = liveData.DelayTime ? parseInt(liveData.DelayTime) : 0;

                let stops = await fetchTrainStops(t.TrainNo);
                let nextStopName = "";
                if (stops && stops.length > 0) {
                    const passedIndex = stops.findIndex(s => s.StationName.Zh_tw === lastStationName);
                    if (passedIndex !== -1 && passedIndex < stops.length - 1) {
                        // ğŸ”¥ ç§»é™¤é‡è¤‡ç«™åï¼ˆä½¿ç”¨ Set å»é‡ï¼‰
                        const nextStops = stops.slice(passedIndex + 1);
                        const uniqueNextStops = [...new Set(nextStops.map(s => translateStation(s.StationName.Zh_tw)))];
                        nextStopName = uniqueNextStops[0] || '';
                    }
                }

                locationText = nextStopName
                    ? `${lang.curPos}${lastStationNameTranslated}${lang.nextPos}${nextStopName}`
                    : `${lang.curPos}${lastStationNameTranslated}`;
                // âœ… ä½¿ç”¨ PIDS_APP.STATE.currentLang
                if (liveDelay > 0) locationText += PIDS_APP.STATE.currentLang === 'zh' ? ` (æ™š ${liveDelay} åˆ†)` : ` (${liveDelay} min late)`;

            } else {
                locationText = (t.IsTomorrow) ? lang.notDeparted : lang.detecting;
            }

            msg += `<span style="color:#4fc3f7">${locationText}</span>`;
            msg += `<span style="margin:0 15px;color:#555">|</span>`;

            // ğŸ”¥ ä¿®æ­£: å„ªå…ˆä½¿ç”¨ Worker å›å‚³çš„ ScheduledArrivalTime (è¡¨å®šæŠµé”æ™‚é–“)
            let arrivalTime = t.ScheduledArrivalTime || t.ScheduledDepartureTime || "00:00";

            // å˜—è©¦å–å¾—æ›´ç²¾ç¢ºçš„åœé ç«™è³‡æ–™ (å¦‚æœæœ‰çš„è©±)
            let stops = await fetchTrainStops(t.TrainNo);
            if (stops && stops.length > 0) {
                let stationStop = stops.find(s => String(s.StationID) === GLOBAL_STATION_ID);
                if (stationStop && stationStop.ArrivalTime) {
                    arrivalTime = stationStop.ArrivalTime.slice(0, 5);
                }
            }

            const predictedTime = getExpectedTime(arrivalTime, delay);
            const timeColor = delay > 0 ? '#ff5252' : '#ffffff';
            const statusText = delay > 0 ? lang.delay.replace('{min}', delay) : lang.onTime;

            msg += `${lang.expected}<span style="color:${timeColor};font-weight:bold;font-size:1.1em">${predictedTime}${lang.arrive} (${statusText})</span>`;

            // ğŸ”¥ æ–°å¢ï¼šé¡¯ç¤ºåˆ—è»Šå‚™è¨»ï¼ˆæ”¯æŒç¿»è¯‘ï¼‰
            if (t.Note && t.Note.trim().length > 0) {
                msg += `<span style="margin:0 15px;color:#555">|</span>`;
                // âœ… ä½¿ç”¨ PIDS_APP.STATE.currentLang
                const noteLabel = PIDS_APP.STATE.currentLang === 'zh' ? 'å‚™è¨»ï¼š' : 'Note: ';
                const translatedNote = translateNote(t.Note);
                msg += `<span style="color:#ff9800;font-weight:bold">${noteLabel}${translatedNote}</span>`;
            }

            if (stops && stops.length > 0) {
                let idx = stops.findIndex(s => String(s.StationID) === GLOBAL_STATION_ID);
                console.log(`[${t.TrainNo}] å°‹æ‰¾æœ¬ç«™ ${GLOBAL_STATION_ID}: æ‰¾åˆ°ç´¢å¼•=${idx}, ç¸½åœé ç«™æ•¸=${stops.length}`);
                if (idx !== -1) {
                    // âœ… ä½¿ç”¨ PIDS_APP.STATE.currentLang
                    let next = stops.slice(idx + 1).map(s => translateStation(s.StationName.Zh_tw)).join(PIDS_APP.STATE.currentLang === 'zh' ? 'ã€' : ' â†’ ');
                    console.log(`[${t.TrainNo}] å¾ŒçºŒåœé ç«™ï¼š${next || 'ç„¡(çµ‚é»)'}`);
                    if (next) {
                        const stopsLabel = PIDS_APP.STATE.currentLang === 'zh' ? 'æ²¿é€”åœé ï¼š' : 'Stops: ';
                        msg += `<span style="margin:0 15px;color:#555">|</span>${stopsLabel}${next}`;
                    }
                    else {
                        const terminalLabel = PIDS_APP.STATE.currentLang === 'zh' ? 'â–¶ çµ‚é»ç«™' : 'â–¶ Terminal';
                        msg += `<span style="margin:0 15px;color:#555">|</span>${terminalLabel}`;
                    }
                } else {
                    // æ‰¾ä¸åˆ°æœ¬ç«™ï¼Œé¡¯ç¤ºé™¤äº†èµ·é»å¤–çš„æ‰€æœ‰åœé ç«™
                    let allStops = stops.slice(1).map(s => translateStation(s.StationName.Zh_tw)).join(PIDS_APP.STATE.currentLang === 'zh' ? 'ã€' : ' â†’ ');
                    console.log(`[${t.TrainNo}] æ‰¾ä¸åˆ°æœ¬ç«™ï¼Œé¡¯ç¤ºæ‰€æœ‰åœé ç«™ï¼š${allStops}`);
                    if (allStops) {
                        const stopsLabel = PIDS_APP.STATE.currentLang === 'zh' ? 'æ²¿é€”åœé ï¼š' : 'Stops: ';
                        msg += `<span style="margin:0 15px;color:#555">|</span>${stopsLabel}${allStops}`;
                    }
                }
            } else {
                console.warn(`[${t.TrainNo}] åœé ç«™è³‡æ–™ç‚ºç©ºæˆ–æœªè¼‰å…¥`);
            }

            el.innerHTML = msg;
            startMarquee(elId);
        }

        async function checkTopMarquee() {
            try {
                // ğŸ”¥ ä¿®æ­£: å¸¶å…¥ station åƒæ•¸ï¼Œè®“ Worker èƒ½å›å‚³æ²¿é€”åœé ç«™è³‡è¨Š
                let url = `${TRA_WORKER_URL}/api/pids/marquee`;
                if (GLOBAL_STATION_ID) url += `?station=${GLOBAL_STATION_ID}`;

                let r = await fetch(url);
                let d = await r.json();
                let el = document.getElementById('unifiedTopMarquee');

                if (d.text !== undefined && d.text !== null) {
                    let cleanText = d.text
                        .replace(/<[^>]*>/g, "") // å¼·åˆ¶ç§»é™¤æ‰€æœ‰ HTML æ¨™ç±¤
                        .replace(/\\n/g, "     ")
                        .replace(/[\r\n]+/g, "     ")
                        .replace(/\s{2,}/g, "     ") // åˆä½µå¤šé¤˜ç©ºç™½
                        .replace(/&nbsp;/g, " ")
                        .replace(/&amp;/g, "&")
                        .trim();

                    // ğŸ”¥ é—œéµå„ªåŒ–ï¼šå¦‚æœå…§å®¹è·Ÿç¾åœ¨ä¸€æ¨£ï¼Œå°±ä¸è¦é‡å•Ÿè·‘é¦¬ç‡ˆï¼Œè®“å®ƒç¹¼çºŒè·‘å®Œ
                    if (el.innerHTML === cleanText) {
                        return;
                    }

                    el.innerHTML = cleanText;
                    startMarquee('unifiedTopMarquee');
                }
            } catch (e) { console.warn("Top Marquee Error:", e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ============ ä½¿ç”¨æ–°æ¶æ§‹åˆå§‹åŒ– PIDS ç³»çµ± ============
            console.log('ğŸš€ PIDS ç³»çµ±å•Ÿå‹•ä¸­...');

            // åˆå§‹åŒ– PIDS_APPï¼ˆæ–°æ¶æ§‹ï¼‰
            PIDS_APP.init();

            // å‘å¾Œå…¼å®¹ï¼šè¨­ç½®èˆŠçš„å…¨åŸŸè®Šæ•¸
            const p = new URLSearchParams(location.search);
            GLOBAL_STATION_ID = p.get('station') || PIDS_APP.STATE.stationID;
            currentLang = PIDS_APP.STATE.currentLang;
            lastTrainData = PIDS_APP.STATE.lastTrainData;

            // ğŸ”¥ è¨»å†Š Service Workerï¼ˆPWA é›¢ç·šæ”¯æ´ï¼‰
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('âœ… Service Worker è¨»å†ŠæˆåŠŸ:', registration.scope);

                        // æª¢æŸ¥æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('ğŸ”„ æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                                    // å¯é¸ï¼šé¡¯ç¤ºæ›´æ–°æç¤º
                                    if (confirm('ç™¼ç¾æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.warn('âš ï¸ Service Worker è¨»å†Šå¤±æ•—:', error);
                    });

                // ç›£è½ Service Worker æ§åˆ¶è®ŠåŒ–
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('ğŸ”„ Service Worker å·²æ›´æ–°');
                });
            }

            // ğŸ”¥ å®‰è£åˆ°æ¡Œé¢æç¤ºï¼ˆPWAï¼‰- å„ªåŒ–ç‰ˆ
            let deferredPrompt;
            let installButton = null;

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;

                // ğŸ¯ å„ªåŒ–ï¼šå‰µå»ºè‡ªå®šç¾©å®‰è£æŒ‰éˆ•ï¼ˆè€Œéè‡ªå‹• confirmï¼‰
                console.log('ğŸ“± å¯å®‰è£ç‚º App');

                // å‰µå»ºæµ®å‹•å®‰è£æŒ‰éˆ•
                if (!localStorage.getItem('pwa_install_dismissed')) {
                    installButton = document.createElement('div');
                    installButton.id = 'pwa-install-banner';
                    installButton.innerHTML = `
                        <div style="position:fixed;top:20px;right:20px;background:#1976d2;color:#fff;padding:15px 25px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:9999;cursor:pointer;font-size:1rem;display:flex;align-items:center;gap:10px;animation:slideIn 0.5s ease-out">
                            <i class="fas fa-mobile-alt"></i>
                            <span>å®‰è£ App</span>
                            <button style="background:#fff;color:#1976d2;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-weight:bold;margin-left:10px">å®‰è£</button>
                            <button id="pwa-dismiss" style="background:transparent;color:#fff;border:none;padding:5px;cursor:pointer;font-size:1.2rem">Ã—</button>
                        </div>
                        <style>
                            @keyframes slideIn {
                                from { transform: translateX(400px); opacity: 0; }
                                to { transform: translateX(0); opacity: 1; }
                            }
                        </style>
                    `;
                    document.body.appendChild(installButton);

                    // å®‰è£æŒ‰éˆ•äº‹ä»¶
                    installButton.querySelector('button:not(#pwa-dismiss)').addEventListener('click', async () => {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice;
                            console.log(outcome === 'accepted' ? 'âœ… ä½¿ç”¨è€…æ¥å—å®‰è£' : 'âŒ ä½¿ç”¨è€…æ‹’çµ•å®‰è£');
                            deferredPrompt = null;
                            installButton.remove();
                        }
                    });

                    // é—œé–‰æŒ‰éˆ•
                    installButton.querySelector('#pwa-dismiss').addEventListener('click', () => {
                        localStorage.setItem('pwa_install_dismissed', 'true');
                        installButton.remove();
                    });
                }
            });

            // å®‰è£æˆåŠŸå¾Œç§»é™¤æŒ‰éˆ•
            window.addEventListener('appinstalled', () => {
                console.log('âœ… PWA å®‰è£æˆåŠŸï¼');
                if (installButton) installButton.remove();
            });

            console.log('âœ… PIDS ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
            console.log(`ğŸ“ è»Šç«™: ${PIDS_APP.STATE.stationName} (ID: ${PIDS_APP.STATE.stationID})`);
            console.log(`ğŸŒ èªè¨€: ${PIDS_APP.STATE.currentLang.toUpperCase()}`);
            console.log('ğŸš€ Master Class åŠŸèƒ½å·²å•Ÿç”¨ï¼š');
            console.log('  âœ… Proxy ç‹€æ…‹ç®¡ç†');
            console.log('  âœ… AbortController é˜²æ­¢ Race Condition');
            console.log('  âœ… DocumentFragment æ¸²æŸ“');
            console.log('  âœ… éµç›¤å°èˆªæ”¯æ´');
            console.log('  âœ… PWA é›¢ç·šèƒ½åŠ›');
        });

        /**
         * å…¨è¢å¹•åŠŸèƒ½ (Master Class ç‰ˆ)
         */
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const fullscreenIcon = fullscreenBtn.querySelector('i');

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // é€²å…¥å…¨è¢å¹•
                document.documentElement.requestFullscreen().then(() => {
                    fullscreenIcon.classList.remove('fa-expand');
                    fullscreenIcon.classList.add('fa-compress');
                    fullscreenBtn.title = 'é€€å‡ºå…¨è¢å¹•';
                    console.log('âœ… å·²é€²å…¥å…¨è¢å¹•æ¨¡å¼');
                }).catch(err => {
                    console.error('âš ï¸ ç„¡æ³•é€²å…¥å…¨è¢å¹•:', err);
                });
            } else {
                // é€€å‡ºå…¨è¢å¹•
                document.exitFullscreen().then(() => {
                    fullscreenIcon.classList.remove('fa-compress');
                    fullscreenIcon.classList.add('fa-expand');
                    fullscreenBtn.title = 'åˆ‡æ›å…¨è¢å¹•';
                    console.log('âœ… å·²é€€å‡ºå…¨è¢å¹•æ¨¡å¼');
                });
            }
        }

        // æŒ‰éˆ•é»æ“Šäº‹ä»¶
        fullscreenBtn.addEventListener('click', toggleFullscreen);

        // ç›£è´å…¨è¢å¹•ç‹€æ…‹è®ŠåŒ–ï¼ˆä¾‹å¦‚ç”¨æˆ¶æŒ‰ ESCï¼‰
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                fullscreenIcon.classList.remove('fa-compress');
                fullscreenIcon.classList.add('fa-expand');
                fullscreenBtn.title = 'åˆ‡æ›å…¨è¢å¹•';
            }
        });

        // å¿«æ·éµ F11 ä¹Ÿå¯ä»¥åˆ‡æ›ï¼ˆå¯é¸ï¼‰
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
        });

        /**
         * æ ¼å¼åŒ–æ™‚é–“å·¥å…· (Master Class ç‰ˆ)
         * ç”¨æ–¼å‘å¾Œå…¼å®¹å’Œæœªä¾†æ“´å……
         */
        function formatTime(t) {
            if (!t || typeof t !== 'string') return '--:--';
            return t.substring(0, 5);
        }
    </script>
</body>

</html>