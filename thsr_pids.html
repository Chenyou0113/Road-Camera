<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THSR Split PIDS</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* --- 全局設定 --- */
        :root {
            --bg-color: #000;
            --text-white: #fff;
            --text-orange: #ff6600; 
            --text-yellow: #ffcc00;
            --text-blue: #00ccff;
            --header-north: #cc0000;
            --header-south: #009933;
            --dim-gray: #444;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-white);
            font-family: 'Arial', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .split-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
        }
        .board-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid #333;
            overflow: hidden;
        }

        /* 標題列 */
        .header {
            padding: 5px 20px;
            font-size: 1.8rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .header.north { background-color: var(--header-north); }
        .header.south { background-color: var(--header-south); }
        .clock { font-family: 'Consolas', monospace; font-size: 1.8rem; }

        /* 表格樣式 */
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        thead { background-color: #222; }
        th { color: #aaa; font-size: 1rem; text-align: left; padding: 5px 10px; border-bottom: 1px solid #555; white-space: nowrap; }
        td { padding: 8px 10px; border-bottom: 1px solid #333; vertical-align: middle; font-size: 1.6rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .th-no { width: 8%; } .th-dest { width: 10%; } .th-time { width: 10%; }
        .th-plat { width: 6%; text-align: center; } .th-free { width: 12%; }
        .th-status { width: 12%; } .th-map { width: 42%; }

        .col-train-no { color: #fff; font-family: 'Consolas', monospace; }
        .col-dest { color: var(--text-blue); font-size: 1.8rem; }
        .col-time { color: #fff; font-family: 'Consolas', monospace; }
        .col-plat { color: #fff; text-align: center; }
        .col-free { color: var(--text-white); font-size: 1.2rem; }
        .status-ok { color: var(--text-yellow); font-size: 1.2rem; }
        .status-delay { color: #ff3333; font-size: 1.2rem; animation: blink 1s infinite; }

        /* 停靠站圖示 */
        .station-map { display: flex; align-items: center; justify-content: space-between; position: relative; padding: 0 10px; }
        .map-line { position: absolute; top: 6px; left: 15px; right: 15px; height: 2px; background-color: var(--dim-gray); z-index: 0; }
        .dot-wrapper { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; width: 100%; }
        .dot { width: 14px; height: 14px; border-radius: 50%; background-color: #222; border: 2px solid var(--dim-gray); margin-bottom: 2px; }
        .dot.active { background-color: var(--text-blue); border-color: #fff; box-shadow: 0 0 8px var(--text-blue); }
        .dot-name { font-size: 0.7rem; color: #666; transform: rotate(-30deg); transform-origin: top left; margin-top: 5px; font-weight: normal; }
        .dot.active + .dot-name { color: #fff; }

        /* --- 改良版跑馬燈 --- */
        .marquee {
            background-color: #000; /* 改回黑色底，比較好讀 */
            color: var(--text-yellow); /* 黃色字體 */
            padding: 12px 0;
            font-size: 1.6rem;
            white-space: nowrap;
            overflow: hidden;
            border-top: 2px solid #555;
            font-family: 'Consolas', 'Arial', sans-serif;
            position: relative;
        }
        .marquee span {
            display: inline-block;
            padding-left: 100%; /* 初始位置在最右邊 */
            animation: scroll 40s linear infinite; /* 調整速度 */
        }
        /* 若有紅色警示，字體變紅 */
        .marquee.alert-mode { background-color: #220000; color: #ff3333; }

        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="app" class="split-container">
        
        <div class="board-section">
            <div class="header north">
                <div>北上 Northbound</div>
                <div class="clock">{{ currentTime }}</div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="th-no">車次 Train</th>
                        <th class="th-dest">開往 Dest.</th>
                        <th class="th-time">時間 Time</th>
                        <th class="th-plat">月台 Plat.</th>
                        <th class="th-free">自由座 Non-Reserved</th>
                        <th class="th-status">行車資訊 Status</th>
                        <th class="th-map">停靠站 Stopping Stations</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="train in northboundTrains" :key="train.train_no">
                        <td class="col-train-no">{{ train.train_no }}</td>
                        <td class="col-dest">{{ train.destination.zh }}</td>
                        <td class="col-time">{{ train.departure_time }}</td>
                        <td class="col-plat">{{ train.platform }}</td>
                        <td class="col-free">Car {{ train.free_seating_cars }}</td>
                        <td class="col-status"><span class="status-ok">準點 On Time</span></td>
                        <td class="col-map">
                            <div class="station-map">
                                <div class="map-line"></div>
                                <div v-for="st in allStationsReversed" :key="st.id" class="dot-wrapper">
                                    <div class="dot" :class="{ 'active': train.stopping_stations.includes(st.id) }"></div>
                                    <div class="dot-name">{{ st.code }}</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr v-if="northboundTrains.length === 0"><td colspan="7" style="text-align:center; color:#555;">無北上班次</td></tr>
                </tbody>
            </table>
        </div>

        <div class="board-section">
            <div class="header south">
                <div>南下 Southbound</div>
                <div style="font-size:1.5rem">{{ currentStationName.zh }} {{ currentStationName.en }}</div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="th-no">車次 Train</th>
                        <th class="th-dest">開往 Dest.</th>
                        <th class="th-time">時間 Time</th>
                        <th class="th-plat">月台 Plat.</th>
                        <th class="th-free">自由座 Non-Reserved</th>
                        <th class="th-status">行車資訊 Status</th>
                        <th class="th-map">停靠站 Stopping Stations</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="train in southboundTrains" :key="train.train_no">
                        <td class="col-train-no">{{ train.train_no }}</td>
                        <td class="col-dest">{{ train.destination.zh }}</td>
                        <td class="col-time">{{ train.departure_time }}</td>
                        <td class="col-plat">{{ train.platform }}</td>
                        <td class="col-free">Car {{ train.free_seating_cars }}</td>
                        <td class="col-status"><span class="status-ok">準點 On Time</span></td>
                        <td class="col-map">
                            <div class="station-map">
                                <div class="map-line"></div>
                                <div v-for="st in allStations" :key="st.id" class="dot-wrapper">
                                    <div class="dot" :class="{ 'active': train.stopping_stations.includes(st.id) }"></div>
                                    <div class="dot-name">{{ st.code }}</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr v-if="southboundTrains.length === 0"><td colspan="7" style="text-align:center; color:#555;">無南下班次</td></tr>
                </tbody>
            </table>
        </div>

        <div class="marquee" :class="{ 'alert-mode': alerts.length > 0 }">
            <span>
                <span v-if="alerts.length > 0">
                    <span v-for="alert in alerts" :key="alert.AlertID" style="margin-right: 150px;">
                        【{{ alert.Title }}】{{ alert.Description }}
                    </span>
                </span>
                
                <span v-else>
                    {{ trainDetailMarquee }}
                </span>
            </span>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const API_URL = "https://thsr-proxy.xiaoyouwu5-fd3.workers.dev";
                
                const urlParams = new URLSearchParams(window.location.search);
                const stationID = ref(urlParams.get('station') || "1000"); 

                const trains = ref([]);
                const alerts = ref([]);
                const currentTime = ref("");

                const allStations = [
                    { id: "0990", name: "南港", code: "NAK" }, { id: "1000", name: "台北", code: "TPE" },
                    { id: "1010", name: "板橋", code: "BAC" }, { id: "1020", name: "桃園", code: "TAY" },
                    { id: "1030", name: "新竹", code: "HSC" }, { id: "1035", name: "苗栗", code: "MIL" },
                    { id: "1040", name: "台中", code: "TAC" }, { id: "1043", name: "彰化", code: "CHA" },
                    { id: "1047", name: "雲林", code: "YUL" }, { id: "1050", name: "嘉義", code: "CHY" },
                    { id: "1060", name: "台南", code: "TNN" }, { id: "1070", name: "左營", code: "ZUY" }
                ];
                
                // 北上地圖用的反轉陣列 (左營 -> 南港)
                const allStationsReversed = [...allStations].reverse();

                // 計算屬性：南下車次 (Direction 0)
                const southboundTrains = computed(() => {
                    return trains.value.filter(t => t.direction === 0).slice(0, 4); // 顯示 4 班
                });

                // 計算屬性：北上車次 (Direction 1)
                const northboundTrains = computed(() => {
                    return trains.value.filter(t => t.direction === 1).slice(0, 4); // 顯示 4 班
                });

                // 取得當前車站名
                const currentStationName = computed(() => {
                    const st = allStations.find(s => s.id === stationID.value);
                    return st ? { zh: st.name, en: st.code } : { zh: "", en: "" };
                });

                // ★★★ 計算跑馬燈文字 ★★★
                const trainDetailMarquee = computed(() => {
                    // 把南下和北上的前幾班車合併起來做跑馬燈
                    const targetTrains = [...northboundTrains.value, ...southboundTrains.value];
                    
                    if (targetTrains.length === 0) return "歡迎搭乘台灣高鐵 Welcome to Taiwan High Speed Rail";

                    // 建立 ID 對照 Map (方便查站名)
                    const stationNameMap = {};
                    allStations.forEach(s => stationNameMap[s.id] = s.name);

                    return targetTrains.map(t => {
                        // 1. 取得這班車的所有停靠站名稱
                        // 並且只顯示「目前車站」之後的站 (過濾掉已經停過的)
                        
                        // 找到目前車站在停靠列表中的 index
                        const currentIndex = t.stopping_stations.indexOf(stationID.value);
                        
                        // 只取 index 之後的站
                        let futureStops = [];
                        if (currentIndex !== -1 && currentIndex < t.stopping_stations.length - 1) {
                            futureStops = t.stopping_stations.slice(currentIndex + 1);
                        } else {
                            // 如果找不到目前站(過站不停?)，就顯示全部
                            futureStops = t.stopping_stations;
                        }

                        // 轉成中文站名
                        const stopsText = futureStops.map(id => stationNameMap[id]).join("、");

                        // 組合句子
                        return `第 ${t.train_no} 車次 ${t.departure_time} 開往 ${t.destination.zh}，沿途停靠：${stopsText}。`;
                    }).join("          "); // 句子之間加空格
                });

                const fetchData = async () => {
                    try {
                        const res = await fetch(`${API_URL}/?station=${stationID.value}`);
                        const data = await res.json();
                        
                        // 時間過濾
                        const now = new Date();
                        const currentHm = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
                        
                        trains.value = data.trains.filter(t => t.departure_time >= currentHm);
                        alerts.value = data.alerts || [];
                    } catch (e) { console.error(e); }
                };

                setInterval(() => {
                    const now = new Date();
                    currentTime.value = now.toLocaleTimeString('en-US', {hour12: false});
                }, 1000);

                setInterval(fetchData, 60000); // 每分鐘更新

                onMounted(() => {
                    fetchData();
                    const now = new Date();
                    currentTime.value = now.toLocaleTimeString('en-US', {hour12: false});
                });

                return {
                    stationID, northboundTrains, southboundTrains, alerts, currentTime,
                    allStations, allStationsReversed, currentStationName, trainDetailMarquee
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
