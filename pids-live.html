<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµ PIDS é›™è¢å¹•çœ‹æ¿ (Liveç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #111;
            color: white;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }

        .pids-screen {
            flex: 1;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            border: 10px solid #333;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            overflow: hidden;
            position: relative;
        }

        /* é ‚éƒ¨è·‘é¦¬ç‡ˆ (ä¸€èˆ¬å…¬å‘Š) */
        .marquee-header {
            background-color: #e3f2fd;
            color: #01579b;
            height: 45px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 2px solid #000;
            white-space: nowrap;
            overflow: hidden;
        }

        /* åº•éƒ¨è·‘é¦¬ç‡ˆ (åˆ—è»Šå‹•æ…‹) */
        .marquee-footer {
            background-color: #212121;
            color: #ffeb3b; /* é»ƒè‰²å­— */
            height: 55px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 1.3rem;
            font-weight: bold;
            border-top: 3px solid #ff9800;
            white-space: nowrap;
            overflow: hidden;
            position: relative;
        }

        .marquee-text {
            display: inline-block;
            animation: scroll-left 20s linear infinite;
            padding-left: 100%;
        }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .screen-body { flex: 1; display: flex; overflow: hidden; }

        /* å·¦å´è³‡è¨Šæ¬„ */
        .sidebar { width: 25%; display: flex; flex-direction: column; border-right: 2px solid #333; }
        .info-box { padding: 10px; color: #000; font-weight: bold; display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .date-box { background-color: #fff; flex: 1; font-size: 1.1rem; border-bottom: 2px solid #000; }
        .time-large { font-size: 2rem; font-weight: 900; margin-top: 5px; color: #000; font-family: Consolas, monospace; }
        .current-train { background-color: #ffe082; flex: 1.5; border-bottom: 2px solid #000; }
        .next-train { background-color: #f5f5f5; flex: 1.5; }
        .box-label { font-size: 1rem; color: #555; }
        .box-dest { font-size: 2.2rem; color: #000; font-weight: 900; line-height: 1.2; }
        .box-time { font-size: 1.8rem; color: #d32f2f; font-weight: bold; margin-top: 5px; }

        /* å³å´åˆ—è¡¨ */
        .schedule-list { flex: 1; display: flex; flex-direction: column; }
        .north-header { background: linear-gradient(to right, #000080, #0d47a1); color: white; padding: 10px; font-size: 1.5rem; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
        .north-table th { background-color: #000080; color: #fff; }
        .north-table tr:nth-child(odd) { background-color: #000; color: #4fc3f7; }
        .north-table tr:nth-child(even) { background-color: #006064; color: #fff; }
        .south-header { background: linear-gradient(to right, #bf360c, #e65100); color: white; padding: 10px; font-size: 1.5rem; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
        .south-table th { background-color: #bf360c; color: #fff; }
        .south-table tr:nth-child(odd) { background-color: #000; color: #ffcc80; }
        .south-table tr:nth-child(even) { background-color: #e65100; color: #fff; }
        
        .train-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 1.5rem; font-weight: bold; flex: 1; }
        .train-table th { padding: 8px; font-size: 1.3rem; border-bottom: 2px solid #fff; }
        .train-table td { padding: 10px 5px; }
        .status-ontime { color: #00e676 !important; }
        .status-delay { color: #ff1744 !important; }
        .type-tze { color: #ffeb3b; } 
        .type-local { color: #fff; }

        @media (max-width: 1024px) { 
            body { flex-direction: column; height: auto; overflow-y: auto; } 
            .pids-screen { width: 100%; height: 650px; margin-bottom: 20px; } 
        }
    </style>
</head>
<body>

    <!-- å·¦è¢å¹•ï¼šåŒ—ä¸Š -->
    <div class="pids-screen">
        <div class="marquee-header">
            <div class="marquee-text">[åŒ—ä¸Šå…¬å‘Š] æœ¬ç«™åŒ—ä¸Šåˆ—è»Šé‹è½‰æ­£å¸¸ï¼Œæ„Ÿè¬æ‚¨çš„æ­ä¹˜ã€‚</div>
        </div>
        <div class="screen-body">
            <div class="sidebar">
                <div class="info-box date-box">
                    <div id="dateN">--/--</div>
                    <div class="time-large" id="timeN">--:--</div>
                </div>
                <div class="info-box current-train">
                    <div class="box-label">æœ¬ç­é–‹å¾€</div>
                    <div class="box-dest" id="currDestN">-</div>
                    <div class="box-time" id="currTimeN">-</div>
                </div>
                <div class="info-box next-train">
                    <div class="box-label">ä¸‹ç­é–‹å¾€</div>
                    <div class="box-dest" id="nextDestN">-</div>
                    <div class="box-time" id="nextTimeN">-</div>
                </div>
            </div>
            <div class="schedule-list">
                <div class="north-header">
                    <span><i class="fas fa-arrow-up"></i> åŒ—ä¸Š</span>
                    <span style="font-size: 1rem;">North Bound</span>
                </div>
                <table class="train-table north-table">
                    <thead>
                        <tr><th>è»Šæ¬¡</th><th>è»Šç¨®</th><th>é–‹å¾€</th><th>æ™‚é–“</th><th>å‚™è¨»</th></tr>
                    </thead>
                    <tbody id="northBody"></tbody>
                </table>
            </div>
        </div>
        <!-- åº•éƒ¨è·‘é¦¬ç‡ˆ (åŒ—ä¸Šå‹•æ…‹) -->
        <div class="marquee-footer">
            <div class="marquee-text" id="marqueeN">ğŸ”„ æ›´æ–°ä¸­...</div>
        </div>
    </div>

    <!-- å³è¢å¹•ï¼šå—ä¸‹ -->
    <div class="pids-screen">
        <div class="marquee-header">
            <div class="marquee-text">[å—ä¸‹å…¬å‘Š] æœ¬ç«™å—ä¸‹åˆ—è»Šé‹è½‰æ­£å¸¸ï¼Œæ„Ÿè¬æ‚¨çš„æ­ä¹˜ã€‚</div>
        </div>
        <div class="screen-body">
            <div class="sidebar">
                <div class="info-box date-box">
                    <div id="dateS">--/--</div>
                    <div class="time-large" id="timeS">--:--</div>
                </div>
                <div class="info-box current-train">
                    <div class="box-label">æœ¬ç­é–‹å¾€</div>
                    <div class="box-dest" id="currDestS">-</div>
                    <div class="box-time" id="currTimeS">-</div>
                </div>
                <div class="info-box next-train">
                    <div class="box-label">ä¸‹ç­é–‹å¾€</div>
                    <div class="box-dest" id="nextDestS">-</div>
                    <div class="box-time" id="nextTimeS">-</div>
                </div>
            </div>
            <div class="schedule-list">
                <div class="south-header">
                    <span><i class="fas fa-arrow-down"></i> å—ä¸‹</span>
                    <span style="font-size: 1rem;">South Bound</span>
                </div>
                <table class="train-table south-table">
                    <thead>
                        <tr><th>è»Šæ¬¡</th><th>è»Šç¨®</th><th>é–‹å¾€</th><th>æ™‚é–“</th><th>å‚™è¨»</th></tr>
                    </thead>
                    <tbody id="southBody"></tbody>
                </table>
            </div>
        </div>
        <!-- åº•éƒ¨è·‘é¦¬ç‡ˆ (å—ä¸‹å‹•æ…‹) -->
        <div class="marquee-footer">
            <div class="marquee-text" id="marqueeS">ğŸ”„ æ›´æ–°ä¸­...</div>
        </div>
    </div>

    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script>
        // ============ æ™‚é˜æ›´æ–° ============
        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            const dateStr = (now.getMonth()+1) + '/' + now.getDate();
            document.getElementById('timeN').textContent = `${h}:${m}`;
            document.getElementById('timeS').textContent = `${h}:${m}`;
            document.getElementById('dateN').textContent = dateStr;
            document.getElementById('dateS').textContent = dateStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // ============ å·¥å…·å‡½å¼ ============
        function getTrainTypeName(trainType) {
            const typeMap = {
                '1100': 'æ™®æ‚ ç‘ª', '1200': 'å¤ªé­¯é–£', '2100': 'è‡ªå¼·', 
                '2200': 'è’å…‰', '2300': 'å¾©èˆˆ', '3100': 'å€é–“'
            };
            return typeMap[trainType] || 'æœªçŸ¥';
        }

        function formatTime(timeStr) {
            if (!timeStr) return '--:--';
            return timeStr.slice(0, 5);
        }

        function getDelayStatus(delay) {
            if (!delay || delay === 0) return { text: 'æº–é»', class: 'status-ontime' };
            return { text: `æ™š${delay}åˆ†`, class: 'status-delay' };
        }

        // ============ ä¸»æ›´æ–°å‡½å¼ ============
        async function updatePidsData(stationID) {
            try {
                console.log(`ğŸ”„ æ›´æ–°è»Šç«™ ${stationID} çš„åˆ—è»Šè³‡æ–™...`);
                
                // å¾ D1 Worker API å–å¾—è³‡æ–™
                const response = await fetch(`https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev/api/schedule?stationId=${stationID}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (!data.Infos || !Array.isArray(data.Infos)) {
                    console.warn('âš ï¸ ç„¡æœ‰æ•ˆè³‡æ–™');
                    return;
                }

                // åˆ†é¡åŒ—ä¸Š(Direction=1)èˆ‡å—ä¸‹(Direction=0)
                const northTrains = data.Infos
                    .filter(t => t.Direction === 1)
                    .sort((a, b) => a.DepartureTime.localeCompare(b.DepartureTime));
                
                const southTrains = data.Infos
                    .filter(t => t.Direction === 0)
                    .sort((a, b) => a.DepartureTime.localeCompare(b.DepartureTime));

                console.log(`âœ… å–å¾— - åŒ—ä¸Š: ${northTrains.length} ç­, å—ä¸‹: ${southTrains.length} ç­`);

                // æ¸²æŸ“è¡¨æ ¼èˆ‡å´é‚Šæ¬„
                renderScreen('north', northTrains);
                renderScreen('south', southTrains);

                // æ›´æ–°è·‘é¦¬ç‡ˆ (æŠ“å„æ–¹å‘çš„ç¬¬ä¸€ç­è»Šåšå³æ™‚ä½ç½®)
                if (northTrains.length > 0) updateLiveMarquee('marqueeN', northTrains[0]);
                if (southTrains.length > 0) updateLiveMarquee('marqueeS', southTrains[0]);

            } catch (error) {
                console.error('âŒ PIDS æ›´æ–°å¤±æ•—:', error);
                document.getElementById('marqueeN').textContent = 'âš ï¸ é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å€™...';
                document.getElementById('marqueeS').textContent = 'âš ï¸ é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å€™...';
            }
        }

        // ============ æ¸²æŸ“è¡¨æ ¼èˆ‡å´é‚Šæ¬„ ============
        function renderScreen(dir, trains) {
            const tbody = document.getElementById(`${dir}Body`);
            tbody.innerHTML = '';
            
            // å¡«å…¥è¡¨æ ¼ (æœ€å¤š5ç­†)
            trains.slice(0, 5).forEach(train => {
                const delayStatus = getDelayStatus(train.Delay);
                const trainType = getTrainTypeName(train.TrainType);
                const typeClass = trainType.includes('è‡ªå¼·') || trainType.includes('æ™®æ‚ ç‘ª') ? 'type-tze' : 'type-local';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${train.TrainNo}</td>
                    <td class="${typeClass}">${trainType}</td>
                    <td>${train.EndingStationName}</td>
                    <td>${formatTime(train.DepartureTime)}</td>
                    <td class="${delayStatus.class}">${delayStatus.text}</td>
                `;
                tbody.appendChild(row);
            });

            // è£œç©ºè¡Œ
            while (tbody.rows.length < 5) {
                const emptyRow = tbody.insertRow();
                emptyRow.innerHTML = '<td>&nbsp;</td><td></td><td></td><td></td><td></td>';
            }

            // æ›´æ–°å´é‚Šæ¬„ (æœ¬ç­/ä¸‹ç­)
            const suffix = dir === 'north' ? 'N' : 'S';
            if (trains.length > 0) {
                document.getElementById(`currDest${suffix}`).textContent = trains[0].EndingStationName;
                document.getElementById(`currTime${suffix}`).textContent = formatTime(trains[0].DepartureTime);
            }
            if (trains.length > 1) {
                document.getElementById(`nextDest${suffix}`).textContent = trains[1].EndingStationName;
                document.getElementById(`nextTime${suffix}`).textContent = formatTime(trains[1].DepartureTime);
            }
        }

        // ============ å³æ™‚ä½ç½®è·‘é¦¬ç‡ˆ ============
        async function updateLiveMarquee(elementId, train) {
            const el = document.getElementById(elementId);
            const trainNo = train.TrainNo;
            
            // é è¨­é¡¯ç¤º
            el.textContent = `æœ¬ç­åˆ—è»Šï¼š${trainNo} æ¬¡ ${getTrainTypeName(train.TrainType)} å¾€ ${train.EndingStationName} | é€£ç·šä¸­...`;

            try {
                // å˜—è©¦å¾ TDX V3 å–å¾—å³æ™‚ä½ç½®
                if (typeof tdxApi !== 'undefined') {
                    const liveData = await tdxApi.fetch(`/v3/Rail/TRA/TrainLiveBoard/TrainNo/${trainNo}?$format=JSON`);
                    
                    if (liveData && liveData.length > 0) {
                        const live = liveData[0];
                        const stationName = live.StationName?.Zh_tw || 'æœªçŸ¥';
                        const status = live.TrainStationStatus === 0 ? 'é€²ç«™ä¸­' : 'å·²é›¢é–‹';
                        
                        const delayStatus = getDelayStatus(train.Delay);
                        const text = `æœ¬ç­åˆ—è»Šï¼š${trainNo} æ¬¡ å¾€ ${train.EndingStationName} | ç›®å‰ä½ç½®ï¼š${status} ${stationName} | ${delayStatus.text}`;
                        
                        el.textContent = text;
                        
                        // æ ¹æ“šå­—æ•¸å‹•æ…‹èª¿æ•´é€Ÿåº¦
                        const duration = Math.max(15, text.length * 0.5);
                        el.parentElement.style.setProperty('--duration', `${duration}s`);
                    }
                }
            } catch (error) {
                console.warn('âš ï¸ å³æ™‚ä½ç½®å–å¾—å¤±æ•—:', error);
                // é™ç´šé¡¯ç¤ºï¼šç„¡å³æ™‚è¨Šè™Ÿç‰ˆæœ¬
                const delayStatus = getDelayStatus(train.Delay);
                el.textContent = `æœ¬ç­åˆ—è»Šï¼š${trainNo} æ¬¡ å¾€ ${train.EndingStationName} | ç„¡å³æ™‚è¨Šè™Ÿ | ${delayStatus.text}`;
            }
        }

        // ============ å¾ URL å–å¾—è»Šç«™ä»£ç¢¼ä¸¦åˆå§‹åŒ– ============
        function getUrlParam(param) {
            const params = new URLSearchParams(window.location.search);
            return params.get(param);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const stationID = getUrlParam('station') || '1000'; // é è¨­å°åŒ—ç«™
            console.log(`ğŸ“ åˆå§‹åŒ–è»Šç«™ ID: ${stationID}`);
            
            updatePidsData(stationID);
            // æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡
            setInterval(() => updatePidsData(stationID), 30000);
        });
    </script>
</body>
</html>
