<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµ PIDS (å¯¬ç‰ˆ+å¾Œå°é€£å‹•)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #111; color: white; font-family: "Microsoft JhengHei", sans-serif;
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            padding: 8px; gap: 8px;
        }

        /* Header */
        .unified-header {
            width: 100%; height: 90px; background: #000; border: 3px solid #333; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); flex-shrink: 0;
        }
        .station-branding { display: flex; align-items: center; gap: 15px; flex: 1; }
        .tra-logo-img { height: 55px; border-radius: 50%; border: 2px solid #fff; }
        .station-name { font-size: 3.2rem; font-weight: 900; line-height: 1; text-shadow: 0 0 10px rgba(255,255,255,0.6); }
        .station-sub { font-size: 1.4rem; color: #4fc3f7; font-family: Consolas, sans-serif; letter-spacing: 1px; }
        .datetime-block { display: flex; align-items: baseline; gap: 15px; text-align: right; }
        .time-text { font-size: 2.8rem; font-weight: bold; font-family: Consolas, monospace; color: #ffeb3b; }
        .date-text { font-size: 1.6rem; color: #ccc; font-weight: bold; font-family: Consolas, monospace; }

        /* Marquee */
        .unified-marquee-container {
            width: 100%; height: 50px; background: #e3f2fd; border: 3px solid #333; border-left: 8px solid #0277bd;
            display: flex; align-items: center; overflow: hidden; position: relative; color: #01579b; flex-shrink: 0;
        }
        .unified-marquee-container .marquee-text {
            position: absolute; white-space: nowrap; height: 50px; line-height: 50px; font-size: 2rem; font-weight: 900; left: 100%;
        }

        /* PIDS Section */
        .pids-section { 
            display: flex; width: 100%; gap: 10px; flex: 1; overflow: hidden; min-height: 0; 
        }
        .pids-column { 
            flex: 1; display: flex; flex-direction: column; background: #000; 
            border: 3px solid #333; border-radius: 8px; overflow: hidden; 
        }
        .screen-body { flex: 1; display: flex; flex-direction: column; background: #000; overflow: hidden; }

        .direction-header-1 { background: linear-gradient(to right, #000080, #0d47a1); color: white; padding: 8px 12px; font-size: 1.4rem; font-weight: 900; display: flex; justify-content: space-between; border-bottom: 2px solid #fff; }
        .direction-header-0 { background: linear-gradient(to right, #bf360c, #e65100); color: white; padding: 8px 12px; font-size: 1.4rem; font-weight: 900; display: flex; justify-content: space-between; border-bottom: 2px solid #fff; }

        /* Table Optimization */
        .train-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 1.6rem; font-weight: bold; table-layout: fixed; }
        .train-table th { padding: 5px; color: #fff; border-bottom: 2px solid #fff; height: 40px; font-size: 1.3rem; }
        .train-table tbody tr { height: 16%; border-bottom: 1px solid #333; }
        .train-table td { padding: 0 2px; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .table-1 th { background: #000080; } .table-1 tr:nth-child(odd) { background: #000; } .table-1 tr:nth-child(even) { background: #002f4b; }
        .table-0 th { background: #bf360c; } .table-0 tr:nth-child(odd) { background: #000; } .table-0 tr:nth-child(even) { background: #3e2723; }

        .marquee-footer { background: #212121; color: #ffeb3b; height: 40px; position: relative; overflow: hidden; border-top: 3px solid #ff9800; flex-shrink: 0; }
        .marquee-footer .marquee-text { position: absolute; white-space: nowrap; left: 100%; height: 40px; line-height: 40px; font-size: 1.3rem; font-weight: bold; }

        /* Media Section */
        .media-section { height: 280px; display: flex; gap: 10px; flex-shrink: 0; }
        .media-box { flex: 1; background: #000; border: 3px solid #333; border-radius: 8px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
        .media-label { position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.7); color: #fff; padding: 4px 10px; font-size: 1rem; z-index: 10; border-bottom-right-radius: 8px; }
        
        .carousel-img { width: 100%; height: 100%; object-fit: contain; position: absolute; opacity: 0; transition: opacity 1s; }
        .carousel-img.active { opacity: 1; }
        .video-iframe { width: 100%; height: 100%; border: none; }

        /* Status & Time */
        .status-ontime { color: #4CAF50; } .status-delay { color: #ff1744; animation: blink 1s infinite alternate; }
        .time-delay-container { display: flex; justify-content: center; gap: 5px; align-items: center; }
        .original-time { text-decoration: line-through; color: #777; font-size: 1rem; }
        .expected-time { color: #4fc3f7; font-weight: bold; }
        
        .train-type-badge { display: inline-block; padding: 2px 5px; border-radius: 4px; color: white; font-size: 1.3rem; min-width: 100px; }
        .type-è‡ªå¼· { background: #FF5722; } .type-è‡ªå¼·3000 { background: #333; border: 1px solid #999; } .type-æ™®æ‚ ç‘ª { background: #E91E63; } .type-å€é–“ { background: #2196F3; } .type-å€é–“å¿« { background: #3F51B5; } .type-è’å…‰ { background: #FF9800; }

        .highlight-row { background-color: rgba(255, 255, 255, 0.15) !important; box-shadow: inset 0 0 15px rgba(255, 235, 59, 0.15); border: 2px solid #ffeb3b !important; }
        .platform-text { color: #FFD700; font-family: Consolas; font-weight: bold; }

        @keyframes blink { from { opacity: 1; } to { opacity: 0.6; } }

        @media (max-width: 900px) {
            body { height: auto; overflow-y: auto; }
            .pids-section { flex-direction: column; } .media-section { flex-direction: column; height: auto; } .media-box { height: 250px; margin-bottom: 10px; }
        }
    </style>
    <script src="assets/station-code-mapping.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="unified-header">
        <div class="station-branding">
            <img src="https://www.railway.gov.tw/tra-tip-web/static/images/TRA_logo.jpg" class="tra-logo-img">
            <div style="display:flex;align-items:baseline;gap:10px;">
                <div class="station-name" id="unifiedStationName">è‡ºéµè»Šç«™</div>
                <div class="station-sub" id="station-en">TRA STATION</div>
            </div>
        </div>
        <div class="datetime-block">
            <div class="date-text" id="unifiedDate"></div>
            <div class="time-text" id="unifiedTime"></div>
        </div>
    </div>

    <!-- Marquee -->
    <div class="unified-marquee-container">
        <div class="marquee-text" id="unifiedTopMarquee">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- PIDS -->
    <div class="pids-section">
        <!-- é€†è¡Œ -->
        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-1"><span id="dirTitle1">é€†è¡Œ</span><span id="destList1" style="font-size:1rem"></span></div>
                <table class="train-table table-1">
                    <thead>
                        <tr>
                            <th style="width:15%">è»Šæ¬¡</th>
                            <th style="width:18%">è»Šç¨®</th>
                            <th style="width:22%">æ™‚é–“</th>
                            <th style="width:23%">é–‹å¾€</th>
                            <th style="width:8%">æœˆå°</th>
                            <th style="width:14%">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="body1"></tbody>
                </table>
            </div>
            <div class="marquee-footer"><div class="marquee-text" id="marquee1">è®€å–ä¸­...</div></div>
        </div>
        <!-- é †è¡Œ -->
        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-0"><span id="dirTitle0">é †è¡Œ</span><span id="destList0" style="font-size:1rem"></span></div>
                <table class="train-table table-0">
                    <thead>
                        <tr>
                            <th style="width:15%">è»Šæ¬¡</th>
                            <th style="width:18%">è»Šç¨®</th>
                            <th style="width:22%">æ™‚é–“</th>
                            <th style="width:23%">é–‹å¾€</th>
                            <th style="width:8%">æœˆå°</th>
                            <th style="width:14%">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="body0"></tbody>
                </table>
            </div>
            <div class="marquee-footer"><div class="marquee-text" id="marquee0">è®€å–ä¸­...</div></div>
        </div>
    </div>

    <!-- Media -->
    <div class="media-section">
        <div class="media-box" id="carouselBox">
            <div class="media-label">å®£å°è³‡è¨Š</div>
            <img src="https://www.railway.gov.tw/tra-tip-web/static/images/hero-bg-01.jpg" class="carousel-img active">
        </div>
        <div class="media-box" id="videoBox">
            <div class="media-label">å½±éŸ³å°ˆå€</div>
            <div id="videoContainer" style="width:100%;height:100%"></div>
        </div>
    </div>

    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script>
        const WORKER_URL = "https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev";
        let GLOBAL_ID = ""; const MAX_ROWS = 5;
        const TRAIN_TYPES = { "1100":"è‡ªå¼·","1101":"å¤ªé­¯é–£","1102":"è‡ªå¼·","1107":"æ™®æ‚ ç‘ª","110B":"æ–°è‡ªå¼·","1110":"è’å…‰","1131":"å€é–“","1132":"å€é–“å¿«","1140":"æ™®å¿«" };
        const stopsCache = {};

        function getInfo(t) {
            let name = t.TrainTypeName?.Zh_tw || TRAIN_TYPES[t.TrainTypeID] || 'åˆ—è»Š';
            let cls = 'å…¶ä»–';
            if(name.includes('æ–°è‡ªå¼·')||name.includes('3000')) { name='æ–°è‡ªå¼·'; cls='è‡ªå¼·3000'; }
            else if(name.includes('æ™®æ‚ ç‘ª')) { cls='æ™®æ‚ ç‘ª'; }
            else if(name.includes('å¤ªé­¯é–£')) { cls='å¤ªé­¯é–£'; }
            else if(name.includes('è‡ªå¼·')) { cls='è‡ªå¼·'; }
            else if(name.includes('è’å…‰')) { cls='è’å…‰'; }
            else if(name.includes('å€é–“å¿«')) { cls='å€é–“å¿«'; }
            else if(name.includes('å€é–“')) { cls='å€é–“'; }
            return { name, cls };
        }

        async function fetchStops(no) {
            if(stopsCache[no]) return stopsCache[no];
            try {
                let r = await fetch(`${WORKER_URL}/api/schedule?trainNo=${no}`);
                let d = await r.json();
                if(d.length) { stopsCache[no] = d[0].StopTimes; return d[0].StopTimes; }
            } catch(e){} return [];
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('unifiedTime').innerText = now.toLocaleTimeString('en-GB');
            document.getElementById('unifiedDate').innerText = now.toISOString().split('T')[0].replace(/-/g,'/');
        }
        setInterval(updateClock, 1000);

        // ğŸ”¥ Media Assets (å‹•æ…‹è¼‰å…¥å¾Œå°è¨­å®š)
        async function updateMedia() {
            try {
                const res = await fetch(`${WORKER_URL}/api/pids/assets`);
                const data = await res.json();
                
                // åœ–ç‰‡è¼ªæ’­
                if(data.images && data.images.length > 0) setupCarousel(data.images);
                
                // å½±ç‰‡æ’­æ”¾
                if(data.video) setupVideo(data.video);
                
            } catch(e) { console.warn("Media Load Error", e); }
        }

        let carTimer;
        function setupCarousel(imgs) {
            const box = document.getElementById('carouselBox');
            box.querySelectorAll('img').forEach(i=>i.remove());
            imgs.forEach((src,i) => {
                const img = document.createElement('img');
                img.src = src; img.className = i===0?'carousel-img active':'carousel-img';
                box.appendChild(img);
            });
            let idx = 0;
            if(carTimer) clearInterval(carTimer);
            carTimer = setInterval(() => {
                const list = box.querySelectorAll('img');
                if(list.length>1) {
                    list[idx].classList.remove('active');
                    idx = (idx+1)%list.length;
                    list[idx].classList.add('active');
                }
            }, 10000);
        }

        function setupVideo(url) {
            const con = document.getElementById('videoContainer');
            let vid = "";
            if(url.includes('youtube') || url.includes('youtu.be')) {
                if(url.includes('v=')) vid = url.split('v=')[1];
                else if(url.includes('embed/')) vid = url.split('embed/')[1];
                else vid = url.split('/').pop();
                vid = vid.split('&')[0];
                con.innerHTML = `<iframe class="video-iframe" src="https://www.youtube.com/embed/${vid}?autoplay=1&mute=1&loop=1&playlist=${vid}&controls=0" allow="autoplay; encrypted-media"></iframe>`;
            } else {
                con.innerHTML = `<video src="${url}" autoplay muted loop playsinline style="width:100%;height:100%;object-fit:contain;"></video>`;
            }
        }

        // Marquee Animation
        function runMarquee(id) {
            const el = document.getElementById(id);
            if(!el) return;
            el.style.animation = 'none'; el.offsetHeight;
            const dur = (el.scrollWidth + el.parentElement.offsetWidth) / 100; 
            el.style.transition = `left ${dur}s linear`;
            el.style.left = '100%';
            requestAnimationFrame(() => el.style.left = `-${el.scrollWidth}px`);
            el.ontransitionend = () => {
                el.style.transition = 'none'; el.style.left = '100%';
                requestAnimationFrame(() => {
                    el.style.transition = `left ${dur}s linear`;
                    el.style.left = `-${el.scrollWidth}px`;
                });
            };
        }

        // PIDS Data
        async function updatePids(id) {
            try {
                let r = await fetch(`${WORKER_URL}/api/liveboard/station?station=${id}`);
                let d = await r.json();
                
                // Sort
                d.forEach(t => {
                    let [h,m] = (t.ScheduledDepartureTime||"00:00").split(':').map(Number);
                    t._sort = (h*60+m) + (t.IsTomorrow?1440:0) + (parseInt(t.DelayTime||0));
                });
                d.sort((a,b) => a._sort - b._sort);

                let t1 = d.filter(t=>t.Direction==1), t0 = d.filter(t=>t.Direction==0);
                renderTable('1', t1); renderTable('0', t0);
                await updateMarquee('marquee1', t1); runMarquee('marquee1');
                await updateMarquee('marquee0', t0); runMarquee('marquee0');

            } catch(e) { renderTable('1',[]); renderTable('0',[]); }
        }

        function renderTable(dir, list) {
            const tb = document.getElementById(`body${dir}`);
            tb.innerHTML = '';
            document.getElementById(`destList${dir}`).innerText = dir==='1'?'åŒ—ä¸Š (Northbound)':'å—ä¸‹ (Southbound)';
            
            list.slice(0, MAX_ROWS).forEach((t, i) => {
                let info = getInfo(t);
                let delay = parseInt(t.DelayTime||0);
                let status = delay>0 ? `æ™š ${delay} åˆ†` : 'æº–é»';
                let cls = delay>0 ? 'status-delay' : 'status-ontime';
                
                let timeStr = (t.ScheduledDepartureTime||"").slice(0,5);
                let timeHtml = `<span style="font-family:Consolas;font-size:1.6rem">${timeStr}</span>`;
                
                if(delay>0) {
                    let [h,m] = timeStr.split(':').map(Number);
                    let min = h*60+m+delay;
                    let newT = `${String(Math.floor(min/60)%24).padStart(2,'0')}:${String(min%60).padStart(2,'0')}`;
                    timeHtml = `<div class="time-delay-container"><span class="original-time">${timeStr}</span><span class="expected-time">${newT}</span></div>`;
                }

                let dest = t.EndingStationName + (t.TripLine==1?' (å±±)':(t.TripLine==2?' (æµ·)':''));
                let plat = t.Platform || "";

                let tr = document.createElement('tr');
                if(i===0) tr.classList.add('highlight-row');
                tr.innerHTML = `
                    <td style="font-family:Consolas">${t.TrainNo}</td>
                    <td><span class="train-type-badge type-${info.cls}">${info.name}</span></td>
                    <td>${timeHtml}</td>
                    <td>${dest}</td>
                    <td class="platform-text">${plat}</td>
                    <td class="${cls}">${status}</td>
                `;
                tb.appendChild(tr);
            });
            for(let i=Math.min(list.length, MAX_ROWS); i<MAX_ROWS; i++) tb.innerHTML+='<tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>';
        }

        async function updateMarquee(elId, list) {
            const el = document.getElementById(elId);
            if(!list.length) { el.innerText="ç„¡åˆ—è»Šè³‡è¨Š"; return; }
            let t = list[0];
            let info = getInfo(t);
            let msg = `${t.TrainNo} æ¬¡ ${info.name} å¾€ ${t.EndingStationName} | `;
            
            let stops = await fetchStops(t.TrainNo);
            if(stops.length) {
                let idx = stops.findIndex(s=>s.StationID==GLOBAL_ID);
                if(idx!=-1) {
                    let next = stops.slice(idx+1).map(s=>s.StationName.Zh_tw).join('ã€');
                    msg += next ? `æ²¿é€”åœé ï¼š${next}` : `æœ¬ç«™ç‚ºçµ‚é»ç«™`;
                }
            } else msg += "æº–é»ç‡ 99%";
            el.innerHTML = `<span style="color:#ffeb3b;font-weight:bold">${msg}</span>`;
        }

        async function checkTop() {
            try {
                let r = await fetch(`${WORKER_URL}/api/pids/marquee`);
                let d = await r.json();
                let el = document.getElementById('unifiedTopMarquee');
                if(d.text && el.innerText!==d.text) { el.innerText=d.text; runMarquee('unifiedTopMarquee'); }
            } catch(e){}
        }

        document.addEventListener('DOMContentLoaded', () => {
            const p = new URLSearchParams(location.search);
            GLOBAL_ID = p.get('station');
            let name = p.get('name')||'è‡ºéµ';
            document.getElementById('unifiedStationName').innerText = name.replace(/è»Šç«™$|ç«™$/,'')+'è»Šç«™';
            if(window.stationDataMap && stationDataMap[GLOBAL_ID]) {
                document.getElementById('station-en').innerText = stationDataMap[GLOBAL_ID].ename.split('_')[0].toUpperCase()+' STATION';
            }
            
            updateClock();
            updateMedia();
            if(GLOBAL_ID) { updatePids(GLOBAL_ID); setInterval(()=>updatePids(GLOBAL_ID), 60000); }
            checkTop(); setTimeout(()=>runMarquee('unifiedTopMarquee'), 1000); setInterval(checkTop, 30000);
        });
    </script>
</body>
</html>
