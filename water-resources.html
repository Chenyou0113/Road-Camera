<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´åˆ©ç½²ç›£è¦–å™¨å½±åƒç³»çµ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            text-align: center;
            color: #1976D2;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
        }

        .filter-tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 2px solid #1976D2;
            background: white;
            color: #1976D2;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .tab-btn.active,
        .tab-btn:hover {
            background: #1976D2;
            color: white;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px auto;
            max-width: 1000px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 10px;
        }

        .stat-time {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1565C0;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .search-section {
            background: white;
            margin: 30px auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            max-width: 1000px;
        }

        .search-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group select,
        .form-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #1976D2;
        }

        .search-btn {
            background: linear-gradient(45deg, #1976D2, #1565C0);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
        }

        .refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #45a049;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2rem;
        }

        .cameras-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin: 30px 0;
        }
        
        @media (max-width: 1200px) {
            .cameras-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .cameras-grid {
                grid-template-columns: 1fr;
            }
        }

        .camera-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .camera-card:hover {
            transform: translateY(-5px);
        }

        .camera-image {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.1rem;
            position: relative;
            overflow: hidden;
        }

        .camera-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-info {
            padding: 20px;
        }

        .camera-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 10px;
        }

        .camera-details {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .camera-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .back-btn {
            display: inline-block;
            padding: 12px 25px;
            background: #1976D2;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin: 20px 0;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: #1565C0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .modal-image {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 10px;
        }

        .modal-info {
            margin-top: 20px;
        }

        .modal-info h2 {
            color: #1976D2;
            margin-bottom: 15px;
        }

        .modal-info p {
            color: #666;
            margin: 8px 0;
            line-height: 1.6;
        }

        .authority-badge {
            background: linear-gradient(45deg, #1976D2, #1565C0);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-bottom: 10px;
            display: inline-block;
        }

        @media (max-width: 992px) {
            .search-form {
                grid-template-columns: 1fr 1fr auto;
            }
        }

        @media (max-width: 768px) {
            .search-form {
                grid-template-columns: 1fr;
            }
            
            .cameras-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .stats-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-panel {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-water"></i> æ°´åˆ©ç½²ç›£è¦–å™¨å½±åƒç³»çµ±</h1>
            <p>ç¶“æ¿Ÿéƒ¨æ°´åˆ©ç½²å³æ™‚ç›£æ§å½±åƒç³»çµ±</p>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é </a>
        
        <!-- æ°´åˆ©ç½²ç›£æ¸¬å½±åƒèªªæ˜ -->
        <div id="infoPanel" style="background: #e3f2fd; border-left: 4px solid #1976D2; padding: 20px; margin: 20px 0; border-radius: 8px; transition: all 0.3s ease;">
            <h3 style="color: #1976D2; margin: 0 0 15px 0; display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleInfoPanel()">
                <span>
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    æ°´åˆ©ç½²ç›£æ¸¬å½±åƒèªªæ˜
                </span>
                <i id="toggleIcon" class="fas fa-chevron-up" style="transition: transform 0.3s ease;"></i>
            </h3>
            <div id="infoContent" style="color: #333; line-height: 1.6;">
                <p style="margin: 0 0 10px 0;">
                    æ°´åˆ©ç½²è¦–è¨Šç›£æ¸¬å½±æ ¼ç…§ç‰‡ç”±<strong>ç¶“æ¿Ÿéƒ¨æ°´åˆ©ç½²</strong>ç¨è‡ªå»ºç½®ç®¡ç†ï¼Œç”¨æ–¼ç›£æ¸¬æ²³å·ã€æ°´åº«ç­‰æ°´åˆ©è¨­æ–½ã€‚
                </p>
                
                <div style="margin: 15px 0;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">ğŸ“ æ‚¨å¯ä»¥å‰å¾€ä»¥ä¸‹å®˜æ–¹ç¶²ç«™æŸ¥çœ‹å³æ™‚æ°´åˆ©ç›£æ¸¬è³‡è¨Šï¼š</p>
                    <div style="margin-left: 20px;">
                        <p style="margin: 5px 0;">
                            â€¢ <a href="https://fhy.wra.gov.tw" target="_blank" style="color: #1976D2; text-decoration: none;">
                                ç¶“æ¿Ÿéƒ¨æ°´åˆ©ç½²é˜²ç½è³‡è¨Šæœå‹™ç¶² <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                        <p style="margin: 5px 0;">
                            â€¢ <a href="https://www.wra.gov.tw" target="_blank" style="color: #1976D2; text-decoration: none;">
                                ç¶“æ¿Ÿéƒ¨æ°´åˆ©ç½²å®˜ç¶² <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                    </div>
                </div>
                
                <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: #666; font-style: italic;">
                    ğŸ’¡ å¦‚éœ€æ•´åˆæ°´åˆ©ç½²ç›£æ¸¬å½±åƒè³‡æ–™ï¼Œè«‹è¯ç¹«æ°´åˆ©ç½²ç”³è«‹ç›¸é—œ API æ¬Šé™ã€‚
                </p>
            </div>
        </div>
        
        <!-- è³‡æ–™æºç¯©é¸æ¨™ç±¤ -->
        <div class="filter-tabs">
            <button class="tab-btn active" onclick="switchDataSource('all')">å…¨éƒ¨ç›£è¦–å™¨</button>
            <button class="tab-btn" onclick="openDebugPage()" style="background: #FF9800; margin-left: 10px;">
                <i class="fas fa-bug"></i> é™¤éŒ¯å·¥å…·
            </button>
        </div>

        <!-- çµ±è¨ˆé¢æ¿ -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-number" id="totalCameras">0</div>
                <div class="stat-label">ç¸½ç›£è¦–å™¨æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="wraCameras">0</div>
                <div class="stat-label">æ°´åˆ©ç½²ç›´è½„</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cooperativeCameras">0</div>
                <div class="stat-label">åœ°æ–¹åˆå»º</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="onlineCameras">0</div>
                <div class="stat-label">æœ‰å½±åƒç›£è¦–å™¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-time" id="currentTime"></div>
                <div class="stat-label">ç›®å‰æ™‚é–“</div>
            </div>
        </div>

        <div class="search-section">
            <div class="search-form">
                <div class="form-group">
                    <label for="filterAuthority">ä¸»ç®¡æ©Ÿé—œ</label>
                    <select id="filterAuthority">
                        <option value="all">å…¨éƒ¨æ©Ÿé—œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterStatus">å½±åƒç‹€æ…‹</label>
                    <select id="filterStatus">
                        <option value="all">å…¨éƒ¨ç›£è¦–å™¨</option>
                        <option value="with-image">æœ‰å½±åƒ</option>
                        <option value="no-image">ç„¡å½±åƒ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sortBy">æ’åºæ–¹å¼</label>
                    <select id="sortBy">
                        <option value="name">åç¨±æ’åº</option>
                        <option value="location">ä½ç½®æ’åº</option>
                        <option value="update-time">æ›´æ–°æ™‚é–“</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="keyword">æœå°‹é—œéµå­—</label>
                    <input type="text" id="keyword" placeholder="è¼¸å…¥ç›£è¦–å™¨åç¨±ã€ä½ç½®æˆ–èªªæ˜">
                </div>
                <div>
                    <button class="search-btn" onclick="filterCameras()">æœå°‹</button>
                    <button class="refresh-btn" onclick="loadCameras()"><i class="fas fa-sync-alt"></i> é‡æ–°è¼‰å…¥</button>
                </div>
            </div>
        </div>

        <div id="cameras-container" class="loading">è¼‰å…¥æ°´åˆ©ç½²ç›£è¦–å™¨è³‡æ–™ä¸­...</div>
    </div>

    <!-- ç›£è¦–å™¨å½±åƒå½ˆçª— -->
    <div id="cameraModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <img id="modalImage" class="modal-image" src="" alt="ç›£è¦–å™¨å½±åƒ">
            <div class="modal-info">
                <h2 id="modalTitle">ç›£è¦–å™¨è³‡è¨Š</h2>
                <p id="modalDescription"></p>
                <p id="modalLocation"></p>
                <p id="modalAuthority"></p>
                <p id="modalStationID"></p>
                <p id="modalUpdateTime"></p>
                <p id="modalCoordinates"></p>
            </div>
        </div>
    </div>

    <script>
        let allCameras = [];
        let filteredCameras = [];
        let currentDataSource = 'all';
        
        // è™•ç†ä¸»ç®¡æ©Ÿé—œé¡¯ç¤º - å¾æè¿°ä¸­æå–å…·é«”çš„æ²³å·åˆ†ç½²æˆ–åœ°æ–¹æ”¿åºœéƒ¨é–€
        function formatAuthority(camera) {
            const thing = camera.Thing || {};
            const authority = thing.properties?.authority || '';
            const description = thing.description || thing.properties?.description || '';
            const name = thing.name || '';
            const location = thing.properties?.location || thing.properties?.stationName || name || '';
            
            // å¦‚æœä¾†è‡ªæ°´åˆ©ç½²å®˜æ–¹APIï¼Œä¸”å·²ç¶“æœ‰æ­£ç¢ºçš„æ²³å·åˆ†ç½²è³‡è¨Šï¼Œç›´æ¥ä½¿ç”¨
            if (camera.source === 'wra_official' && authority && authority.includes('æ²³å·åˆ†ç½²')) {
                return authority;
            }
            
            // å¦‚æœ authority æ˜¯ã€Œæ°´åˆ©ç½²ã€ï¼Œå˜—è©¦å¾ description æˆ– name ä¸­æå–æ²³å·åˆ†ç½²è³‡è¨Š
            if (authority === 'æ°´åˆ©ç½²') {
                // å„ªå…ˆå°‹æ‰¾ç›´æ¥æåˆ°çš„æ²³å·åˆ†ç½²è³‡è¨Š
                const riverBureauMatch = description.match(/ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+æ²³å·åˆ†ç½²|ç¬¬\d+æ²³å·åˆ†ç½²/) || 
                                        name.match(/ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+æ²³å·åˆ†ç½²|ç¬¬\d+æ²³å·åˆ†ç½²/) ||
                                        location.match(/ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+æ²³å·åˆ†ç½²|ç¬¬\d+æ²³å·åˆ†ç½²/);
                if (riverBureauMatch) {
                    return riverBureauMatch[0];
                }
                
                // å¦‚æœæ²’æœ‰ç›´æ¥æåˆ°åˆ†ç½²ï¼Œæ ¹æ“šåœ°ç†ä½ç½®æ¨æ–·æ²³å·åˆ†ç½²ç®¡è½„ç¯„åœ
                const locationStr = location.toLowerCase();
                
                // ç¬¬ä¸€æ²³å·åˆ†ç½²ï¼šåŸºéš†ã€å°åŒ—ã€æ–°åŒ—ã€æ¡ƒåœ’ã€æ–°ç«¹
                if (locationStr.includes('åŸºéš†') || locationStr.includes('å°åŒ—') || locationStr.includes('è‡ºåŒ—') || 
                    locationStr.includes('æ–°åŒ—') || locationStr.includes('æ¡ƒåœ’') || locationStr.includes('æ–°ç«¹') ||
                    locationStr.includes('æ·¡æ°´æ²³') || locationStr.includes('åŸºéš†æ²³') || locationStr.includes('æ–°åº—æºª') ||
                    locationStr.includes('å¤§æ¼¢æºª') || locationStr.includes('æ™¯ç¾æºª') || locationStr.includes('é ­å‰æºª') ||
                    locationStr.includes('ä¸­åŸ') || locationStr.includes('ä¸­å£¢') || locationStr.includes('å¹³é®') ||
                    locationStr.includes('é¾æ½­') || locationStr.includes('æ¥Šæ¢…') || locationStr.includes('ç«¹åŒ—') ||
                    locationStr.includes('ä¸‰å³½') || locationStr.includes('æ±´å­é ­') || locationStr.includes('ä¿¡ç¾©') ||
                    locationStr.includes('æ–‡å±±')) {
                    return 'ç¬¬ä¸€æ²³å·åˆ†ç½²';
                }
                
                // ç¬¬äºŒæ²³å·åˆ†ç½²ï¼šè‹—æ —ã€å°ä¸­ã€å—æŠ•
                if (locationStr.includes('è‹—æ —') || locationStr.includes('å°ä¸­') || locationStr.includes('è‡ºä¸­') ||
                    locationStr.includes('å—æŠ•') || locationStr.includes('å¾Œé¾æºª') || locationStr.includes('å¤§å®‰æºª') ||
                    locationStr.includes('å¤§ç”²æºª') || locationStr.includes('çƒæºª') || locationStr.includes('æ¿æ°´æºªä¸Šæ¸¸') ||
                    locationStr.includes('é ­ä»½') || locationStr.includes('ç«¹å—') || locationStr.includes('è±åŸ') ||
                    locationStr.includes('æ²™é¹¿') || locationStr.includes('æ¸…æ°´') || locationStr.includes('è‰å±¯') ||
                    locationStr.includes('ç­å­æºª') || locationStr.includes('ä¸­ç§‘') || locationStr.includes('é€£ä»”æ©‹') ||
                    locationStr.includes('åœ“æ½­') || locationStr.includes('ä¸­åŸ”')) {
                    return 'ç¬¬äºŒæ²³å·åˆ†ç½²';
                }
                
                // ç¬¬ä¸‰æ²³å·åˆ†ç½²ï¼šé›²æ—ã€å˜‰ç¾©
                if (locationStr.includes('é›²æ—') || locationStr.includes('å˜‰ç¾©') ||
                    locationStr.includes('æ¿æ°´æºª') || locationStr.includes('åŒ—æ¸¯æºª') || locationStr.includes('æœ´å­æºª') ||
                    locationStr.includes('è¥¿èº') || locationStr.includes('è™å°¾') || locationStr.includes('æ–—å…­') ||
                    locationStr.includes('æœ´å­') || locationStr.includes('æ°‘é›„') || locationStr.includes('æ°´ä¸Š')) {
                    return 'ç¬¬ä¸‰æ²³å·åˆ†ç½²';
                }
                
                // ç¬¬å››æ²³å·åˆ†ç½²ï¼šå½°åŒ–ã€å°å—ã€é«˜é›„ã€å±æ±
                if (locationStr.includes('å½°åŒ–') || locationStr.includes('ä¼¸æ¸¯') ||
                    locationStr.includes('å°å—') || locationStr.includes('è‡ºå—') || 
                    locationStr.includes('é«˜é›„') || locationStr.includes('å±æ±') ||
                    locationStr.includes('æ›¾æ–‡æºª') || locationStr.includes('é¹½æ°´æºª') || locationStr.includes('äºŒä»æºª') ||
                    locationStr.includes('é˜¿å…¬åº—æºª') || locationStr.includes('æ„›æ²³') || locationStr.includes('é«˜å±æºª') ||
                    locationStr.includes('æ±æ¸¯æºª') || locationStr.includes('æ—é‚Šæºª') ||
                    locationStr.includes('å¤§éµ¬') || locationStr.includes('å²¡å±±') || locationStr.includes('é³³å±±') ||
                    locationStr.includes('æ——å±±') || locationStr.includes('ç¾æ¿ƒ') || locationStr.includes('å…­é¾œ') ||
                    locationStr.includes('æ¹³ä»”æº') || locationStr.includes('å±±ä¸Š') || locationStr.includes('èœå…¬å¯®') ||
                    locationStr.includes('æ¥ æ¢“') || locationStr.includes('ç¾ä¸Šç¾')) {
                    return 'ç¬¬å››æ²³å·åˆ†ç½²';
                }
                
                // ç¬¬äº”æ²³å·åˆ†ç½²ï¼šå®œè˜­ã€èŠ±è“®
                if (locationStr.includes('å®œè˜­') || locationStr.includes('èŠ±è“®') ||
                    locationStr.includes('è˜­é™½æºª') || locationStr.includes('ç«‹éœ§æºª') || locationStr.includes('èŠ±è“®æºª') ||
                    locationStr.includes('ç§€å§‘å·’æºª') || locationStr.includes('å˜‰å¯¶æ½­') || locationStr.includes('ç¾…æ±') ||
                    locationStr.includes('ç¤æºª') || locationStr.includes('å£¯åœ') || locationStr.includes('å‰å®‰') ||
                    locationStr.includes('æ–°åŸ') || locationStr.includes('ç§€æ—') || locationStr.includes('ç‰é‡Œ')) {
                    return 'ç¬¬äº”æ²³å·åˆ†ç½²';
                }
                
                // ç¬¬å…­æ²³å·åˆ†ç½²ï¼šå°æ±
                if (locationStr.includes('å°æ±') || locationStr.includes('è‡ºæ±') ||
                    locationStr.includes('å‘å—æºª') || locationStr.includes('å¤ªéº»é‡Œæºª') || locationStr.includes('çŸ¥æœ¬æºª') ||
                    locationStr.includes('é¸å±±')) {
                    return 'ç¬¬å…­æ²³å·åˆ†ç½²';
                }
                
                // ç¬¬ä¸ƒæ²³å·åˆ†ç½²ï¼šæ¾æ¹–ã€é‡‘é–€ã€é¦¬ç¥–ï¼ˆé›¢å³¶ï¼‰
                if (locationStr.includes('æ¾æ¹–') || locationStr.includes('é‡‘é–€') || locationStr.includes('é¦¬ç¥–')) {
                    return 'ç¬¬ä¸ƒæ²³å·åˆ†ç½²';
                }
                
                // å°æ–¼ç„¡æ³•å¾åœ°ååˆ¤æ–·çš„ç›£è¦–å™¨ï¼Œå˜—è©¦å¾å…¶ä»–è³‡è¨Šæ¨æ–·
                // é¦–å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºç·¨è™Ÿå¼ç›£è¦–å™¨
                if (locationStr.match(/^[a-z]\d+$|^[A-Z]\d+$/)) {  // ç´”ç·¨è™Ÿå¼ç›£è¦–å™¨(å¦‚ C8, B6)
                    console.log(`ç›£è¦–å™¨ç·¨è™Ÿ ${location} ç„¡æ³•ç¢ºå®šåˆ†ç½²ï¼Œæš«æ™‚æ­¸é¡ç‚ºç¬¬ä¸€æ²³å·åˆ†ç½²`);
                    return 'ç¬¬ä¸€æ²³å·åˆ†ç½²ï¼ˆå¾…ç¢ºèªï¼‰';
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æ²³å·æˆ–æ°´ç³»ç›¸é—œé—œéµå­—
                if (locationStr.includes('æºª') || locationStr.includes('æ²³') || locationStr.includes('æ©‹') ||
                    locationStr.includes('å ¤é˜²') || locationStr.includes('æŠ½æ°´ç«™') || locationStr.includes('æ°´é–€')) {
                    
                    // æ ¹æ“šå¸¸è¦‹çš„æ²³å·ç³»çµ±æ¨æ–·å¯èƒ½çš„åˆ†ç½²
                    if (locationStr.match(/[a-z]\d+|[A-Z]\d+/)) {  // åŒ…å«ç·¨è™Ÿçš„æ°´åˆ©è¨­æ–½
                        console.log(`æ°´åˆ©è¨­æ–½ ${location} ç„¡æ³•ç¢ºå®šåˆ†ç½²ï¼Œæš«æ™‚æ­¸é¡ç‚ºç¬¬ä¸€æ²³å·åˆ†ç½²`);
                        return 'ç¬¬ä¸€æ²³å·åˆ†ç½²ï¼ˆå¾…ç¢ºèªï¼‰';
                    }
                }
                
                // å¦‚æœæ‰¾ä¸åˆ°å…·é«”åˆ†ç½²ï¼Œè¿”å›ã€Œæ°´åˆ©ç½²ã€
                return 'æ°´åˆ©ç½²';
            }
            
            // å¦‚æœ authority æ˜¯ã€Œæ°´åˆ©ç½²ï¼ˆèˆ‡ç¸£å¸‚æ”¿åºœåˆå»ºï¼‰ã€ï¼Œå˜—è©¦å¾å…¶ä»–æ¬„ä½æ‰¾å‡ºå…·é«”çš„åœ°æ–¹æ”¿åºœéƒ¨é–€
            if (authority.includes('æ°´åˆ©ç½²') && authority.includes('åˆå»º')) {
                // å˜—è©¦å¾ description ä¸­æå–åœ°æ–¹æ”¿åºœè³‡è¨Šï¼ˆåŒ…å«å®Œæ•´çš„ç¸£å¸‚åç¨±ï¼‰
                const localGovMatch = description.match(/[\u4e00-\u9fa5]+[ç¸£å¸‚]æ”¿åºœ[\u4e00-\u9fa5]+[å±€ç§‘è™•]/);
                if (localGovMatch) {
                    return localGovMatch[0];
                }
                
                // å¾ä½ç½®è³‡è¨Šæ¨æ–·å…·é«”çš„åœ°æ–¹æ”¿åºœæ°´åˆ©å–®ä½
                const locationStr = location.toLowerCase();
                
                // å„ªå…ˆæª¢æŸ¥ç‰¹å®šåœ°åå’Œåœ°å€é—œéµå­—
                if (locationStr.includes('èŠ±è“®')) return 'èŠ±è“®ç¸£æ”¿åºœæ°´åˆ©ç§‘';
                if (locationStr.includes('å°ä¸­') || locationStr.includes('è‡ºä¸­')) return 'å°ä¸­å¸‚æ”¿åºœæ°´åˆ©å±€';
                if (locationStr.includes('æ–°åŒ—')) return 'æ–°åŒ—å¸‚æ”¿åºœæ°´åˆ©å±€';
                if (locationStr.includes('å°åŒ—') || locationStr.includes('è‡ºåŒ—') || locationStr.includes('ä¸­å±±æ±è·¯')) return 'å°åŒ—å¸‚æ”¿åºœæ°´åˆ©å±€';
                if (locationStr.includes('æ¡ƒåœ’') || locationStr.includes('é¾æ½­å€')) return 'æ¡ƒåœ’å¸‚æ”¿åºœæ°´å‹™å±€';
                if (locationStr.includes('é«˜é›„')) return 'é«˜é›„å¸‚æ”¿åºœæ°´åˆ©å±€';
                if (locationStr.includes('å°å—') || locationStr.includes('è‡ºå—')) return 'å°å—å¸‚æ”¿åºœæ°´åˆ©å±€';
                if (locationStr.includes('å½°åŒ–')) return 'å½°åŒ–ç¸£æ”¿åºœæ°´åˆ©ç§‘';
                if (locationStr.includes('é›²æ—')) return 'é›²æ—ç¸£æ”¿åºœæ°´åˆ©ç§‘';
                if (locationStr.includes('å˜‰ç¾©')) return 'å˜‰ç¾©ç¸£æ”¿åºœæ°´åˆ©ç§‘';
                if (locationStr.includes('å±æ±')) return 'å±æ±ç¸£æ”¿åºœæ°´åˆ©ç§‘';
                if (locationStr.includes('å®œè˜­')) return 'å®œè˜­ç¸£æ”¿åºœæ°´åˆ©ç§‘';
                if (locationStr.includes('å°æ±') || locationStr.includes('è‡ºæ±')) return 'å°æ±ç¸£æ”¿åºœæ°´åˆ©ç§‘';
                if (locationStr.includes('å—æŠ•')) return 'å—æŠ•ç¸£æ”¿åºœæ°´åˆ©ç§‘';
                if (locationStr.includes('è‹—æ —')) return 'è‹—æ —ç¸£æ”¿åºœæ°´åˆ©ç§‘';
                if (locationStr.includes('æ–°ç«¹')) return 'æ–°ç«¹ç¸£æ”¿åºœæ°´åˆ©ç§‘';
                if (locationStr.includes('åŸºéš†')) return 'åŸºéš†å¸‚æ”¿åºœéƒ½å¸‚ç™¼å±•è™•';
                if (locationStr.includes('æ¾æ¹–')) return 'æ¾æ¹–ç¸£æ”¿åºœæ°´åˆ©ç§‘';
                if (locationStr.includes('é‡‘é–€')) return 'é‡‘é–€ç¸£æ”¿åºœå»ºè¨­è™•';
                if (locationStr.includes('é€£æ±Ÿ') || locationStr.includes('é¦¬ç¥–')) return 'é€£æ±Ÿç¸£æ”¿åºœå»ºè¨­å±€';
                
                // æ ¹æ“šç›£è¦–å™¨ç·¨è™Ÿæˆ–ç‰¹æ®Šåœ°æ¨™æ¨æ–·
                if (locationStr.includes('c05') || locationStr.includes('å±±é¼»æ©‹')) {
                    // å±±é¼»æ©‹é€šå¸¸åœ¨é«˜é›„åœ°å€
                    return 'é«˜é›„å¸‚æ”¿åºœæ°´åˆ©å±€';
                }
                if (locationStr.includes('c08') || locationStr.includes('è¥¿å¡æ¸ ')) {
                    // è¥¿å¡æ¸ å¯èƒ½åœ¨å°ä¸­åœ°å€
                    return 'å°ä¸­å¸‚æ”¿åºœæ°´åˆ©å±€';
                }
                if (locationStr.includes('å£«æ ¡å¤§æ± ')) {
                    // å£«æ ¡å¤§æ± å¯èƒ½åœ¨æ¡ƒåœ’åœ°å€
                    return 'æ¡ƒåœ’å¸‚æ”¿åºœæ°´å‹™å±€';
                }
                if (locationStr.includes('ä¸­å±±è·¯') && !locationStr.includes('ä¸­å±±æ±è·¯')) {
                    // ä¸€èˆ¬ä¸­å±±è·¯ï¼Œéœ€è¦æ›´å¤šè³‡è¨Šï¼Œæš«æ™‚æ­¸é¡ç‚ºå°åŒ—å¸‚
                    return 'å°åŒ—å¸‚æ”¿åºœæ°´åˆ©å±€';
                }
                
                // å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œè¿”å›åŸå§‹ authority
                return authority;
            }
            
            // å…¶ä»–æƒ…æ³ç›´æ¥è¿”å› authority
            return authority || 'N/A';
        }
        
        // åˆ‡æ›è³‡è¨Šé¢æ¿é¡¯ç¤º/éš±è—
        function toggleInfoPanel() {
            const content = document.getElementById('infoContent');
            const icon = document.getElementById('toggleIcon');
            const panel = document.getElementById('infoPanel');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                icon.style.transform = 'rotate(0deg)';
                panel.style.background = '#e3f2fd';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                icon.style.transform = 'rotate(180deg)';
                panel.style.background = '#f5f5f5';
            }
        }
        
        // è™•ç†å½±åƒè¼‰å…¥éŒ¯èª¤
        function handleImageError(img, originalUrl, name) {
            console.warn(`å½±åƒè¼‰å…¥å¤±æ•—: ${name} - ${originalUrl}`);
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¤±æ•—ï¼Œå˜—è©¦æ·»åŠ æ™‚é–“æˆ³ä¾†é¿å…å¿«å–å•é¡Œ
            if (!img.dataset.retried) {
                console.log(`é‡è©¦è¼‰å…¥å½±åƒ: ${originalUrl}`);
                img.dataset.retried = 'true';
                const urlWithTimestamp = originalUrl + (originalUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
                img.src = urlWithTimestamp;
                return;
            }
            
            // é‡è©¦ä»å¤±æ•—ï¼Œä¿æŒé è¨­çš„ä½”ä½åœ–æ¡ˆï¼Œä½†é¡¯ç¤ºç‚ºç„¡æ³•è¼‰å…¥ç‹€æ…‹
            const placeholder = img.parentElement.querySelector('.image-placeholder');
            if (placeholder) {
                placeholder.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px; color: #FFB74D;"></i>
                    <span style="font-size: 0.9rem; text-align: center; padding: 0 10px;">å½±åƒæš«æ™‚ç„¡æ³•è¼‰å…¥</span>
                    <span style="font-size: 0.7rem; opacity: 0.8; margin-top: 5px;">é»æ“Šé–‹å•ŸåŸå§‹é€£çµ</span>
                    <div style="position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); background: rgba(255,183,77,0.3); padding: 2px 8px; border-radius: 10px; font-size: 0.6rem;">
                        è¼‰å…¥å¤±æ•—
                    </div>
                `;
                placeholder.style.background = 'linear-gradient(135deg, #FFB74D 0%, #FF8A65 100%)';
            }
            
            // ç§»é™¤å¤±æ•—çš„åœ–ç‰‡å…ƒç´ 
            img.style.display = 'none';
        }
        
        // é‡æ–°å˜—è©¦è¼‰å…¥å½±åƒ
        function retryLoadImage(url, name, button) {
            const container = button.parentElement;
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #1976D2;"></i>
                    <span style="font-size: 0.8rem; margin-top: 8px;">é‡æ–°è¼‰å…¥ä¸­...</span>
                </div>
            `;
            
            setTimeout(() => {
                const newImg = document.createElement('img');
                newImg.src = url + '?retry=' + Date.now();
                newImg.alt = name;
                newImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                newImg.crossOrigin = 'anonymous';
                newImg.onerror = () => handleImageError(newImg, url, name);
                newImg.onload = () => {
                    container.innerHTML = '';
                    container.appendChild(newImg);
                };
            }, 1000);
        }
        
        // é¡¯ç¤ºæˆåŠŸè¼‰å…¥çš„å½±åƒ
        function showLoadedImage(img) {
            console.log('å½±åƒæˆåŠŸè¼‰å…¥:', img.src);
            const placeholder = img.parentElement.querySelector('.image-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            img.style.opacity = '1';
        }
        
        // é–‹å•Ÿé™¤éŒ¯å·¥å…·é é¢
        function openDebugPage() {
            window.open('water-test.html', '_blank');
        }
        
        // åœ¨æ–°é é¢é–‹å•Ÿå½±åƒ
        function openImageInNewTab(url, name) {
            console.log('é–‹å•Ÿå½±åƒ:', url);
            
            // å‰µå»ºä¸€å€‹æ–°çš„é é¢ä¾†é¡¯ç¤ºå½±åƒ
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                <head>
                    <title>${name} - æ°´åˆ©ç½²ç›£æ¸¬å½±åƒ</title>
                    <style>
                        body { 
                            margin: 0; 
                            padding: 20px; 
                            background: #f0f0f0; 
                            font-family: Arial, sans-serif;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                        }
                        .header {
                            background: #1976D2;
                            color: white;
                            padding: 15px 30px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            text-align: center;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        }
                        .image-container {
                            background: white;
                            padding: 20px;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                            max-width: 90vw;
                            max-height: 80vh;
                        }
                        img {
                            max-width: 100%;
                            max-height: 70vh;
                            object-fit: contain;
                            border-radius: 8px;
                        }
                        .error-message {
                            color: #ff6b6b;
                            text-align: center;
                            padding: 40px;
                            font-size: 1.1rem;
                        }
                        .retry-btn {
                            background: #1976D2;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            margin-top: 15px;
                            font-size: 1rem;
                        }
                        .retry-btn:hover {
                            background: #1565C0;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>${name}</h2>
                        <p>ç¶“æ¿Ÿéƒ¨æ°´åˆ©ç½²ç›£æ¸¬å½±åƒ</p>
                    </div>
                    <div class="image-container">
                        <img src="${url}" alt="${name}" 
                             onerror="document.querySelector('.image-container').innerHTML='<div class=\\"error-message\\">å½±åƒè¼‰å…¥å¤±æ•—<br><small>${url}</small><br><button class=\\"retry-btn\\" onclick=\\"location.reload()\\">é‡æ–°è¼‰å…¥</button></div>'"
                             onload="console.log('å½±åƒè¼‰å…¥æˆåŠŸ')">
                    </div>
                    <div style="margin-top: 20px; text-align: center; color: #666; font-size: 0.9rem;">
                        <p>âš ï¸ å¦‚æœå½±åƒç„¡æ³•é¡¯ç¤ºï¼Œå¯èƒ½æ˜¯å› ç‚ºï¼š</p>
                        <ul style="text-align: left; display: inline-block;">
                            <li>æ°´åˆ©ç½²APIéœ€è¦ç‰¹æ®Šèªè­‰</li>
                            <li>ç¶²è·¯é€£ç·šå•é¡Œ</li>
                            <li>å½±åƒæš«æ™‚ä¸å¯ç”¨</li>
                        </ul>
                    </div>
                </body>
                </html>
            `);
        }

        async function loadCameras() {
            try {
                const container = document.getElementById('cameras-container');
                container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥æ°´åˆ©ç½²ç›£è¦–å™¨è³‡æ–™ä¸­...</div>';

                // å„ªå…ˆä½¿ç”¨æ°´åˆ©ç½²å®˜æ–¹ API
                let wraApiCameras = [];
                try {
                    console.log('ğŸ”„ å˜—è©¦è¼‰å…¥æ°´åˆ©ç½²å®˜æ–¹ API...');
                    const wraApiResponse = await fetch('https://fmg.wra.gov.tw/swagger/api/cctv_citynew');
                    if (wraApiResponse.ok) {
                        const wraApiData = await wraApiResponse.json();
                        if (wraApiData.cctvs && wraApiData.cctvs.length > 0) {
                            console.log(`âœ… æˆåŠŸè¼‰å…¥æ°´åˆ©ç½²å®˜æ–¹ API: ${wraApiData.cctvs.length} ç­†è³‡æ–™`);
                            wraApiCameras = wraApiData.cctvs.map(camera => ({
                                '@iot.id': `wra_${camera.cctv_name}_${camera.lat}_${camera.lon}`,
                                Thing: {
                                    name: camera.cctv_name,
                                    properties: {
                                        stationName: camera.cctv_name,
                                        authority: camera.wraunit_name || 'æ°´åˆ©ç½²',
                                        location: `${camera.city_name}${camera.town_name}`,
                                        station_name: camera.station_name
                                    },
                                    location: {
                                        coordinates: [camera.lon, camera.lat]
                                    }
                                },
                                Observations: camera.new_imgurl ? [{
                                    result: camera.new_imgurl,
                                    phenomenonTime: new Date().toISOString()
                                }] : [],
                                source: 'wra_official',
                                sourceLabel: 'æ°´åˆ©ç½²å®˜æ–¹API',
                                streamUrl: camera.stream_url
                            }));
                        }
                    }
                } catch (error) {
                    console.warn('âš ï¸ æ°´åˆ©ç½²å®˜æ–¹ API è¼‰å…¥å¤±æ•—ï¼Œæ”¹ç”¨ STA API:', error.message);
                }

                // å¦‚æœå®˜æ–¹APIç„¡è³‡æ–™æˆ–å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨çš„ STA API
                if (wraApiCameras.length === 0) {
                    console.log('ğŸ”„ ä½¿ç”¨ STA API è¼‰å…¥ç›£è¦–å™¨è³‡æ–™...');
                    
                    // å…ˆå˜—è©¦å…¨åŸŸæœå°‹äº†è§£ç¸½å…±æœ‰å¤šå°‘ç›£è¦–å™¨
                    try {
                        const allCamerasResponse = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$count=true&$top=0');
                        if (allCamerasResponse.ok) {
                            const allCamerasData = await allCamerasResponse.json();
                            console.log(`ğŸ“Š STA è³‡æ–™åº«ç¸½å…±æœ‰ ${allCamerasData['@iot.count']} å€‹ç›£è¦–å™¨`);
                        }
                    } catch (e) {
                        console.warn('ç„¡æ³•ç²å–ç¸½ç›£è¦–å™¨æ•¸é‡');
                    }
                    
                    // è¼‰å…¥æ°´åˆ©ç½²ç›´è½„ç›£è¦–å™¨
                    const wraResponse = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%27&$count=true');
                
                    // è¼‰å…¥æ°´åˆ©ç½²èˆ‡åœ°æ–¹æ”¿åºœåˆå»ºç›£è¦–å™¨
                    const cooperativeResponse = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%EF%BC%88%E8%88%87%E7%B8%A3%E5%B8%82%E6%94%BF%E5%BA%9C%E5%90%88%E5%BB%BA%EF%BC%89%27&$count=true');
                    
                    // å˜—è©¦è¼‰å…¥æ›´å¤šç›¸é—œçš„æ°´åˆ©å–®ä½
                    const extendedLocalResponses = await Promise.allSettled([
                        // åŸæœ‰çš„æŸ¥è©¢
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E8%8A%B1%E8%93%AE%E7%B8%A3%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%88%A9%E7%A7%91%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E8%8A%B1%E8%93%AE%E7%B8%A3%E6%94%BF%E5%BA%9C%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E8%8A%B1%E8%93%AE%E7%B8%A3%E5%BB%BA%E8%A8%AD%E8%99%95%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E5%8F%B0%E5%8C%97%E5%B8%82%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%88%A9%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E5%8F%B0%E5%8C%97%E5%B8%82%E6%94%BF%E5%BA%9C%E5%B7%A5%E5%8B%99%E5%B1%80%E6%B0%B4%E5%88%A9%E5%B7%A5%E7%A8%8B%E8%99%95%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%96%B0%E5%8C%97%E5%B8%82%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%88%A9%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%A1%83%E5%9C%92%E5%B8%82%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%8B%99%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E5%8F%B0%E4%B8%AD%E5%B8%82%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%88%A9%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E9%AB%98%E9%9B%84%E5%B8%82%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%88%A9%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E8%87%BA%E5%8C%97%E5%B8%82%E6%94%BF%E5%BA%9C%E5%B7%A5%E5%8B%99%E5%B1%80%27&$count=true'),
                        
                        // å˜—è©¦æ›´å»£æ³›çš„æœå°‹
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=contains(Thing/properties/authority,%27%E6%B0%B4%E5%88%A9%27)&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=contains(Thing/properties/authority,%27%E6%B2%B3%E5%B7%9D%27)&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=contains(Thing/properties/authority,%27%E5%88%86%E7%BD%B2%27)&$count=true'),
                        
                        // å…¶ä»–å¯èƒ½çš„æ°´åˆ©ç›¸é—œå–®ä½
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%B6%93%E6%BF%9F%E9%83%A8%E6%B0%B4%E5%88%A9%E7%BD%B2%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E4%B8%80%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E4%BA%8C%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E4%B8%89%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E5%9B%9B%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E4%BA%94%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E5%85%AD%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true')
                    ]);
                    
                    if (!wraResponse.ok || !cooperativeResponse.ok) {
                        throw new Error('API å›æ‡‰éŒ¯èª¤');
                    }

                    const wraData = await wraResponse.json();
                    const cooperativeData = await cooperativeResponse.json();
                    
                    // è™•ç†åœ°æ–¹æ”¿åºœæ°´åˆ©å–®ä½çš„å›æ‡‰
                    const localCameras = [];
                    for (const response of extendedLocalResponses) {
                        if (response.status === 'fulfilled' && response.value.ok) {
                            const data = await response.value.json();
                            if (data.value && data.value.length > 0) {
                                console.log(`æ‰¾åˆ°åœ°æ–¹æ°´åˆ©å–®ä½è³‡æ–™: ${data.value.length} ç­†`, data.value[0]?.Thing?.properties?.authority);
                                const cameras = data.value.map(camera => ({
                                    ...camera,
                                    source: 'local',
                                    sourceLabel: 'åœ°æ–¹æ°´åˆ©å–®ä½'
                                }));
                                localCameras.push(...cameras);
                            }
                        }
                    }
                    
                    console.log(`STA API è¼‰å…¥: æ°´åˆ©ç½² ${wraData.value?.length || 0} ç­†, åˆå»º ${cooperativeData.value?.length || 0} ç­†, åœ°æ–¹ ${localCameras.length} ç­†`);
                    
                    // åˆä½µSTA APIè³‡æ–™ä¸¦æ¨™è¨˜ä¾†æº
                    const wraCameras = (wraData.value || []).map(camera => ({
                        ...camera,
                        source: 'wra',
                        sourceLabel: 'æ°´åˆ©ç½²ç›´è½„'
                    }));

                    const cooperativeCameras = (cooperativeData.value || []).map(camera => ({
                        ...camera,
                        source: 'cooperative',
                        sourceLabel: 'æ°´åˆ©ç½²èˆ‡åœ°æ–¹åˆå»º'
                    }));
                    
                    // åˆä½µSTA APIçš„è³‡æ–™
                    const staCameras = [...wraCameras, ...cooperativeCameras, ...localCameras];
                    wraApiCameras = [...wraApiCameras, ...staCameras];
                }

                // å»é™¤é‡è¤‡é …ç›®ä¸¦åˆä½µè³‡æ–™
                const allCamerasMap = new Map();
                wraApiCameras.forEach(camera => {
                    const id = camera['@iot.id'];
                    if (!allCamerasMap.has(id)) {
                        allCamerasMap.set(id, camera);
                    }
                });
                
                allCameras = Array.from(allCamerasMap.values());
                
                if (allCameras.length === 0) {
                    container.innerHTML = '<div class="loading">ç„¡æ°´åˆ©ç½²ç›£è¦–å™¨è³‡æ–™</div>';
                    return;
                }

                filteredCameras = allCameras;
                
                updateStats();
                populateAuthorityFilter();
                applyCurrentFilter();
                
                console.log(`æˆåŠŸè¼‰å…¥ ${allCameras.length} å€‹æ°´åˆ©ç½²ç›£è¦–å™¨ (ç›´è½„: ${wraCameras.length}, åˆå»º: ${cooperativeCameras.length})`);
                
                // é™¤éŒ¯è³‡è¨Šï¼šæª¢æŸ¥å½±åƒURL
                const imagesWithUrl = allCameras.filter(c => c.Observations && c.Observations[0] && c.Observations[0].result);
                const imagesWithoutUrl = allCameras.filter(c => !c.Observations || !c.Observations[0] || !c.Observations[0].result);
                console.log(`æœ‰å½±åƒURL: ${imagesWithUrl.length}, ç„¡å½±åƒURL: ${imagesWithoutUrl.length}`);
                
                if (imagesWithUrl.length > 0) {
                    console.log('ç¯„ä¾‹å½±åƒURL:', imagesWithUrl[0].Observations[0].result);
                }
                
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                document.getElementById('cameras-container').innerHTML = 
                    `<div class="loading">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        è¼‰å…¥å¤±æ•—ï¼š${error.message}<br><br>
                        <button onclick="loadCameras()" class="search-btn">é‡æ–°å˜—è©¦</button>
                    </div>`;
            }
        }

        function switchDataSource(source) {
            currentDataSource = source;
            
            // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            applyCurrentFilter();
        }

        function applyCurrentFilter() {
            // æ ¹æ“šè³‡æ–™æºç¯©é¸
            let sourceFilteredCameras = allCameras;
            
            if (currentDataSource === 'wra') {
                sourceFilteredCameras = allCameras.filter(camera => camera.source === 'wra');
            } else if (currentDataSource === 'cooperative') {
                sourceFilteredCameras = allCameras.filter(camera => camera.source === 'cooperative');
            }
            
            // æ‡‰ç”¨å…¶ä»–ç¯©é¸æ¢ä»¶
            const filterAuthority = document.getElementById('filterAuthority').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const sortBy = document.getElementById('sortBy').value;
            const keyword = document.getElementById('keyword').value.toLowerCase().trim();

            filteredCameras = sourceFilteredCameras.filter(camera => {
                const thing = camera.Thing || {};
                const name = (thing.name || '').toLowerCase();
                const description = (thing.properties?.authority || '').toLowerCase();
                const location = (thing.properties?.location || '').toLowerCase();
                
                // ä¸»ç®¡æ©Ÿé—œç¯©é¸
                const cameraAuthority = formatAuthority(camera);
                const matchAuthority = filterAuthority === 'all' || cameraAuthority === filterAuthority;
                
                // é—œéµå­—ç¯©é¸
                const matchKeyword = !keyword || 
                    name.includes(keyword) || 
                    description.includes(keyword) || 
                    location.includes(keyword);

                // å½±åƒç‹€æ…‹ç¯©é¸
                const latestObs = camera.Observations && camera.Observations.length > 0 ? camera.Observations[0] : null;
                const hasImage = latestObs && latestObs.result && latestObs.result.trim() !== '';
                
                let matchStatus = true;
                if (filterStatus === 'with-image') {
                    matchStatus = hasImage;
                } else if (filterStatus === 'no-image') {
                    matchStatus = !hasImage;
                }

                return matchAuthority && matchKeyword && matchStatus;
            });

            // æ’åº
            filteredCameras.sort((a, b) => {
                const aName = a.Thing?.name || '';
                const bName = b.Thing?.name || '';
                const aLocation = a.Thing?.properties?.location || '';
                const bLocation = b.Thing?.properties?.location || '';
                const aTime = a.Observations?.[0]?.phenomenonTime || '';
                const bTime = b.Observations?.[0]?.phenomenonTime || '';

                switch(sortBy) {
                    case 'location':
                        return aLocation.localeCompare(bLocation, 'zh-TW');
                    case 'update-time':
                        return new Date(bTime) - new Date(aTime);
                    case 'name':
                    default:
                        return aName.localeCompare(bName, 'zh-TW');
                }
            });

            displayCameras();
        }

        function updateStats() {
            const total = allCameras.length;
            const wraCount = allCameras.filter(camera => camera.source === 'wra').length;
            const cooperativeCount = allCameras.filter(camera => camera.source === 'cooperative').length;
            const withImage = allCameras.filter(camera => {
                const latestObs = camera.Observations && camera.Observations.length > 0 ? camera.Observations[0] : null;
                return latestObs && latestObs.result && latestObs.result.trim() !== '';
            }).length;

            document.getElementById('totalCameras').textContent = total;
            document.getElementById('wraCameras').textContent = wraCount;
            document.getElementById('cooperativeCameras').textContent = cooperativeCount;
            document.getElementById('onlineCameras').textContent = withImage;
        }

        // å¡«å……ä¸»ç®¡æ©Ÿé—œç¯©é¸ä¸‹æ‹‰é¸å–®
        function populateAuthorityFilter() {
            const authorities = new Set();
            allCameras.forEach(camera => {
                const authority = formatAuthority(camera);
                if (authority && authority !== 'N/A') {
                    authorities.add(authority);
                }
            });
            
            const sortedAuthorities = Array.from(authorities).sort((a, b) => a.localeCompare(b, 'zh-TW'));
            
            const select = document.getElementById('filterAuthority');
            select.innerHTML = '<option value="all">å…¨éƒ¨æ©Ÿé—œ</option>';
            
            sortedAuthorities.forEach(authority => {
                const option = document.createElement('option');
                option.value = authority;
                option.textContent = `${authority} (${allCameras.filter(c => formatAuthority(c) === authority).length})`;
                select.appendChild(option);
            });
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        function filterCameras() {
            applyCurrentFilter();
        }

        function displayCameras() {
            const container = document.getElementById('cameras-container');
            
            if (filteredCameras.length === 0) {
                container.innerHTML = '<div class="loading">ç„¡ç¬¦åˆæ¢ä»¶çš„ç›£è¦–å™¨</div>';
                return;
            }
            
            console.log(`æº–å‚™é¡¯ç¤º ${filteredCameras.length} å€‹ç›£è¦–å™¨`);
            
            // é™¤éŒ¯ï¼šæª¢æŸ¥ç•¶å‰è¦é¡¯ç¤ºçš„ç›£è¦–å™¨ä¸­æœ‰å½±åƒçš„æ•¸é‡
            const withImages = filteredCameras.filter(c => {
                const latestObs = c.Observations && c.Observations.length > 0 ? c.Observations[0] : null;
                const imageUrl = latestObs?.result || '';
                return imageUrl && imageUrl.trim() !== '';
            });
            console.log(`å…¶ä¸­æœ‰å½±åƒURLçš„ç›£è¦–å™¨: ${withImages.length}`);
            if (withImages.length > 0) {
                console.log('ç¬¬ä¸€å€‹å½±åƒURLç¯„ä¾‹:', withImages[0].Observations[0].result);
            }

            const html = filteredCameras.map((camera, index) => {
                const thing = camera.Thing || {};
                const name = thing.properties?.stationName || (thing.name && !thing.name.match(/^[0-9a-f-]{36}$/i) ? thing.name : 'æœªå‘½åç›£è¦–å™¨');
                const description = thing.properties?.authority || 'ç„¡èªªæ˜';
                // ä½ç½®å„ªå…ˆä½¿ç”¨ stationNameï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ locationï¼Œæœ€å¾Œæ‰ç”¨ name
                const location = thing.properties?.stationName || thing.properties?.location || (thing.name && !thing.name.match(/^[0-9a-f-]{36}$/i) ? thing.name : 'ä½ç½®æœªçŸ¥');
                const authority = formatAuthority(camera);
                
                const latestObs = camera.Observations && camera.Observations.length > 0 ? camera.Observations[0] : null;
                const imageUrl = latestObs?.result || '';
                const hasImage = imageUrl && imageUrl.trim() !== '';
                const updateTime = latestObs?.phenomenonTime || '';
                
                return `
                    <div class="camera-card" onclick="showModal(${allCameras.indexOf(camera)})">
                        <div class="camera-image">
                            ${hasImage ? 
                                `<div class="image-container" data-url="${imageUrl}" data-name="${name}" style="position: relative; cursor: pointer; transition: transform 0.3s ease;" onclick="openImageInNewTab('${imageUrl}', '${name}')" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    <div class="image-placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); color: white; height: 100%; position: relative;">
                                        <i class="fas fa-video" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.9; animation: pulse 2s infinite;"></i>
                                        <span style="font-size: 1rem; text-align: center; padding: 0 10px; font-weight: bold;">æ°´åˆ©ç½²å®˜æ–¹å½±åƒ</span>
                                        <span style="font-size: 0.85rem; opacity: 0.9; margin-top: 8px; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">
                                            <i class="fas fa-hand-pointer"></i> é»æ“Šé–‹å•Ÿ
                                        </span>
                                        <div style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.3); padding: 6px 10px; border-radius: 15px;">
                                            <i class="fas fa-external-link-alt" style="font-size: 0.9rem;"></i>
                                        </div>
                                        <div style="position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.4); padding: 4px 12px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">
                                            <i class="fas fa-shield-alt"></i> å®˜æ–¹èªè­‰å½±åƒ
                                        </div>
                                    </div>
                                    <style>
                                        @keyframes pulse {
                                            0%, 100% { opacity: 0.9; transform: scale(1); }
                                            50% { opacity: 1; transform: scale(1.1); }
                                        }
                                    </style>
                                    <img src="${imageUrl}" 
                                         alt="${name}" 
                                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s;"
                                         crossorigin="anonymous"
                                         loading="lazy"
                                         onload="showLoadedImage(this)"
                                         onerror="handleImageError(this, '${imageUrl}', '${name}')">
                                </div>` : 
                                '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; background: #f5f5f5;"><i class="fas fa-video-slash" style="font-size: 3rem; margin-bottom: 10px;"></i><span>ç„¡å½±åƒè³‡æ–™</span></div>'
                            }
                        </div>
                        <div class="camera-info">
                            <div class="camera-title">${name}</div>
                            <div class="camera-details">
                                <strong><i class="fas fa-building"></i> ä¸»ç®¡æ©Ÿé—œï¼š</strong>${authority}<br>
                                <strong><i class="fas fa-map-marker-alt"></i> ä½ç½®ï¼š</strong>${location}
                            </div>
                            <span class="camera-status ${hasImage ? 'status-online' : 'status-offline'}">
                                ${hasImage ? 'â— æœ‰å½±åƒ' : 'â— ç„¡å½±åƒ'}
                            </span>
                            ${updateTime ? `<div style="font-size: 0.8rem; color: #999; margin-top: 8px;">
                                <i class="fas fa-clock"></i> ${new Date(updateTime).toLocaleString('zh-TW')}
                            </div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="cameras-grid">${html}</div>`;
        }

        function showModal(index) {
            const camera = allCameras[index];
            const thing = camera.Thing || {};
            const latestObs = camera.Observations && camera.Observations.length > 0 ? camera.Observations[0] : null;
            const imageUrl = latestObs?.result || '';
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹å®šçš„ç›£æ¸¬ç«™
            const stationID = thing.properties?.stationID || camera['@iot.id'] || '';
            const isSpecialStation = stationID === '007d029e-2adc-4012-8602-7d69796cbcc8';
            
            document.getElementById('modalImage').src = imageUrl || 'data:image/svg+xml,<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg"><rect width="400" height="300" fill="%23f5f5f5"/><text x="50%" y="50%" font-family="Arial" font-size="18" fill="%23999" text-anchor="middle" dy=".3em">ç„¡å½±åƒè³‡æ–™</text></svg>';
            document.getElementById('modalTitle').textContent = thing.properties?.stationName || (thing.name && !thing.name.match(/^[0-9a-f-]{36}$/i) ? thing.name : 'æœªå‘½åç›£è¦–å™¨');
            
            let descriptionHtml = `
                <strong><i class="fas fa-tag"></i> é¡å‹ï¼š</strong>${camera.sourceLabel || 'æ°´åˆ©ç½²'}<br>
                <strong><i class="fas fa-info-circle"></i> èªªæ˜ï¼š</strong>${thing.properties?.authority || 'ç„¡èªªæ˜'}
            `;
            
            // ç‚ºç‰¹å®šç›£æ¸¬ç«™æ·»åŠ èªªæ˜
            if (isSpecialStation) {
                descriptionHtml += `<br><div style="background: #e3f2fd; padding: 8px; border-radius: 4px; margin-top: 8px; border-left: 3px solid #2196f3;">
                    <i class="fas fa-info-circle" style="color: #2196f3;"></i> 
                    <strong>æ™ºæ…§é˜²æ±›ç³»çµ±</strong> - è§€éŸ³å‘æºªæ’æ°´ç›£æ§ï¼Œå±¬æ–¼æ°´è³‡æºç®¡ç†ç¯„ç–‡
                </div>`;
            }
            
            document.getElementById('modalDescription').innerHTML = descriptionHtml;
            document.getElementById('modalLocation').innerHTML = `<strong><i class="fas fa-map-marker-alt"></i> ä½ç½®ï¼š</strong>${thing.properties?.stationName || thing.properties?.location || (thing.name && !thing.name.match(/^[0-9a-f-]{36}$/i) ? thing.name : 'ä½ç½®æœªçŸ¥')}`;
            document.getElementById('modalAuthority').innerHTML = `<strong><i class="fas fa-building"></i> ä¸»ç®¡æ©Ÿé—œï¼š</strong>${formatAuthority(camera)}`;
            document.getElementById('modalStationID').innerHTML = `<strong><i class="fas fa-id-card"></i> ç›£æ¸¬ç«™åç¨±ï¼š</strong>${thing.properties?.stationName || thing.name || 'æœªçŸ¥'}`;
            
            if (latestObs?.phenomenonTime) {
                document.getElementById('modalUpdateTime').innerHTML = `<strong><i class="fas fa-clock"></i> è³‡æ–™æ™‚é–“ï¼š</strong>${new Date(latestObs.phenomenonTime).toLocaleString('zh-TW')}`;
            } else {
                document.getElementById('modalUpdateTime').innerHTML = '';
            }

            // é¡¯ç¤ºåº§æ¨™è³‡è¨Šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (thing.location && thing.location.coordinates) {
                const coords = thing.location.coordinates;
                document.getElementById('modalCoordinates').innerHTML = `<strong><i class="fas fa-crosshairs"></i> åº§æ¨™ï¼š</strong>ç¶“åº¦ ${coords[0]}, ç·¯åº¦ ${coords[1]}`;
            } else {
                document.getElementById('modalCoordinates').innerHTML = '';
            }
            
            document.getElementById('cameraModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('cameraModal').style.display = 'none';
        }

        // é»æ“Šå½ˆçª—å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('cameraModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // é é¢è¼‰å…¥
        window.onload = function() {
            loadCameras();
            updateTime();
            
            // æ¯åˆ†é˜æ›´æ–°æ™‚é–“
            setInterval(updateTime, 60000);
            
            // æ¯10åˆ†é˜è‡ªå‹•é‡æ–°è¼‰å…¥è³‡æ–™
            setInterval(loadCameras, 600000);
        }

        // æœå°‹æ¡†å³æ™‚æœå°‹
        document.getElementById('keyword').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(filterCameras, 300);
        });

        // ç¯©é¸æ¢ä»¶æ”¹è®Šæ™‚è‡ªå‹•æœå°‹
        document.getElementById('filterAuthority').addEventListener('change', filterCameras);
        document.getElementById('filterStatus').addEventListener('change', filterCameras);
        document.getElementById('sortBy').addEventListener('change', filterCameras);
    </script>
</body>
</html>
