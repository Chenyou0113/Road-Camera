<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>空品測站影像</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #1e40af 0%, #0891b2 100%); min-height: 100vh; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #1e40af; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #1e40af; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .back-btn:hover { background: #0891b2; }
        .loading { text-align: center; padding: 50px; color: white; font-size: 1.2rem; }
        .cameras-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        @media (max-width: 1200px) { .cameras-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .cameras-grid { grid-template-columns: 1fr; } }
        .camera-card { 
            background: white; 
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            cursor: pointer; 
            transition: transform 0.3s; 
            position: relative; 
        }
        .camera-card:hover { transform: translateY(-5px); }
        .camera-card h3 { color: #1e40af; margin-bottom: 10px; font-size: 1.1rem; }
        .camera-card p { color: #666; margin: 5px 0; font-size: 0.9rem; }
        .station-image { 
            width: 100%; 
            height: 200px; 
            background: #f0f0f0; 
            border-radius: 8px; 
            overflow: hidden; 
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .station-image img { width: 100%; height: 100%; object-fit: cover; }
        .no-image { color: #999; text-align: center; padding: 60px 20px; }
        .status-badge { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            font-weight: bold; 
            color: white; 
        }
        .status-demo { background: #FF9800; }
        .status-live { background: #4CAF50; }
        .aqi-value { 
            display: inline-block; 
            padding: 8px 12px; 
            border-radius: 20px; 
            font-weight: bold; 
            min-width: 50px; 
            text-align: center; 
        }
        .pollutant-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            margin-top: 8px; 
        }
        .pollutant-item { 
            background: #f8f9fa; 
            padding: 6px 8px; 
            border-radius: 4px; 
            text-align: center; 
            font-size: 0.75rem; 
        }
        .pollutant-item .label { color: #666; font-weight: bold; }
        .pollutant-item .value { color: #333; font-weight: bold; margin-top: 2px; }
        
        .filter-box { 
            background: white; 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        }
        .filter-box h3 { color: #1e40af; margin-bottom: 15px; }
        .filter-controls { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-box input { 
            width: 100%; 
            padding: 10px 10px 10px 35px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 1rem; 
            outline: none; 
            transition: border-color 0.3s; 
        }
        .search-box input:focus { border-color: #1e40af; }
        .search-box i { 
            position: absolute; 
            left: 10px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #999; 
        }
        .filter-select { 
            padding: 10px 15px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 1rem; 
            background: white; 
            color: #333; 
            cursor: pointer;
            transition: border-color 0.3s;
            min-width: 120px;
        }
        .filter-select:hover, .filter-select:focus { border-color: #1e40af; outline: none; }
        .btn { 
            padding: 10px 15px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: background-color 0.3s;
            font-weight: 500;
        }
        .btn-primary { background: #1e40af; color: white; }
        .btn-primary:hover { background: #0891b2; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown 0.3s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #1e40af;
            padding-bottom: 15px;
        }
        .modal-header h2 { color: #1e40af; font-size: 1.5rem; }
        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }
        .close-btn:hover { color: #333; }
        
        .detail-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1e40af;
        }
        .detail-section h3 {
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        @media (max-width: 600px) { .detail-grid { grid-template-columns: 1fr; } }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .detail-item-label {
            font-weight: bold;
            color: #666;
            min-width: 120px;
        }
        .detail-item-value {
            color: #333;
            text-align: right;
            font-weight: bold;
        }
        
        .detail-full-width {
            grid-column: 1 / -1;
        }
        
        .large-image-container {
            width: 100%;
            height: 400px;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }
        .large-image-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .stats-grid {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-item {
            text-align: center;
            margin: 5px;
            padding: 10px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-wind"></i> 🎥 空品測站影像</h1>
            <p style="text-align: center; color: #666;">環境部空氣品質監測站即時影像</p>
        </div>
    </div>
    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回首頁</a>
        
        <!-- 搜尋與篩選功能 -->
        <div class="filter-box">
            <h3><i class="fas fa-search"></i> 搜尋測站名稱、編碼或縣市...</h3>
            <div class="filter-controls">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="輸入關鍵字搜尋..." oninput="applyFilters()">
                </div>
                <select class="filter-select" id="countySelect" onchange="applyFilters()">
                    <option value="">全部縣市</option>
                </select>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i> 清除篩選
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> 🔄 刷新資料
                </button>
            </div>
        </div>
        
        <!-- 資料來源說明 -->
        <div class="filter-box">
            <p style="margin: 0; font-weight: bold;" id="dataSourceInfo">
                <i class="fas fa-info-circle"></i> 載入中...
            </p>
        </div>
        
        <!-- 統計資訊 -->
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" style="color: #1e40af;" id="totalStations">0</div>
                <div class="stat-label">總測站數</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #4CAF50;" id="filteredStations">0</div>
                <div class="stat-label">篩選結果</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #2196F3;" id="countyCount">0</div>
                <div class="stat-label">涵蓋縣市</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #4CAF50;" id="goodAqiCount">0</div>
                <div class="stat-label">良好品質</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #FFA726;" id="moderateAqiCount">0</div>
                <div class="stat-label">普通品質</div>
            </div>
        </div>
        
        <div id="cameras-container" class="loading"><i class="fas fa-spinner fa-spin"></i> 載入中...</div>
    </div>
    
    <!-- 詳細資訊模態彈窗 -->
    <div id="detailsModal" class="modal" onclick="if(event.target===this) closeDetailsModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">測站詳細資訊</h2>
                <button class="close-btn" onclick="closeDetailsModal()">&times;</button>
            </div>
            
            <div id="stationImageSection"></div>
            
            <div class="detail-section">
                <h3><i class="fas fa-info-circle"></i> 基本資訊</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-item-label">縣市</span>
                        <span class="detail-item-value" id="detailCounty">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item-label">測站代碼</span>
                        <span class="detail-item-value" id="detailSiteId">-</span>
                    </div>
                    <div class="detail-item detail-full-width">
                        <span class="detail-item-label">發布時間</span>
                        <span class="detail-item-value" id="detailPublishtime">-</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <h3><i class="fas fa-wind"></i> 空氣品質指標 (AQI)</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-item-label">AQI 值</span>
                        <span class="detail-item-value" id="detailAQI" style="padding: 6px 12px; border-radius: 20px; background: #f0f0f0;">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item-label">品質狀態</span>
                        <span class="detail-item-value" id="detailAQIStatus">-</span>
                    </div>
                    <div class="detail-item detail-full-width">
                        <span class="detail-item-label">污染指標物</span>
                        <span class="detail-item-value" id="detailPollutant">-</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <h3><i class="fas fa-flask"></i> 主要污染物濃度 (μg/m³ 或 ppm)</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-item-label">PM2.5</span>
                        <span class="detail-item-value" id="detailPM25">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item-label">PM10</span>
                        <span class="detail-item-value" id="detailPM10">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item-label">O₃ (臭氧)</span>
                        <span class="detail-item-value" id="detailO3">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item-label">CO</span>
                        <span class="detail-item-value" id="detailCO">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item-label">SO₂</span>
                        <span class="detail-item-value" id="detailSO2">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item-label">NO₂</span>
                        <span class="detail-item-value" id="detailNO2">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item-label">NOx</span>
                        <span class="detail-item-value" id="detailNOx">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item-label">NO</span>
                        <span class="detail-item-value" id="detailNO">-</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <h3><i class="fas fa-cloud"></i> 氣象資訊</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-item-label">風速 (m/s)</span>
                        <span class="detail-item-value" id="detailWindSpeed">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-item-label">風向 (度)</span>
                        <span class="detail-item-value" id="detailWindDirec">-</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <h3><i class="fas fa-map-marker-alt"></i> 地理位置</h3>
                <div class="detail-grid">
                    <div class="detail-item detail-full-width">
                        <span class="detail-item-label">經度</span>
                        <span class="detail-item-value" id="detailLongitude">-</span>
                    </div>
                    <div class="detail-item detail-full-width">
                        <span class="detail-item-label">緯度</span>
                        <span class="detail-item-value" id="detailLatitude">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isUsingRealData = false;
        let allStations = [];
        let currentStations = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面載入完成，開始載入空品資料...');
            loadAirQualityData();
        });
        
        async function loadAirQualityData() {
            const container = document.getElementById('cameras-container');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 載入中...</div>';
            
            try {
                console.log('🔄 嘗試連接環境部空品 API...');
                const aqResponse = await fetch('https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=b7df779e-71a6-4148-8379-5afbd441d803&limit=1000&sort=ImportDate%20desc&format=JSON');
                const imageResponse = await fetch('https://data.moenv.gov.tw/api/v2/aqx_p_548?api_key=846e44e1-8cc5-4893-ad87-c79d2d383706&limit=1000&sort=ImportDate%20desc&format=JSON');
                
                if (!aqResponse.ok || !imageResponse.ok) {
                    throw new Error('API 回應錯誤');
                }
                
                const aqData = await aqResponse.json();
                const imageData = await imageResponse.json();
                
                if (aqData?.records && imageData?.records) {
                    isUsingRealData = true;
                    document.getElementById('dataSourceInfo').innerHTML = '✅ 顯示即時空品資料（環境部 API 連線成功）';
                    document.getElementById('dataSourceInfo').style.color = '#4CAF50';
                    
                    const imageMap = {};
                    imageData.records.forEach(img => {
                        if (img.sitename) imageMap[img.sitename] = img.photourl || img.PhotoUrl || '';
                    });
                    
                    allStations = aqData.records.map(station => ({
                        ...station,
                        imageUrl: imageMap[station.sitename] || ''
                    }));
                    
                    currentStations = [...allStations];
                    populateCountyOptions();
                    updateStatistics();
                    processAirQualityData(currentStations, container);
                    return;
                }
                throw new Error('無法獲取資料');
            } catch (error) {
                console.error('❌ 載入真實資料失敗:', error);
                loadMockData();
            }
        }
        
        function loadMockData() {
            const container = document.getElementById('cameras-container');
            isUsingRealData = false;
            
            document.getElementById('dataSourceInfo').innerHTML = '⚠️ 顯示模擬空品資料（API 連線失敗，使用備用資料）';
            document.getElementById('dataSourceInfo').style.color = '#FF9800';
            
            const mockStations = [
                {
                    sitename: '中山', county: '臺北市', aqi: '42', status: '良好',
                    publishtime: new Date().toISOString(), pm2_5: '15', pm10: '28',
                    o3: '45', co: '0.3', so2: '2', no2: '18', siteid: 'TPE001',
                    imageUrl: 'https://images.unsplash.com/photo-1519501025264-65ba15a82390?w=800&h=600&fit=crop'
                },
                {
                    sitename: '萬華', county: '臺北市', aqi: '58', status: '普通',
                    publishtime: new Date(Date.now() - 1800000).toISOString(),
                    pm2_5: '22', pm10: '35', o3: '38', co: '0.4', so2: '3', no2: '25', siteid: 'TPE002',
                    imageUrl: 'https://images.unsplash.com/photo-1513002749550-c59d786b8e6c?w=800&h=600&fit=crop'
                },
                {
                    sitename: '板橋', county: '新北市', aqi: '61', status: '普通',
                    publishtime: new Date(Date.now() - 600000).toISOString(),
                    pm2_5: '25', pm10: '38', o3: '37', co: '0.4', so2: '3', no2: '28', siteid: 'NTP001',
                    imageUrl: 'https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=800&h=600&fit=crop'
                },
                {
                    sitename: '桃園', county: '桃園市', aqi: '73', status: '普通',
                    publishtime: new Date(Date.now() - 2100000).toISOString(),
                    pm2_5: '32', pm10: '48', o3: '32', co: '0.6', so2: '5', no2: '35', siteid: 'TYN001',
                    imageUrl: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=800&h=600&fit=crop'
                },
                {
                    sitename: '台中', county: '臺中市', aqi: '68', status: '普通',
                    publishtime: new Date(Date.now() - 1500000).toISOString(),
                    pm2_5: '28', pm10: '42', o3: '35', co: '0.5', so2: '4', no2: '31', siteid: 'TXG001',
                    imageUrl: 'https://images.unsplash.com/photo-1516738901171-8eb4fc13bd20?w=800&h=600&fit=crop'
                }
            ];
            
            allStations = mockStations;
            currentStations = [...allStations];
            populateCountyOptions();
            updateStatistics();
            processAirQualityData(currentStations, container);
        }
        
        function processAirQualityData(stations, container) {
            const html = stations.map((station, index) => {
                const name = station.sitename || '未命名測站';
                const county = station.county || '';
                const aqi = station.aqi || 'N/A';
                
                let aqiColor = '#999', aqiStatus = '無資料';
                if (aqi && aqi !== 'N/A') {
                    const aqiNum = parseInt(aqi);
                    if (aqiNum <= 50) { aqiColor = '#4CAF50'; aqiStatus = '良好'; }
                    else if (aqiNum <= 100) { aqiColor = '#FFEB3B'; aqiStatus = '普通'; }
                    else if (aqiNum <= 150) { aqiColor = '#FF9800'; aqiStatus = '對敏感族群不健康'; }
                    else { aqiColor = '#F44336'; aqiStatus = '不健康'; }
                }
                
                const imageHtml = station.imageUrl ? 
                    `<div class="station-image"><img src="${station.imageUrl}" alt="${name}測站影像" onerror="this.parentElement.innerHTML='<div class=\\'no-image\\'><i class=\\'fas fa-camera-slash\\'></i><br>影像載入失敗</div>'"></div>` :
                    `<div class="station-image"><div class="no-image"><i class="fas fa-camera-slash"></i><br>無影像資料</div></div>`;
                
                const pollutantItems = [];
                if (station.pm2_5) pollutantItems.push(`<div class="pollutant-item"><div class="label">PM2.5</div><div class="value">${station.pm2_5}</div></div>`);
                if (station.pm10) pollutantItems.push(`<div class="pollutant-item"><div class="label">PM10</div><div class="value">${station.pm10}</div></div>`);
                if (station.o3) pollutantItems.push(`<div class="pollutant-item"><div class="label">O₃</div><div class="value">${station.o3}</div></div>`);
                
                return `
                    <div class="camera-card" onclick="showStationDetails(${index})">
                        <div class="status-badge ${isUsingRealData ? 'status-live' : 'status-demo'}">${isUsingRealData ? '即時' : '模擬'}</div>
                        <h3><i class="fas fa-map-marker-alt"></i> ${name}</h3>
                        <p><i class="fas fa-map"></i> ${county}</p>
                        ${imageHtml}
                        <div style="margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 0.85rem; color: #666;">空氣品質指標</div>
                                    <div class="aqi-value" style="background: ${aqiColor}; color: white;">${aqi}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: ${aqiColor};">${aqiStatus}</div>
                                </div>
                            </div>
                            ${pollutantItems.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                    <div style="font-size: 0.8rem; color: #666; margin-bottom: 6px;"><strong>污染物濃度</strong></div>
                                    <div class="pollutant-grid">${pollutantItems.join('')}</div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                <p style="color: #1e40af; font-size: 0.85rem; text-align: center;">
                                    <i class="fas fa-expand-alt"></i> 點擊查看詳細資訊
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="cameras-grid">${html}</div>`;
        }
        
        function populateCountyOptions() {
            const countySelect = document.getElementById('countySelect');
            const counties = [...new Set(allStations.map(s => s.county).filter(c => c))].sort();
            countySelect.innerHTML = '<option value="">全部縣市</option>' + counties.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        
        function applyFilters() {
            const selectedCounty = document.getElementById('countySelect').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            currentStations = allStations.filter(station => {
                if (selectedCounty && station.county !== selectedCounty) return false;
                if (searchInput) {
                    const name = (station.sitename || '').toLowerCase();
                    const id = (station.siteid || '').toLowerCase();
                    const county = (station.county || '').toLowerCase();
                    if (!name.includes(searchInput) && !id.includes(searchInput) && !county.includes(searchInput)) return false;
                }
                return true;
            });
            
            const container = document.getElementById('cameras-container');
            processAirQualityData(currentStations, container);
            updateStatistics();
        }
        
        function clearFilters() {
            document.getElementById('countySelect').value = '';
            document.getElementById('searchInput').value = '';
            currentStations = [...allStations];
            const container = document.getElementById('cameras-container');
            processAirQualityData(currentStations, container);
            updateStatistics();
        }
        
        function updateStatistics() {
            const total = allStations.length;
            const filtered = currentStations.length;
            const counties = new Set(currentStations.map(s => s.county).filter(c => c)).size;
            
            let goodCount = 0, moderateCount = 0;
            currentStations.forEach(station => {
                const aqi = parseInt(station.aqi) || 0;
                if (aqi <= 50) goodCount++;
                else if (aqi <= 100) moderateCount++;
            });
            
            document.getElementById('totalStations').textContent = total;
            document.getElementById('filteredStations').textContent = filtered;
            document.getElementById('countyCount').textContent = counties;
            document.getElementById('goodAqiCount').textContent = goodCount;
            document.getElementById('moderateAqiCount').textContent = moderateCount;
        }
        
        async function refreshData() {
            console.log('🔄 正在刷新資料...');
            await loadAirQualityData();
        }
        
        function showStationDetails(index) {
            if (index < 0 || index >= currentStations.length) return;
            const station = currentStations[index];
            
            const aqi = station.aqi || 'N/A';
            let aqiColor = '#999', aqiStatus = '無資料';
            if (aqi && aqi !== 'N/A') {
                const aqiNum = parseInt(aqi);
                if (aqiNum <= 50) { aqiColor = '#4CAF50'; aqiStatus = '良好'; }
                else if (aqiNum <= 100) { aqiColor = '#FFEB3B'; aqiStatus = '普通'; }
                else if (aqiNum <= 150) { aqiColor = '#FF9800'; aqiStatus = '對敏感族群不健康'; }
                else if (aqiNum <= 200) { aqiColor = '#FF6F00'; aqiStatus = '對所有族群不健康'; }
                else if (aqiNum <= 300) { aqiColor = '#DC143C'; aqiStatus = '非常不健康'; }
                else { aqiColor = '#8B0000'; aqiStatus = '危害'; }
            }
            
            document.getElementById('modalTitle').textContent = station.sitename || '未命名測站';
            
            const imageSection = document.getElementById('stationImageSection');
            if (station.imageUrl) {
                imageSection.innerHTML = `
                    <div class="large-image-container">
                        <img src="${station.imageUrl}" alt="${station.sitename}測站影像" 
                             onerror="this.parentElement.innerHTML='<div style=\\'color: #999; text-align: center; padding: 40px;\\'>影像載入失敗</div>'">
                    </div>
                `;
            } else {
                imageSection.innerHTML = `
                    <div class="large-image-container">
                        <div style="color: #999; text-align: center;">
                            <i class="fas fa-camera-slash" style="font-size: 3rem; margin-bottom: 10px;"></i><br>
                            無影像資料
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('detailCounty').textContent = station.county || '-';
            document.getElementById('detailSiteId').textContent = station.siteid || '-';
            document.getElementById('detailPublishtime').textContent = station.publishtime ? 
                new Date(station.publishtime).toLocaleString('zh-TW') : '-';
            
            document.getElementById('detailAQI').textContent = aqi;
            document.getElementById('detailAQI').style.background = aqiColor;
            document.getElementById('detailAQI').style.color = aqiColor === '#FFEB3B' ? '#333' : 'white';
            document.getElementById('detailAQIStatus').textContent = aqiStatus;
            document.getElementById('detailPollutant').textContent = station.pollutant || station.pollutants || '-';
            
            document.getElementById('detailPM25').textContent = station.pm2_5 || station['PM2.5'] || '-';
            document.getElementById('detailPM10').textContent = station.pm10 || station['PM10'] || '-';
            document.getElementById('detailO3').textContent = station.o3 || station['O3'] || '-';
            document.getElementById('detailCO').textContent = station.co || station['CO'] || '-';
            document.getElementById('detailSO2').textContent = station.so2 || station['SO2'] || '-';
            document.getElementById('detailNO2').textContent = station.no2 || station['NO2'] || '-';
            document.getElementById('detailNOx').textContent = station.nox || station['NOx'] || '-';
            document.getElementById('detailNO').textContent = station.no || station['NO'] || '-';
            
            document.getElementById('detailWindSpeed').textContent = station.wind_speed || station.windspeed || '-';
            document.getElementById('detailWindDirec').textContent = station.wind_direc || station.winddirection || '-';
            
            document.getElementById('detailLongitude').textContent = station.longitude || station.lon || '-';
            document.getElementById('detailLatitude').textContent = station.latitude || station.lat || '-';
            
            document.getElementById('detailsModal').classList.add('show');
        }
        
        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('show');
        }
    </script>
</body>
</html>
