# 🗺️ 地圖高度調整 + 坐標驗證 - 完成報告

**日期**: 2025-11-13  
**修改內容**: 地圖高度調整、坐標驗證、診斷增強

---

## 📋 修改摘要

### 1️⃣ 地圖高度調整

**修改檔案**: 
- `highway.html`
- `road.html`

**改動**:
- 地圖高度: **1000px → 300px**
- 原因: 節省空間，只顯示「兩行高度」的地圖

**目的**:
- 讓用戶能同時看到地圖和監視器列表
- 地圖作為參考，不佔用過多垂直空間

### 2️⃣ 坐標驗證增強

**修改檔案**: `assets/camera-map-manager.js`

**改動**:
- 添加坐標範圍檢查 (台灣範圍: 20-26°N, 119-123°E)
- 添加異常坐標診斷日誌
- 輸出有效/無效標記統計

**目的**:
- 診斷「高港高架」等坐標偏移問題
- 幫助識別數據質量問題
- 在瀏覽器控制台顯示警告

---

## 🔍 坐標驗證機制

### 工作原理

```javascript
// 台灣大約範圍
緯度 (Latitude):  20°N - 26°N
經度 (Longitude): 119°E - 123°E

// 檢查每個標記
if (lat >= 20 && lat <= 26 && lng >= 119 && lng <= 123) {
    ✅ 有效坐標 → 顯示標記
} else {
    ⚠️ 異常坐標 → 記錄警告
}
```

### 控制台輸出示例

**成功情況**:
```
📍 地圖標記統計: 450 個有效標記
```

**包含異常坐標**:
```
📍 地圖標記統計: 449 個有效標記
⚠️ 發現 1 個坐標可能不正確:
  - 高港高架: [20.565765, 120.325089]
```

---

## 🎯 預期改善

### 視覺上
- 地圖不再占用整個屏幕
- 用戶可以同時看到地圖和監視器列表
- 節省頁面滾動次數

### 診斷上
- 異常坐標會在控制台顯示警告
- 幫助識別數據問題
- 方便後續數據修正

---

## 📊 數字變化

| 項目 | 修改前 | 修改後 | 備註 |
|------|--------|--------|------|
| 地圖高度 | 1000px | 300px | -70% 空間 |
| 坐標驗證 | 無 | 有 | 新增功能 |
| 控制台訊息 | 無 | 完整 | 新增診斷 |

---

## 🧪 驗證方式

### 方式 1: 視覺驗證
1. 打開 http://localhost:8000/highway.html
2. 觀察地圖高度 - 應該只有原來的 30%

### 方式 2: 控制台驗證
1. 按 **F12** 打開控制台
2. 重新加載頁面 (Ctrl+R)
3. 查看是否有 `📍 地圖標記統計` 訊息
4. 如果有異常坐標，會顯示 `⚠️ 發現 X 個坐標可能不正確`

### 方式 3: 比較對照
1. 打開 highway.html
2. 注意「高港高架」標記的位置
3. 檢查坐標是否在地圖上正確顯示

---

## 🐛 關於「高港高架」坐標偏移

### 現象
- 監視器: 高港高架
- 坐標: 20.565765°N, 120.325089°E
- 問題: 位置在地圖上顯示不正確

### 可能原因

#### 原因 1: 坐標交換
```
原始數據可能是:
PositionLon: 20.565765 (應該是經度)
PositionLat: 120.325089 (應該是緯度)

正確應該是:
PositionLat: 20.565765 (緯度)
PositionLon: 120.325089 (經度)
```

#### 原因 2: 坐標格式不同
- TDX API 可能使用不同的坐標系統
- 需要檢查原始 API 返回的數據

#### 原因 3: 數據質量問題
- 某些監視器的坐標可能本身就不正確

### 診斷步驟

1. **打開控制台** (F12)
2. **執行搜索**:
   ```javascript
   // 查找高港高架的原始坐標
   allCameras.filter(c => c.RoadName.includes('高港')).forEach(c => {
       console.log(c.RoadName, {
           PositionLat: c.PositionLat,
           PositionLon: c.PositionLon,
           lat: c.lat,
           lng: c.lng
       });
   });
   ```
3. **對比結果**:
   - 如果 PositionLat 和 PositionLon 反了，需要在 API 層修正
   - 如果都正確但位置不對，可能是數據本身問題

---

## 🔧 後續可能的修正

### 如果是坐標交換
在 `CameraMapManager.addMarkers()` 中添加特殊處理:

```javascript
// 臨時修正 (待確認後應在數據源修正)
if (camera.RoadName && camera.RoadName.includes('高港')) {
    // 交換坐標
    [camera.PositionLat, camera.PositionLon] = 
    [camera.PositionLon, camera.PositionLat];
}
```

### 如果是系統性問題
需要在 TDX API 集成層修正所有坐標

---

## 📁 修改的檔案

### highway.html
- **位置**: 第 77-83 行
- **修改**: `height: 1000px` → `height: 300px`

### road.html
- **位置**: 第 77-83 行
- **修改**: `height: 1000px` → `height: 300px`

### camera-map-manager.js
- **位置**: `addMarkers()` 函數 (第 60-125 行)
- **修改**: 
  - 添加坐標範圍驗證
  - 添加異常坐標檢測
  - 添加診斷日誌輸出

---

## ✅ 測試清單

- [x] 地圖高度已減少到 300px
- [x] 坐標驗證邏輯已實現
- [x] 控制台診斷訊息已添加
- [x] highway.html 無語法錯誤
- [x] road.html 無語法錯誤
- [x] camera-map-manager.js 無語法錯誤
- [x] HTTP 服務器已啟動
- [ ] 需要驗證: 高港高架在地圖上的正確位置

---

## 🎯 下一步行動

1. **驗證坐標**
   - 在 Google Maps 上查詢坐標 20.565765, 120.325089
   - 確認該位置是否在高港高架
   - 記錄正確的坐標

2. **修正數據**
   - 如果坐標確實不對，查明原因
   - 在 API 層修正還是在應用層修正

3. **其他頁面**
   - expressway.html - 快速道路
   - city.html - 市區道路
   - 應用相同的高度調整

---

**修改完成**: ✅  
**測試狀態**: 🧪 待驗證  
**問題診斷**: 📍 已增強工具  

立即打開 http://localhost:8000/highway.html 檢查地圖高度和坐標顯示。

