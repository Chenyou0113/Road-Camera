<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£é«˜éµå³æ™‚çœ‹æ¿</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === CSS æ¨£å¼å€åŸŸ === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            /* é«˜éµæ©˜è‰²æ¼¸å±¤èƒŒæ™¯ */
            background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); 
            min-height: 100vh; 
            padding-bottom: 40px;
            color: #333;
        }
        
        /* Header */
        .header { 
            background: white; 
            padding: 20px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            position: relative;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 20px; 
        }
        
        .header h1 { 
            color: #d84315; 
            text-align: center; 
            margin-bottom: 10px; 
            font-weight: 800;
        }
        
        .back-btn { 
            display: inline-block; 
            padding: 8px 15px; 
            background: #e64a19; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px; 
            margin: 10px 0; 
            transition: background 0.3s;
            font-size: 0.9rem;
        }
        
        .back-btn:hover { background: #bf360c; }
        
        /* æ·±è‰²æ¨¡å¼æŒ‰éˆ• */
        #themeToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #eee;
            color: #333;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }

        /* === ä¸Šæ–¹é€šé˜»è·‘é¦¬ç‡ˆ (æ–°å¢) === */
        .top-marquee {
            background: #ffffff; 
            color: #333333; 
            border: 2px solid #ff9800; /* é«˜éµæ©˜é‚Šæ¡† */
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            position: relative;
            height: 60px;
            overflow: hidden;
        }
        .marquee-icon { 
            margin-right: 15px; 
            color: #e65100; 
            font-size: 1.4rem; 
            z-index: 2; 
            background: #fff; /* é®æ“‹æ–‡å­— */
            padding-right: 10px;
        }
        .marquee-wrapper { flex: 1; overflow: hidden; position: relative; height: 100%; display: block; }
        .marquee-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            /* å‹•ç•«æœƒç”± JS å‹•æ…‹è¨­å®š */
            line-height: 60px;
            position: absolute;
            top: 0; left: 0;
            color: #d84315;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { 
            background: linear-gradient(135deg, rgba(255, 112, 67, 0.95) 0%, rgba(255, 87, 34, 0.95) 100%);
            margin: 20px 0; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .control-panel h3 { 
            color: white; 
            margin-bottom: 20px; 
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .selector-row { 
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px; 
            align-items: end;
        }
        
        .selector-group { display: flex; flex-direction: column; }
        .selector-group label { margin-bottom: 8px; font-weight: 600; color: white; font-size: 0.95rem; }
        .selector-group select { 
            padding: 12px 15px; 
            border-radius: 10px; 
            border: 2px solid rgba(255,255,255,0.3); 
            background: white;
            color: #333;
            font-size: 1rem;
            width: 100%;
        }
        
        .query-btn {
            padding: 12px 30px; 
            background: #2e7d32; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .query-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); background: #1b5e20; }
        .query-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* åˆ—è»Šåˆ—è¡¨å®¹å™¨ */
        .train-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 20px 0;
            display: none; /* é è¨­éš±è— */
        }
        .board-header {
            background: linear-gradient(135deg, #333 0%, #555 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .board-title h2 { font-size: 1.3rem; margin: 0; }
        .board-info { font-size: 0.9rem; color: #ccc; margin-top: 5px; }
        
        .pids-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #ff9800;
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .pids-btn:hover { transform: scale(1.05); background: #f57c00; }

        .direction-header {
            background: #f5f5f5;
            padding: 15px 20px;
            font-weight: 600;
            color: #333;
            border-left: 5px solid #ff5722;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* åˆ—è»Šå¡ç‰‡ */
        .train-card {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        .train-card:hover { background: #fff8e1; }
        
        .train-info { display: flex; align-items: center; gap: 12px; }
        
        .train-type-badge {
            padding: 4px 10px;
            border-radius: 4px;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            background-color: #ff6f00; /* é«˜éµæ©˜ */
            white-space: nowrap;
        }
        
        .train-no { font-weight: bold; color: #333; font-size: 1.1rem; }
        .train-destination .destination { font-size: 1.2rem; font-weight: bold; color: #000; }
        
        .schedule-time { text-align: center; font-weight: 700; color: #333; font-size: 1.5rem; font-family: 'Roboto', sans-serif; }
        
        .delay-status { text-align: right; }
        .status-badge { 
            display: inline-block; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem;
        }
        .status-ok { background-color: #e8f5e9; color: #2e7d32; }
        .status-free { background-color: #fff3e0; color: #ef6c00; font-size: 0.85rem; margin-top: 5px; }

        /* è­¦å‘Šæ¡† */
        .warning-alert {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            background-color: rgba(62, 39, 35, 0.8); /* æ·±å’–å•¡è‰² */
            border-left: 6px solid #ff5722;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #ffccbc;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .alert-icon { font-size: 1.5rem; color: #ff5722; }
        .alert-title { color: #ffab91; font-weight: bold; margin-bottom: 5px; }
        .alert-text { font-size: 0.95rem; line-height: 1.5; color: #eee; }

        /* æ·±è‰²æ¨¡å¼ */
        body.dark-mode { background: #121212; color: #e0e0e0; }
        body.dark-mode .header { background: #1e1e1e; border-bottom: 1px solid #333; }
        body.dark-mode .header h1 { color: #ffccbc; }
        body.dark-mode .control-panel { background: #263238; border: 1px solid #333; }
        body.dark-mode select { background-color: #37474f; color: #fff; border-color: #546e7a; }
        body.dark-mode .train-container { background: #1e1e1e; }
        body.dark-mode .train-card { background-color: #1e1e1e; border-bottom: 1px solid #333; }
        body.dark-mode .train-card:hover { background-color: #263238; }
        body.dark-mode .train-no, body.dark-mode .destination, body.dark-mode .schedule-time { color: #fff; }
        body.dark-mode .direction-header { background-color: #263238; color: #ffccbc; }
        body.dark-mode .top-marquee { background: #212121; color: #ffeb3b; border-color: #424242; }
        body.dark-mode .marquee-icon { background: #212121; }

        /* æ‰‹æ©Ÿç‰ˆé©é… */
        @media (max-width: 768px) {
            .selector-row { grid-template-columns: 1fr; }
            .train-card { grid-template-columns: 1fr; gap: 10px; padding: 15px; }
            .train-info { flex-direction: row; justify-content: space-between; width: 100%; }
            .schedule-time { text-align: left; font-size: 2rem; color: #e65100; }
            body.dark-mode .schedule-time { color: #ffab40; }
            .delay-status { text-align: left; display: flex; gap: 10px; align-items: center; }
            .board-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .pids-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="#" class="back-btn" onclick="window.history.back();"><i class="fas fa-arrow-left"></i> è¿”å›</a>
            <h1><i class="fas fa-train"></i> å°ç£é«˜éµå³æ™‚çœ‹æ¿</h1>
            <p style="text-align: center; color: #666; font-size: 0.95rem;">
                Live Board System (TRA Style)
            </p>
            <button id="themeToggle" title="åˆ‡æ›æ·±è‰²æ¨¡å¼">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <div class="container">
        <!-- ä¸Šæ–¹å³æ™‚é€šé˜»è·‘é¦¬ç‡ˆ -->
        <div class="top-marquee">
            <div class="marquee-icon"><i class="fas fa-bullhorn"></i></div>
            <div class="marquee-wrapper">
                <div class="marquee-content" id="alertMarquee">
                    è³‡æ–™è®€å–ä¸­...
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <h3><i class="fas fa-search"></i> æŸ¥è©¢æ¢ä»¶</h3>
            <div class="selector-row">
                <div class="selector-group">
                    <label for="stationSelect">é¸æ“‡è»Šç«™</label>
                    <select id="stationSelect">
                        <option value="1000">å°åŒ— Taipei</option>
                        <option value="0990">å—æ¸¯ Nangang</option>
                        <option value="1010">æ¿æ©‹ Banqiao</option>
                        <option value="1020">æ¡ƒåœ’ Taoyuan</option>
                        <option value="1030">æ–°ç«¹ Hsinchu</option>
                        <option value="1035">è‹—æ — Miaoli</option>
                        <option value="1040">å°ä¸­ Taichung</option>
                        <option value="1043">å½°åŒ– Changhua</option>
                        <option value="1047">é›²æ— Yunlin</option>
                        <option value="1050">å˜‰ç¾© Chiayi</option>
                        <option value="1060">å°å— Tainan</option>
                        <option value="1070">å·¦ç‡Ÿ Zuoying</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label for="directionFilter">æ–¹å‘</label>
                    <select id="directionFilter">
                        <option value="">å…¨éƒ¨æ–¹å‘ All Directions</option>
                        <option value="0">å—ä¸‹ Southbound</option>
                        <option value="1">åŒ—ä¸Š Northbound</option>
                    </select>
                </div>
                <button class="query-btn" id="queryBtn" onclick="fetchTHSRData()">
                    <i class="fas fa-sync-alt"></i> æŸ¥è©¢ Query
                </button>
            </div>
        </div>

        <!-- è­¦å‘Šæç¤º -->
        <div class="warning-alert">
            <div class="alert-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="alert-content">
                <div class="alert-title">ç³»çµ±æç¤ºï¼š</div>
                <div class="alert-text">
                    æœ¬çœ‹æ¿ç­æ¬¡è³‡è¨Šä»‹æ¥è‡ª Cloudflare Worker ä»£ç†æœå‹™ã€‚
                    <br>å³æ™‚é€šé˜»è³‡è¨Šå°‡é¡¯ç¤ºæ–¼ä¸Šæ–¹è·‘é¦¬ç‡ˆã€‚
                </div>
            </div>
        </div>

        <!-- åˆ—è»Šçœ‹æ¿ -->
        <div id="trainContainer" class="train-container">
            <div class="board-header">
                <div class="board-title">
                    <h2 id="stationTitle">å°åŒ—ç«™ å³æ™‚çœ‹æ¿</h2>
                    <div class="board-info">
                        <span id="updateTime"><i class="fas fa-clock"></i> æ›´æ–°æ™‚é–“ï¼š--:--:--</span>
                    </div>
                </div>
                <a href="#" id="pidsLink" target="_blank" class="pids-btn">
                    <i class="fas fa-desktop"></i> é–‹å•Ÿ PIDS æ¨¡æ“¬
                </a>
            </div>
            <div id="trainsBoard">
                <div style="padding: 50px; text-align: center; color: #999;">
                    <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <p>è«‹é»æ“ŠæŸ¥è©¢è¼‰å…¥è³‡æ–™</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®šå€
        const WORKER_URL = "https://thsr-proxy.weacamm.org";
        let currentStationName = "å°åŒ—";
        
        // è»Šç«™ä»£ç¢¼å°ç…§
        const stationMap = {
            "0990": "å—æ¸¯", "1000": "å°åŒ—", "1010": "æ¿æ©‹", "1020": "æ¡ƒåœ’",
            "1030": "æ–°ç«¹", "1035": "è‹—æ —", "1040": "å°ä¸­", "1043": "å½°åŒ–",
            "1047": "é›²æ—", "1050": "å˜‰ç¾©", "1060": "å°å—", "1070": "å·¦ç‡Ÿ"
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // æ·±è‰²æ¨¡å¼åˆ‡æ›é‚è¼¯
            const toggle = document.getElementById('themeToggle');
            toggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('thsr_theme', isDark ? 'dark' : 'light');
                toggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            });
            
            // è®€å–åå¥½è¨­å®š
            if(localStorage.getItem('thsr_theme') === 'dark') {
                document.body.classList.add('dark-mode');
                toggle.innerHTML = '<i class="fas fa-sun"></i>';
            }

            // é è¨­æŸ¥è©¢å°åŒ—ç«™
            fetchTHSRData();
        });

        // ä¸»è¦æŸ¥è©¢å‡½å¼
        async function fetchTHSRData() {
            const stationID = document.getElementById('stationSelect').value;
            const direction = document.getElementById('directionFilter').value;
            const btn = document.getElementById('queryBtn');
            const board = document.getElementById('trainsBoard');
            const container = document.getElementById('trainContainer');
            
            currentStationName = stationMap[stationID];
            
            // æ›´æ–° UI ç‹€æ…‹
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...';
            container.style.display = 'block';
            board.innerHTML = '<div style="padding:40px; text-align:center; color:#888;">è³‡æ–™è®€å–ä¸­...</div>';
            
            // æ›´æ–°æ¨™é¡Œèˆ‡é€£çµ
            document.getElementById('stationTitle').innerText = `${currentStationName}ç«™ å³æ™‚çœ‹æ¿`;
            document.getElementById('pidsLink').href = `thsr_pids.html?station=${stationID}`;
            updateTime();

            try {
                const res = await fetch(`${WORKER_URL}/?station=${stationID}`);
                const data = await res.json();
                
                // 1. è™•ç†ä¸Šæ–¹è·‘é¦¬ç‡ˆå…¬å‘Š
                renderAlertMarquee(data.alerts);

                // 2. è™•ç†ç­æ¬¡
                const now = new Date();
                const currentHm = now.getHours().toString().padStart(2,'0') + ":" + 
                                 now.getMinutes().toString().padStart(2,'0');

                let trains = (data.trains || [])
                    .filter(t => t.departure_time >= currentHm) // éæ¿¾å·²ç™¼è»Š
                    .filter(t => direction === "" || String(t.direction) === direction); // éæ¿¾æ–¹å‘

                // æ’åº (ä¾æ™‚é–“)
                trains.sort((a, b) => a.departure_time.localeCompare(b.departure_time));

                renderBoard(trains);

            } catch (e) {
                console.error(e);
                board.innerHTML = '<div style="padding:40px; text-align:center; color:#ff5252;">è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚</div>';
                document.getElementById('alertMarquee').innerText = "ç„¡æ³•å–å¾—å³æ™‚è³‡æ–™";
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> æŸ¥è©¢ Query';
            }
        }

        // æ¸²æŸ“åˆ—è¡¨ (ä»¿ TRA é¢¨æ ¼)
        function renderBoard(trains) {
            const board = document.getElementById('trainsBoard');
            if (trains.length === 0) {
                board.innerHTML = '<div style="padding:40px; text-align:center; color:#888;">ç›®å‰ç„¡ç¬¦åˆæ¢ä»¶çš„ç­æ¬¡</div>';
                return;
            }

            // åˆ†çµ„ (å—ä¸‹/åŒ—ä¸Š)
            const groups = {
                '0': { title: 'å—ä¸‹ Southbound', trains: [], color: '#2e7d32' },
                '1': { title: 'åŒ—ä¸Š Northbound', trains: [], color: '#00609c' }
            };

            trains.forEach(t => {
                if(groups[t.direction]) groups[t.direction].trains.push(t);
            });

            let html = '';

            Object.entries(groups).forEach(([dir, group]) => {
                if (group.trains.length === 0) return;

                html += `
                <div style="background:#fff;">
                    <div class="direction-header" style="border-left-color: ${group.color};">
                        <i class="fas ${dir==='0'?'fa-arrow-down':'fa-arrow-up'}"></i> ${group.title}
                    </div>
                `;

                group.trains.forEach(t => {
                    html += `
                    <div class="train-card">
                        <div class="train-info">
                            <span class="train-type-badge">é«˜éµ</span>
                            <div class="train-destination">
                                <div class="train-no">${t.train_no} æ¬¡</div>
                                <div class="destination">å¾€ ${t.destination.zh}</div>
                            </div>
                        </div>
                        <div class="schedule-time">${t.departure_time}</div>
                        <div class="delay-status">
                            <span class="status-badge status-ok">æº–é»</span>
                            <div class="status-badge status-free">è‡ªç”±åº§ ${t.free_seating_cars || '10-12'}</div>
                        </div>
                    </div>
                    `;
                });
                html += '</div>';
            });

            board.innerHTML = html;
        }

        // æ¸²æŸ“ä¸Šæ–¹è·‘é¦¬ç‡ˆ
        function renderAlertMarquee(alerts) {
            const marqueeEl = document.getElementById('alertMarquee');
            
            // é‡ç½®å‹•ç•«
            marqueeEl.style.animation = 'none';
            marqueeEl.offsetHeight; // trigger reflow

            if (!alerts || alerts.length === 0) {
                marqueeEl.innerHTML = "ğŸš„ ç›®å‰å…¨ç·šç‡Ÿé‹æ­£å¸¸ï¼Œæœªæœ‰ç½å®³é€šé˜»äº‹ä»¶ã€‚ Good Service.";
                marqueeEl.style.animation = 'marquee-scroll 15s linear infinite';
                return;
            }

            // ä¸²æ¥æ‰€æœ‰è­¦å ±
            let text = "";
            alerts.forEach(a => {
                const title = a.Title || "ç‡Ÿé‹è³‡è¨Š";
                const desc = (a.Description || "").replace(/[\r\n]+/g, ' ');
                text += `ã€${title}ã€‘${desc}   |   `;
            });
            
            marqueeEl.innerHTML = text;

            // è¨ˆç®—å‹•ç•«é€Ÿåº¦
            const duration = Math.max(15, text.length * 0.3);
            marqueeEl.style.animation = `marquee-scroll ${duration}s linear infinite`;
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('updateTime').innerText = 
                `æ›´æ–°æ™‚é–“ï¼š${now.toLocaleTimeString('zh-TW', {hour12:false})}`;
        }

        // è·‘é¦¬ç‡ˆå‹•ç•« Keyframes (æ³¨å…¥åˆ° head)
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes marquee-scroll {
                0% { transform: translateX(100%); } 
                100% { transform: translateX(-100%); }
            }
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>