<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airport PIDS System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; }
        body { background-color: #dcdcdc; margin: 0; padding: 0; font-family: "Microsoft JhengHei", "Heiti TC", Arial, sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        #selection-screen { display: flex; flex: 1; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white; height: 100vh; }
        .menu-title { font-size: 3rem; margin-bottom: 30px; font-weight: bold; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .menu-buttons { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; }
        .btn-select { padding: 30px 50px; font-size: 1.5rem; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.5); color: white; border-radius: 15px; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(5px); display: flex; flex-direction: column; align-items: center; gap: 10px; min-width: 250px; }
        .btn-select:hover { background: white; color: #333; transform: translateY(-5px); }
        .btn-select.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; background: rgba(0,0,0,0.2); border-color: transparent; display: none; }
        #pids-view { display: none; padding: 20px; flex-wrap: wrap; gap: 20px; width: 100%; justify-content: center; }
        .btn-back { position: fixed; top: 20px; right: 20px; background: #555; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; z-index: 100; font-size: 1rem; }
        .pids-screen { flex: 1; min-width: 45%; max-width: 900px; background: #3e3e3e; box-shadow: 0 5px 20px rgba(0,0,0,0.4); display: flex; flex-direction: column; height: 90vh; border: 1px solid #555; border-radius: 8px; overflow: hidden; color: #f0f0f0; }
        .pids-header { height: 90px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; font-weight: bold; color: #fff; flex-shrink: 0; }
        .pids-header-title { font-size: 2rem; display: flex; align-items: center; gap: 15px; }
        .pids-clock { font-size: 2.8rem; font-family: 'Arial', sans-serif; letter-spacing: 2px; }
        .theme-yellow .pids-header { background: linear-gradient(to bottom, #f0ad4e, #ec971f); border-bottom: 4px solid #d58512; }
        .theme-blue .pids-header { background: linear-gradient(to bottom, #337ab7, #2e6da4); border-bottom: 4px solid #204d74; }
        .theme-green .pids-header { background: linear-gradient(to bottom, #5cb85c, #449d44); border-bottom: 4px solid #398439; }
        .table-container { flex: 1; overflow-y: hidden; padding: 0; background-color: #3e3e3e; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        thead tr { border-bottom: 2px solid #666; height: 55px; background-color: #2c2c2c; }
        thead th { font-size: 1.1rem; color: #bbb; font-weight: normal; text-align: left; padding: 0 15px; }
        tbody tr { height: 80px; border-bottom: 1px solid #555; }
        tbody tr:nth-child(even) { background-color: #444; }
        td { padding: 0 15px; vertical-align: middle; font-size: 1.6rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dest-cn { font-size: 1.6rem; font-weight: bold; }
        .dest-en { font-size: 1.1rem; color: #aaa; margin-left: 8px; font-family: Arial, sans-serif; font-weight: bold; }
        .status-badge { display: inline-block; padding: 8px 16px; border-radius: 6px; font-size: 1rem; min-width: 120px; text-align: center; font-weight: bold; }
        .status-departed, .status-arrived { background-color: #5cb85c; color: #fff; }
        .status-delayed { background-color: #d9534f; color: #fff; }
        .status-boarding { background-color: #f0ad4e; color: #000; animation: blink 1s infinite; }
        .status-ontime { color: #5cb85c; font-weight: bold; font-size: 1.3rem; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .pids-footer { height: 60px; background-color: #2c2c2c; border-top: 2px solid #555; display: flex; align-items: center; padding: 0 20px; font-size: 1.3rem; color: #ffd700; overflow: hidden; }
        .marquee { white-space: nowrap; animation: marquee 25s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @media (max-width: 1200px) { .pids-screen { min-width: 100%; height: auto; min-height: 80vh; } #pids-view { flex-direction: column; } }
    </style>
</head>
<body>

    <div id="selection-screen">
        <div class="menu-title">âœˆï¸ æ©Ÿå ´èˆªç­ PIDS</div>
        <div style="margin-bottom: 40px; text-align: center;">
            <label style="display: block; margin-bottom: 10px; font-size: 1.2rem; color: #ccc;">è«‹é¸æ“‡æ©Ÿå ´ Select Airport</label>
            <select id="airport-select" onchange="checkAirportType()" style="padding: 15px 30px; font-size: 1.3rem; border-radius: 12px; border: none; background: rgba(255,255,255,0.9); cursor: pointer; min-width: 300px;">
                <optgroup label="åŒ—éƒ¨ North">
                    <option value="TSA">è‡ºåŒ—æ¾å±± (TSA)</option>
                    <option value="TPE">æ¡ƒåœ’åœ‹éš› (TPE)</option>
                </optgroup>
                <optgroup label="ä¸­éƒ¨ Central">
                    <option value="RMQ">è‡ºä¸­æ¸…æ³‰å´— (RMQ)</option>
                </optgroup>
                <optgroup label="å—éƒ¨ South">
                    <option value="KHH">é«˜é›„å°æ¸¯ (KHH)</option>
                    <option value="TNN">è‡ºå— (TNN)</option>
                    <option value="CYI">å˜‰ç¾© (CYI)</option>
                </optgroup>
                <optgroup label="æ±éƒ¨ East">
                    <option value="HUN">èŠ±è“® (HUN)</option>
                    <option value="TTT">è‡ºæ± (TTT)</option>
                </optgroup>
                <optgroup label="é›¢å³¶ Offshore Islands">
                    <option value="MZG">æ¾æ¹– (MZG)</option>
                    <option value="KNH">é‡‘é–€ (KNH)</option>
                    <option value="LZN">é¦¬ç¥–å—ç«¿ (LZN)</option>
                    <option value="MFK">é¦¬ç¥–åŒ—ç«¿ (MFK)</option>
                    <option value="LUD">ç¶ å³¶ (LUD)</option>
                    <option value="KYD">è˜­å¶¼ (KYD)</option>
                    <option value="CMJ">ä¸ƒç¾ (CMJ)</option>
                    <option value="WOT">æœ›å®‰ (WOT)</option>
                </optgroup>
            </select>
        </div>

        <div class="menu-buttons">
            <button id="btn-dom" class="btn-select" onclick="showSystem('DOMESTIC')">
                <i class="fas fa-flag"></i> åœ‹å…§ç·š<br><span style="font-size:0.6em">Domestic</span>
            </button>
            <button id="btn-int" class="btn-select" onclick="showSystem('INTERNATIONAL')">
                <i class="fas fa-globe-asia"></i> åœ‹éš›ç·š<br><span style="font-size:0.6em">International</span>
            </button>
        </div>
        
        <div id="loading-hint" style="margin-top:20px; color:#ddd; display:none;">
            <i class="fas fa-spinner fa-spin"></i> è³‡æ–™æª¢æŸ¥ä¸­...
        </div>
    </div>

    <div id="pids-view">
        <button class="btn-back" onclick="goBack()"><i class="fas fa-arrow-left"></i> è¿”å›</button>
        <div id="pids-container" style="display:contents;"></div>
    </div>

    <script>
        const WORKER_URL = "https://airport.xiaoyouwu5-fd3.workers.dev/"; 
        let CurrentFlightData = null;
        const INT_AIRPORTS = ['TPE', 'TSA', 'KHH', 'RMQ'];

        document.addEventListener('DOMContentLoaded', checkAirportType);

        async function checkAirportType() {
            const code = document.getElementById('airport-select').value;
            const btnInt = document.getElementById('btn-int');
            if (INT_AIRPORTS.includes(code)) {
                btnInt.classList.remove('disabled');
                btnInt.style.display = 'flex';
            } else {
                btnInt.classList.add('disabled');
                btnInt.style.display = 'none';
            }
        }

        async function showSystem(type) {
            const airportCode = document.getElementById('airport-select').value;
            const container = document.getElementById('pids-container');
            
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('pids-view').style.display = 'flex';
            container.innerHTML = `<div style="color:white; font-size:2rem; width:100%; text-align:center; margin-top:150px;"><i class="fas fa-circle-notch fa-spin"></i> è³‡æ–™è¼‰å…¥ä¸­...</div>`;

            await fetchAirportData(airportCode);
            container.innerHTML = ''; 

            const now = new Date();
            const currentTime = now.toTimeString().substring(0, 5);

            // ä¿®æ­£ï¼šæ™ºæ…§æ“·å–é‚è¼¯ - å„ªå…ˆé¡¯ç¤ºæœ€è¿‘çš„ç­æ©Ÿï¼Œç¸½æ˜¯é¡¯ç¤º 8 ç­†
            const filterAndSlice = (list) => {
                if (!list || list.length === 0) return [];
                
                // å…ˆæ’åº
                list.sort((a, b) => a.time.localeCompare(b.time));
                
                // æ‰¾å‡ºç¬¬ä¸€ç­ã€Œé‚„æ²’é£›ã€çš„ç´¢å¼•
                let startIndex = list.findIndex(f => f.time >= currentTime);
                
                // å¦‚æœæ‰€æœ‰é£›æ©Ÿéƒ½é£›å®Œäº† (startIndex = -1)ï¼Œå°±é¡¯ç¤ºæœ€å¾Œ 8 ç­
                if (startIndex === -1) {
                    return list.slice(-8); 
                }
                
                // æ­£å¸¸æƒ…æ³ï¼šå¾ç¾åœ¨é€™ç­é–‹å§‹å– 8 ç­†
                // ç‚ºäº†ç¾è§€ï¼Œä¿ç•™å‰ 2 ç­å·²é£›çš„ä½œç‚ºåƒè€ƒ
                let start = Math.max(0, startIndex - 2);
                
                // ç¢ºä¿åˆ‡ç‰‡ç¯„åœ
                return list.slice(start, start + 8);
            };

            if (type === 'DOMESTIC') {
                renderPIDS("åœ‹å…§ç·šåˆ°ç«™", "Domestic Arrivals", 'blue', 'ğŸ›¬', filterAndSlice(CurrentFlightData.DOMESTIC_ARRIVALS), 'D_ARR', 'æ­¡è¿å…‰è‡¨ Welcome');
                renderPIDS("åœ‹å…§ç·šé›¢ç«™", "Domestic Departures", 'yellow', 'ğŸ›«', filterAndSlice(CurrentFlightData.DOMESTIC_DEPARTURES), 'D_DEP', 'ç¥æ‚¨æ—…é€”æ„‰å¿« Have a nice trip');
            } else {
                renderPIDS("åœ‹éš›ç·šåˆ°ç«™", "International Arrivals", 'green', 'ğŸ›¬', filterAndSlice(CurrentFlightData.INTERNATIONAL_ARRIVALS), 'I_ARR', 'æ­¡è¿ä¾†å°ç£ Welcome to Taiwan');
                renderPIDS("åœ‹éš›ç·šé›¢ç«™", "International Departures", 'green', 'ğŸ›«', filterAndSlice(CurrentFlightData.INTERNATIONAL_DEPARTURES), 'I_DEP', 'ç¥æ‚¨é£›è¡Œæ„‰å¿« Have a nice trip');
            }
        }

        async function fetchAirportData(airportCode) {
            try {
                const res = await fetch(`${WORKER_URL}?airport=${airportCode}`);
                if (!res.ok) throw new Error("API Error");
                CurrentFlightData = await res.json();
            } catch (e) {
                console.error(e);
                alert("ç„¡æ³•å–å¾—èˆªç­è³‡æ–™");
                CurrentFlightData = { DOMESTIC_DEPARTURES: [], DOMESTIC_ARRIVALS: [], INTERNATIONAL_DEPARTURES: [], INTERNATIONAL_ARRIVALS: [] };
            }
        }

        function goBack() {
            document.getElementById('pids-view').style.display = 'none';
            document.getElementById('selection-screen').style.display = 'flex';
        }

        function getColumns(type) {
            const isDeparture = type.includes('DEP');
            const isInternational = type.includes('I_');
            let columns = [];
            
            if (isInternational) columns.push({ header: "èˆªç©ºå…¬å¸", sub: "Airline", dataKey: "airline", width: "12%" });
            columns.push({ header: "ç­æ¬¡", sub: "Flight", dataKey: "flight", width: isInternational ? "13%" : "18%" });
            
            if (isDeparture) {
                columns.push({ header: "ç›®çš„åœ°", sub: "Destination", dataKey: "dest", width: isInternational ? "30%" : "32%" });
                columns.push({ header: "æ™‚é–“", sub: "Time", dataKey: "time", width: "10%" });
                columns.push({ header: "ç™»æ©Ÿé–€", sub: "Gate", dataKey: "gate", width: "10%" });
                columns.push({ header: "ç‹€æ…‹", sub: "Status", dataKey: "status", width: "20%" });
            } else {
                columns.push({ header: "å‡ºç™¼åœ°", sub: "Origin", dataKey: "dest", width: isInternational ? "30%" : "32%" });
                columns.push({ header: "æ™‚é–“", sub: "Time", dataKey: "time", width: "10%" });
                columns.push({ header: "å‚™è¨»", sub: "Remarks", dataKey: "est", width: "10%" }); 
                columns.push({ header: "ç‹€æ…‹", sub: "Status", dataKey: "status", width: "20%" });
            }
            return columns;
        }

        function renderPIDS(titleCn, titleEn, theme, icon, data, dataType, marqueeText) {
            if (!data) data = [];
            while(data.length < 8) { data.push({ isEmpty: true }); }

            const columns = getColumns(dataType);
            const screenDiv = document.createElement('div');
            screenDiv.className = `pids-screen theme-${theme}`;
            const screenId = `screen-${Date.now()}-${Math.random()}`;

            const headerHtml = `
                <div class="pids-header">
                    <div class="pids-header-title">
                        <span class="header-icon">${icon}</span>
                        <div>${titleCn}<br><span style="font-size: 0.6em; opacity: 0.8;">${titleEn}</span></div>
                    </div>
                    <div class="pids-clock" id="clock-${screenId}">--:--</div>
                </div>`

            let tableHeaderHtml = '<thead><tr>';
            columns.forEach(col => { tableHeaderHtml += `<th style="width: ${col.width};">${col.header}<span>${col.sub}</span></th>`; });
            tableHeaderHtml += '</tr></thead>';

            let tableBodyHtml = '<tbody>';
            data.forEach(flight => {
                if (flight.isEmpty) {
                    tableBodyHtml += `<tr><td colspan="${columns.length}">&nbsp;</td></tr>`;
                } else {
                    tableBodyHtml += '<tr>';
                    columns.forEach(col => {
                        let cellData = flight[col.dataKey] || "-";
                        let cellHtml = '';

                        if (col.dataKey === 'status') {
                            if(flight.type === 'ontime') cellHtml = `<span class="status-ontime">${cellData}</span>`;
                            else cellHtml = `<span class="status-badge status-${flight.type}">${cellData}</span>`;
                        } else if (col.dataKey === 'dest') {
                            let parts = cellData.split(' ');
                            let cn = parts[1] || parts[0]; 
                            let code = "";
                            if (cellData.match(/^[A-Z]{3}/)) code = cellData.substring(0,3);
                            if (!cn.match(/[\u4e00-\u9fa5]/)) cn = cellData;

                            cellHtml = `<span class="dest-cn">${cn}</span><span class="dest-en">${code}</span>`;
                        } else if (col.dataKey === 'airline') {
                            let color = '#fff';
                            if(['CI','AE'].includes(cellData)) color='#e0a0ff';
                            if(['BR','B7'].includes(cellData)) color='#00a651';
                            if(['JX'].includes(cellData)) color='#cda45e';
                            if(['IT'].includes(cellData)) color='#f68b1f';
                            cellHtml = `<div style="text-align: center; font-weight: bold; color:${color}; font-size: 1.2em;">${cellData}</div>`;
                        } else {
                            const align = (col.dataKey === 'dest') ? 'left' : 'center';
                            cellHtml = `<div style="text-align: ${align};">${cellData}</div>`;
                        }
                        tableBodyHtml += `<td>${cellHtml}</td>`;
                    });
                    tableBodyHtml += '</tr>';
                }
            });
            tableBodyHtml += '</tbody>';

            screenDiv.innerHTML = `${headerHtml}<div class="table-container"><table>${tableHeaderHtml}${tableBodyHtml}</table></div><div class="pids-footer"><div class="marquee">${marqueeText}</div></div>`;
            document.getElementById('pids-container').appendChild(screenDiv);

            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
                const clockEl = document.getElementById(`clock-${screenId}`);
                if (clockEl) clockEl.innerText = timeString;
            }
            setInterval(updateClock, 1000); updateClock();
        }
    </script>
</body>
</html>
