<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>省道監視器 - TDX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <link rel="stylesheet" href="assets/responsive-camera.css">
    <script>window.CURRENT_PAGE = 'road';</script>
    <script src="assets/config.js"></script>
    <script src="assets/coordinate-validator.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script src="assets/city-boundaries.js"></script>
    <script src="assets/image-handler-simple.js"></script>
    <script src="assets/camera-statistics.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #1e40af 0%, #0891b2 100%); min-height: 100vh; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #1e40af; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #1e40af; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .back-btn:hover { background: #0891b2; }
        .loading { text-align: center; padding: 50px; color: white; font-size: 1.2rem; }
        
        /* 地圖和監視器列表左右佈局 */
        .cameras-map-wrapper { display: grid; grid-template-columns: 1fr 3fr; gap: 20px; margin: 20px 0; }
        
        /* 手機版改為上下佈局：地圖在上，監視器在下 */
        @media (max-width: 768px) {
            .cameras-map-wrapper { 
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }
        }
        
        .cameras-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0; }
        @media (max-width: 1400px) {
            .cameras-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 1200px) {
            .cameras-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .cameras-grid { grid-template-columns: 1fr; }
        }
        .camera-card { background: white; border-radius: 10px; padding: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.3s; overflow: hidden; display: flex; flex-direction: column; }
        .camera-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .camera-info { padding: 12px; background: white; flex-shrink: 0; }
        .camera-info h3 { color: #1e40af; margin-bottom: 5px; font-size: 16px; font-weight: bold; word-wrap: break-word; overflow-wrap: break-word; }
        .camera-info p { color: #666; margin: 2px 0; font-size: 0.85rem; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.4; }
        .camera-image { width: 100%; aspect-ratio: 2 / 1; background: #f0f0f0; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .camera-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .camera-image:hover img { transform: scale(1.02); }
        .image-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .camera-image:hover .image-overlay { opacity: 1; }
        .stream-placeholder, .no-image-placeholder, .image-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { position: relative; margin: 2% auto; width: 90%; max-width: 1200px; }
        .close { position: absolute; top: 15px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1001; }
        .close:hover { color: #0891b2; }
        .modal-image { width: 100%; max-height: 80vh; object-fit: contain; }
        .modal-info { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .modal-info h2 { color: #1e40af; margin-bottom: 10px; }
        .modal-info p { color: #666; margin: 5px 0; word-wrap: break-word; overflow-wrap: break-word; }
        
        /* 省道特色樣式 */
        .road-badge { background: #1e40af; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; display: inline-block; margin: 2px; }
        .stats-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: bold; color: #1e40af; }
        .stat-label { color: #666; margin-top: 5px; }
        
        /* 篩選區域 */
        .filter-section { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 5px; font-weight: bold; color: #333; }
        .filter-group select, .filter-group button { padding: 10px; border-radius: 5px; border: 2px solid #1e40af; font-size: 1rem; }
        .filter-group button { background: #1e40af; color: white; cursor: pointer; }
        .filter-group button:hover { background: #0891b2; }
        
        /* 地圖容器 */
        #map {
            width: 100%;
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 0;
            z-index: 1;
        }
        
        .map-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .map-section h3 {
            color: #1e40af;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 分頁 */
        .pagination { display: flex; justify-content: center; align-items: center; margin: 20px 0; gap: 10px; }
        .pagination button { padding: 10px 15px; border: none; background: white; color: #1e40af; border-radius: 5px; cursor: pointer; }
        .pagination button:hover, .pagination button.active { background: #1e40af; color: white; }
        .pagination button:disabled { background: #ccc; cursor: not-allowed; }
        .pagination span { color: white; font-weight: bold; padding: 10px 15px; }
        
        /* 深色模式下的分頁樣式 */
        body.dark-mode .pagination button { background: rgba(255,255,255,0.1); color: #FFB74D; border: 1px solid rgba(255,255,255,0.2); }
        body.dark-mode .pagination button:hover, body.dark-mode .pagination button.active { background: #FFB74D; color: #1a1a2e; }
        body.dark-mode .pagination button:disabled { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.3); }
        body.dark-mode .pagination span { color: #FFB74D; }
        
        /* 深色模式下的篩選區域和統計面板樣式 */
        body.dark-mode .filter-section { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .filter-section h3 { color: #FFB74D; }
        body.dark-mode .filter-group label { color: rgba(255,255,255,0.9); }
        body.dark-mode .filter-group select { background: rgba(255,255,255,0.1); color: white; border-color: #FFB74D; }
        body.dark-mode .filter-group select option { background: #000000; color: white; }
        body.dark-mode .filter-group button { background: #FFB74D; color: #1a1a2e; border-color: #FFB74D; }
        body.dark-mode .filter-group button:hover { background: #FFA726; }
        body.dark-mode .stat-card { background: #000000; border: 1px solid rgba(255,255,255,0.15); }
        body.dark-mode .stat-number { color: #FFB74D; }
        body.dark-mode .stat-label { color: rgba(255,255,255,0.7); }
        body.dark-mode #infoPanel { background: #000000; border-left-color: #FFB74D; border: 1px solid rgba(255,255,255,0.15); }
        body.dark-mode #infoPanel h3 { color: #FFB74D; }
        body.dark-mode #infoContent { color: rgba(255,255,255,0.8); }
        body.dark-mode #infoContent a { color: #FFB74D; }
        
        /* 深色模式下的白色背景元素 */
        body.dark-mode .header { background: linear-gradient(135deg, rgba(30,30,40,0.95) 0%, rgba(25,25,35,0.95) 100%); border-bottom: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .header h1 { color: #FFB74D; }
        body.dark-mode .camera-card { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(35,35,45,0.95) 100%); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        body.dark-mode .camera-info { background: linear-gradient(135deg, rgba(35,35,45,0.95) 0%, rgba(30,30,40,0.95) 100%); }
        body.dark-mode .camera-info h3 { color: #FFB74D; }
        body.dark-mode .camera-info p { color: rgba(255,255,255,0.7); }
        body.dark-mode .camera-image { background: rgba(20,20,30,0.6); }
        body.dark-mode .stream-placeholder, body.dark-mode .no-image-placeholder, body.dark-mode .image-placeholder { background: rgba(20,20,30,0.8); color: rgba(255,255,255,0.5); }
        body.dark-mode .modal-info { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(35,35,45,0.95) 100%); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .modal-info h2 { color: #FFB74D; }
        body.dark-mode .modal-info p { color: rgba(255,255,255,0.8); }
        body.dark-mode .map-section { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(35,35,45,0.95) 100%); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        body.dark-mode .map-section h3 { color: #FFB74D; }
        body.dark-mode .back-btn { background: #FFB74D; color: #1a1a2e; }
        body.dark-mode .back-btn:hover { background: #FFA726; }
        
        /* 手機版響應式優化 */
        @media (max-width: 768px) {
            .camera-info { padding: 12px; }
            .camera-info h3 { font-size: 24px; font-weight: bold; }
            .camera-info p { font-size: 0.85rem; }
            .filter-row { flex-direction: column; align-items: stretch; }
            .stats-panel { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 480px) {
            .stats-panel { grid-template-columns: 1fr; }
        }
    </style>
    
    <!-- 載入進度條 -->
    <script src="assets/loading-progress.js"></script>
    <script>
        // 省道監視器載入設定
        window.AUTO_START_LOADING = false;
        
        window.addEventListener('DOMContentLoaded', () => {
            window.startLoading({
                labelText: '載入省道監視器...',
                color: '#FF9800',
                showLabel: true
            });
        });
    </script>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-road"></i> 省道監視器</h1>
            <p style="text-align: center; color: #666;">即時省道路況監視器</p>
        </div>
    </div>

    <div class="container">
        <div style="display: flex; gap: 10px; align-items: center;">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回首頁</a>
            <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode" style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; cursor: pointer; font-size: 1.2rem;">
                <i class="fas fa-moon"></i>
            </button>
        </div>
        
        <!-- 省道監視器說明 -->
        <div id="infoPanel" style="background: #e8f5e8; border-left: 4px solid #FF9800; padding: 20px; margin: 20px 0; border-radius: 8px; transition: all 0.3s ease;">
            <h3 style="color: #F57C00; margin: 0 0 15px 0; display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleInfoPanel()">
                <span>
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    省道監視器資料說明
                </span>
                <i id="toggleIcon" class="fas fa-chevron-up" style="transition: transform 0.3s ease;"></i>
            </h3>
            <div id="infoContent" style="color: #333; line-height: 1.6;">
                <p style="margin: 0 0 10px 0;">
                    本系統使用交通部 TDX 交通資料流通服務平台提供的即時省道監視器資料，涵蓋台1線、台3線、台9線等主要省道路線。
                </p>
                
                <div style="margin: 15px 0;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">🔗 相關資源連結：</p>
                    <div style="margin-left: 20px;">
                        <p style="margin: 5px 0;">
                            • <a href="https://tdx.transportdata.tw" target="_blank" style="color: #F57C00; text-decoration: none;">
                                TDX 交通資料流通服務平台 <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                        <p style="margin: 5px 0;">
                            • <a href="https://www.thb.gov.tw" target="_blank" style="color: #F57C00; text-decoration: none;">
                                公路總局監視器系統 <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                    </div>
                </div>
                
                <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: #666; font-style: italic;">
                    💡 點擊監視器卡片可查看放大影像和詳細資訊。
                </p>
            </div>
        </div>

        <!-- 統計面板 -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-number" id="totalCameras">0</div>
                <div class="stat-label">監視器總數</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="availableCameras">0</div>
                <div class="stat-label">可用監視器</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="filteredCameras">0</div>
                <div class="stat-label">目前顯示</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="roadCount">0</div>
                <div class="stat-label">省道數</div>
            </div>
        </div>

        <!-- 篩選區域 -->
        <div class="filter-section">
            <h3 style="color: #FF9800; margin-bottom: 15px;"><i class="fas fa-filter"></i> 篩選與排序省道監視器</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="roadSelect">省道</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #FF9800; font-size: 1rem;" id="roadSelect" onchange="applyFilters('road')">
                        <option value="">所有省道</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="citySelect">縣市</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #FF9800; font-size: 1rem;" id="citySelect" onchange="applyFilters('city')">
                        <option value="">所有縣市</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="directionSelect">方向</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #FF9800; font-size: 1rem;" id="directionSelect" onchange="applyFilters('direction')">
                        <option value="">所有方向</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortSelect">里程排序</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #FF9800; font-size: 1rem;" id="sortSelect" onchange="applySorting()">
                        <option value="">預設排序</option>
                        <option value="mile-asc">里程數 ↑ (小到大)</option>
                        <option value="mile-desc">里程數 ↓ (大到小)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button onclick="resetFilters()"><i class="fas fa-refresh"></i> 重置篩選</button>
                </div>
            </div>
        </div>

        <!-- 地圖和監視器列表並排布局 -->
        <div class="cameras-map-wrapper">
            <!-- 左側：地圖定位 -->
            <div class="map-section">
                <h3><i class="fas fa-map"></i> 監視器地理分佈圖</h3>
                <div id="map"></div>
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                    💡 提示：點擊地圖上的標記可查看監視器詳細資訊和坐標位置
                </p>
            </div>

            <!-- 右側：監視器卡片列表 -->
            <div id="cameras-container" class="loading">
                <i class="fas fa-spinner fa-spin"></i> 載入省道監視器資料中...
            </div>
        </div>

        <!-- 下方分頁 -->
        <div id="pagination" class="pagination" style="display: none;">
            <button onclick="changePage(-1)" id="prevBtn"><i class="fas fa-chevron-left"></i> 上一頁</button>
            <span id="pageInfo">第 1 頁，共 1 頁</span>
            <button onclick="changePage(1)" id="nextBtn">下一頁 <i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- 影像彈窗 -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img class="modal-image" id="modalImage" alt="監視器影像">
            <div class="modal-info">
                <h2 id="modalTitle">省道監視器資訊</h2>
                <p id="modalLocation"></p>
                <p id="modalRoad"></p>
                <p id="modalCoords"></p>
            </div>
        </div>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="assets/camera-map-manager.js"></script>
    <script>
        let allCameras = [];
        let filteredCameras = [];
        let currentPage = 1;
        let itemsPerPage = 12;  // 優化：減少每頁顯示數量以提升初始加載速度
        let totalPages = 1;
        
        // 地圖管理器
        let cameraMapManager = null;
        
        // 優化：快取系統用於存儲計算結果以提升篩選速度
        const computationCache = {
            directionsByCamera: new Map(),     // 緩存每個監視器的方向
            mileageByCamera: new Map(),        // 緩存每個監視器的里程
            cityRanges: null,                  // 緩存城市範圍
            clear() {
                this.directionsByCamera.clear();
                this.mileageByCamera.clear();
            }
        };
        
        // 快速道路列表（用於排除）
        const EXPRESSWAYS = [
            '台61', '台62', '台63', '台64', '台65', '台66', '台68', 
            '台72', '台74', '台76', '台78', '台82', '台84', '台86', '台88'
        ];
        
        // 判斷是否為快速道路
        function isExpressway(camera) {
            const roadName = camera.RoadName || '';
            const locationDesc = camera.LocationDescription || '';
            const allText = `${roadName} ${locationDesc}`;
            
            // 檢查是否包含快速道路編號
            for (const expressway of EXPRESSWAYS) {
                const pattern = new RegExp(`[台臺](${expressway.slice(1)})線?`, 'g');
                if (pattern.test(allText)) {
                    return true;
                }
            }
            
            // 特殊處理一些別名
            if (allText.includes('西濱') || allText.includes('西部濱海') ||
                allText.includes('中投') || allText.includes('萬里瑞濱')) {
                return true;
            }
            
            return false;
        }
        
        // 判斷是否為省道（排除國道和快速道路）
        function isProvincialRoad(camera) {
            const roadName = camera.RoadName || '';
            const locationDesc = camera.LocationDescription || '';
            const cctvId = camera.CCTVID || '';
            const allText = `${roadName} ${locationDesc}`;
            
            // 排除國道（編號以 CCTV-N 開頭）
            if (cctvId.startsWith('CCTV-N')) {
                return false;
            }
            
            // 排除明確標示為國道的
            if (allText.includes('國道')) {
                return false;
            }
            
            // 匹配省道格式：台1線、台9甲線等
            const match = allText.match(/[台臺](\d+)([甲乙丙丁]?)線?/);
            if (match) {
                const roadNum = parseInt(match[1]);
                const roadCode = `台${match[1]}`;
                
                // 排除快速道路
                if (EXPRESSWAYS.includes(roadCode)) {
                    return false;
                }
                
                // 省道通常編號在 1-200 範圍內
                if (roadNum >= 1 && roadNum <= 200) {
                    return true;
                }
            }
            
            return false;
        }
        
        // 從路段資訊中提取省道路線編號
        function extractroadNumber(camera) {
            const roadName = camera.RoadName || '';
            const locationDesc = camera.LocationDescription || '';
            const roadSection = typeof camera.RoadSection === 'string' ? camera.RoadSection : '';
            const allText = `${roadName} ${locationDesc} ${roadSection}`;
            
            // 匹配台1線、台9甲線等格式
            const match = allText.match(/[台臺](\d+)([甲乙丙丁]?)線?/);
            if (match) {
                const roadNumber = `台${match[1]}${match[2] ? match[2] : ''}線`;
                return roadNumber;
            }
            
            return '';
        }
        
        // 切換資訊面板顯示/隱藏
        function toggleInfoPanel() {
            const content = document.getElementById('infoContent');
            const icon = document.getElementById('toggleIcon');
            const panel = document.getElementById('infoPanel');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                icon.style.transform = 'rotate(0deg)';
                panel.style.background = '#e8f5e8';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                icon.style.transform = 'rotate(180deg)';
                panel.style.background = '#f5f5f5';
            }
        }

        // 將英文方向轉換為中文
        function convertDirectionToChinese(direction) {
            if (!direction || typeof direction !== 'string') {
                return direction;
            }
            
            const directionMap = {
                'S': '南',
                'N': '北', 
                'E': '東',
                'W': '西',
                'South': '南',
                'North': '北',
                'East': '東',
                'West': '西',
                'southbound': '南下',
                'northbound': '北上',
                'eastbound': '東向',
                'westbound': '西向'
            };
            
            // 檢查是否有完全匹配
            if (directionMap[direction]) {
                return directionMap[direction];
            }
            
            // 檢查是否包含方向關鍵字
            for (const [english, chinese] of Object.entries(directionMap)) {
                if (direction.toLowerCase().includes(english.toLowerCase())) {
                    return direction.replace(new RegExp(english, 'gi'), chinese);
                }
            }
            
            return direction;
        }

        // 格式化位置資訊，包含里程、方向和路段
        function formatLocationInfo(camera) {
            let locationParts = [];
            
            // 1. 優先加上道路線號
            const roadPrefix = camera.RoadNumber || camera.RoadName || '省道';
            locationParts.push(roadPrefix);
            
            // 2. 顯示里程（確保是字符串類型）
            if (camera.LocationMile && typeof camera.LocationMile === 'string') {
                locationParts.push(camera.LocationMile);
            } else if (camera.LocationDescription && typeof camera.LocationDescription === 'string') {
                locationParts.push(camera.LocationDescription);
            }
            
            // 3. 添加方向資訊（確保是字符串類型並轉換為中文）
            if (camera.RoadDirection && typeof camera.RoadDirection === 'string') {
                const chineseDirection = convertDirectionToChinese(camera.RoadDirection);
                locationParts.push(chineseDirection);
            }
            
            // 4. 添加路段資訊（確保是字符串類型）
            if (camera.RoadSection && typeof camera.RoadSection === 'string') {
                locationParts.push(camera.RoadSection);
            } else if (camera.LocationDescription && typeof camera.LocationDescription === 'string') {
                // 如果沒有專門的路段欄位，嘗試從位置描述中提取路段信息
                const sectionMatches = camera.LocationDescription.match(/(.*?段|.*?線|.*?交流道|.*?收費站|.*?服務區)/);
                if (sectionMatches) {
                    const sectionInfo = sectionMatches[1];
                    // 只有當sectionInfo不同於已有的LocationMile時才添加
                    if (!camera.LocationMile || !camera.LocationMile.includes(sectionInfo)) {
                        locationParts.push(sectionInfo);
                    }
                }
            }
            
            return locationParts.length > 0 ? locationParts.join(' ') : '未提供位置資訊';
        }

        // 縣市判斷函數已移至 assets/city-boundaries.js

        // 處理影像載入錯誤 - 改進版本，解決CORS問題
        function handleImageError(img, originalUrl) {
            // 嘗試使用代理或備用方案
            if (originalUrl && !img.dataset.retried) {
                img.dataset.retried = 'true';
                // 添加時間戳避免快取問題
                const separator = originalUrl.includes('?') ? '&' : '?';
                const newUrl = `${originalUrl}${separator}t=${Date.now()}`;
                img.src = newUrl;
                return;
            }
            
            // 最終失敗時顯示錯誤訊息
            img.parentNode.innerHTML = `
                <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#999;background:#f5f5f5;border-radius:8px;padding:10px;">
                    <i class="fas fa-exclamation-triangle" style="font-size:2rem;margin-bottom:8px;color:#f44336;"></i>
                    <span style="font-size:0.85rem;text-align:center;line-height:1.4;">
                        監視器影像<br>載入失敗
                    </span>
                    <small style="font-size:0.7rem;color:#999;margin-top:4px;">可能為CORS限制</small>
                </div>
            `;
        }

        // 確保進度條函數可用的輔助函數
        function ensureProgressFunctions() {
            if (typeof window.setLoadingProgress !== 'function') {
                window.setLoadingProgress = function() { console.warn('setLoadingProgress not available'); };
            }
            if (typeof window.updateLoadingLabel !== 'function') {
                window.updateLoadingLabel = function() { console.warn('updateLoadingLabel not available'); };
            }
            if (typeof window.finishLoading !== 'function') {
                window.finishLoading = function() { console.warn('finishLoading not available'); };
            }
        }

        async function loadCameras() {
            const container = document.getElementById('cameras-container');
            container.innerHTML = '';
            
            // 確保進度條函數可用
            ensureProgressFunctions();
            
            // 更新進度
            window.setLoadingProgress(20);
            window.updateLoadingLabel('連接 TDX API...');
            
            let tdxCameras = [];
            let thbCameras = [];
            let allCamerasFromSources = [];
            
            try {
                console.log('正在載入省道監視器資料...');
                
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在載入省道監視器資料...<br>
                        <small style="margin-top: 10px; display: block;">從 TDX 平台載入全國省道監視器並篩選省道...</small>
                    </div>
                `;
                
                // 載入 TDX 資料
                window.setLoadingProgress(50);
                window.updateLoadingLabel('載入省道監視器資料...');
                
                const endpoint = '/v2/Road/Traffic/CCTV/Highway?$format=JSON';
                console.log('📍 載入 Highway 端點資料並篩選省道...');
                
                const response = await tdxApi.fetchCCTV(endpoint);
                
                window.setLoadingProgress(75);
                window.updateLoadingLabel('篩選省道監視器...');
                
                let cameras = [];
                if (Array.isArray(response)) {
                    cameras = response;
                } else if (response && response.CCTVs && Array.isArray(response.CCTVs)) {
                    cameras = response.CCTVs;
                } else if (response && response.data && Array.isArray(response.data)) {
                    cameras = response.data;
                } else {
                    console.warn('未預期的回應格式:', response);
                    cameras = [];
                }
                
                console.log(`📊 TDX Highway 原始資料: ${cameras.length} 筆`);
                
                if (cameras.length > 0) {
                    // 篩選並處理省道監視器資料
                    allCamerasFromSources = cameras
                        .filter(camera => isProvincialRoad(camera))
                        .map(camera => {
                            const roadNumber = extractroadNumber(camera);
                            return {...camera, source: 'tdx', RoadNumber: roadNumber || camera.RoadName || '省道'};
                        })
                        .filter(camera => camera.RoadNumber);
                }
                
            } catch (error) {
                console.error('❌ 載入省道監視器資料失敗:', error);
                window.finishLoading();
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        載入失敗: ${error.message}<br><br>
                        <button onclick="loadCameras()" style="padding: 10px 20px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-refresh"></i> 重新載入
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log(`📊 省道監視器總計: ${allCamerasFromSources.length} 筆`);
            
            if (allCamerasFromSources.length === 0) {
                window.finishLoading();
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-circle"></i><br>
                        目前沒有可用的省道監視器資料<br><br>
                        <button onclick="loadCameras()" style="padding: 10px 20px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-refresh"></i> 重新載入
                        </button>
                    </div>
                `;
                return;
            }
            
            // 處理監視器資料
            console.log('🔄 處理監視器資料...');
            allCameras = allCamerasFromSources.map(camera => ({
                ...camera,
                City: camera.City || getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName)
            }));
            
            console.log('✅ 資料處理完成');
            filteredCameras = allCameras;
            
            // 更新介面
            populateFilters();
            updateStats();
            displayCameras(allCameras);
            
            // 延遲初始化地圖，確保 Leaflet 已完全加載
            setTimeout(() => {
                console.log('檢查 Leaflet 加載狀態...');
                if (typeof L !== 'undefined') {
                    console.log('✅ Leaflet 已就位，現在初始化地圖');
                    initializeMap();
                } else {
                    console.error('❌ Leaflet 仍未加載，嘗試重新加載...');
                    setTimeout(() => {
                        if (typeof L !== 'undefined') {
                            initializeMap();
                        } else {
                            console.error('❌ Leaflet 加載失敗！');
                        }
                    }, 1000);
                }
            }, 500);
            
            // 完成載入進度
            window.setLoadingProgress(100);
            setTimeout(() => {
                window.finishLoading();
                console.log('✅ 頁面載入完成');
            }, 200);
        }

        function populateFilters() {
            console.log('🔄 開始填充篩選下拉選單...');
            updateRoadSelect(allCameras);
            console.log('✅ 省道篩選已填充');
            updateCitySelect(allCameras);
            console.log('✅ 縣市篩選已填充');
            updateDirectionSelect(allCameras);
            console.log('✅ 方向篩選已填充');
            console.log('✅ 所有篩選下拉選單已完成初始化');
        }

        function updateStats() {
            document.getElementById('totalCameras').textContent = allCameras.length;
            const available = allCameras.filter(c => c.VideoImageUrl || c.VideoStreamURL).length;
            document.getElementById('availableCameras').textContent = available;
            document.getElementById('filteredCameras').textContent = filteredCameras.length;
            
            // 計算省道數量
            const roads = [...new Set(allCameras.map(c => c.RoadNumber).filter(Boolean))];
            document.getElementById('roadCount').textContent = roads.length;
        }
        
        // 更新方向篩選下拉選單
        function updateDirectionSelect(cameras, selectedValue = '') {
            const directions = [...new Set(cameras.map(c => extractDirection(c)).filter(Boolean))];
            
            // 方向排序：東、西、南、北
            const directionOrder = ['東向', '西向', '南向', '北向'];
            const sortedDirections = directions.sort((a, b) => {
                const indexA = directionOrder.indexOf(a);
                const indexB = directionOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            const directionSelect = document.getElementById('directionSelect');
            directionSelect.innerHTML = '<option value="">所有方向</option>' + 
                sortedDirections.map(direction => {
                    const count = cameras.filter(c => extractDirection(c) === direction).length;
                    // 添加方向圖標
                    let icon = '🧭';
                    if (direction === '北向') icon = '⬆️';
                    else if (direction === '南向') icon = '⬇️';
                    else if (direction === '東向') icon = '➡️';
                    else if (direction === '西向') icon = '⬅️';
                    
                    return `<option value="${direction}">${icon} ${direction} (${count})</option>`;
                }).join('');
            
            if (selectedValue && sortedDirections.includes(selectedValue)) {
                directionSelect.value = selectedValue;
            }
        }
        
        // 新增：從里程資訊中提取數值
        function extractMileageNumber(camera) {
            const locationMile = camera.LocationMile || '';
            const locationDesc = camera.LocationDescription || '';
            const allText = `${locationMile} ${locationDesc}`;
            
            // 嘗試匹配各種里程格式
            // 例如：125K、125.5K、125K+500、125公里、125km
            const patterns = [
                /(\d+\.?\d*)K\+(\d+)/i,  // 125K+500
                /(\d+\.?\d*)K/i,          // 125K 或 125.5K
                /(\d+\.?\d*)公里/,        // 125公里
                /(\d+\.?\d*)km/i,         // 125km
                /里程[：:]\s*(\d+\.?\d*)/  // 里程：125
            ];
            
            for (const pattern of patterns) {
                const match = allText.match(pattern);
                if (match) {
                    if (pattern === patterns[0]) {
                        // K+格式：例如 125K+500 = 125.5
                        return parseFloat(match[1]) + parseFloat(match[2]) / 1000;
                    } else {
                        return parseFloat(match[1]);
                    }
                }
            }
            
            return null;
        }
        
        // 提取方向資訊，統一為東向、西向、南向、北向
        // 優化版本：使用緩存加速多次調用
        function extractDirection(camera) {
            // 檢查緩存
            const cameraId = camera.CCTVID || camera.VideoImageUrl;
            if (cameraId && computationCache.directionsByCamera.has(cameraId)) {
                return computationCache.directionsByCamera.get(cameraId);
            }
            
            const roadDirection = camera.RoadDirection || '';
            const roadName = camera.RoadName || '';
            const locationDesc = camera.LocationDescription || '';
            const allText = `${roadDirection} ${roadName} ${locationDesc}`.toUpperCase();
            
            let result = null;
            
            // 判斷北向（優先順序：完整單字 > 單字母）
            if (allText.includes('NORTH') || allText.includes('北')) {
                result = '北向';
            }
            // 判斷南向
            else if (allText.includes('SOUTH') || allText.includes('南')) {
                result = '南向';
            }
            // 判斷東向
            else if (allText.includes('EAST') || allText.includes('東')) {
                result = '東向';
            }
            // 判斷西向
            else if (allText.includes('WEST') || allText.includes('西')) {
                result = '西向';
            }
            else {
                // 單字母判斷（當沒有完整單字時）
                const upperRoadDirection = roadDirection.toUpperCase().trim();
                if (upperRoadDirection === 'N' || upperRoadDirection.startsWith('N ') || upperRoadDirection.endsWith(' N')) {
                    result = '北向';
                }
                else if (upperRoadDirection === 'S' || upperRoadDirection.startsWith('S ') || upperRoadDirection.endsWith(' S')) {
                    result = '南向';
                }
                else if (upperRoadDirection === 'E' || upperRoadDirection.startsWith('E ') || upperRoadDirection.endsWith(' E')) {
                    result = '東向';
                }
                else if (upperRoadDirection === 'W' || upperRoadDirection.startsWith('W ') || upperRoadDirection.endsWith(' W')) {
                    result = '西向';
                }
            }
            
            // 存儲到緩存
            if (cameraId) {
                computationCache.directionsByCamera.set(cameraId, result);
            }
            
            return result;
        }
        
        // 新增：格式化里程顯示，保持原始格式並提取路段資訊
        function formatMileageDisplay(camera) {
            const locationMile = camera.LocationMile || '';
            const locationDesc = camera.LocationDescription || '';
            const roadName = camera.RoadName || '';
            const allText = `${locationMile} ${locationDesc} ${roadName}`;
            
            let mileageDisplay = '';
            let segmentInfo = '';
            
            // 提取原始里程格式
            const mileagePatterns = [
                /(\d+K\+\d+)/i,           // 125K+500 (保持原格式)
                /(\d+\.?\d*K)/i,          // 125K 或 125.5K
                /(\d+\.?\d*)公里/,        // 125公里
                /(\d+\.?\d*)km/i,         // 125km
                /里程[：:]\s*(\d+\.?\d*)/ // 里程：125
            ];
            
            for (const pattern of mileagePatterns) {
                const match = allText.match(pattern);
                if (match) {
                    mileageDisplay = match[1];
                    // 如果不是K+格式，轉換為K格式
                    if (!mileageDisplay.includes('K')) {
                        const num = parseFloat(match[1]);
                        mileageDisplay = `${num}K`;
                    }
                    break;
                }
            }
            
            // 提取路段資訊（交流道、橋樑、隧道等地標）
            const segmentPatterns = [
                /([^，,。\s]*(?:交流道|系統交流道))/g,     // 各種交流道
                /([^，,。\s]*(?:橋|大橋|陸橋|天橋))/g,     // 各種橋樑  
                /([^，,。\s]*(?:隧道))/g,                // 隧道
                /([^，,。\s]*(?:收費站|服務區))/g,        // 收費站、服務區
                /([^，,。\s]*(?:匝道|聯絡道))/g,          // 匝道、聯絡道
                /([^，,。\s]*(?:路口|十字路口))/g,        // 路口
                /([^，,。\s]*(?:車站|火車站|高鐵站))/g,    // 車站
                /([^，,。\s]*(?:工業區|科學園區|工業園區))/g, // 工業區等
                /(近\s*[^，,。\s]+)/g,                   // 近某地點
                /(距\s*[^，,。\s]+)/g                    // 距某地點
            ];
            
            const segments = [];
            for (const pattern of segmentPatterns) {
                const matches = allText.match(pattern);
                if (matches) {
                    segments.push(...matches);
                }
            }
            
            // 去重並取最相關的路段資訊（通常是最後一個或最長的）
            const uniqueSegments = [...new Set(segments)];
            if (uniqueSegments.length > 0) {
                // 優先選擇包含交流道、橋、隧道等重要地標的
                const importantSegments = uniqueSegments.filter(seg => 
                    /交流道|橋|隧道|收費站|服務區/.test(seg)
                );
                segmentInfo = importantSegments.length > 0 ? importantSegments[0] : uniqueSegments[0];
            }
            
            return {
                mileage: mileageDisplay,
                segment: segmentInfo
            };
        }
        
        // 新增：應用排序
        function applySorting() {
            const sortValue = document.getElementById('sortSelect').value;
            
            if (!sortValue) {
                // 恢復預設排序
                displayCameras(filteredCameras);
                return;
            }
            
            const sortedCameras = [...filteredCameras].sort((a, b) => {
                const mileA = extractMileageNumber(a);
                const mileB = extractMileageNumber(b);
                
                // 沒有里程資訊的放在最後
                if (mileA === null && mileB === null) return 0;
                if (mileA === null) return 1;
                if (mileB === null) return -1;
                
                if (sortValue === 'mile-asc') {
                    return mileA - mileB;  // 升序
                } else if (sortValue === 'mile-desc') {
                    return mileB - mileA;  // 降序
                }
                
                return 0;
            });
            
            currentPage = 1;
            displayCameras(sortedCameras);
        }
        
        function applyFilters(changedFilter = null) {
            const roadFilter = document.getElementById('roadSelect').value;
            const cityFilter = document.getElementById('citySelect').value;
            const directionFilter = document.getElementById('directionSelect').value;
            
            if (changedFilter === 'road') {
                if (roadFilter) {
                    const camerasForRoad = allCameras.filter(camera => camera.RoadNumber === roadFilter);
                    const citiesForRoad = [...new Set(camerasForRoad.map(c => c.City).filter(Boolean))].sort();
                    const directionsForRoad = [...new Set(camerasForRoad.map(c => extractDirection(c)).filter(Boolean))].sort();
                    
                    const citySelect = document.getElementById('citySelect');
                    const directionSelect = document.getElementById('directionSelect');
                    const currentCityValue = citySelect.value;
                    const currentDirectionValue = directionSelect.value;
                    
                    citySelect.innerHTML = '<option value="">所有縣市</option>' + 
                        citiesForRoad.map(city => {
                            const count = camerasForRoad.filter(c => c.City === city).length;
                            return `<option value="${city}">${city} (${count})</option>`;
                        }).join('');
                    
                    directionSelect.innerHTML = '<option value="">所有方向</option>' + 
                        directionsForRoad.map(direction => {
                            const count = camerasForRoad.filter(c => extractDirection(c) === direction).length;
                            return `<option value="${direction}">${direction} (${count})</option>`;
                        }).join('');
                    
                    if (currentCityValue && citiesForRoad.includes(currentCityValue)) {
                        citySelect.value = currentCityValue;
                    }
                    if (currentDirectionValue && directionsForRoad.includes(currentDirectionValue)) {
                        directionSelect.value = currentDirectionValue;
                    }
                } else {
                    updateCitySelect(allCameras);
                    updateDirectionSelect(allCameras);
                }
            } else if (changedFilter === 'city') {
                if (cityFilter) {
                    const camerasForCity = allCameras.filter(camera => camera.City === cityFilter);
                    const roadsForCity = [...new Set(camerasForCity.map(c => c.RoadNumber).filter(Boolean))].sort((a, b) => {
                        const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                        const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                        return numA - numB;
                    });
                    const directionsForCity = [...new Set(camerasForCity.map(c => extractDirection(c)).filter(Boolean))].sort();
                    
                    const roadSelect = document.getElementById('roadSelect');
                    const directionSelect = document.getElementById('directionSelect');
                    const currentRoadValue = roadSelect.value;
                    const currentDirectionValue = directionSelect.value;
                    
                    roadSelect.innerHTML = '<option value="">所有省道</option>' + 
                        roadsForCity.map(road => {
                            const count = camerasForCity.filter(c => c.RoadNumber === road).length;
                            return `<option value="${road}">${road} (${count})</option>`;
                        }).join('');
                    
                    directionSelect.innerHTML = '<option value="">所有方向</option>' + 
                        directionsForCity.map(direction => {
                            const count = camerasForCity.filter(c => extractDirection(c) === direction).length;
                            return `<option value="${direction}">${direction} (${count})</option>`;
                        }).join('');
                    
                    if (currentRoadValue && roadsForCity.includes(currentRoadValue)) {
                        roadSelect.value = currentRoadValue;
                    }
                    if (currentDirectionValue && directionsForCity.includes(currentDirectionValue)) {
                        directionSelect.value = currentDirectionValue;
                    }
                } else {
                    updateRoadSelect(allCameras);
                    updateDirectionSelect(allCameras);
                }
            } else if (changedFilter === 'direction') {
                if (directionFilter) {
                    const camerasForDirection = allCameras.filter(camera => extractDirection(camera) === directionFilter);
                    const roadsForDirection = [...new Set(camerasForDirection.map(c => c.RoadNumber).filter(Boolean))].sort((a, b) => {
                        const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                        const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                        return numA - numB;
                    });
                    const citiesForDirection = [...new Set(camerasForDirection.map(c => c.City).filter(Boolean))].sort();
                    
                    const roadSelect = document.getElementById('roadSelect');
                    const citySelect = document.getElementById('citySelect');
                    const currentRoadValue = roadSelect.value;
                    const currentCityValue = citySelect.value;
                    
                    roadSelect.innerHTML = '<option value="">所有省道</option>' + 
                        roadsForDirection.map(road => {
                            const count = camerasForDirection.filter(c => c.RoadNumber === road).length;
                            return `<option value="${road}">${road} (${count})</option>`;
                        }).join('');
                    
                    citySelect.innerHTML = '<option value="">所有縣市</option>' + 
                        citiesForDirection.map(city => {
                            const count = camerasForDirection.filter(c => c.City === city).length;
                            return `<option value="${city}">${city} (${count})</option>`;
                        }).join('');
                    
                    if (currentRoadValue && roadsForDirection.includes(currentRoadValue)) {
                        roadSelect.value = currentRoadValue;
                    }
                    if (currentCityValue && citiesForDirection.includes(currentCityValue)) {
                        citySelect.value = currentCityValue;
                    }
                } else {
                    updateRoadSelect(allCameras);
                    updateCitySelect(allCameras);
                }
            }
            
            filteredCameras = allCameras.filter(camera => {
                const matchRoad = !roadFilter || camera.RoadNumber === roadFilter;
                const matchCity = !cityFilter || camera.City === cityFilter;
                const matchDirection = !directionFilter || extractDirection(camera) === directionFilter;
                return matchRoad && matchCity && matchDirection;
            });
            
            currentPage = 1;
            updateStats();
            updateMapMarkers();
            
            // 應用當前的排序設定
            const sortValue = document.getElementById('sortSelect').value;
            if (sortValue) {
                applySorting();
            } else {
                displayCameras(filteredCameras);
            }
        }

        function resetFilters() {
            document.getElementById('roadSelect').value = '';
            document.getElementById('citySelect').value = '';
            document.getElementById('directionSelect').value = '';
            document.getElementById('sortSelect').value = '';
            applyFilters();
        }
        
        function updateRoadSelect(cameras, selectedValue = '') {
            const roads = [...new Set(cameras.map(c => c.RoadNumber).filter(Boolean))].sort((a, b) => {
                const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                return numA - numB;
            });
            
            const roadSelect = document.getElementById('roadSelect');
            roadSelect.innerHTML = '<option value="">所有省道</option>' + 
                roads.map(road => {
                    const count = cameras.filter(c => c.RoadNumber === road).length;
                    return `<option value="${road}" ${road === selectedValue ? 'selected' : ''}>${road} (${count})</option>`;
                }).join('');
        }
        
        function updateCitySelect(cameras, selectedValue = '') {
            const cities = [...new Set(cameras.map(c => c.City).filter(Boolean))].sort();
            
            const citySelect = document.getElementById('citySelect');
            citySelect.innerHTML = '<option value="">所有縣市</option>' + 
                cities.map(city => {
                    const count = cameras.filter(c => c.City === city).length;
                    return `<option value="${city}" ${city === selectedValue ? 'selected' : ''}>${city} (${count})</option>`;
                }).join('');
        }

        function displayCameras(cameras) {
            const container = document.getElementById('cameras-container');
            const pagination = document.getElementById('pagination');
            
            if (cameras.length === 0) {
                container.innerHTML = '<div class="loading">無符合篩選條件的省道監視器</div>';
                pagination.style.display = 'none';
                return;
            }

            // 計算分頁
            totalPages = Math.ceil(cameras.length / itemsPerPage);
            if (currentPage > totalPages) currentPage = 1;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const displayCameras = cameras.slice(startIndex, endIndex);

            const grid = displayCameras.map((camera, index) => {
                const sourceIcon = camera.source === 'tdx' ? '<i class="fas fa-database" title="TDX資料" style="color: #2196F3;"></i>' : '';
                const roadNumber = camera.RoadNumber ? `<span class="road-badge">${camera.RoadNumber}</span>` : '';
                const imageId = `img-${startIndex + index}-${Date.now()}`;
                const imageUrl = camera.VideoImageUrl || camera.VideoImageURL || camera.VideoStreamURL || camera.PictureURL;
                
                return `
                    <div class="camera-card" onclick="openModal(${startIndex + index})">
                        <div class="camera-image" id="container-${imageId}">
                            ${imageUrl ? 
                                `<div class="image-loading-placeholder" style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;background:#f5f5f5;border-radius:8px;">
                                    <i class="fas fa-spinner fa-pulse" style="font-size:2rem;margin-bottom:8px;color:#FF9800;"></i>
                                    <span style="font-size:0.85rem;color:#666;">載入中...</span>
                                </div>
                                <img id="${imageId}"
                                     data-src="${imageUrl}" 
                                     alt="${camera.CCTVID || '監視器影像'}" 
                                     data-camera-id="${camera.CCTVID || index}"
                                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; background: #f0f0f0; display: none;"
                                     onload="handleImageLoad(this)"
                                     onerror="handleImageError(this, '${imageUrl}')">
                                 <div class="image-overlay" style="display: none;">
                                     <i class="fas fa-search-plus" style="font-size: 2rem;"></i>
                                 </div>` : 
                                '<div class="no-image-placeholder" style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;background:#f5f5f5;border-radius:8px;"><i class="fas fa-video-slash" style="font-size: 2rem; color: #ccc; margin-bottom: 10px;"></i><span style="color: #666;">無影像資料</span></div>'
                            }
                        </div>
                        <div class="camera-info">
                            <h3>${roadNumber || '省道監視器'} ${sourceIcon}</h3>
                            ${(() => {
                                const city = camera.City || getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName);
                                const mileageInfo = formatMileageDisplay(camera);
                                const direction = extractDirection(camera);
                                
                                let infoHtml = '';
                                
                                // 1. 縣市
                                if (city && city !== '未知') {
                                    infoHtml += `<p><i class="fas fa-map-marker-alt" style="color: #FF9800; margin-right: 5px;"></i><span style="color: #666;">${city}</span></p>`;
                                }
                                
                                // 2. 里程(在里程前面必定顯示路線編號)
                                if (mileageInfo.mileage) {
                                    let mileageText = mileageInfo.mileage;
                                    if (mileageInfo.segment) {
                                        mileageText += ` (${mileageInfo.segment})`;
                                    }
                                    // 在里程前面必須加上路線編號,若無則使用RoadName
                                    const roadPrefix = camera.RoadNumber || camera.RoadName || '省道';
                                    infoHtml += `<p><i class="fas fa-road" style="color: #FF9800; margin-right: 5px;"></i><span style="color: #666;">${roadPrefix} ${mileageText}</span></p>`;
                                }
                                
                                // 3. 方向
                                if (direction) {
                                    infoHtml += `<p><i class="fas fa-compass" style="color: #FF9800; margin-right: 5px;"></i><span style="color: #666;">${direction}</span></p>`;
                                }
                                
                                // 4. 省道編號已在標題顯示，不再重複顯示
                                
                                return infoHtml;
                            })()}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="cameras-grid">${grid}</div>`;
            
            // 使用漸進式載入取代懶加載,避免HTTP/2連線過載
            setTimeout(() => {
                progressiveImageLoading();
            }, 100);
            
            // 更新分頁
            updatePagination();
        }

        // 漸進式圖片載入 - 避免HTTP/2協議錯誤
        let imageLoadQueue = [];
        let currentLoadingCount = 0;
        const MAX_CONCURRENT_LOADS = 6;
        const LOAD_DELAY = 150;

        function progressiveImageLoading() {
            const images = document.querySelectorAll('img[data-src]:not([src])');
            imageLoadQueue = Array.from(images);
            
            console.log(`🖼️ 開始漸進式載入 ${imageLoadQueue.length} 張圖片 (最大併發: ${MAX_CONCURRENT_LOADS})`);
            processImageQueue();
        }

        function processImageQueue() {
            while (currentLoadingCount < MAX_CONCURRENT_LOADS && imageLoadQueue.length > 0) {
                const img = imageLoadQueue.shift();
                if (img && img.dataset.src) {
                    loadImageWithDelay(img);
                }
            }
        }

        function loadImageWithDelay(img) {
            currentLoadingCount++;
            
            setTimeout(() => {
                const container = img.closest('.camera-image');
                const loadingPlaceholder = container?.querySelector('.image-loading-placeholder');
                const overlay = container?.querySelector('.image-overlay');
                
                img.onload = function() {
                    handleImageLoad(this);
                    if (loadingPlaceholder) loadingPlaceholder.style.display = 'none';
                    if (overlay) overlay.style.display = 'flex';
                    this.style.display = 'block';
                    
                    currentLoadingCount--;
                    processImageQueue();
                };
                
                img.onerror = function() {
                    handleImageError(this, this.dataset.src);
                    currentLoadingCount--;
                    processImageQueue();
                };
                
                // [修正] 直接使用 data-src 中儲存的完整 VideoStreamURL
                let imageUrl = img.dataset.src;
                
                if (!imageUrl) {
                    console.warn('⚠️ 缺少影像網址');
                    currentLoadingCount--;
                    processImageQueue();
                    return;
                }
                
                // 確保使用 HTTPS 和正確的伺服器
                if (imageUrl.includes('freeway.gov.tw')) {
                    imageUrl = imageUrl.replace(/^http:/, 'https:')
                                      .replace('cctv.freeway.gov.tw', 'cctvn.freeway.gov.tw')
                                      .replace('cctvs.freeway.gov.tw', 'cctvn.freeway.gov.tw');
                    
                    // 加上時間戳記避免快取
                    imageUrl = `${imageUrl}${imageUrl.includes('?') ? '&' : '?'}t=${Date.now()}`;
                    
                    // 使用 corsproxy.io 代理 (解決 HTTP/2 Protocol Error)
                    img.src = `https://corsproxy.io/?${encodeURIComponent(imageUrl)}`;
                    console.log(`🖼️ 載入: ${imageUrl.substring(0, 60)}...`);
                } else {
                    // 非高公局來源，直接使用
                    img.src = imageUrl;
                }
            }, LOAD_DELAY);
        }

        function updatePagination() {
            const paginationTop = document.getElementById('pagination-top');
            const paginationBottom = document.getElementById('pagination');
            const pageInfoTop = document.getElementById('pageInfoTop');
            const pageInfoBottom = document.getElementById('pageInfo');
            
            if (totalPages <= 1) {
                if (paginationTop) paginationTop.style.display = 'none';
                if (paginationBottom) paginationBottom.style.display = 'none';
                return;
            }
            
            const pageText = `第 ${currentPage} 頁 / 共 ${totalPages} 頁`;
            if (paginationTop) paginationTop.style.display = 'flex';
            if (paginationBottom) paginationBottom.style.display = 'flex';
            if (pageInfoTop) pageInfoTop.textContent = pageText;
            if (pageInfoBottom) pageInfoBottom.textContent = pageText;
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayCameras(filteredCameras);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // 處理圖片載入錯誤,添加重試機制和超時處理
        const imageRetryCount = new Map();
        const imageTimeouts = new Map();
        
        function handleImageError(imgElement, originalSrc) {
            const imgId = imgElement.id || imgElement.dataset.cameraId || originalSrc;
            const retryCount = imageRetryCount.get(imgId) || 0;
            
            // 清除可能存在的超時計時器
            if (imageTimeouts.has(imgId)) {
                clearTimeout(imageTimeouts.get(imgId));
                imageTimeouts.delete(imgId);
            }
            
            // 最多重試2次
            if (retryCount < 2) {
                imageRetryCount.set(imgId, retryCount + 1);
                
                // 延遲重試,避免立即重複請求
                setTimeout(() => {
                    // 添加時間戳避免快取
                    const separator = originalSrc.includes('?') ? '&' : '?';
                    imgElement.src = `${originalSrc}${separator}_retry=${retryCount + 1}&t=${Date.now()}`;
                    
                    // 設定30秒超時
                    const timeoutId = setTimeout(() => {
                        if (imgElement.parentNode) {
                            imgElement.parentNode.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#999;background:#f5f5f5;border-radius:8px;">
                                <i class="fas fa-clock" style="font-size:2rem;margin-bottom:8px;color:#ff9800;"></i>
                                <span style="font-size:0.85rem;text-align:center;">影像載入超時<br>請稍後重新整理</span>
                            </div>`;
                        }
                        imageTimeouts.delete(imgId);
                    }, 30000);
                    
                    imageTimeouts.set(imgId, timeoutId);
                }, 1000 * (retryCount + 1)); // 漸進式延遲
                
            } else {
                // 重試失敗,顯示錯誤訊息
                if (imgElement.parentNode) {
                    imgElement.parentNode.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#999;background:#f5f5f5;border-radius:8px;">
                        <i class="fas fa-exclamation-triangle" style="font-size:2rem;margin-bottom:8px;color:#f44336;"></i>
                        <span style="font-size:0.85rem;text-align:center;">省道監視器<br>影像暫時無法載入</span>
                    </div>`;
                }
                imageRetryCount.delete(imgId);
            }
        }
        
        // 圖片載入成功時清除超時計時器
        function handleImageLoad(imgElement) {
            const imgId = imgElement.id || imgElement.dataset.cameraId;
            if (imageTimeouts.has(imgId)) {
                clearTimeout(imageTimeouts.get(imgId));
                imageTimeouts.delete(imgId);
            }
            if (imageRetryCount.has(imgId)) {
                imageRetryCount.delete(imgId);
            }
        }

        // 優化：使用 Intersection Observer API 實現高效的圖片懶加載
        function initializeLazyLoading() {
            if (!('IntersectionObserver' in window)) {
                // 降級方案：如果瀏覽器不支持，直接加載所有圖片
                document.querySelectorAll('img[data-src]').forEach(img => {
                    img.src = img.dataset.src;
                });
                return;
            }
            
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px',  // 提前50px開始加載
                threshold: 0.01
            });
            
            // 監視所有待加載的圖片
            document.querySelectorAll('img[data-src]').forEach(img => {
                imageObserver.observe(img);
            });
        }

        function openModal(index) {
            const camera = filteredCameras[index];
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalLocation = document.getElementById('modalLocation');
            const modalRoad = document.getElementById('modalRoad');
            const modalCoords = document.getElementById('modalCoords');
            
            modalImg.src = camera.VideoImageUrl || camera.VideoStreamURL || '';
            modalTitle.textContent = camera.RoadName || '省道監視器';
            const locationInfo = formatLocationInfo(camera);
            modalLocation.innerHTML = `<i class="fas fa-map-marker-alt"></i> <strong>位置：</strong>${locationInfo}`;
            modalRoad.innerHTML = `<i class="fas fa-road"></i> <strong>路線：</strong>${camera.RoadNumber || '未知路線'} (${camera.City || getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName)})`;
            
            let coordsHtml = '';
            if (camera.PositionLat && camera.PositionLon) {
                coordsHtml = `<i class="fas fa-crosshairs"></i> <strong>座標：</strong>
                    <a href="https://www.google.com/maps?q=${camera.PositionLat},${camera.PositionLon}" 
                       target="_blank" 
                       style="color: #FF9800; text-decoration: none;" 
                       title="在Google地圖中查看">
                        ${camera.PositionLat.toFixed(6)}, ${camera.PositionLon.toFixed(6)}
                        <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-left: 3px;"></i>
                    </a>`;
            }
            const imageUrl = camera.VideoImageUrl || camera.VideoStreamURL;
            if (imageUrl) {
                coordsHtml += `<br><i class="fas fa-external-link-alt"></i> <strong>原始影像：</strong><a href="${imageUrl}" target="_blank" style="color: #FF9800; text-decoration: none;">開啟原始影像連結</a>`;
            }
            modalCoords.innerHTML = coordsHtml;
            
            modal.style.display = 'block';
            
            // 🔥 [新增] 發送真實統計數據到 D1 資料庫
            const cameraId = camera.CCTVID || camera.CCTVId || `${camera.RoadName}-${camera.LocationMile || index}`;
            const trackingName = camera.RoadName || '省道監視器';
            const trackingLoc = camera.City || getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName);

            if (typeof recordCameraView === 'function') {
                recordCameraView(cameraId, trackingName, 'road');
            }
        }

        // 根據相機ID查找並打開詳細資訊
        function openCameraDetails(cameraId) {
            // 在所有相機中搜索匹配的ID
            const index = allCameras.findIndex(camera => {
                return (camera.CCTVID === cameraId || 
                        camera.RoadName === cameraId ||
                        camera.LocationDescription === cameraId);
            });
            
            if (index !== -1) {
                // 如果找到，打開該相機的詳情彈窗
                openModal(index);
            } else {
                console.warn('找不到相機:', cameraId);
            }
        }

        // 關閉彈窗
        document.getElementsByClassName('close')[0].onclick = function() {
            document.getElementById('imageModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // 初始化地圖
        function initializeMap() {
            console.log('開始初始化地圖...');
            
            // 檢查 Leaflet 是否已載入
            if (typeof L === 'undefined') {
                console.error('❌ Leaflet 未成功載入，無法初始化地圖');
                console.log('window.L:', window.L);
                return;
            }
            
            // 檢查地圖容器
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.error('❌ 找不到地圖容器 #map');
                return;
            }
            
            console.log('✅ Leaflet 已載入，地圖容器存在');
            console.log('地圖容器大小:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);
            
            try {
                if (cameraMapManager) {
                    console.log('銷毀舊的地圖管理器...');
                    cameraMapManager.destroy();
                }
                
                console.log('建立新的 CameraMapManager，監視器數量:', allCameras.length);
                cameraMapManager = new CameraMapManager('map', allCameras, {
                    center: [23.5, 121],
                    zoom: 7,
                    onMarkerClick: (camera) => {
                        console.log('點擊監視器:', camera);
                    }
                });
                
                console.log('✅ 地圖初始化成功！');
            } catch (error) {
                console.error('❌ 地圖初始化失敗:', error);
                console.error('錯誤詳情:', error.message, error.stack);
            }
        }

        // 更新地圖標記
        function updateMapMarkers() {
            if (cameraMapManager) {
                console.log('更新地圖標記，監視器數量:', filteredCameras.length);
                cameraMapManager.updateMarkers(filteredCameras);
            } else {
                console.warn('⚠️ cameraMapManager 未初始化');
            }
        }

        // 初始載入
        window.onload = function() {
            // 確保進度條已初始化再開始載入
            setTimeout(() => {
                loadCameras();
            }, 100);
        };
    </script>

    <!-- Back to Top Button -->
    <div class="back-to-top" id="backToTop" style="position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999; font-size: 1.2rem;">
        <i class="fas fa-arrow-up"></i>
    </div>
</body>
</html>
