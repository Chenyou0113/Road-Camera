<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµå³æ™‚çœ‹æ¿ - çœŸå¯¦åˆ—è»Šå‹•æ…‹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <script>window.CURRENT_PAGE = 'train-liveboard';</script>
    <script src="assets/config.js"></script>
    <script src="assets/train-line-classification.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* å¢åŠ é¡è‰²éæ¸¡æ•ˆæœ */
        body, .header, .control-panel, .tra-marquee, .marquee-content, .info-panel, .news-item {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #3575ff 0%, #15bbd8 100%); 
            min-height: 100vh; 
            padding-bottom: 80px;
        }
        
        .header { 
            background: white; 
            padding: 20px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 20px; 
        }
        
        .header h1 { 
            color: #D84315; 
            text-align: center; 
            margin-bottom: 10px; 
        }
        
        .back-btn { 
            display: inline-block; 
            padding: 10px 20px; 
            background: #016d68; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px; 
            margin: 20px 0; 
            transition: background 0.3s;
        }
        
        .back-btn:hover { 
            background: #034d64; 
        }
        
        .control-panel { 
            background: linear-gradient(135deg, rgba(53, 134, 255, 0.9) 0%, rgba(21, 144, 216, 0.9) 100%);
            margin: 20px 0; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,107,53,0.5);
        }
        
        .control-panel h3 { 
            color: white; 
            margin-bottom: 20px; 
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .selector-row { 
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 15px; 
            align-items: end;
        }
        
        .selector-group { 
            display: flex; 
            flex-direction: column; 
        }
        
        .selector-group label { 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: white; 
            font-size: 0.95rem;
        }
        
        .selector-group select, .selector-group input { 
            padding: 12px 15px; 
            border-radius: 10px; 
            border: 2px solid rgba(255,255,255,0.3); 
            background: white;
            color: #333;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .selector-group input:focus { 
            outline: none;
            border-color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.95);
        }
        
        .query-btn {
            padding: 12px 30px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .query-btn:hover { 
            background: #45a049; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        .query-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* åˆ—è»Šåˆ—è¡¨å®¹å™¨ */
        .train-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 20px 0;
        }
        
        .board-header {
            background: linear-gradient(135deg, #FF6B35 0%, #D84315 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .board-title h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .pids-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #212121;
            color: #ffb74d;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            font-family: 'Microsoft JhengHei', sans-serif;
            border: 1px solid #444;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .pids-btn:hover {
            background: #000;
            color: #fff;
            box-shadow: 0 0 15px rgba(255, 183, 77, 0.3);
            transform: translateY(-2px);
        }
        
        .board-info {
            font-size: 0.9rem;
            opacity: 0.9;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .direction-section { border-bottom: 2px solid #eee; }
        .direction-section:last-child { border-bottom: none; }
        
        .direction-header {
            background: #f5f5f5;
            padding: 15px 20px;
            font-weight: 600;
            color: #333;
            border-left: 4px solid #FF6B35;
            font-size: 1.05rem;
        }
        
        .train-card {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
            cursor: pointer;
        }
        
        .train-card:hover { background: #f9f9f9; }
        
        .train-info { display: flex; align-items: center; gap: 12px; }
        
        .train-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .type-è‡ªå¼· { background-color: #FF5722; }
        .type-è‡ªå¼·3000 { background: linear-gradient(135deg, #000000 0%, #333333 100%); border: 1px solid #666; }
        .type-æ™®æ‚ ç‘ª { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); }
        .type-å¤ªé­¯é–£ { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .type-è’å…‰ { background-color: #FF9800; }
        .type-è§€å…‰ { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); border: 1px dashed #fff; }
        .type-å€é–“å¿« { background-color: #3F51B5; }
        .type-å€é–“ { background-color: #2196F3; }
        .type-å¾©èˆˆ { background-color: #00BCD4; }
        .type-æ™®å¿« { background-color: #009688; }
        .type-å…¶ä»– { background-color: #607D8B; }
        
        .train-destination { flex-grow: 1; }
        .train-no { font-weight: bold; color: #333; margin-right: 8px; }
        .destination { color: #666; font-size: 0.95rem; }
        
        .schedule-time { text-align: center; font-weight: 600; color: #333; font-size: 1.1rem; }
        .schedule-label { font-size: 0.75rem; color: #999; margin-top: 2px; }
        
        .delay-status { text-align: center; min-width: 80px; }
        .delay-badge { display: inline-block; padding: 6px 10px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .delay-ok { background-color: #E8F5E9; color: #2E7D32; }
        .delay-warn { background-color: #FFEBEE; color: #C62828; }
        
        .no-data { text-align: center; padding: 60px 20px; color: #999; }
        .no-data i { font-size: 3rem; margin-bottom: 20px; opacity: 0.5; }

        /* === å…¬å‘Šé¢æ¿æ¨£å¼ (Info Panel) === */
        .info-panel {
            background: #fff3e0;
            border-left: 5px solid #ff9800;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .info-panel h3 { color: #e65100; margin-bottom: 12px; display: flex; align-items: baseline; }
        .news-item { padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .news-item:last-child { border-bottom: none; }
        
        /* æ¨™é¡Œèˆ‡æè¿°å¾®èª¿ */
        .news-title { font-weight: bold; color: #bf360c; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .news-desc { color: #5d4037; font-size: 0.95rem; line-height: 1.5; }
        .news-time { font-size: 0.85rem; color: #8d6e63; margin-top: 4px; }

        /* === è·‘é¦¬ç‡ˆæ¨£å¼ä¿®æ­£ (Top Marquee) === */
        .tra-marquee {
            /* â˜€ï¸ æ·ºè‰²æ¨¡å¼è¨­å®š */
            background: #ffffff; 
            color: #333333; 
            border: 1px solid #e0e0e0;
            
            display: flex;
            align-items: center; /* è®“å­å…ƒç´ å‚ç›´ç½®ä¸­ */
            padding: 0 15px; /* ç¨å¾®æ¸›å°‘ä¸Šä¸‹ padding */
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            
            position: relative;
            height: 50px; /* ğŸ”¥ é«˜åº¦ç¨å¾®ç¸®å°ï¼Œè®“æ–‡å­—æ›´é›†ä¸­ */
            overflow: hidden;
        }

        .marquee-icon {
            margin-right: 15px;
            color: #e65100; 
            font-size: 1.3rem; /* åœ–ç¤ºå¤§å°èª¿æ•´ */
            animation: flash 2s infinite;
            flex-shrink: 0;
            z-index: 2;
            background: inherit;
        }

        .marquee-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
            height: 100%;
            display: block;
        }

        .marquee-content-top {
            display: inline-block;
            white-space: nowrap;
            
            /* ğŸ”¥ é—œéµä½ç½®èª¿æ•´ */
            position: absolute;
            top: 0;
            left: 0;
            line-height: 50px; /* å¿…é ˆç­‰æ–¼å®¹å™¨é«˜åº¦ï¼Œç¢ºä¿å‚ç›´ç½®ä¸­ */
            
            padding-left: 100%;
            animation: marquee-announce 30s linear infinite;
            color: inherit; /* è·Ÿéš¨çˆ¶å®¹å™¨é¡è‰² */
        }

        @keyframes marquee-announce { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* === åº•éƒ¨è·‘é¦¬ç‡ˆ (Bottom Marquee) === */
        .marquee-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background-color: #1a1a1a; display: flex; align-items: center; z-index: 9999;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.4); border-top: 3px solid #ff9800;
            font-family: 'Microsoft JhengHei', sans-serif; box-sizing: border-box;
        }
        .marquee-info {
            background: #000000; min-width: 150px; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 0 10px; border-right: 2px solid #333; z-index: 20; position: relative;
            box-shadow: 5px 0 20px rgba(0,0,0,0.9); flex-shrink: 0;
        }
        .marquee-train-no { font-size: 1.4rem; font-weight: 800; color: #ffeb3b; text-shadow: 0 0 8px rgba(255, 235, 59, 0.6); white-space: nowrap; }
        .marquee-dest { font-size: 1rem; color: #ffffff; font-weight: 600; opacity: 0.9; white-space: nowrap; }
        .marquee-content-wrapper {
            flex: 1; overflow: hidden; position: relative; height: 100%; background: #1a1a1a;
            mask-image: linear-gradient(to right, transparent, black 20px, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 20px, black 95%, transparent);
            display: flex; align-items: center;
        }
        .marquee-content {
            position: absolute; white-space: nowrap; font-size: 1.3rem; font-weight: bold;
            letter-spacing: 1px; line-height: 57px; padding-left: 100%;
            animation: marquee-scroll 35s linear infinite; color: #fff; will-change: transform;
        }
        .station-stop { color: #ff3d00; }
        .station-arrow { color: #00e676; margin: 0 5px; font-size: 1rem; }
        .marquee-close {
            background: #222; border: none; border-left: 1px solid #444; color: #999;
            width: 50px; height: 100%; font-size: 1.8rem; cursor: pointer; z-index: 20;
            transition: all 0.2s; flex-shrink: 0;
        }
        .marquee-close:hover { background: #cc0000; color: white; }
        @keyframes marquee-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* å…è²¬è²æ˜ */
        .data-disclaimer {
            background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;
            padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; font-size: 0.9rem;
            display: flex; align-items: flex-start; gap: 10px; line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .data-disclaimer i { font-size: 1.2rem; color: #856404; margin-top: 2px; }

        /* === ğŸš€ æ‡¸æµ®æ·±è‰²æ¨¡å¼æŒ‰éˆ• (å›ºå®šå³ä¸Šè§’) === */
        .theme-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 1.2rem;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-btn:hover { transform: rotate(15deg) scale(1.1); }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 1024px) {
            .selector-row { grid-template-columns: 1fr 1fr; }
            .train-card { grid-template-columns: 1fr 1fr; gap: 10px; }
        }
        @media (max-width: 768px) {
            .selector-row { grid-template-columns: 1fr; }
            .train-card { grid-template-columns: 1fr; }
            .train-info { flex-direction: column; align-items: flex-start; }
            .marquee-bar { height: 50px; }
            .marquee-info { min-width: 100px; padding: 0 8px; }
            .marquee-train-no { font-size: 1.2rem; }
            .marquee-dest { font-size: 0.9rem; }
            .marquee-content { font-size: 1.1rem; line-height: 47px; }
            .tra-marquee { height: auto !important; min-height: 50px; }
            .theme-btn { top: 15px; right: 15px; width: 40px; height: 40px; font-size: 1rem; }
            body { padding-bottom: 70px; }
        }

        /* =========================================
           ğŸŒ™ æ·±è‰²æ¨¡å¼æ¨£å¼ (Dark Mode)
           ========================================= */
        body.dark-mode { background: #121212; color: #e0e0e0; }
        body.dark-mode .header { background: #1e1e1e; border-bottom: 1px solid #333; }
        body.dark-mode .header h1 { color: #ffab91; }
        body.dark-mode .control-panel { background: #1e1e1e; border: 1px solid #333; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        body.dark-mode .control-panel h3 { color: #90caf9; }
        body.dark-mode .selector-group label { color: #cfd8dc; }
        body.dark-mode select, body.dark-mode input { background-color: #2c2c2c; border: 1px solid #444; color: #fff; }
        body.dark-mode .train-container { background: #1e1e1e; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        body.dark-mode .board-header { background: linear-gradient(135deg, #bf360c 0%, #d84315 100%); border-bottom: 1px solid #333; }
        body.dark-mode .direction-header { background-color: #263238; color: #eceff1; border-bottom: 1px solid #37474f; border-left-color: #ff7043; }
        body.dark-mode .train-card { background-color: #1e1e1e; border-bottom: 1px solid #333; }
        body.dark-mode .train-card:hover { background-color: #2c2c2c; }
        body.dark-mode .train-no { color: #fff; }
        body.dark-mode .destination { color: #b0bec5; }
        body.dark-mode .schedule-time { color: #fff; }
        body.dark-mode .schedule-label { color: #78909c; }
        
        /* ğŸ”¥ å…¬å‘Šå€æ·±è‰²ä¿®æ­£ */
        body.dark-mode .info-panel { background: #3e2723; border-left-color: #ffb74d; }
        body.dark-mode .info-panel h3 { color: #ffcc80; }
        body.dark-mode .news-item { border-bottom-color: rgba(255,255,255,0.1); }
        body.dark-mode .news-title { color: #ffab91; }
        body.dark-mode .news-desc { color: #d7ccc8; }
        body.dark-mode .news-time { color: #a1887f; }
        
        /* ğŸ”¥ è·‘é¦¬ç‡ˆæ·±è‰²ä¿®æ­£ (é‡è¦ï¼) */
        body.dark-mode .tra-marquee { 
            background: #212121; 
            color: #ffeb3b; /* æ·±è‰²æ¨¡å¼ä¸‹æ–‡å­—è®Šé»ƒè‰² */
            border-color: #424242; 
        }
        body.dark-mode .marquee-icon { color: #ff9800; }
        
        body.dark-mode .data-disclaimer { background-color: #2c2208; color: #ffecb3; border-color: #443610; }
        body.dark-mode .data-disclaimer i { color: #ffc107; }
    </style>
</head>
<body>
    <button id="theme-toggle" class="theme-btn" onclick="toggleTheme()" title="åˆ‡æ›æ·±è‰²/æ·ºè‰²æ¨¡å¼">
        <i class="fas fa-moon"></i>
    </button>

    <div class="header">
        <div class="container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é </a>
            <h1><i class="fas fa-train"></i> å°éµå³æ™‚çœ‹æ¿</h1>
            <p style="text-align: center; color: #666; font-size: 0.95rem;">
                å…¨å°éµè·¯å³æ™‚åˆ—è»Šå‹•æ…‹ã€èª¤é»è³‡è¨ŠæŸ¥è©¢
            </p>
        </div>
    </div>

    <div class="container">
        <div class="info-panel rail-news" id="traAlertPanel" style="display: none;">
            <h3>
                <span><i class="fas fa-bullhorn"></i> å°éµç‡Ÿé‹é€šé˜»</span>
                <small style="font-size: 0.8rem; margin-left: 10px; font-weight: normal;">(è¿‘ 5 ç­†)</small>
            </h3>
            <div id="traAlertContent" class="news-content">
                </div>
        </div>

        <div class="control-panel">
            <h3>
                <i class="fas fa-search"></i> æŸ¥è©¢å³æ™‚çœ‹æ¿
            </h3>
            <div class="selector-row">
                <div class="selector-group">
                    <label for="lineSelect">è·¯ç·šåˆ†é¡</label>
                    <select id="lineSelect" onchange="filterStations()">
                        <option value="all">å…¨éƒ¨è·¯ç·š</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label for="stationSearch">æœå°‹è»Šç«™</label>
                    <input type="text" id="stationSearch" placeholder="è¼¸å…¥ç«™åæˆ–ä»£ç¢¼ (å¦‚: å°åŒ—, 1000)" oninput="filterStations()">
                </div>
                <div class="selector-group">
                    <label for="stationSelect">é¸æ“‡è»Šç«™</label>
                    <select id="stationSelect">
                        <option value="">è«‹é¸æ“‡è»Šç«™...</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label for="directionFilter">æ–¹å‘</label>
                    <select id="directionFilter">
                        <option value="">å…¨éƒ¨</option>
                        <option value="0">é †è¡Œ</option>
                        <option value="1">é€†è¡Œ</option>
                    </select>
                </div>
                <button class="query-btn" id="queryBtn" onclick="fetchTrainLiveBoard()">
                    <i class="fas fa-sync-alt"></i> æŸ¥è©¢
                </button>
            </div>
        </div>

        <div class="tra-marquee">
            <div class="marquee-icon"><i class="fas fa-bell"></i></div>
            <div class="marquee-wrapper">
                <div class="marquee-content-top" id="marqueeText">
                    <span>æ­¡è¿æ­ä¹˜å°éµã€‚æœ¬çœ‹æ¿è³‡æ–™ç”± TDX æä¾›ï¼Œåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›é‹è¡Œè«‹ä»¥è»Šç«™ç¾å ´ç‚ºä¸»ã€‚</span>
                </div>
            </div>
        </div>

        <div class="data-disclaimer">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>âš ï¸ æ³¨æ„äº‹é …ï¼š</strong>
                æœ¬çœ‹æ¿è³‡æ–™ä¾†æºç‚º TDX å¹³å°åŠ å€¼é‹ç®—ï¼Œèˆ‡è‡ºéµå®˜ç¶²ä¸€è‡´ä½†ç´„æœ‰ <strong>2 åˆ†é˜å»¶é²</strong>ã€‚
                æ­¤è³‡æ–™éç›´æ¥ä»‹æ¥è»Šç«™ç¾å ´ç³»çµ±ï¼Œè«‹å‹¿ç›´æ¥èˆ‡æœˆå° TIDS çœ‹æ¿æ¯”å°ã€‚
            </div>
        </div>

        <div id="trainContainer" class="train-container" style="display: none;">
            <div class="board-header">
                <div class="board-title">
                    <h2 id="stationTitle">å°éµå³æ™‚çœ‹æ¿</h2>
                    <div class="board-info">
                        <span id="stationInfo">é¸æ“‡è»Šç«™é€²è¡ŒæŸ¥è©¢</span>
                        <span class="sync-time">
                            <i class="fas fa-clock"></i> 
                            <span id="updateTime">--:--:--</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <div id="trainsBoard">
                <div class="no-data">
                    <i class="fas fa-inbox"></i>
                    <p>è«‹é¸æ“‡è»Šç«™æŸ¥è©¢</p>
                </div>
            </div>
        </div>
    </div>

    <div id="trainMarqueeBar" class="marquee-bar" style="display: none;">
        <div class="marquee-info">
            <span class="marquee-train-no" id="mqTrainNo"></span>
            <span class="marquee-dest" id="mqDest"></span>
        </div>
        <div class="marquee-content-wrapper">
            <div class="marquee-content" id="mqContent"></div>
        </div>
        <button class="marquee-close" onclick="closeMarquee()">Ã—</button>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        // ============ å…¨å±€è®Šæ•¸ ============
        const WORKER_URL = 'https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev';
        let currentStationID = '';
        let currentStationName = '';
        let allStationsFlat = []; 
        const trainDataCache = {}; 
        let prefetchTimeout = null;

        // è»Šç¨®å°ç…§è¡¨
        const TRAIN_TYPE_DB = [
          { "id": "1100", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1101", "name": "å¤ªé­¯é–£", "code": "1" },
          { "id": "1102", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1103", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1107", "name": "æ™®æ‚ ç‘ª", "code": "2" },
          { "id": "1108", "name": "è‡ªå¼·", "code": "3" },
          { "id": "110G", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "110H", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "110K", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "110M", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "1110", "name": "è’å…‰", "code": "4" },
          { "id": "1111", "name": "è’å…‰", "code": "4" },
          { "id": "1114", "name": "è’å…‰", "code": "4" },
          { "id": "1115", "name": "è’å…‰", "code": "4" },
          { "id": "1120", "name": "å¾©èˆˆ", "code": "5" },
          { "id": "1131", "name": "å€é–“", "code": "6" },
          { "id": "1132", "name": "å€é–“å¿«", "code": "6" },
          { "id": "1140", "name": "æ™®å¿«", "code": "7" }
        ];
        const trainTypeMap = new Map();
        TRAIN_TYPE_DB.forEach(item => trainTypeMap.set(item.id, item.name));

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', () => {
            initStationControls();
            setInterval(updateTime, 1000);
            loadTraAlerts();
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const icon = document.querySelector('#theme-toggle i');
                if(icon) { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); }
            }
        });

        // æ·±è‰²æ¨¡å¼åˆ‡æ›é‚è¼¯
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('theme-toggle');
            const icon = btn.querySelector('i');
            body.classList.toggle('dark-mode');
            if (body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); localStorage.setItem('theme', 'dark');
            } else {
                icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); localStorage.setItem('theme', 'light');
            }
        }

        // è¼‰å…¥å…¬å‘Š
        async function loadTraAlerts() {
            try {
                const response = await fetch(`${WORKER_URL}/api/alert`).then(r => r.json());
                const panel = document.getElementById('traAlertPanel');
                const content = document.getElementById('traAlertContent');
                const marqueeEl = document.getElementById('marqueeText');

                let alertList = response.Alerts || response || [];

                if (marqueeEl && alertList.length > 0) {
                    let marqueeHTML = '';
                    alertList.forEach(alert => {
                        const cleanDesc = (alert.Description || '').replace(/[\r\n]+/g, ' ');
                        marqueeHTML += `<span style="display: inline-block; margin-right: 50px;">ã€${alert.Title}ã€‘${cleanDesc}</span>`;
                    });
                    marqueeHTML += `<span style="color:#ff9800;">(ä»¥ä¸Šè³‡è¨Šç”± Worker æä¾›)</span>`;
                    marqueeEl.innerHTML = marqueeHTML;
                    const duration = Math.max(20, marqueeEl.innerText.length * 0.25); 
                    marqueeEl.style.animation = `marquee-announce ${duration}s linear infinite`;
                }

                if (panel && content && alertList.length > 0) {
                    let html = '';
                    alertList.forEach(alert => {
                        let icon = 'â„¹ï¸';
                        let titleColor = '#e65100';
                        if (alert.Status === 2 || alert.Level > 1) { icon = 'ğŸš¨'; titleColor = '#d32f2f'; }
                        const timeStr = new Date(alert.PublishTime).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                        html += `<div class="news-item">
                            <div class="news-title" style="color: ${titleColor}"><span>${icon}</span><span>${alert.Title}</span></div>
                            <div class="news-desc">${(alert.Description || '').replace(/\n/g, '<br>')}</div>
                            <div class="news-time"><i class="far fa-clock"></i> ç™¼å¸ƒæ™‚é–“ï¼š${timeStr}</div>
                        </div>`;
                    });
                    content.innerHTML = html;
                    panel.style.display = 'block';
                }
            } catch (error) {
                console.warn('å…¬å‘Šè¼‰å…¥å¤±æ•—');
                document.getElementById('traAlertPanel').style.display = 'none'; // å¤±æ•—å°±éš±è—
            }
        }

        function initStationControls() {
            const lineSelect = document.getElementById('lineSelect');
            const categories = {};
            for (const [key, data] of Object.entries(trainLineClassification)) {
                const category = data.category || 'å…¶ä»–';
                if (!categories[category]) categories[category] = [];
                categories[category].push({ key, ...data });
            }

            for (const [category, routes] of Object.entries(categories)) {
                if (Object.keys(categories).length > 1) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category;
                    routes.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.key;
                        option.textContent = route.name;
                        optgroup.appendChild(option);
                    });
                    lineSelect.appendChild(optgroup);
                } else {
                    routes.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.key;
                        option.textContent = route.name;
                        lineSelect.appendChild(option);
                    });
                }
                routes.forEach(route => {
                    route.stations.forEach(station => {
                        if (!allStationsFlat.find(s => s.code === station.code)) {
                            allStationsFlat.push({ code: station.code, name: station.name, lineKey: route.key });
                        }
                    });
                });
            }
            filterStations();
        }

        function filterStations() {
            const selectedLine = document.getElementById('lineSelect').value;
            const keyword = document.getElementById('stationSearch').value.toLowerCase().trim();
            let filtered = [];

            if (selectedLine === 'all') {
                filtered = allStationsFlat;
            } else if (trainLineClassification[selectedLine]) {
                filtered = trainLineClassification[selectedLine].stations.map(s => ({
                    code: s.code, name: s.name, lineKey: selectedLine
                }));
            }

            if (keyword) {
                filtered = filtered.filter(s => s.name.includes(keyword) || s.code.includes(keyword));
            }
            renderStationOptions(filtered);
        }

        function renderStationOptions(stations) {
            const select = document.getElementById('stationSelect');
            select.innerHTML = '';
            if (stations.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.text = "æŸ¥ç„¡ç¬¦åˆè»Šç«™";
                select.add(option);
                return;
            }
            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.text = `è«‹é¸æ“‡è»Šç«™ (${stations.length} å€‹çµæœ)`;
            select.add(defaultOpt);
            stations.forEach(s => {
                const option = document.createElement('option');
                option.value = s.code;
                option.text = `${s.code} - ${s.name}`;
                select.add(option);
            });
            if (stations.length === 1) select.selectedIndex = 1;
        }

        // ============ æŸ¥è©¢åŠŸèƒ½ (å«éŒ¯èª¤åµæ¸¬ç‰ˆ) ============
        async function fetchTrainLiveBoard() {
            const stationSelect = document.getElementById('stationSelect');
            const queryBtn = document.getElementById('queryBtn');
            currentStationID = stationSelect.value;

            if (!currentStationID) { alert('è«‹å…ˆé¸æ“‡è»Šç«™'); return; }

            const selectedOption = stationSelect.options[stationSelect.selectedIndex];
            currentStationName = selectedOption.text.split(' - ')[1];
            queryBtn.disabled = true;
            
            document.getElementById('trainsBoard').innerHTML = '<div class="no-data"><i class="fas fa-spinner fa-spin"></i><p>è¼‰å…¥å…¨æ—¥ç­è¡¨èˆ‡å‹•æ…‹ä¸­...</p></div>';
            document.getElementById('trainContainer').style.display = 'block';

            try {
                // 1. å‘¼å« Worker (åŠ ä¸Šæ™‚é–“æˆ³è¨˜é¿é–‹å¿«å–)
                const ts = Date.now();
                const [scheduleRes, liveRes] = await Promise.all([
                    fetch(`${WORKER_URL}/api/station/schedule?stationID=${currentStationID}&t=${ts}`).then(r => r.json()),
                    fetch(`${WORKER_URL}/api/station/live?stationID=${currentStationID}&t=${ts}`).then(r => r.json())
                ]);

                // ğŸ”¥ã€æ–°å¢ã€‘éŒ¯èª¤æª¢æŸ¥ï¼šå¦‚æœ Worker å›å‚³éŒ¯èª¤ï¼Œç›´æ¥è·³å‡ºè­¦å‘Š
                if (scheduleRes.error) throw new Error("æ™‚åˆ»è¡¨ API éŒ¯èª¤: " + scheduleRes.error);
                if (liveRes.error) console.warn("å³æ™‚å‹•æ…‹ API è­¦å‘Š: " + liveRes.error);

                let allTrains = [];
                
                // 2. è§£æè³‡æ–™ (è§£é–‹å…©å±¤çµæ§‹ + è‡ªå‹•é©æ‡‰æ¬„ä½)
                const rootData = scheduleRes.StationTimetables || scheduleRes;
                
                if (rootData && Array.isArray(rootData)) {
                    rootData.forEach(stationContainer => {
                        // ğŸ”¥ è‡ªå‹•é©æ‡‰: TimeTables æˆ– StationTimetables
                        const innerTrains = stationContainer.TimeTables || stationContainer.StationTimetables || []; 
                        
                        innerTrains.forEach(st => {
                            const getZhTw = (val) => (val && typeof val === 'object' && val.Zh_tw) ? val.Zh_tw : val;
                            const depTime = st.DepartureTime || st.ArrivalTime;
                            if (!depTime) return;

                            // ğŸ”¥ æ¬„ä½è‡ªå‹•é©æ‡‰: DestinationStationName æˆ– EndingStationName
                            const destRaw = st.DestinationStationName || st.EndingStationName;

                            const train = {
                                TrainNo: st.TrainNo,
                                Direction: st.Direction,
                                TrainTypeName: getZhTw(st.TrainTypeName) || 'åˆ—è»Š',
                                TrainTypeCode: st.TrainTypeCode,
                                EndingStationName: getZhTw(destRaw) || 'æœªçŸ¥',
                                ScheduledDepartureTime: depTime,
                                DelayTime: 0,
                                Status: 'future'
                            };
                            allTrains.push(train);
                        });
                    });
                } else {
                    // å¦‚æœæ ¼å¼ä¸å°ï¼Œæ‹‹å‡ºéŒ¯èª¤ä»¥ä¾¿ Debug
                    console.error("API å›å‚³æ ¼å¼ç•°å¸¸:", scheduleRes);
                    throw new Error("Worker å›å‚³äº†éé™£åˆ—è³‡æ–™ï¼Œè«‹æª¢æŸ¥ Console");
                }

                // 3. æ•´åˆèª¤é»è³‡è¨Š
                const liveMap = new Map();
                const liveBoardData = liveRes.StationLiveBoards || liveRes;
                if (liveBoardData && Array.isArray(liveBoardData)) {
                    liveBoardData.forEach(t => liveMap.set(t.TrainNo, t.DelayTime));
                }

                const nowTime = new Date().toTimeString().slice(0, 5);
                allTrains = allTrains.map(train => {
                    if (liveMap.has(train.TrainNo)) {
                        train.DelayTime = liveMap.get(train.TrainNo);
                        train.Status = 'live';
                    }
                    return train;
                }).filter(t => isTimeAfter(t.ScheduledDepartureTime, nowTime, -30));

                allTrains.sort((a, b) => a.ScheduledDepartureTime.localeCompare(b.ScheduledDepartureTime));

                if (allTrains.length > 0) renderBoard(allTrains);
                else showNoData('ä»Šæ—¥å·²ç„¡æ›´å¤šåˆ—è»Šç­æ¬¡ (æˆ–è³‡æ–™ç¯©é¸å¾Œç‚ºç©º)');

            } catch (error) {
                console.error('æŸ¥è©¢å¤±æ•—:', error);
                // ğŸ”¥ã€æ–°å¢ã€‘é¡¯ç¤ºå…·é«”éŒ¯èª¤çµ¦ä½¿ç”¨è€…
                alert(`æŸ¥è©¢å¤±æ•—ï¼\néŒ¯èª¤åŸå› ï¼š${error.message}\nè«‹æª¢æŸ¥ Worker è¨­å®šæˆ– Console`);
                showNoData('ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                queryBtn.disabled = false;
            }
        }

        function renderBoard(trains) {
            const container = document.getElementById('trainContainer');
            const trainsBoard = document.getElementById('trainsBoard');
            const directionFilter = document.getElementById('directionFilter').value;
            const pidsLink = `pids-live.html?station=${currentStationID}&name=${encodeURIComponent(currentStationName)}`;
            document.getElementById('stationTitle').innerHTML = `${currentStationName} åˆ—è»Šå‹•æ…‹ <a href="${pidsLink}" target="_blank" class="pids-btn"><i class="fas fa-desktop"></i> PIDS æ¨¡æ“¬</a>`;
            document.getElementById('stationInfo').textContent = `è»Šç«™ä»£ç¢¼ï¼š${currentStationID}`;
            updateTime();

            let filteredTrains = trains;
            if (directionFilter !== '') {
                filteredTrains = trains.filter(t => String(t.Direction) === directionFilter);
            }

            const grouped = {
                '0': { title: 'é †è¡Œ (å—ä¸‹/è¥¿è¡Œ)', trains: [] },
                '1': { title: 'é€†è¡Œ (åŒ—ä¸Š/æ±ä¸Š)', trains: [] }
            };

            filteredTrains.forEach(train => {
                const dir = String(train.Direction);
                if (grouped[dir]) grouped[dir].trains.push(train);
            });

            let html = '';
            Object.entries(grouped).forEach(([dir, data]) => {
                if (data.trains.length === 0) return;
                const trainsToShow = data.trains.slice(0, 15); 

                html += `<div class="direction-section"><div class="direction-header"><i class="fas fa-arrow-right"></i> ${data.title}</div>`;
                
                trainsToShow.forEach(train => {
                    const timeText = train.ScheduledDepartureTime ? train.ScheduledDepartureTime.slice(0,5) : '--:--';
                    let delayStatus = train.Status === 'live' ? getDelayStatus(train) : '<span class="delay-badge" style="background:#f5f5f5; color:#999;">è¡¨å®š</span>';
                    const trainInfo = getTrainDisplayInfo(train);
                    const isPast = train.Status !== 'live' && isTimeAfter(new Date().toTimeString().slice(0,5), timeText, 0); 
                    const rowOpacity = isPast ? 'opacity: 0.6; filter: grayscale(0.8);' : '';

                    html += `
                        <div class="train-card" style="${rowOpacity}"
                             onclick="showTrainStops('${train.TrainNo}', '${currentStationID}', '${train.EndingStationName}')"
                             onmouseenter="prefetchTrainData('${train.TrainNo}')"
                             title="é»æ“ŠæŸ¥çœ‹æ²¿é€”åœé ç«™">
                            <div class="train-info">
                                <span class="train-type-badge type-${trainInfo.class}">${trainInfo.name}</span>
                                <div class="train-destination">
                                    <div class="train-no">${train.TrainNo} æ¬¡</div>
                                    <div class="destination">å¾€ ${train.EndingStationName}</div>
                                </div>
                            </div>
                            <div class="schedule-time">${timeText}<div class="schedule-label">é–‹è»Š</div></div>
                            <div class="delay-status">${delayStatus}</div>
                        </div>
                    `;
                });
                if (data.trains.length > 15) html += `<div style="text-align:center; padding:10px; color:#999;">... å°šæœ‰ ${data.trains.length - 15} ç­åˆ—è»Šæœªé¡¯ç¤º ...</div>`;
                html += '</div>';
            });

            if (html === '') showNoData('è©²æ–¹å‘ä»Šæ—¥å·²ç„¡æ›´å¤šåˆ—è»Š');
            trainsBoard.innerHTML = html;
            container.style.display = 'block';
        }

        // ============ è¼”åŠ©å‡½å¼ ============
        function getTrainDisplayInfo(train) {
            let name = train.TrainTypeName?.Zh_tw || train.TrainTypeName || 'åˆ—è»Š';
            let cssClass = 'å…¶ä»–';
            const typeID = train.TrainTypeID;

            if (typeID && trainTypeMap.has(typeID)) name = trainTypeMap.get(typeID);
            else {
                if (name.includes('æ™®æ‚ ç‘ª')) cssClass = 'æ™®æ‚ ç‘ª';
                else if (name.includes('å¤ªé­¯é–£')) cssClass = 'å¤ªé­¯é–£';
                else if (name.includes('3000') || name.includes('æ–°è‡ªå¼·')) cssClass = 'è‡ªå¼·3000';
                else if (name.includes('è‡ªå¼·')) cssClass = 'è‡ªå¼·';
                else if (name.includes('è’å…‰')) cssClass = 'è’å…‰';
                else if (name.includes('å€é–“å¿«')) cssClass = 'å€é–“å¿«';
                else if (name.includes('å€é–“')) cssClass = 'å€é–“';
                else if (name.includes('å¾©èˆˆ')) cssClass = 'å¾©èˆˆ';
                else if (name.includes('æ™®å¿«')) cssClass = 'æ™®å¿«';
                else if (name.includes('è§€å…‰')) cssClass = 'è§€å…‰';
            }
            return { name: name, class: cssClass };
        }
        
        function getDelayStatus(train) {
            const delay = train.DelayTime || 0;
            return delay === 0 
                ? '<span class="delay-badge delay-ok"><i class="fas fa-check"></i> æº–é»</span>' 
                : `<span class="delay-badge delay-warn"><i class="fas fa-clock"></i> æ™š ${delay} åˆ†</span>`;
        }

        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const el = document.getElementById('updateTime');
            if (el) el.textContent = timeStr;
        }

        function showNoData(msg) {
            document.getElementById('trainsBoard').innerHTML = `<div class="no-data"><i class="fas fa-inbox"></i><p>${msg}</p></div>`;
            document.getElementById('trainContainer').style.display = 'block';
        }

        function isTimeAfter(targetTime, baseTime, offsetMinutes) {
            if (!targetTime || !baseTime) return true;
            const [h1, m1] = targetTime.split(':').map(Number);
            const [h2, m2] = baseTime.split(':').map(Number);
            const t1 = h1 * 60 + m1;
            let t2 = h2 * 60 + m2 + offsetMinutes;
            if (t1 < t2 && (t2 - t1) > 720) return true;
            return t1 >= t2;
        }

        function addMinutesToTime(timeStr, minutesToAdd) {
            if (!timeStr) return '--:--';
            const [h, m] = timeStr.split(':').map(Number);
            const d = new Date();
            d.setHours(h); d.setMinutes(m + minutesToAdd);
            return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }

        // ============ è·‘é¦¬ç‡ˆé‚è¼¯ ============
        function prefetchTrainData(trainNo) {
            if (trainDataCache[trainNo]) return;
            if (prefetchTimeout) clearTimeout(prefetchTimeout);
            prefetchTimeout = setTimeout(() => {
                // æ”¹å‘ Worker è«‹æ±‚
                const url = `${WORKER_URL}/api/schedule?trainNo=${trainNo}`;
                fetch(url).then(r=>r.json()).then(d => {
                    if(d && d.length > 0) trainDataCache[trainNo] = Promise.resolve([d[0].StopTimes, null]);
                });
            }, 300);
        }

        async function showTrainStops(trainNo, currentStationID, destName) {
            const bar = document.getElementById('trainMarqueeBar');
            const content = document.getElementById('mqContent');
            
            bar.style.display = 'flex';
            document.getElementById('mqTrainNo').textContent = `${trainNo} æ¬¡`;
            document.getElementById('mqDest').textContent = `å¾€ ${destName}`;
            content.innerHTML = '<span style="color:#aaa;">è¼‰å…¥ä¸­...</span>';
            content.style.animation = 'none';

            try {
                // æ”¹ç”¨ Worker æŸ¥è©¢ (æœ€ç©©å®š)
                const [scheduleRes, liveRes] = await Promise.all([
                    fetch(`${WORKER_URL}/api/schedule?trainNo=${trainNo}`).then(r => r.json()).catch(() => []),
                    fetch(`${WORKER_URL}/api/live?trainNo=${trainNo}`).then(r => r.json()).catch(() => ({}))
                ]);

                const stopTimes = (scheduleRes && scheduleRes.length > 0) ? scheduleRes[0].StopTimes : [];
                const liveData = (liveRes.TrainLiveBoards && liveRes.TrainLiveBoards.length > 0) ? liveRes.TrainLiveBoards[0] : null;

                let marqueeHTML = '';
                const delayTime = liveData ? liveData.DelayTime : 0;

                // A. ç›®å‰ä½ç½®
                if (liveData && liveData.StationName) {
                    const lastStation = liveData.StationName.Zh_tw || liveData.StationName;
                    const delayText = delayTime <= 0 ? '<span style="color:#00e676;">(æº–é»)</span>' : `<span style="color:#ff5252;">(æ™š ${delayTime} åˆ†)</span>`;
                    marqueeHTML += `<span style="color:#aaa;">ç›®å‰ä½ç½®ï¼š</span><span style="color:#ffeb3b; font-weight:bold;">${lastStation}</span> ${delayText}`;
                } else {
                    marqueeHTML += `<span style="color:#aaa;">(æš«ç„¡å³æ™‚è¨Šè™Ÿ)</span>`;
                }
                
                marqueeHTML += `<span style="margin:0 20px; border-left:1px solid #555;"></span>`;

                // B. æœ¬ç«™é è¨ˆ
                if (stopTimes.length > 0) {
                    const idx = stopTimes.findIndex(s => s.StationID === currentStationID);
                    if (idx !== -1) {
                        const myStation = stopTimes[idx];
                        const tableTime = myStation.DepartureTime || myStation.ArrivalTime;
                        const predictedTime = addMinutesToTime(tableTime, delayTime);
                        const timeColor = delayTime > 0 ? '#ff5252' : '#4fc3f7';
                        marqueeHTML += `æœ¬ç«™é è¨ˆï¼š<span style="color:${timeColor}; font-weight:bold; font-size:1.2rem;">${predictedTime}</span> é–‹è»Š`;
                    }
                } else {
                    // å¦‚æœ Worker ä¹ŸæŸ¥ä¸åˆ°ï¼Œå˜—è©¦ç”¨åˆ—è¡¨ä¸­çš„è³‡è¨Šè£œæ•‘
                    marqueeHTML += `<span style="color:#aaa;">(ç„¡æ³•å–å¾—è©³ç´°åœé ç«™)</span>`;
                }

                // C. å¾ŒçºŒåœé  (å…¨åˆ—ï¼Œä¸çœç•¥)
                if (stopTimes.length > 0) {
                    const idx = stopTimes.findIndex(s => s.StationID === currentStationID);
                    if (idx !== -1 && idx < stopTimes.length - 1) {
                        const nextStops = stopTimes.slice(idx + 1); // å–å‡ºæ‰€æœ‰
                        const stopsHTML = nextStops.map(s => 
                            `<span class="station-stop">${s.StationName.Zh_tw}</span>`
                        ).join('<span class="station-arrow">â–¶</span>');
                        marqueeHTML += `<span style="margin:0 20px; border-left:1px solid #555;"></span><span style="color:#aaa;">å¾ŒçºŒåœé ï¼š</span>${stopsHTML}`;
                    }
                }

                content.innerHTML = marqueeHTML;
                void content.offsetHeight;
                const duration = Math.max(10, content.innerText.length * 0.35);
                content.style.animation = `marquee-scroll ${duration}s linear infinite`;

            } catch (e) { console.error(e); content.innerHTML = 'ç„¡æ³•è¼‰å…¥'; }
        }

        function closeMarquee() { document.getElementById('trainMarqueeBar').style.display = 'none'; }
    </script>
</body>
</html>