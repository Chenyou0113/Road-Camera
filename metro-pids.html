<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro PIDS - TPASS 2.0 Edition</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&family=Roboto:wght@700;900&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --theme-color: #8246af;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
        }

        body {
            background-color: #000;
            height: 100vh;
            width: 100vw;
            display: flex;
        }

        /* ğŸ“± æ‰‹æ©Ÿç‰ˆå…è¨±æ»‘å‹• */
        @media (max-width: 768px) {
            body {
                overflow: visible;
                height: auto;
                min-height: 100vh;
            }
        }

        /* ğŸ–¥ï¸ æ¡Œé¢ç‰ˆä¿æŒåŸè¨­è¨ˆ */
        @media (min-width: 769px) {
            body {
                overflow: hidden;
                height: 100vh;
            }
        }

        .pids-wrapper {
            display: grid;
            grid-template-columns: 24% 76%;
            grid-template-rows: 90% 10%;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            border-right: 2px solid #ccc;
            background-color: #fff;
            height: 100%;
            overflow: hidden;
        }

        .station-header {
            height: 10%;
            min-height: 60px;
            background-color: var(--theme-color);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 12px;
        }

        .st-badge {
            background: #fff;
            color: var(--theme-color);
            font-weight: 900;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 1.4vw;
        }

        .st-name-zh {
            font-size: 1.8vw;
            font-weight: 900;
        }

        .st-name-en {
            font-size: 1.0vw;
            font-weight: 700;
            margin-left: 4px;
            opacity: 0.9;
        }

        .st-title-group {
            display: flex;
            flex-direction: column;
            justify-content: center;
            line-height: 1.1;
        }

        .arrival-info {
            flex: 1;
            padding: 1vh 1vw;
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid #eee;
            justify-content: center;
        }

        .arrival-info.secondary {
            background-color: #fcfcfc;
        }

        .dir-label {
            font-size: 1.2vw;
            font-weight: 900;
            color: #555;
            margin-bottom: 2px;
        }

        .line-tag-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .line-badge-small {
            background: var(--theme-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 1vw;
            font-weight: 900;
            min-width: 45px;
            text-align: center;
        }

        .dest-zh {
            font-size: 2.2vw;
            font-weight: 900;
            color: #000;
            line-height: 1.2;
        }

        .dest-en {
            font-size: 1.1vw;
            color: #888;
            font-weight: 700;
        }

        /* --- æ™‚é–“æ¡†æ¨£å¼å„ªåŒ– --- */
        .time-box {
            background-color: var(--theme-color);
            color: white;
            margin-top: 5px;
            text-align: center;
            font-size: 3.5vw;
            font-weight: 700;
            border-radius: 8px;
            padding: 0.5vh 0;
            font-family: 'Roboto', sans-serif;
            width: 95%;
            align-self: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            transition: 0.3s;
            /* ç¢ºä¿æ–‡å­—å‚ç›´ç½®ä¸­ */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 6vh;
        }

        .time-box.arriving {
            background-color: #d32f2f;
            animation: pulse 1s infinite;
        }

        .time-box.approaching {
            background-color: #f58220;
        }

        /* ğŸ”¥ æœ«ç­è»Šå·²é§›é›¢ (å­—é«”ç¸®å°ä»¥å¡å…¥æ¡†å…§) */
        .time-box.end-service {
            font-size: 1.8vw;
            /* ç¸®å°å­—é«” */
            background-color: #444;
            /* æ·±ç°åº•è‰² */
            font-family: 'Noto Sans TC', sans-serif;
            /* æ”¹å›ä¸­æ–‡é«” */
            padding: 0 10px;
        }

        .weather-box {
            height: 18%;
            background: #fff;
            border-top: 2px solid #ccc;
            display: grid;
            grid-template-columns: 1fr 2.5fr;
            grid-template-rows: 1fr 1fr;
            align-items: stretch;
        }

        .w-icon-area {
            grid-row: 1 / span 2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
            background: #f4f7f9;
            border-right: 1px solid #eee;
        }

        .w-icon-large {
            font-size: 4vw;
            color: #607d8b;
        }

        .w-desc {
            font-size: 1.3vw;
            font-weight: 700;
            color: #555;
        }

        .w-top-info {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 1vw;
            border-bottom: 1px solid #eee;
        }

        .w-bottom-info {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 1vw;
        }

        .w-range-text {
            font-size: 2vw;
            font-weight: 900;
            color: #d32f2f;
        }

        .w-rain-text {
            font-size: 2vw;
            font-weight: 900;
            color: #5a9fd4;
        }

        .main-display {
            display: grid;
            grid-template-rows: 1fr 130px;
            background-color: #000;
            position: relative;
        }

        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        #video-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            transform: scale(1.01);
        }

        /* --- PIDS æ“æ“ åº¦å„ªåŒ–ç‰ˆ (åŠ å¤§ + æ•¸å­—) --- */
        .congestion-area {
            background: #fff;
            border-top: 2px solid #ccc;
            padding: 15px 30px;
            /* å¢åŠ å…§è· */
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
            /* å¢åŠ é«˜åº¦ */
            gap: 15px;
            /* å…©åˆ—ä¹‹é–“çš„è·é›¢ */
        }

        .cong-row {
            display: flex;
            align-items: center;
            gap: 20px;
            width: 100%;
        }

        .cong-label {
            font-size: 1.5vw;
            /* å­—é«”åŠ å¤§ */
            font-weight: 900;
            color: #333;
            width: 250px;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
        }

        .cong-bar-container {
            flex: 1;
            display: flex;
            gap: 6px;
            /* æ–¹å¡Šé–“è· */
            height: 40px;
            /* æ–¹å¡Šé«˜åº¦åŠ å¤§ */
            background: #e2e8f0;
            padding: 4px;
            border-radius: 8px;
        }

        .cong-car {
            flex: 1;
            border-radius: 4px;
            background-color: #cbd5e1;
            /* é è¨­ç° */

            /* æ•¸å­—ç½®ä¸­ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.2rem;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            transition: 0.3s;
        }

        /* é¡è‰²å®šç¾© (ç¨å¾®äº®ä¸€é») */
        .cong-lvl-1 {
            background-color: #32b900;
        }

        .cong-lvl-2 {
            background-color: #ffcc00;
            color: #000;
            text-shadow: none;
        }

        /* é»ƒè‰²é»‘å­— */
        .cong-lvl-3 {
            background-color: #f58220;
        }

        .cong-lvl-4 {
            background-color: #d32f2f;
        }

        .cong-no-data {
            color: #94a3b8;
            font-size: 1vw;
            font-weight: 700;
            text-align: center;
            width: 100%;
        }

        .footer {
            grid-column: 1/3;
            display: grid;
            grid-template-columns: 24% 76%;
            background: #1a1a1a;
            color: #fff;
        }

        .clock-section {
            background: #d32f2f;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2vw;
            font-weight: 900;
            font-family: 'Roboto', sans-serif;
        }

        .marquee-section {
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0;
            position: relative;
            /* å¿…é ˆç‚ºç›¸å°å®šä½ */
            width: 100%;
        }

        .marquee-text {
            white-space: nowrap;
            font-size: 1.7vw;
            font-weight: 700;
            position: absolute;
            /* å¿…é ˆç‚ºçµ•å°å®šä½ä¾› JS æ§åˆ¶ */
            left: 100%;
            will-change: transform;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* ğŸ“± æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .pids-wrapper {
                display: flex;
                flex-direction: column;
                grid-template-columns: unset;
                grid-template-rows: unset;
                min-height: 100vh;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }

            .station-header {
                order: 1;
                height: auto;
                min-height: 55px;
                padding: 12px 15px;
                gap: 12px;
            }

            .st-badge {
                font-size: 1.8rem;
                padding: 6px 12px;
            }

            .st-name-zh {
                font-size: 2.2rem;
                font-weight: 900;
            }

            .st-name-en {
                font-size: 1.2rem;
                font-weight: 700;
            }

            /* æ‰‹æ©Ÿç‰ˆç¨ç«‹æ™‚é–“æ¡† */
            .clock-section {
                order: 2;
                background: #d32f2f;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 1.5rem;
                font-weight: 900;
                font-family: 'Roboto', sans-serif;
                padding: 8px 0;
                color: #fff;
                border-bottom: 2px solid #ccc;
                width: 100%;
            }

            /* æ‰‹æ©Ÿç‰ˆç¨ç«‹è·‘é¦¬ç‡ˆ */
            .marquee-section {
                order: 3;
                overflow: hidden;
                display: flex;
                align-items: center;
                padding: 0;
                position: relative;
                width: 100%;
                min-height: 46px;
                background: #1a1a1a;
                border-bottom: 2px solid #ccc;
            }

            .marquee-text {
                white-space: nowrap;
                font-size: 1.5rem !important;
                font-weight: 700;
                position: absolute;
                left: 100%;
                will-change: transform;
                color: #fff;
                letter-spacing: 1px;
                line-height: 46px;
            }

            #block-dir0 {
                order: 4;
            }

            #block-dir1 {
                order: 5;
            }

            .arrival-info {
                padding: 1.2vh 1.2vw;
                min-height: auto;
                border-bottom: 2px solid #ccc;
                background-color: #fff;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .arrival-info.secondary {
                background-color: #fcfcfc;
            }

            /* ğŸ“± æ‰‹æ©Ÿç‰ˆæœˆå°æ“æ“ åº¦ */
            .mobile-congestion {
                margin-top: 10px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 8px;
                border: 1px solid #e9ecef;
            }

            .mobile-cong-label {
                font-size: 0.9rem;
                font-weight: 700;
                color: #666;
                margin-bottom: 8px;
                text-align: center;
            }

            .mobile-cong-bars {
                display: flex;
                gap: 4px;
                justify-content: center;
            }

            .mobile-cong-car {
                flex: 1;
                height: 32px;
                max-width: 45px;
                border-radius: 4px;
                background-color: #cbd5e1;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 900;
                font-size: 0.85rem;
                color: #fff;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
                transition: 0.3s;
            }

            /* æ‰‹æ©Ÿç‰ˆæ“æ“ åº¦é¡è‰²ç­‰ç´š */
            .mobile-cong-car.cong-lvl-1 {
                background-color: #32b900;
            }

            .mobile-cong-car.cong-lvl-2 {
                background-color: #ffcc00;
                color: #000;
                text-shadow: none;
            }

            .mobile-cong-car.cong-lvl-3 {
                background-color: #f58220;
            }

            .mobile-cong-car.cong-lvl-4 {
                background-color: #d32f2f;
            }

            .dir-label {
                /* é è‰²åŠ æ·±ä¸¦ä¼˜åŒ–ä½“éªŒ */
                font-size: 1.1rem !important;
                font-weight: 900;
                color: #555;
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .line-tag-row {
                gap: 8px;
                display: flex;
                align-items: center;
                margin-bottom: 8px;
            }

            .line-badge-small {
                /* ğŸ”¥ é‡é»ï¼šä½¿ç”¨ !important å¼·åˆ¶è¦†è“‹ JS çš„ vw è¨­å®š */
                font-size: 1.6rem !important;
                
                /* èª¿æ•´å…§è·èˆ‡å¯¬åº¦ï¼Œè®“å®ƒçœ‹èµ·ä¾†åƒå€‹æ˜é¡¯çš„æ¨™ç‰Œ */
                padding: 2px 10px !important;
                min-width: 68px !important;
                height: 42px;
                
                /* æ–‡å­—ç½®ä¸­ */
                text-align: center;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                
                background: var(--theme-color);
                color: white;
                border-radius: 6px;
                font-weight: 900;
                
                /* å¾®èª¿ä½ç½®ï¼Œè®“è¦–è¦ºä¸Šè·Ÿä¸­æ–‡æ›´å°é½Š */
                margin-right: 6px;
                margin-top: 4px;
            }

            /* ğŸ“± æ‰‹æ©Ÿç‰ˆä¸Šæ–¹å€åŸŸï¼šç«™åå’Œæ™‚é–“ä¸¦æ’åœ¨åŒä¸€è¡Œ */
            .mobile-top-row {
                display: flex;
                align-items: center; /* è®“ç«™åè·Ÿå¤§æ™‚é–“æ¡†å‚ç›´ç½®ä¸­å°é½ */
                justify-content: space-between;
                gap: 12px;
                margin-bottom: 5px;
            }

            .mobile-dest-section {
                flex: 1;
                min-width: 0; /* ç¢ºä¿ flex å­å…ƒç´ å¯ä»¥ç¸®å° */
                padding-right: 8px; /* è·Ÿå³é‚Šçš„æ™‚é–“æ¡†ä¿æŒè·é›¢ */
            }

            .countdown-label {
                /* å€’æ•¸è¨ˆæ™‚ï¼šæ¥µå¤§åŒ–ï¼ˆè¦–è¦ºä¸­å¿ƒï¼‰ */
                display: flex !important;
                align-items: center;
                justify-content: center;
                
                /* ğŸ”¥ è¶…å¤§å­—é«”èˆ‡æ¡† */
                font-size: 2.2rem !important;
                height: 60px;
                min-width: 110px;
                
                /* æ·±è‰²åº•ç™½å­—ï¼Œæ›´é†’ç›® */
                background-color: #333 !important;
                color: #fff !important;
                border: none;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                
                /* å…¶ä»–ä¿æŒ */
                padding: 0 12px;
                font-weight: 900;
                flex-shrink: 0;
                font-family: 'Roboto', sans-serif;
            }
            
            /* é‡å°é€²ç«™ä¸­ç‹€æ…‹çš„ç‰¹æ®Šæ¨£å¼ */
            .countdown-label.arriving {
                background-color: #d32f2f;
                animation: pulse 1s infinite;
            }
            
            .countdown-label.approaching {
                background-color: #f58220;
            }

            .dest-zh {
                /* å¾®èª¿åˆ° 2.0remï¼Œç‚ºè¶…å¤§æ™‚é–“æ¡†é¨°å‡ºç©ºé–“ */
                font-size: 2.0rem !important;
                font-weight: 900;
                color: #000;
                line-height: 1.1;
                margin: 0;
                
                /* è®“å­—ç¨å¾®é ç·Šä¸€é»ï¼Œäº‰å–ç©ºé–“ */
                letter-spacing: -1px;
                
                /* é¿å…å­—å¤ªé•·æ™‚æ’²åˆ°å³é‚Šçš„æ™‚é–“æ¡† */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                
                /* è®“å®ƒç›¡é‡ä½”æ»¿ä½™ä¸‹çš„ç©ºé–“ */
                flex: 1;
            }

            /* è‹±æ–‡ç«™ååŠ æ·±ä¸€é»ï¼Œæå‡æˆ¶å¤–é–±è®€æ€§ */
            .dest-en {
                /* ğŸ”¥ ç¸®å°å­—é«”ï¼šå¾åŸæœ¬çš„ 1.1 é™åˆ° 0.95rem */
                font-size: 0.95rem !important;
                
                /* é¡è‰²å¾®èª¿æ·±åŒ– */
                color: #666 !important;
                font-weight: 700;
                
                /* ä¿æŒå–®è¡Œï¼Œä¸æ›è¡Œï¼Œé¿å…æ’é«˜ç‰ˆé¢ */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                
                display: block;
                margin-top: 2px;
                letter-spacing: -0.2px;
            }

            .time-box {
                display: none !important; /* æ‰‹æ©Ÿç‰ˆéš±è—æ¡Œé¢ç‰ˆæ™‚é–“æ¡† */
            }

            .time-box.arriving {
                background-color: #d32f2f;
                animation: pulse 1s infinite;
            }

            .time-box.approaching {
                background-color: #f58220;
            }

            .time-box.end-service {
                font-size: 1.4rem;
                background-color: #444;
                font-family: 'Noto Sans TC', sans-serif;
            }

            .weather-box {
                order: 6;
                height: auto;
                display: grid;
                grid-template-columns: 120px 1fr;
                grid-template-rows: 1fr 1fr;
                padding: 15px;
                border-bottom: 2px solid #ccc;
                background: #fff;
                gap: 10px;
                align-items: center;
            }

            .w-icon-area {
                grid-row: 1 / span 2;
                grid-column: 1;
                border-right: 1px solid #eee;
                padding-right: 10px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 8px;
            }

            .w-icon-large {
                font-size: 3.5rem;
                color: #607d8b;
            }

            .w-desc {
                font-size: 1.2rem;
                font-weight: 700;
                color: #555;
                text-align: center;
                line-height: 1.2;
            }

            .w-top-info {
                grid-row: 1;
                grid-column: 2;
                display: flex;
                justify-content: flex-start;
                align-items: center;
                padding: 0;
            }

            .w-bottom-info {
                grid-row: 2;
                grid-column: 2;
                display: flex;
                justify-content: flex-start;
                align-items: center;
                padding: 0;
            }

            .w-range-text,
            .w-rain-text {
                font-size: 1.8rem;
                font-weight: 900;
            }

            .w-range-text {
                color: #d32f2f;
            }

            .w-rain-text {
                color: #5a9fd4;
            }

            .main-display {
                order: 7;
                display: grid;
                grid-template-rows: auto;
                grid-template-columns: 1fr;
                background-color: #000;
                height: 300px;
                border-top: 2px solid #ccc;
            }

            .video-container {
                display: block !important;
                width: 100%;
                height: 100%;
                position: relative;
                overflow: hidden;
                background: #000;
            }

            .congestion-area {
                display: none;
            }

            /* éš±è—æ¡Œé¢ç‰ˆ Footer */
            .footer {
                display: none;
            }
        }

        /* ğŸ–¥ï¸ æ¡Œé¢ç‰ˆä¿æŒåŸè¨­è¨ˆ */
        @media (min-width: 769px) {
            .pids-wrapper {
                display: grid !important;
                grid-template-columns: 24% 76% !important;
                grid-template-rows: 90% 10% !important;
                width: 100% !important;
                height: 100% !important;
                background-color: #f0f0f0 !important;
            }
            
            .sidebar {
                display: flex !important;
                flex-direction: column !important;
                border-right: 2px solid #ccc !important;
                background-color: #fff !important;
                height: 100% !important;
                overflow: hidden !important;
            }
            
            .main-display {
                display: grid !important;
                grid-template-rows: 1fr 130px !important;
                background-color: #000 !important;
                position: relative !important;
            }
            
            .congestion-area {
                display: flex !important;
            }
            
            .footer {
                display: grid !important;
            }
            
            .clock-section:not(#clock) {
                display: flex;
            }
            
            .marquee-section:not(:has(#ui-marquee)) {
                display: flex;
            }
            
            /* æ¡Œé¢ç‰ˆéš±è—æ‰‹æ©Ÿç‰ˆå°ˆç”¨å…ƒç´  */
            #clock {
                display: none !important;
            }
            
            .marquee-section:has(#ui-marquee) {
                display: none !important;
            }
            
            .mobile-congestion {
                display: none !important;
            }
            
            .countdown-label {
                display: none !important;
            }
            
            /* æ¡Œé¢ç‰ˆä¿æŒåŸæœ‰ä½ˆå±€ */
            .mobile-top-row {
                display: block !important;
            }
            
            .mobile-dest-section {
                display: block !important;
            }
            
            .mobile-time-section {
                display: block !important;
                margin-top: 5px !important;
                flex-direction: initial !important;
                gap: initial !important;
            }
            
            .mobile-time-label {
                display: none !important;
            }
            
            .mobile-dest-row {
                display: block !important;
            }
            
            .mobile-dest-info {
                display: block !important;
                flex: none !important;
            }
            
            .dest-zh {
                font-size: 2.2vw !important;
                margin: 0 !important;
            }
            
            .dest-en {
                font-size: 1.1vw !important;
                margin-top: 2px !important;
            }
            
            .time-box {
                display: flex !important; /* æ¡Œé¢ç‰ˆé¡¯ç¤ºæ™‚é–“æ¡† */
                background-color: var(--theme-color) !important;
                color: white !important;
                margin-top: 5px !important;
                text-align: center !important;
                font-size: 3.5vw !important;
                font-weight: 700 !important;
                border-radius: 8px !important;
                padding: 0.5vh 0 !important;
                font-family: 'Roboto', sans-serif !important;
                width: 95% !important;
                align-self: center !important;
                min-width: auto !important;
                flex-shrink: initial !important;
                min-height: 6vh !important;
                align-items: center !important;
                justify-content: center !important;
            }
        }

        /* ğŸ“± è¶…å°å±æ‰‹æ©Ÿ */
        @media (max-width: 480px) {
            .st-badge {
                font-size: 1rem;
            }

            .st-name-zh {
                font-size: 1.1rem;
            }

            .dest-zh {
                font-size: 1.2rem;
            }

            .dest-en {
                font-size: 0.7rem;
            }

            .time-box {
                font-size: 1.5rem;
                min-height: 45px;
            }

            .cong-label {
                font-size: 0.9rem;
            }

            .cong-bar-container {
                height: 30px;
            }

            .marquee-text {
                font-size: 0.8rem;
            }

            .congestion-area {
                padding: 10px;
                gap: 10px;
            }
        }
    </style>
</head>

<body>

    <div class="pids-wrapper">
        <div class="sidebar">
            <div class="station-header" id="ui-header">
                <div class="st-badge" id="ui-st-id">--</div>
                <div class="st-title-group">
                    <div class="st-name-zh" id="ui-st-name">è¼‰å…¥ä¸­...</div>
                    <div class="st-name-en" id="ui-st-name-en"></div>
                </div>
            </div>

            <div class="clock-section" id="clock">00:00</div>
        
            <div class="marquee-section">
                <div class="marquee-text" id="ui-marquee">TPASS 2.0 å…¬é‹å¸¸å®¢å„ªæƒ æ­£å¼ä¸Šç·šï¼æ­è¶Šå¤šå›é¥‹è¶Šå¤š...</div>
            </div>

            <div class="arrival-info" id="block-dir0">
                <div class="dir-label">ç¬¬ä¸€æœˆå° Platform 1</div>
                <div class="mobile-top-row">
                    <div class="mobile-dest-section">
                        <div class="line-tag-row">
                            <div class="line-badge-small" id="ui-line-tag-1"></div>
                            <div class="dest-zh" id="dir0-dest">--</div>
                        </div>
                        <div class="dest-en" id="dir0-en"></div>
                    </div>
                    <div class="countdown-label" id="countdown-0">å€’æ•¸æ™‚é–“</div>
                </div>
                <!-- ï¿½ï¸ æ¡Œé¢ç‰ˆæ™‚é–“æ¡† -->
                <div class="time-box" id="dir0-time">-- : --</div>
                <!-- ï¿½ğŸ“± æ‰‹æ©Ÿç‰ˆæ“æ“ åº¦ -->
                <div class="mobile-congestion" id="mobile-cong-0" style="display: none;">
                    <div class="mobile-cong-label">è»Šå»‚æ“æ“ åº¦</div>
                    <div class="mobile-cong-bars" id="mobile-cong-bars-0"></div>
                </div>
            </div>

            <div class="arrival-info secondary" id="block-dir1">
                <div class="dir-label">ç¬¬äºŒæœˆå° Platform 2</div>
                <div class="mobile-top-row">
                    <div class="mobile-dest-section">
                        <div class="line-tag-row">
                            <div class="line-badge-small" id="ui-line-tag-2"></div>
                            <div class="dest-zh" id="dir1-dest">--</div>
                        </div>
                        <div class="dest-en" id="dir1-en"></div>
                    </div>
                    <div class="countdown-label" id="countdown-1">å€’æ•¸æ™‚é–“</div>
                </div>
                <!-- ï¿½ï¸ æ¡Œé¢ç‰ˆæ™‚é–“æ¡† -->
                <div class="time-box" id="dir1-time">-- : --</div>
                <!-- ï¿½ğŸ“± æ‰‹æ©Ÿç‰ˆæ“æ“ åº¦ -->
                <div class="mobile-congestion" id="mobile-cong-1" style="display: none;">
                    <div class="mobile-cong-label">è»Šå»‚æ“æ“ åº¦</div>
                    <div class="mobile-cong-bars" id="mobile-cong-bars-1"></div>
                </div>
            </div>

            <div class="weather-box">
                <div class="w-icon-area">
                    <div class="w-icon-large" id="ui-weather-icon"><i class="fas fa-cloud-sun"></i></div>
                    <div class="w-desc" id="ui-weather-text">--</div>
                </div>
                <div class="w-top-info"><span class="w-range-text" id="ui-range-display">--Â°C ~ --Â°C</span></div>
                <div class="w-bottom-info"><span class="w-rain-text" id="ui-rain-display"><i
                            class="fas fa-umbrella"></i> --%</span></div>
            </div>
        </div>

        <div class="main-display">
            <div class="video-container">
                <iframe id="video-iframe"
                    src="https://www.youtube.com/embed/Y_siE2Wsp38?autoplay=1&mute=1&loop=1&playlist=Y_siE2Wsp38&controls=0&modestbranding=1&rel=0"
                    allow="autoplay; encrypted-media">
                </iframe>
            </div>
            <div class="congestion-area"></div>
        </div>

        <div class="footer" style="display: none;">
            <div class="clock-section" id="clock-desktop">00:00</div>
            <div class="marquee-section">
                <div class="marquee-text" id="ui-marquee-desktop">TPASS 2.0 å…¬é‹å¸¸å®¢å„ªæƒ æ­£å¼ä¸Šç·šï¼æ­è¶Šå¤šå›é¥‹è¶Šå¤š...</div>
            </div>
        </div>
    </div>

    <script>
        const METRO_STATIONS = fetch('metro-stations-raw.json').then(r => r.json()).catch(() => null);

        // ğŸš¨ é€™æ˜¯ TDX Worker (çµ¦éåŒ—æ·ç³»çµ±ç”¨)
        const METRO_API_TDX = 'https://metro-api-worker.weacamm.org/api';

        // ğŸ”¥ é€™æ˜¯æ‚¨æ–°éƒ¨ç½²çš„ TRTC å°ˆå±¬ Worker (æ³¨æ„ï¼šå»æ‰äº† /api)
        const METRO_API_TRTC = 'https://trtc-metro-api.weacamm.org';

        const WEATHER_API = 'https://cwa-weather-proxy.weacamm.org';

        const params = new URLSearchParams(window.location.search);
        const system = params.get('sys') || params.get('system') || 'TYMC';
        const station = params.get('sid') || params.get('station') || 'A8';

        let countdownSecs = { dir0: -1, dir1: -1 };
        const sysColors = { 'TRTC': '#0070bd', 'KRTC': '#f58220', 'TYMC': '#8246af', 'TMRT': '#b2d235', 'NTMC': '#0096cc', 'KLRT': '#008010' };
        let GLOBAL_STATIONS = null;

        function updateClock() {
            const n = new Date();
            const d = `${String(n.getMonth() + 1).padStart(2, '0')}/${String(n.getDate()).padStart(2, '0')}`;
            const t = n.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const timeText = `${d} ${t}`;
            
            // æ‰‹æ©Ÿç‰ˆæ™‚é˜
            const mobileClock = document.getElementById('clock');
            if (mobileClock) mobileClock.innerText = timeText;
            
            // æ¡Œé¢ç‰ˆæ™‚é˜
            const desktopClock = document.getElementById('clock-desktop');
            if (desktopClock) desktopClock.innerText = timeText;
        }

        async function init() {
            // éåŒ—æ·ç³»çµ±éš±è—æ“æ“ åº¦å€å¡Šä¸¦èª¿æ•´ç‰ˆé¢
            if (system !== 'TRTC') {
                document.querySelector('.congestion-area').style.display = 'none';
                document.querySelector('.main-display').style.gridTemplateRows = '1fr';
            }

            document.documentElement.style.setProperty('--theme-color', sysColors[system] || '#333');
            document.getElementById('ui-st-id').innerText = station;

            Promise.allSettled([
                METRO_STATIONS.then(data => {
                    GLOBAL_STATIONS = data;
                    if (data?.systems[system]) {
                        // å°‹æ‰¾è»Šç«™ (æ–°æ¶æ§‹ï¼šsystems[sys] æ˜¯ Array)
                        const lines = data.systems[system];
                        let foundStation = null;
                        let foundLine = null;

                        for (const line of lines) {
                            const s = line.stations.find(st => st.sid === station);
                            if (s) {
                                foundStation = s;
                                foundLine = line;
                                break;
                            }
                        }

                        if (foundStation) {
                            document.getElementById('ui-st-name').innerText = foundStation.name_zh;
                            document.getElementById('ui-st-name-en').innerText = foundStation.name_en; // ç¢ºä¿é€™è£¡ä¹Ÿæœ‰è‹±æ–‡

                            let themeColor = foundLine.color;
                            if (system === 'TRTC') {
                                if (station.startsWith('GA')) themeColor = '#8fc31f';
                                if (station.startsWith('RA')) themeColor = '#fd92a3';
                            }
                            if (system === 'KRTC') {
                                if (station.startsWith('R')) themeColor = '#e3002c';
                                if (station.startsWith('O')) themeColor = '#f8b61c';
                            }
                            if (themeColor) document.documentElement.style.setProperty('--theme-color', themeColor);
                        }
                    }
                }),
                updateData(),
                updateWeather(),
                updateMarquee()
            ]);

            setInterval(updateData, 15000);
            setInterval(updateWeather, 600000);
            setInterval(updateMarquee, 300000);
            updateClock();
            setInterval(updateClock, 1000);

            setInterval(() => {
                [0, 1].forEach(i => {
                    if (countdownSecs[`dir${i}`] > 0) {
                        countdownSecs[`dir${i}`]--;
                        renderTime(i);
                    }
                });
            }, 1000);
        }

        function getOfflineStatus() {
            const h = new Date().getHours();
            const isLateNight = (h >= 23 || h < 6);
            if (isLateNight) {
                return {
                    destZh: "ç‡Ÿé‹çµæŸ", destEn: "Service Ended",
                    timeText: "æœ«ç­è»Šå·²é§›é›¢", timeClass: "time-box end-service"
                };
            }
            return {
                destZh: "æš«ç„¡åˆ—è»Š", destEn: "No Service",
                timeText: "-- : --", timeClass: "time-box"
            };
        }

        async function updateData() {
            try {
                let nextTrains = [null, null];

                // --- 1. åŒ—æ· (TRTC) å°ˆç”¨é‚è¼¯ ---
                if (system === 'TRTC') {
                    nextTrains = await fetchTRTCData();
                }
                // --- 2. å…¶ä»–æ·é‹ (TDX) é‚è¼¯ ---
                else {
                    const res = await fetch(`${METRO_API_TDX}/liveboard?sys=${system}&sid=${station.toUpperCase()}`);
                    const sData = await res.json();

                    if (sData && sData.length > 0) {
                        if (system === 'TYMC') {
                            const toTaipei = sData.find(t => t.DestinationStationName.Zh_tw.includes('å°åŒ—è»Šç«™'));
                            const toSouth = sData.find(t => !t.DestinationStationName.Zh_tw.includes('å°åŒ—è»Šç«™'));
                            nextTrains = [toSouth, toTaipei];
                        } else if (system === 'KLRT') {
                            nextTrains = [sData[0], sData.length > 1 ? sData[1] : null];
                        } else {
                            const dests = [...new Set(sData.map(item => item.DestinationStationName.Zh_tw))];
                            if (dests.length >= 2) {
                                nextTrains[0] = sData.find(t => t.DestinationStationName.Zh_tw === dests[0]);
                                nextTrains[1] = sData.find(t => t.DestinationStationName.Zh_tw === dests[1]);
                            } else {
                                nextTrains[0] = sData[0];
                                nextTrains[1] = sData.length > 1 ? sData[1] : null;
                            }
                        }

                        // æ›´æ–°è»Šç«™è‹±æ–‡
                        if (sData[0].StationName) {
                            if (sData[0].StationName.En) document.getElementById('ui-st-name-en').innerText = sData[0].StationName.En;
                            // é‡å° KRTC è‰è¡™ç«™èˆ‡å…¶ä»–å¯èƒ½ç¼ºæ¼
                            if (station === 'R4A' && system === 'KRTC') document.getElementById('ui-st-name-en').innerText = 'Caoya';
                        }
                    }
                }

                updateUI(0, nextTrains[0]);
                updateUI(1, nextTrains[1]);
                updateCongestion(nextTrains);

            } catch (e) {
                console.error("Fetch Data Error:", e);
                setOfflineUI(0); setOfflineUI(1);
            }
        }

        // ğŸ”¥ å°ˆæ¥­æ¨¡å¼ï¼šPIDS å°ˆç”¨è³‡æ–™æŠ“å– (å«ç’°ç‹€ç·šæ”¯æ´)
        async function fetchTRTCData() {
            const res = await fetch(`${METRO_API_TRTC}/arrival`);
            const rawData = await res.json();

            const targetStationID = station.toUpperCase().trim(); // ä¾‹å¦‚ Y11
            const stNameEl = document.getElementById('ui-st-name');
            const targetName = stNameEl.innerText.replace('ç«™', '');

            // 1. åˆ¤æ–·ç•¶å‰æ˜¯å“ªæ¢ç·š
            let currentLine = '';
            if (targetStationID.startsWith('BR')) currentLine = 'BR';
            else if (targetStationID.startsWith('BL')) currentLine = 'BL';
            else if (targetStationID.startsWith('Y')) currentLine = 'Y';
            else if (targetStationID.startsWith('GA')) currentLine = 'GA';
            else if (targetStationID.startsWith('RA')) currentLine = 'RA';
            else currentLine = targetStationID.substring(0, 1); // R, G, O

            // 2. å®šç¾©å„è·¯ç·šçš„åˆæ³•ç›®çš„åœ° (ç™½åå–®)
            const VALID_DESTINATIONS = {
                'BR': ['å‹•ç‰©åœ’', 'å—æ¸¯å±•è¦½é¤¨'],
                'BL': ['å—æ¸¯å±•è¦½é¤¨', 'é ‚åŸ”', 'äºæ±é†«é™¢', 'æ˜†é™½'],
                'R': ['æ·¡æ°´', 'è±¡å±±', 'åŒ—æŠ•', 'å¤§å®‰', 'æ–°åŒ—æŠ•'],
                'G': ['æ¾å±±', 'æ–°åº—', 'å°é›»å¤§æ¨“', 'å°ç¢§æ½­'],
                'O': ['è¿´é¾', 'å—å‹¢è§’', 'è˜†æ´²'],
                'Y': ['å¤§åªæ—', 'æ–°åŒ—ç”¢æ¥­åœ’å€'],
                'GA': ['å°ç¢§æ½­', 'ä¸ƒå¼µ'],
                'RA': ['æ–°åŒ—æŠ•', 'åŒ—æŠ•']
            };

            const allowedDests = VALID_DESTINATIONS[currentLine] || [];

            // 3. åš´æ ¼ç¯©é¸
            const stationTrains = rawData.filter(t => {
                // A. å¦‚æœ ID å®Œå…¨å»åˆï¼Œç›´æ¥æ”¾è¡Œ
                if (t.StationID && t.StationID === targetStationID) return true;

                // B. é‡å°è½‰ä¹˜ç«™ (å¦‚æ™¯å®‰)ï¼šå…è¨± Y ç·šå’Œ O ç·šå…±å­˜ï¼Œä½†åªæŠ“å±¬æ–¼æœ¬æœˆå°çš„
                const apiName = (t.StationName || "").replace('ç«™', '').trim();
                if (apiName === targetName) {
                    const dest = t.DestinationName || "";
                    // æª¢æŸ¥é€™ç­è»Šçš„ç›®çš„åœ°ï¼Œæ˜¯ä¸æ˜¯å±¬æ–¼é€™æ¢ç·š
                    return allowedDests.some(d => dest.includes(d));
                }
                return false;
            });

            if (stationTrains.length === 0) return [null, null];

            // 4. ç‡Ÿé‹æ¨¡å¼æ–¹å‘å®šç¾© (æ±ºå®šå“ªé‚Šæ˜¯ä¸Šè¡Œ/ç¬¬ä¸€æœˆå°)
            const TRTC_UPSTREAM_DESTS = {
                'BR': ['å—æ¸¯å±•è¦½é¤¨'],
                'R': ['æ·¡æ°´', 'åŒ—æŠ•', 'æ–°åŒ—æŠ•'],
                'G': ['æ¾å±±'],
                'O': ['è¿´é¾', 'è˜†æ´²'],
                'BL': ['å—æ¸¯å±•è¦½é¤¨'],
                'Y': ['æ–°åŒ—ç”¢æ¥­åœ’å€'],
                'GA': ['å°ç¢§æ½­'],
                'RA': ['æ–°åŒ—æŠ•']
            };

            const upstreamList = TRTC_UPSTREAM_DESTS[currentLine] || [];

            // 5. è½‰æ›ä¸¦æ¨™è¨»æ–¹å‘
            const formatted = stationTrains.map(t => {
                const dest = t.DestinationName.replace('ç«™', '');
                const isUpstream = upstreamList.some(d => dest.includes(d));
                return {
                    DestinationStationName: { Zh_tw: t.DestinationName, En: '' },
                    EstimateTime: parseTRTCTime(t.CountDown),
                    TrainNumber: t.TrainNumber,
                    LineColor: ({ 'GA': '#8fc31f', 'RA': '#fd92a3' }[currentLine]) || getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim(),
                    platformSide: isUpstream ? 0 : 1
                };
            });

            const t1 = formatted.filter(t => t.platformSide === 0).sort((a, b) => a.EstimateTime - b.EstimateTime)[0] || null;
            const t2 = formatted.filter(t => t.platformSide === 1).sort((a, b) => a.EstimateTime - b.EstimateTime)[0] || null;

            return [t1, t2];
        }

        function parseTRTCTime(timeStr) {
            if (!timeStr || timeStr === 'åˆ—è»Šé€²ç«™' || timeStr === 'è³‡æ–™æ“·å–ä¸­') return 0;
            if (timeStr.includes(':')) {
                const [mm, ss] = timeStr.split(':').map(Number);
                return (mm * 60) + ss;
            }
            return 9999;
        }

        function updateUI(idx, item) {
            const destZh = document.getElementById(`dir${idx}-dest`);
            const destEn = document.getElementById(`dir${idx}-en`);
            const timeBox = document.getElementById(`dir${idx}-time`);
            const countdownLabel = document.getElementById(`countdown-${idx}`);
            const lineBadge = document.getElementById(`ui-line-tag-${idx + 1}`);

            if (!item) {
                const status = getOfflineStatus();
                destZh.innerText = status.destZh;
                destEn.innerText = status.destEn;
                if (timeBox) {
                    timeBox.innerText = status.timeText;
                    timeBox.className = status.timeClass;
                }
                if (countdownLabel) {
                    countdownLabel.innerText = "å€’æ•¸æ™‚é–“";
                }
                lineBadge.style.opacity = '0';
                return;
            }

            lineBadge.style.opacity = '1';
            // ä¿®æ”¹é€™ä¸€è¡Œï¼šè‡ªå‹•æŠŠçµå°¾çš„ã€Œç«™ã€å­—æ‹¿æ‰ï¼Œæ­¢ä½™ç©ºé–“ç¨å¾®å¯¬ä¸€é»
            destZh.innerText = item.DestinationStationName.Zh_tw.replace(/ç«™$/, '');
            lineBadge.style.opacity = '1';
            // ä¿®æ”¹é€™ä¸€è¡Œï¼šè‡ªå‹•æŠŠçµå°¾çš„ã€Œç«™ã€å­—æ‹¿æ‰
            destZh.innerText = item.DestinationStationName.Zh_tw.replace(/ç«™$/, '');
            // destEn.innerText è¨­å®šç§»åˆ°ä¸‹æ–¹ï¼Œç¢ºä¿èƒ½å–åˆ°æœ¬åœ°è³‡æ–™è£œå®Œ

            let lbText = item.LineID || system.substring(0, 1);
            let destID = null;

            // å˜—è©¦å°‹æ‰¾è»Šç«™ç·¨è™Ÿ
            // å˜—è©¦å°‹æ‰¾è»Šç«™ç·¨è™Ÿ
            if (GLOBAL_STATIONS && GLOBAL_STATIONS.systems[system]) {
                const lines = GLOBAL_STATIONS.systems[system];
                const destName = item.DestinationStationName.Zh_tw.replace('ç«™', '').trim();

                let found = null;

                // 1. å„ªå…ˆæœå°‹æœ¬è·¯ç·š (Current Line Priority)
                // æ‰¾å‡ºåŒ…å«ç›®å‰è»Šç«™(station)çš„é‚£å€‹è·¯ç·šç‰©ä»¶
                const currentLineObj = lines.find(l => l.stations.some(s => s.sid === station));

                if (currentLineObj) {
                    found = currentLineObj.stations.find(s => s.name_zh === destName);
                }

                // 2. å¦‚æœæœ¬è·¯ç·šæ‰¾ä¸åˆ° (ä¾‹å¦‚è·¨ç·šæˆ–è½‰ä¹˜è³‡è¨Š)ï¼Œå‰‡æœå°‹æ‰€æœ‰è·¯ç·š
                if (!found) {
                    for (const line of lines) {
                        if (currentLineObj && line.line_id === currentLineObj.line_id) continue; // å·²ç¶“æ‰¾éäº†

                        // ç²¾ç¢ºæ¯”å°
                        found = line.stations.find(s => s.name_zh === destName);

                        // æ¨¡ç³Šæ¯”å° (KRTC)
                        if (!found && system === 'KRTC') {
                            found = line.stations.find(s => destName.includes(s.name_zh) || s.name_zh.includes(destName));
                        }

                        if (found) {
                            break;
                        }
                    }
                }

                if (found) {
                    destID = found.sid;
                }
            }

            // ğŸ”¥ ä¿®æ­£ï¼šå¦‚æœ API æ²’æœ‰å›å‚³è‹±æ–‡ï¼Œå‰‡å˜—è©¦å¾æœ¬åœ°è³‡æ–™åº«æŠ“å–è‹±æ–‡ç«™å
            let finalEnName = item.DestinationStationName.En || "Train";
            if (!item.DestinationStationName.En && destID && GLOBAL_STATIONS.systems[system]) {
                const lines = GLOBAL_STATIONS.systems[system];
                for (const line of lines) {
                    const s = line.stations.find(st => st.sid === destID);
                    if (s && s.name_en) {
                        finalEnName = s.name_en;
                        break;
                    }
                }
            }
            
            // ğŸ”¥ æ–°å¢ï¼šå¦‚æœè‹±æ–‡ç«™åä»¥ã€ŒTaipeiã€é–‹é ­ï¼Œå°±åˆªæ‰çœç©ºé–“ï¼ˆå°åŒ—æ·é‹çš„å¸¸ç”¨åšæ³•ï¼‰
            if (finalEnName.startsWith('Taipei ')) {
                finalEnName = finalEnName.replace('Taipei ', '');
            }
            
            destEn.innerText = finalEnName;

            if (destID) {
                lbText = destID;
            } else {
                // æ‰¾ä¸åˆ°ç·¨è™Ÿå‰‡å›é€€åŸæœ¬é‚è¼¯
                if (system === 'KRTC' && (lbText === 'RA' || lbText === 'R')) lbText = 'R';
            }

            lineBadge.innerText = lbText;

            // å­—é«”å¤§å°è‡ªå‹•èª¿æ•´
            if (lbText.length >= 4) lineBadge.style.fontSize = '1.0vw';
            else if (lbText.length >= 3) lineBadge.style.fontSize = '1.2vw';
            else lineBadge.style.fontSize = '1.5vw';

            lineBadge.style.background = item.LineColor || "#808080";

            const estimateTime = item.EstimateTime != null ? item.EstimateTime : 0;
            countdownSecs[`dir${idx}`] = estimateTime;
            renderTime(idx);
        }

        function setOfflineUI(idx) {
            const status = getOfflineStatus();
            document.getElementById(`dir${idx}-dest`).innerText = status.destZh;
            document.getElementById(`dir${idx}-en`).innerText = status.destEn;
            const timeBox = document.getElementById(`dir${idx}-time`);
            timeBox.innerText = status.timeText;
            timeBox.className = status.timeClass;
            document.getElementById(`ui-line-tag-${idx + 1}`).style.opacity = '0';
        }

        function renderTime(idx) {
            const el = document.getElementById(`dir${idx}-time`);
            const countdownLabel = document.getElementById(`countdown-${idx}`);
            const s = countdownSecs[`dir${idx}`];

            if (s == null || isNaN(s) || s < 0) {
                const status = getOfflineStatus();
                if (el) {
                    el.innerText = status.timeText;
                    el.className = status.timeClass;
                }
                if (countdownLabel) {
                    countdownLabel.innerText = "å€’æ•¸æ™‚é–“";
                }
                return;
            }

            let timeText, className, labelClass;
            if (s <= 40) {
                timeText = "é€²ç«™ä¸­";
                className = "time-box arriving";
                labelClass = "countdown-label arriving";
            } else if (s <= 120) {
                // é¡¯ç¤º MM : SS (åŠ ä¸Šå‰å°é›¶)
                const m = String(Math.floor(s / 60)).padStart(2, '0');
                const secs = String(s % 60).padStart(2, '0');
                timeText = `${m}:${secs}`;
                className = "time-box approaching";
                labelClass = "countdown-label approaching";
            } else {
                // é¡¯ç¤º MM : SS (åŠ ä¸Šå‰å°é›¶)
                const m = String(Math.floor(s / 60)).padStart(2, '0');
                const secs = String(s % 60).padStart(2, '0');
                timeText = `${m}:${secs}`;
                className = "time-box";
                labelClass = "countdown-label";
            }

            // ğŸ“± æ‰‹æ©Ÿç‰ˆï¼šæ›´æ–°å€’æ•¸æ¨™ç±¤ï¼ˆå«ç‹€æ…‹classï¼‰
            if (countdownLabel) {
                countdownLabel.innerText = timeText;
                countdownLabel.className = labelClass;
            }
            
            // ğŸ–¥ï¸ æ¡Œé¢ç‰ˆï¼šæ›´æ–°åŸæœ‰æ™‚é–“æ¡†
            if (el) {
                el.innerText = timeText;
                el.className = className;
            }
        }

        // ğŸ‘¥ æ›´æ–°æ“æ“ åº¦è³‡è¨Š (TRTC å°ˆç”¨ - å…¨æ–°é‚è¼¯)
        async function updateCongestion(nextTrains) {
            if (system !== 'TRTC') {
                // éš±è—æ¡Œé¢ç‰ˆæ“æ“ åº¦
                document.querySelector('.congestion-area').innerHTML = `<div class="cong-no-data">æœ¬ç³»çµ±æš«ç„¡æ“æ“ åº¦è³‡è¨Š</div>`;
                // éš±è—æ‰‹æ©Ÿç‰ˆæ“æ“ åº¦
                document.getElementById('mobile-cong-0').style.display = 'none';
                document.getElementById('mobile-cong-1').style.display = 'none';
                return;
            }

            if (!nextTrains[0] && !nextTrains[1]) {
                document.querySelector('.congestion-area').innerHTML = `<div class="cong-no-data">å¾…åˆ—è»Šé€²ç«™å¾Œé¡¯ç¤ºæ“æ“ åº¦</div>`;
                document.getElementById('mobile-cong-0').style.display = 'none';
                document.getElementById('mobile-cong-1').style.display = 'none';
                return;
            }

            // å–å¾—è·¯ç·šä»£è™Ÿ
            let lineId = station.replace(/[0-9]/g, '');
            if (system === 'KRTC' && lineId === 'RA') lineId = 'R';

            // â˜…â˜…â˜… å¦‚æœæ˜¯ç’°ç‹€ç·š(Y)ï¼Œé¡¯ç¤ºç‰¹å®šæç¤ºä¸¦è·³å‡º â˜…â˜…â˜…
            if (lineId === 'Y') {
                document.querySelector('.congestion-area').innerHTML = `<div class="cong-no-data">ç’°ç‹€ç·šç›®å‰ä¸æä¾›æ“æ“ åº¦è³‡è¨Š</div>`;
                document.getElementById('mobile-cong-0').style.display = 'none';
                document.getElementById('mobile-cong-1').style.display = 'none';
                return;
            }

            try {
                let endpoint = '';

                if (lineId === 'BR') {
                    endpoint = '/crowdedness/wenhu';
                } else if (lineId === 'Y') {
                    endpoint = '/crowdedness/high-capacity';
                } else {
                    endpoint = '/crowdedness/high-capacity';
                }

                const res = await fetch(`${METRO_API_TRTC}${endpoint}`);
                let data = await res.json();

                if (data.error || !Array.isArray(data)) {
                    document.querySelector('.congestion-area').innerHTML = `<div class="cong-no-data">ç›®å‰ç„¡æ“æ“ åº¦è¨Šè™Ÿ</div>`;
                    document.getElementById('mobile-cong-0').style.display = 'none';
                    document.getElementById('mobile-cong-1').style.display = 'none';
                    return;
                }

                const stNameEl = document.getElementById('ui-st-name');
                const currentStationName = stNameEl.innerText.replace('ç«™', '').replace('è‡º', 'å°').trim();

                let html = '';
                let carCount = 6;
                if (lineId === 'BR' || lineId === 'Y') carCount = 4;
                if (lineId === 'GA' || lineId === 'RA') carCount = 3;

                // ğŸ”¥ æ‰‹æ©Ÿç‰ˆæ“æ“ åº¦æ›´æ–°
                [0, 1].forEach(idx => {
                    const train = nextTrains[idx];
                    const mobileContainer = document.getElementById(`mobile-cong-${idx}`);
                    const mobileBars = document.getElementById(`mobile-cong-bars-${idx}`);
                    
                    if (!train) {
                        mobileContainer.style.display = 'none';
                        return;
                    }

                    // è»Šè™Ÿæ¯”å°é‚è¼¯
                    let match = null;
                    if (train.TrainNumber) {
                        const targetTN = parseInt(train.TrainNumber, 10);
                        match = data.find(c => {
                            const crowdNumbers = String(c.TrainNumber).split(',').map(n => parseInt(n.trim(), 10));
                            return crowdNumbers.includes(targetTN);
                        });
                    }

                    // ç«™åæ¯”å°å‚™æ¡ˆ
                    if (!match) {
                        match = data.find(c => {
                            const apiStation = (c.StationName || "").replace('BR', '').replace('ç«™', '').replace('è‡º', 'å°').trim();
                            return apiStation === currentStationName;
                        });
                    }

                    let mobileBarsHtml = '';
                    if (match) {
                        for (let i = 1; i <= carCount; i++) {
                            const level = match[`Car${i}`] || match[`Cart${i}L`] || 0;
                            let cls = 'mobile-cong-car';

                            if (level == 1) cls += ' cong-lvl-1';
                            else if (level == 2) cls += ' cong-lvl-2';
                            else if (level == 3) cls += ' cong-lvl-3';
                            else if (level >= 4) cls += ' cong-lvl-4';

                            mobileBarsHtml += `<div class="${cls}">${i}</div>`;
                        }
                        mobileContainer.style.display = 'block';
                    } else {
                        // ç°è‰²ç‹€æ…‹
                        for (let i = 1; i <= carCount; i++) {
                            mobileBarsHtml += `<div class="mobile-cong-car">${i}</div>`;
                        }
                        mobileContainer.style.display = 'block';
                    }

                    mobileBars.innerHTML = mobileBarsHtml;

                    // æ¡Œé¢ç‰ˆé‚è¼¯ï¼ˆä¿æŒåŸæœ‰ï¼‰
                    const label = `å¾€ ${train.DestinationStationName.Zh_tw}`;
                    let barsHtml = '';

                    if (match) {
                        for (let i = 1; i <= carCount; i++) {
                            const level = match[`Car${i}`] || match[`Cart${i}L`] || 0;
                            let cls = 'cong-car';

                            if (level == 1) cls += ' cong-lvl-1';
                            else if (level == 2) cls += ' cong-lvl-2';
                            else if (level == 3) cls += ' cong-lvl-3';
                            else if (level >= 4) cls += ' cong-lvl-4';

                            barsHtml += `<div class="${cls}">${i}</div>`;
                        }
                    } else {
                        for (let i = 1; i <= carCount; i++) {
                            barsHtml += `<div class="cong-car">${i}</div>`;
                        }
                    }

                    html += `
                        <div class="cong-row">
                            <div class="cong-label">
                                <span style="background:${train.LineColor}; width:12px; height:12px; border-radius:50%; display:inline-block;"></span>
                                ${label}
                            </div>
                            <div class="cong-bar-container">${barsHtml}</div>
                        </div>
                    `;
                });

                document.querySelector('.congestion-area').innerHTML = html || `<div class="cong-no-data">æ¥æ”¶æ“æ“ åº¦è¨Šè™Ÿä¸­...</div>`;

            } catch (e) {
                console.error("æ“æ“ åº¦æ›´æ–°å¤±æ•—", e);
                document.getElementById('mobile-cong-0').style.display = 'none';
                document.getElementById('mobile-cong-1').style.display = 'none';
            }
        }

        async function updateWeather() {
            try {
                const res = await fetch(`${WEATHER_API}?dataset=F-C0032-001`);
                const json = await res.json();
                const county = system === 'TYMC' ? 'æ¡ƒåœ’å¸‚' : 'è‡ºåŒ—å¸‚';
                const loc = json.records.location.find(l => l.locationName === county);
                if (loc) {
                    const wx = loc.weatherElement.find(e => e.elementName === 'Wx').time[0].parameter.parameterName;
                    const minT = loc.weatherElement.find(e => e.elementName === 'MinT').time[0].parameter.parameterName;
                    const maxT = loc.weatherElement.find(e => e.elementName === 'MaxT').time[0].parameter.parameterName;
                    const pop = loc.weatherElement.find(e => e.elementName === 'PoP').time[0].parameter.parameterName;
                    document.getElementById('ui-weather-text').innerText = wx;
                    document.getElementById('ui-range-display').innerText = `${minT}Â°C ~ ${maxT}Â°C`;
                    document.getElementById('ui-rain-display').innerHTML = `<i class="fas fa-umbrella"></i> ${pop}%`;
                }
            } catch (e) { }
        }

        // ğŸ“¢ å°ˆæ¥­å®˜æ–¹å®£å° + å¾ªç’°æ’­æ”¾é‚è¼¯
        async function updateMarquee() {
            try {
                // --- 1. å–å¾—ç›®å‰ç³»çµ±åç¨± ---
                const sysMap = { 'TRTC': 'å°åŒ—æ·é‹', 'KRTC': 'é«˜é›„æ·é‹', 'TYMC': 'æ¡ƒåœ’æ·é‹', 'TMRT': 'å°ä¸­æ·é‹', 'NTMC': 'æ–°åŒ—æ·é‹', 'KLRT': 'é«˜é›„è¼•è»Œ' };
                const sysName = sysMap[system] || 'æ·é‹ç³»çµ±';

                // --- 2. æŠ“å–æœ€æ–°æ¶ˆæ¯ ---
                let newsContent = "";
                try {
                    const res = await fetch(`https://metro-api-worker.weacamm.org/api/news?sys=${system}`);
                    const data = await res.json();
                    if (Array.isArray(data) && data.length > 0) {
                        newsContent = data.slice(0, 3).map(n => `ã€${sysName}æœ€æ–°æ¶ˆæ¯ã€‘${n.Title || n.NewsTitle}`).join('ã€€ã€€') + 'ã€€ã€€';
                    }
                } catch (e) { console.log("News fetch failed"); }

                // --- 3. å®Œæ•´å®˜æ–¹å®£å°å…§å®¹ (åš´æ ¼ä¿ç•™) ---
                const mandatoryMessages = [
                    "ã€TPASS 2.0ï¼ˆå…¬å…±é‹è¼¸å¸¸å®¢å„ªæƒ ï¼‰ã€‘æ°‘çœ¾åªè¦æŒè¨˜åé›»å­ç¥¨è­‰ä¸”è‡³å…¬è·¯å±€å…¬å…±é‹è¼¸å¸¸å®¢å„ªæƒ å›é¥‹å°ˆå€å®Œæˆç™»éŒ„ï¼Œæ¯æœˆæ­ä¹˜å…¬å…±é‹è¼¸é”11æ¬¡ä»¥ä¸Šï¼Œå¯äº«ä¸åŒæ¯”ä¾‹ä¹˜è»Šé‡‘é¡å›é¥‹ï¼Œè‡ºéµå’Œæ·é‹ä¹Ÿæœ‰åŠ ç¢¼ã€‚é‡å°91æ¢ä¸­é•·é€”åœ‹é“å®¢é‹è·¯ç·šè¨­è¨ˆè¼ƒæ˜“é”æˆä¹‹å›é¥‹æ¢ä»¶ï¼Œæ°‘çœ¾æ¯æœˆæ­ä¹˜2è‡³3æ¬¡å³å¯äº«æœ‰15%ä¹˜è»Šé‡‘é¡å›é¥‹ï¼Œ4æ¬¡ä»¥ä¸Šå‰‡äº«30%å›é¥‹ã€‚",
                    "é‡ç·Šæ€¥ç‹€æ³ä¿æŒå†·éœå‹¿é©šæ…Œï¼Œè«‹ä½¿ç”¨å°è¬›æ©Ÿé€šçŸ¥æœå‹™äººå“¡è™•ç†ã€‚",
                    "æ·é‹ç³»çµ±å…¨é¢ç¦æ­¢å¸è¸(å«é›»å­ç…™ç­‰é¡è¸å“)ï¼Œé•è€…ä¾æ³•æœ€é«˜å¯è™•æ–°å°å¹£1è¬å…ƒç½°é°ã€‚",
                    "æ­ä¹˜é›»æ‰¶æ¢¯å…©å´çš†å¯ç«™ç«‹ã€é¿å…ä½¿ç”¨æ‰‹æ©Ÿï¼›é›»æ‰¶æ¢¯å‡ºå…¥å£è«‹å‹¿é€—ç•™ã€‚",
                    "ã€Œè·‘ã€èº²ã€å ±ï¼é­é‡çªç™¼å¨è„…ï¼Œä¿å‘½é—œéµä¸‰æ­¥é©Ÿã€ï¼šã€Œè·‘ã€ï¼šç«‹å³è·‘é›¢ç¾å ´ï¼Œä¸åœè§€æ‹ç…§ã€‚ã€Œèº²ã€ï¼šå°‹æ‰¾å®‰å…¨è™•èº²è—ï¼Œä¿æŒå®‰éœã€‚ã€Œå ±ã€ï¼šç¢ºèªå®‰å…¨å¾Œç«‹å³å ±æ¡ˆ(110æˆ–119)ã€‚",
                    "æµ·å¤–æ‰“å·¥é ˆè¬¹æ…ï¼Œå°å¿ƒè½å…¥åœˆå¥—æœ‰å»ç„¡å›ã€‚",
                    "æŠ•è³‡ç†è²¡éç›²ç›®æŠ•æ©Ÿï¼Œå‹¿è¼•ä¿¡è‚¡å¸‚æ˜ç‰Œã€‚",
                    "ææ¬¾æ©Ÿä¸èƒ½è§£é™¤æ‰£æ¬¾è¨­å®šï¼Œä¸èƒ½è¾¨è­˜èº«åˆ†ï¼Œä¸èƒ½é€€æ¬¾ã€‚",
                    "æª¢è­¦è¦éŒ¢å¿…è©é¨™ï¼Œç›£ç®¡å¸³æˆ¶éƒ½æ˜¯é¨™ï¼Œæª¢è­¦æ©Ÿé—œä¸æœƒè¦æ±‚æ°‘çœ¾å¢ƒå¤–åŒ¯æ¬¾ã€‚",
                    "æ…é˜²è©é¨™é›†åœ˜å¸¸å†’ç”¨æ”¿åºœæ©Ÿé—œåç¾©è¡Œé¨™ï¼Œè¬Šç¨±è¢«å®³äººèº«åˆ†é­å†’ç”¨ï¼Œè«‹æé«˜è­¦è¦ºï¼Œå¦‚æœ‰ç–‘å•æ­¡è¿æ’¥æ‰“165åè©é¨™å°ˆç·šã€‚",
                    "åˆ‘äº‹è­¦å¯Ÿå±€ç¶²ç«™å»ºç½®ã€Œé€šç·ä»¤è¿½è¿½è¿½ï¼æª¢èˆ‰è©æ¬ºè»Šæ‰‹å°ˆå€ã€ï¼Œå…¨æ°‘ä¸€èµ·æŠ“è»Šæ‰‹é ˜çé‡‘ã€‚",
                    "æ±‚è·ã€è²¸æ¬¾åˆ‡å‹¿äº¤å‡ºèº«åˆ†è­‰ä»¶ã€å­˜æ‘ºã€å°ç« ã€ææ¬¾å¡åŠå¯†ç¢¼ï¼Œ é¿å…æ·ªç‚ºè©æ¬ºå…±çŠ¯ã€‚",
                    "é˜²è©å°æ’‡æ­¥ï¼šä¿æŒå†·éœå¤šæŸ¥è­‰ï¼Œä¸åƒè™§æ‰å®‰å¿ƒï¼",
                    "æ™‚æ™‚å°å¿ƒé˜²æ„å¤–ï¼Œè™•è™•ç•™æ„ä¿å¹³å®‰ï¼Œç™¼ç¾ç•°å¸¸é€Ÿé€šå ±ï¼Œä¹˜è»Šå®‰å…¨å¾—ç¢ºä¿ã€‚"
                ];

                // --- 4. çµ„åˆæœ€çµ‚å­—ä¸² ---
                const finalMarqueeText = `${newsContent}${mandatoryMessages.join('ã€€ã€€')}ã€€ã€€ç¥æ‚¨æ—…é€”æ„‰å¿«ï¼`;

                // æ‰‹æ©Ÿç‰ˆè·‘é¦¬ç‡ˆ
                const marqueeEl = document.getElementById('ui-marquee');
                if (marqueeEl) {
                    marqueeEl.innerText = finalMarqueeText;
                    runMarqueeLoop('ui-marquee');
                }
                
                // æ¡Œé¢ç‰ˆè·‘é¦¬ç‡ˆ
                const marqueeDesktopEl = document.getElementById('ui-marquee-desktop');
                if (marqueeDesktopEl) {
                    marqueeDesktopEl.innerText = finalMarqueeText;
                    runMarqueeLoop('ui-marquee-desktop');
                }

            } catch (e) { console.error("Marquee error:", e); }
        }

        // ğŸ”¥ ç„¡é™å¾ªç’°è·‘é¦¬ç‡ˆæ§åˆ¶æ ¸å¿ƒ
        function runMarqueeLoop(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const container = el.parentElement;

            // é‡ç½®ç‹€æ…‹
            el.style.transition = 'none';
            const containerWidth = container.offsetWidth;

            // èµ·é»ï¼šå®¹å™¨æœ€å³é‚Š
            el.style.left = containerWidth + 'px';

            // è®“ç€è¦½å™¨è¨ˆç®—å¯¬åº¦
            setTimeout(() => {
                const textWidth = el.offsetWidth;
                // è¨­å®šé€Ÿåº¦ï¼šæ¯å€‹å­—ç´„ 0.8 ç§’ (æ•¸å€¼è¶Šå¤§è¶Šæ…¢)
                const speed = 0.012;
                const duration = (textWidth + containerWidth) * speed;

                // åŸ·è¡Œå‹•ç•«ï¼šä½ç§»åˆ°æ–‡å­—å¯¬åº¦çš„è² å€¼ï¼ˆå®Œå…¨æ¶ˆå¤±åœ¨å·¦å´ï¼‰
                el.style.transition = `left ${duration}s linear`;
                el.style.left = `-${textWidth}px`;

                // é—œéµï¼šç›£è½å‹•ç•«çµæŸäº‹ä»¶ï¼ŒçµæŸå¾Œç«‹åˆ»é‡å•Ÿ
                el.ontransitionend = () => {
                    runMarqueeLoop(id);
                };
            }, 50);
        }

        init();
    </script>
</body>

</html>