<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>土砂觀測站 API 測試</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-panel { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .info { color: blue; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .data-preview { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>土砂觀測站 API 測試工具</h1>
        
        <div class="test-panel">
            <h3>API 資訊</h3>
            <p><strong>API 網址：</strong>https://opendata.epa.gov.tw/ws/data/soil00054/?$format=json</p>
            <p><strong>預期欄位：</strong>Organization, StationName, Coordinate, Location, VideoType, ImgURL, County, Township, River, Status</p>
            <button onclick="testDirectAPI()">直接測試 API</button>
            <button onclick="testWithProxy()">使用代理測試</button>
            <button onclick="clearResults()">清除結果</button>
        </div>
        
        <div class="test-panel">
            <h3>測試結果</h3>
            <div id="testResults">點擊上方按鈕開始測試...</div>
        </div>
        
        <div class="test-panel">
            <h3>資料預覽</h3>
            <div id="dataPreview" class="data-preview">等待資料載入...</div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('dataPreview').innerHTML = '等待資料載入...';
        }

        async function testDirectAPI() {
            log('開始直接測試 EPA 土砂觀測站 API...');
            
            try {
                const apiUrl = 'https://opendata.epa.gov.tw/ws/data/soil00054/?$format=json';
                log(`嘗試存取：${apiUrl}`);
                
                const response = await fetch(apiUrl);
                log(`回應狀態：${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                log(`內容類型：${contentType}`);
                
                const data = await response.json();
                log(`✅ API 直接存取成功！`, 'success');
                log(`資料筆數：${Array.isArray(data) ? data.length : '未知'}`, 'success');
                
                displayDataPreview(data);
                
            } catch (error) {
                log(`❌ 直接存取失敗：${error.message}`, 'error');
                log('可能原因：CORS 政策限制', 'warning');
            }
        }

        async function testWithProxy() {
            log('開始使用代理測試...');
            
            const apiUrl = 'https://opendata.epa.gov.tw/ws/data/soil00054/?$format=json';
            const proxyUrls = [
                'https://api.allorigins.win/get?url=' + encodeURIComponent(apiUrl),
                'https://cors-anywhere.herokuapp.com/' + apiUrl,
                'https://thingproxy.freeboard.io/fetch/' + apiUrl
            ];
            
            for (let i = 0; i < proxyUrls.length; i++) {
                const proxyUrl = proxyUrls[i];
                const proxyName = proxyUrl.split('/')[2];
                
                try {
                    log(`嘗試代理 ${i + 1}: ${proxyName}`);
                    
                    const response = await fetch(proxyUrl);
                    log(`代理回應狀態：${response.status}`, response.ok ? 'success' : 'error');
                    
                    if (!response.ok) {
                        throw new Error(`代理回應錯誤：${response.status}`);
                    }
                    
                    const proxyData = await response.json();
                    
                    let data;
                    if (proxyData.contents) {
                        // allorigins 格式
                        data = JSON.parse(proxyData.contents);
                    } else {
                        data = proxyData;
                    }
                    
                    log(`✅ 代理 ${proxyName} 成功！`, 'success');
                    log(`資料筆數：${Array.isArray(data) ? data.length : '未知'}`, 'success');
                    
                    displayDataPreview(data);
                    return;
                    
                } catch (error) {
                    log(`❌ 代理 ${proxyName} 失敗：${error.message}`, 'error');
                }
            }
            
            log('⚠️ 所有代理都失敗了', 'warning');
        }

        function displayDataPreview(data) {
            const preview = document.getElementById('dataPreview');
            
            if (!data) {
                preview.innerHTML = '<div class="error">無資料</div>';
                return;
            }
            
            if (Array.isArray(data) && data.length > 0) {
                const firstItem = data[0];
                const fields = Object.keys(firstItem);
                
                let html = `<h4>資料結構分析（共 ${data.length} 筆）</h4>`;
                html += `<p><strong>欄位：</strong>${fields.join(', ')}</p>`;
                
                html += '<h4>第一筆資料範例：</h4>';
                html += '<pre>' + JSON.stringify(firstItem, null, 2) + '</pre>';
                
                // 檢查預期欄位
                const expectedFields = ['Organization', 'StationName', 'Coordinate', 'Location', 'VideoType', 'ImgURL', 'County', 'Township', 'River', 'Status'];
                const missingFields = expectedFields.filter(field => !fields.includes(field));
                const extraFields = fields.filter(field => !expectedFields.includes(field));
                
                if (missingFields.length > 0) {
                    html += `<div class="warning">缺少欄位：${missingFields.join(', ')}</div>`;
                }
                if (extraFields.length > 0) {
                    html += `<div class="info">額外欄位：${extraFields.join(', ')}</div>`;
                }
                
                // 顯示前 3 筆完整資料
                html += '<h4>前 3 筆完整資料：</h4>';
                html += '<pre>' + JSON.stringify(data.slice(0, 3), null, 2) + '</pre>';
                
                preview.innerHTML = html;
                
            } else {
                preview.innerHTML = '<div class="warning">資料格式不符預期</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
            }
        }

        // 頁面載入時自動測試
        window.addEventListener('load', function() {
            log('土砂觀測站 API 測試工具已載入');
            log('請點擊測試按鈕開始檢測 API');
        });
    </script>
</body>
</html>