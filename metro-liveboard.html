<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·é‹å³æ™‚åˆ°é›¢ç«™çœ‹æ¿ - TDX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <script>window.CURRENT_PAGE = 'metro-liveboard';</script>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%); 
            min-height: 100vh; 
            padding-bottom: 80px;
        }
        .header { 
            background: white; 
            padding: 20px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 0 20px; 
        }
        .header h1 { 
            color: #00bcd4; 
            text-align: center; 
            margin-bottom: 10px; 
        }
        .header p {
            text-align: center;
            color: #666;
            font-size: 0.95rem;
        }
        .back-btn { 
            display: inline-block; 
            padding: 10px 20px; 
            background: #00bcd4; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px; 
            margin: 20px 0; 
            transition: background 0.3s;
        }
        .back-btn:hover { 
            background: #0097a7; 
        }
        
        .system-selector { 
            background: linear-gradient(135deg, rgba(40,40,50,0.8) 0%, rgba(30,30,40,0.8) 100%);
            margin: 20px 0; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 1px solid rgba(79, 195, 247, 0.3);
            backdrop-filter: blur(10px);
        }
        .system-selector h3 { 
            color: #4fc3f7; 
            margin-bottom: 20px; 
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        .selector-row { 
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px; 
            align-items: end;
        }
        .selector-group { 
            display: flex; 
            flex-direction: column; 
        }
        .selector-group label { 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #e0e0e0; 
            font-size: 0.95rem;
            display: block;
        }
        
        .selector-group label:has(input[type="checkbox"]) {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            cursor: pointer;
            user-select: none;
        }
        .selector-group select { 
            padding: 12px 15px; 
            border-radius: 10px; 
            border: 2px solid rgba(79, 195, 247, 0.4); 
            font-size: 1rem; 
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .selector-group select option {
            background: #2a2a3a;
            color: #fff;
        }
        .selector-group select:hover {
            border-color: #4fc3f7;
            background: rgba(255, 255, 255, 0.08);
        }
        .selector-group select:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.2);
            background: rgba(255, 255, 255, 0.1);
        }
        .selector-group button { 
            padding: 12px 25px; 
            background: linear-gradient(135deg, #4fc3f7 0%, #0097a7 100%);
            color: white; 
            cursor: pointer; 
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        .selector-group button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 195, 247, 0.4);
        }
        .selector-group button:disabled {
            background: rgba(255,255,255,0.2);
            cursor: not-allowed;
            transform: none;
        }

        .selector-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #4fc3f7;
            margin-right: 8px;
        }

        .liveboard-container {
            background: white;
            margin: 20px 0; 
            padding: 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .liveboard-header {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .liveboard-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .update-time {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .train-table {
            width: 100%;
            border-collapse: collapse;
        }
        .train-table thead {
            background: #f8f9fa;
        }
        .train-table th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            color: #00bcd4;
            border-bottom: 2px solid #00bcd4;
        }
        .train-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        .train-table tbody tr:hover {
            background: #f8f9fa;
        }
        .train-number {
            font-weight: bold;
            color: #00bcd4;
            font-size: 1.1rem;
        }
        .line-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-right: 8px;
            color: white;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .status-badge.arriving { background: #4caf50; color: white; }
        .status-badge.waiting { background: #ff9800; color: white; }
        .status-badge.departed { background: #9e9e9e; color: white; }
        .status-badge.no-service { background: #f44336; color: white; }
        
        .direction-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            background: #00bcd4;
            color: white;
        }
        
        .transfer-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .transfer-group {
            border-bottom: 1px solid #eee;
            padding-bottom: 12px;
        }
        .transfer-group:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .transfer-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .transfer-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .transfer-line-name {
            font-weight: 600;
            color: #333;
            flex-grow: 1;
        }
        .transfer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.85rem;
        }
        .transfer-destination {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #333;
            flex-grow: 1;
        }
        .transfer-destination::before {
            content: 'â†’';
            color: #999;
        }
        .transfer-time {
            color: #666;
            min-width: 60px;
            text-align: right;
            font-weight: 500;
        }
        .transfer-none {
            padding: 8px;
            color: #999;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .stats-panel { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .stat-number { 
            font-size: 2rem; 
            font-weight: bold; 
            color: #00bcd4; 
        }
        .stat-label { 
            color: #666; 
            margin-top: 5px; 
        }
        
        .info-panel {
            background: #e0f7fa;
            border-left: 4px solid #00bcd4;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .info-panel.rail-news {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
        .info-panel h3 {
            color: #00bcd4;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding-bottom: 10px;
        }
        .info-panel.rail-news h3 {
            color: #e65100;
        }
        
        .panel-content {
            display: none;
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        .panel-content.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .news-card {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .news-card.trtc { border-left-color: #0066cc; }
        .news-card.trtc h4 { color: #0066cc; }
        .news-card.krtc { border-left-color: #ff6600; }
        .news-card.krtc h4 { color: #ff6600; }
        .news-card.tymc { border-left-color: #9966cc; }
        .news-card.tymc h4 { color: #9966cc; }
        .news-card.klrt { border-left-color: #00cc99; }
        .news-card.klrt h4 { color: #00cc99; }

        .news-card h4 {
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }
        .news-scroll-container {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .news-scroll-container::-webkit-scrollbar { width: 6px; }
        .news-scroll-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .news-scroll-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }

        .news-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .news-item:last-child { border-bottom: none; margin-bottom: 0; }
        .news-item h5 { margin: 0 0 4px 0; color: #333; font-size: 0.95rem; }
        .news-item p { margin: 0; color: #666; font-size: 0.85rem; line-height: 1.5; }
        .news-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.75rem;
            color: #888;
        }
        
        .system-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .system-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .system-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .system-card.selected {
            border-color: #00bcd4;
            background: #e0f7fa;
        }
        .system-card h4 {
            color: #00bcd4;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .system-card p {
            color: #666;
            font-size: 0.9rem;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%);
        }
        body.dark-mode .header {
            background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        body.dark-mode .header h1 {
            color: #4fc3f7;
        }
        body.dark-mode .header p {
            color: rgba(255,255,255,0.7);
        }
        body.dark-mode .back-btn {
            background: #4fc3f7;
            color: #0d47a1;
        }
        body.dark-mode .back-btn:hover {
            background: #81d4fa;
        }
        body.dark-mode .system-selector,
        body.dark-mode .system-card {
            background: #000000;
            border: 1px solid rgba(255,255,255,0.15);
        }
        body.dark-mode .system-card.selected {
            border-color: #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
        }
        body.dark-mode .system-selector h3,
        body.dark-mode .system-card h4 {
            color: #4fc3f7;
        }
        body.dark-mode .system-card p {
            color: rgba(255,255,255,0.7);
        }
        body.dark-mode .selector-group label {
            color: rgba(255,255,255,0.9);
        }
        body.dark-mode .selector-group select {
            background: rgba(255,255,255,0.1);
            color: white;
            border-color: #4fc3f7;
        }
        body.dark-mode .selector-group select option {
            background: #2a2a3e;
            color: white;
        }
        body.dark-mode .selector-group button {
            background: #4fc3f7;
            color: #0d47a1;
        }
        body.dark-mode .selector-group button:hover {
            background: #81d4fa;
        }
        body.dark-mode .liveboard-container {
            background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }
        body.dark-mode .liveboard-header {
            background: linear-gradient(135deg, #4fc3f7 0%, #81d4fa 100%);
            color: #0d47a1;
        }
        body.dark-mode .train-table thead {
            background: rgba(79, 195, 247, 0.1);
        }
        body.dark-mode .train-table th {
            color: #4fc3f7;
            border-bottom-color: #4fc3f7;
        }
        body.dark-mode .train-table td {
            color: rgba(255,255,255,0.9);
            border-bottom-color: rgba(255,255,255,0.1);
        }
        body.dark-mode .train-table tbody tr:hover {
            background: rgba(79, 195, 247, 0.1);
        }
        
        body.dark-mode .transfer-group {
            border-bottom-color: rgba(255,255,255,0.1);
        }
        body.dark-mode .transfer-line-name {
            color: #81d4fa;
        }
        body.dark-mode .transfer-destination {
            color: rgba(255,255,255,0.8);
        }
        body.dark-mode .transfer-destination::before {
            color: rgba(255,255,255,0.4);
        }
        body.dark-mode .transfer-time {
            color: rgba(255,255,255,0.7);
        }
        body.dark-mode .transfer-none {
            color: rgba(255,255,255,0.5);
        }
        body.dark-mode .train-number {
            color: #4fc3f7;
        }
        body.dark-mode .stat-card {
            background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }
        body.dark-mode .stat-number {
            color: #4fc3f7;
        }
        body.dark-mode .stat-label {
            color: rgba(255,255,255,0.7);
        }
        
        body.dark-mode .info-panel {
            background: rgba(40,40,50,0.95);
            border-left-color: #4fc3f7;
            color: #e0e0e0;
        }
        body.dark-mode .info-panel h3 { color: #4fc3f7; }
        body.dark-mode .info-panel p { color: rgba(255,255,255,0.8); }
        
        body.dark-mode .info-panel.rail-news {
            background: rgba(50, 40, 30, 0.95);
            border-left-color: #ff9800;
        }
        body.dark-mode .info-panel.rail-news h3 { color: #ffb74d; }
        body.dark-mode .panel-content { border-top-color: rgba(255,255,255,0.1); }

        body.dark-mode .news-card {
            background: #1e1e2e;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        body.dark-mode .news-item { border-bottom-color: rgba(255,255,255,0.1); }
        body.dark-mode .news-item h5 { color: #e0e0e0; }
        body.dark-mode .news-item p { color: #b0b0b0; }
        body.dark-mode .news-meta { color: #777; }
        
        body.dark-mode .no-data {
            color: rgba(255,255,255,0.5);
        }
        
        @media (max-width: 768px) {
            .selector-row {
                grid-template-columns: 1fr;
            }
            .train-table {
                font-size: 0.9rem;
            }
            .train-table th,
            .train-table td {
                padding: 10px 8px;
            }
            .stats-panel {
                grid-template-columns: repeat(2, 1fr);
            }
            .system-cards {
                grid-template-columns: 1fr;
            }
            .liveboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .news-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .stats-panel {
                grid-template-columns: 1fr;
            }
        }

        .back-to-top {
            bottom: 80px;
        }

        @media (max-width: 768px) {
            .back-to-top {
                bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-subway"></i> æ·é‹å³æ™‚åˆ°é›¢ç«™çœ‹æ¿</h1>
            <p>å³æ™‚æŸ¥è©¢æ·é‹è»Šç«™åˆ—è»Šåˆ°é›¢ç«™è³‡è¨Š</p>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é </a>
        <button class="theme-toggle" id="themeToggle" title="åˆ‡æ›æ·±è‰²æ¨¡å¼" style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #1e40af, #0891b2); color: white; border: none; cursor: pointer; margin-left: 15px; font-size: 1.2rem;">
            <i class="fas fa-moon"></i>
        </button>
        
        <!-- è³‡è¨Šé¢æ¿ -->
        <div class="info-panel" id="infoPanel">
            <h3 onclick="togglePanel('infoContent', 'toggleIcon')">
                <span>
                    <i class="fas fa-info-circle"></i>
                    TDX æ·é‹å³æ™‚çœ‹æ¿èªªæ˜
                </span>
                <i id="toggleIcon" class="fas fa-chevron-up"></i>
            </h3>
            <div id="infoContent" class="panel-content show">
                <p>
                    <strong>ğŸ“Š è³‡æ–™ä¾†æºï¼š</strong>äº¤é€šéƒ¨ TDX äº¤é€šè³‡æ–™æµé€šæœå‹™å¹³å°
                </p>
                <p>
                    <strong>ğŸš‡ æ”¯æ´ç³»çµ±ï¼š</strong>å°åŒ—æ·é‹ã€é«˜é›„æ·é‹ã€é«˜é›„è¼•è»Œã€æ¡ƒåœ’æ·é‹
                </p>
                <p>
                    <strong>ğŸ”„ æ›´æ–°é »ç‡ï¼š</strong>å³æ™‚æ›´æ–°
                </p>
                <p>
                    <strong>â„¹ï¸ æ³¨æ„äº‹é …ï¼š</strong>æ¡ƒåœ’æ·é‹ç›®å‰åƒ…æä¾› A1~A21 ç«™çš„è³‡æ–™
                </p>
                <p style="margin-top: 15px;">
                    ğŸ”— <a href="https://tdx.transportdata.tw" target="_blank" style="color: #00bcd4; text-decoration: none;">
                        TDX äº¤é€šè³‡æ–™æµé€šæœå‹™å¹³å° <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                    </a>
                </p>
            </div>
        </div>

        <!-- æ·é‹å…¬å‘Šé¢æ¿ -->
        <div class="info-panel rail-news" id="railInfoPanel">
            <h3 onclick="togglePanel('railInfoContent', 'railToggleIcon')">
                <span>
                    <i class="fas fa-bullhorn"></i>
                    æ·é‹ç³»çµ±å…¬å‘Š
                </span>
                <i id="railToggleIcon" class="fas fa-chevron-up"></i>
            </h3>
            <div id="railInfoContent" class="panel-content show">
                <div class="news-grid">
                    <div class="news-card trtc">
                        <h4><i class="fas fa-subway"></i> å°åŒ—æ·é‹ (TRTC)</h4>
                        <div id="newsContainer-TRTC" class="news-scroll-container">
                            <p style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                    <div class="news-card krtc">
                        <h4><i class="fas fa-subway"></i> é«˜é›„æ·é‹ (KRTC)</h4>
                        <div id="newsContainer-KRTC" class="news-scroll-container">
                            <p style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                    <div class="news-card tymc">
                        <h4><i class="fas fa-subway"></i> æ¡ƒåœ’æ·é‹ (TYMC)</h4>
                        <div id="newsContainer-TYMC" class="news-scroll-container">
                            <p style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                    <div class="news-card klrt">
                        <h4><i class="fas fa-train"></i> é«˜é›„è¼•è»Œ (KLRT)</h4>
                        <div id="newsContainer-KLRT" class="news-scroll-container">
                            <p style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆé¢æ¿ -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-number" id="totalTrains">0</div>
                <div class="stat-label">åˆ—è»Šç¸½æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="arrivingTrains">0</div>
                <div class="stat-label">å³å°‡åˆ°ç«™</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stationCount">0</div>
                <div class="stat-label">è»Šç«™æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lineCount">0</div>
                <div class="stat-label">è·¯ç·šæ•¸</div>
            </div>
        </div>

        <!-- æ·é‹ç³»çµ±é¸æ“‡ -->
        <div class="system-cards">
            <div class="system-card" data-system="TRTC" onclick="selectSystem('TRTC')">
                <h4><i class="fas fa-subway"></i> å°åŒ—æ·é‹</h4>
                <p>Taipei Metro (TRTC)</p>
                <p style="font-size: 0.8rem; color: #999; margin-top: 5px;">æ¶µè“‹å°åŒ—å¸‚åŠæ–°åŒ—å¸‚</p>
            </div>
            <div class="system-card" data-system="KRTC" onclick="selectSystem('KRTC')">
                <h4><i class="fas fa-subway"></i> é«˜é›„æ·é‹</h4>
                <p>Kaohsiung Metro (KRTC)</p>
                <p style="font-size: 0.8rem; color: #999; margin-top: 5px;">æ¶µè“‹é«˜é›„å¸‚</p>
            </div>
            <div class="system-card" data-system="KLRT" onclick="selectSystem('KLRT')">
                <h4><i class="fas fa-train"></i> é«˜é›„è¼•è»Œ</h4>
                <p>Kaohsiung LRT (KLRT)</p>
                <p style="font-size: 0.8rem; color: #999; margin-top: 5px;">ç’°ç‹€è¼•è»Œç³»çµ±</p>
            </div>
            <div class="system-card" data-system="TYMC" onclick="selectSystem('TYMC')">
                <h4><i class="fas fa-subway"></i> æ¡ƒåœ’æ·é‹</h4>
                <p>Taoyuan Metro (TYMC)</p>
                <p style="font-size: 0.8rem; color: #999; margin-top: 5px;">åƒ…æä¾› A1~A21 ç«™</p>
            </div>
        </div>

        <!-- è»Šç«™é¸æ“‡ -->
        <div class="system-selector" id="stationSelector" style="display: none;">
            <h3><i class="fas fa-map-marker-alt"></i> æŸ¥è©¢è¨­å®š</h3>
            <div class="selector-row">
                <div class="selector-group">
                    <label for="lineSelect">è·¯ç·š</label>
                    <select id="lineSelect" onchange="onLineChange()">
                        <option value="">è«‹é¸æ“‡è·¯ç·š</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label for="stationSelect">è»Šç«™</label>
                    <select id="stationSelect">
                        <option value="">è«‹å…ˆé¸æ“‡è·¯ç·š</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label for="allStationsCheck">
                        <input type="checkbox" id="allStationsCheck" onchange="toggleAllStations()">
                        <span>æ‰€æœ‰è»Šç«™</span>
                    </label>
                </div>
                <div class="selector-group">
                    <label>&nbsp;</label>
                    <button onclick="queryLiveboard()" id="queryBtn">
                        <i class="fas fa-search"></i> æŸ¥è©¢ / æ›´æ–°
                    </button>
                </div>
            </div>
        </div>

        <!-- çœ‹æ¿å®¹å™¨ -->
        <div id="liveboardContainer" style="display: none;">
            <div class="liveboard-container">
                <div class="liveboard-header">
                    <h2 id="stationTitle">
                        <i class="fas fa-subway"></i>
                        <span id="systemName">æ·é‹ç³»çµ±</span> - <span id="stationName">é¸æ“‡è»Šç«™</span>
                    </h2>
                    <div class="update-time">
                        <i class="fas fa-clock"></i> æ›´æ–°æ™‚é–“ï¼š<span id="updateTime">--</span>
                    </div>
                </div>
                <table class="train-table">
                    <thead>
                        <tr>
                            <th>è»Šç«™</th>
                            <th>è·¯ç·š</th>
                            <th>æ–¹å‘</th>
                            <th>çµ‚é»ç«™</th>
                            <th>åˆ°ç«™æ™‚é–“</th>
                            <th>ç‹€æ…‹</th>
                            <th>è½‰ä¹˜è³‡è¨Š</th>
                        </tr>
                    </thead>
                    <tbody id="trainTableBody">
                        <tr>
                            <td colspan="7" class="no-data">
                                <i class="fas fa-subway"></i>
                                <p>è«‹é¸æ“‡æ·é‹ç³»çµ±å’Œè»Šç«™</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        const metroSystems = {
            TRTC: { name: 'å°åŒ—æ·é‹', code: 'TRTC' },
            KRTC: { name: 'é«˜é›„æ·é‹', code: 'KRTC' },
            KLRT: { name: 'é«˜é›„è¼•è»Œ', code: 'KLRT' },
            TYMC: { name: 'æ¡ƒåœ’æ·é‹', code: 'TYMC' }
        };

        const lineColors = {
            'BR': '#C25523', 'R': '#E3002C', 'G': '#008659', 'O': '#F08226', 'BL': '#005AB5', 'Y': '#FFD200',
            'RK': '#E3002C', 'OK': '#F08226', 'C': '#00A651', 'A': '#6A1B9A'
        };

        let currentSystem = '';
        let currentStationId = '';
        let currentStationName = '';
        let allLiveboardData = [];
        let allStationData = [];
        let currentLiveboardData = [];
        let autoRefreshInterval = null;
        let lastApiRequest = 0;
        let allStationsMode = false;

        // â˜… æ–°å¢é€™å€‹è®Šæ•¸ï¼šç”¨ä¾†å¿«å–å„ç³»çµ±çš„è»Šç«™è³‡æ–™ï¼Œé¿å…é‡è¤‡è«‹æ±‚
        const stationDataCache = {};

        const trtcStationMap = {
            'BR01': 'å‹•ç‰©åœ’', 'BR02': 'æœ¨æŸµ', 'BR03': 'è¬èŠ³ç¤¾å€', 'BR04': 'è¬èŠ³é†«é™¢', 'BR05': 'è¾›äº¥',
            'R02': 'è±¡å±±', 'R03': 'å°åŒ—101/ä¸–è²¿', 'R04': 'ä¿¡ç¾©å®‰å’Œ', 'R05': 'å¤§å®‰', 'R06': 'å¤§å®‰æ£®æ—å…¬åœ’',
            'G01': 'æ–°åº—', 'G02': 'æ–°åº—å€å…¬æ‰€', 'G03': 'ä¸ƒå¼µ', 'G04': 'å¤§åªæ—', 'G05': 'æ™¯ç¾',
            'O01': 'å—å‹¢è§’', 'O02': 'æ™¯å®‰', 'O03': 'æ°¸å®‰å¸‚å ´', 'O04': 'é ‚æºª', 'O05': 'å¤äº­',
            'BL01': 'é ‚åŸ”', 'BL02': 'æ°¸å¯§', 'BL03': 'åœŸåŸ', 'BL04': 'æµ·å±±', 'BL05': 'äºæ±é†«é™¢'
        };

        const krctStationMap = {
            'R3': 'å°æ¸¯', 'R4': 'é«˜é›„åœ‹éš›æ©Ÿå ´', 'R4A': 'è‰è¡™', 'R5': 'å‰é®é«˜ä¸­',
            'O1': 'å“ˆç‘ªæ˜Ÿ', 'O2': 'é¹½åŸ•åŸ”', 'O4': 'å‰é‡‘', 'O5': 'ç¾éº—å³¶'
        };

        const klrtStationMap = {
            'C1': 'ç±¬ä»”å…§', 'C2': 'å‡±æ—‹ç‘ç”°', 'C3': 'å‰é®ä¹‹æ˜Ÿ', 'C4': 'å‡±æ—‹ä¸­è¯', 'C5': 'å¤¢æ™‚ä»£'
        };

        const tymcStationMap = {
            'A1': 'å°åŒ—è»Šç«™', 'A2': 'ä¸‰é‡', 'A3': 'æ–°åŒ—ç”¢æ¥­åœ’å€', 'A4': 'æ–°èŠ', 'A5': 'æ³°å±±',
            'A6': 'æ¡ƒåœ’', 'A7': 'èˆˆå—', 'A8': 'æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆ', 'A9': 'æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ'
        };

        function selectSystem(systemCode) {
            currentSystem = systemCode;
            document.getElementById('totalTrains').textContent = '0';
            document.getElementById('arrivingTrains').textContent = '0';
            document.getElementById('stationCount').textContent = '0';
            document.getElementById('lineCount').textContent = '0';
            
            document.querySelectorAll('.system-card').forEach(card => card.classList.remove('selected'));
            document.querySelector(`[data-system="${systemCode}"]`).classList.add('selected');
            document.getElementById('stationSelector').style.display = 'block';
            loadSystemData(systemCode);
        }

        // è¼‰å…¥ç³»çµ±è³‡æ–™ (ä¿®æ­£ç‰ˆï¼šå¼·åˆ¶è£œå…¨è·¯ç·šåç¨±ï¼Œè§£æ±ºé¸å–®ç¯©é¸ä¸åˆ°çš„å•é¡Œ)
        async function loadSystemData(systemCode) {
            const lineSelect = document.getElementById('lineSelect');
            const stationSelect = document.getElementById('stationSelect');
            
            // åˆå§‹åŒ– UI
            lineSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
            stationSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡è·¯ç·š</option>';
            document.getElementById('stationCount').textContent = '-';
            
            // æª¢æŸ¥å¿«å– (ä½†è¦é©—è­‰å¿«å–çš„è³‡æ–™æœ‰æ•ˆæ€§)
            if (stationDataCache[systemCode] && stationDataCache[systemCode].length > 0) {
                console.log(`ğŸ“¦ ä½¿ç”¨å¿«å–è³‡æ–™: ${systemCode}`);
                allStationData = stationDataCache[systemCode];
                renderLineSelect(allStationData, systemCode);
                return;
            }

            try {
                // é™åˆ¶è«‹æ±‚é »ç‡
                const now = Date.now();
                if (now - lastApiRequest < 1000) {
                    await new Promise(r => setTimeout(r, 1000));
                }
                lastApiRequest = Date.now();

                const stationEndpoint = `/v2/Rail/Metro/Station/${systemCode}?$format=JSON&$top=1000`;
                console.log(`ğŸ“¡ ä¸‹è¼‰è»Šç«™è³‡æ–™: ${systemCode}`);
                const stationData = await tdxApi.fetch(stationEndpoint);
                
                // âœ… é©—è­‰ API å›æ‡‰
                if (!Array.isArray(stationData) || stationData.length === 0) {
                    throw new Error(`ç„¡æ³•å–å¾— ${systemCode} çš„è»Šç«™è³‡æ–™`);
                }
                
                // â˜… è³‡æ–™é è™•ç†ï¼šå¼·åˆ¶è£œå…¨ LineName (é—œéµæ­¥é©Ÿ)
                const patchedData = stationData.map(item => {
                    let lineName = item.LineName?.Zh_tw;
                    const sID = item.StationID || '';
                    const lID = item.LineID || '';

                    // å¦‚æœåŸæœ¬æ²’æœ‰åç¨±ï¼Œæˆ–æ˜¯æœªçŸ¥ï¼Œå˜—è©¦æ¨æ–·
                    if (!lineName || lineName === 'æœªçŸ¥') {
                        // 1. å°åŒ—æ·é‹ & æ¡ƒåœ’æ·é‹ & ç’°ç‹€ç·š (çœ‹ LineID)
                        const lineCodeMap = {
                            'BL': 'æ¿å—ç·š', 'BR': 'æ–‡æ¹–ç·š', 'R': 'æ·¡æ°´ä¿¡ç¾©ç·š',
                            'G': 'æ¾å±±æ–°åº—ç·š', 'O': 'ä¸­å’Œæ–°è˜†ç·š', 'Y': 'ç’°ç‹€ç·š',
                            'A': 'æ©Ÿå ´ç·š'
                        };
                        // å˜—è©¦å¾ LineID æˆ– StationID å‰ç¶´åŒ¹é…
                        for (const code in lineCodeMap) {
                            if (lID === code || lID.startsWith(code)) {
                                lineName = lineCodeMap[code];
                                break;
                            }
                        }
                    }

                    // 2. é«˜é›„æ·é‹ (KRTC) ç‰¹åˆ¥è™•ç† (çœ‹ StationID å‰ç¶´)
                    if ((!lineName || lineName === 'æœªçŸ¥') && systemCode === 'KRTC') {
                        if (sID.startsWith('R')) lineName = 'ç´…ç·š';
                        if (sID.startsWith('O')) lineName = 'æ©˜ç·š';
                    }
                    
                    // 3. é«˜é›„è¼•è»Œ (KLRT)
                    if (systemCode === 'KLRT') {
                        lineName = 'é«˜é›„è¼•è»Œ';
                    }

                    // å°‡è£œå…¨çš„åç¨±å¯«å›ç‰©ä»¶ï¼Œæ–¹ä¾¿å¾ŒçºŒç¯©é¸
                    if (lineName) {
                        if (!item.LineName) item.LineName = {};
                        item.LineName.Zh_tw = lineName;
                    }
                    
                    return item;
                });

                // âœ… åªæœ‰ç•¶æˆåŠŸå–å¾—æœ‰æ•ˆè³‡æ–™æ™‚æ‰å¯«å…¥å¿«å–
                allStationData = patchedData;
                stationDataCache[systemCode] = patchedData;
                console.log(`âœ… ${systemCode} å·²å¿«å–ï¼Œå…± ${patchedData.length} ç­†è»Šç«™è³‡æ–™`);

                renderLineSelect(allStationData, systemCode);
                
            } catch (error) {
                console.error(`è¼‰å…¥${systemCode}è³‡æ–™å¤±æ•—:`, error);
                // âœ… æ¸…é™¤å£æ‰çš„å¿«å–
                delete stationDataCache[systemCode];
                lineSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
            }
        }

        // æ¸²æŸ“è·¯ç·šé¸å–® (ç°¡åŒ–ç‰ˆ)
        function renderLineSelect(stationData, systemCode) {
            const lineSelect = document.getElementById('lineSelect');
            const lineSet = new Set();
            
            // æ”¶é›†æ‰€æœ‰è·¯ç·šåç¨±
            stationData.forEach(item => {
                const name = item.LineName?.Zh_tw;
                if (name && name !== 'æœªçŸ¥') {
                    lineSet.add(name);
                }
            });
            
            const lines = Array.from(lineSet);
            // æ’åº (è®“ç´…ç·šã€æ©˜ç·šæˆ–é¡è‰²ç·šæ’åœ¨ä¸€èµ·)
            lines.sort(); 

            console.log(`${systemCode} è·¯ç·šåˆ—è¡¨:`, lines);
            
            document.getElementById('stationCount').textContent = stationData.length;
            document.getElementById('lineCount').textContent = lines.length;

            if (lines.length > 0) {
                lineSelect.innerHTML = '<option value="">è«‹é¸æ“‡è·¯ç·š</option>' +
                    lines.map(line => `<option value="${line}">${line}</option>`).join('');
            } else {
                lineSelect.innerHTML = '<option value="">ç„¡æ³•å–å¾—è·¯ç·š</option>';
            }
        }

        function extractStationNumber(stationId) {
            if (!stationId) return 999;
            const numStr = stationId.replace(/[^0-9]/g, '');
            return numStr ? parseInt(numStr, 10) : 999;
        }

        // è·¯ç·šè®Šæ›´äº‹ä»¶ (ä¿®æ­£ç‰ˆï¼šç›´æ¥æ¯”å°ä¸­æ–‡åç¨±)
        function onLineChange() {
            const lineSelect = document.getElementById('lineSelect');
            const stationSelect = document.getElementById('stationSelect');
            const selectedLine = lineSelect.value;

            if (!selectedLine) {
                stationSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡è·¯ç·š</option>';
                return;
            }

            console.log(`ğŸ“ ç¯©é¸è·¯ç·š: ${selectedLine}`);

            // ç¯©é¸è»Šç«™ï¼šç›´æ¥æ¯”å°æˆ‘å€‘å‰›å‰›è£œå…¨çš„ LineName
            const lineStations = allStationData
                .filter(station => {
                    const sName = station.LineName?.Zh_tw;
                    return sName === selectedLine;
                })
                .map(station => ({
                    id: station.StationID || station.ID,
                    name: station.StationName?.Zh_tw || station.StationName || 'æœªçŸ¥è»Šç«™',
                    // æ’åºæ¬Šé‡ï¼šå–å‡ºæ•¸å­—éƒ¨åˆ†
                    sequence: extractStationNumber(station.StationID)
                }));
            
            // æ’åº (æŒ‰æ•¸å­—å¤§å°)
            lineStations.sort((a, b) => a.sequence - b.sequence);
            
            // å»é‡ (é¿å…åŒä¸€ç«™å‡ºç¾å…©æ¬¡)
            const uniqueStations = Array.from(new Map(lineStations.map(s => [s.id, s])).values());
            
            console.log(`ğŸš‰ æ‰¾åˆ° ${uniqueStations.length} å€‹è»Šç«™`);

            if (uniqueStations.length === 0) {
                stationSelect.innerHTML = '<option value="">è©²è·¯ç·šç„¡è»Šç«™è³‡æ–™</option>';
                return;
            }

            stationSelect.innerHTML = '<option value="">è«‹é¸æ“‡è»Šç«™</option>' +
                uniqueStations.map(station => 
                    `<option value="${station.id}">${station.name} (${station.id})</option>`
                ).join('');
        }

        function toggleAllStations() {
            const checkbox = document.getElementById('allStationsCheck');
            document.getElementById('stationSelect').disabled = checkbox.checked;
            allStationsMode = checkbox.checked;
        }

        // æŸ¥è©¢çœ‹æ¿ (çµ‚æ¥µç©©å®šç‰ˆï¼šä¸€æ¬¡æ‹‰å–å…¨ç³»çµ±è³‡æ–™ï¼Œç¢ºä¿ä¸æ¼æ¥)
        async function queryLiveboard() {
            // âœ… ç¯€æµæ§åˆ¶ (é¿å…å¿«é€Ÿé€£ç™¼è«‹æ±‚)
            const now = Date.now();
            if (typeof window.lastApiCall === 'undefined') {
                window.lastApiCall = 0;
            }
            
            if (now - window.lastApiCall < 2000) {
                console.warn('â±ï¸ è«‹æ±‚å¤ªé »ç¹ï¼Œè«‹ç¨å€™');
                return;
            }
            window.lastApiCall = now;

            const stationSelect = document.getElementById('stationSelect');
            
            if (!allStationsMode && !stationSelect.value) {
                alert('è«‹é¸æ“‡è»Šç«™æˆ–å‹¾é¸ã€Œæ‰€æœ‰è»Šç«™ã€');
                return;
            }

            // åªåœ¨æ‰‹å‹•æŸ¥è©¢æ™‚é¡¯ç¤ºè¼‰å…¥ä¸­ (è‡ªå‹•åˆ·æ–°ä¸é¡¯ç¤º)
            const isAutoRefresh = (arguments.callee.isAutoRefresh === true);
            if (!isAutoRefresh) {
                const tableBody = document.getElementById('trainTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #00bcd4;"></i>
                            <p style="margin-top: 10px; color: #666;">æ­£åœ¨æ›´æ–°å³æ™‚è³‡è¨Š...</p>
                        </td>
                    </tr>
                `;
            }

            if (allStationsMode) {
                currentStationId = 'ALL';
                currentStationName = 'æ‰€æœ‰è»Šç«™';
            } else {
                currentStationId = stationSelect.value;
                currentStationName = stationSelect.options[stationSelect.selectedIndex].text;
            }

            // ç­–ç•¥ï¼šä¸å†çŒœæ¸¬ LineIDï¼Œç›´æ¥æŠ“å–è©²ç³»çµ±æ‰€æœ‰åˆ—è»Šè³‡æ–™ (Top 3000 ç¢ºä¿æŠ“å®Œ)
            // é€™æ¨£å¯ä»¥é¿å… API ç¯©é¸æ©Ÿåˆ¶çš„å„ç¨®æ½›åœ¨å•é¡Œ (å¦‚ LineID ä¸ç¬¦ã€å–®ç«™ç„¡è³‡æ–™å›å‚³ç©ºé™£åˆ—ç­‰)
            const endpoint = `/v2/Rail/Metro/LiveBoard/${currentSystem}?$format=JSON&$top=3000`;

            try {
                console.log(`ğŸ” å…¨ç³»çµ±æŸ¥è©¢: ${currentSystem}, URL: ${endpoint}`);
                const newData = await tdxApi.fetch(endpoint);
                
                // âœ… é©—è­‰ API å›æ‡‰æœ‰æ•ˆæ€§ (é—œéµé˜²è­·)
                if (!newData) {
                    throw new Error('API å›æ‡‰ç‚ºç©º');
                }
                if (!Array.isArray(newData)) {
                    throw new Error(`API å›æ‡‰ä¸æ˜¯é™£åˆ—: ${typeof newData}`);
                }
                
                console.log(`âœ… API å›æ‡‰ç¸½ç­†æ•¸: ${newData.length}`);
                currentLiveboardData = newData;
                
                // é¡¯ç¤ºè³‡æ–™
                displayLiveboard();

            } catch (error) {
                console.error("æŸ¥è©¢å¤±æ•—:", error);
                const tableBody = document.getElementById('trainTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">
                            <i class="fas fa-exclamation-triangle" style="color: #ff9800;"></i>
                            <p>è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦</p>
                            <p style="font-size:0.8rem; color:#999">${error.message}</p>
                        </td>
                    </tr>
                `;
            }
            
            // é‡è¨­è‡ªå‹•åˆ·æ–° (30ç§’)
            if (window.autoRefreshInterval) {
                clearInterval(window.autoRefreshInterval);
            }
            window.autoRefreshInterval = setInterval(() => {
                const autoFunc = queryLiveboard.bind(null);
                autoFunc.isAutoRefresh = true;
                autoFunc();
            }, 30000);
        }

        // é¡¯ç¤ºçœ‹æ¿ (å¢å¼·é™¤éŒ¯è¨Šæ¯ç‰ˆ)
        function displayLiveboard() {
            const container = document.getElementById('liveboardContainer');
            const systemNameEl = document.getElementById('systemName');
            const stationNameEl = document.getElementById('stationName');
            const tableBody = document.getElementById('trainTableBody');
            
            systemNameEl.textContent = metroSystems[currentSystem].name;
            stationNameEl.textContent = currentStationName;
            container.style.display = 'block';
            
            let stationTrains = [];
            
            if (allStationsMode) {
                stationTrains = currentLiveboardData;
            } else {
                // åœ¨æœ¬åœ°ç«¯é€²è¡Œç¯©é¸ï¼Œæ¯”å° StationID
                stationTrains = currentLiveboardData.filter(item => item.StationID === currentStationId);
            }
            
            console.log(`ğŸ“Š ç¯©é¸å¾Œè»Šç«™ ${currentStationId} è³‡æ–™ç­†æ•¸: ${stationTrains.length}`);

            // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºè©³ç´°ç‹€æ…‹
            if (stationTrains.length === 0) {
                const totalInSystem = currentLiveboardData.length;
                let extraMsg = '';
                
                if (totalInSystem === 0) {
                    extraMsg = '(API å›å‚³ 0 ç­†è³‡æ–™ï¼Œå¯èƒ½æ˜¯ç³»çµ±æ”¶ç­æˆ–ç¶­è­·ä¸­)';
                } else {
                    extraMsg = `(ç³»çµ±å…§æœ‰ ${totalInSystem} ç­†å…¶ä»–è»Šç«™è³‡æ–™ï¼Œä½†æ­¤ç«™ç„¡æ›´æ–°)`;
                }

                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">
                            <i class="fas fa-subway" style="color: #e0e0e0;"></i>
                            <p>ç›®å‰è©²è»Šç«™æ²’æœ‰å³æ™‚åˆ—è»Šè³‡è¨Š</p>
                            <p style="font-size: 0.85rem; margin-top: 10px; color:#999;">
                                StationID: ${currentStationId}<br>
                                ${extraMsg}
                            </p>
                        </td>
                    </tr>
                `;
                updateUpdateTime();
                return;
            }

            // --- ä»¥ä¸‹ç‚ºè³‡æ–™è™•ç†èˆ‡ HTML ç”Ÿæˆé‚è¼¯ ---
            let trainRows = [];
            stationTrains.forEach(item => {
                // 1. è™•ç† Estimates é™£åˆ—
                const estimates = item.Estimates || item.estimates || item.NextBuses || item.Buses || [];
                if (Array.isArray(estimates) && estimates.length > 0) {
                    estimates.forEach(estimate => {
                        const directionText = estimate.TripHeadSign || estimate.Direction || '';
                        const destName = estimate.DestinationStationName?.Zh_tw || estimate.DestinationStationName || 'æœªçŸ¥';
                        
                        trainRows.push({
                            stationName: item.StationName?.Zh_tw || currentStationName,
                            lineName: item.LineName?.Zh_tw || item.LineID,
                            lineID: item.LineID || '',
                            tripHeadSign: directionText,
                            destinationName: destName,
                            estimateTime: estimate.EstimateTime || 0,
                            serviceStatus: 0
                        });
                    });
                } 
                // 2. è™•ç†æ‰å¹³çµæ§‹ (KLRT ç­‰)
                else if (item.EstimateTime !== undefined || item.DestinationStationName) {
                     const destName = item.DestinationStationName?.Zh_tw || item.DestinationStationName || item.TripHeadSign || 'æœªçŸ¥';
                     trainRows.push({
                        stationName: item.StationName?.Zh_tw || currentStationName,
                        lineName: item.LineName?.Zh_tw || item.LineID,
                        lineID: item.LineID || '',
                        tripHeadSign: item.TripHeadSign || destName,
                        destinationName: destName,
                        estimateTime: item.EstimateTime || 0,
                        serviceStatus: item.ServiceStatus
                    });
                }
            });
            
            // æ’åº
            trainRows.sort((a, b) => a.estimateTime - b.estimateTime);

            // ç”Ÿæˆ HTML
            const rows = trainRows.map(train => {
                const lineColor = lineColors[train.lineID] || '#666';
                let timeDisplay;
                
                // ä¿®æ­£ï¼š<= 0 éƒ½è¦–ç‚ºé€²ç«™ä¸­
                if (train.estimateTime <= 0) {
                    timeDisplay = `<span style="color: #d32f2f; font-weight: bold;">é€²ç«™ä¸­</span>`;
                } else {
                    const minutes = Math.ceil(train.estimateTime / 60);
                    timeDisplay = `ç´„ <strong>${minutes}</strong> åˆ†é˜`;
                }
                
                const statusClass = train.estimateTime <= 60 ? 'arriving' : 'waiting';
                const statusText = train.estimateTime <= 60 ? 'å³å°‡åˆ°ç«™' : 'è¡Œé§›ä¸­';

                return `
                    <tr>
                        <td>${train.stationName}</td>
                        <td><span class="line-badge" style="background: ${lineColor};">${train.lineName}</span></td>
                        <td><span class="direction-badge"><i class="fas fa-arrow-right"></i> ${train.tripHeadSign}</span></td>
                        <td>${train.destinationName}</td>
                        <td>${timeDisplay}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>-</td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rows;
            updateUpdateTime();
            updateTrainStats(trainRows);
        }

        function updateSystemStats() {
            const stations = [...new Set(allLiveboardData.map(item => item.StationID))];
            const lines = [...new Set(allLiveboardData.map(item => item.LineName?.Zh_tw).filter(Boolean))];
            document.getElementById('stationCount').textContent = stations.length;
            document.getElementById('lineCount').textContent = lines.length;
        }

        function updateTrainStats(trainRows) {
            const total = trainRows.length;
            const arriving = trainRows.filter(t => t.estimateTime <= 180).length;
            document.getElementById('totalTrains').textContent = total;
            document.getElementById('arrivingTrains').textContent = arriving;
        }

        function updateUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('updateTime').textContent = timeStr + ' (æ¯90ç§’è‡ªå‹•æ›´æ–°)';
        }

        function togglePanel(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.className = 'fas fa-chevron-down';
            } else {
                content.classList.add('show');
                icon.className = 'fas fa-chevron-up';
            }
        }

        async function loadMetroNews() {
            try {
                const systems = ['TRTC', 'KRTC', 'TYMC', 'KLRT'];
                
                if (typeof tdxApi === 'undefined') {
                    systems.forEach(sys => {
                        const el = document.getElementById(`newsContainer-${sys}`);
                        if(el) el.innerHTML = '<p>ç„¡æ³•è¼‰å…¥å…¬å‘Šï¼ˆAPI æœªå°±ç·’ï¼‰</p>';
                    });
                    return;
                }
                
                const newsPromises = systems.map(async (systemCode) => {
                    try {
                        const endpoint = `/v2/Rail/Metro/News/${systemCode}?$format=JSON&$top=10&$orderby=PublishTime%20desc`;
                        const apiResponse = await tdxApi.fetch(endpoint);
                        
                        let newsData = [];
                        if (apiResponse && apiResponse.Newses && Array.isArray(apiResponse.Newses)) {
                            newsData = apiResponse.Newses;
                        } else if (Array.isArray(apiResponse)) {
                            newsData = apiResponse;
                        }
                        
                        const container = document.getElementById(`newsContainer-${systemCode}`);
                        if (!container) return;
                        
                        if (!newsData || newsData.length === 0) {
                            container.innerHTML = '<p style="text-align: center; padding: 15px; color: #999; font-size: 0.9rem;">ç›®å‰æ²’æœ‰æ–°å…¬å‘Š</p>';
                            return;
                        }
                        
                        let html = '';
                        newsData.slice(0, 5).forEach((news) => {
                            const updateTime = news.UpdateTime ? new Date(news.UpdateTime).toLocaleString('zh-TW', {
                                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                            }) : 'æœªçŸ¥æ™‚é–“';
                            
                            const title = news.Title || 'ç„¡æ¨™é¡Œ';
                            const description = news.Description || '';
                            const newsUrl = news.NewsURL || '#';
                            const linkHtml = newsUrl !== '#' ? 
                                `<a href="${newsUrl}" target="_blank" title="é–‹å•Ÿé€£çµ"><i class="fas fa-external-link-alt"></i></a>` : '';
                            
                            html += `
                                <div class="news-item">
                                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                                        <i class="fas fa-caret-right" style="color: #999; margin-top: 3px;"></i>
                                        <div style="flex: 1;">
                                            <h5>${title}</h5>
                                            <p>${description.substring(0, 80)}${description.length > 80 ? '...' : ''}</p>
                                            <div class="news-meta">
                                                <span><i class="far fa-clock"></i> ${updateTime}</span>
                                                ${linkHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = html;
                        
                    } catch (e) {
                        console.error(`è¼‰å…¥ ${systemCode} å…¬å‘Šå¤±æ•—`, e);
                        const container = document.getElementById(`newsContainer-${systemCode}`);
                        if(container) container.innerHTML = '<p style="color: #f44336; text-align: center; padding: 10px;">è¼‰å…¥å¤±æ•—</p>';
                    }
                });
                
                await Promise.all(newsPromises);
                
            } catch (e) {
                console.error('è¼‰å…¥æ·é‹ç³»çµ±å…¬å‘Šå¤±æ•—', e);
            }
        }

        window.onload = function() {
            // â˜… è‡ªå‹•é è¨­è¼‰å…¥å°åŒ—æ·é‹ (TRTC)
            selectSystem('TRTC');
            loadMetroNews();
        };
    </script>

    <div class="back-to-top" id="backToTop" style="position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: linear-gradient(135deg, #1e40af, #0891b2); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999; font-size: 1.2rem;">
        <i class="fas fa-arrow-up"></i>
    </div>
</body>
</html>
