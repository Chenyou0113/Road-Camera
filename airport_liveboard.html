<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣機場航班動態</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === 基礎變數與設定 === */
        :root {
            --primary-gradient: linear-gradient(135deg, #0056b3 0%, #003d80 100%);
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            
            --header-dep: #0056b3; /* 出發藍 */
            --header-arr: #2e7d32; /* 抵達綠 */
            
            --status-green: #28a745;
            --status-red: #dc3545;
            --status-yellow: #ffc107;
            --status-gray: #6c757d;
        }

        body.dark-mode {
            --primary-gradient: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #aaa;
            --header-dep: #1565c0;
            --header-arr: #2e7d32;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }

        /* === Header === */
        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .back-btn { color: white; text-decoration: none; font-size: 1.2rem; }
        .header-title { font-size: 1.25rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .header-right { display: flex; align-items: center; gap: 10px; }

        .btn-pids {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .btn-pids:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }

        .btn-theme {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* === 控制面板 === */
        .control-panel {
            background: var(--card-bg);
            padding: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .airport-selector {
            width: 100%;
            padding: 10px 15px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 12px;
            background-color: var(--bg-color);
            color: var(--text-main);
            outline: none;
            font-weight: bold;
        }
        body.dark-mode .airport-selector { border-color: #444; }

        /* === 頁籤 (Tabs) === */
        .tabs {
            display: flex;
            background: var(--card-bg);
            padding: 5px 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 0;
            border: none;
            background: transparent;
            color: var(--text-sub);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .tab-btn.active { color: #007bff; }
        body.dark-mode .tab-btn.active { color: #4fa3ff; }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            width: 60%;
            height: 3px;
            background-color: #007bff;
            border-radius: 3px 3px 0 0;
        }
        body.dark-mode .tab-btn.active::after { background-color: #4fa3ff; }
        
        .tab-btn.disabled { display: none; } /* 自動隱藏 */

        /* === 雙欄佈局 === */
        .split-view {
            flex: 1;
            display: flex;
            overflow: hidden; 
        }

        .split-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(0,0,0,0.1);
            background-color: var(--bg-color);
        }
        body.dark-mode .split-col { border-right: 1px solid rgba(255,255,255,0.1); }
        .split-col:last-child { border-right: none; }

        .col-header {
            padding: 10px 15px;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 5;
        }
        .header-dep { background-color: var(--header-dep); }
        .header-arr { background-color: var(--header-arr); }

        .flight-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* 航班卡片 */
        .flight-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid transparent;
            display: grid;
            grid-template-columns: 50px 1fr auto;
            gap: 10px;
            align-items: center;
        }
        
        .flight-card.status-ontime { border-left-color: var(--status-green); }
        .flight-card.status-delayed { border-left-color: var(--status-red); }
        .flight-card.status-boarding { border-left-color: var(--status-yellow); }
        .flight-card.status-arrived, .flight-card.status-departed { border-left-color: var(--status-gray); }

        .time-main { font-size: 1.2rem; font-weight: 800; color: var(--text-main); line-height: 1; text-align: center;}
        .time-delayed { color: var(--status-red); text-decoration: line-through; font-size: 0.8rem; display: block;}
        .time-new { color: var(--status-red); font-weight: bold; font-size: 1.2rem; }

        .airline-tag { font-size: 0.75rem; color: var(--text-sub); display: block; margin-bottom: 2px;}
        .flight-no { font-weight: bold; font-size: 0.95rem; color: #007bff; margin-right: 5px; }
        body.dark-mode .flight-no { color: #6db3ff; }
        .dest-cn { font-size: 1.1rem; font-weight: bold; color: var(--text-main); }
        .dest-code { font-size: 0.8rem; color: var(--text-sub); margin-left: 5px; font-weight: bold; }

        .status-text { 
            font-size: 0.85rem; 
            font-weight: bold; 
            text-align: right; 
            display: block;
            margin-bottom: 4px;
        }
        .status-ontime .status-text { color: var(--status-green); }
        .status-delayed .status-text { color: var(--status-red); }
        .status-boarding .status-text { color: #f57f17; }
        
        .gate-info { font-size: 0.8rem; color: var(--text-sub); text-align: right; }

        /* 載入中 */
        .loading { text-align: center; padding: 30px; color: var(--text-sub); }
        .empty-msg { text-align: center; padding: 30px; color: #999; font-size: 0.9rem; }

        /* 手機版適配：變為上下排列 */
        @media (max-width: 768px) {
            .split-view { flex-direction: column; overflow: auto; }
            .split-col { 
                height: auto; 
                flex: none; 
                border-right: none;
                border-bottom: 1px solid rgba(0,0,0,0.1);
            }
            .flight-list { max-height: 50vh; } 
            .btn-pids span { display: none; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <a href="javascript:history.back()" class="back-btn"><i class="fas fa-arrow-left"></i></a>
            <div class="header-title">
                <i class="fas fa-plane"></i> 航班動態
            </div>
        </div>
        <div class="header-right">
            <a href="airport-pids.html" target="_blank" class="btn-pids">
                <i class="fas fa-tv"></i> <span>PIDS</span>
            </a>
            <button class="btn-theme" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <div class="control-panel">
        <select class="airport-selector" id="airportSelect" onchange="handleAirportChange()">
            <optgroup label="北部 North">
                <option value="TSA" selected>臺北松山 TSA</option>
                <option value="TPE">桃園國際 TPE</option>
            </optgroup>
            <optgroup label="中部 Central">
                <option value="RMQ">臺中清泉崗 RMQ</option>
            </optgroup>
            <optgroup label="南部 South">
                <option value="KHH">高雄小港 KHH</option>
                <option value="TNN">臺南 TNN</option>
                <option value="CYI">嘉義 CYI</option>
            </optgroup>
            <optgroup label="東部 East">
                <option value="HUN">花蓮 HUN</option>
                <option value="TTT">臺東 TTT</option>
            </optgroup>
            <optgroup label="離島 Offshore Islands">
                <option value="MZG">澎湖 MZG</option>
                <option value="KNH">金門 KNH</option>
                <option value="LZN">馬祖南竿 LZN</option>
                <option value="MFK">馬祖北竿 MFK</option>
                <option value="LUD">綠島 LUD</option>
                <option value="KYD">蘭嶼 KYD</option>
                <option value="CMJ">七美 CMJ</option>
                <option value="WOT">望安 WOT</option>
            </optgroup>
        </select>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchRouteType('DOMESTIC')" id="tabDom">國內線 Domestic</button>
        <button class="tab-btn" onclick="switchRouteType('INTERNATIONAL')" id="tabInt">國際線 International</button>
    </div>

    <!-- 左右分欄區 -->
    <div class="split-view">
        <!-- 左欄：出發 -->
        <div class="split-col">
            <div class="col-header header-dep">
                <i class="fas fa-plane-departure"></i> 出發 Departures
            </div>
            <div class="flight-list" id="listDep">
                <div class="loading"><i class="fas fa-circle-notch fa-spin"></i></div>
            </div>
        </div>

        <!-- 右欄：抵達 -->
        <div class="split-col">
            <div class="col-header header-arr">
                <i class="fas fa-plane-arrival"></i> 抵達 Arrivals
            </div>
            <div class="flight-list" id="listArr">
                <div class="loading"><i class="fas fa-circle-notch fa-spin"></i></div>
            </div>
        </div>
    </div>

    <div style="text-align: center; padding: 5px; font-size: 0.75rem; color: #888; background: var(--bg-color);">
        資料來源：TDX | 更新時間：<span id="updateTime">--:--</span>
    </div>

    <script>
        const WORKER_URL = "https://airport.xiaoyouwu5-fd3.workers.dev/"; 
        let currentData = null;
        let currentRouteType = 'DOMESTIC'; 

        // 國際機場白名單
        const INT_AIRPORTS = ['TPE', 'TSA', 'KHH', 'RMQ'];

        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('themeToggle');
            toggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                toggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                localStorage.setItem('airport_theme', isDark ? 'dark' : 'light');
            });
            if(localStorage.getItem('airport_theme') === 'dark') {
                document.body.classList.add('dark-mode');
                toggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            handleAirportChange();
        });

        // 智慧隱藏國際線按鈕
        async function handleAirportChange() {
            const airport = document.getElementById('airportSelect').value;
            const tabInt = document.getElementById('tabInt');
            const tabDom = document.getElementById('tabDom');

            if (!INT_AIRPORTS.includes(airport)) {
                tabInt.classList.add('disabled');
                // 如果目前在國際線，強制切回國內線
                if (currentRouteType === 'INTERNATIONAL') {
                    currentRouteType = 'DOMESTIC';
                    tabDom.classList.add('active');
                    tabInt.classList.remove('active');
                }
            } else {
                tabInt.classList.remove('disabled');
            }

            await fetchData();
        }

        async function fetchData() {
            const airport = document.getElementById('airportSelect').value;
            const loadingHtml = `<div class="loading"><i class="fas fa-circle-notch fa-spin"></i><p>載入中...</p></div>`;
            document.getElementById('listDep').innerHTML = loadingHtml;
            document.getElementById('listArr').innerHTML = loadingHtml;

            try {
                const res = await fetch(`${WORKER_URL}?airport=${airport}`);
                if(!res.ok) throw new Error("API Error");
                currentData = await res.json();
                
                const now = new Date();
                document.getElementById('updateTime').innerText = 
                    now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });

                renderLists();

            } catch (e) {
                console.error(e);
                const errHtml = `<div class="loading" style="color:var(--status-red)">載入失敗</div>`;
                document.getElementById('listDep').innerHTML = errHtml;
                document.getElementById('listArr').innerHTML = errHtml;
            }
        }

        function switchRouteType(type) {
            currentRouteType = type;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(type === 'DOMESTIC' ? 'tabDom' : 'tabInt').classList.add('active');
            renderLists();
        }

        function renderLists() {
            if (!currentData) return;

            // 取得現在時間 (HH:mm) - 用來自動捲動，但不拿來過濾
            const now = new Date();
            const currentTime = now.toTimeString().substring(0, 5);

            // 修正：移除時間過濾，顯示當日所有航班
            const filterAndSlice = (list) => {
                let sortedList = (list || []).sort((a, b) => a.time.localeCompare(b.time));
                // 手機版顯示全天，讓使用者可以滑動查看整日班次
                return sortedList; 
            };

            let dataDep = [], dataArr = [];

            if (currentRouteType === 'DOMESTIC') {
                dataDep = filterAndSlice(currentData.DOMESTIC_DEPARTURES);
                dataArr = filterAndSlice(currentData.DOMESTIC_ARRIVALS);
            } else {
                dataDep = filterAndSlice(currentData.INTERNATIONAL_DEPARTURES);
                dataArr = filterAndSlice(currentData.INTERNATIONAL_ARRIVALS);
            }

            renderContainer('listDep', dataDep);
            renderContainer('listArr', dataArr);
            
            // 新增：自動捲動到「最接近現在時間」的班機位置
            setTimeout(() => {
                scrollToCurrentTime('listDep', currentTime);
                scrollToCurrentTime('listArr', currentTime);
            }, 100);
        }

        // 自動捲動輔助函式
        function scrollToCurrentTime(containerId, currentTime) {
            const container = document.getElementById(containerId);
            const times = container.getElementsByClassName('time-main');
            
            for (let i = 0; i < times.length; i++) {
                const t = times[i].innerText;
                // 找到第一個時間比現在晚的，或是相等的
                if (t >= currentTime) {
                    const card = times[i].closest('.flight-card');
                    if (card) {
                        // 讓該卡片滾動到容器頂部
                        container.scrollTop = card.offsetTop - container.offsetTop - 10;
                    }
                    break;
                }
            }
        }

        function renderContainer(containerId, flights) {
            const container = document.getElementById(containerId);
            if (flights.length === 0) {
                container.innerHTML = `<div class="empty-msg">近期無航班資訊</div>`;
                return;
            }

            let html = '';
            flights.forEach(f => {
                // 目的地顯示：中文 + 三碼代號
                let parts = f.dest.split(' ');
                let cn = parts[1] || parts[0]; 
                let code = "";
                if (f.dest.match(/^[A-Z]{3}/)) code = f.dest.substring(0,3);
                if (!cn.match(/[\u4e00-\u9fa5]/)) cn = f.dest;

                // 時間顯示 (支援延誤)
                let timeHtml = `<div class="time-main">${f.time}</div>`;
                if (f.est && f.est !== f.time && !f.status.includes('取消') && !f.status.includes('準時') && f.est.includes(':')) {
                    timeHtml = `
                        <span class="time-delayed">${f.time}</span>
                        <div class="time-new">${f.est}</div>
                    `;
                }

                // 狀態顯示
                let statusText = f.status.split(' ')[0]; 
                if (f.status.includes("Check-in")) statusText = "報到中";

                html += `
                <div class="flight-card status-${f.type}">
                    <div>${timeHtml}</div>
                    <div>
                        <span class="airline-tag">${f.airline}</span>
                        <div>
                            <span class="flight-no">${f.flight.split('-')[1] || f.flight}</span>
                            <span class="dest-cn">${cn}</span>
                            <span class="dest-code">${code}</span>
                        </div>
                    </div>
                    <div>
                        <span class="status-text">${statusText}</span>
                        <div class="gate-info">
                            ${f.gate && f.gate !== '-' ? '<i class="fas fa-door-open"></i> '+f.gate : ''}
                        </div>
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;
        }
    </script>
</body>
</html>
