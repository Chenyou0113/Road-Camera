<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°£è±¡è§€æ¸¬ç«™ - ä¸­å¤®æ°£è±¡ç½²å³æ™‚è³‡æ–™</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <link rel="stylesheet" href="assets/theme-toggle-unified.css">

    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #1a1a2e; color: #fff; margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* é ‚éƒ¨å°èˆª */
        .navbar { background: #16213e; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .nav-title { font-size: 1.4rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .nav-actions { display: flex; gap: 10px; }
        .btn { padding: 8px 15px; border-radius: 20px; text-decoration: none; font-size: 0.9rem; font-weight: bold; transition: 0.3s; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; }
        .btn:hover { background: rgba(255,255,255,0.2); }

        /* çµ±è¨ˆå„€è¡¨æ¿ */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; padding: 20px; background: #0f3460; }
        .stat-card { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #4fc3f7; }
        .stat-val { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.85rem; color: #aaa; }

        /* åœ°åœ–å€åŸŸ */
        #map { flex: 1; min-height: 500px; width: 100%; z-index: 1; }

        /* åº•éƒ¨ç¯©é¸å™¨ */
        .filter-bar { background: #16213e; padding: 15px; overflow-x: auto; white-space: nowrap; display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .filter-btn { padding: 6px 15px; border-radius: 15px; border: 1px solid #4fc3f7; color: #4fc3f7; background: transparent; cursor: pointer; transition: 0.3s; }
        .filter-btn:hover, .filter-btn.active { background: #4fc3f7; color: #000; }

        /* å½ˆçª—æ¨£å¼ */
        .popup-content { font-size: 0.95rem; line-height: 1.6; min-width: 200px; color: #333; }
        .popup-title { font-weight: bold; font-size: 1.1rem; color: #003a70; margin-bottom: 5px; border-bottom: 2px solid #4fc3f7; padding-bottom: 3px; }
        .popup-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .popup-val { font-weight: bold; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="nav-title">
            <i class="fas fa-satellite-dish" style="color: #ff9800;"></i>
            æ°£è±¡è§€æ¸¬ç«™ - å³æ™‚è³‡æ–™
        </div>
        <div class="nav-actions">
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
            <a href="index.html" class="btn"><i class="fas fa-arrow-left"></i> è¿”å›ä¸»é </a>
        </div>
    </div>

    <div class="dashboard">
        <div class="stat-card" style="border-color: #fff;">
            <div class="stat-val" id="totalCount">0</div>
            <div class="stat-label">è§€æ¸¬ç«™æ•¸</div>
        </div>
        <div class="stat-card" style="border-color: #ff9800;">
            <div class="stat-val" id="avgTemp">--Â°C</div>
            <div class="stat-label">å¹³å‡æ°£æº«</div>
        </div>
        <div class="stat-card" style="border-color: #f44336;">
            <div class="stat-val" id="maxTemp">--Â°C</div>
            <div class="stat-label">æœ€é«˜æ°£æº«</div>
        </div>
        <div class="stat-card" style="border-color: #00d9ff;">
            <div class="stat-val" id="minTemp">--Â°C</div>
            <div class="stat-label">æœ€ä½æ°£æº«</div>
        </div>
        <div class="stat-card" style="border-color: #7c4dff;">
            <div class="stat-val" id="rainCount">0</div>
            <div class="stat-label">é™é›¨ç«™æ•¸</div>
        </div>
        <div class="stat-card" style="border-color: #00e676;">
            <div class="stat-val" id="maxRain">0mm</div>
            <div class="stat-label">æœ€é«˜é›¨é‡</div>
        </div>
    </div>

    <div id="map"></div>

    <div class="filter-bar" id="countyFilter">
        <button class="filter-btn active" onclick="filterMap('å…¨éƒ¨')">å…¨éƒ¨</button>
        </div>

    <script>
        // è¨­å®š Worker ç¶²å€
        const API_BASE = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev';
        
        let map;
        let markers = L.layerGroup();
        let allStations = [];

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            map = L.map('map').setView([23.6, 121.0], 8);
            
            // ä½¿ç”¨æ·±è‰²åº•åœ–
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            markers.addTo(map);
        }

        // è¼‰å…¥è³‡æ–™ (åŒæ™‚æŠ“å–å±€å±¬ç«™èˆ‡è‡ªå‹•ç«™)
        async function loadData() {
            try {
                // 1. æŠ“å–å±€å±¬ç«™ (æœ‰äººç«™)
                const res1 = await fetch(`${API_BASE}/?dataset=O-A0003-001`);
                const data1 = await res1.json();
                
                // 2. æŠ“å–è‡ªå‹•ç«™ (ç„¡äººç«™)
                const res2 = await fetch(`${API_BASE}/?dataset=O-A0001-001`);
                const data2 = await res2.json();

                // åˆä½µè³‡æ–™
                const list1 = data1.records?.Station || [];
                const list2 = data2.records?.Station || [];
                allStations = [...list1, ...list2];

                console.log(`å…±è¼‰å…¥ ${allStations.length} å€‹æ¸¬ç«™`);
                
                renderMarkers(allStations);
                updateStats(allStations);
                generateFilterButtons();

            } catch (e) {
                console.error("è¼‰å…¥å¤±æ•—:", e);
                alert("ç„¡æ³•é€£ç·šè‡³æ°£è±¡è³‡æ–™åº«ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }

        // ç¹ªè£½æ¨™è¨˜
        function renderMarkers(stations) {
            markers.clearLayers();

            stations.forEach(s => {
                const lat = s.GeoInfo.Coordinates[1].StationLatitude;
                const lon = s.GeoInfo.Coordinates[0].StationLongitude;
                const temp = getVal(s, 'TEMP');
                const rain = getVal(s, 'H_24R') || getVal(s, 'RAIN') || 0;
                
                // æ ¹æ“šæº«åº¦æ±ºå®šé¡è‰²
                let color = '#4fc3f7'; // è— (æ¶¼çˆ½)
                if (temp > 30) color = '#f44336'; // ç´… (ç†±)
                else if (temp > 25) color = '#ff9800'; // æ©˜ (æš–)
                else if (temp < 15) color = '#00d9ff'; // é’ (å†·)

                // å»ºç«‹åœ“é»æ¨™è¨˜
                const marker = L.circleMarker([lat, lon], {
                    radius: 6,
                    fillColor: color,
                    color: "#fff",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                // ç¶å®šå½ˆçª—
                const popupContent = `
                    <div class="popup-content">
                        <div class="popup-title">${s.StationName} (${s.StationId})</div>
                        <div class="popup-row"><span>ğŸŒ¡ï¸ æº«åº¦</span><span class="popup-val">${temp}Â°C</span></div>
                        <div class="popup-row"><span>ğŸ’§ æ¿•åº¦</span><span class="popup-val">${getVal(s, 'HUMD')}%</span></div>
                        <div class="popup-row"><span>ğŸŒ§ï¸ é›¨é‡</span><span class="popup-val">${rain}mm</span></div>
                        <div class="popup-row"><span>ğŸƒ é¢¨é€Ÿ</span><span class="popup-val">${getVal(s, 'WDSD')}m/s</span></div>
                        <div class="popup-row" style="margin-top:5px; font-size:0.8rem; color:#666;">ğŸ“ ${s.GeoInfo.CountyName} ${s.GeoInfo.TownName}</div>
                    </div>
                `;
                marker.bindPopup(popupContent);
                markers.addLayer(marker);
            });
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats(stations) {
            let temps = [];
            let rains = [];
            
            stations.forEach(s => {
                const t = getVal(s, 'TEMP');
                const r = getVal(s, 'H_24R') || 0;
                if (t > -50 && t < 50) temps.push(t);
                if (r >= 0) rains.push(r);
            });

            if (temps.length > 0) {
                const max = Math.max(...temps);
                const min = Math.min(...temps);
                const avg = (temps.reduce((a,b)=>a+b,0) / temps.length).toFixed(1);
                
                document.getElementById('totalCount').innerText = stations.length;
                document.getElementById('avgTemp').innerText = avg + 'Â°C';
                document.getElementById('maxTemp').innerText = max + 'Â°C';
                document.getElementById('minTemp').innerText = min + 'Â°C';
                
                // çµ±è¨ˆé™é›¨
                const rainyStations = rains.filter(r => r > 0).length;
                const maxRain = Math.max(...rains);
                
                document.getElementById('rainCount').innerText = rainyStations;
                document.getElementById('maxRain').innerText = maxRain + 'mm';
            }
        }

        // ç”¢ç”Ÿç¸£å¸‚ç¯©é¸æŒ‰éˆ•
        function generateFilterButtons() {
            const counties = [...new Set(allStations.map(s => s.GeoInfo.CountyName))];
            const container = document.getElementById('countyFilter');
            
            // æ¸…ç©ºèˆŠæŒ‰éˆ• (ä¿ç•™ç¬¬ä¸€å€‹ 'å…¨éƒ¨')
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            counties.forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.innerText = c;
                btn.onclick = () => filterMap(c);
                container.appendChild(btn);
            });
        }

        // ç¯©é¸åœ°åœ–
        function filterMap(county) {
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.toggle('active', b.innerText === county);
            });

            if (county === 'å…¨éƒ¨') {
                renderMarkers(allStations);
                map.setView([23.6, 121.0], 8);
            } else {
                const filtered = allStations.filter(s => s.GeoInfo.CountyName === county);
                renderMarkers(filtered);
                
                // è‡ªå‹•ç¸®æ”¾åˆ°è©²ç¸£å¸‚ç¯„åœ
                if (filtered.length > 0) {
                    const group = L.featureGroup(markers.getLayers());
                    map.fitBounds(group.getBounds());
                }
            }
        }

        // è¼”åŠ©å–å€¼å‡½å¼
        function getVal(item, key) {
            if (Array.isArray(item.WeatherElement)) {
                const el = item.WeatherElement.find(e => e.ElementName === key);
                return el ? parseFloat(el.ElementValue) : -99;
            }
            const k = key === 'TEMP' ? 'AirTemperature' : (key === 'HUMD' ? 'RelativeHumidity' : key);
            let val = item.WeatherElement?.[k];
            // è™•ç†é›¨é‡ç‰¹æ®Šçµæ§‹
            if (key === 'H_24R') val = item.WeatherElement?.Now?.Precipitation;
            return parseFloat(val);
        }

        // æ·±è‰²æ¨¡å¼åˆ‡æ›
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            // åˆ‡æ›åœ°åœ–åº•åœ–
            if(isDark) {
                // æ·±è‰²åº•åœ–
            } else {
                // æ·ºè‰²åº•åœ– (å¯é¸)
            }
        }

        // å•Ÿå‹•
        initMap();
        loadData();
    </script>
</body>
</html>