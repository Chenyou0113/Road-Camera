<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣即時空品戰情室</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- ✨ 深色模式 CSS -->
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #1e40af 0%, #0891b2 100%); min-height: 100vh; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #1e40af; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #1e40af; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .back-btn:hover { background: #0891b2; }
        .loading { text-align: center; padding: 50px; color: white; font-size: 1.2rem; }
        .cameras-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        @media (max-width: 1200px) { .cameras-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .cameras-grid { grid-template-columns: 1fr; } }
        .camera-card { 
            background: white; 
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            cursor: pointer; 
            transition: transform 0.3s; 
            position: relative; 
        }
        .camera-card:hover { transform: translateY(-5px); }
        .camera-card h3 { color: #1e40af; margin-bottom: 10px; font-size: 1.1rem; }
        .camera-card p { color: #666; margin: 5px 0; font-size: 0.9rem; }

        .status-badge { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            font-weight: bold; 
            color: white; 
        }
        .status-demo { background: #FF9800; }
        .status-live { background: #4CAF50; }
        .aqi-value { 
            display: inline-block; 
            padding: 8px 12px; 
            border-radius: 20px; 
            font-weight: bold; 
            min-width: 50px; 
            text-align: center; 
        }
        .pollutant-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            margin-top: 8px; 
        }
        .pollutant-item { 
            background: #f8f9fa; 
            padding: 6px 8px; 
            border-radius: 4px; 
            text-align: center; 
            font-size: 0.75rem; 
        }
        .pollutant-item .label { color: #666; font-weight: bold; }
        .pollutant-item .value { color: #333; font-weight: bold; margin-top: 2px; }
        
        .filter-box { 
            background: white; 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        }
        .filter-box h3 { color: #1e40af; margin-bottom: 15px; }
        .filter-controls { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-box input { 
            width: 100%; 
            padding: 10px 10px 10px 35px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 1rem; 
            outline: none; 
            transition: border-color 0.3s; 
        }
        .search-box input:focus { border-color: #1e40af; }
        .search-box i { 
            position: absolute; 
            left: 10px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #999; 
        }
        .filter-select { 
            padding: 10px 15px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 1rem; 
            background: white; 
            color: #333; 
            cursor: pointer;
            transition: border-color 0.3s;
            min-width: 120px;
        }
        .filter-select:hover, .filter-select:focus { border-color: #1e40af; outline: none; }
        .btn { 
            padding: 10px 15px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: background-color 0.3s;
            font-weight: 500;
        }
        .btn-primary { background: #1e40af; color: white; }
        .btn-primary:hover { background: #0891b2; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown 0.3s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #1e40af;
            padding-bottom: 15px;
        }
        .modal-header h2 { color: #1e40af; font-size: 1.5rem; }
        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }
        .close-btn:hover { color: #333; }
        
        .detail-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1e40af;
        }
        .detail-section h3 {
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        @media (max-width: 600px) { .detail-grid { grid-template-columns: 1fr; } }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .detail-item-label {
            font-weight: bold;
            color: #666;
            min-width: 120px;
        }
        .detail-item-value {
            color: #333;
            text-align: right;
            font-weight: bold;
        }
        
        .detail-full-width {
            grid-column: 1 / -1;
        }
        
        .large-image-container {
            display: none;
        }
        
        .stats-grid {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-item {
            text-align: center;
            margin: 5px;
            padding: 10px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* === 新版 Modal 樣式 === */
        .modal-content.extended-modal {
            max-width: 750px;
            padding: 20px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-top-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-right: 30px;
        }

        .modal-header-info h2 {
            font-size: 1.6rem;
            margin-bottom: 8px;
            color: #1e40af;
        }

        .badges {
            display: flex;
            gap: 8px;
            font-size: 0.85rem;
        }

        .badge {
            background: #f0f0f0;
            padding: 4px 10px;
            border-radius: 4px;
            color: #666;
        }

        .badge.time-badge {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* 小版 AQI 圓圈 */
        .aqi-circle-small {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            flex-shrink: 0;
        }
        .aqi-circle-small span { font-size: 1.8rem; line-height: 1; }
        .aqi-circle-small small { font-size: 0.65rem; opacity: 0.9; margin-top: 2px; }

        .modal-divider {
            border: 0;
            border-top: 1px solid #eee;
            margin: 12px 0 15px 0;
        }

        .modal-body-scroll {
            overflow-y: auto;
            flex: 1;
            padding-right: 8px;
        }

        /* 污染物網格 */
        .pollutant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .pollutant-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 14px;
            transition: all 0.2s;
        }

        .pollutant-box:hover {
            background: #fff;
            border-color: #bbdefb;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .p-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .p-title .unit {
            font-size: 0.7em;
            color: #888;
            font-weight: 500;
        }

        .p-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .p-row.single-row {
            margin-top: 10px;
            margin-bottom: 0;
        }

        .p-label {
            color: #666;
            font-size: 0.9rem;
        }

        .p-val {
            font-weight: 700;
            color: #1565c0;
            font-family: 'Courier New', monospace;
            font-size: 1.05rem;
        }

        .info-row {
            font-size: 0.9rem;
            color: #888;
            text-align: right;
            margin: 12px 0 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* 手機版調整 */
        @media (max-width: 600px) {
            .pollutant-grid {
                grid-template-columns: 1fr 1fr;
            }
            .modal-content.extended-modal {
                width: 95%;
                padding: 12px;
                max-width: 100%;
            }
            .modal-header-info h2 { font-size: 1.3rem; }
            .aqi-circle-small { width: 60px; height: 60px; }
            .aqi-circle-small span { font-size: 1.4rem; }
            .p-title { font-size: 0.85rem; }
            .p-row { font-size: 0.85rem; }
            .p-val { font-size: 0.95rem; }
        }

        /* === ✨ 新增：返回按鈕樣式 === */
        .back-btn { 
            display: inline-flex; 
            align-items: center;
            gap: 8px;
            padding: 10px 20px; 
            background: #016d68; 
            color: white; 
            text-decoration: none; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .back-btn:hover { 
            background: #034d64; 
            transform: translateY(-2px);
        }

        /* === ✨ 新增：深色模式覆寫樣式 (Dark Mode) === */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
        }

        /* 區塊背景黑化 */
        body.dark-mode .header,
        body.dark-mode .filter-box,
        body.dark-mode .stats-grid,
        body.dark-mode .camera-card,
        body.dark-mode .modal-content {
            background: #252a34;
            color: #e0e0e0;
            border-color: #393e46;
        }

        /* 文字顏色調整 */
        body.dark-mode .header h1 { color: #4db6ac; }
        body.dark-mode .header p { color: #b0bec5; }
        body.dark-mode .filter-box h3 { color: #4db6ac; }
        body.dark-mode .stat-label { color: #b0bec5; }

        /* 卡片與輸入框 */
        body.dark-mode .camera-card {
            background: #2e3440;
            border-color: #393e46;
        }
        body.dark-mode .camera-card:hover { background: #3b4252; }
        body.dark-mode .camera-card h3,
        body.dark-mode .camera-card p { color: #b0bec5; }
        body.dark-mode .status-badge { background: #37474f; color: #eceff1; }
        body.dark-mode .aqi-value { background: #37474f; color: #eceff1; }

        /* 輸入框與選單 */
        body.dark-mode .search-box input,
        body.dark-mode .filter-select {
            background: #252a34;
            border-color: #455a64;
            color: #fff;
        }
        body.dark-mode .search-box input:focus,
        body.dark-mode .filter-select:focus { border-color: #4db6ac; }
        body.dark-mode .search-box i { color: #90a4ae; }

        /* Modal 內部 */
        body.dark-mode .modal-content.extended-modal {
            background: #252a34;
            border-color: #393e46;
        }
        body.dark-mode .pollutant-box {
            background: #2e3440;
            border-color: #393e46;
        }
        body.dark-mode .p-title { color: #eceff1; border-bottom-color: #455a64; }
        body.dark-mode .p-label { color: #b0bec5; }
        body.dark-mode .p-val { color: #80cbc4; }
        body.dark-mode .modal-divider { border-top-color: #393e46; }
        body.dark-mode .close-btn { color: #eceff1; }
        body.dark-mode .badge { background: #37474f; color: #eceff1; }
        body.dark-mode .detail-item-label { color: #b0bec5; }
        body.dark-mode .detail-item-value { color: #eceff1; }
        body.dark-mode .pollutant-item { background: #2e3440; border-color: #393e46; }
        body.dark-mode .pollutant-item .label { color: #90a4ae; }
        body.dark-mode .pollutant-item .value { color: #80cbc4; }

        /* 按鈕深色模式 */
        body.dark-mode .btn-primary { background: #016d68; border-color: #016d68; }
        body.dark-mode .btn-primary:hover { background: #034d64; }
        body.dark-mode .btn-secondary { background: #455a64; border-color: #455a64; color: #eceff1; }
        body.dark-mode .btn-secondary:hover { background: #546e7a; }

        /* Modal 外層 */
        body.dark-mode .modal {
            background: rgba(0,0,0,0.7);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-wind"></i> 🎥 空品測站影像</h1>
            <p style="text-align: center; color: #666;">環境部空氣品質監測站即時影像</p>
        </div>
    </div>
    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回首頁</a>
        
        <!-- 搜尋與篩選功能 -->
        <div class="filter-box">
            <h3><i class="fas fa-search"></i> 搜尋測站名稱、編碼或縣市...</h3>
            <div class="filter-controls">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="輸入關鍵字搜尋..." oninput="applyFilters()">
                </div>
                <select class="filter-select" id="countySelect" onchange="applyFilters()">
                    <option value="">全部縣市</option>
                </select>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i> 清除篩選
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> 🔄 刷新資料
                </button>
            </div>
        </div>
        
        <!-- 資料來源說明 -->
        <div class="filter-box">
            <p style="margin: 0; font-weight: bold;" id="dataSourceInfo">
                <i class="fas fa-info-circle"></i> 載入中...
            </p>
        </div>
        
        <!-- 統計資訊 -->
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" style="color: #1e40af;" id="totalStations">0</div>
                <div class="stat-label">總測站數</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #4CAF50;" id="filteredStations">0</div>
                <div class="stat-label">篩選結果</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #2196F3;" id="countyCount">0</div>
                <div class="stat-label">涵蓋縣市</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #4CAF50;" id="goodAqiCount">0</div>
                <div class="stat-label">良好品質</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #FFA726;" id="moderateAqiCount">0</div>
                <div class="stat-label">普通品質</div>
            </div>
        </div>
        
        <div id="cameras-container" class="loading"><i class="fas fa-spinner fa-spin"></i> 載入中...</div>
    </div>
    
    <!-- 詳細資訊模態彈窗 (新版) -->
    <div id="detailsModal" class="modal" onclick="if(event.target===this) closeDetailsModal()">
        <div class="modal-content extended-modal">
            <button class="close-btn" onclick="closeDetailsModal()">×</button>
            
            <div class="modal-top-section">
                <div class="modal-header-info">
                    <h2 id="modalTitle">測站詳細資訊</h2>
                    <div class="badges">
                        <span id="m-county" class="badge">縣市</span>
                        <span id="m-time" class="badge time-badge">更新時間</span>
                    </div>
                </div>
                <!-- AQI 圓圈 (縮小版) -->
                <div class="aqi-circle-small" id="m-aqi-bg">
                    <span id="m-aqi">--</span>
                    <small>AQI</small>
                </div>
            </div>
            
            <hr class="modal-divider">
            
            <div id="stationImageSection"></div>

            <div class="modal-body-scroll">
                <!-- 污染物數據網格 -->
                <div class="pollutant-grid">
                    <!-- PM2.5 -->
                    <div class="pollutant-box">
                        <div class="p-title">PM2.5 <span class="unit">(μg/m³)</span></div>
                        <div class="p-row">
                            <span class="p-label">移動平均</span>
                            <span class="p-val" id="detailPM25Avg">--</span>
                        </div>
                        <div class="p-row">
                            <span class="p-label">即時濃度</span>
                            <span class="p-val" id="detailPM25">--</span>
                        </div>
                    </div>

                    <!-- PM10 -->
                    <div class="pollutant-box">
                        <div class="p-title">PM10 <span class="unit">(μg/m³)</span></div>
                        <div class="p-row">
                            <span class="p-label">移動平均</span>
                            <span class="p-val" id="detailPM10Avg">--</span>
                        </div>
                        <div class="p-row">
                            <span class="p-label">即時濃度</span>
                            <span class="p-val" id="detailPM10">--</span>
                        </div>
                    </div>

                    <!-- O3 臭氧 -->
                    <div class="pollutant-box">
                        <div class="p-title">O3 臭氧 <span class="unit">(ppb)</span></div>
                        <div class="p-row">
                            <span class="p-label">8小時平均</span>
                            <span class="p-val" id="detailO3Avg">--</span>
                        </div>
                        <div class="p-row">
                            <span class="p-label">即時濃度</span>
                            <span class="p-val" id="detailO3">--</span>
                        </div>
                    </div>

                    <!-- CO 一氧化碳 -->
                    <div class="pollutant-box">
                        <div class="p-title">CO 一氧化碳 <span class="unit">(ppm)</span></div>
                        <div class="p-row">
                            <span class="p-label">8小時平均</span>
                            <span class="p-val" id="detailCOAvg">--</span>
                        </div>
                        <div class="p-row">
                            <span class="p-label">即時濃度</span>
                            <span class="p-val" id="detailCO">--</span>
                        </div>
                    </div>

                    <!-- SO2 二氧化硫 -->
                    <div class="pollutant-box">
                        <div class="p-title">SO2 二氧化硫 <span class="unit">(ppb)</span></div>
                        <div class="p-row">
                            <span class="p-label">移動平均</span>
                            <span class="p-val" id="detailSO2Avg">--</span>
                        </div>
                        <div class="p-row">
                            <span class="p-label">即時濃度</span>
                            <span class="p-val" id="detailSO2">--</span>
                        </div>
                    </div>

                    <!-- NO2 二氧化氮 -->
                    <div class="pollutant-box">
                        <div class="p-title">NO2 二氧化氮 <span class="unit">(ppb)</span></div>
                        <div class="p-row single-row">
                            <span class="p-label">即時濃度</span>
                            <span class="p-val" id="detailNO2">--</span>
                        </div>
                    </div>

                    <!-- ✨ 新增：NOx 氮氧化物 -->
                    <div class="pollutant-box">
                        <div class="p-title">NOx 氮氧化物 <span class="unit">(ppb)</span></div>
                        <div class="p-row single-row">
                            <span class="p-label">即時濃度</span>
                            <span class="p-val" id="detailNOx">--</span>
                        </div>
                    </div>

                    <!-- ✨ 新增：NO 一氧化氮 -->
                    <div class="pollutant-box">
                        <div class="p-title">NO 一氧化氮 <span class="unit">(ppb)</span></div>
                        <div class="p-row single-row">
                            <span class="p-label">即時濃度</span>
                            <span class="p-val" id="detailNO">--</span>
                        </div>
                    </div>
                </div>
                
                <!-- ✨ 新增：氣象資訊區塊 -->
                <div class="detail-section" style="background: #e3f2fd; border-left-color: #2196f3; margin-top: 0;">
                    <h3><i class="fas fa-wind"></i> 氣象資訊</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-item-label">風速 (WindSpeed)</span>
                            <span class="detail-item-value"><span id="detailWindSpeed">--</span> m/sec</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-item-label">風向 (WindDirec)</span>
                            <span class="detail-item-value"><span id="detailWindDirec">--</span>°</span>
                        </div>
                    </div>
                </div>

                <!-- 基本資訊區塊 -->
                <div class="detail-section">
                    <h3><i class="fas fa-info-circle"></i> 測站資訊</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-item-label">測站代碼</span>
                            <span class="detail-item-value" id="detailSiteId">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-item-label">經緯度</span>
                            <span class="detail-item-value" id="detailCoord" style="font-size:0.9rem">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-item-label">狀態</span>
                            <span class="detail-item-value" id="detailStatus">-</span>
                        </div>
                        <div class="detail-item detail-full-width">
                            <span class="detail-item-label">主要污染指標物</span>
                            <span class="detail-item-value" id="detailPollutant" style="color:#d32f2f">-</span>
                        </div>
                    </div>
                </div>

                <!-- 地圖按鈕 (保持在最下方) -->
                <div class="modal-footer">
                    <button class="btn-locate" id="btnLocateMap" onclick="focusOnStation()">
                        <i class="fas fa-map-marked-alt"></i> 在地圖上顯示
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ 全局錯誤處理 ============
        window.addEventListener('error', (e) => {
            console.error('❌ 全局捕獲錯誤:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                error: e.error
            });
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('❌ 未處理的 Promise 拒絕:', e.reason);
        });

        // ============ 初始化變數 ============
        let isUsingRealData = false;
        let allStations = [];
        let currentStations = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面載入完成，開始載入空品資料...');
            loadAirQualityData();
        });
        
        async function loadAirQualityData() {
            const container = document.getElementById('cameras-container');
            
            if (!container) {
                console.error('❌ 找不到容器元素 "cameras-container"');
                return;
            }
            
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 載入中...</div>';
            
            try {
                console.log('🔄 嘗試連接環境部空品 API...');
                const aqResponse = await fetch('https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=b7df779e-71a6-4148-8379-5afbd441d803&limit=1000&sort=ImportDate%20desc&format=JSON');
                
                if (!aqResponse.ok) {
                    throw new Error('API 回應錯誤');
                }
                
                const aqData = await aqResponse.json();
                
                if (aqData?.records) {
                    isUsingRealData = true;
                    const dataSourceEl = document.getElementById('dataSourceInfo');
                    if (dataSourceEl) {
                        dataSourceEl.innerHTML = '✅ 顯示即時空品資料（環境部 API 連線成功）';
                        dataSourceEl.style.color = '#4CAF50';
                    }
                    
                    allStations = aqData.records.map(station => ({
                        ...station
                    }));
                    
                    // 診斷：統計有多少站點沒有攝像頭
                    const stationsWithImages = allStations.filter(s => s.imageUrl && s.imageUrl.trim()).length;
                    const stationsWithoutImages = allStations.length - stationsWithImages;
                    const imagePercentage = allStations.length > 0 ? Math.round((stationsWithoutImages / allStations.length) * 100) : 0;
                    console.log(`📊 空氣品質攝像頭統計: ${allStations.length} 站點 → ${stationsWithImages} 有影像, ${stationsWithoutImages} 無影像 (${imagePercentage}% 無影像)`);
                    
                    currentStations = [...allStations];
                    populateCountyOptions();
                    updateStatistics();
                    processAirQualityData(currentStations, container);
                    return;
                }
                throw new Error('無法獲取資料');
            } catch (error) {
                console.error('❌ 載入真實資料失敗:', error?.message || error);
                
                // 顯示錯誤訊息到頁面
                const container = document.getElementById('cameras-container');
                if (container) {
                    container.innerHTML = `
                        <div style="padding: 20px; background: #fff3cd; border-radius: 8px; margin: 20px 0;">
                            <strong style="color: #856404;">⚠️ API 連線失敗</strong><br>
                            <small style="color: #856404;">正在嘗試載入模擬資料...</small>
                        </div>
                    `;
                }
                
                loadMockData();
            }
        }
        
        function loadMockData() {
            const container = document.getElementById('cameras-container');
            if (!container) {
                console.error('❌ 找不到容器元素 "cameras-container"');
                return;
            }
            
            isUsingRealData = false;
            
            const dataSourceEl = document.getElementById('dataSourceInfo');
            if (dataSourceEl) {
                dataSourceEl.innerHTML = '⚠️ 顯示模擬空品資料（API 連線失敗，使用備用資料）';
                dataSourceEl.style.color = '#FF9800';
            }
            
            const mockStations = [
                {
                    sitename: '中山', county: '臺北市', aqi: '42', status: '良好',
                    publishtime: new Date().toISOString(), pm2_5: '15', pm25_avg: '13.5', pm10: '28', pm10_avg: '26',
                    o3: '45', o3_avg: '48', co: '0.3', co_avg: '0.28', so2: '2', no2: '18', siteid: 'TPE001',
                    latitude: '25.0330', longitude: '121.5654',
                    imageUrl: 'https://images.unsplash.com/photo-1519501025264-65ba15a82390?w=800&h=600&fit=crop'
                },
                {
                    sitename: '萬華', county: '臺北市', aqi: '58', status: '普通',
                    publishtime: new Date(Date.now() - 1800000).toISOString(),
                    pm2_5: '22', pm25_avg: '20.1', pm10: '35', pm10_avg: '33', o3: '38', o3_avg: '40', co: '0.4', co_avg: '0.38', so2: '3', no2: '25', siteid: 'TPE002',
                    latitude: '25.0360', longitude: '121.4990',
                    imageUrl: 'https://images.unsplash.com/photo-1513002749550-c59d786b8e6c?w=800&h=600&fit=crop'
                },
                {
                    sitename: '板橋', county: '新北市', aqi: '61', status: '普通',
                    publishtime: new Date(Date.now() - 600000).toISOString(),
                    pm2_5: '25', pm25_avg: '23.2', pm10: '38', pm10_avg: '36', o3: '37', o3_avg: '39', co: '0.4', co_avg: '0.39', so2: '3', no2: '28', siteid: 'NTP001',
                    latitude: '25.0092', longitude: '121.4605',
                    imageUrl: 'https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=800&h=600&fit=crop'
                },
                {
                    sitename: '桃園', county: '桃園市', aqi: '73', status: '普通',
                    publishtime: new Date(Date.now() - 2100000).toISOString(),
                    pm2_5: '32', pm25_avg: '29.8', pm10: '48', pm10_avg: '45', o3: '32', o3_avg: '35', co: '0.6', co_avg: '0.55', so2: '5', no2: '35', siteid: 'TYN001',
                    latitude: '24.9936', longitude: '121.3010',
                    imageUrl: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=800&h=600&fit=crop'
                },
                {
                    sitename: '台中', county: '臺中市', aqi: '68', status: '普通',
                    publishtime: new Date(Date.now() - 1500000).toISOString(),
                    pm2_5: '28', pm25_avg: '26.5', pm10: '42', pm10_avg: '40', o3: '35', o3_avg: '37', co: '0.5', co_avg: '0.48', so2: '4', no2: '31', siteid: 'TXG001',
                    latitude: '24.1755', longitude: '120.6396',
                    imageUrl: 'https://images.unsplash.com/photo-1516738901171-8eb4fc13bd20?w=800&h=600&fit=crop'
                }
            ];
            
            allStations = mockStations;
            currentStations = [...allStations];
            populateCountyOptions();
            updateStatistics();
            processAirQualityData(currentStations, container);
        }
        
        function processAirQualityData(stations, container) {
            const html = stations.map((station, index) => {
                const name = station.sitename || '未命名測站';
                const county = station.county || '';
                const aqi = station.aqi || 'N/A';
                
                let aqiColor = '#999', aqiStatus = '無資料';
                if (aqi && aqi !== 'N/A') {
                    const aqiNum = parseInt(aqi);
                    if (aqiNum <= 50) { aqiColor = '#4CAF50'; aqiStatus = '良好'; }
                    else if (aqiNum <= 100) { aqiColor = '#FFEB3B'; aqiStatus = '普通'; }
                    else if (aqiNum <= 150) { aqiColor = '#FF9800'; aqiStatus = '對敏感族群不健康'; }
                    else { aqiColor = '#F44336'; aqiStatus = '不健康'; }
                }
                
                const imageHtml = '';
                
                const pollutantItems = [];
                if (station.pm2_5) pollutantItems.push(`<div class="pollutant-item"><div class="label">PM2.5</div><div class="value">${station.pm2_5}</div></div>`);
                if (station.pm10) pollutantItems.push(`<div class="pollutant-item"><div class="label">PM10</div><div class="value">${station.pm10}</div></div>`);
                if (station.o3) pollutantItems.push(`<div class="pollutant-item"><div class="label">O₃</div><div class="value">${station.o3}</div></div>`);
                
                return `
                    <div class="camera-card" onclick="showStationDetails(${index})">
                        <div class="status-badge ${isUsingRealData ? 'status-live' : 'status-demo'}">${isUsingRealData ? '即時' : '模擬'}</div>
                        <h3><i class="fas fa-map-marker-alt"></i> ${name}</h3>
                        <p><i class="fas fa-map"></i> ${county}</p>
                        ${imageHtml}
                        <div style="margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 0.85rem; color: #666;">空氣品質指標</div>
                                    <div class="aqi-value" style="background: ${aqiColor}; color: white;">${aqi}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: ${aqiColor};">${aqiStatus}</div>
                                </div>
                            </div>
                            ${pollutantItems.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                    <div style="font-size: 0.8rem; color: #666; margin-bottom: 6px;"><strong>污染物濃度</strong></div>
                                    <div class="pollutant-grid">${pollutantItems.join('')}</div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                <p style="color: #1e40af; font-size: 0.85rem; text-align: center;">
                                    <i class="fas fa-expand-alt"></i> 點擊查看詳細資訊
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="cameras-grid">${html}</div>`;
        }
        
        function populateCountyOptions() {
            const countySelect = document.getElementById('countySelect');
            const counties = [...new Set(allStations.map(s => s.county).filter(c => c))].sort();
            countySelect.innerHTML = '<option value="">全部縣市</option>' + counties.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        
        function applyFilters() {
            const selectedCounty = document.getElementById('countySelect').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            currentStations = allStations.filter(station => {
                if (selectedCounty && station.county !== selectedCounty) return false;
                if (searchInput) {
                    const name = (station.sitename || '').toLowerCase();
                    const id = (station.siteid || '').toLowerCase();
                    const county = (station.county || '').toLowerCase();
                    if (!name.includes(searchInput) && !id.includes(searchInput) && !county.includes(searchInput)) return false;
                }
                return true;
            });
            
            const container = document.getElementById('cameras-container');
            processAirQualityData(currentStations, container);
            updateStatistics();
        }
        
        function clearFilters() {
            document.getElementById('countySelect').value = '';
            document.getElementById('searchInput').value = '';
            currentStations = [...allStations];
            const container = document.getElementById('cameras-container');
            processAirQualityData(currentStations, container);
            updateStatistics();
        }
        
        function updateStatistics() {
            const total = allStations.length;
            const filtered = currentStations.length;
            const counties = new Set(currentStations.map(s => s.county).filter(c => c)).size;
            
            let goodCount = 0, moderateCount = 0;
            currentStations.forEach(station => {
                const aqi = parseInt(station.aqi) || 0;
                if (aqi <= 50) goodCount++;
                else if (aqi <= 100) moderateCount++;
            });
            
            // ✅ 安全地設定所有統計元素
            const updateStat = (id, value) => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = value;
                } else {
                    console.warn(`⚠️ 找不到統計元素: ${id}`);
                }
            };
            
            updateStat('totalStations', total);
            updateStat('filteredStations', filtered);
            updateStat('countyCount', counties);
            updateStat('goodAqiCount', goodCount);
            updateStat('moderateAqiCount', moderateCount);
        }
        
        async function refreshData() {
            console.log('🔄 正在刷新資料...');
            await loadAirQualityData();
        }
        
        function showStationDetails(index) {
            if (index < 0 || index >= currentStations.length) return;
            const station = currentStations[index];
            
            // === 1. 資料讀取輔助函式 (優先讀取新欄位，若無則嘗試舊欄位) ===
            const getValue = (keys, digits = 1) => {
                if (!Array.isArray(keys)) keys = [keys];
                for (const key of keys) {
                    const val = station[key];
                    if (val !== undefined && val !== null && val !== '') {
                        // 如果是數字且需要小數點格式化
                        if (!isNaN(val) && digits !== null) {
                            return Number(val).toFixed(digits);
                        }
                        return val;
                    }
                }
                return '-';
            };

            // === 2. AQI 顏色判斷 ===
            // 嘗試讀取 AQI，有些 API 是 'AQI'，有些是 'aqi'
            const aqiVal = station.AQI || station.aqi || 0;
            const aqi = parseInt(aqiVal) || 0;
            
            let aqiColor = '#999';
            if (aqi > 0) {
                if (aqi <= 50) aqiColor = '#4CAF50';
                else if (aqi <= 100) aqiColor = '#FFEB3B';
                else if (aqi <= 150) aqiColor = '#FF9800';
                else if (aqi <= 200) aqiColor = '#F44336';
                else if (aqi <= 300) aqiColor = '#800080'; // 非常不健康
                else aqiColor = '#7e0023'; // 危害
            }

            // === 3. 填入 DOM ===
            const setText = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.textContent = val;
            };

            // 標題與時間
            setText('modalTitle', getValue(['SiteName', 'sitename']) || '未命名測站');
            setText('m-county', getValue(['County', 'county']));
            
            const timeStr = getValue(['DataCreationDate', 'publishtime', 'PublishTime'], null);
            setText('m-time', timeStr !== '-' ? new Date(timeStr).toLocaleString('zh-TW') : '更新中');

            // AQI 圓圈
            setText('m-aqi', aqi || '-');
            const circle = document.getElementById('m-aqi-bg');
            if (circle) {
                circle.style.background = aqiColor;
                circle.style.color = (aqi > 50 && aqi <= 100) ? '#333' : '#fff';
            }

            // === 污染物數據 (對應您提供的新欄位) ===
            
            // PM2.5
            setText('detailPM25', getValue(['PM2.5_conc', 'pm2_5', 'PM2.5']));
            setText('detailPM25Avg', getValue(['PM2.5_AVG_conc', 'pm25_avg', 'PM2.5_AVG']));

            // PM10
            setText('detailPM10', getValue(['PM10_conc', 'pm10', 'PM10'], 0));
            setText('detailPM10Avg', getValue(['PM10_AVG_conc', 'pm10_avg', 'PM10_AVG'], 0));

            // O3
            setText('detailO3', getValue(['O3_conc', 'o3', 'O3']));
            setText('detailO3Avg', getValue(['O3_8hr_conc', 'o3_avg', 'O3_8hr']));

            // CO (小數點 2 位)
            setText('detailCO', getValue(['CO_conc', 'co', 'CO'], 2));
            setText('detailCOAvg', getValue(['CO_8hr_conc', 'co_avg', 'CO_8hr'], 2));

            // SO2
            setText('detailSO2', getValue(['SO2_conc', 'so2', 'SO2']));
            setText('detailSO2Avg', getValue(['SO2_AVG_conc', 'so2_avg'], 1)); // 新增移動平均

            // NO 系列
            setText('detailNO2', getValue(['NO2_conc', 'no2', 'NO2']));
            setText('detailNOx', getValue(['NOx_conc', 'nox', 'NOx'])); // 新增
            setText('detailNO', getValue(['NO_conc', 'no', 'NO']));     // 新增

            // === 氣象資訊 ===
            setText('detailWindSpeed', getValue(['WindSpeed', 'wind_speed'], 1));
            setText('detailWindDirec', getValue(['WindDirec', 'wind_direc'], 0));

            // === 測站資訊 ===
            setText('detailSiteId', getValue(['SiteId', 'siteid']));
            setText('detailStatus', getValue(['Status', 'status']));
            setText('detailPollutant', getValue(['Pollutant', 'pollutant']) || '無');

            // 座標 (用於地圖定位)
            const lat = parseFloat(getValue(['Latitude', 'latitude', 'lat'], null));
            const lon = parseFloat(getValue(['Longitude', 'longitude', 'lon'], null));
            
            if (!isNaN(lat) && !isNaN(lon)) {
                setText('detailCoord', `${lat.toFixed(4)}, ${lon.toFixed(4)}`);
                // 更新全域變數供地圖定位使用
                currentTargetLat = lat;
                currentTargetLon = lon;
                const btn = document.getElementById('btnLocateMap');
                if(btn) btn.style.display = 'flex';
            } else {
                setText('detailCoord', '未知');
                const btn = document.getElementById('btnLocateMap');
                if(btn) btn.style.display = 'none';
            }

            // 顯示 Modal
            const modal = document.getElementById('detailsModal');
            if (modal) modal.classList.add('show');
        }
        
        function closeDetailsModal() {
            const modal = document.getElementById('detailsModal');
            if (modal) {
                modal.classList.remove('show');
            } else {
                console.warn('⚠️ 找不到模態窗口元素 "detailsModal"');
            }
        }
    </script>
    <!-- ✨ 引入外部腳本 -->
    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
</body>
</html>
