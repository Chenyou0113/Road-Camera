<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬è·¯ç›£è¦–å™¨ç¶œåˆ - TDX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/responsive-camera.css">
    <script>window.CURRENT_PAGE = 'combined';</script>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script src="assets/image-handler-simple.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #1e40af 0%, #0891b2 100%); min-height: 100vh; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #1e40af; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #1e40af; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .back-btn:hover { background: #0891b2; }
        .loading { text-align: center; padding: 50px; color: white; font-size: 1.2rem; }
        
        /* åœ°åœ–å’Œç›£è¦–å™¨åˆ—è¡¨å·¦å³ä½ˆå±€ */
        .cameras-map-wrapper { display: grid; grid-template-columns: 1fr 3fr; gap: 20px; margin: 20px 0; }
        
        .cameras-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        @media (max-width: 1400px) {
            .cameras-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 1200px) {
            .cameras-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .cameras-grid { grid-template-columns: 1fr; }
        }
        .camera-card { background: white; border-radius: 10px; padding: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.3s; overflow: hidden; }
        .camera-card:hover { transform: translateY(-5px); }
        .camera-info { padding: 15px; }
        .camera-info h3 { color: #1e40af; margin-bottom: 8px; font-size: 1.1rem; word-wrap: break-word; overflow-wrap: break-word; }
        .camera-info p { color: #666; margin: 4px 0; font-size: 0.9rem; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.5; }
        .camera-image { width: 100%; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .camera-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .camera-image:hover img { transform: scale(1.05); }
        .image-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .camera-image:hover .image-overlay { opacity: 1; }
        .stream-placeholder, .no-image-placeholder, .image-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { position: relative; margin: 2% auto; width: 90%; max-width: 1200px; }
        .close { position: absolute; top: 15px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1001; }
        .close:hover { color: #1e40af; }
        .modal-image { width: 100%; max-height: 80vh; object-fit: contain; }
        .modal-info { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .modal-info h2 { color: #1e40af; margin-bottom: 10px; }
        .modal-info p { color: #666; margin: 5px 0; word-wrap: break-word; overflow-wrap: break-word; }
        
        /* é¡å‹æ¨™ç±¤ */
        .type-badge { background: #1e40af; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; display: inline-block; margin: 2px; font-weight: bold; }
        .type-badge.highway { background: #1e40af; }
        .type-badge.expressway { background: #0891b2; }
        .type-badge.provincial { background: #14b8a6; }
        
        .stats-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: bold; color: #1e40af; }
        .stat-label { color: #666; margin-top: 5px; }
        
        /* ç¯©é¸å€åŸŸ */
        .filter-section { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 5px; font-weight: bold; color: #333; }
        .filter-group select, .filter-group button { padding: 10px; border-radius: 5px; border: 2px solid #1e40af; font-size: 1rem; }
        .filter-group button { background: #1e40af; color: white; cursor: pointer; }
        .filter-group button:hover { background: #0891b2; }
        
        /* åœ°åœ–å®¹å™¨ */
        #map {
            width: 100%;
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 0;
            z-index: 1;
        }
        
        .map-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .map-section h3 {
            color: #1e40af;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* åˆ†é  */
        .pagination { display: flex; justify-content: center; align-items: center; margin: 20px 0; gap: 10px; }
        .pagination button { padding: 10px 15px; border: none; background: white; color: #1e40af; border-radius: 5px; cursor: pointer; }
        .pagination button:hover, .pagination button.active { background: #1e40af; color: white; }
        .pagination button:disabled { background: #ccc; cursor: not-allowed; }
        .pagination span { color: white; font-weight: bold; padding: 10px 15px; }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„åˆ†é æ¨£å¼ */
        body.dark-mode .pagination button { background: rgba(255,255,255,0.1); color: #66BB6A; border: 1px solid rgba(255,255,255,0.2); }
        body.dark-mode .pagination button:hover, body.dark-mode .pagination button.active { background: #66BB6A; color: #1a1a2e; }
        body.dark-mode .pagination button:disabled { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.3); }
        body.dark-mode .pagination span { color: #66BB6A; }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„ç¯©é¸å€åŸŸå’Œçµ±è¨ˆé¢æ¿æ¨£å¼ */
        body.dark-mode .filter-section { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .filter-section h3 { color: #66BB6A; }
        body.dark-mode .filter-group label { color: rgba(255,255,255,0.9); }
        body.dark-mode .filter-group select { background: rgba(255,255,255,0.1); color: white; border-color: #66BB6A; }
        body.dark-mode .filter-group select option { background: #2a2a3e; color: white; }
        body.dark-mode .filter-group button { background: #66BB6A; color: #1a1a2e; border-color: #66BB6A; }
        body.dark-mode .filter-group button:hover { background: #81C784; }
        body.dark-mode .stat-card { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .stat-number { color: #66BB6A; }
        body.dark-mode .stat-label { color: rgba(255,255,255,0.7); }
        body.dark-mode #infoPanel { background: rgba(40,40,50,0.95); border-left-color: #66BB6A; }
        body.dark-mode #infoPanel h3 { color: #66BB6A; }
        body.dark-mode #infoContent { color: rgba(255,255,255,0.8); }
        body.dark-mode #infoContent a { color: #66BB6A; }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„ç™½è‰²èƒŒæ™¯å…ƒç´  */
        body.dark-mode .header { background: linear-gradient(135deg, rgba(30,30,40,0.95) 0%, rgba(25,25,35,0.95) 100%); border-bottom: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .header h1 { color: #66BB6A; }
        body.dark-mode .camera-card { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(35,35,45,0.95) 100%); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        body.dark-mode .camera-info h3 { color: #66BB6A; }
        body.dark-mode .camera-info p { color: rgba(255,255,255,0.7); }
        body.dark-mode .camera-image { background: rgba(20,20,30,0.6); }
        body.dark-mode .stream-placeholder, body.dark-mode .no-image-placeholder, body.dark-mode .image-placeholder { background: rgba(20,20,30,0.8); color: rgba(255,255,255,0.5); }
        body.dark-mode .modal-info { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(35,35,45,0.95) 100%); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .modal-info h2 { color: #66BB6A; }
        body.dark-mode .modal-info p { color: rgba(255,255,255,0.8); }
        body.dark-mode .map-section { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(35,35,45,0.95) 100%); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        body.dark-mode .map-section h3 { color: #66BB6A; }
        body.dark-mode .back-btn { background: #66BB6A; color: #1a1a2e; }
        body.dark-mode .back-btn:hover { background: #81C784; }
        
        /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼å„ªåŒ– */
        @media (max-width: 768px) {
            .cameras-map-wrapper { grid-template-columns: 1fr; }
            .camera-info { padding: 12px; }
            .camera-info h3 { font-size: 1rem; }
            .camera-info p { font-size: 0.85rem; }
            .filter-row { flex-direction: column; align-items: stretch; }
            .stats-panel { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 480px) {
            .stats-panel { grid-template-columns: 1fr; }
        }
    </style>
    
    <!-- è¼‰å…¥é€²åº¦æ¢ -->
    <script src="assets/loading-progress.js"></script>
    <script>
        // å…¬è·¯ç›£è¦–å™¨ç¶œåˆè¼‰å…¥è¨­å®š
        window.AUTO_START_LOADING = false; // æ‰‹å‹•æ§åˆ¶
        
        window.addEventListener('DOMContentLoaded', () => {
            window.startLoading({
                labelText: 'è¼‰å…¥å…¬è·¯ç›£è¦–å™¨...',
                color: '#1e40af',
                showLabel: true
            });
        });
    </script>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-road"></i> å…¬è·¯ç›£è¦–å™¨ç¶œåˆ</h1>
            <p style="text-align: center; color: #666;">åœ‹é“ã€å¿«é€Ÿå…¬è·¯ã€çœé“çµ±ä¸€ç›£æ§å¹³å°</p>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é </a>
        <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode" style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; cursor: pointer; margin-left: 15px; font-size: 1.2rem;">
            <i class="fas fa-moon"></i>
        </button>
        
        <!-- å…¬è·¯ç›£è¦–å™¨èªªæ˜ -->
        <div id="infoPanel" style="background: #e8f5e8; border-left: 4px solid #1e40af; padding: 20px; margin: 20px 0; border-radius: 8px; transition: all 0.3s ease;">
            <h3 style="color: #0891b2; margin: 0 0 15px 0; display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleInfoPanel()">
                <span>
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    TDX å…¬è·¯ç›£è¦–å™¨ç¶œåˆæœå‹™èªªæ˜
                </span>
                <i id="toggleIcon" class="fas fa-chevron-up" style="transition: transform 0.3s ease;"></i>
            </h3>
            <div id="infoContent" style="color: #333; line-height: 1.6;">
                <p style="margin: 0 0 10px 0;">
                    æœ¬ç³»çµ±æ•´åˆäº¤é€šéƒ¨ TDX äº¤é€šè³‡æ–™æµé€šæœå‹™å¹³å°æä¾›çš„åœ‹é“ã€å¿«é€Ÿå…¬è·¯ã€çœé“ç›£è¦–å™¨è³‡æ–™ï¼Œè®“ä½¿ç”¨è€…åœ¨çµ±ä¸€å¹³å°æŸ¥çœ‹å…¨åœ‹å…¬è·¯ç›£è¦–å™¨å½±åƒã€‚
                </p>
                
                <div style="margin: 15px 0;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">ğŸ›£ï¸ ç›£æ§é¡å‹ï¼š</p>
                    <div style="margin-left: 20px;">
                        <p style="margin: 5px 0;">
                            â€¢ <span class="type-badge highway">åœ‹é“</span> - åœ‹é“ 1ã€3ã€5 è™ŸåŠå„äº¤æµé“
                        </p>
                        <p style="margin: 5px 0;">
                            â€¢ <span class="type-badge expressway">å¿«é€Ÿé“è·¯</span> - è¥¿æ¿±ã€å°61ã€å°64ã€å°65ã€å°66ã€å°74ã€å°86ç­‰å¿«é€Ÿé“è·¯
                        </p>
                        <p style="margin: 5px 0;">
                            â€¢ <span class="type-badge provincial">çœé“</span> - å°1ã€å°3ã€å°9ã€å°11ç­‰ä¸»è¦çœé“
                        </p>
                    </div>
                </div>
                
                <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: #666;">
                    ğŸ“Š æœ¬ç³»çµ±æä¾›å³æ™‚è·¯æ³ç›£æ§ã€åœ°ç†ä½ç½®æ¨™è¨˜ã€å¤šæ¢ä»¶ç¯©é¸ç­‰åŠŸèƒ½ã€‚
                </p>
            </div>
        </div>

        <!-- çµ±è¨ˆé¢æ¿ -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-number" id="totalCameras">0</div>
                <div class="stat-label">ç›£è¦–å™¨ç¸½æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highwayCameras">0</div>
                <div class="stat-label">åœ‹é“ç›£è¦–å™¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expresswayCameras">0</div>
                <div class="stat-label">å¿«é€Ÿé“è·¯ç›£è¦–å™¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="provincialCameras">0</div>
                <div class="stat-label">çœé“ç›£è¦–å™¨</div>
            </div>
        </div>

        <!-- ç¯©é¸å€åŸŸ -->
        <div class="filter-section">
            <h3 style="color: #1e40af; margin-bottom: 15px;"><i class="fas fa-filter"></i> ç¯©é¸å…¬è·¯ç›£è¦–å™¨</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="typeSelect">é“è·¯é¡å‹</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #1e40af; font-size: 1rem;" id="typeSelect" onchange="applyFilters('type')">
                        <option value="">æ‰€æœ‰é¡å‹</option>
                        <option value="highway">åœ‹é“</option>
                        <option value="expressway">å¿«é€Ÿé“è·¯</option>
                        <option value="provincial">çœé“</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="citySelect">ç¸£å¸‚</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #1e40af; font-size: 1rem;" id="citySelect" onchange="applyFilters('city')">
                        <option value="">æ‰€æœ‰ç¸£å¸‚</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button onclick="resetFilters()"><i class="fas fa-refresh"></i> é‡ç½®ç¯©é¸</button>
                </div>
            </div>
        </div>

        <!-- åœ°åœ–å’Œç›£è¦–å™¨åˆ—è¡¨ä¸¦æ’å¸ƒå±€ -->
        <div class="cameras-map-wrapper">
            <!-- å·¦å´ï¼šåœ°åœ–å®šä½ -->
            <div class="map-section">
                <h3><i class="fas fa-map"></i> ç›£è¦–å™¨åœ°ç†åˆ†ä½ˆåœ–</h3>
                <div id="map"></div>
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                    ğŸ’¡ æç¤ºï¼šé»æ“Šåœ°åœ–ä¸Šçš„æ¨™è¨˜å¯æŸ¥çœ‹ç›£è¦–å™¨è©³ç´°è³‡è¨Šå’Œåæ¨™ä½ç½®
                </p>
            </div>

            <!-- å³å´ï¼šç›£è¦–å™¨å¡ç‰‡åˆ—è¡¨ -->
            <div id="cameras-container" class="loading">
                <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥å…¬è·¯ç›£è¦–å™¨è³‡æ–™ä¸­...
            </div>
        </div>

        <!-- åˆ†é  -->
        <div id="pagination" class="pagination" style="display: none;">
            <button onclick="changePage(-1)" id="prevBtn"><i class="fas fa-chevron-left"></i> ä¸Šä¸€é </button>
            <span id="pageInfo">ç¬¬ 1 é ï¼Œå…± 1 é </span>
            <button onclick="changePage(1)" id="nextBtn">ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- å½±åƒå½ˆçª— -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeImageModal()">&times;</span>
            <div id="modalImageContainer" style="text-align: center;">
                <img id="modalImage" class="modal-image" alt="ç›£è¦–å™¨å½±åƒ">
            </div>
            <div class="modal-info">
                <h2 id="modalTitle">ç›£è¦–å™¨è³‡è¨Š</h2>
                <p id="modalInfo"></p>
            </div>
        </div>
    </div>

    <script src="assets/dark-mode.js"></script>
    <script src="assets/camera-map-manager.js"></script>
    <script>
        console.log('ğŸ”„ é–‹å§‹è¼‰å…¥å…¬è·¯ç›£è¦–å™¨ç¶œåˆé é¢...');
        
        // é é¢è³‡æ–™
        const ITEMS_PER_PAGE = 12;
        let allCameras = [];
        let filteredCameras = [];
        let currentPage = 1;
        let cameraMap = null;
        let markers = [];

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            console.log('ğŸ—ºï¸ åˆå§‹åŒ–åœ°åœ–...');
            cameraMap = new CameraMapManager('map', {
                center: [23.97, 120.97],
                zoom: 7
            });
        }

        // è¼‰å…¥æ‰€æœ‰ç›£è¦–å™¨è³‡æ–™
        async function loadAllCameras() {
            try {
                console.log('ğŸ“¡ é–‹å§‹è¼‰å…¥ç›£è¦–å™¨è³‡æ–™...');
                
                // ä¸¦è¡Œè¼‰å…¥ä¸‰å€‹ä¾†æºçš„æ•¸æ“š
                const [highways, expressways, provincial] = await Promise.all([
                    TDXClient.getHighwayCamera(),
                    TDXClient.getExpresswayCamera(),
                    TDXClient.getProvincialCamera()
                ]);

                console.log(`âœ… åœ‹é“ç›£è¦–å™¨: ${highways.length} å€‹`);
                console.log(`âœ… å¿«é€Ÿé“è·¯ç›£è¦–å™¨: ${expressways.length} å€‹`);
                console.log(`âœ… çœé“ç›£è¦–å™¨: ${provincial.length} å€‹`);

                // æ¨™è¨˜è³‡æ–™ä¾†æºä¸¦åˆä½µ
                const markedHighways = (highways || []).map(cam => ({
                    ...cam,
                    type: 'highway',
                    typeName: 'åœ‹é“'
                }));
                
                const markedExpressways = (expressways || []).map(cam => ({
                    ...cam,
                    type: 'expressway',
                    typeName: 'å¿«é€Ÿé“è·¯'
                }));
                
                const markedProvincial = (provincial || []).map(cam => ({
                    ...cam,
                    type: 'provincial',
                    typeName: 'çœé“'
                }));

                allCameras = [...markedHighways, ...markedExpressways, ...markedProvincial];
                console.log(`âœ… ç¸½å…±è¼‰å…¥ ${allCameras.length} å€‹ç›£è¦–å™¨`);

                // å¡«å……ç¯©é¸é¸å–®
                populateFilters();

                // é¡¯ç¤ºæ‰€æœ‰ç›£è¦–å™¨
                filteredCameras = [...allCameras];
                displayCameras();
                updateStats();

                // æ·»åŠ æ¨™è¨˜åˆ°åœ°åœ–
                addMarkersToMap();

                window.finishLoading();
            } catch (error) {
                console.error('âŒ è¼‰å…¥ç›£è¦–å™¨è³‡æ–™å¤±æ•—:', error);
                document.getElementById('cameras-container').innerHTML = 
                    `<div class="loading" style="color: red;">
                        <i class="fas fa-exclamation-circle"></i> è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦
                    </div>`;
                window.finishLoading();
            }
        }

        // å¡«å……ç¯©é¸ä¸‹æ‹‰é¸å–®
        function populateFilters() {
            console.log('ğŸ”„ é–‹å§‹å¡«å……ç¯©é¸ä¸‹æ‹‰é¸å–®...');
            
            // å¡«å……ç¸£å¸‚é¸å–® - å¾æ‰€æœ‰æ”åƒé ­ä¸­æå–å”¯ä¸€åŸå¸‚
            const allCities = new Set();
            allCameras.forEach(cam => {
                if (cam.LocationCityName) {
                    allCities.add(cam.LocationCityName);
                }
            });

            const sortedCities = Array.from(allCities).sort();
            const citySelect = document.getElementById('citySelect');
            sortedCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });

            console.log(`âœ… ç¸£å¸‚ç¯©é¸å·²å¡«å…… - å…± ${sortedCities.length} å€‹ç¸£å¸‚`);
            console.log('âœ… æ‰€æœ‰ç¯©é¸ä¸‹æ‹‰é¸å–®å·²å®Œæˆåˆå§‹åŒ–');
        }

        // æ›´æ–°çµ±è¨ˆæ•¸å­—
        function updateStats() {
            console.log('ğŸ“Š æ›´æ–°çµ±è¨ˆè³‡è¨Š...');
            
            const highwayCount = filteredCameras.filter(c => c.type === 'highway').length;
            const expresswayCount = filteredCameras.filter(c => c.type === 'expressway').length;
            const provincialCount = filteredCameras.filter(c => c.type === 'provincial').length;

            document.getElementById('totalCameras').textContent = filteredCameras.length;
            document.getElementById('highwayCameras').textContent = highwayCount;
            document.getElementById('expresswayCameras').textContent = expresswayCount;
            document.getElementById('provincialCameras').textContent = provincialCount;
        }

        // æ‡‰ç”¨ç¯©é¸
        function applyFilters(filterType) {
            console.log(`ğŸ” æ‡‰ç”¨ç¯©é¸: ${filterType}`);
            
            const typeSelect = document.getElementById('typeSelect');
            const citySelect = document.getElementById('citySelect');
            
            const selectedType = typeSelect.value;
            const selectedCity = citySelect.value;

            filteredCameras = allCameras.filter(cam => {
                const typeMatch = !selectedType || cam.type === selectedType;
                const cityMatch = !selectedCity || cam.LocationCityName === selectedCity;
                return typeMatch && cityMatch;
            });

            currentPage = 1;
            displayCameras();
            updateStats();
            updateMarkersVisibility();
            
            console.log(`âœ… ç¯©é¸çµæœ: ${filteredCameras.length} å€‹ç›£è¦–å™¨`);
        }

        // é¡¯ç¤ºç›£è¦–å™¨å¡ç‰‡
        function displayCameras() {
            console.log(`ğŸ“„ é¡¯ç¤ºç¬¬ ${currentPage} é ç›£è¦–å™¨...`);
            
            const container = document.getElementById('cameras-container');
            
            if (filteredCameras.length === 0) {
                container.innerHTML = '<div class="loading">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç›£è¦–å™¨</div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            const totalPages = Math.ceil(filteredCameras.length / ITEMS_PER_PAGE);
            const startIdx = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIdx = Math.min(startIdx + ITEMS_PER_PAGE, filteredCameras.length);
            const pageCameras = filteredCameras.slice(startIdx, endIdx);

            let html = '<div class="cameras-grid">';
            pageCameras.forEach(cam => {
                const imageUrl = window.getCameraImageUrl(cam);
                const typeBadgeClass = `type-badge ${cam.type}`;
                const description = cam.Description || cam.LocationAreaName || '';
                
                html += `
                    <div class="camera-card">
                        <div class="camera-image" onclick="showImageModal('${imageUrl}', '${cam.Name}', '${cam.type}', '${description}', '${cam.LocationCityName}')">
                            ${imageUrl ? `<img src="${imageUrl}" alt="${cam.Name}">` : '<div class="no-image-placeholder"><i class="fas fa-image"></i><p>ç„¡å½±åƒ</p></div>'}
                            <div class="image-overlay">
                                <i class="fas fa-search-plus"></i> é»æ“ŠæŸ¥çœ‹
                            </div>
                        </div>
                        <div class="camera-info">
                            <h3>${cam.Name}</h3>
                            <p><span class="${typeBadgeClass}">${cam.typeName}</span></p>
                            <p><i class="fas fa-map-marker-alt"></i> ${cam.LocationCityName}</p>
                            <p style="font-size: 0.85rem; color: #888;">${description}</p>
                            ${cam.LocationPoint ? `<p style="font-size: 0.8rem; color: #999;">ğŸ“ ${cam.LocationPoint.Latitude?.toFixed(4)}, ${cam.LocationPoint.Longitude?.toFixed(4)}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;

            // æ›´æ–°åˆ†é 
            updatePagination(totalPages);
        }

        // æ›´æ–°åˆ†é æ§åˆ¶
        function updatePagination(totalPages) {
            const paginationDiv = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            
            pageInfo.textContent = `ç¬¬ ${currentPage} é ï¼Œå…± ${totalPages} é `;
            
            if (totalPages > 1) {
                paginationDiv.style.display = 'flex';
                document.getElementById('prevBtn').disabled = currentPage === 1;
                document.getElementById('nextBtn').disabled = currentPage === totalPages;
            } else {
                paginationDiv.style.display = 'none';
            }
        }

        // æ›´æ”¹é ç¢¼
        function changePage(direction) {
            const totalPages = Math.ceil(filteredCameras.length / ITEMS_PER_PAGE);
            const newPage = currentPage + direction;
            
            if (newPage > 0 && newPage <= totalPages) {
                currentPage = newPage;
                displayCameras();
                window.scrollTo(0, 0);
            }
        }

        // é‡ç½®ç¯©é¸
        function resetFilters() {
            console.log('ğŸ”„ é‡ç½®ç¯©é¸...');
            document.getElementById('typeSelect').value = '';
            document.getElementById('citySelect').value = '';
            filteredCameras = [...allCameras];
            currentPage = 1;
            displayCameras();
            updateStats();
            updateMarkersVisibility();
            console.log('âœ… ç¯©é¸å·²é‡ç½®');
        }

        // æ–°å¢æ¨™è¨˜åˆ°åœ°åœ–
        function addMarkersToMap() {
            console.log(`ğŸ“ æ·»åŠ  ${allCameras.length} å€‹æ¨™è¨˜åˆ°åœ°åœ–...`);
            
            allCameras.forEach(cam => {
                if (cam.LocationPoint) {
                    const icon = getMarkerIcon(cam.type);
                    cameraMap.addMarker(
                        [cam.LocationPoint.Latitude, cam.LocationPoint.Longitude],
                        cam.Name,
                        {
                            icon: icon,
                            type: cam.type,
                            city: cam.LocationCityName,
                            description: cam.Description || cam.LocationAreaName || ''
                        },
                        () => {
                            showImageModal(
                                window.getCameraImageUrl(cam),
                                cam.Name,
                                cam.type,
                                cam.Description || cam.LocationAreaName || '',
                                cam.LocationCityName
                            );
                        }
                    );
                }
            });
        }

        // å–å¾—æ¨™è¨˜åœ–æ¨™
        function getMarkerIcon(type) {
            const colors = {
                'highway': '#1e40af',
                'expressway': '#0891b2',
                'provincial': '#14b8a6'
            };
            const color = colors[type] || '#1e40af';
            
            return L.divIcon({
                html: `<div style="background: ${color}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                    <i class="fas fa-video"></i>
                </div>`,
                className: 'custom-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
        }

        // æ›´æ–°æ¨™è¨˜å¯è¦‹æ€§
        function updateMarkersVisibility() {
            if (!cameraMap) return;
            
            const visibleIds = new Set(filteredCameras.map(c => c.Name));
            cameraMap.updateMarkersVisibility((markerData) => {
                return visibleIds.has(markerData.title);
            });
        }

        // é¡¯ç¤ºå½±åƒå½ˆçª—
        function showImageModal(imageUrl, name, type, description, city) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalInfo = document.getElementById('modalInfo');
            
            if (!imageUrl) {
                return;
            }

            const typeNames = {
                'highway': 'åœ‹é“',
                'expressway': 'å¿«é€Ÿé“è·¯',
                'provincial': 'çœé“'
            };

            modalImage.src = imageUrl;
            modalTitle.textContent = name;
            modalInfo.innerHTML = `
                <p><strong>é¡å‹ï¼š</strong> ${typeNames[type] || type}</p>
                <p><strong>ç¸£å¸‚ï¼š</strong> ${city}</p>
                <p><strong>ä½ç½®ï¼š</strong> ${description || 'æœªæä¾›'}</p>
            `;
            
            modal.style.display = 'block';
        }

        // é—œé–‰å½±åƒå½ˆçª—
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // åˆ‡æ›è³‡è¨Šé¢æ¿
        function toggleInfoPanel() {
            const infoContent = document.getElementById('infoContent');
            const toggleIcon = document.getElementById('toggleIcon');
            
            infoContent.style.display = infoContent.style.display === 'none' ? 'block' : 'none';
            toggleIcon.style.transform = infoContent.style.display === 'none' ? 'rotate(0deg)' : 'rotate(180deg)';
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // é é¢è¼‰å…¥å®Œæˆ
        window.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadAllCameras();
        });
    </script>
</body>
</html>
