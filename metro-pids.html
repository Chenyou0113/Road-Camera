<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro PIDS - TPASS 2.0 Edition</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&family=Roboto:wght@700;900&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --theme-color: #8246af; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
        body { background-color: #000; height: 100vh; width: 100vw; display: flex; overflow: hidden; }
        
        .pids-wrapper { display: grid; grid-template-columns: 24% 76%; grid-template-rows: 90% 10%; width: 100%; height: 100%; background-color: #f0f0f0; }
        
        .sidebar { display: flex; flex-direction: column; border-right: 2px solid #ccc; background-color: #fff; height: 100%; overflow: hidden; }
        .station-header { height: 10%; min-height: 60px; background-color: var(--theme-color); color: white; display: flex; align-items: center; padding: 0 15px; gap: 12px; }
        .st-badge { background: #fff; color: var(--theme-color); font-weight: 900; padding: 4px 10px; border-radius: 6px; font-size: 1.4vw; }
        .st-name-zh { font-size: 1.8vw; font-weight: 900; }

        .arrival-info { flex: 1; padding: 1vh 1vw; display: flex; flex-direction: column; border-bottom: 2px solid #eee; justify-content: center; }
        .arrival-info.secondary { background-color: #fcfcfc; }
        .dir-label { font-size: 0.9vw; font-weight: 900; color: #555; margin-bottom: 2px; }
        .line-tag-row { display: flex; align-items: center; gap: 8px; }
        .line-badge-small { background: var(--theme-color); color: white; padding: 2px 8px; border-radius: 4px; font-size: 1vw; font-weight: 900; min-width: 45px; text-align: center; }
        
        .dest-zh { font-size: 2.2vw; font-weight: 900; color: #000; line-height: 1.2; }
        .dest-en { font-size: 0.8vw; color: #888; }
        
        /* --- æ™‚é–“æ¡†æ¨£å¼å„ªåŒ– --- */
        .time-box { 
            background-color: var(--theme-color); 
            color: white; 
            margin-top: 5px; 
            text-align: center; 
            font-size: 3.5vw; 
            font-weight: 700; 
            border-radius: 8px; 
            padding: 0.5vh 0; 
            font-family: 'Roboto', sans-serif; 
            width: 95%; 
            align-self: center; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2); 
            transition: 0.3s;
            /* ç¢ºä¿æ–‡å­—å‚ç›´ç½®ä¸­ */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 6vh; 
        }
        .time-box.arriving { background-color: #d32f2f; animation: pulse 1s infinite; }
        .time-box.approaching { background-color: #f58220; }
        
        /* ğŸ”¥ æœ«ç­è»Šå·²é§›é›¢ (å­—é«”ç¸®å°ä»¥å¡å…¥æ¡†å…§) */
        .time-box.end-service {
            font-size: 1.8vw; /* ç¸®å°å­—é«” */
            background-color: #444; /* æ·±ç°åº•è‰² */
            font-family: 'Noto Sans TC', sans-serif; /* æ”¹å›ä¸­æ–‡é«” */
            padding: 0 10px;
        }

        .weather-box { height: 18%; background: #fff; border-top: 2px solid #ccc; display: grid; grid-template-columns: 1fr 2.5fr; grid-template-rows: 1fr 1fr; align-items: stretch; }
        .w-icon-area { grid-row: 1 / span 2; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; background: #f4f7f9; border-right: 1px solid #eee; }
        .w-icon-large { font-size: 4vw; color: #607d8b; }
        .w-desc { font-size: 1.3vw; font-weight: 700; color: #555; }
        .w-top-info { display: flex; justify-content: center; align-items: center; padding: 0 1vw; border-bottom: 1px solid #eee; }
        .w-bottom-info { display: flex; justify-content: center; align-items: center; padding: 0 1vw; }
        .w-range-text { font-size: 2vw; font-weight: 900; color: #d32f2f; }
        .w-rain-text { font-size: 2vw; font-weight: 900; color: #5a9fd4; }

        .main-display { display: grid; grid-template-rows: 1fr 130px; background-color: #000; position: relative; }
        .video-container { width: 100%; height: 100%; position: relative; overflow: hidden; background: #000; }
        #video-iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; transform: scale(1.01); }
        
        /* æ“æ“ åº¦é¡¯ç¤ºå€ */
        .congestion-area { 
            background: #fff; 
            border-top: 2px solid #ccc; 
            padding: 10px 25px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            min-height: 80px; /* ç¢ºä¿æœ€å°é«˜åº¦ */
        }
        .cong-row { display: flex; align-items: center; gap: 15px; margin-bottom: 8px; }
        .cong-row:last-child { margin-bottom: 0; }
        .cong-label { font-size: 1.1vw; font-weight: 900; color: #333; width: 180px; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        .cong-bar-container { flex: 1; display: flex; gap: 4px; height: 20px; background: #e2e8f0; padding: 2px; border-radius: 4px; }
        .cong-car { flex: 1; background-color: #cbd5e1; border-radius: 2px; transition: 0.3s; }
        .cong-lvl-1 { background-color: #32b900; box-shadow: 0 0 5px #32b90080; }
        .cong-lvl-2 { background-color: #ffcc00; box-shadow: 0 0 5px #ffcc0080; }
        .cong-lvl-3 { background-color: #f58220; box-shadow: 0 0 5px #f5822080; }
        .cong-lvl-4 { background-color: #d32f2f; box-shadow: 0 0 5px #d32f2f80; }
        .cong-no-data { color: #94a3b8; font-size: 1vw; font-weight: 700; text-align: center; width: 100%; }

        .footer { grid-column: 1/3; display: grid; grid-template-columns: 24% 76%; background: #1a1a1a; color: #fff; }
        .clock-section { background: #d32f2f; display: flex; justify-content: center; align-items: center; font-size: 1.6vw; font-weight: 900; font-family: 'Roboto', sans-serif; }
        .marquee-section { overflow: hidden; display: flex; align-items: center; padding: 0 20px; }
        .marquee-text { white-space: nowrap; font-size: 1.7vw; animation: scroll 40s linear infinite; font-weight: 700; }

        @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>

    <div class="pids-wrapper">
        <div class="sidebar">
            <div class="station-header" id="ui-header">
                <div class="st-badge" id="ui-st-id">--</div>
                <div class="st-name-zh" id="ui-st-name">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="arrival-info" id="block-dir0">
                <div class="dir-label">ç¬¬ä¸€æœˆå° Platform 1</div>
                <div class="line-tag-row">
                    <div class="line-badge-small" id="ui-line-tag-1"></div>
                    <div class="dest-zh" id="dir0-dest">--</div>
                </div>
                <div class="dest-en" id="dir0-en"></div>
                <!-- é€™è£¡çš„æ™‚é–“æ¡†æœƒç”¨ä¾†é¡¯ç¤ºã€Œæœ«ç­è»Šå·²é§›é›¢ã€ -->
                <div class="time-box" id="dir0-time">-- : --</div>
            </div>

            <div class="arrival-info secondary" id="block-dir1">
                <div class="dir-label">ç¬¬äºŒæœˆå° Platform 2</div>
                <div class="line-tag-row">
                    <div class="line-badge-small" id="ui-line-tag-2"></div>
                    <div class="dest-zh" id="dir1-dest">--</div>
                </div>
                <div class="dest-en" id="dir1-en"></div>
                <div class="time-box" id="dir1-time">-- : --</div>
            </div>

            <div class="weather-box">
                <div class="w-icon-area">
                    <div class="w-icon-large" id="ui-weather-icon"><i class="fas fa-cloud-sun"></i></div>
                    <div class="w-desc" id="ui-weather-text">--</div>
                </div>
                <div class="w-top-info"><span class="w-range-text" id="ui-range-display">--Â°C ~ --Â°C</span></div>
                <div class="w-bottom-info"><span class="w-rain-text" id="ui-rain-display"><i class="fas fa-umbrella"></i> --%</span></div>
            </div>
        </div>

        <div class="main-display">
            <div class="video-container">
                <iframe id="video-iframe" 
                    src="https://www.youtube.com/embed/Y_siE2Wsp38?autoplay=1&mute=1&loop=1&playlist=Y_siE2Wsp38&controls=0&modestbranding=1&rel=0" 
                    allow="autoplay; encrypted-media">
                </iframe>
            </div>
            <div class="congestion-area"></div>
        </div>

        <div class="footer">
            <div class="clock-section" id="clock">00:00</div>
            <div class="marquee-section">
                <div class="marquee-text" id="ui-marquee">TPASS 2.0 å…¬é‹å¸¸å®¢å„ªæƒ æ­£å¼ä¸Šç·šï¼æ­è¶Šå¤šå›é¥‹è¶Šå¤š...</div>
            </div>
        </div>
    </div>

    <script>
        const METRO_STATIONS = fetch('metro-stations-raw.json').then(r => r.json()).catch(() => null);
        
        // ğŸš¨ é€™æ˜¯ TDX Worker (çµ¦éåŒ—æ·ç³»çµ±ç”¨)
        const METRO_API_TDX = 'https://metro-api-worker.xiaoyouwu5-fd3.workers.dev/api';
        
        // ğŸ”¥ é€™æ˜¯æ‚¨æ–°éƒ¨ç½²çš„ TRTC å°ˆå±¬ Worker (æ³¨æ„ï¼šå»æ‰äº† /api)
        const METRO_API_TRTC = 'https://trtc-metro-api.xiaoyouwu5-fd3.workers.dev';
        
        const WEATHER_API = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev';

        const params = new URLSearchParams(window.location.search);
        const system = params.get('sys') || params.get('system') || 'TYMC';
        const station = params.get('sid') || params.get('station') || 'A8';

        let countdownSecs = { dir0: -1, dir1: -1 };
        const sysColors = { 'TRTC': '#0070bd', 'KRTC': '#f58220', 'TYMC': '#8246af', 'TMRT': '#b2d235', 'NTMC': '#0096cc', 'KLRT': '#008010' };

        function updateClock() {
            const n = new Date();
            const d = `${String(n.getMonth()+1).padStart(2,'0')}/${String(n.getDate()).padStart(2,'0')}`;
            const t = n.toLocaleTimeString('en-US', {hour12:true, hour:'2-digit', minute:'2-digit'}).toUpperCase();
            document.getElementById('clock').innerText = `${d} ${t}`;
        }

        async function init() {
            document.documentElement.style.setProperty('--theme-color', sysColors[system] || '#333');
            document.getElementById('ui-st-id').innerText = station;
            
            Promise.allSettled([
                METRO_STATIONS.then(data => {
                    if (data?.systems[system]?.stations[station]) {
                        const st = data.systems[system].stations[station];
                        document.getElementById('ui-st-name').innerText = st.name;
                        const ln = data.systems[system].lines[st.lineId];
                        if (ln?.color) document.documentElement.style.setProperty('--theme-color', ln.color);
                    }
                }),
                updateData(),
                updateWeather(),
                updateMarquee()
            ]);

            setInterval(updateData, 15000);
            setInterval(updateWeather, 600000);
            setInterval(updateMarquee, 300000);
            updateClock();
            setInterval(updateClock, 1000);

            setInterval(() => {
                [0, 1].forEach(i => {
                    if(countdownSecs[`dir${i}`] > 0) {
                        countdownSecs[`dir${i}`]--;
                        renderTime(i);
                    }
                });
            }, 1000);
        }

        function getOfflineStatus() {
            const h = new Date().getHours();
            const isLateNight = (h >= 23 || h < 6);
            if (isLateNight) {
                return {
                    destZh: "ç‡Ÿé‹çµæŸ", destEn: "Service Ended",
                    timeText: "æœ«ç­è»Šå·²é§›é›¢", timeClass: "time-box end-service"
                };
            }
            return {
                destZh: "æš«ç„¡åˆ—è»Š", destEn: "No Service",
                timeText: "-- : --", timeClass: "time-box"
            };
        }

        async function updateData() {
            try {
                let nextTrains = [null, null];

                // --- 1. åŒ—æ· (TRTC) å°ˆç”¨é‚è¼¯ ---
                if (system === 'TRTC') {
                    nextTrains = await fetchTRTCData();
                } 
                // --- 2. å…¶ä»–æ·é‹ (TDX) é‚è¼¯ ---
                else {
                    const res = await fetch(`${METRO_API_TDX}/liveboard?sys=${system}&sid=${station.toUpperCase()}`);
                    const sData = await res.json();
                    
                    if (sData && sData.length > 0) {
                        if (system === 'TYMC') {
                            const toTaipei = sData.find(t => t.DestinationStationName.Zh_tw.includes('å°åŒ—è»Šç«™'));
                            const toSouth = sData.find(t => !t.DestinationStationName.Zh_tw.includes('å°åŒ—è»Šç«™'));
                            nextTrains = [toSouth, toTaipei];
                        } else if (system === 'KLRT') {
                            nextTrains = [sData[0], sData.length > 1 ? sData[1] : null];
                        } else {
                            const dests = [...new Set(sData.map(item => item.DestinationStationName.Zh_tw))];
                            if (dests.length >= 2) {
                                nextTrains[0] = sData.find(t => t.DestinationStationName.Zh_tw === dests[0]);
                                nextTrains[1] = sData.find(t => t.DestinationStationName.Zh_tw === dests[1]);
                            } else {
                                nextTrains[0] = sData[0];
                                nextTrains[1] = sData.length > 1 ? sData[1] : null;
                            }
                        }
                    }
                }

                updateUI(0, nextTrains[0]);
                updateUI(1, nextTrains[1]);
                updateCongestion(nextTrains);

            } catch(e) { 
                console.error("Fetch Data Error:", e);
                setOfflineUI(0); setOfflineUI(1);
            }
        }

        // ğŸ”¥ å°ˆé–€è™•ç† TRTC è³‡æ–™ (å«æ™ºæ…§åˆ†æµ)
        async function fetchTRTCData() {
            const res = await fetch(`${METRO_API_TRTC}/arrival`);
            const rawData = await res.json();
            
            const stNameEl = document.getElementById('ui-st-name');
            const currentStationName = stNameEl.innerText.replace('ç«™', '');

            // 1. éæ¿¾æœ¬ç«™åˆ—è»Š
            const stationTrains = rawData.filter(t => {
                const apiName = t.StationName.replace('ç«™', '');
                return apiName === currentStationName;
            });

            if (stationTrains.length === 0) return [null, null];

            // 2. æ ¼å¼è½‰æ›
            const formattedTrains = stationTrains.map(t => ({
                DestinationStationName: { Zh_tw: t.DestinationName, En: '' }, 
                EstimateTime: parseTRTCTime(t.CountDown),
                LineID: t.LineID,
                LineColor: getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim(),
                TrainNumber: t.TrainNumber
            }));

            // 3. æ™ºæ…§åˆ†æµ (Platform 1 / Platform 2)
            const dests = [...new Set(formattedTrains.map(t => t.DestinationStationName.Zh_tw))];
            
            let t1 = null, t2 = null;
            
            if (dests.length >= 2) {
                const group1 = formattedTrains.filter(t => t.DestinationStationName.Zh_tw === dests[0]).sort((a,b)=>a.EstimateTime-b.EstimateTime);
                const group2 = formattedTrains.filter(t => t.DestinationStationName.Zh_tw === dests[1]).sort((a,b)=>a.EstimateTime-b.EstimateTime);
                t1 = group1[0];
                t2 = group2[0];
            } else {
                const sorted = formattedTrains.sort((a,b)=>a.EstimateTime-b.EstimateTime);
                t1 = sorted[0];
                t2 = sorted.length > 1 ? sorted[1] : null;
            }

            return [t1, t2];
        }

        function parseTRTCTime(timeStr) {
            if (!timeStr || timeStr === 'åˆ—è»Šé€²ç«™' || timeStr === 'è³‡æ–™æ“·å–ä¸­') return 0;
            if (timeStr.includes(':')) {
                const [mm, ss] = timeStr.split(':').map(Number);
                return (mm * 60) + ss;
            }
            return 9999;
        }

        function updateUI(idx, item) {
            const destZh = document.getElementById(`dir${idx}-dest`);
            const destEn = document.getElementById(`dir${idx}-en`);
            const timeBox = document.getElementById(`dir${idx}-time`);
            const lineBadge = document.getElementById(`ui-line-tag-${idx+1}`);

            if(!item) {
                const status = getOfflineStatus();
                destZh.innerText = status.destZh;
                destEn.innerText = status.destEn;
                timeBox.innerText = status.timeText;
                timeBox.className = status.timeClass;
                lineBadge.style.opacity = '0'; 
                return;
            }

            lineBadge.style.opacity = '1';
            destZh.innerText = item.DestinationStationName.Zh_tw;
            destEn.innerText = item.DestinationStationName.En || "Train"; // è‹±æ–‡æš«æ™‚é¡¯ç¤º Train
            
            lineBadge.innerText = item.LineID || system.substring(0,1);
            lineBadge.style.background = item.LineColor || "#808080";
            
            const estimateTime = item.EstimateTime != null ? item.EstimateTime : 0;
            countdownSecs[`dir${idx}`] = estimateTime;
            renderTime(idx);
        }

        function setOfflineUI(idx) {
            const status = getOfflineStatus();
            document.getElementById(`dir${idx}-dest`).innerText = status.destZh;
            document.getElementById(`dir${idx}-en`).innerText = status.destEn;
            const timeBox = document.getElementById(`dir${idx}-time`);
            timeBox.innerText = status.timeText;
            timeBox.className = status.timeClass;
            document.getElementById(`ui-line-tag-${idx+1}`).style.opacity = '0';
        }

        function renderTime(idx) {
            const el = document.getElementById(`dir${idx}-time`);
            const s = countdownSecs[`dir${idx}`];
            
            if (s == null || isNaN(s) || s < 0) {
                const status = getOfflineStatus();
                el.innerText = status.timeText;
                el.className = status.timeClass;
                return;
            }

            if(s <= 40) {
                el.innerText = "é€²ç«™ä¸­";
                el.className = "time-box arriving";
            } else if (s <= 120) {
                // é¡¯ç¤º MM : SS
                const m = Math.floor(s/60);
                const secs = String(s%60).padStart(2,'0');
                el.innerText = `${m} : ${secs}`;
                el.className = "time-box approaching";
            } else {
                const m = Math.floor(s/60);
                const secs = String(s%60).padStart(2,'0');
                el.innerText = `${m} : ${secs}`;
                el.className = "time-box";
            }
        }

        // ğŸ‘¥ æ›´æ–°æ“æ“ åº¦è³‡è¨Š (TRTC å°ˆç”¨ - å…¨æ–°é‚è¼¯)
        async function updateCongestion(nextTrains) {
            if (system !== 'TRTC') {
                document.querySelector('.congestion-area').innerHTML = `<div class="cong-no-data">æœ¬ç³»çµ±æš«ç„¡æ“æ“ åº¦è³‡è¨Š</div>`;
                return;
            }

            if (!nextTrains[0] && !nextTrains[1]) {
                document.querySelector('.congestion-area').innerHTML = `<div class="cong-no-data">å¾…åˆ—è»Šé€²ç«™å¾Œé¡¯ç¤ºæ“æ“ åº¦</div>`;
                return;
            }

            // å–å¾—è·¯ç·šä»£è™Ÿ
            const lineId = station.replace(/[0-9]/g, ''); 

            // â˜…â˜…â˜… å¦‚æœæ˜¯ç’°ç‹€ç·š(Y)ï¼Œé¡¯ç¤ºç‰¹å®šæç¤ºä¸¦è·³å‡º â˜…â˜…â˜…
            if (lineId === 'Y') {
                document.querySelector('.congestion-area').innerHTML = `<div class="cong-no-data">ç’°ç‹€ç·šç›®å‰ä¸æä¾›æ“æ“ åº¦è³‡è¨Š</div>`;
                return;
            }

            try { 
                let endpoint = '';
                
                if (lineId === 'BR') {
                    endpoint = '/crowdedness/wenhu';
                } else if (lineId === 'Y') {
                    // â˜…â˜…â˜… ç’°ç‹€ç·šï¼šç›®å‰åŒ—æ·å…¬é–‹ API ä¸­æ“æ“ åº¦å¯èƒ½ä¸åœ¨é€™ 7 é …ä¸­ â˜…â˜…â˜…
                    // ä½†æˆ‘å€‘é ç•™é‚è¼¯ï¼Œè‹¥æœªä¾†æœ‰è³‡æ–™å¯ç›´æ¥é¡¯ç¤º
                    endpoint = '/crowdedness/high-capacity';
                } else {
                    endpoint = '/crowdedness/high-capacity';
                }

                const res = await fetch(`${METRO_API_TRTC}${endpoint}`);
                let data = await res.json();

                if (data.error || !Array.isArray(data)) {
                    document.querySelector('.congestion-area').innerHTML = `<div class="cong-no-data">ç›®å‰ç„¡æ“æ“ åº¦è¨Šè™Ÿ</div>`;
                    return;
                }

                const stNameEl = document.getElementById('ui-st-name');
                const currentStationName = stNameEl.innerText.replace('ç«™', '').replace('è‡º', 'å°').trim();

                let html = '';
                // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šæ–‡æ¹–ç·š(BR) èˆ‡ ç’°ç‹€ç·š(Y) éƒ½æ˜¯ 4 ç¯€è»Šå»‚ â˜…â˜…â˜…
                const carCount = (lineId === 'BR' || lineId === 'Y') ? 4 : 6;
                
                [0, 1].forEach(idx => {
                    const train = nextTrains[idx];
                    if (!train) return;

                    // --- ç­–ç•¥ Aï¼šè»Šè™Ÿæ¯”å° ---
                    let match = null;
                    if (train.TrainNumber) {
                        const targetTN = parseInt(train.TrainNumber, 10);
                        match = data.find(c => {
                            const crowdNumbers = String(c.TrainNumber).split(',').map(n => parseInt(n.trim(), 10));
                            return crowdNumbers.includes(targetTN);
                        });
                    }

                    // --- ç­–ç•¥ Bï¼šç«™åæ¯”å° (ç«¯é»ç«™å‚™æ¡ˆ) ---
                    if (!match) {
                        match = data.find(c => {
                            const apiStation = (c.StationName || "").replace('BR', '').replace('ç«™', '').replace('è‡º', 'å°').trim();
                            return apiStation === currentStationName;
                        });
                    }

                    const label = `å¾€ ${train.DestinationStationName.Zh_tw}`;
                    let barsHtml = '';

                    if (match) {
                        for (let i = 1; i <= carCount; i++) {
                            const level = match[`Car${i}`] || match[`Cart${i}L`] || 0;
                            let cls = 'cong-car';
                            if (level == 1) cls += ' cong-lvl-1';
                            else if (level == 2) cls += ' cong-lvl-2';
                            else if (level == 3) cls += ' cong-lvl-3';
                            else if (level >= 4) cls += ' cong-lvl-4';
                            
                            // è‹¥ç„¡è³‡æ–™ level=0ï¼Œé¡¯ç¤ºç°è‰²
                            if(!level) cls = 'cong-car';
                            
                            barsHtml += `<div class="${cls}"></div>`;
                        }
                    } else {
                        // æœ‰è»Šä½†ç„¡æ“æ“ åº¦è³‡æ–™ (é¡¯ç¤ºç°è‰²)
                        for (let i = 1; i <= carCount; i++) barsHtml += `<div class="cong-car"></div>`;
                    }

                    html += `
                        <div class="cong-row">
                            <div class="cong-label">
                                <span style="background:${train.LineColor}; width:12px; height:12px; border-radius:50%; display:inline-block;"></span>
                                ${label}
                            </div>
                            <div class="cong-bar-container">${barsHtml}</div>
                        </div>
                    `;
                });

                document.querySelector('.congestion-area').innerHTML = html || `<div class="cong-no-data">æ¥æ”¶æ“æ“ åº¦è¨Šè™Ÿä¸­...</div>`;

            } catch (e) {
                console.error("æ“æ“ åº¦æ›´æ–°å¤±æ•—", e);
            }
        }

        async function updateWeather() {
            try {
                const res = await fetch(`${WEATHER_API}?dataset=F-C0032-001`);
                const json = await res.json();
                const county = system === 'TYMC' ? 'æ¡ƒåœ’å¸‚' : 'è‡ºåŒ—å¸‚';
                const loc = json.records.location.find(l => l.locationName === county);
                if(loc) {
                    const wx = loc.weatherElement.find(e => e.elementName === 'Wx').time[0].parameter.parameterName;
                    const minT = loc.weatherElement.find(e => e.elementName === 'MinT').time[0].parameter.parameterName;
                    const maxT = loc.weatherElement.find(e => e.elementName === 'MaxT').time[0].parameter.parameterName;
                    const pop = loc.weatherElement.find(e => e.elementName === 'PoP').time[0].parameter.parameterName;
                    document.getElementById('ui-weather-text').innerText = wx;
                    document.getElementById('ui-range-display').innerText = `${minT}Â°C ~ ${maxT}Â°C`;
                    document.getElementById('ui-rain-display').innerHTML = `<i class="fas fa-umbrella"></i> ${pop}%`;
                }
            } catch(e) {}
        }

        async function updateMarquee() {
            try {
                // æ–°èé‚„æ˜¯èµ° TDX Worker
                const res = await fetch(`${METRO_API_TDX}/news?sys=${system}`);
                const data = await res.json();
                let text = "ã€TPASS 2.0+ å‡ç´šã€‘å¸¸å®¢å„ªæƒ æ­£å¼ä¸Šç·šï¼æ­ä¹˜11æ¬¡ä»¥ä¸Šæœ€é«˜äº«30%å›é¥‹ï¼Œåœ‹é“å®¢é‹é è¡Œå†äº«å„ªæƒ ï¼Œè©³æƒ…è«‹è¦‹å®˜ç¶²ã€‚ã€€ã€€";
                
                if (data && data.length > 0) {
                    text = data.slice(0, 3).map(n => `ã€æœ€æ–°æ¶ˆæ¯ã€‘${n.Title || n.NewsTitle}`).join('ã€€ã€€') + 'ã€€ã€€' + text;
                }
                document.getElementById('ui-marquee').innerText = text;
            } catch(e) {}
        }

        init();
    </script>
</body>
</html>
