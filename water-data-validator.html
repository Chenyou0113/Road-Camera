<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水利署資料驗證工具 - 時間戳記異常檢測</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .alert-section {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .alert-section h2 {
            color: #856404;
            margin-bottom: 15px;
        }

        .alert-section ul {
            margin-left: 20px;
            color: #856404;
            line-height: 1.8;
        }

        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .control-panel h3 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .filter-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .filter-item label {
            cursor: pointer;
            user-select: none;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.error {
            border-left: 5px solid #dc3545;
        }

        .stat-card.warning {
            border-left: 5px solid #ffc107;
        }

        .stat-card.success {
            border-left: 5px solid #28a745;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-card.error .stat-number {
            color: #dc3545;
        }

        .stat-card.warning .stat-number {
            color: #ffc107;
        }

        .stat-card.success .stat-number {
            color: #28a745;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-table {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            margin: 0;
        }

        .export-btn {
            background: white;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s ease;
        }

        .export-btn:hover {
            transform: scale(1.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            display: inline-block;
        }

        .badge-error {
            background: #fee;
            color: #dc3545;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2rem;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-link {
            display: inline-block;
            padding: 12px 25px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .back-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .table-container {
                overflow-x: auto;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="water-resources.html" class="back-link">
            <i class="fas fa-arrow-left"></i> 返回水利署監視器
        </a>

        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> 水利署資料驗證工具</h1>
            <p>時間戳記異常檢測與資料品質分析</p>
        </div>

        <div class="alert-section">
            <h2><i class="fas fa-exclamation-triangle"></i> 檢測到的異常問題</h2>
            <ul>
                <li><strong>未來日期異常：</strong>發現測站資料時間為 2099/12/31，這是明顯的異常時間戳記</li>
                <li><strong>可能原因：</strong>測試資料、API 錯誤、預設值佔位符、或資料庫同步問題</li>
                <li><strong>影響範圍：</strong>異常時間戳記可能影響資料排序、統計分析和自動化處理</li>
            </ul>
            <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #1976D2;">
                <p style="margin: 0; color: #1565C0; font-weight: bold;">
                    <i class="fas fa-link"></i> 相關資源連結
                </p>
                <div style="margin-top: 10px;">
                    <a href="https://fhy.wra.gov.tw/fhy/" target="_blank" style="color: #1976D2; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; margin-right: 20px;">
                        <i class="fas fa-water"></i> 水利署防災資訊服務網
                        <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                    </a>
                    <a href="https://fhy.wra.gov.tw/fhy/Monitor/ImageMonitor" target="_blank" style="color: #1976D2; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; margin-right: 20px;">
                        <i class="fas fa-video"></i> 河川影像監視系統
                        <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                    </a>
                    <a href="https://www.wra.gov.tw/" target="_blank" style="color: #1976D2; text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">
                        <i class="fas fa-building"></i> 經濟部水利署官網
                        <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <h3><i class="fas fa-sliders-h"></i> 資料篩選控制</h3>
            <div class="filter-group">
                <div class="filter-item">
                    <input type="checkbox" id="showFuture" checked>
                    <label for="showFuture">顯示未來日期 (> 當前時間)</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="showOld" checked>
                    <label for="showOld">顯示過舊資料 (> 30天)</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="showNormal" checked>
                    <label for="showNormal">顯示正常資料</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="showNoData" checked>
                    <label for="showNoData">顯示無時間戳記</label>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="loadAndValidateData()">
                    <i class="fas fa-sync-alt"></i> 重新檢測
                </button>
                <button class="btn btn-success" onclick="exportReport()">
                    <i class="fas fa-file-export"></i> 匯出報告
                </button>
                <button class="btn btn-danger" onclick="highlightAnomalies()">
                    <i class="fas fa-exclamation-circle"></i> 僅顯示異常
                </button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card success">
                <div class="stat-number" id="totalStations">0</div>
                <div class="stat-label">總測站數</div>
            </div>
            <div class="stat-card error">
                <div class="stat-number" id="futureDate">0</div>
                <div class="stat-label">未來日期異常</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-number" id="oldData">0</div>
                <div class="stat-label">資料過舊 (>30天)</div>
            </div>
            <div class="stat-card success">
                <div class="stat-number" id="normalData">0</div>
                <div class="stat-label">正常資料</div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <i class="fas fa-spinner spinner fa-3x"></i>
            <p>正在載入並分析資料...</p>
        </div>

        <div class="data-table" id="dataTable" style="display: none;">
            <div class="table-header">
                <h3><i class="fas fa-table"></i> 資料驗證結果</h3>
                <button class="export-btn" onclick="exportToCSV()">
                    <i class="fas fa-download"></i> 下載 CSV
                </button>
            </div>
            <div class="table-container">
                <table id="validationTable">
                    <thead>
                        <tr>
                            <th>測站名稱</th>
                            <th>測站ID</th>
                            <th>資料時間</th>
                            <th>主管機關</th>
                            <th>位置</th>
                            <th>狀態</th>
                            <th>異常說明</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allStationsData = [];
        let validationResults = [];

        async function loadAndValidateData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dataTable').style.display = 'none';

            try {
                // 載入水利署直轄監視器
                const wraResponse = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%27&$count=true');
                
                // 載入水利署與地方政府合建監視器
                const cooperativeResponse = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%EF%BC%88%E8%88%87%E7%B8%A3%E5%B8%82%E6%94%BF%E5%BA%9C%E5%90%88%E5%BB%BA%EF%BC%89%27&$count=true');
                
                if (!wraResponse.ok || !cooperativeResponse.ok) {
                    throw new Error('API 回應錯誤');
                }

                const wraData = await wraResponse.json();
                const cooperativeData = await cooperativeResponse.json();
                
                allStationsData = [...(wraData.value || []), ...(cooperativeData.value || [])];
                
                // 驗證資料
                validateTimestamps();
                
                // 更新統計
                updateStatistics();
                
                // 顯示表格
                displayResults();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dataTable').style.display = 'block';

            } catch (error) {
                console.error('載入失敗:', error);
                document.getElementById('loading').innerHTML = `
                    <i class="fas fa-exclamation-triangle fa-3x" style="color: #dc3545;"></i>
                    <p>載入失敗：${error.message}</p>
                    <button class="btn btn-primary" onclick="loadAndValidateData()">重試</button>
                `;
            }
        }

        function validateTimestamps() {
            validationResults = [];
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            allStationsData.forEach(station => {
                const thing = station.Thing || {};
                const latestObs = station.Observations && station.Observations.length > 0 ? station.Observations[0] : null;
                const timestamp = latestObs?.phenomenonTime;

                let status = 'normal';
                let issue = '';

                if (!timestamp) {
                    status = 'no-data';
                    issue = '無時間戳記資料';
                } else {
                    const date = new Date(timestamp);
                    
                    if (isNaN(date.getTime())) {
                        status = 'error';
                        issue = '時間格式錯誤';
                    } else if (date > now) {
                        status = 'future';
                        issue = `未來日期 (距今 ${Math.floor((date - now) / (24 * 60 * 60 * 1000))} 天)`;
                    } else if (date < thirtyDaysAgo) {
                        status = 'old';
                        issue = `資料過舊 (${Math.floor((now - date) / (24 * 60 * 60 * 1000))} 天前)`;
                    }
                }

                validationResults.push({
                    station,
                    thing,
                    timestamp,
                    status,
                    issue
                });
            });
        }

        function updateStatistics() {
            document.getElementById('totalStations').textContent = allStationsData.length;
            document.getElementById('futureDate').textContent = validationResults.filter(r => r.status === 'future').length;
            document.getElementById('oldData').textContent = validationResults.filter(r => r.status === 'old').length;
            document.getElementById('normalData').textContent = validationResults.filter(r => r.status === 'normal').length;
        }

        function displayResults() {
            const tbody = document.getElementById('tableBody');
            const showFuture = document.getElementById('showFuture').checked;
            const showOld = document.getElementById('showOld').checked;
            const showNormal = document.getElementById('showNormal').checked;
            const showNoData = document.getElementById('showNoData').checked;

            const filteredResults = validationResults.filter(result => {
                if (result.status === 'future' && !showFuture) return false;
                if (result.status === 'old' && !showOld) return false;
                if (result.status === 'normal' && !showNormal) return false;
                if (result.status === 'no-data' && !showNoData) return false;
                return true;
            });

            const html = filteredResults.map(result => {
                const thing = result.thing;
                const name = thing.name || '未命名';
                const stationId = thing.properties?.stationID || thing['@iot.id'] || 'N/A';
                const authority = thing.properties?.authority || 'N/A';
                const location = thing.properties?.location || '位置未知';
                const timeDisplay = result.timestamp ? new Date(result.timestamp).toLocaleString('zh-TW') : '無資料';

                let statusBadge = '';
                let statusText = '';

                switch(result.status) {
                    case 'future':
                        statusBadge = 'badge-error';
                        statusText = '⚠️ 異常';
                        break;
                    case 'old':
                        statusBadge = 'badge-warning';
                        statusText = '⚠ 警告';
                        break;
                    case 'no-data':
                        statusBadge = 'badge-warning';
                        statusText = '⚠ 無資料';
                        break;
                    case 'error':
                        statusBadge = 'badge-error';
                        statusText = '❌ 錯誤';
                        break;
                    default:
                        statusBadge = 'badge-success';
                        statusText = '✓ 正常';
                }

                return `
                    <tr>
                        <td><strong>${name}</strong></td>
                        <td><code style="font-size: 0.85rem;">${stationId}</code></td>
                        <td>${timeDisplay}</td>
                        <td>${authority}</td>
                        <td>${location}</td>
                        <td><span class="status-badge ${statusBadge}">${statusText}</span></td>
                        <td>${result.issue || '-'}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align: center;">無符合條件的資料</td></tr>';
        }

        function highlightAnomalies() {
            document.getElementById('showFuture').checked = true;
            document.getElementById('showOld').checked = true;
            document.getElementById('showNormal').checked = false;
            document.getElementById('showNoData').checked = true;
            displayResults();
        }

        function exportReport() {
            const report = {
                generatedAt: new Date().toISOString(),
                summary: {
                    total: allStationsData.length,
                    future: validationResults.filter(r => r.status === 'future').length,
                    old: validationResults.filter(r => r.status === 'old').length,
                    normal: validationResults.filter(r => r.status === 'normal').length,
                    noData: validationResults.filter(r => r.status === 'no-data').length
                },
                anomalies: validationResults.filter(r => r.status === 'future' || r.status === 'error').map(r => ({
                    name: r.thing.name,
                    stationID: r.thing.properties?.stationID || r.thing['@iot.id'],
                    timestamp: r.timestamp,
                    status: r.status,
                    issue: r.issue,
                    authority: r.thing.properties?.authority,
                    location: r.thing.properties?.location
                }))
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `water-data-validation-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportToCSV() {
            const headers = ['測站名稱', '測站ID', '資料時間', '主管機關', '位置', '狀態', '異常說明'];
            const rows = validationResults.map(result => {
                const thing = result.thing;
                return [
                    thing.name || '未命名',
                    thing.properties?.stationID || thing['@iot.id'] || 'N/A',
                    result.timestamp ? new Date(result.timestamp).toLocaleString('zh-TW') : '無資料',
                    thing.properties?.authority || 'N/A',
                    thing.properties?.location || '位置未知',
                    result.status,
                    result.issue || '-'
                ];
            });

            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `water-data-validation-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 監聽篩選條件變更
        document.getElementById('showFuture').addEventListener('change', displayResults);
        document.getElementById('showOld').addEventListener('change', displayResults);
        document.getElementById('showNormal').addEventListener('change', displayResults);
        document.getElementById('showNoData').addEventListener('change', displayResults);

        // 頁面載入時自動執行檢測
        window.onload = function() {
            loadAndValidateData();
        };
    </script>
</body>
</html>
