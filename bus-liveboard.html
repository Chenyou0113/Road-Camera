<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£å…¬è»Šå³æ™‚å‹•æ…‹è¿½è¹¤ç³»çµ±</title>
    <!-- Leaflet åœ°åœ–å¥—ä»¶ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            background: #f5f7fa;
        }
        
        #controls { 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        #controls strong {
            font-size: 1.3rem;
            font-weight: 900;
            margin-right: 10px;
        }
        
        #main { 
            display: flex; 
            flex: 1; 
            overflow: hidden; 
        }
        
        #stop-list { 
            width: 380px; 
            overflow-y: auto; 
            background: #ffffff;
            border-right: 2px solid #e5e7eb;
            padding: 15px;
        }
        
        #map { 
            flex: 1; 
            position: relative;
        }
        
        .stop-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 14px 16px; 
            background: white; 
            margin-bottom: 8px; 
            border-radius: 12px; 
            border-left: 5px solid #bdc3c7;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stop-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .stop-name { 
            font-weight: 700; 
            color: #1f2937;
            font-size: 1.05rem;
        }
        
        .stop-sequence {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            text-align: center;
            line-height: 26px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-right: 10px;
        }
        
        .arrival-time { 
            padding: 8px 14px; 
            border-radius: 8px; 
            font-size: 15px; 
            font-weight: 900; 
            min-width: 80px; 
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* æ™‚é–“é¡è‰² */
        .time-now { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; animation: pulse 1.5s infinite; }
        .time-soon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .time-wait { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .time-none { background: #9ca3af; color: white; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        input, select, button { 
            padding: 10px 14px; 
            border-radius: 8px; 
            border: none;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 0.95rem;
        }
        
        input, select {
            background: rgba(255,255,255,0.95);
            color: #1f2937;
            font-weight: 600;
        }
        
        button { 
            background: #10b981;
            color: white; 
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            padding: 10px 24px;
        }
        
        button:hover { 
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        #update-status {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .city-legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 0.8rem;
            align-items: center;
        }
        
        .city-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 6px;
        }
        
        .city-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: #6b7280;
        }
        
        .route-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 900;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* åœ°åœ–ä¸Šçš„å…¬è»Šåœ–æ¨™ - å‡ç´šç‰ˆå¸¶æ–¹å‘ç®­é ­ */
        .bus-marker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .bus-icon-wrapper {
            background: linear-gradient(135deg, #d63031 0%, #e17055 100%);
            color: white;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(214, 48, 49, 0.6);
            transition: all 0.3s ease;
            animation: pulse-bus 2s infinite;
        }
        
        .bus-icon-wrapper:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(214, 48, 49, 0.8);
        }
        
        .bus-icon-wrapper i {
            font-size: 20px;
        }
        
        .bus-plate-label {
            background: rgba(45, 52, 54, 0.9);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 3px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }
        
        @keyframes pulse-bus {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        /* å…¬è»Šè©³ç´°è³‡è¨Šå½ˆçª—æ¨£å¼ */
        .bus-popup {
            min-width: 200px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .bus-popup-header {
            background: linear-gradient(135deg, #d63031 0%, #e17055 100%);
            color: white;
            padding: 12px;
            border-radius: 8px 8px 0 0;
            font-weight: 900;
            text-align: center;
            margin: -16px -20px 12px -20px;
            font-size: 1.1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .bus-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .bus-info-row:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .bus-info-label {
            color: #6b7280;
            font-size: 13px;
            font-weight: 600;
        }
        
        .bus-info-value {
            font-weight: 700;
            color: #1f2937;
            font-size: 14px;
        }
        
        .bus-popup-footer {
            font-size: 11px;
            color: #9ca3af;
            text-align: center;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        
        /* Leaflet Popup è‡ªè¨‚æ¨£å¼ */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content {
            margin: 16px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .popup-stop-title {
            font-size: 1.2rem;
            font-weight: 900;
            color: #667eea;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .popup-routes-container {
            max-height: 180px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            padding: 4px;
        }
        
        .popup-routes-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .popup-routes-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .popup-route-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .popup-route-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .popup-loading {
            text-align: center;
            padding: 20px;
            color: #9ca3af;
        }
        
        .popup-error {
            text-align: center;
            padding: 20px;
            color: #ef4444;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            #main { flex-direction: column; }
            #stop-list { width: 100%; max-height: 40%; }
            #controls { padding: 12px; }
            #controls strong { display: block; width: 100%; margin-bottom: 8px; }
        }
    </style>
</head>
<body>

<div id="controls">
    <strong><i class="fas fa-bus"></i> å…¬è»Šå³æ™‚è¿½è¹¤ç³»çµ±</strong>
    <div class="city-legend">
        <span style="opacity: 0.8;">åŸå¸‚ï¼š</span>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #667eea;"></div>
            <span>å°åŒ—</span>
        </div>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #10b981;"></div>
            <span>æ–°åŒ—</span>
        </div>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #f59e0b;"></div>
            <span>å°ä¸­</span>
        </div>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #ef4444;"></div>
            <span>é«˜é›„</span>
        </div>
    </div>
    <select id="category">
        <option value="CityBus">å¸‚å€å…¬è»Š</option>
        <option value="InterCity">å…¬è·¯å®¢é‹</option>
    </select>
    <select id="city">
        <option value="Taipei">å°åŒ—å¸‚</option>
        <option value="NewTaipei">æ–°åŒ—å¸‚</option>
        <option value="Taoyuan">æ¡ƒåœ’å¸‚</option>
        <option value="Taichung">å°ä¸­å¸‚</option>
        <option value="Tainan">å°å—å¸‚</option>
        <option value="Kaohsiung">é«˜é›„å¸‚</option>
        <option value="Keelung">åŸºéš†å¸‚</option>
        <option value="Hsinchu">æ–°ç«¹å¸‚</option>
        <option value="HsinchuCounty">æ–°ç«¹ç¸£</option>
        <option value="MiaoliCounty">è‹—æ —ç¸£</option>
        <option value="ChanghwaCounty">å½°åŒ–ç¸£</option>
        <option value="NantouCounty">å—æŠ•ç¸£</option>
        <option value="YunlinCounty">é›²æ—ç¸£</option>
        <option value="ChiayiCounty">å˜‰ç¾©ç¸£</option>
        <option value="Chiayi">å˜‰ç¾©å¸‚</option>
        <option value="PingtungCounty">å±æ±ç¸£</option>
        <option value="YilanCounty">å®œè˜­ç¸£</option>
        <option value="HualienCounty">èŠ±è“®ç¸£</option>
        <option value="TaitungCounty">å°æ±ç¸£</option>
        <option value="KinmenCounty">é‡‘é–€ç¸£</option>
        <option value="PenghuCounty">æ¾æ¹–ç¸£</option>
        <option value="LienchiangCounty">é€£æ±Ÿç¸£</option>
    </select>
    <input type="text" id="routeNum" placeholder="è¼¸å…¥è·¯ç·šåˆ‡æ›å–®ä¸€è·¯ç·šæ¨¡å¼">
    <select id="direction">
        <option value="0">å»ç¨‹</option>
        <option value="1">è¿”ç¨‹</option>
    </select>
    <button onclick="startTracking()"><i class="fas fa-search"></i> è¿½è¹¤è·¯ç·š</button>
    <span id="update-status"></span>
</div>

<div id="main">
    <div id="stop-list">
        <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <h3>ğŸŒ æ¢ç´¢æ¨¡å¼</h3>
            <p>æ­£åœ¨è¼‰å…¥å…¨å°ç†±é–€è·¯ç·šè»Šè¼›...</p>
            <div style="margin-top: 15px; font-size: 0.85rem; color: #9ca3af;">
                <p>ğŸ’¡ <strong>æç¤ºï¼š</strong></p>
                <p>â€¢ åœ°åœ–æœƒè‡ªå‹•é¡¯ç¤ºå„åŸå¸‚è»Šè¼›</p>
                <p>â€¢ é»æ“Šè»Šè¼›æŸ¥çœ‹è©³ç´°è³‡è¨Š</p>
                <p>â€¢ è¼¸å…¥è·¯ç·šè™Ÿå¯åˆ‡æ›å–®ä¸€è·¯ç·šæ¨¡å¼</p>
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>

<script>
    /*
     * ============================================
     * å°ç£å…¬è»Šå³æ™‚è¿½è¹¤ç³»çµ± - æŠ€è¡“èªªæ˜
     * ============================================
     * 
     * ã€åº§æ¨™æ ¼å¼èªªæ˜ã€‘
     * TDX API æä¾›å…©ç¨®è·¯ç·šåº§æ¨™æ ¼å¼ï¼š
     * 
     * 1. Geometry (WKTæ ¼å¼) âœ… ç›®å‰ä½¿ç”¨
     *    ç¯„ä¾‹: "LINESTRING (121.565 25.065, 121.566 25.066, ...)"
     *    - å„ªé»ï¼šäººé¡å¯è®€ï¼Œå®¹æ˜“é™¤éŒ¯ï¼Œç„¡éœ€é¡å¤–å¥—ä»¶
     *    - ç¼ºé»ï¼šè³‡æ–™é‡è¼ƒå¤§ï¼ˆç´„ 5-10KBï¼‰
     * 
     * 2. EncodedPolyline (Googleå£“ç¸®æ ¼å¼) ğŸ”§ å·²å¯¦ä½œä½†æœªå•Ÿç”¨
     *    ç¯„ä¾‹: "afpVwCwahdV~iB..." (çœ‹èµ·ä¾†åƒäº‚ç¢¼)
     *    - å„ªé»ï¼šè³‡æ–™é‡æ¥µå°ï¼ˆç´„ 1-2KBï¼‰ï¼Œç¯€çœ 80% æµé‡
     *    - ç¼ºé»ï¼šéœ€è¦è§£ç¢¼æ¼”ç®—æ³•ï¼ˆå·²å…§å»ºæ‰‹å‹•è§£ç¢¼å‡½å¼ï¼‰
     * 
     * ğŸ’¡ å¦‚éœ€å•Ÿç”¨ EncodedPolyline æ”¯æ´ï¼š
     *    åªéœ€ç¢ºä¿ Worker å›å‚³çš„è³‡æ–™åŒ…å« EncodedPolyline æ¬„ä½å³å¯ï¼Œ
     *    ç³»çµ±æœƒè‡ªå‹•åµæ¸¬ä¸¦ä½¿ç”¨æ‰‹å‹•è§£ç¢¼å‡½å¼è™•ç†ã€‚
     * 
     * ============================================
     */
    
    const WORKER_URL = 'https://bus-worker.weacamm.org/';
    let map, stopMarkers = [], busMarkers = [];
    let pollingTimer = null;
    let currentStops = [];
    let currentRouteLine = null; // è·¯ç·šç·šå‹åœ–å±¤
    let allBusMarkers = []; // æ‰€æœ‰è·¯ç·šçš„è»Šè¼›æ¨™è¨˜
    let isExploreMode = true; // æ¢ç´¢æ¨¡å¼ï¼ˆé¡¯ç¤ºæ‰€æœ‰è»Šè¼›ï¼‰

    // ç†±é–€è·¯ç·šé…ç½®ï¼ˆæœƒè‡ªå‹•è¼‰å…¥é€™äº›è·¯ç·šçš„è»Šè¼›ï¼‰
    const POPULAR_ROUTES = [
        { city: 'Taipei', routes: ['307', 'ç´…5', 'æ£•1', 'è—5', '617', 'æ•¦åŒ–å¹¹ç·š', 'ä¿¡ç¾©å¹¹ç·š'] },
        { city: 'NewTaipei', routes: ['è—37', 'ç¶ 2', 'æ©˜20', '842'] },
        { city: 'Taichung', routes: ['300', '301', '302', '303', '304', '305'] },
        { city: 'Kaohsiung', routes: ['ç´…51', 'ç´…52', 'ç´…53', 'æ©˜1', 'æ©˜7'] }
    ];

    // åˆå§‹åŒ–åœ°åœ–ï¼ˆä¿®å¤ SSL è¯ä¹¦é”™è¯¯ï¼šä½¿ç”¨ç¨³å®šçš„ OpenStreetMap æ ‡å‡†æœåŠ¡å™¨ï¼‰
    map = L.map('map').setView([25.0475, 121.5173], 12); // é è¨­å°åŒ—å¸‚
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | TDX',
        maxZoom: 19,
        crossOrigin: true
    }).addTo(map);

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•é¡¯ç¤ºç†±é–€è·¯ç·šçš„è»Šè¼›
    window.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸš€ å•Ÿå‹•æ¢ç´¢æ¨¡å¼ï¼šè¼‰å…¥ç†±é–€è·¯ç·šè»Šè¼›...');
        loadPopularRoutesBuses();
        // æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡æ‰€æœ‰è»Šè¼›ä½ç½®
        setInterval(loadPopularRoutesBuses, 30000);
    });

    /**
     * è¼‰å…¥ç†±é–€è·¯ç·šçš„æ‰€æœ‰è»Šè¼›ï¼ˆæ¢ç´¢æ¨¡å¼ï¼‰
     */
    async function loadPopularRoutesBuses() {
        console.log('ğŸ”„ æ›´æ–°æ¢ç´¢æ¨¡å¼è»Šè¼›ä½ç½®...');
        document.getElementById('update-status').innerHTML = '<i class="fas fa-sync fa-spin"></i> è¼‰å…¥å…¨å°è»Šè¼›...';
        
        // æ›´æ–°å´é‚Šæ¬„ç‹€æ…‹
        document.getElementById('stop-list').innerHTML = `
            <div class="route-header">
                <i class="fas fa-globe"></i> æ¢ç´¢æ¨¡å¼
                <div style="font-size: 0.9rem; font-weight: 600; margin-top: 4px; opacity: 0.9;">
                    æ­£åœ¨è¼‰å…¥ç†±é–€è·¯ç·š...
                </div>
            </div>
        `;
        
        // æ¸…é™¤èˆŠçš„è»Šè¼›æ¨™è¨˜
        allBusMarkers.forEach(m => map.removeLayer(m));
        allBusMarkers = [];
        
        let totalBuses = 0;
        const promises = [];
        const routeStats = {}; // è¨˜éŒ„æ¯æ¢è·¯ç·šçš„è»Šè¼›æ•¸
        
        // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰åŸå¸‚çš„ç†±é–€è·¯ç·š
        for (const cityGroup of POPULAR_ROUTES) {
            for (const route of cityGroup.routes) {
                promises.push(
                    fetchRouteBuses('CityBus', cityGroup.city, route)
                        .then(buses => {
                            if (buses && buses.length > 0) {
                                const key = `${cityGroup.city}-${route}`;
                                routeStats[key] = buses.length;
                                buses.forEach(bus => {
                                    createBusMarker(bus, route, cityGroup.city, true);
                                    totalBuses++;
                                });
                            }
                        })
                        .catch(err => console.warn(`âš ï¸ ${cityGroup.city} ${route} è¼‰å…¥å¤±æ•—:`, err))
                );
            }
        }
        
        await Promise.all(promises);
        
        // æ›´æ–°å´é‚Šæ¬„é¡¯ç¤ºè·¯ç·šçµ±è¨ˆ
        updateExploreSidebar(routeStats, totalBuses);
        
        document.getElementById('update-status').innerHTML = 
            `<i class="fas fa-globe"></i> æ¢ç´¢æ¨¡å¼ | ğŸšŒ ${totalBuses} å°è»Šè¼›é‹è¡Œä¸­ | ${new Date().toLocaleTimeString('zh-TW')}`;
        
        console.log(`âœ… æ¢ç´¢æ¨¡å¼ï¼šå·²é¡¯ç¤º ${totalBuses} å°è»Šè¼›`);
    }

    /**
     * æ›´æ–°æ¢ç´¢æ¨¡å¼å´é‚Šæ¬„
     */
    function updateExploreSidebar(routeStats, totalBuses) {
        const container = document.getElementById('stop-list');
        
        let html = `
            <div class="route-header">
                <i class="fas fa-globe"></i> æ¢ç´¢æ¨¡å¼
                <div style="font-size: 0.9rem; font-weight: 600; margin-top: 4px; opacity: 0.9;">
                    å…± ${totalBuses} å°è»Šè¼›é‹è¡Œä¸­
                </div>
            </div>
            <div style="padding: 10px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px;">
                <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 8px;">
                    <i class="fas fa-info-circle"></i> <strong>å¦‚ä½•ä½¿ç”¨ï¼š</strong>
                </div>
                <ul style="font-size: 0.85rem; color: #6b7280; margin-left: 20px;">
                    <li>é»æ“Šåœ°åœ–ä¸Šçš„è»Šè¼›æŸ¥çœ‹è©³æƒ…</li>
                    <li>ä¸åŒé¡è‰²ä»£è¡¨ä¸åŒåŸå¸‚</li>
                    <li>è¼¸å…¥è·¯ç·šè™Ÿå¯åˆ‡æ›å–®ä¸€è·¯ç·š</li>
                </ul>
            </div>
        `;
        
        // æŒ‰åŸå¸‚åˆ†çµ„é¡¯ç¤ºè·¯ç·š
        const cityGroups = {};
        for (const [key, count] of Object.entries(routeStats)) {
            const [city, route] = key.split('-');
            if (!cityGroups[city]) cityGroups[city] = [];
            cityGroups[city].push({ route, count });
        }
        
        for (const [city, routes] of Object.entries(cityGroups)) {
            const cityColors = {
                'Taipei': '#667eea',
                'NewTaipei': '#10b981',
                'Taichung': '#f59e0b',
                'Kaohsiung': '#ef4444'
            };
            const color = cityColors[city] || '#9ca3af';
            const cityName = getCityName(city);
            
            html += `
                <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${color};">
                    <div style="font-weight: 700; color: ${color}; margin-bottom: 8px; font-size: 1rem;">
                        ${cityName}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            `;
            
            routes.forEach(({ route, count }) => {
                html += `
                    <span style="background: ${color}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">
                        ${route} (${count})
                    </span>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }

    /**
     * ç²å–æŒ‡å®šè·¯ç·šçš„è»Šè¼›è³‡æ–™
     */
    async function fetchRouteBuses(category, city, route) {
        try {
            const url = `${WORKER_URL}?category=${category}&city=${city}&route=${encodeURIComponent(route)}`;
            const res = await fetch(url);
            if (!res.ok) return [];
            const data = await res.json();
            return data.buses || [];
        } catch (e) {
            return [];
        }
    }

    /**
     * å‰µå»ºè»Šè¼›æ¨™è¨˜ï¼ˆå¯ç”¨æ–¼å–®ä¸€è·¯ç·šæˆ–æ¢ç´¢æ¨¡å¼ï¼‰
     */
    function createBusMarker(bus, routeName, cityName, isExploreMode = false) {
        const azimuth = bus.azi || 0;
        const cityColors = {
            'Taipei': '#667eea',
            'NewTaipei': '#10b981',
            'Taichung': '#f59e0b',
            'Kaohsiung': '#ef4444'
        };
        const markerColor = isExploreMode ? (cityColors[cityName] || '#d63031') : '#d63031';
        
        const busIcon = L.divIcon({
            className: '',
            html: `
                <div class="bus-marker-container">
                    <div class="bus-icon-wrapper" style="transform: rotate(${azimuth}deg); background: linear-gradient(135deg, ${markerColor} 0%, ${markerColor}dd 100%);">
                        <i class="fas fa-location-arrow"></i>
                    </div>
                    ${isExploreMode ? `<div class="bus-plate-label" style="background: ${markerColor};">${routeName}</div>` : `<div class="bus-plate-label">${bus.plate || 'æœªçŸ¥'}</div>`}
                </div>
            `,
            iconSize: [45, 60],
            iconAnchor: [22, 30]
        });
        
        const marker = L.marker([bus.lat, bus.lon], { icon: busIcon }).addTo(map);
        
        const statusColor = (bus.status === 0 || bus.status === undefined) ? '#10b981' : '#ef4444';
        const statusText = (bus.status === 0 || bus.status === undefined) ? 'æ­£å¸¸è¡Œé§›' : 'ç‹€æ…‹ç•°å¸¸';
        const directionText = bus.dir == 0 ? 'å»ç¨‹ â¡ï¸' : 'è¿”ç¨‹ â¬…ï¸';
        const directionName = getDirectionName(azimuth);
        
        const popupHtml = `
            <div class="bus-popup">
                <div class="bus-popup-header" style="background: linear-gradient(135deg, ${markerColor} 0%, ${markerColor}dd 100%);">
                    <i class="fas fa-bus"></i> ${routeName} ${bus.plate ? '(' + bus.plate + ')' : ''}
                </div>
                <div class="bus-info-row">
                    <span class="bus-info-label"><i class="fas fa-map-marked-alt"></i> åŸå¸‚</span>
                    <span class="bus-info-value">${getCityName(cityName)}</span>
                </div>
                <div class="bus-info-row">
                    <span class="bus-info-label"><i class="fas fa-route"></i> è¡Œé§›æ–¹å‘</span>
                    <span class="bus-info-value">${directionText}</span>
                </div>
                <div class="bus-info-row">
                    <span class="bus-info-label"><i class="fas fa-compass"></i> è»Šé ­æœå‘</span>
                    <span class="bus-info-value">${directionName} (${azimuth}Â°)</span>
                </div>
                <div class="bus-info-row">
                    <span class="bus-info-label"><i class="fas fa-circle-check"></i> é‹è¡Œç‹€æ…‹</span>
                    <span class="bus-info-value" style="color: ${statusColor};">${statusText}</span>
                </div>
                <div class="bus-popup-footer">
                    <i class="fas fa-clock"></i> ${new Date().toLocaleTimeString('zh-TW')}
                </div>
            </div>
        `;
        
        marker.bindPopup(popupHtml);
        
        if (isExploreMode) {
            allBusMarkers.push(marker);
        } else {
            busMarkers.push(marker);
        }
        
        return marker;
    }

    /**
     * ç²å–åŸå¸‚ä¸­æ–‡åç¨±
     */
    function getCityName(cityCode) {
        const cityNames = {
            'Taipei': 'å°åŒ—å¸‚',
            'NewTaipei': 'æ–°åŒ—å¸‚',
            'Taichung': 'å°ä¸­å¸‚',
            'Tainan': 'å°å—å¸‚',
            'Kaohsiung': 'é«˜é›„å¸‚',
            'Taoyuan': 'æ¡ƒåœ’å¸‚'
        };
        return cityNames[cityCode] || cityCode;
    }

    async function startTracking() {
        // åˆ‡æ›åˆ°å–®ä¸€è·¯ç·šæ¨¡å¼
        isExploreMode = false;
        
        // æ¸…é™¤æ¢ç´¢æ¨¡å¼çš„è»Šè¼›
        allBusMarkers.forEach(m => map.removeLayer(m));
        allBusMarkers = [];
        
        const category = document.getElementById('category').value;
        const city = document.getElementById('city').value;
        const route = document.getElementById('routeNum').value.trim();
        const direction = document.getElementById('direction').value;

        if (!route) {
            alert('âš ï¸ è«‹è¼¸å…¥è·¯ç·šè™Ÿç¢¼');
            // é‡æ–°å•Ÿå‹•æ¢ç´¢æ¨¡å¼
            isExploreMode = true;
            loadPopularRoutesBuses();
            return;
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        document.getElementById('stop-list').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <h3>æ­£åœ¨è¼‰å…¥è·¯ç·šè³‡è¨Š...</h3>
            </div>
        `;

        try {
            // 1. æŠ“å–ç«™ç‰Œåˆ—è¡¨ (éœæ…‹è³‡æ–™)
            const stopListInfo = await fetchStops(category, city, route, direction);
            if (!stopListInfo || stopListInfo.length === 0) {
                document.getElementById('stop-list').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>æŸ¥ç„¡æ­¤è·¯ç·š</h3>
                        <p>è«‹ç¢ºèªè·¯ç·šè™Ÿç¢¼æ˜¯å¦æ­£ç¢º</p>
                    </div>
                `;
                return;
            }

            currentStops = stopListInfo;
            renderStops(stopListInfo, route, direction);
            
            // å˜—è©¦ç¹ªè£½è·¯ç·šç·šå‹ï¼ˆå¯é¸åŠŸèƒ½ï¼‰
            try {
                await drawRouteShape(city, route, category);
            } catch (e) {
                console.log('ç„¡æ³•ç¹ªè£½è·¯ç·šç·šå‹:', e);
            }

            // 2. å•Ÿå‹•å®šæ™‚è¼ªè©¢ (æ¯ 20 ç§’å‘¼å«ä¸€æ¬¡ Worker)
            if (pollingTimer) clearInterval(pollingTimer);
            fetchDynamicData(category, city, route, direction);
            pollingTimer = setInterval(() => fetchDynamicData(category, city, route, direction), 20000);
        } catch (err) {
            console.error('å•Ÿå‹•è¿½è¹¤å¤±æ•—:', err);
            document.getElementById('stop-list').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-times-circle"></i>
                    <h3>è¼‰å…¥å¤±æ•—</h3>
                    <p>${err.message}</p>
                </div>
            `;
        }
    }

    // æŠ“å–å‹•æ…‹è³‡æ–™ (å‘¼å« Worker)
    async function fetchDynamicData(category, city, route, direction) {
        document.getElementById('update-status').innerHTML = '<i class="fas fa-sync fa-spin"></i> æ›´æ–°ä¸­...';
        try {
            const url = `${WORKER_URL}?category=${category}&city=${city}&route=${encodeURIComponent(route)}`;
            console.log('ğŸ“¡ æ­£åœ¨ç²å–å‹•æ…‹è³‡æ–™:', url);
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            
            const data = await res.json();
            console.log('ğŸ“¦ æ”¶åˆ°çš„æ•¸æ“š:', data);
            console.log('ğŸšŒ è»Šè¼›æ•¸æ“š:', data.buses);
            console.log('â° åˆ°ç«™æ™‚é–“:', data.estimates);

            // æ›´æ–°åˆ°ç«™æ™‚é–“
            if (data.estimates) {
                updateArrivalTimes(data.estimates, direction);
            } else {
                console.warn('âš ï¸ æ²’æœ‰åˆ°ç«™æ™‚é–“è³‡æ–™');
            }

            // æ›´æ–°è»Šè¼›ä½ç½®
            if (data.buses && data.buses.length > 0) {
                console.log(`âœ… æ‰¾åˆ° ${data.buses.length} å°è»Šè¼›`);
                updateBusPositions(data.buses, direction);
            } else {
                console.warn('âš ï¸ ç›®å‰æ²’æœ‰è»Šè¼›åœ¨ç·šä¸Šé‹è¡Œ');
                document.getElementById('update-status').innerHTML = 
                    `<i class="fas fa-info-circle"></i> ç›®å‰ç„¡è»Šè¼›è³‡æ–™ - ${new Date().toLocaleTimeString('zh-TW')}`;
            }
            
            const now = new Date();
            if (data.buses && data.buses.length > 0) {
                document.getElementById('update-status').innerHTML = 
                    `<i class="fas fa-check-circle"></i> æœ€å¾Œæ›´æ–°: ${now.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit', second: '2-digit'})} | ğŸšŒ ${data.buses.length} å°è»Š`;
            }
        } catch (err) {
            console.error('âŒ å‹•æ…‹è³‡æ–™å–å¾—å¤±æ•—:', err);
            document.getElementById('update-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> é€£ç·šå¤±æ•—';
        }
    }

    function renderStops(stops, routeName, direction) {
        const container = document.getElementById('stop-list');
        const directionText = direction === '0' ? 'å»ç¨‹' : 'è¿”ç¨‹';
        
        container.innerHTML = `
            <div class="route-header">
                <i class="fas fa-route"></i> ${routeName} ${directionText}
                <div style="font-size: 0.9rem; font-weight: 600; margin-top: 4px; opacity: 0.9;">
                    å…± ${stops.length} ç«™
                </div>
            </div>
        `;
        
        // æ¸…é™¤åœ°åœ–èˆŠ Marker
        stopMarkers.forEach(m => map.removeLayer(m));
        stopMarkers = [];

        stops.forEach((stop, index) => {
            const div = document.createElement('div');
            div.className = 'stop-item';
            div.id = `stop-${stop.uid}`;
            div.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <span class="stop-sequence">${index + 1}</span>
                    <span class="stop-name">${stop.name}</span>
                </div>
                <span class="arrival-time time-none">è®€å–ä¸­</span>
            `;
            container.appendChild(div);

            // åŠ åˆ°åœ°åœ–
            const marker = L.circleMarker([stop.lat, stop.lon], { 
                radius: 7, 
                color: '#667eea',
                fillColor: '#667eea',
                fillOpacity: 0.8,
                weight: 2
            })
                .bindPopup(`<b>${index + 1}. ${stop.name}</b><br><small>é»æ“ŠæŸ¥çœ‹ç¶“éè·¯ç·š</small>`)
                .addTo(map);
            
            // ç¶å®šé»æ“Šäº‹ä»¶ï¼šæŸ¥è©¢ç¶“éæ­¤ç«™çš„æ‰€æœ‰è·¯ç·š
            marker.on('click', async () => {
                marker.bindPopup('<div class="popup-loading"><i class="fas fa-spinner fa-spin"></i><br>æŸ¥è©¢è·¯ç·šä¸­...</div>').openPopup();
                
                const city = document.getElementById('city').value;
                const category = document.getElementById('category').value;
                
                try {
                    const routes = await fetchStopRoutes(city, stop.name, category);
                    
                    let popupContent = `
                        <div style="min-width: 220px;">
                            <div class="popup-stop-title">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${stop.name}</span>
                            </div>
                            <hr style="margin: 10px 0; border: none; border-top: 2px solid #e5e7eb;">
                            <div style="font-weight: 700; font-size: 0.95rem; color: #6b7280; margin-bottom: 6px;">
                                <i class="fas fa-bus"></i> ç¶“éçš„è·¯ç·š (${routes.length})
                            </div>
                            <div class="popup-routes-container">
                    `;
                    
                    if (routes.length === 0) {
                        popupContent += `
                            <div style="color: #9ca3af; text-align: center; padding: 20px; width: 100%;">
                                <i class="fas fa-info-circle"></i><br>
                                æš«ç„¡è·¯ç·šè³‡æ–™
                            </div>
                        `;
                    } else {
                        routes.forEach(routeName => {
                            popupContent += `
                                <span class="popup-route-badge" 
                                      onclick="switchToRoute('${routeName.replace(/'/g, "\\'")}')"
                                      title="é»æ“Šåˆ‡æ›åˆ° ${routeName} è·¯ç·š">
                                    ${routeName}
                                </span>
                            `;
                        });
                    }
                    
                    popupContent += `
                            </div>
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 0.75rem; color: #9ca3af; text-align: center;">
                                ğŸ’¡ é»æ“Šè·¯ç·šè™Ÿç¢¼å¯å¿«é€Ÿåˆ‡æ›
                            </div>
                        </div>
                    `;
                    
                    marker.setPopupContent(popupContent);
                } catch (e) {
                    console.error('æŸ¥è©¢è·¯ç·šå¤±æ•—:', e);
                    marker.setPopupContent(`
                        <div class="popup-error">
                            <i class="fas fa-times-circle"></i><br>
                            ç„¡æ³•å–å¾—è·¯ç·šè³‡è¨Š<br>
                            <small>${e.message}</small>
                        </div>
                    `);
                }
            });
            
            stopMarkers.push(marker);
        });

        // èª¿æ•´åœ°åœ–è¦–è§’ä»¥é¡¯ç¤ºæ‰€æœ‰ç«™ç‰Œ
        if (stops.length > 0) {
            const bounds = L.latLngBounds(stops.map(s => [s.lat, s.lon]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    function updateArrivalTimes(estimates, direction) {
        // å…ˆå°‡æ‰€æœ‰ç«™ç‰Œè¨­ç‚ºç„¡è³‡æ–™
        currentStops.forEach(stop => {
            const el = document.querySelector(`#stop-${stop.uid} .arrival-time`);
            if (el) {
                el.innerText = 'æœªç™¼è»Š';
                el.className = 'arrival-time time-none';
            }
        });

        // æ›´æ–°æœ‰è³‡æ–™çš„ç«™ç‰Œ
        for (const [key, value] of Object.entries(estimates)) {
            const [dir, stopUID] = key.split('_');
            if (dir !== direction) continue;

            const el = document.querySelector(`#stop-${stopUID} .arrival-time`);
            if (!el) continue;

            let text = '';
            let statusClass = 'time-wait';

            if (value.sec === null || value.sec === undefined) {
                text = (value.status === 1) ? 'æœªç™¼è»Š' : 'æœ«ç­å·²é';
                statusClass = 'time-none';
            } else if (value.sec < 60) {
                text = 'é€²ç«™ä¸­';
                statusClass = 'time-now';
            } else if (value.sec < 180) {
                text = 'å°‡åˆ°ç«™';
                statusClass = 'time-soon';
            } else {
                const mins = Math.floor(value.sec / 60);
                text = `${mins} åˆ†`;
                statusClass = 'time-wait';
            }

            el.innerText = text;
            el.className = `arrival-time ${statusClass}`;
        }
    }

    /**
     * æ›´æ–°å…¬è»Šä½ç½®ï¼ˆå‡ç´šç‰ˆï¼‰- ç”¨æ–¼å–®ä¸€è·¯ç·šæ¨¡å¼
     * 
     * æ–°åŠŸèƒ½ï¼š
     * - å¸¶æ–¹å‘ç®­é ­çš„æ—‹è½‰åœ–æ¨™ï¼ˆæ ¹æ“šæ–¹ä½è§’ azi è‡ªå‹•æ—‹è½‰ï¼‰
     * - è»Šç‰Œæ¨™ç±¤é¡¯ç¤ºåœ¨åœ–æ¨™ä¸‹æ–¹
     * - ç²¾ç¾çš„è©³ç´°è³‡è¨Šå½ˆçª—
     * 
     * @param {Array} buses - å…¬è»Šä½ç½®é™£åˆ—
     * @param {string} direction - ç•¶å‰é¸æ“‡çš„æ–¹å‘ï¼ˆå»ç¨‹/è¿”ç¨‹ï¼‰
     */
    function updateBusPositions(buses, direction) {
        // åªåœ¨å–®ä¸€è·¯ç·šæ¨¡å¼ä¸‹é‹ä½œ
        if (isExploreMode) return;
        
        console.log('ğŸšŒ é–‹å§‹æ›´æ–°è»Šè¼›ä½ç½®ï¼ˆå–®ä¸€è·¯ç·šæ¨¡å¼ï¼‰');
        console.log('   ç¸½è»Šè¼›æ•¸:', buses ? buses.length : 0);
        console.log('   ç¯©é¸æ–¹å‘:', direction === '0' ? 'å»ç¨‹' : 'è¿”ç¨‹');
        
        // æ¸…é™¤èˆŠçš„è»Šè¼›æ¨™è¨˜
        busMarkers.forEach(m => map.removeLayer(m));
        busMarkers = [];

        if (!buses || buses.length === 0) {
            console.warn('âš ï¸ æ²’æœ‰è»Šè¼›è³‡æ–™');
            return;
        }

        // ç¯©é¸ç¬¦åˆæ–¹å‘çš„è»Šè¼›
        const filteredBuses = buses.filter(b => b.dir == direction);
        console.log(`   ç¬¦åˆæ–¹å‘çš„è»Šè¼›: ${filteredBuses.length} å°`);

        if (filteredBuses.length === 0) {
            console.warn('âš ï¸ è©²æ–¹å‘ç›®å‰æ²’æœ‰è»Šè¼›é‹è¡Œ');
            return;
        }

        // ç²å–ç•¶å‰è·¯ç·šå’ŒåŸå¸‚
        const route = document.getElementById('routeNum').value.trim();
        const city = document.getElementById('city').value;

        filteredBuses.forEach((bus, index) => {
            console.log(`   è»Šè¼› ${index + 1}:`, {
                è»Šç‰Œ: bus.plate,
                ç·¯åº¦: bus.lat,
                ç¶“åº¦: bus.lon,
                æ–¹ä½è§’: bus.azi,
                æ–¹å‘: bus.dir === 0 ? 'å»ç¨‹' : 'è¿”ç¨‹'
            });

            createBusMarker(bus, route, city, false);
        });

        console.log(`âœ… å·²åœ¨åœ°åœ–ä¸Šæ¨™è¨˜ ${filteredBuses.length} å°è»Šè¼›`);
    }
    
    /**
     * å°‡æ–¹ä½è§’è½‰æ›ç‚ºæ–¹å‘æ–‡å­—
     * @param {number} azimuth - æ–¹ä½è§’ (0-360åº¦)
     * @returns {string} æ–¹å‘æ–‡å­—
     */
    function getDirectionName(azimuth) {
        const directions = [
            { name: 'æ­£åŒ— â¬†ï¸', min: 0, max: 22.5 },
            { name: 'æ±åŒ— â†—ï¸', min: 22.5, max: 67.5 },
            { name: 'æ­£æ± â¡ï¸', min: 67.5, max: 112.5 },
            { name: 'æ±å— â†˜ï¸', min: 112.5, max: 157.5 },
            { name: 'æ­£å— â¬‡ï¸', min: 157.5, max: 202.5 },
            { name: 'è¥¿å— â†™ï¸', min: 202.5, max: 247.5 },
            { name: 'æ­£è¥¿ â¬…ï¸', min: 247.5, max: 292.5 },
            { name: 'è¥¿åŒ— â†–ï¸', min: 292.5, max: 337.5 },
            { name: 'æ­£åŒ— â¬†ï¸', min: 337.5, max: 360 }
        ];
        
        for (const dir of directions) {
            if (azimuth >= dir.min && azimuth < dir.max) {
                return dir.name;
            }
        }
        
        return 'æœªçŸ¥æ–¹å‘';
    }

    // è¼”åŠ©å‡½å¼ï¼šæŠ“å–ç«™ç‰Œ (é€é Worker)
    async function fetchStops(category, city, route, direction) {
        try {
            const url = `${WORKER_URL}?action=info&category=${category}&city=${city}&route=${encodeURIComponent(route)}`;
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error('ç„¡æ³•å–å¾—è·¯ç·šè³‡è¨Šï¼Œè«‹æª¢æŸ¥ Worker è¨­å®š');
            }
            
            const data = await res.json();
            
            // è™•ç†ä¸åŒçš„å›å‚³æ ¼å¼
            let routeInfo;
            if (Array.isArray(data)) {
                routeInfo = data.find(r => r.Direction == direction);
            } else if (data.Direction !== undefined) {
                routeInfo = data.Direction == direction ? data : null;
            }
            
            if (!routeInfo || !routeInfo.Stops) {
                throw new Error('æŸ¥ç„¡æ­¤æ–¹å‘çš„è·¯ç·šè³‡æ–™');
            }
            
            return routeInfo.Stops.map(s => ({
                uid: s.StopUID,
                name: s.StopName?.Zh_tw || s.StopName,
                lat: s.StopPosition?.PositionLat || s.StopPosition?.Lat,
                lon: s.StopPosition?.PositionLon || s.StopPosition?.Lon
            }));
        } catch (e) {
            console.error('å–å¾—ç«™ç‰Œå¤±æ•—:', e);
            throw new Error('ç„¡æ³•å–å¾—ç«™ç‰Œè³‡è¨Šï¼Œè«‹ç¢ºèª Worker æ˜¯å¦æ”¯æ´ action=info åƒæ•¸');
        }
    }

    // æŸ¥è©¢ç«™ç‰Œæœ‰å“ªäº›è·¯ç·šç¶“é
    async function fetchStopRoutes(city, stopName, category) {
        try {
            const url = `${WORKER_URL}?action=stop_info&city=${city}&name=${encodeURIComponent(stopName)}`;
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            
            const data = await res.json();
            return data.routes || [];
        } catch (e) {
            console.error('å–å¾—ç«™ç‰Œè·¯ç·šå¤±æ•—:', e);
            return [];
        }
    }
    
    /**
     * ç¹ªè£½è·¯ç·šç·šå‹åœ¨åœ°åœ–ä¸Š
     * 
     * æœƒè‡ªå‹•è™•ç†ä»¥ä¸‹æƒ…æ³ï¼š
     * - TDX å›å‚³å¤šå€‹æ–¹å‘ï¼ˆå»ç¨‹/è¿”ç¨‹ï¼‰æ™‚ï¼Œè‡ªå‹•é¸æ“‡ç•¶å‰æ–¹å‘
     * - æ”¯æ´ Geometry (WKT) å’Œ EncodedPolyline å…©ç¨®æ ¼å¼
     * - ç”¨æ¼¸å±¤è—ç´«è‰²ç¹ªè£½è·¯ç·šï¼Œå¢åŠ è™›ç·šæ•ˆæœæå‡è¾¨è­˜åº¦
     * 
     * @param {string} city - åŸå¸‚ä»£ç¢¼ (å¦‚ 'Taipei')
     * @param {string} route - è·¯ç·šç·¨è™Ÿ (å¦‚ '307')
     * @param {string} category - é¡åˆ¥ ('CityBus' æˆ– 'InterCity')
     */
    async function drawRouteShape(city, route, category) {
        // æ¸…é™¤èˆŠçš„è·¯ç·š
        if (currentRouteLine) {
            map.removeLayer(currentRouteLine);
            currentRouteLine = null;
        }
        
        try {
            const url = `${WORKER_URL}?action=shape&city=${city}&route=${encodeURIComponent(route)}&category=${category}`;
            const res = await fetch(url);
            
            if (!res.ok) {
                console.log('âš ï¸ ç„¡æ³•å–å¾—è·¯ç·šç·šå‹è³‡æ–™ (HTTP ' + res.status + ')');
                return;
            }
            
            const data = await res.json();
            
            if (!data || data.length === 0) {
                console.log('âš ï¸ æ­¤è·¯ç·šæ²’æœ‰æä¾›ç·šå‹è³‡æ–™');
                return;
            }
            
            // è™•ç†å¯èƒ½æœ‰å¤šå€‹æ–¹å‘çš„ç·šå‹ï¼ˆå»/è¿”ç¨‹ï¼‰
            const direction = document.getElementById('direction').value;
            let targetRoute = null;
            
            // å˜—è©¦æ‰¾åˆ°å°æ‡‰æ–¹å‘çš„ç·šå‹
            if (data.length > 1) {
                targetRoute = data.find(item => item.Direction == direction) || data[0];
            } else {
                targetRoute = data[0];
            }
            
            if (!targetRoute) return;
            
            // ä½¿ç”¨æ™ºèƒ½è§£æå™¨ï¼ˆè‡ªå‹•åˆ¤æ–·æ˜¯ Geometry é‚„æ˜¯ EncodedPolylineï¼‰
            const coordinates = parseRouteGeometry(targetRoute);
            
            if (coordinates.length > 0) {
                console.log(`âœ… æˆåŠŸè§£æè·¯ç·šç·šå‹ï¼Œå…± ${coordinates.length} å€‹åº§æ¨™é»`);
                
                currentRouteLine = L.polyline(coordinates, { 
                    color: '#667eea',        // è—ç´«è‰²
                    weight: 5,               // ç·šæ¢ç²—ç´°
                    opacity: 0.7,            // é€æ˜åº¦
                    dashArray: '10, 5',      // è™›ç·šæ¨£å¼
                    lineJoin: 'round',       // åœ“è§’
                    lineCap: 'round'         // ç«¯é»åœ“è§’
                }).addTo(map);
                
                console.log('ğŸ—ºï¸ è·¯ç·šå·²ç¹ªè£½åˆ°åœ°åœ–ä¸Š');
            } else {
                console.warn('âš ï¸ åº§æ¨™è§£æçµæœç‚ºç©º');
            }
        } catch (e) {
            console.error('âŒ ç¹ªè£½è·¯ç·šå¤±æ•—:', e);
        }
    }
    
    // ============================================
    // ğŸ“ åº§æ¨™æ ¼å¼è§£æå™¨
    // ============================================
    
    /**
     * è§£æ TDX API å›å‚³çš„è·¯ç·šåº§æ¨™
     * 
     * TDX æä¾›å…©ç¨®åº§æ¨™æ ¼å¼ï¼š
     * 1. Geometry (WKTæ ¼å¼): "LINESTRING (121.5 25.0, 121.51 25.01, ...)"
     *    - å„ªé»ï¼šäººé¡å¯è®€ï¼Œå®¹æ˜“é™¤éŒ¯
     *    - ç¼ºé»ï¼šè³‡æ–™é‡è¼ƒå¤§
     * 
     * 2. EncodedPolyline (Googleå£“ç¸®æ ¼å¼): "afpVwCwahdV..."
     *    - å„ªé»ï¼šè³‡æ–™é‡å°ï¼Œç¯€çœæµé‡
     *    - ç¼ºé»ï¼šéœ€è¦è§£ç¢¼ï¼Œçœ‹èµ·ä¾†åƒäº‚ç¢¼
     * 
     * æœ¬å‡½å¼å„ªå…ˆä½¿ç”¨ Geometryï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å˜—è©¦è§£ç¢¼ EncodedPolyline
     */
    function parseRouteGeometry(routeData) {
        // å„ªå…ˆä½¿ç”¨ Geometry (WKT æ ¼å¼)
        if (routeData.Geometry) {
            return parseWktLineString(routeData.Geometry);
        }
        
        // å‚™ç”¨æ–¹æ¡ˆï¼šè§£ç¢¼ EncodedPolyline
        if (routeData.EncodedPolyline) {
            return decodePolyline(routeData.EncodedPolyline);
        }
        
        console.warn('è·¯ç·šè³‡æ–™ä¸­æ²’æœ‰æ‰¾åˆ° Geometry æˆ– EncodedPolyline');
        return [];
    }
    
    /**
     * è§£æ WKT LINESTRING æ ¼å¼ï¼ˆå„ªåŒ–ç‰ˆï¼‰
     * 
     * WKT ç¯„ä¾‹: "LINESTRING (121.565 25.065, 121.566 25.066, ...)"
     * æ¯å€‹åº§æ¨™å°æ˜¯ "ç¶“åº¦ ç·¯åº¦" çš„æ ¼å¼
     */
    function parseWktLineString(wkt) {
        try {
            if (!wkt || typeof wkt !== 'string') return [];
            
            // æ”¯æ´å¤šç¨® WKT æ ¼å¼: LINESTRING, MULTILINESTRING
            let coordString = wkt;
            
            // è™•ç† LINESTRING
            if (wkt.toUpperCase().includes('LINESTRING')) {
                coordString = wkt.replace(/.*LINESTRING\s*\(/i, "").replace(/\)[^)]*$/, "").trim();
            }
            
            // è™•ç† MULTILINESTRING (å–ç¬¬ä¸€æ®µ)
            if (wkt.toUpperCase().includes('MULTILINESTRING')) {
                const match = wkt.match(/\(\(([^)]+)\)\)/);
                if (match) coordString = match[1];
            }
            
            // è§£æåº§æ¨™å°
            const pairs = coordString.split(",").map(p => p.trim()).filter(p => p);
            
            return pairs.map(pair => {
                // æ”¯æ´ç©ºæ ¼æˆ– tab åˆ†éš”
                const coords = pair.trim().split(/\s+/);
                if (coords.length >= 2) {
                    const lon = parseFloat(coords[0]);
                    const lat = parseFloat(coords[1]);
                    // é©—è­‰ç¶“ç·¯åº¦ç¯„åœï¼ˆå°ç£å€åŸŸï¼šåŒ—ç·¯21-26åº¦ï¼Œæ±ç¶“119-122åº¦ï¼‰
                    if (!isNaN(lat) && !isNaN(lon) && 
                        lat >= 21 && lat <= 26 && 
                        lon >= 119 && lon <= 122) {
                        return [lat, lon]; // Leaflet ä½¿ç”¨ [ç·¯åº¦, ç¶“åº¦] é †åº
                    }
                }
                return null;
            }).filter(coord => coord !== null);
        } catch (e) {
            console.error('âŒ è§£æ WKT å¤±æ•—:', e);
            console.log('ğŸ“„ åŸå§‹è³‡æ–™å‰100å­—:', wkt?.substring(0, 100));
            return [];
        }
    }
    
    /**
     * è§£ç¢¼ Google EncodedPolyline æ ¼å¼ï¼ˆé¸ç”¨ï¼‰
     * 
     * EncodedPolyline ç¯„ä¾‹: "afpVwCwahdV~iB..." (çœ‹èµ·ä¾†åƒäº‚ç¢¼)
     * é€™æ˜¯ Google Maps çš„åº§æ¨™å£“ç¸®æ¼”ç®—æ³•ï¼Œå¯å¤§å¹…æ¸›å°‘è³‡æ–™å‚³è¼¸é‡
     * 
     * å¦‚æœéœ€è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè«‹åœ¨ HTML head ä¸­å¼•å…¥è§£ç¢¼åº«ï¼š
     * <script src="https:\/\/unpkg.com\/@mapbox\/polyline@1.1.1\/src\/polyline.js"><\/script>
     */
    function decodePolyline(encoded) {
        try {
            // æª¢æŸ¥æ˜¯å¦æœ‰å¼•å…¥ polyline è§£ç¢¼åº«
            if (typeof polyline !== 'undefined' && polyline.decode) {
                const decoded = polyline.decode(encoded);
                console.log('âœ… æˆåŠŸè§£ç¢¼ EncodedPolylineï¼Œå…±', decoded.length, 'å€‹åº§æ¨™é»');
                return decoded; // å·²ç¶“æ˜¯ [lat, lon] æ ¼å¼
            }
            
            // æ‰‹å‹•è§£ç¢¼å¯¦ä½œï¼ˆç°¡åŒ–ç‰ˆï¼‰
            console.warn('âš ï¸ æœªæ‰¾åˆ° polyline è§£ç¢¼åº«ï¼Œä½¿ç”¨æ‰‹å‹•è§£ç¢¼');
            return decodePolylineManual(encoded);
        } catch (e) {
            console.error('âŒ è§£ç¢¼ EncodedPolyline å¤±æ•—:', e);
            return [];
        }
    }
    
    /**
     * æ‰‹å‹•å¯¦ä½œ EncodedPolyline è§£ç¢¼ï¼ˆä¸ä¾è³´å¤–éƒ¨åº«ï¼‰
     * åŸºæ–¼ Google Polyline Algorithm
     */
    function decodePolylineManual(encoded) {
        const coordinates = [];
        let index = 0;
        let lat = 0;
        let lng = 0;

        while (index < encoded.length) {
            let shift = 0;
            let result = 0;
            let byte;

            // è§£ç¢¼ç·¯åº¦
            do {
                byte = encoded.charCodeAt(index++) - 63;
                result |= (byte & 0x1f) << shift;
                shift += 5;
            } while (byte >= 0x20);
            const deltaLat = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lat += deltaLat;

            shift = 0;
            result = 0;

            // è§£ç¢¼ç¶“åº¦
            do {
                byte = encoded.charCodeAt(index++) - 63;
                result |= (byte & 0x1f) << shift;
                shift += 5;
            } while (byte >= 0x20);
            const deltaLng = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lng += deltaLng;

            coordinates.push([lat / 1e5, lng / 1e5]);
        }

        return coordinates;
    }
    
    // åˆ‡æ›åˆ°æŒ‡å®šè·¯ç·šï¼ˆå¾ç«™ç‰Œ popup é»æ“Šè·¯ç·šæ™‚è§¸ç™¼ï¼‰
    window.switchToRoute = function(routeName) {
        document.getElementById('routeNum').value = routeName;
        startTracking();
    };
    
    // é é¢è¼‰å…¥å®Œæˆå¾Œçš„è™•ç†
    window.addEventListener('beforeunload', () => {
        if (pollingTimer) clearInterval(pollingTimer);
    });
</script>

</body>
</html>
