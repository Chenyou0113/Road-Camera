<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地震監測中心</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --main-red: #d32f2f; --main-blue: #1976d2; --main-bg: #f5f5f5; --card-bg: #ffffff; --text-dark: #333; }
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: var(--main-bg); color: var(--text-dark); margin: 0; padding-bottom: 50px; }
        
        /* 標題列 */
        .header { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; align-items: center; justify-content: space-between; max-width: 1000px; margin: 0 auto; }
        .header-title { font-size: 1.4rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .back-btn { color: white; text-decoration: none; font-size: 1.2rem; cursor: pointer; }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* 同步按鈕 */
        .sync-section { text-align: center; margin-bottom: 20px; }
        .sync-btn {
            padding: 10px 25px; background: #2e7d32; color: white; border: none; border-radius: 25px;
            cursor: pointer; font-size: 1rem; font-weight: bold; display: inline-flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        .sync-btn:active { transform: scale(0.95); }

        /* 列表樣式 */
        .report-list { list-style: none; padding: 0; margin: 0; }
        
        .report-card { 
            background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            margin-bottom: 20px; overflow: hidden; border-left: 6px solid #ccc; 
            transition: transform 0.2s;
        }
        .report-card:hover { transform: translateY(-3px); }

        /* 類型區分 */
        .type-sig { border-left-color: var(--main-red); } /* 顯著有感 */
        .type-micro { border-left-color: var(--main-blue); } /* 小區域 */

        .card-header { 
            padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #eee;
        }
        .bg-sig { background-color: rgba(211, 47, 47, 0.1); color: var(--main-red); }
        .bg-micro { background-color: rgba(25, 118, 210, 0.1); color: var(--main-blue); }
        
        .header-tag { font-weight: bold; font-size: 0.9rem; padding: 4px 10px; border-radius: 20px; }
        .report-id { font-family: monospace; color: #666; font-size: 0.9rem; }

        .card-body { padding: 20px; }
        
        .main-info { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .magnitude-box { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 70px; height: 70px; border-radius: 50%; border: 4px solid #eee;
            font-weight: 800; font-size: 1.8rem; line-height: 1;
        }
        .mag-sig { border-color: var(--main-red); color: var(--main-red); }
        .mag-micro { border-color: var(--main-blue); color: var(--main-blue); }
        
        .time-loc { flex: 1; }
        .time { font-size: 1.1rem; font-weight: bold; margin-bottom: 4px; color: #333; }
        .location { font-size: 0.95rem; color: #666; display: flex; align-items: center; gap: 5px; }

        .detail-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 15px;
        }
        .detail-item { font-size: 0.9rem; color: #555; }
        .detail-item span { font-weight: bold; color: #333; }

        .btn-link {
            display: block; text-align: center; padding: 10px; 
            background: #f0f0f0; color: #333; text-decoration: none; 
            border-radius: 8px; font-weight: 600; transition: background 0.2s;
        }
        .btn-link:hover { background: #e0e0e0; }

        /* 載入狀態 */
        .no-data { text-align: center; padding: 50px; color: #888; }
        
        /* 圖片容器 */
        .map-box { margin-top: 15px; text-align: center; }
        .map-box img { max-width: 100%; border-radius: 8px; border: 1px solid #ddd; }
        .intensity-box { margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
            <div class="header-title"><i class="fas fa-house-damage"></i> 地震監測中心</div>
        </div>
    </div>

    <div class="container">
        <div class="sync-section">
            <button class="sync-btn" id="manualSyncBtn" onclick="manualSyncAndFetch()">
                <i class="fas fa-sync-alt"></i> 手動同步最新報告
            </button>
        </div>

        <ul id="reports-list" class="report-list">
            <div class="no-data">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p style="margin-top: 10px;">載入地震資料中...</p>
            </div>
        </ul>
    </div>

    <script>
        const WORKER_URL = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev';

        document.addEventListener('DOMContentLoaded', fetchCombinedReports);

        // 手動同步功能
        async function manualSyncAndFetch() {
            const btn = document.getElementById('manualSyncBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 同步中...';

            try {
                const syncResponse = await fetch(`${WORKER_URL}/api/sync/reports`);
                if (!syncResponse.ok) throw new Error('Sync failed');
                
                await fetchCombinedReports();
                btn.innerHTML = '<i class="fas fa-check"></i> 同步完成';
            } catch (e) {
                console.error(e);
                alert('同步失敗，請稍後再試');
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 同步失敗';
            } finally {
                setTimeout(() => { 
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> 手動同步最新報告'; 
                }, 3000);
            }
        }

        // 核心查詢：呼叫綜合路由 (Combined)
        async function fetchCombinedReports() {
            const list = document.getElementById('reports-list');
            
            try {
                // 直接呼叫 Worker 的綜合查詢路由
                const response = await fetch(`${WORKER_URL}/api/report/combined?top=20`);
                if (!response.ok) throw new Error("API Error");
                
                const reports = await response.json();

                if (!reports || reports.length === 0) {
                    list.innerHTML = '<div class="no-data"><i class="fas fa-info-circle fa-2x"></i><p style="margin-top:10px;">目前無任何地震資料，請點擊同步按鈕。</p></div>';
                    return;
                }

                list.innerHTML = '';
                reports.forEach(report => renderCard(report));

            } catch (error) {
                console.error(error);
                list.innerHTML = '<div class="no-data" style="color:red;"><i class="fas fa-times-circle fa-2x"></i><p>資料載入失敗</p></div>';
            }
        }

        function renderCard(report) {
            const list = document.getElementById('reports-list');
            const card = document.createElement('li');
            
            // 判斷類型 (Worker 回傳 IsSignificant: 1 or 0)
            const isSig = report.IsSignificant === 1;
            const mag = parseFloat(report.Magnitude).toFixed(1);
            const time = new Date(report.Time).toLocaleString('zh-TW', {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });

            card.className = `report-card ${isSig ? 'type-sig' : 'type-micro'}`;

            card.innerHTML = `
                <div class="card-header ${isSig ? 'bg-sig' : 'bg-micro'}">
                    <span class="header-tag">${isSig ? '顯著有感' : '小區域'}</span>
                    <span class="report-id">#${report.ReportID}</span>
                </div>
                <div class="card-body">
                    <div class="main-info">
                        <div class="magnitude-box ${isSig ? 'mag-sig' : 'mag-micro'}">${mag}</div>
                        <div class="time-loc">
                            <div class="time">${time}</div>
                            <div class="location"><i class="fas fa-map-marker-alt"></i> ${report.Location}</div>
                        </div>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-item">深度：<span>${report.Depth} km</span></div>
                        <div class="detail-item">編號：<span>${report.ReportID}</span></div>
                    </div>

                    <a href="${report.ReportURL}" target="_blank" class="btn-link">
                        查看 CWA 官方報告 <i class="fas fa-external-link-alt"></i>
                    </a>
                    
                    ${isSig ? `
                    <div class="map-box" id="map-${report.ReportID}">
                        <i class="fas fa-spinner fa-spin"></i> 載入等震圖...
                    </div>` : ''}
                </div>
            `;
            list.appendChild(card);
            
            // 只有顯著有感才去抓圖，避免浪費資源
            if (isSig) {
                fetchMapImage(report.ReportID);
            }
        }
        
        async function fetchMapImage(reportID) {
            // 這裡簡單模擬抓取，實際應呼叫 Worker 的 E-A0015-003 API
            const box = document.getElementById(`map-${reportID}`);
            try {
                const res = await fetch(`${WORKER_URL}?dataset=E-A0015-003`);
                const data = await res.json();
                const imgUrl = data.cwaopendata?.dataset?.resource?.uri;
                
                if (imgUrl) {
                    box.innerHTML = `<img src="${imgUrl}" alt="等震圖">`;
                } else {
                    box.style.display = 'none';
                }
            } catch(e) {
                box.style.display = 'none';
            }
        }
    </script>
</body>
</html>
