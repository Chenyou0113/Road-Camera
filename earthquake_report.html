<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地震監測中心 | Earthquake Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --main-red: #d32f2f; 
            --main-blue: #1976d2; 
            --main-bg: #f5f5f5; 
            --card-bg: #ffffff; 
            --text-dark: #333; 
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif;
            background-color: var(--main-bg); 
            color: var(--text-dark); 
            margin: 0; 
            padding-bottom: 50px; 
        }
        
        /* 標題列 */
        .header { 
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); 
            color: white; 
            padding: 15px 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); 
            position: sticky; top: 0; z-index: 100; 
        }
        .header-content { display: flex; align-items: center; justify-content: space-between; max-width: 1000px; margin: 0 auto; }
        .header-title { font-size: 1.4rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .back-btn { color: white; text-decoration: none; font-size: 1.2rem; cursor: pointer; }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* 同步按鈕區塊 */
        .sync-section { 
            text-align: center; 
            margin-bottom: 20px; 
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .sync-btn {
            padding: 10px 25px; background: #2e7d32; color: white; border: none; border-radius: 25px;
            cursor: pointer; font-size: 1rem; font-weight: bold; display: inline-flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        .sync-btn:active { transform: scale(0.95); }
        .sync-hint { display: block; font-size: 0.85rem; color: #666; margin-top: 8px; }

        /* 列表樣式 */
        .report-list { list-style: none; padding: 0; margin: 0; }
        
        .report-card { 
            background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            margin-bottom: 20px; overflow: hidden; border-left: 6px solid #ccc; 
            transition: transform 0.2s;
        }
        .report-card:hover { transform: translateY(-3px); }

        /* 類型區分 */
        .type-sig { border-left-color: var(--main-red); } /* 顯著有感 */
        .type-micro { border-left-color: var(--main-blue); } /* 小區域 */

        .card-header { 
            padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #eee;
        }
        /* 動態背景色由 JS 控制 */
        
        .header-tag { font-weight: bold; font-size: 0.9rem; padding: 4px 10px; border-radius: 20px; background: rgba(255,255,255,0.9); }
        .report-id { font-family: monospace; color: rgba(255,255,255,0.9); font-size: 0.9rem; }

        .card-body { padding: 20px; }
        
        .main-info { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .magnitude-box { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 70px; height: 70px; border-radius: 50%; border: 4px solid #eee;
            font-weight: 800; font-size: 1.8rem; line-height: 1;
        }
        .mag-sig { border-color: var(--main-red); color: var(--main-red); }
        .mag-micro { border-color: var(--main-blue); color: var(--main-blue); }
        
        .time-loc { flex: 1; }
        .time { font-size: 1.1rem; font-weight: bold; margin-bottom: 4px; color: #333; }
        .location { font-size: 0.95rem; color: #666; display: flex; align-items: center; gap: 5px; }

        .detail-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 15px;
        }
        .detail-item { font-size: 0.9rem; color: #555; }
        .detail-item span { font-weight: bold; color: #333; }

        .btn-link {
            display: block; text-align: center; padding: 10px; 
            background: #f0f0f0; color: #333; text-decoration: none; 
            border-radius: 8px; font-weight: 600; transition: background 0.2s;
        }
        .btn-link:hover { background: #e0e0e0; }

        /* 載入狀態 */
        .no-data { text-align: center; padding: 50px; color: #888; }
        
        /* 圖片容器 */
        .map-box { margin-top: 15px; text-align: center; min-height: 100px; display: flex; align-items: center; justify-content: center; background: #fafafa; border-radius: 8px;}
        .map-box img { max-width: 100%; border-radius: 8px; border: 1px solid #ddd; }
        .intensity-box { margin-top: 10px; font-size: 0.9rem; }
        
        /* 錯誤訊息 */
        .error-msg { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 20px; display: none; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回</a>
            <div class="header-title"><i class="fas fa-house-damage"></i> 地震監測中心</div>
        </div>
    </div>

    <div class="container">
        
        <div id="error-display" class="error-msg"></div>

        <div class="sync-section">
            <button class="sync-btn" id="manualSyncBtn" onclick="manualSyncAndFetch()">
                <i class="fas fa-sync-alt"></i> 手動同步報告
            </button>
            <span class="sync-hint">若資料未更新，請點擊按鈕強制同步。</span>
        </div>

        <ul id="reports-list" class="report-list">
            <div class="no-data">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p style="margin-top: 10px;">正在連線至 CWA Worker...</p>
            </div>
        </ul>
    </div>

    <script>
        // 設定您的 Worker 網址
        const WORKER_URL = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev';

        document.addEventListener('DOMContentLoaded', () => {
            fetchCombinedReports();
        });

        // 手動同步功能
        async function manualSyncAndFetch() {
            const btn = document.getElementById('manualSyncBtn');
            const errDisplay = document.getElementById('error-display');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 同步中...';
            errDisplay.style.display = 'none';

            try {
                // 1. 呼叫 Worker 的手動同步路由
                const syncResponse = await fetch(`${WORKER_URL}/api/sync/reports`);
                
                if (!syncResponse.ok) {
                    throw new Error(`同步失敗 (HTTP ${syncResponse.status})`);
                }
                
                const resultText = await syncResponse.text();
                console.log("Sync Result:", resultText);

                // 2. 同步成功後，重新查詢資料
                await fetchCombinedReports();
                
                btn.innerHTML = '<i class="fas fa-check-circle"></i> 同步完成';
                btn.style.backgroundColor = '#4caf50';

            } catch (e) {
                console.error(e);
                errDisplay.textContent = `同步失敗：${e.message}。請檢查 Worker 是否正常運作。`;
                errDisplay.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 同步失敗';
                btn.style.backgroundColor = '#d32f2f';
            } finally {
                setTimeout(() => { 
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> 手動同步報告'; 
                    btn.style.backgroundColor = '#2e7d32';
                }, 3000);
            }
        }

        // 核心查詢：呼叫綜合路由 (Combined)
        async function fetchCombinedReports() {
            const list = document.getElementById('reports-list');
            
            try {
                // 直接呼叫 Worker 的綜合查詢路由
                const response = await fetch(`${WORKER_URL}/api/report/combined?top=20`);
                
                if (!response.ok) {
                    throw new Error(`API Error ${response.status}`);
                }
                
                const reports = await response.json();

                if (!reports || reports.length === 0) {
                    list.innerHTML = `
                        <div class="no-data">
                            <i class="fas fa-info-circle fa-2x" style="color:#ff9800"></i>
                            <p style="margin-top:10px;">目前資料庫無地震資料。</p>
                            <p style="font-size:0.9rem; color:#666;">請點擊上方的「手動同步」按鈕。</p>
                        </div>`;
                    return;
                }

                list.innerHTML = '';
                reports.forEach(report => renderCard(report));

            } catch (error) {
                console.error(error);
                list.innerHTML = `
                    <div class="no-data" style="color:#d32f2f;">
                        <i class="fas fa-times-circle fa-2x"></i>
                        <p style="margin-top:10px;">無法讀取資料</p>
                        <p style="font-size:0.8rem;">${error.message}</p>
                    </div>`;
            }
        }

        function renderCard(report) {
            const list = document.getElementById('reports-list');
            const card = document.createElement('li');
            
            // 判斷類型 (Worker 回傳 IsSignificant: 1 or 0)
            const isSig = report.IsSignificant === 1;
            const mag = parseFloat(report.Magnitude).toFixed(1);
            const time = new Date(report.Time).toLocaleString('zh-TW', {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });

            card.className = `report-card ${isSig ? 'type-sig' : 'type-micro'}`;
            const headerBg = isSig ? '#d32f2f' : '#1976d2';

            card.innerHTML = `
                <div class="card-header" style="background-color: ${headerBg}; color: white;">
                    <span class="header-tag" style="color: ${headerBg};">${isSig ? '顯著有感' : '小區域'}</span>
                    <span class="report-id">#${report.ReportID}</span>
                </div>
                <div class="card-body">
                    <div class="main-info">
                        <div class="magnitude-box ${isSig ? 'mag-sig' : 'mag-micro'}">${mag}</div>
                        <div class="time-loc">
                            <div class="time">${time}</div>
                            <div class="location"><i class="fas fa-map-marker-alt"></i> ${report.Location}</div>
                        </div>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-item">深度：<span>${report.Depth} km</span></div>
                        <div class="detail-item">編號：<span>${report.ReportID}</span></div>
                    </div>

                    <a href="${report.ReportURL}" target="_blank" class="btn-link">
                        查看 CWA 官方報告 <i class="fas fa-external-link-alt"></i>
                    </a>
                    
                    ${isSig ? `
                    <div class="map-box" id="map-${report.ReportID}">
                        <i class="fas fa-spinner fa-spin"></i> 載入等震圖...
                    </div>` : ''}
                </div>
            `;
            list.appendChild(card);
            
            // 只有顯著有感才去抓圖，避免浪費資源
            if (isSig) {
                fetchMapImage(report.ReportID);
            }
        }
        
        async function fetchMapImage(reportID) {
            // 使用 Worker 的通用圖資代理 (針對 E-A0015-003)
            const box = document.getElementById(`map-${reportID}`);
            try {
                // 注意：這裡假設 Worker 已經緩存了最新的等震圖。
                // 如果要針對特定地震報告抓圖，通常需要該報告內的具體 URL。
                // 這裡我們先嘗試抓最新的 E-A0015-003 (如果對應得上的話)
                const res = await fetch(`${WORKER_URL}?dataset=E-A0015-003`);
                const data = await res.json();
                const imgUrl = data.cwaopendata?.dataset?.resource?.uri;
                
                if (imgUrl) {
                    box.innerHTML = `<img src="${imgUrl}" alt="等震圖">`;
                } else {
                    box.style.display = 'none';
                }
            } catch(e) {
                box.style.display = 'none';
            }
        }
    </script>
</body>
</html>
