<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>臺鐵即時看板 - 真實列車動態</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <script>window.CURRENT_PAGE = 'train-liveboard';</script>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script src="assets/train-line-classification.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #3575ff 0%, #15bbd8 100%); 
            min-height: 100vh; 
            padding-bottom: 80px; /* 預留底部跑馬燈空間 */
        }
        
        .header { 
            background: white; 
            padding: 20px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 20px; 
        }
        
        .header h1 { 
            color: #D84315; 
            text-align: center; 
            margin-bottom: 10px; 
        }
        
        .back-btn { 
            display: inline-block; 
            padding: 10px 20px; 
            background: #016d68; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px; 
            margin: 20px 0; 
            transition: background 0.3s;
        }
        
        .back-btn:hover { 
            background: #034d64; 
        }
        
        .control-panel { 
            background: linear-gradient(135deg, rgba(53, 134, 255, 0.9) 0%, rgba(21, 144, 216, 0.9) 100%);
            margin: 20px 0; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,107,53,0.5);
        }
        
        .control-panel h3 { 
            color: white; 
            margin-bottom: 20px; 
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .selector-row { 
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 15px; 
            align-items: end;
        }
        
        .selector-group { 
            display: flex; 
            flex-direction: column; 
        }
        
        .selector-group label { 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: white; 
            font-size: 0.95rem;
        }
        
        .selector-group select, .selector-group input { 
            padding: 12px 15px; 
            border-radius: 10px; 
            border: 2px solid rgba(255,255,255,0.3); 
            background: white;
            color: #333;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .selector-group input:focus { 
            outline: none;
            border-color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.95);
        }
        
        .query-btn {
            padding: 12px 30px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .query-btn:hover { 
            background: #45a049; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        .query-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* 列車列表容器 */
        .train-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            margin: 20px 0;
        }
        
        .board-header {
            background: linear-gradient(135deg, #FF6B35 0%, #D84315 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .board-title h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .pids-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #212121;
            color: #ffb74d;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            font-family: 'Microsoft JhengHei', sans-serif;
            border: 1px solid #444;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .pids-btn:hover {
            background: #000;
            color: #fff;
            box-shadow: 0 0 15px rgba(255, 183, 77, 0.3);
            transform: translateY(-2px);
        }
        
        .board-info {
            font-size: 0.9rem;
            opacity: 0.9;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .direction-section { border-bottom: 2px solid #eee; }
        .direction-section:last-child { border-bottom: none; }
        
        .direction-header {
            background: #f5f5f5;
            padding: 15px 20px;
            font-weight: 600;
            color: #333;
            border-left: 4px solid #FF6B35;
            font-size: 1.05rem;
        }
        
        .train-card {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
            cursor: pointer;
        }
        
        .train-card:hover { background: #f9f9f9; }
        
        .train-info { display: flex; align-items: center; gap: 12px; }
        
        .train-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .type-自強 { background-color: #FF5722; }
        .type-自強3000 { background: linear-gradient(135deg, #000000 0%, #333333 100%); border: 1px solid #666; }
        .type-普悠瑪 { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); }
        .type-太魯閣 { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .type-莒光 { background-color: #FF9800; }
        .type-觀光 { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); border: 1px dashed #fff; }
        .type-區間快 { background-color: #3F51B5; }
        .type-區間 { background-color: #2196F3; }
        .type-復興 { background-color: #00BCD4; }
        .type-普快 { background-color: #009688; }
        .type-其他 { background-color: #607D8B; }
        
        .train-destination { flex-grow: 1; }
        .train-no { font-weight: bold; color: #333; margin-right: 8px; }
        .destination { color: #666; font-size: 0.95rem; }
        
        .schedule-time { text-align: center; font-weight: 600; color: #333; font-size: 1.1rem; }
        .schedule-label { font-size: 0.75rem; color: #999; margin-top: 2px; }
        
        .delay-status { text-align: center; min-width: 80px; }
        .delay-badge { display: inline-block; padding: 6px 10px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .delay-ok { background-color: #E8F5E9; color: #2E7D32; }
        .delay-warn { background-color: #FFEBEE; color: #C62828; }
        
        .no-data { text-align: center; padding: 60px 20px; color: #999; }
        .no-data i { font-size: 3rem; margin-bottom: 20px; opacity: 0.5; }

        /* === 底部跑馬燈樣式 (整合版) === */
        .marquee-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px; /* 修正後的高度 */
            background-color: #1a1a1a;
            display: flex;
            align-items: center;
            z-index: 9999;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.4);
            border-top: 3px solid #ff9800;
            font-family: 'Microsoft JhengHei', sans-serif;
            box-sizing: border-box;
        }

        .marquee-info {
            background: #000000;
            min-width: 150px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0 10px;
            border-right: 2px solid #333; 
            z-index: 20;
            position: relative;
            box-shadow: 5px 0 20px rgba(0,0,0,0.9);
            flex-shrink: 0;
        }

        .marquee-train-no {
            font-size: 1.4rem;
            font-weight: 800;
            color: #ffeb3b;
            line-height: 1.2;
            text-shadow: 0 0 8px rgba(255, 235, 59, 0.6);
            white-space: nowrap;
        }

        .marquee-dest {
            font-size: 1rem;
            color: #ffffff;
            font-weight: 600;
            opacity: 0.9;
            white-space: nowrap;
        }

        .marquee-content-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
            height: 100%;
            background: #1a1a1a;
            mask-image: linear-gradient(to right, transparent, black 20px, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 20px, black 95%, transparent);
            display: flex;
            align-items: center;
        }

        /* 修正：文字垂直置中 */
        .marquee-content {
            position: absolute;
            white-space: nowrap;
            font-size: 1.3rem;
            font-weight: bold;
            letter-spacing: 1px;
            line-height: 57px; /* 60px - 3px border */
            padding-left: 100%;
            animation: marquee-scroll 35s linear infinite;
            color: #fff;
            will-change: transform;
        }

        .station-stop { color: #ff3d00; }
        .station-arrow { color: #00e676; margin: 0 5px; font-size: 1rem; }

        .marquee-close {
            background: #222;
            border: none;
            border-left: 1px solid #444;
            color: #999;
            width: 50px;
            height: 100%;
            font-size: 1.8rem;
            cursor: pointer;
            z-index: 20;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .marquee-close:hover { background: #cc0000; color: white; }

        @keyframes marquee-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* 響應式調整 */
        @media (max-width: 1024px) {
            .selector-row { grid-template-columns: 1fr 1fr; }
            .train-card { grid-template-columns: 1fr 1fr; gap: 10px; }
        }

        @media (max-width: 768px) {
            .selector-row { grid-template-columns: 1fr; }
            .train-card { grid-template-columns: 1fr; }
            .train-info { flex-direction: column; align-items: flex-start; }
            
            .marquee-bar { height: 50px; }
            .marquee-info { min-width: 100px; padding: 0 8px; }
            .marquee-train-no { font-size: 1.2rem; }
            .marquee-dest { font-size: 0.9rem; }
            .marquee-content { font-size: 1.1rem; line-height: 47px; }
            body { padding-bottom: 70px; }
        }

        /* 深色模式 */
        body.dark-mode { background: #121212; color: #e0e0e0; }
        body.dark-mode .header { background: #1e1e1e; border-bottom: 1px solid #333; }
        body.dark-mode .header h1 { color: #ffab91; }
        body.dark-mode .control-panel { background: #1e1e1e; border: 1px solid #333; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        body.dark-mode .control-panel h3 { color: #90caf9; }
        body.dark-mode .selector-group label { color: #cfd8dc; }
        body.dark-mode select, body.dark-mode input { background-color: #2c2c2c; border: 1px solid #444; color: #fff; }
        body.dark-mode .train-container { background: #1e1e1e; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        body.dark-mode .board-header { background: linear-gradient(135deg, #bf360c 0%, #d84315 100%); border-bottom: 1px solid #333; }
        body.dark-mode .direction-header { background-color: #263238; color: #eceff1; border-bottom: 1px solid #37474f; border-left-color: #ff7043; }
        body.dark-mode .train-card { background-color: #1e1e1e; border-bottom: 1px solid #333; }
        body.dark-mode .train-card:hover { background-color: #2c2c2c; }
        body.dark-mode .train-no { color: #fff; }
        body.dark-mode .destination { color: #b0bec5; }
        body.dark-mode .schedule-time { color: #fff; }
        body.dark-mode .schedule-label { color: #78909c; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回首頁</a>
            <h1><i class="fas fa-train"></i> 台鐵即時看板</h1>
            <p style="text-align: center; color: #666; font-size: 0.95rem;">全台鐵路即時列車動態、誤點資訊查詢</p>
        </div>
    </div>

    <div class="container">
        <div class="control-panel">
            <h3><i class="fas fa-search"></i> 查詢即時看板</h3>
            <div class="selector-row">
                <div class="selector-group">
                    <label for="lineSelect">路線分類</label>
                    <select id="lineSelect" onchange="filterStations()"><option value="all">全部路線</option></select>
                </div>
                <div class="selector-group">
                    <label for="stationSearch">搜尋車站</label>
                    <input type="text" id="stationSearch" placeholder="輸入站名或代碼 (如: 台北, 1000)" oninput="filterStations()">
                </div>
                <div class="selector-group">
                    <label for="stationSelect">選擇車站</label>
                    <select id="stationSelect"><option value="">請選擇車站...</option></select>
                </div>
                <div class="selector-group">
                    <label for="directionFilter">方向</label>
                    <select id="directionFilter">
                        <option value="">全部</option>
                        <option value="0">順行</option>
                        <option value="1">逆行</option>
                    </select>
                </div>
                <button class="query-btn" id="queryBtn" onclick="fetchTrainLiveBoard()">
                    <i class="fas fa-sync-alt"></i> 查詢
                </button>
            </div>
        </div>

        <div id="trainContainer" class="train-container" style="display: none;">
            <div class="board-header">
                <div class="board-title">
                    <h2 id="stationTitle">台鐵即時看板</h2>
                    <div class="board-info">
                        <span id="stationInfo">選擇車站進行查詢</span>
                        <span class="sync-time"><i class="fas fa-clock"></i> <span id="updateTime">--:--:--</span></span>
                    </div>
                </div>
            </div>
            <div id="trainsBoard">
                <div class="no-data"><i class="fas fa-inbox"></i><p>請選擇車站查詢</p></div>
            </div>
        </div>
    </div>

    <div id="trainMarqueeBar" class="marquee-bar" style="display: none;">
        <div class="marquee-info">
            <span class="marquee-train-no" id="mqTrainNo"></span>
            <span class="marquee-dest" id="mqDest"></span>
        </div>
        <div class="marquee-content-wrapper">
            <div class="marquee-content" id="mqContent"></div>
        </div>
        <button class="marquee-close" onclick="closeMarquee()">×</button>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        // ============ 全局變數 ============
        let currentStationID = '';
        let currentStationName = '';
        let allStationsFlat = []; 
        const trainDataCache = {}; 

        // 車種對照表
        const TRAIN_TYPE_DB = [
          { "id": "1100", "name": "自強", "code": "3" },
          { "id": "1101", "name": "太魯閣", "code": "1" },
          { "id": "1102", "name": "自強", "code": "3" },
          { "id": "1103", "name": "自強", "code": "3" },
          { "id": "1107", "name": "普悠瑪", "code": "2" },
          { "id": "1108", "name": "自強", "code": "3" },
          { "id": "110G", "name": "自強(3000)", "code": "11" },
          { "id": "110H", "name": "自強(3000)", "code": "11" },
          { "id": "110K", "name": "自強(3000)", "code": "11" },
          { "id": "110M", "name": "自強(3000)", "code": "11" },
          { "id": "1110", "name": "莒光", "code": "4" },
          { "id": "1111", "name": "莒光", "code": "4" },
          { "id": "1114", "name": "莒光", "code": "4" },
          { "id": "1115", "name": "莒光", "code": "4" },
          { "id": "1120", "name": "復興", "code": "5" },
          { "id": "1131", "name": "區間", "code": "6" },
          { "id": "1132", "name": "區間快", "code": "6" },
          { "id": "1140", "name": "普快", "code": "7" }
        ];
        const trainTypeMap = new Map();
        TRAIN_TYPE_DB.forEach(item => trainTypeMap.set(item.id, item.name));

        // ============ 初始化 ============
        document.addEventListener('DOMContentLoaded', () => {
            initStationControls();
            setInterval(updateTime, 1000);
        });

        function initStationControls() {
            const lineSelect = document.getElementById('lineSelect');
            const categories = {};
            for (const [key, data] of Object.entries(trainLineClassification)) {
                const category = data.category || '其他';
                if (!categories[category]) categories[category] = [];
                categories[category].push({ key, ...data });
            }

            for (const [category, routes] of Object.entries(categories)) {
                if (Object.keys(categories).length > 1) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category;
                    routes.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.key;
                        option.textContent = route.name;
                        optgroup.appendChild(option);
                    });
                    lineSelect.appendChild(optgroup);
                } else {
                    routes.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.key;
                        option.textContent = route.name;
                        lineSelect.appendChild(option);
                    });
                }
                routes.forEach(route => {
                    route.stations.forEach(station => {
                        if (!allStationsFlat.find(s => s.code === station.code)) {
                            allStationsFlat.push({ code: station.code, name: station.name, lineKey: route.key });
                        }
                    });
                });
            }
            filterStations();
        }

        function filterStations() {
            const selectedLine = document.getElementById('lineSelect').value;
            const keyword = document.getElementById('stationSearch').value.toLowerCase().trim();
            let filtered = [];

            if (selectedLine === 'all') {
                filtered = allStationsFlat;
            } else if (trainLineClassification[selectedLine]) {
                filtered = trainLineClassification[selectedLine].stations.map(s => ({
                    code: s.code, name: s.name, lineKey: selectedLine
                }));
            }

            if (keyword) {
                filtered = filtered.filter(s => s.name.includes(keyword) || s.code.includes(keyword));
            }
            renderStationOptions(filtered);
        }

        function renderStationOptions(stations) {
            const select = document.getElementById('stationSelect');
            select.innerHTML = '';
            if (stations.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.text = "查無符合車站";
                select.add(option);
                return;
            }
            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.text = `請選擇車站 (${stations.length} 個結果)`;
            select.add(defaultOpt);
            stations.forEach(s => {
                const option = document.createElement('option');
                option.value = s.code;
                option.text = `${s.code} - ${s.name}`;
                select.add(option);
            });
            if (stations.length === 1) select.selectedIndex = 1;
        }

        // ============ 查詢功能 ============
        async function fetchTrainLiveBoard() {
            const stationSelect = document.getElementById('stationSelect');
            const queryBtn = document.getElementById('queryBtn');
            currentStationID = stationSelect.value;

            if (!currentStationID) {
                alert('請先選擇車站');
                return;
            }

            const selectedOption = stationSelect.options[stationSelect.selectedIndex];
            currentStationName = selectedOption.text.split(' - ')[1];
            queryBtn.disabled = true;

            try {
                const endpoint = `/v2/Rail/TRA/LiveBoard?$filter=StationID eq '${currentStationID}'&$format=JSON`;
                const response = await tdxApi.fetch(endpoint);
                const trains = Array.isArray(response) ? response : [];

                if (trains.length > 0) renderBoard(trains);
                else showNoData('目前無列車進出站資訊');

            } catch (error) {
                console.error('查詢失敗:', error);
                showNoData('查詢失敗，請檢查網路');
            } finally {
                queryBtn.disabled = false;
            }
        }

        function renderBoard(trains) {
            const container = document.getElementById('trainContainer');
            const trainsBoard = document.getElementById('trainsBoard');
            const directionFilter = document.getElementById('directionFilter').value;
            const pidsLink = `pids-live.html?station=${currentStationID}&name=${encodeURIComponent(currentStationName)}`;

            document.getElementById('stationTitle').innerHTML = `${currentStationName} 即時看板 <a href="${pidsLink}" target="_blank" class="pids-btn"><i class="fas fa-desktop"></i> 開啟 PIDS 模擬</a>`;
            document.getElementById('stationInfo').textContent = `車站代碼：${currentStationID}`;
            updateTime();

            let filteredTrains = trains;
            if (directionFilter !== '') {
                filteredTrains = trains.filter(t => String(t.Direction) === directionFilter);
            }

            const grouped = {
                '0': { title: '順行 (南下/西行)', trains: [] },
                '1': { title: '逆行 (北上/東上)', trains: [] }
            };

            filteredTrains.forEach(train => {
                const dir = String(train.Direction);
                if (grouped[dir]) grouped[dir].trains.push(train);
            });

            Object.values(grouped).forEach(g => {
                g.trains.sort((a, b) => (a.ScheduledDepartureTime || '').localeCompare(b.ScheduledDepartureTime || ''));
            });

            let html = '';
            Object.entries(grouped).forEach(([dir, data]) => {
                if (data.trains.length === 0) return;
                html += `<div class="direction-section"><div class="direction-header"><i class="fas fa-arrow-right"></i> ${data.title}</div>`;
                
                data.trains.forEach(train => {
                    const timeText = train.ScheduledDepartureTime ? train.ScheduledDepartureTime.slice(0,5) : '--:--';
                    const delayStatus = getDelayStatus(train);
                    const endStation = train.EndingStationName?.Zh_tw || train.EndingStationName || '未知';
                    const trainInfo = getTrainDisplayInfo(train);

                    html += `
                        <div class="train-card" 
                             onclick="showTrainStops('${train.TrainNo}', '${currentStationID}', '${endStation}')"
                             onmouseenter="prefetchTrainData('${train.TrainNo}')"
                             title="點擊查看沿途停靠站">
                            <div class="train-info">
                                <span class="train-type-badge type-${trainInfo.class}">${trainInfo.name}</span>
                                <div class="train-destination">
                                    <div class="train-no">${train.TrainNo} 次</div>
                                    <div class="destination">往 ${endStation}</div>
                                </div>
                            </div>
                            <div class="schedule-time">${timeText}<div class="schedule-label">表定</div></div>
                            <div class="delay-status">${delayStatus}</div>
                        </div>
                    `;
                });
                html += '</div>';
            });

            if (html === '') {
                showNoData('該方向無列車資訊');
                return;
            }
            trainsBoard.innerHTML = html;
            container.style.display = 'block';
        }

        // ============ 輔助函式 ============
        function getTrainDisplayInfo(train) {
            let name = train.TrainTypeName?.Zh_tw || '列車';
            let cssClass = '其他';
            const typeID = train.TrainTypeID;

            if (typeID && trainTypeMap.has(typeID)) name = trainTypeMap.get(typeID);
            else {
                if (name.includes('普悠瑪')) name = '普悠瑪';
                else if (name.includes('太魯閣')) name = '太魯閣';
                else if (name.includes('3000')) name = '自強(3000)';
                else if (name.includes('區間快')) name = '區間快';
                else if (name.includes('區間')) name = '區間';
                else if (name.includes('自強')) name = '自強';
                else if (name.includes('莒光')) name = '莒光';
                else if (name.includes('復興')) name = '復興';
            }

            if (name.includes('自強(3000)') || name.includes('EMU3000')) cssClass = '自強3000';
            else if (name.includes('普悠瑪')) cssClass = '普悠瑪';
            else if (name.includes('太魯閣')) cssClass = '太魯閣';
            else if (name.includes('自強')) cssClass = '自強';
            else if (name.includes('莒光')) cssClass = '莒光';
            else if (name.includes('區間快')) cssClass = '區間快';
            else if (name.includes('區間')) cssClass = '區間';
            else if (name.includes('復興')) cssClass = '復興';
            else if (name.includes('觀光')) cssClass = '觀光';
            else if (name.includes('普快')) cssClass = '普快';

            return { name: name, class: cssClass };
        }

        function getDelayStatus(train) {
            const delay = train.DelayTime || 0;
            return delay === 0 
                ? '<span class="delay-badge delay-ok"><i class="fas fa-check"></i> 準點</span>' 
                : `<span class="delay-badge delay-warn"><i class="fas fa-clock"></i> 晚 ${delay} 分</span>`;
        }

        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const el = document.getElementById('updateTime');
            if (el) el.textContent = timeStr;
        }

        function showNoData(msg) {
            document.getElementById('trainsBoard').innerHTML = `<div class="no-data"><i class="fas fa-inbox"></i><p>${msg}</p></div>`;
            document.getElementById('trainContainer').style.display = 'block';
        }

        // ============ 跑馬燈邏輯 ============
        function prefetchTrainData(trainNo) {
            if (trainDataCache[trainNo]) return;
            const p1 = fetchScheduleWithFallback(trainNo);
            const p2 = tdxApi.fetch(`/v3/Rail/TRA/TrainLiveBoard/TrainNo/${trainNo}?$format=JSON`).catch(() => null);
            trainDataCache[trainNo] = Promise.all([p1, p2]);
        }

        async function fetchScheduleWithFallback(trainNo) {
            try {
                const v3Url = `/v3/Rail/TRA/DailyTimetable/Today/TrainNo/${trainNo}?$format=JSON`;
                const v3Data = await tdxApi.fetch(v3Url);
                if (v3Data && v3Data.length > 0 && v3Data[0].StopTimes) return v3Data[0].StopTimes;
            } catch (e) {}
            
            try {
                const v2Url = `/v2/Rail/TRA/DailyTrainInfo/TrainNo/${trainNo}?$format=JSON`;
                const v2Data = await tdxApi.fetch(v2Url);
                if (v2Data && v2Data.length > 0 && v2Data[0].StopTimes) return v2Data[0].StopTimes;
            } catch (e) {}

            return [];
        }

        function addMinutesToTime(timeStr, minutesToAdd) {
            if (!timeStr) return '--:--';
            if (minutesToAdd === 0) return timeStr;
            const [h, m] = timeStr.split(':').map(Number);
            const d = new Date();
            d.setHours(h); d.setMinutes(m + minutesToAdd);
            return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }

        async function showTrainStops(trainNo, currentStationID, destName) {
            const bar = document.getElementById('trainMarqueeBar');
            const content = document.getElementById('mqContent');
            
            bar.style.display = 'flex';
            document.getElementById('mqTrainNo').textContent = `${trainNo} 次`;
            document.getElementById('mqDest').textContent = `往 ${destName}`;
            
            if (!trainDataCache[trainNo]) content.innerHTML = '<span style="color:#aaa;">載入中...</span>';
            content.style.animation = 'none';

            try {
                let stopTimes, liveData;
                if (trainDataCache[trainNo]) {
                    [stopTimes, liveData] = await trainDataCache[trainNo];
                } else {
                    [stopTimes, liveData] = await Promise.all([
                        fetchScheduleWithFallback(trainNo),
                        tdxApi.fetch(`/v3/Rail/TRA/TrainLiveBoard/TrainNo/${trainNo}?$format=JSON`).catch(() => null)
                    ]);
                    trainDataCache[trainNo] = Promise.resolve([stopTimes, liveData]);
                }

                let marqueeHTML = '';
                const delayTime = (liveData && liveData.DelayTime) ? liveData.DelayTime : 0;

                // 1. 目前位置
                if (liveData && liveData.StationName) {
                    const lastStation = liveData.StationName.Zh_tw;
                    const delayText = delayTime <= 0 ? '<span style="color:#00e676;">(準點)</span>' : `<span style="color:#ff5252;">(晚 ${delayTime} 分)</span>`;
                    marqueeHTML += `<span style="color:#aaa;">目前位置：</span><span style="color:#ffeb3b; font-weight:bold;">${lastStation}</span> ${delayText}`;
                } else {
                    marqueeHTML += `<span style="color:#aaa;">(暫無即時位置訊號)</span>`;
                }
                
                marqueeHTML += `<span style="margin:0 20px; border-left:1px solid #555;"></span>`;

                // 2. 本站預計
                if (stopTimes.length > 0) {
                    const idx = stopTimes.findIndex(s => s.StationID === currentStationID);
                    if (idx !== -1) {
                        const myStation = stopTimes[idx];
                        const tableTime = myStation.ArrivalTime || myStation.DepartureTime;
                        const predictedTime = addMinutesToTime(tableTime, delayTime);
                        const timeColor = delayTime > 0 ? '#ff5252' : '#4fc3f7';
                        marqueeHTML += `本站預計：<span style="color:${timeColor}; font-weight:bold; font-size:1.2rem;">${predictedTime}</span> 抵達`;
                    }
                }

                // 3. 後續停靠
                if (stopTimes.length > 0) {
                    const idx = stopTimes.findIndex(s => s.StationID === currentStationID);
                    if (idx !== -1 && idx < stopTimes.length - 1) {
                        const stops = stopTimes.slice(idx + 1).map(s => `<span class="station-stop">${s.StationName.Zh_tw}</span>`).join('<span class="station-arrow">▶</span>');
                        marqueeHTML += `<span style="margin:0 20px; border-left:1px solid #555;"></span><span style="color:#aaa;">後續停靠：</span>${stops}`;
                    }
                }

                content.innerHTML = marqueeHTML;
                void content.offsetHeight;
                const duration = Math.max(8, content.innerText.length * 0.4);
                content.style.animation = `marquee-scroll ${duration}s linear infinite`;

            } catch (e) {
                console.error(e);
                content.innerHTML = '無法載入詳細資料';
            }
        }

        function closeMarquee() {
            document.getElementById('trainMarqueeBar').style.display = 'none';
        }
    </script>
</body>
</html>