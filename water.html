<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°æ°´æƒ…ç›£æ¸¬ - å¤©æ°£å³æ™‚å¿«è¨Š</title>
    
    <!-- Leaflet åœ°åœ– CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- FontAwesome åœ–ç¤º -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- çµ±è¨ˆæ¨¡çµ„ -->
    <script src="assets/camera-statistics.js"></script>

    <style>
        :root {
            --primary-color: #0077b6;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: var(--bg-color); }
        
        /* é ‚éƒ¨å°èˆª */
        .header { background: var(--primary-color); color: white; padding: 15px 20px; display: flex; align-items: center; gap: 15px; }
        .back-btn { text-decoration: none; color: white; font-size: 1.2rem; }

        /* ä½ˆå±€å®¹å™¨ */
        .dashboard-container {
            display: grid;
            grid-template-columns: 350px 1fr; /* å·¦åˆ—è¡¨ï¼Œå³åœ°åœ– */
            height: calc(100vh - 60px);
            gap: 10px;
            padding: 10px;
        }

        /* å·¦å´åˆ—è¡¨å€ */
        .sidebar {
            background: var(--card-bg);
            border-radius: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .tabs { display: flex; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; background: #f8f9fa; border: none; }
        .tab.active { background: white; font-weight: bold; border-top: 3px solid var(--primary-color); }

        /* ç›£è¦–å™¨å¡ç‰‡ */
        .cam-grid { padding: 10px; display: flex; flex-direction: column; gap: 15px; }
        
        .cam-card {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .cam-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .cam-header {
            padding: 8px 12px;
            background: #f8f9fa;
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        /* å½±åƒå®¹å™¨ - ä¿æŒ 16:9 */
        .cam-view {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background: #000;
        }

        .cam-view img {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
        }

        /* è¼‰å…¥ä¸­/éŒ¯èª¤ç‹€æ…‹ */
        .cam-placeholder {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            flex-direction: column;
            background: #1a1a1a;
        }

        .cam-info {
            padding: 5px 10px;
            font-size: 0.8rem;
            color: #888;
            text-align: right;
            background: #f9f9f9;
        }

        /* åœ°åœ–å€ */
        #map { border-radius: 10px; height: 100%; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* æ‰‹æ©Ÿç‰ˆ RWD */
        @media (max-width: 768px) {
            .dashboard-container { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
            .header { flex-wrap: wrap; }
            .header h2 { margin: 0; font-size: 1.1rem; }
        }

        /* çµ±è¨ˆè³‡è¨Š */
        .stats-info {
            padding: 10px;
            background: #e7f3ff;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            color: #0077b6;
        }

        /* éæ¿¾å™¨ */
        .filter-section {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 5px;
        }

        .filter-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* å„ªåŒ– Popup æ¨£å¼ */
        .leaflet-popup-content {
            text-align: center;
            font-family: 'Segoe UI', sans-serif;
            padding: 0 !important;
        }
        .leaflet-popup-content img {
            width: 100%;
            max-width: 260px;
            border-radius: 8px;
            margin: 8px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: block;
        }
        .leaflet-popup-content h4 {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 4px;
        }
        .time-tag {
            background: #f1f1f1;
            padding: 4px 10px;
            border-radius: 12px;
            color: #666;
            font-size: 0.85rem;
            display: inline-block;
            margin-top: 4px;
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <h2>ğŸ’§ æ°´æƒ…ç›£æ¸¬æˆ°æƒ…å®¤</h2>
    </div>

    <div class="dashboard-container">
        <!-- å·¦å´ï¼šç›£è¦–å™¨åˆ—è¡¨ -->
        <div class="sidebar">
            <div class="tabs">
                <button class="tab active" onclick="filterType('cctv')">ğŸ“¸ æ°´åˆ©ç›£è¦–å™¨</button>
                <button class="tab" onclick="showComingSoon()">ğŸŒŠ æ°´åº«æ°´æƒ…</button>
            </div>
            
            <div class="stats-info">
                <i class="fas fa-info-circle"></i> 
                ç›£æ§é»æ•¸: <strong id="stats-count">0</strong> | 
                <i class="fas fa-sync-alt fa-spin" id="sync-indicator" style="display:none;"></i>
            </div>

            <div class="filter-section" id="filter-section" style="display:none;">
                <button class="filter-btn active" onclick="filterByCity(null)">å…¨éƒ¨åœ°å€</button>
            </div>
            
            <div id="cam-list" class="cam-grid">
                <div style="padding:20px; text-align:center; color:#666;">
                    <i class="fas fa-circle-notch fa-spin"></i> è¼‰å…¥å½±åƒè³‡æ–™ä¸­...
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šåœ°åœ– -->
        <div id="map"></div>
    </div>

    <!-- è¼‰å…¥ Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ğŸŒ å…¨åŸŸè®Šæ•¸
        let map;
        let allCameras = [];
        let filteredCameras = [];
        let markers = [];
        let refreshInterval = null;
        let currentFilter = null;

        // ğŸš€ åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadWaterCCTV();
        });

        // ğŸ•’ æ™‚é–“æ ¼å¼åŒ–å°å¹«æ‰‹
        function formatTime(timeStr) {
            if (!timeStr) return 'æœªæä¾›æ›´æ–°æ™‚é–“';
            
            const date = new Date(timeStr);
            // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ—¥æœŸ
            if (isNaN(date.getTime())) {
                return timeStr || 'æ™‚é–“æ ¼å¼éŒ¯èª¤';
            }
            
            // æ ¼å¼åŒ–æˆï¼š2024/11/22 20:51
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }

        // 1ï¸âƒ£ åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            map = L.map('map').setView([23.7, 121.0], 7);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
        }

        // 2ï¸âƒ£ è¼‰å…¥æ°´åˆ©ç½² CCTV (å‘¼å« Cloudflare Functions API)
        async function loadWaterCCTV() {
            try {
                showSyncIndicator(true);
                const res = await fetch('/api/cctv-water');
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }

                allCameras = await res.json();
                filteredCameras = allCameras;

                // æ›´æ–°çµ±è¨ˆ
                document.getElementById('stats-count').textContent = allCameras.length;

                // å»ºç«‹åœ°å€éæ¿¾å™¨
                setupCityFilters();

                // æ¸²æŸ“
                renderList(filteredCameras);
                renderMapMarkers(filteredCameras);
                startAutoRefresh();

                console.log(`âœ… æˆåŠŸè¼‰å…¥ ${allCameras.length} å€‹ç›£è¦–å™¨`);

            } catch (error) {
                console.error("âŒ è¼‰å…¥å¤±æ•—", error);
                document.getElementById('cam-list').innerHTML = `
                    <div style="color:red; padding:20px; text-align:center;">
                        âŒ ç„¡æ³•è¼‰å…¥ç›£è¦–å™¨è³‡æ–™<br>
                        <small>${error.message}</small><br>
                        <button onclick="location.reload()" style="margin-top:10px; padding:8px 16px; cursor:pointer;">
                            é‡æ–°è¼‰å…¥
                        </button>
                    </div>`;
            } finally {
                showSyncIndicator(false);
            }
        }

        // å»ºç«‹åœ°å€éæ¿¾å™¨
        function setupCityFilters() {
            const cities = [...new Set(allCameras.map(c => c.city))].sort();
            const filterSection = document.getElementById('filter-section');
            
            if (cities.length > 1) {
                filterSection.style.display = 'flex';
                
                // æ¸…é™¤èˆŠæŒ‰éˆ• (ä¿ç•™ã€Œå…¨éƒ¨åœ°å€ã€)
                const buttons = filterSection.querySelectorAll('.filter-btn:not(:first-child)');
                buttons.forEach(btn => btn.remove());

                // æ–°å¢åœ°å€æŒ‰éˆ•
                cities.forEach(city => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.textContent = city;
                    btn.onclick = () => filterByCity(city);
                    filterSection.appendChild(btn);
                });
            }
        }

        // 3ï¸âƒ£ åœ°å€éæ¿¾
        function filterByCity(city) {
            currentFilter = city;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // éæ¿¾è³‡æ–™
            if (city) {
                filteredCameras = allCameras.filter(c => c.city === city);
            } else {
                filteredCameras = allCameras;
            }

            // é‡æ–°æ¸²æŸ“
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });
            
            renderList(filteredCameras);
            renderMapMarkers(filteredCameras);
        }

        // 4ï¸âƒ£ æ¸²æŸ“å·¦å´åˆ—è¡¨
        function renderList(cams) {
            const container = document.getElementById('cam-list');
            container.innerHTML = '';

            if (cams.length === 0) {
                container.innerHTML = '<div style="padding:20px;">ç„¡å¯ç”¨å½±åƒ</div>';
                return;
            }

            cams.forEach(cam => {
                const div = document.createElement('div');
                div.className = 'cam-card';
                const imgId = `img-${cam.id}`;
                
                div.innerHTML = `
                    <div class="cam-header">
                        <span>${cam.name}</span>
                        <small>${cam.river || cam.city}</small>
                    </div>
                    <div class="cam-view">
                        <div class="cam-placeholder">
                            <i class="fas fa-image" style="font-size:2rem; margin-bottom:10px;"></i>
                            å½±åƒè¼‰å…¥ä¸­...
                        </div>
                        <img id="${imgId}" 
                             src="${cam.url}" 
                             alt="${cam.name}" 
                             onload="this.previousElementSibling.style.display='none'"
                             onerror="this.style.display='none'; this.previousElementSibling.innerHTML='<i class=\"fas fa-exclamation-circle\" style=\"font-size:2rem; margin-bottom:10px;\"></i><div>âŒ è¨Šè™Ÿä¸­æ–·</div>'">
                    </div>
                    <div class="cam-info">
                        <i class="fas fa-sync-alt"></i> æ¯åˆ†é˜è‡ªå‹•åˆ·æ–° | ID: ${cam.id}
                    </div>
                `;
                
                // é»æ“Šå¡ç‰‡ï¼Œåœ°åœ–é£›éå»
                div.onclick = () => {
                    map.flyTo([cam.lat, cam.lon], 14, { duration: 1.5 });
                };

                container.appendChild(div);
            });
        }

        // 5ï¸âƒ£ æ¸²æŸ“åœ°åœ–æ¨™è¨˜
        function renderMapMarkers(cams) {
            cams.forEach(cam => {
                const marker = L.circleMarker([cam.lat, cam.lon], {
                    radius: 7,
                    fillColor: '#0077b6',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.85
                }).addTo(map);

                // é»æ“Šæ¨™è¨˜é¡¯ç¤ºå½ˆå‡ºè¦–çª—
                const popupContent = `
                    <div style="max-width: 260px; padding: 12px;">
                        <h4>${cam.name}</h4>
                        <p style="margin: 0 0 8px 0; font-size: 0.9rem; color: #666;">
                            <i class="fas fa-map-pin"></i> ${cam.city} ${cam.river}
                        </p>
                        <img src="${cam.url}" alt="ç›£è¦–å™¨å½±åƒ" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22260%22 height=%22146%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22260%22 height=%22146%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-family=%22Arial%22%3Eå½±åƒè¼‰å…¥å¤±æ•—%3C/text%3E%3C/svg%3E'">
                        <div class="time-tag">
                            <i class="far fa-clock"></i> ${formatTime(cam.time)}
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent, { maxWidth: 250 });
                
                // ğŸ¥ è¨˜éŒ„ç›£è¦–å™¨ç€è¦½çµ±è¨ˆ
                marker.on('popupopen', function() {
                    recordCameraView(cam.id, cam.name, 'water-cctv');
                });
                
                markers.push(marker);
            });
        }

        // 6ï¸âƒ£ æ™ºæ…§åœ–ç‰‡åˆ·æ–° (Smart Refresh)
        function startAutoRefresh() {
            // æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
            if (refreshInterval) clearInterval(refreshInterval);

            // è¨­å®šæ¯ 60 ç§’åŸ·è¡Œä¸€æ¬¡
            refreshInterval = setInterval(() => {
                console.log("ğŸ”„ æ­£åœ¨åˆ·æ–°æ‰€æœ‰æ°´åˆ©ç½²å½±åƒ...");
                showSyncIndicator(true);
                
                // æŠ“å–é é¢ä¸Šæ‰€æœ‰çš„ CCTV åœ–ç‰‡
                const images = document.querySelectorAll('.cam-view img');
                const timestamp = new Date().getTime();

                images.forEach(img => {
                    // åªæœ‰ç•¶åœ–ç‰‡æ˜¯é¡¯ç¤ºç‹€æ…‹æ™‚æ‰åˆ·æ–° (ç¯€çœé »å¯¬)
                    if (img.style.display !== 'none') {
                        // é€éåŠ ä¸Šæ™‚é–“æˆ³è¨˜åƒæ•¸ï¼Œå¼·è¿«ç€è¦½å™¨é‡æ–°ä¸‹è¼‰åœ–ç‰‡
                        let originalUrl = img.src.split('?')[0];
                        img.src = `${originalUrl}?t=${timestamp}`;
                    }
                });

                setTimeout(() => showSyncIndicator(false), 500);

            }, 60000); // 60000 ms = 1 åˆ†é˜
        }

        // è¼”åŠ©å‡½æ•¸ï¼šé¡¯ç¤ºåŒæ­¥æŒ‡ç¤ºå™¨
        function showSyncIndicator(show) {
            const indicator = document.getElementById('sync-indicator');
            if (show) {
                indicator.style.display = 'inline-block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // é¡å‹éæ¿¾ (é ç•™çµ¦æœªä¾†çš„æ°´åº«æ°´æƒ…åŠŸèƒ½)
        function filterType(type) {
            if (type === 'cctv') {
                console.log('ğŸ“¸ é¡¯ç¤ºæ°´åˆ©ç›£è¦–å™¨');
                document.getElementById('filter-section').style.display = 'flex';
            } else {
                console.log('ğŸŒŠ æ°´åº«æ°´æƒ…åŠŸèƒ½å°šæœªå¯¦è£');
            }
        }

        // é å‘ŠåŠŸèƒ½
        function showComingSoon() {
            alert('ğŸŒŠ æ°´åº«æ°´æƒ…åŠŸèƒ½\n\nå³å°‡æ¨å‡ºï¼š\nâœ… å³æ™‚è“„æ°´é‡çµ±è¨ˆ\nâœ… å®¹é‡è­¦æˆ’æŒ‡æ¨™\nâœ… æ­·å²ç”¨æ°´è¶¨å‹¢\n\næ•¬è«‹æœŸå¾…ï¼');
        }

        // é é¢å¸è¼‰æ™‚æ¸…é™¤è¨ˆæ™‚å™¨
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) clearInterval(refreshInterval);
        });
    </script>
</body>
</html>
