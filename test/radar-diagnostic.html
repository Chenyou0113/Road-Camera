<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›·é” API å®Œæ•´è¨ºæ–·å·¥å…·</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #1a1a1a; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #4ec9b0; margin-bottom: 20px; }
        .radar-test { margin: 20px 0; padding: 15px; background: #252526; border-left: 3px solid #569cd6; border-radius: 5px; }
        button { background: #007acc; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 3px; margin: 5px 0; }
        button:hover { background: #005a9e; }
        .output { background: #1e1e1e; border: 1px solid #444; padding: 15px; margin: 10px 0; border-radius: 3px; max-height: 400px; overflow-y: auto; font-size: 12px; }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .info { color: #9cdcfe; }
        .url { color: #ce9178; word-break: break-all; }
        pre { background: #252526; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é›·é” API å®Œæ•´è¨ºæ–·å·¥å…·</h1>

        <div class="radar-test">
            <h2>ğŸ¯ æ¨¹æ—é›·é” (O-A0084-001)</h2>
            <button onclick="testRadarDirect('O-A0084-001')">ğŸ“¡ ç›´æ¥ Fetch API</button>
            <button onclick="parseXMLFromRadar('O-A0084-001')">ğŸ§¬ è§£æ XML</button>
            <div class="output" id="output-001"></div>
        </div>

        <div class="radar-test">
            <h2>ğŸ¯ å—å±¯é›·é” (O-A0084-002)</h2>
            <button onclick="testRadarDirect('O-A0084-002')">ğŸ“¡ ç›´æ¥ Fetch API</button>
            <button onclick="parseXMLFromRadar('O-A0084-002')">ğŸ§¬ è§£æ XML</button>
            <div class="output" id="output-002"></div>
        </div>

        <div class="radar-test">
            <h2>ğŸ¯ æ—åœ’é›·é” (O-A0084-003)</h2>
            <button onclick="testRadarDirect('O-A0084-003')">ğŸ“¡ ç›´æ¥ Fetch API</button>
            <button onclick="parseXMLFromRadar('O-A0084-003')">ğŸ§¬ è§£æ XML</button>
            <div class="output" id="output-003"></div>
        </div>

        <div class="radar-test">
            <h2>ğŸŒ å°ç£é„°è¿‘å€åŸŸ (O-A0058-003)</h2>
            <button onclick="testRadarDirect('O-A0058-003')">ğŸ“¡ ç›´æ¥ Fetch API</button>
            <div class="output" id="output-101"></div>
        </div>

        <div class="radar-test">
            <h2>ğŸŒ å°ç£è¼ƒå¤§ç¯„åœ (O-A0058-001)</h2>
            <button onclick="testRadarDirect('O-A0058-001')">ğŸ“¡ ç›´æ¥ Fetch API</button>
            <div class="output" id="output-102"></div>
        </div>
    </div>

    <script>
        const API_KEY = 'CWA-675CED45-09DF-4249-9599-B9B5A5AB761A';
        const FILE_API_BASE = 'https://opendata.cwa.gov.tw/fileapi/v1/opendataapi';

        const codeMap = {
            'O-A0084-001': '001',
            'O-A0084-002': '002',
            'O-A0084-003': '003',
            'O-A0058-003': '101',
            'O-A0058-001': '102'
        };

        async function testRadarDirect(dataId) {
            const code = codeMap[dataId];
            const output = document.getElementById(`output-${code}`);
            output.innerHTML = '<span class="info">â³ æ­£åœ¨è«‹æ±‚ API...</span>';

            try {
                const url = `${FILE_API_BASE}/${dataId}?Authorization=${API_KEY}&downloadType=WEB&format=JSON`;
                
                console.log('ğŸ“¡ æ­£åœ¨è«‹æ±‚:', url);
                
                const response = await fetch(url);
                const text = await response.text();
                
                let html = `<span class="success">âœ… HTTP ${response.status}</span>\n`;
                html += `<span class="info">ğŸ“ å›æ‡‰é•·åº¦: ${text.length} å­—å…ƒ</span>\n`;
                html += `<span class="info">ğŸ“ é¦– 100 å­—å…ƒ:</span>\n`;
                html += `<pre>${text.substring(0, 100)}</pre>\n`;

                // æª¢æ¸¬æ ¼å¼
                if (text.includes('<?xml') || text.includes('<dataset')) {
                    html += `<span class="success">âœ… åµæ¸¬åˆ° XML æ ¼å¼</span>\n`;
                    
                    // å˜—è©¦è§£æ XML
                    try {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(text, 'application/xml');
                        
                        if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                            html += `<span class="error">âŒ XML è§£æéŒ¯èª¤</span>\n`;
                        } else {
                            html += `<span class="success">âœ… XML è§£ææˆåŠŸ</span>\n`;
                            
                            // æå–é—œéµè³‡è¨Š
                            const getElementText = (tagName) => {
                                let elements = xmlDoc.getElementsByTagName(tagName);
                                if (elements.length > 0) return elements[0].textContent;
                                return null;
                            };
                            
                            const productUrl = getElementText('ProductURL');
                            const dateTime = getElementText('DateTime');
                            const resourceDesc = getElementText('resourceDesc');
                            const imageDim = getElementText('ImageDimension');
                            
                            html += `<span class="info">ğŸ“Š æå–çš„è³‡è¨Š:</span>\n`;
                            html += `  ProductURL: ${productUrl ? '<span class="success">âœ… æœ‰</span>' : '<span class="error">âŒ ç„¡'}</span>\n`;
                            html += `  DateTime: ${dateTime ? '<span class="success">âœ… ' + dateTime + '</span>' : '<span class="error">âŒ ç„¡'}</span>\n`;
                            html += `  resourceDesc: ${resourceDesc || 'ç„¡'}\n`;
                            html += `  imageDimension: ${imageDim || 'ç„¡'}\n`;
                            
                            if (productUrl) {
                                html += `<span class="success">ğŸ–¼ï¸ å½±åƒ URL:</span>\n`;
                                html += `<span class="url">${productUrl}</span>\n`;
                                html += `<img src="${productUrl}" style="max-width: 100%; margin: 10px 0; border-radius: 5px;" onerror="this.src=''; this.innerHTML='ç„¡æ³•è¼‰å…¥åœ–ç‰‡';">`;
                            }
                        }
                    } catch (e) {
                        html += `<span class="error">âŒ XML è§£æç•°å¸¸: ${e.message}</span>\n`;
                    }
                } else if (text.startsWith('{')) {
                    html += `<span class="success">âœ… åµæ¸¬åˆ° JSON æ ¼å¼</span>\n`;
                    try {
                        const json = JSON.parse(text);
                        html += `<pre>${JSON.stringify(json, null, 2).substring(0, 500)}...</pre>`;
                    } catch (e) {
                        html += `<span class="error">âŒ JSON è§£æå¤±æ•—</span>\n`;
                    }
                } else {
                    html += `<span class="warning">âš ï¸ æœªçŸ¥æ ¼å¼</span>\n`;
                    html += `<pre>${text.substring(0, 500)}</pre>`;
                }

                output.innerHTML = html;

            } catch (error) {
                output.innerHTML = `<span class="error">âŒ éŒ¯èª¤: ${error.message}</span>\n<pre>${error.stack}</pre>`;
            }
        }

        async function parseXMLFromRadar(dataId) {
            const code = codeMap[dataId];
            const output = document.getElementById(`output-${code}`);
            output.innerHTML = '<span class="info">â³ æ­£åœ¨æ¸¬è©¦è½‰æ›å·¥å…·...</span>';

            try {
                // è¼‰å…¥ transformer
                if (typeof RadarTransformer === 'undefined') {
                    output.innerHTML = '<span class="error">âŒ RadarTransformer æœªè¼‰å…¥</span>';
                    return;
                }

                const result = await RadarTransformer.getRadarEchoMap(code);
                
                let html = '<span class="info">ğŸ“Š è½‰æ›å·¥å…·çµæœ:</span>\n';
                html += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                
                if (result.error) {
                    html += `<span class="error">âŒ éŒ¯èª¤: ${result.error}</span>\n`;
                } else if (result.imageUrl) {
                    html += `<span class="success">âœ… æˆåŠŸå–å¾—å½±åƒ</span>\n`;
                    html += `<span class="url">${result.imageUrl}</span>\n`;
                }

                output.innerHTML = html;

            } catch (error) {
                output.innerHTML = `<span class="error">âŒ ç•°å¸¸: ${error.message}</span>`;
            }
        }

        // é é¢è¼‰å…¥æ™‚æç¤º
        window.addEventListener('DOMContentLoaded', () => {
            console.log('âœ… è¨ºæ–·å·¥å…·å·²åŠ è¼‰');
            if (typeof RadarTransformer !== 'undefined') {
                console.log('âœ… RadarTransformer å·²åŠ è¼‰');
            } else {
                console.warn('âš ï¸ RadarTransformer æœªåŠ è¼‰ï¼Œè«‹ç¢ºä¿åœ¨ rainfall-radar.html ä¸­æ­£ç¢ºå¼•å…¥');
            }
        });
    </script>
</body>
</html>
