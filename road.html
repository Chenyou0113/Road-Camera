<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœé“ç›£è¦–å™¨ - TDX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/responsive-camera.css">
    <script>window.CURRENT_PAGE = 'road';</script>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script src="assets/image-handler-simple.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); min-height: 100vh; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #FF9800; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #FF9800; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .back-btn:hover { background: #F57C00; }
        .loading { text-align: center; padding: 50px; color: white; font-size: 1.2rem; }
        .cameras-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        @media (max-width: 1200px) {
            .cameras-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .cameras-grid { grid-template-columns: 1fr; }
        }
        .camera-card { background: white; border-radius: 10px; padding: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.3s; overflow: hidden; }
        .camera-card:hover { transform: translateY(-5px); }
        .camera-info { padding: 15px; }
        .camera-info h3 { color: #FF9800; margin-bottom: 8px; font-size: 24px; font-weight: bold; word-wrap: break-word; overflow-wrap: break-word; }
        .camera-info p { color: #666; margin: 4px 0; font-size: 0.9rem; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.5; }
        .camera-image { width: 100%; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .camera-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .camera-image:hover img { transform: scale(1.05); }
        .image-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .camera-image:hover .image-overlay { opacity: 1; }
        .stream-placeholder, .no-image-placeholder, .image-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .modal-content { position: relative; margin: 2% auto; width: 90%; max-width: 1200px; }
        .close { position: absolute; top: 15px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 1001; }
        .close:hover { color: #FF9800; }
        .modal-image { width: 100%; max-height: 80vh; object-fit: contain; }
        .modal-info { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .modal-info h2 { color: #FF9800; margin-bottom: 10px; }
        .modal-info p { color: #666; margin: 5px 0; word-wrap: break-word; overflow-wrap: break-word; }
        
        /* çœé“ç‰¹è‰²æ¨£å¼ */
        .road-badge { background: #FF9800; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; display: inline-block; margin: 2px; }
        .stats-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: bold; color: #FF9800; }
        .stat-label { color: #666; margin-top: 5px; }
        
        /* ç¯©é¸å€åŸŸ */
        .filter-section { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 5px; font-weight: bold; color: #333; }
        .filter-group select, .filter-group button { padding: 10px; border-radius: 5px; border: 2px solid #FF9800; font-size: 1rem; }
        .filter-group button { background: #FF9800; color: white; cursor: pointer; }
        .filter-group button:hover { background: #F57C00; }
        
        /* åˆ†é  */
        .pagination { display: flex; justify-content: center; align-items: center; margin: 20px 0; gap: 10px; }
        .pagination button { padding: 10px 15px; border: none; background: white; color: #FF9800; border-radius: 5px; cursor: pointer; }
        .pagination button:hover, .pagination button.active { background: #FF9800; color: white; }
        .pagination button:disabled { background: #ccc; cursor: not-allowed; }
        .pagination span { color: white; font-weight: bold; padding: 10px 15px; }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„åˆ†é æ¨£å¼ */
        body.dark-mode .pagination button { background: rgba(255,255,255,0.1); color: #FFB74D; border: 1px solid rgba(255,255,255,0.2); }
        body.dark-mode .pagination button:hover, body.dark-mode .pagination button.active { background: #FFB74D; color: #1a1a2e; }
        body.dark-mode .pagination button:disabled { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.3); }
        body.dark-mode .pagination span { color: #FFB74D; }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„ç¯©é¸å€åŸŸå’Œçµ±è¨ˆé¢æ¿æ¨£å¼ */
        body.dark-mode .filter-section { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .filter-section h3 { color: #FFB74D; }
        body.dark-mode .filter-group label { color: rgba(255,255,255,0.9); }
        body.dark-mode .filter-group select { background: rgba(255,255,255,0.1); color: white; border-color: #FFB74D; }
        body.dark-mode .filter-group select option { background: #2a2a3e; color: white; }
        body.dark-mode .filter-group button { background: #FFB74D; color: #1a1a2e; border-color: #FFB74D; }
        body.dark-mode .filter-group button:hover { background: #FFA726; }
        body.dark-mode .stat-card { background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%); border: 1px solid rgba(255,255,255,0.1); }
        body.dark-mode .stat-number { color: #FFB74D; }
        body.dark-mode .stat-label { color: rgba(255,255,255,0.7); }
        body.dark-mode #infoPanel { background: rgba(40,40,50,0.95); border-left-color: #FFB74D; }
        body.dark-mode #infoPanel h3 { color: #FFB74D; }
        body.dark-mode #infoContent { color: rgba(255,255,255,0.8); }
        body.dark-mode #infoContent a { color: #FFB74D; }
        
        /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼å„ªåŒ– */
        @media (max-width: 768px) {
            .camera-info { padding: 12px; }
            .camera-info h3 { font-size: 24px; font-weight: bold; }
            .camera-info p { font-size: 0.85rem; }
            .filter-row { flex-direction: column; align-items: stretch; }
            .stats-panel { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 480px) {
            .stats-panel { grid-template-columns: 1fr; }
        }
    </style>
    
    <!-- è¼‰å…¥é€²åº¦æ¢ -->
    <script src="assets/loading-progress.js"></script>
    <script>
        // çœé“ç›£è¦–å™¨è¼‰å…¥è¨­å®š
        window.AUTO_START_LOADING = false;
        
        window.addEventListener('DOMContentLoaded', () => {
            window.startLoading({
                labelText: 'è¼‰å…¥çœé“ç›£è¦–å™¨...',
                color: '#FF9800',
                showLabel: true
            });
        });
    </script>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-road"></i> çœé“ç›£è¦–å™¨</h1>
            <p style="text-align: center; color: #666;">å³æ™‚çœé“è·¯æ³ç›£è¦–å™¨</p>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é </a>
        
        <!-- çœé“ç›£è¦–å™¨èªªæ˜ -->
        <div id="infoPanel" style="background: #e8f5e8; border-left: 4px solid #FF9800; padding: 20px; margin: 20px 0; border-radius: 8px; transition: all 0.3s ease;">
            <h3 style="color: #F57C00; margin: 0 0 15px 0; display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleInfoPanel()">
                <span>
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    çœé“ç›£è¦–å™¨è³‡æ–™èªªæ˜
                </span>
                <i id="toggleIcon" class="fas fa-chevron-up" style="transition: transform 0.3s ease;"></i>
            </h3>
            <div id="infoContent" style="color: #333; line-height: 1.6;">
                <p style="margin: 0 0 10px 0;">
                    æœ¬ç³»çµ±ä½¿ç”¨äº¤é€šéƒ¨ TDX äº¤é€šè³‡æ–™æµé€šæœå‹™å¹³å°æä¾›çš„å³æ™‚çœé“ç›£è¦–å™¨è³‡æ–™ï¼Œæ¶µè“‹å°1ç·šã€å°3ç·šã€å°9ç·šç­‰ä¸»è¦çœé“è·¯ç·šã€‚
                </p>
                
                <div style="margin: 15px 0;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">ğŸ”— ç›¸é—œè³‡æºé€£çµï¼š</p>
                    <div style="margin-left: 20px;">
                        <p style="margin: 5px 0;">
                            â€¢ <a href="https://tdx.transportdata.tw" target="_blank" style="color: #F57C00; text-decoration: none;">
                                TDX äº¤é€šè³‡æ–™æµé€šæœå‹™å¹³å° <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                        <p style="margin: 5px 0;">
                            â€¢ <a href="https://www.thb.gov.tw" target="_blank" style="color: #F57C00; text-decoration: none;">
                                å…¬è·¯ç¸½å±€ç›£è¦–å™¨ç³»çµ± <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                    </div>
                </div>
                
                <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: #666; font-style: italic;">
                    ğŸ’¡ é»æ“Šç›£è¦–å™¨å¡ç‰‡å¯æŸ¥çœ‹æ”¾å¤§å½±åƒå’Œè©³ç´°è³‡è¨Šã€‚
                </p>
            </div>
        </div>

        <!-- çµ±è¨ˆé¢æ¿ -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-number" id="totalCameras">0</div>
                <div class="stat-label">ç›£è¦–å™¨ç¸½æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="availableCameras">0</div>
                <div class="stat-label">å¯ç”¨ç›£è¦–å™¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="filteredCameras">0</div>
                <div class="stat-label">ç›®å‰é¡¯ç¤º</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="roadCount">0</div>
                <div class="stat-label">çœé“æ•¸</div>
            </div>
        </div>

        <!-- ç¯©é¸å€åŸŸ -->
        <div class="filter-section">
            <h3 style="color: #FF9800; margin-bottom: 15px;"><i class="fas fa-filter"></i> ç¯©é¸èˆ‡æ’åºçœé“ç›£è¦–å™¨</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="roadSelect">çœé“</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #FF9800; font-size: 1rem;" id="roadSelect" onchange="applyFilters('road')">
                        <option value="">æ‰€æœ‰çœé“</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="citySelect">ç¸£å¸‚</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #FF9800; font-size: 1rem;" id="citySelect" onchange="applyFilters('city')">
                        <option value="">æ‰€æœ‰ç¸£å¸‚</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="directionSelect">æ–¹å‘</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #FF9800; font-size: 1rem;" id="directionSelect" onchange="applyFilters('direction')">
                        <option value="">æ‰€æœ‰æ–¹å‘</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortSelect">é‡Œç¨‹æ’åº</label>
                    <select style="padding: 10px; border-radius: 5px; border: 2px solid #FF9800; font-size: 1rem;" id="sortSelect" onchange="applySorting()">
                        <option value="">é è¨­æ’åº</option>
                        <option value="mile-asc">é‡Œç¨‹æ•¸ â†‘ (å°åˆ°å¤§)</option>
                        <option value="mile-desc">é‡Œç¨‹æ•¸ â†“ (å¤§åˆ°å°)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button onclick="resetFilters()"><i class="fas fa-refresh"></i> é‡ç½®ç¯©é¸</button>
                </div>
            </div>
        </div>

        <!-- ä¸Šæ–¹åˆ†é  -->
        <div id="pagination-top" class="pagination" style="display: none;">
            <button onclick="changePage(-1)"><i class="fas fa-chevron-left"></i> ä¸Šä¸€é </button>
            <span id="pageInfoTop">ç¬¬ 1 é ï¼Œå…± 1 é </span>
            <button onclick="changePage(1)">ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i></button>
        </div>

        <div id="cameras-container" class="loading">
            <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥çœé“ç›£è¦–å™¨è³‡æ–™ä¸­...
        </div>

        <!-- ä¸‹æ–¹åˆ†é  -->
        <div id="pagination" class="pagination" style="display: none;">
            <button onclick="changePage(-1)" id="prevBtn"><i class="fas fa-chevron-left"></i> ä¸Šä¸€é </button>
            <span id="pageInfo">ç¬¬ 1 é ï¼Œå…± 1 é </span>
            <button onclick="changePage(1)" id="nextBtn">ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- å½±åƒå½ˆçª— -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img class="modal-image" id="modalImage" alt="ç›£è¦–å™¨å½±åƒ">
            <div class="modal-info">
                <h2 id="modalTitle">çœé“ç›£è¦–å™¨è³‡è¨Š</h2>
                <p id="modalLocation"></p>
                <p id="modalRoad"></p>
                <p id="modalCoords"></p>
            </div>
        </div>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        let allCameras = [];
        let filteredCameras = [];
        let currentPage = 1;
        let itemsPerPage = 30;
        let totalPages = 1;
        
        // å¿«é€Ÿé“è·¯åˆ—è¡¨ï¼ˆç”¨æ–¼æ’é™¤ï¼‰
        const EXPRESSWAYS = [
            'å°61', 'å°62', 'å°63', 'å°64', 'å°65', 'å°66', 'å°68', 
            'å°72', 'å°74', 'å°76', 'å°78', 'å°82', 'å°84', 'å°86', 'å°88'
        ];
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºå¿«é€Ÿé“è·¯
        function isExpressway(camera) {
            const roadName = camera.RoadName || '';
            const locationDesc = camera.LocationDescription || '';
            const allText = `${roadName} ${locationDesc}`;
            
            // æª¢æŸ¥æ˜¯å¦åŒ…å«å¿«é€Ÿé“è·¯ç·¨è™Ÿ
            for (const expressway of EXPRESSWAYS) {
                const pattern = new RegExp(`[å°è‡º](${expressway.slice(1)})ç·š?`, 'g');
                if (pattern.test(allText)) {
                    return true;
                }
            }
            
            // ç‰¹æ®Šè™•ç†ä¸€äº›åˆ¥å
            if (allText.includes('è¥¿æ¿±') || allText.includes('è¥¿éƒ¨æ¿±æµ·') ||
                allText.includes('ä¸­æŠ•') || allText.includes('è¬é‡Œç‘æ¿±')) {
                return true;
            }
            
            return false;
        }
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºçœé“ï¼ˆæ’é™¤åœ‹é“å’Œå¿«é€Ÿé“è·¯ï¼‰
        function isProvincialRoad(camera) {
            const roadName = camera.RoadName || '';
            const locationDesc = camera.LocationDescription || '';
            const cctvId = camera.CCTVID || '';
            const allText = `${roadName} ${locationDesc}`;
            
            // æ’é™¤åœ‹é“ï¼ˆç·¨è™Ÿä»¥ CCTV-N é–‹é ­ï¼‰
            if (cctvId.startsWith('CCTV-N')) {
                return false;
            }
            
            // æ’é™¤æ˜ç¢ºæ¨™ç¤ºç‚ºåœ‹é“çš„
            if (allText.includes('åœ‹é“')) {
                return false;
            }
            
            // åŒ¹é…çœé“æ ¼å¼ï¼šå°1ç·šã€å°9ç”²ç·šç­‰
            const match = allText.match(/[å°è‡º](\d+)([ç”²ä¹™ä¸™ä¸]?)ç·š?/);
            if (match) {
                const roadNum = parseInt(match[1]);
                const roadCode = `å°${match[1]}`;
                
                // æ’é™¤å¿«é€Ÿé“è·¯
                if (EXPRESSWAYS.includes(roadCode)) {
                    return false;
                }
                
                // çœé“é€šå¸¸ç·¨è™Ÿåœ¨ 1-200 ç¯„åœå…§
                if (roadNum >= 1 && roadNum <= 200) {
                    return true;
                }
            }
            
            return false;
        }
        
        // å¾è·¯æ®µè³‡è¨Šä¸­æå–çœé“è·¯ç·šç·¨è™Ÿ
        function extractroadNumber(camera) {
            const roadName = camera.RoadName || '';
            const locationDesc = camera.LocationDescription || '';
            const roadSection = typeof camera.RoadSection === 'string' ? camera.RoadSection : '';
            const allText = `${roadName} ${locationDesc} ${roadSection}`;
            
            // åŒ¹é…å°1ç·šã€å°9ç”²ç·šç­‰æ ¼å¼
            const match = allText.match(/[å°è‡º](\d+)([ç”²ä¹™ä¸™ä¸]?)ç·š?/);
            if (match) {
                const roadNumber = `å°${match[1]}${match[2] ? match[2] : ''}ç·š`;
                return roadNumber;
            }
            
            return '';
        }
        
        // åˆ‡æ›è³‡è¨Šé¢æ¿é¡¯ç¤º/éš±è—
        function toggleInfoPanel() {
            const content = document.getElementById('infoContent');
            const icon = document.getElementById('toggleIcon');
            const panel = document.getElementById('infoPanel');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                icon.style.transform = 'rotate(0deg)';
                panel.style.background = '#e8f5e8';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                icon.style.transform = 'rotate(180deg)';
                panel.style.background = '#f5f5f5';
            }
        }

        // å°‡è‹±æ–‡æ–¹å‘è½‰æ›ç‚ºä¸­æ–‡
        function convertDirectionToChinese(direction) {
            if (!direction || typeof direction !== 'string') {
                return direction;
            }
            
            const directionMap = {
                'S': 'å—',
                'N': 'åŒ—', 
                'E': 'æ±',
                'W': 'è¥¿',
                'South': 'å—',
                'North': 'åŒ—',
                'East': 'æ±',
                'West': 'è¥¿',
                'southbound': 'å—ä¸‹',
                'northbound': 'åŒ—ä¸Š',
                'eastbound': 'æ±å‘',
                'westbound': 'è¥¿å‘'
            };
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å®Œå…¨åŒ¹é…
            if (directionMap[direction]) {
                return directionMap[direction];
            }
            
            // æª¢æŸ¥æ˜¯å¦åŒ…å«æ–¹å‘é—œéµå­—
            for (const [english, chinese] of Object.entries(directionMap)) {
                if (direction.toLowerCase().includes(english.toLowerCase())) {
                    return direction.replace(new RegExp(english, 'gi'), chinese);
                }
            }
            
            return direction;
        }

        // æ ¼å¼åŒ–ä½ç½®è³‡è¨Šï¼ŒåŒ…å«é‡Œç¨‹ã€æ–¹å‘å’Œè·¯æ®µ
        function formatLocationInfo(camera) {
            let locationParts = [];
            
            // 1. å„ªå…ˆåŠ ä¸Šé“è·¯ç·šè™Ÿ
            const roadPrefix = camera.RoadNumber || camera.RoadName || 'çœé“';
            locationParts.push(roadPrefix);
            
            // 2. é¡¯ç¤ºé‡Œç¨‹ï¼ˆç¢ºä¿æ˜¯å­—ç¬¦ä¸²é¡å‹ï¼‰
            if (camera.LocationMile && typeof camera.LocationMile === 'string') {
                locationParts.push(camera.LocationMile);
            } else if (camera.LocationDescription && typeof camera.LocationDescription === 'string') {
                locationParts.push(camera.LocationDescription);
            }
            
            // 3. æ·»åŠ æ–¹å‘è³‡è¨Šï¼ˆç¢ºä¿æ˜¯å­—ç¬¦ä¸²é¡å‹ä¸¦è½‰æ›ç‚ºä¸­æ–‡ï¼‰
            if (camera.RoadDirection && typeof camera.RoadDirection === 'string') {
                const chineseDirection = convertDirectionToChinese(camera.RoadDirection);
                locationParts.push(chineseDirection);
            }
            
            // 4. æ·»åŠ è·¯æ®µè³‡è¨Šï¼ˆç¢ºä¿æ˜¯å­—ç¬¦ä¸²é¡å‹ï¼‰
            if (camera.RoadSection && typeof camera.RoadSection === 'string') {
                locationParts.push(camera.RoadSection);
            } else if (camera.LocationDescription && typeof camera.LocationDescription === 'string') {
                // å¦‚æœæ²’æœ‰å°ˆé–€çš„è·¯æ®µæ¬„ä½ï¼Œå˜—è©¦å¾ä½ç½®æè¿°ä¸­æå–è·¯æ®µä¿¡æ¯
                const sectionMatches = camera.LocationDescription.match(/(.*?æ®µ|.*?ç·š|.*?äº¤æµé“|.*?æ”¶è²»ç«™|.*?æœå‹™å€)/);
                if (sectionMatches) {
                    const sectionInfo = sectionMatches[1];
                    // åªæœ‰ç•¶sectionInfoä¸åŒæ–¼å·²æœ‰çš„LocationMileæ™‚æ‰æ·»åŠ 
                    if (!camera.LocationMile || !camera.LocationMile.includes(sectionInfo)) {
                        locationParts.push(sectionInfo);
                    }
                }
            }
            
            return locationParts.length > 0 ? locationParts.join(' ') : 'æœªæä¾›ä½ç½®è³‡è¨Š';
        }

        // æ ¹æ“šç¶“ç·¯åº¦åˆ¤æ–·ç¸£å¸‚
        function getCityFromCoordinates(lon, lat, roadName = '') {
            if (!lon || !lat) return 'æœªçŸ¥';
            
            // å°ç£å„ç¸£å¸‚ç¶“ç·¯åº¦ç¯„åœ
            const cityRanges = [
                { name: 'å°åŒ—å¸‚', lonMin: 121.45, lonMax: 121.65, latMin: 24.95, latMax: 25.20 },
                { name: 'åŸºéš†å¸‚', lonMin: 121.65, lonMax: 121.85, latMin: 25.10, latMax: 25.25 },
                { name: 'æ–°åŒ—å¸‚', lonMin: 121.20, lonMax: 121.95, latMin: 24.70, latMax: 25.30 },
                { name: 'æ¡ƒåœ’å¸‚', lonMin: 121.05, lonMax: 121.50, latMin: 24.75, latMax: 25.05 },
                { name: 'æ–°ç«¹ç¸£', lonMin: 120.80, lonMax: 121.30, latMin: 24.55, latMax: 24.85 },
                { name: 'æ–°ç«¹å¸‚', lonMin: 120.90, lonMax: 121.05, latMin: 24.75, latMax: 24.85 },
                { name: 'è‹—æ —ç¸£', lonMin: 120.55, lonMax: 121.15, latMin: 24.25, latMax: 24.75 },
                { name: 'å°ä¸­å¸‚', lonMin: 120.45, lonMax: 121.25, latMin: 24.05, latMax: 24.55 },
                { name: 'å½°åŒ–ç¸£', lonMin: 120.35, lonMax: 120.75, latMin: 23.85, latMax: 24.25 },
                { name: 'å—æŠ•ç¸£', lonMin: 120.65, lonMax: 121.25, latMin: 23.45, latMax: 24.15 },
                { name: 'é›²æ—ç¸£', lonMin: 120.15, lonMax: 120.65, latMin: 23.45, latMax: 23.85 },
                { name: 'å˜‰ç¾©ç¸£', lonMin: 120.15, lonMax: 120.75, latMin: 23.15, latMax: 23.65 },
                { name: 'å˜‰ç¾©å¸‚', lonMin: 120.40, lonMax: 120.50, latMin: 23.45, latMax: 23.52 },
                { name: 'å°å—å¸‚', lonMin: 120.05, lonMax: 120.65, latMin: 22.85, latMax: 23.45 },
                { name: 'é«˜é›„å¸‚', lonMin: 120.15, lonMax: 120.95, latMin: 22.45, latMax: 23.15 },
                { name: 'å±æ±ç¸£', lonMin: 120.25, lonMax: 120.95, latMin: 21.85, latMax: 22.85 },
                { name: 'å®œè˜­ç¸£', lonMin: 121.55, lonMax: 122.05, latMin: 24.25, latMax: 24.95 },
                { name: 'èŠ±è“®ç¸£', lonMin: 121.15, lonMax: 121.75, latMin: 23.00, latMax: 24.45 },
                { name: 'å°æ±ç¸£', lonMin: 120.95, lonMax: 121.65, latMin: 22.35, latMax: 23.55 }
            ];
            
            for (const city of cityRanges) {
                if (lon >= city.lonMin && lon <= city.lonMax && 
                    lat >= city.latMin && lat <= city.latMax) {
                    return city.name;
                }
            }
            
            return 'æœªçŸ¥';
        }

        // è™•ç†å½±åƒè¼‰å…¥éŒ¯èª¤ - æ”¹é€²ç‰ˆæœ¬ï¼Œè§£æ±ºCORSå•é¡Œ
        function handleImageError(img, originalUrl) {
            // å˜—è©¦ä½¿ç”¨ä»£ç†æˆ–å‚™ç”¨æ–¹æ¡ˆ
            if (originalUrl && !img.dataset.retried) {
                img.dataset.retried = 'true';
                // æ·»åŠ æ™‚é–“æˆ³é¿å…å¿«å–å•é¡Œ
                const separator = originalUrl.includes('?') ? '&' : '?';
                const newUrl = `${originalUrl}${separator}t=${Date.now()}`;
                img.src = newUrl;
                return;
            }
            
            // æœ€çµ‚å¤±æ•—æ™‚é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            img.parentNode.innerHTML = `
                <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#999;background:#f5f5f5;border-radius:8px;padding:10px;">
                    <i class="fas fa-exclamation-triangle" style="font-size:2rem;margin-bottom:8px;color:#f44336;"></i>
                    <span style="font-size:0.85rem;text-align:center;line-height:1.4;">
                        ç›£è¦–å™¨å½±åƒ<br>è¼‰å…¥å¤±æ•—
                    </span>
                    <small style="font-size:0.7rem;color:#999;margin-top:4px;">å¯èƒ½ç‚ºCORSé™åˆ¶</small>
                </div>
            `;
        }

        // ç¢ºä¿é€²åº¦æ¢å‡½æ•¸å¯ç”¨çš„è¼”åŠ©å‡½æ•¸
        function ensureProgressFunctions() {
            if (typeof window.setLoadingProgress !== 'function') {
                window.setLoadingProgress = function() { console.warn('setLoadingProgress not available'); };
            }
            if (typeof window.updateLoadingLabel !== 'function') {
                window.updateLoadingLabel = function() { console.warn('updateLoadingLabel not available'); };
            }
            if (typeof window.finishLoading !== 'function') {
                window.finishLoading = function() { console.warn('finishLoading not available'); };
            }
        }

        async function loadCameras() {
            const container = document.getElementById('cameras-container');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥çœé“ç›£è¦–å™¨è³‡æ–™ä¸­...</div>';
            
            // ç¢ºä¿é€²åº¦æ¢å‡½æ•¸å¯ç”¨
            ensureProgressFunctions();
            
            // æ›´æ–°é€²åº¦ - æ¸›å°‘é »ç‡
            window.setLoadingProgress(25);
            window.updateLoadingLabel('é€£æ¥TDX API...');
            
            let allCamerasFromSources = [];
            
            try {
                console.log('æ­£åœ¨è¼‰å…¥çœé“ç›£è¦–å™¨è³‡æ–™...');
                
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¼‰å…¥çœé“ç›£è¦–å™¨è³‡æ–™...<br>
                        <small style="margin-top: 10px; display: block;">å¾ TDX å¹³å°è¼‰å…¥å…¨åœ‹çœé“ç›£è¦–å™¨ä¸¦ç¯©é¸çœé“...</small>
                    </div>
                `;
                
                // å»¶é²é€²åº¦æ›´æ–°ä»¥æ¸›å°‘é »ç¹èª¿ç”¨
                setTimeout(() => {
                    window.setLoadingProgress(50);
                    window.updateLoadingLabel('è¼‰å…¥çœé“ç›£è¦–å™¨è³‡æ–™...');
                }, 100);
                
                // ä½¿ç”¨ TDX Highway ç«¯é»è¼‰å…¥å…¨åœ‹é“è·¯ç›£è¦–å™¨ï¼ˆåŒ…å«çœé“ï¼‰
                const endpoint = '/v2/Road/Traffic/CCTV/Highway?$format=JSON';
                console.log('ğŸ“ è¼‰å…¥ Highway ç«¯é»è³‡æ–™ä¸¦ç¯©é¸çœé“...');
                
                const response = await tdxApi.fetchCCTV(endpoint);
                
                // æ›´æ–°é€²åº¦
                window.setLoadingProgress(75);
                window.updateLoadingLabel('ç¯©é¸çœé“ç›£è¦–å™¨...');
                
                let cameras = [];
                if (Array.isArray(response)) {
                    cameras = response;
                } else if (response && response.CCTVs && Array.isArray(response.CCTVs)) {
                    cameras = response.CCTVs;
                } else if (response && response.data && Array.isArray(response.data)) {
                    cameras = response.data;
                } else {
                    console.warn('æœªé æœŸçš„å›æ‡‰æ ¼å¼:', response);
                    cameras = [];
                }
                
                console.log(`ğŸ“Š TDX Highway åŸå§‹è³‡æ–™: ${cameras.length} ç­†`);
                
                if (cameras.length > 0) {
                    // ç¯©é¸ä¸¦è™•ç†çœé“ç›£è¦–å™¨è³‡æ–™
                    allCamerasFromSources = cameras
                        .filter(camera => isProvincialRoad(camera)) // åªä¿ç•™çœé“
                        .map(camera => {
                            const roadNumber = extractroadNumber(camera);
                            return {...camera, source: 'tdx', RoadNumber: roadNumber || camera.RoadName || 'çœé“'};
                        })
                        .filter(camera => camera.RoadNumber); // åªä¿ç•™æœ‰é“è·¯ç·¨è™Ÿçš„
                }
                
            } catch (error) {
                console.error('è¼‰å…¥çœé“ç›£è¦–å™¨è³‡æ–™å¤±æ•—:', error);
                window.finishLoading();
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        è¼‰å…¥å¤±æ•—: ${error.message}<br><br>
                        <button onclick="loadCameras()" style="padding: 10px 20px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-refresh"></i> é‡æ–°è¼‰å…¥
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log(`ğŸ“Š çœé“ç›£è¦–å™¨: ${allCamerasFromSources.length} ç­†`);
            
            if (allCamerasFromSources.length === 0) {
                container.innerHTML = '<div class="loading">ç›®å‰æ²’æœ‰å¯ç”¨çš„çœé“ç›£è¦–å™¨è³‡æ–™</div>';
                return;
            }
            
            // è™•ç†ç›£è¦–å™¨è³‡æ–™
            allCameras = allCamerasFromSources.map(camera => ({
                ...camera,
                City: getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName)
            }));
            
            filteredCameras = allCameras;
            populateFilters();
            updateStats();
            displayCameras(allCameras);
            
            // å®Œæˆè¼‰å…¥é€²åº¦
            window.setLoadingProgress(100);
            setTimeout(() => {
                window.finishLoading();
            }, 200);
        }

        function populateFilters() {
            updateRoadSelect(allCameras);
            updateCitySelect(allCameras);
            updateDirectionSelect(allCameras);
        }

        function updateStats() {
            document.getElementById('totalCameras').textContent = allCameras.length;
            const available = allCameras.filter(c => c.VideoImageUrl || c.VideoStreamURL).length;
            document.getElementById('availableCameras').textContent = available;
            document.getElementById('filteredCameras').textContent = filteredCameras.length;
            
            // è¨ˆç®—çœé“æ•¸é‡
            const roads = [...new Set(allCameras.map(c => c.RoadNumber).filter(Boolean))];
            document.getElementById('roadCount').textContent = roads.length;
        }
        
        // æ›´æ–°æ–¹å‘ç¯©é¸ä¸‹æ‹‰é¸å–®
        function updateDirectionSelect(cameras, selectedValue = '') {
            const directions = [...new Set(cameras.map(c => extractDirection(c)).filter(Boolean))];
            
            // æ–¹å‘æ’åºï¼šæ±ã€è¥¿ã€å—ã€åŒ—
            const directionOrder = ['æ±å‘', 'è¥¿å‘', 'å—å‘', 'åŒ—å‘'];
            const sortedDirections = directions.sort((a, b) => {
                const indexA = directionOrder.indexOf(a);
                const indexB = directionOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            const directionSelect = document.getElementById('directionSelect');
            directionSelect.innerHTML = '<option value="">æ‰€æœ‰æ–¹å‘</option>' + 
                sortedDirections.map(direction => {
                    const count = cameras.filter(c => extractDirection(c) === direction).length;
                    // æ·»åŠ æ–¹å‘åœ–æ¨™
                    let icon = 'ğŸ§­';
                    if (direction === 'åŒ—å‘') icon = 'â¬†ï¸';
                    else if (direction === 'å—å‘') icon = 'â¬‡ï¸';
                    else if (direction === 'æ±å‘') icon = 'â¡ï¸';
                    else if (direction === 'è¥¿å‘') icon = 'â¬…ï¸';
                    
                    return `<option value="${direction}">${icon} ${direction} (${count})</option>`;
                }).join('');
            
            if (selectedValue && sortedDirections.includes(selectedValue)) {
                directionSelect.value = selectedValue;
            }
        }
        
        // æ–°å¢ï¼šå¾é‡Œç¨‹è³‡è¨Šä¸­æå–æ•¸å€¼
        function extractMileageNumber(camera) {
            const locationMile = camera.LocationMile || '';
            const locationDesc = camera.LocationDescription || '';
            const allText = `${locationMile} ${locationDesc}`;
            
            // å˜—è©¦åŒ¹é…å„ç¨®é‡Œç¨‹æ ¼å¼
            // ä¾‹å¦‚ï¼š125Kã€125.5Kã€125K+500ã€125å…¬é‡Œã€125km
            const patterns = [
                /(\d+\.?\d*)K\+(\d+)/i,  // 125K+500
                /(\d+\.?\d*)K/i,          // 125K æˆ– 125.5K
                /(\d+\.?\d*)å…¬é‡Œ/,        // 125å…¬é‡Œ
                /(\d+\.?\d*)km/i,         // 125km
                /é‡Œç¨‹[ï¼š:]\s*(\d+\.?\d*)/  // é‡Œç¨‹ï¼š125
            ];
            
            for (const pattern of patterns) {
                const match = allText.match(pattern);
                if (match) {
                    if (pattern === patterns[0]) {
                        // K+æ ¼å¼ï¼šä¾‹å¦‚ 125K+500 = 125.5
                        return parseFloat(match[1]) + parseFloat(match[2]) / 1000;
                    } else {
                        return parseFloat(match[1]);
                    }
                }
            }
            
            return null;
        }
        
        // æå–æ–¹å‘è³‡è¨Šï¼Œçµ±ä¸€ç‚ºæ±å‘ã€è¥¿å‘ã€å—å‘ã€åŒ—å‘
        function extractDirection(camera) {
            const roadDirection = camera.RoadDirection || '';
            const roadName = camera.RoadName || '';
            const locationDesc = camera.LocationDescription || '';
            const allText = `${roadDirection} ${roadName} ${locationDesc}`.toUpperCase();
            
            // åˆ¤æ–·åŒ—å‘ï¼ˆå„ªå…ˆé †åºï¼šå®Œæ•´å–®å­— > å–®å­—æ¯ï¼‰
            if (allText.includes('NORTH') || allText.includes('åŒ—')) {
                return 'åŒ—å‘';
            }
            
            // åˆ¤æ–·å—å‘
            if (allText.includes('SOUTH') || allText.includes('å—')) {
                return 'å—å‘';
            }
            
            // åˆ¤æ–·æ±å‘
            if (allText.includes('EAST') || allText.includes('æ±')) {
                return 'æ±å‘';
            }
            
            // åˆ¤æ–·è¥¿å‘
            if (allText.includes('WEST') || allText.includes('è¥¿')) {
                return 'è¥¿å‘';
            }
            
            // å–®å­—æ¯åˆ¤æ–·ï¼ˆç•¶æ²’æœ‰å®Œæ•´å–®å­—æ™‚ï¼‰
            const upperRoadDirection = roadDirection.toUpperCase().trim();
            if (upperRoadDirection === 'N' || upperRoadDirection.startsWith('N ') || upperRoadDirection.endsWith(' N')) {
                return 'åŒ—å‘';
            }
            if (upperRoadDirection === 'S' || upperRoadDirection.startsWith('S ') || upperRoadDirection.endsWith(' S')) {
                return 'å—å‘';
            }
            if (upperRoadDirection === 'E' || upperRoadDirection.startsWith('E ') || upperRoadDirection.endsWith(' E')) {
                return 'æ±å‘';
            }
            if (upperRoadDirection === 'W' || upperRoadDirection.startsWith('W ') || upperRoadDirection.endsWith(' W')) {
                return 'è¥¿å‘';
            }
            
            return null;
        }
        
        // æ–°å¢ï¼šæ ¼å¼åŒ–é‡Œç¨‹é¡¯ç¤ºï¼Œä¿æŒåŸå§‹æ ¼å¼ä¸¦æå–è·¯æ®µè³‡è¨Š
        function formatMileageDisplay(camera) {
            const locationMile = camera.LocationMile || '';
            const locationDesc = camera.LocationDescription || '';
            const roadName = camera.RoadName || '';
            const allText = `${locationMile} ${locationDesc} ${roadName}`;
            
            let mileageDisplay = '';
            let segmentInfo = '';
            
            // æå–åŸå§‹é‡Œç¨‹æ ¼å¼
            const mileagePatterns = [
                /(\d+K\+\d+)/i,           // 125K+500 (ä¿æŒåŸæ ¼å¼)
                /(\d+\.?\d*K)/i,          // 125K æˆ– 125.5K
                /(\d+\.?\d*)å…¬é‡Œ/,        // 125å…¬é‡Œ
                /(\d+\.?\d*)km/i,         // 125km
                /é‡Œç¨‹[ï¼š:]\s*(\d+\.?\d*)/ // é‡Œç¨‹ï¼š125
            ];
            
            for (const pattern of mileagePatterns) {
                const match = allText.match(pattern);
                if (match) {
                    mileageDisplay = match[1];
                    // å¦‚æœä¸æ˜¯K+æ ¼å¼ï¼Œè½‰æ›ç‚ºKæ ¼å¼
                    if (!mileageDisplay.includes('K')) {
                        const num = parseFloat(match[1]);
                        mileageDisplay = `${num}K`;
                    }
                    break;
                }
            }
            
            // æå–è·¯æ®µè³‡è¨Šï¼ˆäº¤æµé“ã€æ©‹æ¨‘ã€éš§é“ç­‰åœ°æ¨™ï¼‰
            const segmentPatterns = [
                /([^ï¼Œ,ã€‚\s]*(?:äº¤æµé“|ç³»çµ±äº¤æµé“))/g,     // å„ç¨®äº¤æµé“
                /([^ï¼Œ,ã€‚\s]*(?:æ©‹|å¤§æ©‹|é™¸æ©‹|å¤©æ©‹))/g,     // å„ç¨®æ©‹æ¨‘  
                /([^ï¼Œ,ã€‚\s]*(?:éš§é“))/g,                // éš§é“
                /([^ï¼Œ,ã€‚\s]*(?:æ”¶è²»ç«™|æœå‹™å€))/g,        // æ”¶è²»ç«™ã€æœå‹™å€
                /([^ï¼Œ,ã€‚\s]*(?:åŒé“|è¯çµ¡é“))/g,          // åŒé“ã€è¯çµ¡é“
                /([^ï¼Œ,ã€‚\s]*(?:è·¯å£|åå­—è·¯å£))/g,        // è·¯å£
                /([^ï¼Œ,ã€‚\s]*(?:è»Šç«™|ç«è»Šç«™|é«˜éµç«™))/g,    // è»Šç«™
                /([^ï¼Œ,ã€‚\s]*(?:å·¥æ¥­å€|ç§‘å­¸åœ’å€|å·¥æ¥­åœ’å€))/g, // å·¥æ¥­å€ç­‰
                /(è¿‘\s*[^ï¼Œ,ã€‚\s]+)/g,                   // è¿‘æŸåœ°é»
                /(è·\s*[^ï¼Œ,ã€‚\s]+)/g                    // è·æŸåœ°é»
            ];
            
            const segments = [];
            for (const pattern of segmentPatterns) {
                const matches = allText.match(pattern);
                if (matches) {
                    segments.push(...matches);
                }
            }
            
            // å»é‡ä¸¦å–æœ€ç›¸é—œçš„è·¯æ®µè³‡è¨Šï¼ˆé€šå¸¸æ˜¯æœ€å¾Œä¸€å€‹æˆ–æœ€é•·çš„ï¼‰
            const uniqueSegments = [...new Set(segments)];
            if (uniqueSegments.length > 0) {
                // å„ªå…ˆé¸æ“‡åŒ…å«äº¤æµé“ã€æ©‹ã€éš§é“ç­‰é‡è¦åœ°æ¨™çš„
                const importantSegments = uniqueSegments.filter(seg => 
                    /äº¤æµé“|æ©‹|éš§é“|æ”¶è²»ç«™|æœå‹™å€/.test(seg)
                );
                segmentInfo = importantSegments.length > 0 ? importantSegments[0] : uniqueSegments[0];
            }
            
            return {
                mileage: mileageDisplay,
                segment: segmentInfo
            };
        }
        
        // æ–°å¢ï¼šæ‡‰ç”¨æ’åº
        function applySorting() {
            const sortValue = document.getElementById('sortSelect').value;
            
            if (!sortValue) {
                // æ¢å¾©é è¨­æ’åº
                displayCameras(filteredCameras);
                return;
            }
            
            const sortedCameras = [...filteredCameras].sort((a, b) => {
                const mileA = extractMileageNumber(a);
                const mileB = extractMileageNumber(b);
                
                // æ²’æœ‰é‡Œç¨‹è³‡è¨Šçš„æ”¾åœ¨æœ€å¾Œ
                if (mileA === null && mileB === null) return 0;
                if (mileA === null) return 1;
                if (mileB === null) return -1;
                
                if (sortValue === 'mile-asc') {
                    return mileA - mileB;  // å‡åº
                } else if (sortValue === 'mile-desc') {
                    return mileB - mileA;  // é™åº
                }
                
                return 0;
            });
            
            currentPage = 1;
            displayCameras(sortedCameras);
        }
        
        function applyFilters(changedFilter = null) {
            const roadFilter = document.getElementById('roadSelect').value;
            const cityFilter = document.getElementById('citySelect').value;
            const directionFilter = document.getElementById('directionSelect').value;
            
            if (changedFilter === 'road') {
                if (roadFilter) {
                    const camerasForRoad = allCameras.filter(camera => camera.RoadNumber === roadFilter);
                    const citiesForRoad = [...new Set(camerasForRoad.map(c => c.City).filter(Boolean))].sort();
                    const directionsForRoad = [...new Set(camerasForRoad.map(c => extractDirection(c)).filter(Boolean))].sort();
                    
                    const citySelect = document.getElementById('citySelect');
                    const directionSelect = document.getElementById('directionSelect');
                    const currentCityValue = citySelect.value;
                    const currentDirectionValue = directionSelect.value;
                    
                    citySelect.innerHTML = '<option value="">æ‰€æœ‰ç¸£å¸‚</option>' + 
                        citiesForRoad.map(city => {
                            const count = camerasForRoad.filter(c => c.City === city).length;
                            return `<option value="${city}">${city} (${count})</option>`;
                        }).join('');
                    
                    directionSelect.innerHTML = '<option value="">æ‰€æœ‰æ–¹å‘</option>' + 
                        directionsForRoad.map(direction => {
                            const count = camerasForRoad.filter(c => extractDirection(c) === direction).length;
                            return `<option value="${direction}">${direction} (${count})</option>`;
                        }).join('');
                    
                    if (currentCityValue && citiesForRoad.includes(currentCityValue)) {
                        citySelect.value = currentCityValue;
                    }
                    if (currentDirectionValue && directionsForRoad.includes(currentDirectionValue)) {
                        directionSelect.value = currentDirectionValue;
                    }
                } else {
                    updateCitySelect(allCameras);
                    updateDirectionSelect(allCameras);
                }
            } else if (changedFilter === 'city') {
                if (cityFilter) {
                    const camerasForCity = allCameras.filter(camera => camera.City === cityFilter);
                    const roadsForCity = [...new Set(camerasForCity.map(c => c.RoadNumber).filter(Boolean))].sort((a, b) => {
                        const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                        const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                        return numA - numB;
                    });
                    const directionsForCity = [...new Set(camerasForCity.map(c => extractDirection(c)).filter(Boolean))].sort();
                    
                    const roadSelect = document.getElementById('roadSelect');
                    const directionSelect = document.getElementById('directionSelect');
                    const currentRoadValue = roadSelect.value;
                    const currentDirectionValue = directionSelect.value;
                    
                    roadSelect.innerHTML = '<option value="">æ‰€æœ‰çœé“</option>' + 
                        roadsForCity.map(road => {
                            const count = camerasForCity.filter(c => c.RoadNumber === road).length;
                            return `<option value="${road}">${road} (${count})</option>`;
                        }).join('');
                    
                    directionSelect.innerHTML = '<option value="">æ‰€æœ‰æ–¹å‘</option>' + 
                        directionsForCity.map(direction => {
                            const count = camerasForCity.filter(c => extractDirection(c) === direction).length;
                            return `<option value="${direction}">${direction} (${count})</option>`;
                        }).join('');
                    
                    if (currentRoadValue && roadsForCity.includes(currentRoadValue)) {
                        roadSelect.value = currentRoadValue;
                    }
                    if (currentDirectionValue && directionsForCity.includes(currentDirectionValue)) {
                        directionSelect.value = currentDirectionValue;
                    }
                } else {
                    updateRoadSelect(allCameras);
                    updateDirectionSelect(allCameras);
                }
            } else if (changedFilter === 'direction') {
                if (directionFilter) {
                    const camerasForDirection = allCameras.filter(camera => extractDirection(camera) === directionFilter);
                    const roadsForDirection = [...new Set(camerasForDirection.map(c => c.RoadNumber).filter(Boolean))].sort((a, b) => {
                        const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                        const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                        return numA - numB;
                    });
                    const citiesForDirection = [...new Set(camerasForDirection.map(c => c.City).filter(Boolean))].sort();
                    
                    const roadSelect = document.getElementById('roadSelect');
                    const citySelect = document.getElementById('citySelect');
                    const currentRoadValue = roadSelect.value;
                    const currentCityValue = citySelect.value;
                    
                    roadSelect.innerHTML = '<option value="">æ‰€æœ‰çœé“</option>' + 
                        roadsForDirection.map(road => {
                            const count = camerasForDirection.filter(c => c.RoadNumber === road).length;
                            return `<option value="${road}">${road} (${count})</option>`;
                        }).join('');
                    
                    citySelect.innerHTML = '<option value="">æ‰€æœ‰ç¸£å¸‚</option>' + 
                        citiesForDirection.map(city => {
                            const count = camerasForDirection.filter(c => c.City === city).length;
                            return `<option value="${city}">${city} (${count})</option>`;
                        }).join('');
                    
                    if (currentRoadValue && roadsForDirection.includes(currentRoadValue)) {
                        roadSelect.value = currentRoadValue;
                    }
                    if (currentCityValue && citiesForDirection.includes(currentCityValue)) {
                        citySelect.value = currentCityValue;
                    }
                } else {
                    updateRoadSelect(allCameras);
                    updateCitySelect(allCameras);
                }
            }
            
            filteredCameras = allCameras.filter(camera => {
                const matchRoad = !roadFilter || camera.RoadNumber === roadFilter;
                const matchCity = !cityFilter || camera.City === cityFilter;
                const matchDirection = !directionFilter || extractDirection(camera) === directionFilter;
                return matchRoad && matchCity && matchDirection;
            });
            
            currentPage = 1;
            updateStats();
            
            // æ‡‰ç”¨ç•¶å‰çš„æ’åºè¨­å®š
            const sortValue = document.getElementById('sortSelect').value;
            if (sortValue) {
                applySorting();
            } else {
                displayCameras(filteredCameras);
            }
        }

        function resetFilters() {
            document.getElementById('roadSelect').value = '';
            document.getElementById('citySelect').value = '';
            document.getElementById('directionSelect').value = '';
            document.getElementById('sortSelect').value = '';
            applyFilters();
        }
        
        function updateRoadSelect(cameras, selectedValue = '') {
            const roads = [...new Set(cameras.map(c => c.RoadNumber).filter(Boolean))].sort((a, b) => {
                const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                return numA - numB;
            });
            
            const roadSelect = document.getElementById('roadSelect');
            roadSelect.innerHTML = '<option value="">æ‰€æœ‰çœé“</option>' + 
                roads.map(road => {
                    const count = cameras.filter(c => c.RoadNumber === road).length;
                    return `<option value="${road}" ${road === selectedValue ? 'selected' : ''}>${road} (${count})</option>`;
                }).join('');
        }
        
        function updateCitySelect(cameras, selectedValue = '') {
            const cities = [...new Set(cameras.map(c => c.City).filter(Boolean))].sort();
            
            const citySelect = document.getElementById('citySelect');
            citySelect.innerHTML = '<option value="">æ‰€æœ‰ç¸£å¸‚</option>' + 
                cities.map(city => {
                    const count = cameras.filter(c => c.City === city).length;
                    return `<option value="${city}" ${city === selectedValue ? 'selected' : ''}>${city} (${count})</option>`;
                }).join('');
        }
        
        function updateDirectionSelect(cameras, selectedValue = '') {
            const directions = [...new Set(cameras.map(c => extractDirection(c)).filter(Boolean))].sort();
            
            const directionSelect = document.getElementById('directionSelect');
            directionSelect.innerHTML = '<option value="">æ‰€æœ‰æ–¹å‘</option>' + 
                directions.map(direction => {
                    const count = cameras.filter(c => extractDirection(c) === direction).length;
                    return `<option value="${direction}" ${direction === selectedValue ? 'selected' : ''}>${direction} (${count})</option>`;
                }).join('');
        }

        function displayCameras(cameras) {
            const container = document.getElementById('cameras-container');
            const pagination = document.getElementById('pagination');
            
            if (cameras.length === 0) {
                container.innerHTML = '<div class="loading">ç„¡ç¬¦åˆç¯©é¸æ¢ä»¶çš„çœé“ç›£è¦–å™¨</div>';
                pagination.style.display = 'none';
                return;
            }

            // è¨ˆç®—åˆ†é 
            totalPages = Math.ceil(cameras.length / itemsPerPage);
            if (currentPage > totalPages) currentPage = 1;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const displayCameras = cameras.slice(startIndex, endIndex);

            const grid = displayCameras.map((camera, index) => {
                const sourceIcon = camera.source === 'tdx' ? '<i class="fas fa-database" title="TDXè³‡æ–™" style="color: #2196F3;"></i>' : '';
                const roadNumber = camera.RoadNumber ? `<span class="road-badge">${camera.RoadNumber}</span>` : '';
                
                return `
                    <div class="camera-card" onclick="openModal(${startIndex + index})">
                        <div class="camera-image">
                            ${camera.VideoImageUrl || camera.VideoStreamURL ? 
                                `<img src="${camera.VideoImageUrl || camera.VideoStreamURL}" 
                                     alt="${camera.CCTVID || 'ç›£è¦–å™¨å½±åƒ'}" 
                                     loading="lazy"
                                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
                                     onerror="this.parentNode.innerHTML='<div style=&quot;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#999;background:#f5f5f5;border-radius:8px;&quot;><i class=&quot;fas fa-exclamation-triangle&quot; style=&quot;font-size:2rem;margin-bottom:8px;color:#f44336;&quot;></i><span style=&quot;font-size:0.85rem;text-align:center;&quot;>${camera.RoadName || 'ç›£è¦–å™¨'}<br>å½±åƒè¼‰å…¥å¤±æ•—</span></div>'">
                                 <div class="image-overlay">
                                     <i class="fas fa-search-plus" style="font-size: 2rem;"></i>
                                 </div>` : 
                                '<div class="no-image-placeholder"><i class="fas fa-video-slash" style="font-size: 2rem; color: #ccc; margin-bottom: 10px;"></i><span style="color: #666;">ç„¡å½±åƒè³‡æ–™</span></div>'
                            }
                        </div>
                        <div class="camera-info">
                            <h3>${roadNumber || 'çœé“ç›£è¦–å™¨'} ${sourceIcon}</h3>
                            ${(() => {
                                const city = camera.City || getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName);
                                const mileageInfo = formatMileageDisplay(camera);
                                const direction = extractDirection(camera);
                                
                                let infoHtml = '';
                                
                                // 1. ç¸£å¸‚
                                if (city && city !== 'æœªçŸ¥') {
                                    infoHtml += `<p><i class="fas fa-map-marker-alt" style="color: #FF9800;"></i> ${city}</p>`;
                                }
                                
                                // 2. é‡Œç¨‹ï¼ˆåœ¨é‡Œç¨‹å‰é¢å¿…å®šé¡¯ç¤ºè·¯ç·šç·¨è™Ÿï¼‰
                                if (mileageInfo.mileage) {
                                    let mileageText = mileageInfo.mileage;
                                    if (mileageInfo.segment) {
                                        mileageText += ` (${mileageInfo.segment})`;
                                    }
                                    // åœ¨é‡Œç¨‹å‰é¢å¿…é ˆåŠ ä¸Šè·¯ç·šç·¨è™Ÿï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨RoadName
                                    const roadPrefix = camera.RoadNumber || camera.RoadName || 'çœé“';
                                    infoHtml += `<p><i class="fas fa-road" style="color: #FF9800;"></i> ${roadPrefix} ${mileageText}</p>`;
                                }
                                
                                // 3. æ–¹å‘
                                if (direction) {
                                    infoHtml += `<p><i class="fas fa-compass" style="color: #FF9800;"></i> ${direction}</p>`;
                                }
                                
                                // 4. çœé“ç·¨è™Ÿå·²åœ¨æ¨™é¡Œé¡¯ç¤ºï¼Œä¸å†é‡è¤‡é¡¯ç¤º
                                
                                return infoHtml;
                            })()}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="cameras-grid">${grid}</div>`;
            
            // æ›´æ–°åˆ†é 
            updatePagination();
        }

        function updatePagination() {
            const paginationTop = document.getElementById('pagination-top');
            const paginationBottom = document.getElementById('pagination');
            const pageInfoTop = document.getElementById('pageInfoTop');
            const pageInfoBottom = document.getElementById('pageInfo');
            
            if (totalPages <= 1) {
                paginationTop.style.display = 'none';
                paginationBottom.style.display = 'none';
                return;
            }
            
            const pageText = `ç¬¬ ${currentPage} é  / å…± ${totalPages} é `;
            paginationTop.style.display = 'flex';
            paginationBottom.style.display = 'flex';
            pageInfoTop.textContent = pageText;
            pageInfoBottom.textContent = pageText;
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayCameras(filteredCameras);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function openModal(index) {
            const camera = filteredCameras[index];
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalLocation = document.getElementById('modalLocation');
            const modalRoad = document.getElementById('modalRoad');
            const modalCoords = document.getElementById('modalCoords');
            
            modalImg.src = camera.VideoImageUrl || camera.VideoStreamURL || '';
            modalTitle.textContent = camera.RoadName || 'çœé“ç›£è¦–å™¨';
            const locationInfo = formatLocationInfo(camera);
            modalLocation.innerHTML = `<i class="fas fa-map-marker-alt"></i> <strong>ä½ç½®ï¼š</strong>${locationInfo}`;
            modalRoad.innerHTML = `<i class="fas fa-road"></i> <strong>è·¯ç·šï¼š</strong>${camera.RoadNumber || 'æœªçŸ¥è·¯ç·š'} (${camera.City || getCityFromCoordinates(camera.PositionLon, camera.PositionLat, camera.RoadName)})`;
            
            let coordsHtml = '';
            if (camera.PositionLat && camera.PositionLon) {
                coordsHtml = `<i class="fas fa-crosshairs"></i> <strong>åº§æ¨™ï¼š</strong>
                    <a href="https://www.google.com/maps?q=${camera.PositionLat},${camera.PositionLon}" 
                       target="_blank" 
                       style="color: #FF9800; text-decoration: none;" 
                       title="åœ¨Googleåœ°åœ–ä¸­æŸ¥çœ‹">
                        ${camera.PositionLat.toFixed(6)}, ${camera.PositionLon.toFixed(6)}
                        <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-left: 3px;"></i>
                    </a>`;
            }
            const imageUrl = camera.VideoImageUrl || camera.VideoStreamURL;
            if (imageUrl) {
                coordsHtml += `<br><i class="fas fa-external-link-alt"></i> <strong>åŸå§‹å½±åƒï¼š</strong><a href="${imageUrl}" target="_blank" style="color: #FF9800; text-decoration: none;">é–‹å•ŸåŸå§‹å½±åƒé€£çµ</a>`;
            }
            modalCoords.innerHTML = coordsHtml;
            
            modal.style.display = 'block';
        }

        // é—œé–‰å½ˆçª—
        document.getElementsByClassName('close')[0].onclick = function() {
            document.getElementById('imageModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // åˆå§‹è¼‰å…¥
        window.onload = function() {
            // ç¢ºä¿é€²åº¦æ¢å·²åˆå§‹åŒ–å†é–‹å§‹è¼‰å…¥
            setTimeout(() => {
                loadCameras();
            }, 100);
        };
    </script>
</body>
</html>
