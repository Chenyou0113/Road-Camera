<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©æ°£è§€æ¸¬ç«™ | å³æ™‚æ•¸æ“š</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #1a1a2e; color: #fff; font-family: 'Microsoft JhengHei', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .back-btn { color: #aaa; text-decoration: none; display: flex; align-items: center; gap: 8px; font-weight: bold; transition: 0.3s; }
        .back-btn:hover { color: #4fc3f7; }

        .controls { background: #16213e; padding: 20px; border-radius: 15px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        select { background: #0f3460; color: white; border: 1px solid #533483; padding: 10px; border-radius: 8px; font-size: 1rem; outline: none; }
        
        .chart-card { background: #16213e; padding: 20px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 15px; padding-left: 10px; border-left: 4px solid #4fc3f7; }
        .chart-title { font-size: 1.2rem; font-weight: bold; }
        .chart-date { color: #aaa; font-size: 0.9rem; }

        canvas { width: 100% !important; height: 300px !important; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> å›é¦–é </a>
            <h1 style="margin:0; font-size: 1.8rem;">ğŸŒ¡ï¸ å¤©æ°£è§€æ¸¬ç«™</h1>
        </div>

        <div class="controls">
            <label><i class="fas fa-map-marker-alt"></i> é¸æ“‡æ¸¬ç«™ï¼š</label>
            <select id="stationSelect" onchange="loadStationData()">
                <option value="466920">è‡ºåŒ— (Taipei)</option>
                <option value="466940">åŸºéš† (Keelung)</option>
                <option value="466880">æ¿æ©‹ (Banqiao)</option>
                <option value="467490">è‡ºä¸­ (Taichung)</option>
                <option value="467410">è‡ºå— (Tainan)</option>
                <option value="467440">é«˜é›„ (Kaohsiung)</option>
                <option value="466990">èŠ±è“® (Hualien)</option>
                <option value="C0Z100">å£½è± (Shoufeng)</option>
            </select>
            <span id="statusText" style="color: #aaa; font-size: 0.9rem; margin-left: auto;"></span>
        </div>

        <div id="chartsContainer">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">éå» 24 å°æ™‚æº«åº¦è®ŠåŒ–</div>
                    <div class="chart-date" id="tempDateRange"></div>
                </div>
                <div class="chart-box"><canvas id="tempChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header" style="border-left-color: #00d9ff;">
                    <div class="chart-title">éå» 24 å°æ™‚ç›¸å°æ¿•åº¦è®ŠåŒ–</div>
                    <div class="chart-date" id="humDateRange"></div>
                </div>
                <div class="chart-box"><canvas id="humChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header" style="border-left-color: #7c4dff;">
                    <div class="chart-title">éå» 24 å°æ™‚ç´¯ç©é›¨é‡</div>
                    <div class="chart-date" id="rainDateRange"></div>
                </div>
                <div class="chart-box"><canvas id="rainChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header" style="border-left-color: #00e676;">
                    <div class="chart-title">éå» 24 å°æ™‚å¹³å‡é¢¨é€Ÿ</div>
                    <div class="chart-date" id="windDateRange"></div>
                </div>
                <div class="chart-box"><canvas id="windChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev';
        
        let tempChartInstance = null;
        let humChartInstance = null;
        let rainChartInstance = null;
        let windChartInstance = null; // æ–°å¢é¢¨é€Ÿå¯¦ä¾‹

        function formatTime(ts) {
            const d = new Date(ts);
            return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        function formatDate(ts) {
            const d = new Date(ts);
            return `${d.getMonth()+1}/${d.getDate()} ${formatTime(ts)}`;
        }

        async function loadStationData() {
            const stationId = document.getElementById('stationSelect').value;
            const statusEl = document.getElementById('statusText');
            statusEl.innerText = "â³ è³‡æ–™è®€å–ä¸­...";
            
            try {
                const res = await fetch(`${API_BASE}/api/history?stationId=${stationId}&history=true&t=${Date.now()}`);
                const data = await res.json();

                if (!Array.isArray(data) || data.length === 0) {
                    statusEl.innerText = "âŒ ç„¡æ­·å²è³‡æ–™ (è«‹ç¨å¾Œå†è©¦)";
                    return;
                }

                statusEl.innerText = `âœ… æ›´æ–°å®Œæˆ (å…± ${data.length} ç­†)`;
                renderCharts(data);

            } catch (e) {
                console.error(e);
                statusEl.innerText = "âš ï¸ é€£ç·šå¤±æ•—";
            }
        }

        function renderCharts(data) {
            // è³‡æ–™å»é‡é‚è¼¯
            const uniqueData = [];
            const seenTimes = new Set();

            data.forEach(d => {
                const dateObj = new Date(d.timestamp);
                const uniqueKey = `${dateObj.getMonth()}-${dateObj.getDate()} ${dateObj.getHours()}:${dateObj.getMinutes()}`;
                
                if (!seenTimes.has(uniqueKey)) {
                    seenTimes.add(uniqueKey);
                    uniqueData.push(d);
                }
            });

            // æº–å‚™æ•¸æ“š
            const labels = uniqueData.map(d => d.timestamp); 
            const temps = uniqueData.map(d => d.temperature);
            const hums = uniqueData.map(d => d.humidity);
            const rains = uniqueData.map(d => d.rain || 0);
            const winds = uniqueData.map(d => d.wind_speed || 0); // å–å‡ºé¢¨é€Ÿ

            // æ›´æ–°æ—¥æœŸæ–‡å­—
            if (uniqueData.length > 0) {
                const rangeText = `${formatDate(uniqueData[0].timestamp)} ~ ${formatDate(uniqueData[uniqueData.length-1].timestamp)}`;
                document.getElementById('tempDateRange').innerText = rangeText;
                document.getElementById('humDateRange').innerText = rangeText;
                document.getElementById('rainDateRange').innerText = rangeText;
                document.getElementById('windDateRange').innerText = rangeText;
            }

            // æ¸…é™¤èˆŠåœ–è¡¨
            if (tempChartInstance) tempChartInstance.destroy();
            if (humChartInstance) humChartInstance.destroy();
            if (rainChartInstance) rainChartInstance.destroy();
            if (windChartInstance) windChartInstance.destroy();

            // 1. æº«åº¦
            tempChartInstance = new Chart(document.getElementById('tempChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æº«åº¦ (Â°C)',
                        data: temps,
                        borderColor: '#ff9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        fill: true
                    }]
                },
                options: getChartOptions('Â°C')
            });

            // 2. æ¿•åº¦
            humChartInstance = new Chart(document.getElementById('humChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ¿•åº¦ (%)',
                        data: hums,
                        borderColor: '#00d9ff',
                        backgroundColor: 'rgba(0, 217, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        fill: true
                    }]
                },
                options: getChartOptions('%')
            });

            // 3. é›¨é‡
            rainChartInstance = new Chart(document.getElementById('rainChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ç´¯ç©é›¨é‡ (mm)',
                        data: rains,
                        backgroundColor: 'rgba(124, 77, 255, 0.6)',
                        borderColor: '#7c4dff',
                        borderWidth: 1,
                    }]
                },
                options: getChartOptions('mm')
            });

            // 4. ğŸ”¥ é¢¨é€Ÿ (æ–°å¢)
            windChartInstance = new Chart(document.getElementById('windChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é¢¨é€Ÿ (m/s)',
                        data: winds,
                        borderColor: '#00e676', // ç¶ è‰²
                        backgroundColor: 'rgba(0, 230, 118, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        fill: true
                    }]
                },
                options: getChartOptions('m/s')
            });
        }

        function getChartOptions(unit) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        callbacks: {
                            title: (items) => formatDate(items[0].label)
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#888',
                            maxTicksLimit: 8, 
                            maxRotation: 0,
                            callback: function(value) {
                                return formatTime(this.getLabelForValue(value));
                            }
                        },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    y: {
                        ticks: { color: '#888' },
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        title: { display: true, text: unit, color: '#666' }
                    }
                }
            };
        }

        loadStationData();
    </script>
</body>
</html>