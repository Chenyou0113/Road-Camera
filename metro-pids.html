<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METRO PIDS - Universal PC Edition</title>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&family=Roboto+Condensed:wght@700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
        }

        body {
            background-color: #000;
            height: 100vh;
            width: 100vw;
            display: flex;
            overflow: hidden;
        }

        /* ------------------ ä¸»ç‰ˆé¢ä½ˆå±€ ------------------ */
        .pids-container {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 26% 74%;
            grid-template-rows: 90% 10%;
        }

        /* ------------------ å·¦å´è³‡è¨Šæ¬„ ------------------ */
        .sidebar {
            display: grid;
            grid-template-rows: 50% 35% 15%;
            border-right: 2px solid #333;
        }

        /* 1. åˆ°ç«™å€’æ•¸å€ */
        .arrival-section {
            display: flex;
            flex-direction: column;
            gap: 1vh;
            padding: 2vh 1vw;
            background-color: #1a1a1a;
        }

        .arrival-card {
            background-color: #fff;
            color: #333;
            padding: 1.5vh 1vw;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 1vh;
            flex: 1;
        }

        .arrival-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .route-badge {
            padding: 8px 12px;
            border-radius: 8px;
            color: #fff;
            text-align: center;
            line-height: 1;
            min-width: 50px;
        }
        .route-badge .line { font-size: 1.8vw; font-weight: 900; }
        .route-badge .id { font-size: 1vw; font-weight: 700; margin-top: 2px; }

        .dest-wrap { flex: 1; }
        .dest-text { font-size: 2.2vw; font-weight: 900; letter-spacing: 2px; }
        .dest-en { font-size: 1vw; color: #666; font-weight: 500; margin-top: 2px; }

        .countdown-box {
            color: #fff;
            border-radius: 10px;
            text-align: center;
            padding: 2vh 0;
            font-size: 5vw;
            font-weight: 700;
            font-family: 'Roboto Condensed', sans-serif;
            letter-spacing: 3px;
        }

        /* 2. è»Šç«™è³‡è¨Šå€ */
        .station-info {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2vh;
            color: #fff;
            text-align: center;
        }
        .station-name { font-size: 3vw; font-weight: 900; margin-bottom: 1vh; }
        .station-name-en { font-size: 1.2vw; color: #aaa; font-weight: 500; }
        .system-name { font-size: 1.5vw; margin-top: 2vh; color: #888; }

        /* 3. é»æ•¸å®£å°å€ */
        .promo-area {
            background: linear-gradient(135deg, #00c9ff, #92fe9d);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2vh;
            color: #fff;
        }
        .promo-title { font-size: 2vw; font-weight: 900; text-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .promo-subtitle { font-size: 1vw; margin-top: 5px; opacity: 0.9; }

        /* ------------------ å³å´å…§å®¹å€ ------------------ */
        .main-content {
            display: flex;
            flex-direction: column;
            background-color: #000;
        }

        /* åˆ—è»Šåˆ—è¡¨å€ */
        .train-list {
            flex: 1;
            overflow-y: auto;
            padding: 2vh 2vw;
            display: flex;
            flex-direction: column;
            gap: 1.5vh;
        }

        .train-item {
            background-color: #1a1a1a;
            border-radius: 10px;
            padding: 1.5vh 1.5vw;
            display: grid;
            grid-template-columns: 1fr 3fr 1.5fr;
            gap: 1.5vw;
            align-items: center;
            border-left: 5px solid;
        }

        .train-time {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 3.5vw;
            font-weight: 700;
            color: #fff;
            text-align: center;
        }

        .train-dest {
            display: flex;
            flex-direction: column;
        }
        .train-dest-zh { font-size: 2vw; font-weight: 900; color: #fff; }
        .train-dest-en { font-size: 1vw; color: #888; margin-top: 3px; }
        .train-direction { font-size: 0.9vw; color: #666; margin-top: 3px; }

        .train-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .train-type {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9vw;
            font-weight: 700;
            text-align: center;
            color: #fff;
        }
        .train-platform {
            text-align: center;
            color: #aaa;
            font-size: 0.8vw;
        }

        .type-express { background-color: #d85fb6; }
        .type-commuter { background-color: #1976d2; }

        /* æ“æ“ åº¦é¡¯ç¤ºæ¢ (ä¿ç•™å‚™ç”¨) */
        .congestion-bar {
            background-color: #1a1a1a;
            height: 10vh;
            display: none; /* æš«æ™‚éš±è—ï¼Œå¯ä¾éœ€æ±‚å•Ÿç”¨ */
        }

        /* ------------------ ä¸‹æ–¹è·‘é¦¬ç‡ˆ ------------------ */
        .footer-marquee {
            grid-column: 1 / span 2;
            display: grid;
            grid-template-columns: 26% 74%;
            background-color: #000;
            border-top: 2px solid #333;
        }

        .datetime-box {
            background-color: #e65c5c;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.8vw;
            font-weight: 700;
            font-family: 'Roboto Condensed', sans-serif;
        }

        .marquee-container {
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0 2vw;
        }

        .marquee-text {
            white-space: nowrap;
            font-size: 2vw;
            font-weight: 500;
            color: #fff;
            animation: scroll 25s linear infinite;
        }

        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* è¼‰å…¥ä¸­æ¨£å¼ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #666;
            font-size: 2vw;
        }
    </style>
</head>
<body>

    <div class="pids-container" id="pids-content">
        <!-- è³‡æ–™ç”± JavaScript å‹•æ…‹ç”¢ç”Ÿ -->
    </div>

    <script>
        /**
         * TDX API æ•´åˆ - å‹•æ…‹ç²å–å³æ™‚åˆ°ç«™è³‡æ–™
         * tdxApi å·²åœ¨ tdx-api.js ä¸­åˆå§‹åŒ–
         */
        let autoUpdateInterval = null;

        // PIDS é…ç½® - åŒ…å«éœæ…‹è³‡æ–™å’Œ API è¨­å®š
        const pidsConfig = {
            TRTC: {
                name: 'å°åŒ—æ·é‹',
                cityCode: 'TRTC',
                tdxCityName: 'Taipei',  // TDX API ä½¿ç”¨çš„åŸå¸‚åç¨±
                stationId: '08',  // é è¨­å°åŒ—è»Šç«™
                stationName: 'å°åŒ—è»Šç«™',
                lineColor: '#005ab5',
                marquee: "ã€å°åŒ—æ·é‹ã€‘æœ¬ç«™å„é …è¨­æ–½å‡æ­£å¸¸ä½¿ç”¨ã€‚ç¥æ‚¨æ—…é€”æ„‰å¿«ã€‚"
            },
            TYMC: {
                name: 'æ¡ƒåœ’æ·é‹',
                cityCode: 'TYMC',
                tdxCityName: 'Taoyuan',
                stationId: 'A18',  // é è¨­é«˜éµæ¡ƒåœ’ç«™
                stationName: 'é«˜éµæ¡ƒåœ’',
                lineColor: '#a855f7',
                marquee: "ã€ç³»çµ±è¨Šæ¯ã€‘æ¡ƒåœ’æ·é‹å…¨ç·šç‡Ÿé‹æ­£å¸¸ã€‚ Passenger Information: All lines are operating normally. ã€ä¹˜è»Šæé†’ã€‘è«‹å‹¿åœ¨è»Šç«™åŠè»Šå»‚å…§é£²é£Ÿã€‚"
            },
            NTDLRT: {
                name: 'æ–°åŒ—æ·é‹',
                cityCode: 'NTDLRT',
                tdxCityName: 'NewTaipei',
                stationId: 'F03',  // é è¨­é ­å‰åº„ç«™
                stationName: 'é ­å‰åº„',
                lineColor: '#fbbf24',
                marquee: "ã€æ–°åŒ—æ·é‹ã€‘ä¸‰é¶¯ç·šèˆ‡æ·¡æµ·è¼•è»Œç«­èª ç‚ºæ‚¨æœå‹™ã€‚"
            },
            TMRT: {
                name: 'å°ä¸­æ·é‹',
                cityCode: 'TMRT',
                tdxCityName: 'Taichung',
                stationId: 'G08',  // é è¨­å¸‚æ”¿åºœç«™
                stationName: 'å¸‚æ”¿åºœ',
                lineColor: '#10b981',
                marquee: "ã€å°ä¸­æ·é‹ã€‘ç¶ ç·šå…¨ç·šæ­£å¸¸ç‡Ÿé‹ï¼Œæ„Ÿè¬æ‚¨çš„æ­ä¹˜ã€‚"
            },
            KRTC: {
                name: 'é«˜é›„æ·é‹',
                cityCode: 'KRTC',
                tdxCityName: 'Kaohsiung',
                stationId: 'R11',  // é è¨­é«˜é›„è»Šç«™
                stationName: 'é«˜é›„è»Šç«™',
                lineColor: '#ef4444',
                marquee: "ã€é«˜é›„æ·é‹ã€‘ç´…æ©˜ç·šå…¨ç·šæ­£å¸¸ç‡Ÿé‹ã€‚Kaohsiung MRT services are operating normally."
            },
            KLRT: {
                name: 'é«˜é›„è¼•è»Œ',
                cityCode: 'KLRT',
                tdxCityName: 'Kaohsiung',
                stationId: 'C1',  // é è¨­ç±¬ä»”å…§ç«™
                stationName: 'ç±¬ä»”å…§',
                lineColor: '#f97316',
                marquee: "ã€é«˜é›„è¼•è»Œã€‘ç’°ç‹€è¼•è»Œç‚ºæ‚¨æœå‹™ã€‚è«‹æ³¨æ„è¼•è»Œå„ªå…ˆè™ŸèªŒã€‚"
            }
        };

        // Cloudflare Worker API ç«¯é»
        const WORKER_URL = 'https://metro-api-worker.xiaoyouwu5-fd3.workers.dev';

        // ç•¶å‰ç³»çµ±è¨­å®š
        let currentSystem = 'KRTC';
        let currentConfig = pidsConfig[currentSystem];

        /**
         * å¾ Cloudflare Worker API ç²å–å³æ™‚åˆ°ç«™è³‡æ–™ï¼ˆèˆ‡ metro-liveboard ä¸€è‡´ï¼‰
         */
        async function fetchLiveData() {
            try {
                const config = pidsConfig[currentSystem];
                
                // ä½¿ç”¨ WORKER_URL (ä¾†è‡ª config.js)
                const type = (currentSystem === 'KLRT') ? 'LivePosition' : 'LiveBoard';
                const endpoint = `${WORKER_URL}/api/liveboard?system=${currentSystem}&type=${type}`;
                
                console.log(`ğŸš‡ API è«‹æ±‚: ${endpoint}`);

                const response = await fetch(endpoint);

                if (!response.ok) {
                    throw new Error(`Worker API éŒ¯èª¤: ${response.status}`);
                }

                const data = await response.json();
                console.log('âœ… å³æ™‚è³‡æ–™ç²å–æˆåŠŸ:', data);
                console.log('ğŸ“Š è³‡æ–™é¡å‹:', Array.isArray(data) ? 'é™£åˆ—' : typeof data);
                
                // è™•ç†ä¸åŒçš„è³‡æ–™æ ¼å¼
                let rawData = data;
                
                // å¦‚æœæ˜¯ç‰©ä»¶ä¸”åŒ…å«é™£åˆ—å±¬æ€§ï¼Œå˜—è©¦æå–
                if (!Array.isArray(data) && typeof data === 'object') {
                    // åˆ—å‡ºæ‰€æœ‰å¯èƒ½åŒ…å«åˆ—è»Šè³‡æ–™çš„é™£åˆ—å±¬æ€§
                    const possibleArrayKeys = [
                        'data', 'BusInfo', 'TrainInfo', 'Trains', 'LivePosition', 
                        'LiveBoard', 'Estimates', 'trains', 'positions'
                    ];
                    
                    // æ‰¾åˆ°ç¬¬ä¸€å€‹æ˜¯é™£åˆ—çš„å±¬æ€§
                    let found = false;
                    for (const key of possibleArrayKeys) {
                        if (data[key] && Array.isArray(data[key])) {
                            rawData = data[key];
                            console.log(`ğŸ“¦ è§£åŒ…è³‡æ–™çµæ§‹ (${key}):`, rawData.length, 'ç­†');
                            found = true;
                            break;
                        }
                    }
                    
                    // å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œåˆ—å‡ºç‰©ä»¶çš„æ‰€æœ‰ key ä¾†å”åŠ©è¨ºæ–·
                    if (!found) {
                        console.warn('âš ï¸ ç„¡æ³•æ‰¾åˆ°åˆ—è»Šè³‡æ–™é™£åˆ—ï¼Œç‰©ä»¶å±¬æ€§:', Object.keys(data));
                        // å°æ–¼ KLRT ç­‰ç‰¹æ®Šæƒ…æ³ï¼Œå¯èƒ½éœ€è¦ç›´æ¥è¿”å›æ•´å€‹ç‰©ä»¶ä¾›é€²ä¸€æ­¥è™•ç†
                        return data;
                    }
                }
                
                // ç¯©é¸æŒ‡å®šè»Šç«™çš„è³‡æ–™
                if (rawData && Array.isArray(rawData)) {
                    const stationData = rawData.filter(item => {
                        if (!item.StationID) return false;
                        // å¯¬é¬†æ¯”å° StationID
                        if (item.StationID === config.stationId) return true;
                        if (item.StationID.endsWith(config.stationId)) return true;
                        if (config.stationId.endsWith(item.StationID)) return true;
                        return false;
                    });
                    console.log(`ğŸ¯ ç¯©é¸è»Šç«™ ${config.stationId}:`, stationData.length, 'ç­†è³‡æ–™');
                    return stationData;
                }
                
                return rawData;

            } catch (error) {
                console.error('âŒ ç²å–å³æ™‚è³‡æ–™å¤±æ•—:', error);
                return null;
            }
        }

        /**
         * å°‡ Worker API è³‡æ–™è½‰æ›ç‚º PIDS é¡¯ç¤ºæ ¼å¼
         */
        function transformTDXData(liveboardData) {
            console.log('ğŸ”„ é–‹å§‹è½‰æ›è³‡æ–™...', liveboardData);
            
            if (!liveboardData) {
                console.warn('âš ï¸ è³‡æ–™ç‚º null/undefined');
                return null;
            }
            
            // ç¢ºä¿è³‡æ–™æ˜¯é™£åˆ—
            if (!Array.isArray(liveboardData)) {
                console.error('âŒ è³‡æ–™ä¸æ˜¯é™£åˆ—:', typeof liveboardData);
                return null;
            }
            
            if (liveboardData.length === 0) {
                console.warn('âš ï¸ è³‡æ–™é™£åˆ—ç‚ºç©º');
                return null;
            }

            const sections = {};
            const now = new Date();

            liveboardData.forEach(train => {
                // è™•ç†ç›®çš„åœ°è³‡è¨Š
                const destId = train.DestinationStationID || train.DestinationStaionID || 'N/A';
                const destNameObj = train.DestinationStationName || train.DestinationStaionName;
                const destName = destNameObj?.Zh_tw || destNameObj || destId;
                const destNameEn = destNameObj?.En || destName;
                
                // è™•ç†æ–¹å‘
                const tripHeadSign = train.TripHeadSign || destName;
                let direction = train.Direction || tripHeadSign;
                
                // æ¡ƒæ·ç‰¹æ®Šè™•ç†ï¼šæ ¹æ“šç«™è™Ÿåˆ¤æ–·æ–¹å‘
                if (currentSystem === 'TYMC') {
                    try {
                        const currentNum = parseInt(train.StationID.replace(/[^0-9]/g, ''));
                        const destNum = parseInt(destId.replace(/[^0-9]/g, ''));
                        if (!isNaN(currentNum) && !isNaN(destNum)) {
                            direction = (destNum < currentNum) ? 'å¾€å°åŒ—' : 'å¾€ä¸­å£¢';
                        }
                    } catch(e) {}
                }

                // è¨ˆç®—åˆ°ç«™æ™‚é–“
                let displayTime = '--:--';
                let estimateMinutes = train.EstimateTime;
                
                if (estimateMinutes !== undefined && estimateMinutes >= 0) {
                    const arrivalTime = new Date(now.getTime() + estimateMinutes * 60 * 1000);
                    const hours = String(arrivalTime.getHours()).padStart(2, '0');
                    const minutes = String(arrivalTime.getMinutes()).padStart(2, '0');
                    displayTime = `${hours}:${minutes}`;
                }

                // åˆ¤æ–·è»Šç¨® (æ¡ƒæ·å°ˆç”¨)
                let trainTypeName = 'æ™®é€šè»Š';
                let trainTypeColor = currentConfig.lineColor;
                
                if (currentSystem === 'TYMC') {
                    const typeCode = String(train.TrainType);
                    if (typeCode === '2' || typeCode === '4' || typeCode === '5') {
                        trainTypeName = 'ç›´é”è»Š';
                        trainTypeColor = '#d85fb6'; // ç²‰ç´…è‰²
                    }
                    // é€²ä¸€æ­¥æ ¡æ­£ï¼šåªæœ‰ç‰¹å®šç«™æœ‰ç›´é”è»Š
                    const expressStations = ['A1', 'A3', 'A8', 'A12', 'A13'];
                    const stationIdSimple = currentConfig.stationId.replace('TYMC-', '');
                    if (!expressStations.includes(stationIdSimple) && trainTypeName === 'ç›´é”è»Š') {
                        trainTypeName = 'æ™®é€šè»Š';
                        trainTypeColor = currentConfig.lineColor;
                    }
                }

                // æŒ‰æ–¹å‘åˆ†çµ„
                if (!sections[direction]) {
                    sections[direction] = {
                        dirZh: direction,
                        dirEn: direction,
                        trains: []
                    };
                }

                sections[direction].trains.push({
                    time: displayTime,
                    id: destId.replace('TYMC-', '').replace('KRTC-', ''),
                    zh: destName,
                    en: destNameEn,
                    typeZh: trainTypeName,
                    typeEn: trainTypeName === 'ç›´é”è»Š' ? 'Express' : 'Commuter',
                    typeColor: trainTypeColor,
                    plat: train.Platform || '?'
                });
            });

            return {
                sections: Object.values(sections),
                marquee: currentConfig.marquee
            };
        }

        /**
         * æ¸²æŸ“ PIDS é¡¯ç¤ºç•«é¢ï¼ˆæ–°ç‰ˆä½ˆå±€ï¼‰
         */
        function renderPIDS(data) {
            const container = document.getElementById('pids-content');
            
            if (!data || !data.sections || data.sections.length === 0) {
                container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
                return;
            }

            // å–å¾—ç¬¬ä¸€å€‹æ–¹å‘çš„å‰å…©ç­è»Šç”¨æ–¼å·¦å´é¡¯ç¤º
            const firstDirection = data.sections[0];
            const topTrains = firstDirection.trains.slice(0, 2);
            
            // æ”¶é›†æ‰€æœ‰åˆ—è»Šç”¨æ–¼å³å´é¡¯ç¤º
            let allTrains = [];
            data.sections.forEach(sec => {
                sec.trains.forEach(train => {
                    allTrains.push({
                        ...train,
                        direction: sec.dirZh
                    });
                });
            });

            let html = `
                <!-- å·¦å´æ¬„ä½ -->
                <div class="sidebar">
                    <!-- 1. åˆ°ç«™å€’æ•¸å€ -->
                    <div class="arrival-section">`;
            
            // é¡¯ç¤ºå‰ 2 ç­è»Š
            topTrains.forEach((train, idx) => {
                const badgeColor = train.typeColor || currentConfig.lineColor;
                html += `
                        <div class="arrival-card">
                            <div class="arrival-header">
                                <div class="route-badge" style="background-color: ${badgeColor}">
                                    <div class="line">${train.id}</div>
                                    <div class="id">${firstDirection.dirZh}</div>
                                </div>
                                <div class="dest-wrap">
                                    <div class="dest-text">${train.zh}</div>
                                    <div class="dest-en">${train.en}</div>
                                </div>
                            </div>
                            <div class="countdown-box" style="background-color: ${badgeColor}">
                                ${train.time}
                            </div>
                        </div>`;
            });
            
            html += `
                    </div>

                    <!-- 2. è»Šç«™è³‡è¨Šå€ -->
                    <div class="station-info">
                        <div class="station-name">${currentConfig.stationName}</div>
                        <div class="station-name-en">${currentConfig.stationName} Station</div>
                        <div class="system-name">${currentConfig.name}</div>
                    </div>

                    <!-- 3. é»æ•¸å®£å°å€ -->
                    <div class="promo-area">
                        <div class="promo-title">æ·é‹æ™ºæ…§å‡ºè¡Œ</div>
                        <div class="promo-subtitle">ä¾¿æ· â— ç’°ä¿ â— æº–æ™‚</div>
                    </div>
                </div>

                <!-- å³å´ä¸»å€åŸŸ -->
                <div class="main-content">
                    <!-- åˆ—è»Šåˆ—è¡¨ -->
                    <div class="train-list">`;
            
            // é¡¯ç¤ºæ‰€æœ‰åˆ—è»Šï¼ˆæœ€å¤š 8 ç­ï¼‰
            allTrains.slice(0, 8).forEach(train => {
                const borderColor = train.typeColor || currentConfig.lineColor;
                html += `
                        <div class="train-item" style="border-left-color: ${borderColor}">
                            <div class="train-time">${train.time}</div>
                            <div class="train-dest">
                                <div class="train-dest-zh">${train.zh}</div>
                                <div class="train-dest-en">${train.en}</div>
                                <div class="train-direction">â†’ ${train.direction}</div>
                            </div>
                            <div class="train-info">
                                <div class="train-type ${train.typeZh === 'ç›´é”è»Š' ? 'type-express' : 'type-commuter'}">
                                    ${train.typeZh}
                                </div>
                                <div class="train-platform">æœˆå° ${train.plat}</div>
                            </div>
                        </div>`;
            });
            
            html += `
                    </div>
                </div>

                <!-- ä¸‹æ–¹è·‘é¦¬ç‡ˆèˆ‡æ™‚é–“ -->
                <div class="footer-marquee">
                    <div class="datetime-box" id="datetime">
                        01/14 10:49 <span style="font-size: 0.8em;">AM</span>
                    </div>
                    <div class="marquee-container">
                        <div class="marquee-text">${data.marquee}</div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            updateClock(); // ç«‹å³æ›´æ–°æ™‚é˜
        }

        /**
         * æ›´æ–° PIDS è³‡æ–™
         */
        async function updatePIDS() {
            console.log('ğŸ”„ æ›´æ–° PIDS è³‡æ–™...');
            const liveboardData = await fetchLiveData();
            
            if (liveboardData) {
                const displayData = transformTDXData(liveboardData);
                if (displayData) {
                    renderPIDS(displayData);
                } else {
                    console.warn('âš ï¸ è½‰æ›è³‡æ–™å¾Œç‚ºç©ºï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­...');
                    renderPIDS(null);
                }
            } else {
                console.warn('âš ï¸ æœªç²å–åˆ°è³‡æ–™');
                renderPIDS(null);
            }
        }

        /**
         * æ™‚é˜æ›´æ–°
         */
        function updateClock() {
            const el = document.getElementById('datetime');
            if (!el) return;
            
            const now = new Date();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours() % 12 || 12).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            const ampm = now.getHours() >= 12 ? 'PM' : 'AM';

            el.innerHTML = `${m}/${d} ${hh}:${mm} <span style="font-size: 0.8em; margin-left: 5px;">${ampm}</span>`;
        }

        /**
         * å•Ÿå‹•è‡ªå‹•æ›´æ–°
         */
        function startAutoUpdate() {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
            }
            // æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡
            autoUpdateInterval = setInterval(updatePIDS, 30000);
        }

        /**
         * å¾ URL åƒæ•¸è®€å–è¨­å®š
         */
        function loadConfigFromURL() {
            const params = new URLSearchParams(window.location.search);
            const system = params.get('system');
            const station = params.get('station');

            if (system && pidsConfig[system.toUpperCase()]) {
                currentSystem = system.toUpperCase();
                currentConfig = pidsConfig[currentSystem];
                console.log(`âœ… åˆ‡æ›åˆ°ç³»çµ±: ${currentConfig.name} (${currentSystem})`);
            } else if (system) {
                console.warn(`âš ï¸ æœªçŸ¥çš„ç³»çµ±ä»£ç¢¼: ${system}ï¼Œä½¿ç”¨é è¨­ç³»çµ±`);
            }

            if (station) {
                currentConfig.stationId = station;
                console.log(`âœ… è¨­å®šè»Šç«™ ID: ${station}`);
            }

            console.log('ğŸ“ ç•¶å‰é…ç½®:', currentConfig);
        }

        /**
         * åˆå§‹åŒ–
         */
        document.addEventListener('DOMContentLoaded', async () => {
            loadConfigFromURL();
            await updatePIDS();
            startAutoUpdate();
            setInterval(updateClock, 1000);
            updateClock();
        });

        /**
         * èˆŠç‰ˆéœæ…‹è³‡æ–™é…ç½®ï¼ˆå‚™ç”¨ï¼‰
         */
        /**
         * èˆŠç‰ˆéœæ…‹è³‡æ–™é…ç½®ï¼ˆå‚™ç”¨ï¼‰
         */
        const legacyConfig = {
            // æ¡ƒåœ’æ·é‹ç¯„ä¾‹
            TYMC: {
                sections: [
                    {
                        dirZh: "å¾€ä¸­å£¢", dirEn: "To Zhongli",
                        trains: [
                            { time: "10:18", id: "A22", zh: "è€è¡—æºª", en: "Laojie River", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#0076e4", plat: "2" },
                            { time: "10:25", id: "A13", zh: "æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ", en: "Airport Terminal 2", typeZh: "ç›´é”è»Š", typeEn: "Express", typeColor: "#d85fb6", plat: "2" }
                        ]
                    },
                    {
                        dirZh: "å¾€å°åŒ—", dirEn: "To Taipei",
                        trains: [
                            { time: "10:17", id: "A1", zh: "å°åŒ—è»Šç«™", en: "Taipei Main Station", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#0076e4", plat: "3" },
                            { time: "10:26", id: "A1", zh: "å°åŒ—è»Šç«™", en: "Taipei Main Station", typeZh: "ç›´é”è»Š", typeEn: "Express", typeColor: "#d85fb6", plat: "3" }
                        ]
                    }
                ],
                marquee: "ã€ç³»çµ±è¨Šæ¯ã€‘æ¡ƒåœ’æ·é‹å…¨ç·šç‡Ÿé‹æ­£å¸¸ã€‚ Passenger Information: All lines are operating normally. ã€ä¹˜è»Šæé†’ã€‘è«‹å‹¿åœ¨è»Šç«™åŠè»Šå»‚å…§é£²é£Ÿã€‚"
            },
            // å°åŒ—æ·é‹æ¿å—ç·šç¯„ä¾‹
            TRTC_BL: {
                sections: [
                    {
                        dirZh: "å¾€å—æ¸¯å±•è¦½é¤¨", dirEn: "To Nangang",
                        trains: [
                            { time: "14:32", id: "BL24", zh: "å—æ¸¯å±•è¦½é¤¨", en: "Nangang Exhib. Center", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#005ab5", plat: "1" },
                            { time: "14:38", id: "BL24", zh: "å—æ¸¯å±•è¦½é¤¨", en: "Nangang Exhib. Center", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#005ab5", plat: "1" }
                        ]
                    },
                    {
                        dirZh: "å¾€é ‚åŸ”", dirEn: "To Dingpu",
                        trains: [
                            { time: "14:30", id: "BL01", zh: "é ‚åŸ”", en: "Dingpu", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#005ab5", plat: "2" },
                            { time: "14:35", id: "BL01", zh: "é ‚åŸ”", en: "Dingpu", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#005ab5", plat: "2" }
                        ]
                    }
                ],
                marquee: "ã€å°åŒ—æ·é‹ã€‘æœ¬ç«™å„é …è¨­æ–½å‡æ­£å¸¸ä½¿ç”¨ã€‚ç¥æ‚¨æ—…é€”æ„‰å¿«ã€‚"
            }
        };

        // èˆŠç‰ˆéœæ…‹åˆå§‹åŒ–å‡½æ•¸ï¼ˆå·²åœç”¨ï¼‰
        /*
        function initPIDS(systemKey) {
            const data = legacyConfig[systemKey];
            renderPIDS(data);
        }
        */
    </script>
</body>
</html>
