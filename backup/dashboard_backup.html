<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>監視器儀表板 - 台灣即時監控系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/responsive-camera.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>window.CURRENT_PAGE = 'dashboard';</script>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #667eea; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .back-btn:hover { background: #5a6fd8; }

        /* 儀表板統計面板 */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-trend {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .trend-up { color: #4CAF50; }
        .trend-down { color: #f44336; }
        .trend-stable { color: #FF9800; }

        /* 系統狀態表格 */
        .status-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .status-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .status-table th,
        .status-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .status-table th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #4CAF50; }
        .status-offline { background: #f44336; }
        .status-warning { background: #FF9800; }

        /* 圖表區域 */
        .chart-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        /* 圖表控制按鈕 */
        .chart-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            color: #666;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .chart-btn:hover {
            background: #e0e0e0;
            border-color: #ccc;
        }

        .chart-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chart-btn.active:hover {
            background: #5a6fd8;
        }

        /* 即時更新指示器 */
        .update-indicator {
            position: fixed;
            top: 20px;
            right: 80px; /* 向左移動，避免與深色切換按鈕重疊 */
            background: white;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 999; /* 降低層級，避免遮擋深色切換按鈕 */
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        /* 響應式設計 - 小螢幕調整 */
        @media (max-width: 768px) {
            .update-indicator {
                position: static;
                margin: 10px auto;
                width: fit-content;
                order: -1; /* 讓更新指示器顯示在頂部 */
            }
            
            .container {
                position: relative;
            }
        }

        @media (max-width: 480px) {
            .update-indicator {
                font-size: 0.8rem;
                padding: 8px 12px;
                right: 60px; /* 在小螢幕上進一步向左移動 */
            }
        }

        /* 載入動畫 */
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2rem;
        }

        .loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .dashboard-stats { grid-template-columns: repeat(2, 1fr); }
            .stat-card { padding: 15px; }
            .stat-number { font-size: 1.5rem; }
            .status-table { font-size: 0.9rem; }
        }

        @media (max-width: 480px) {
            .dashboard-stats { grid-template-columns: 1fr; }
        }

        /* 深色模式 */
        body.dark-mode .stat-card,
        body.dark-mode .status-section,
        body.dark-mode .chart-section {
            background: rgba(40,40,50,0.95);
            border: 1px solid rgba(255,255,255,0.1);
        }

        body.dark-mode .stat-number { color: #e0e0e0; }
        body.dark-mode .stat-label { color: rgba(255,255,255,0.7); }
        body.dark-mode .status-table th { background: rgba(255,255,255,0.05); color: #e0e0e0; }
        body.dark-mode .status-table td { color: rgba(255,255,255,0.8); border-bottom-color: rgba(255,255,255,0.1); }
        body.dark-mode .chart-container { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7); }
        body.dark-mode .update-indicator { background: rgba(40,40,50,0.95); border: 1px solid rgba(255,255,255,0.1); }
        
        /* 暗色模式圖表按鈕 */
        body.dark-mode .chart-btn {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.8);
        }
        
        body.dark-mode .chart-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
        }
        
        body.dark-mode .chart-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* 深色模式下圖表標籤樣式 */
        body.dark-mode label {
            color: rgba(255,255,255,0.9) !important;
            background: rgba(40,40,50,0.9) !important;
        }
        
        body.dark-mode div[style*="background: rgba(255,255,255,0.9)"] {
            background: rgba(40,40,50,0.9) !important;
            color: rgba(255,255,255,0.9) !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-tachometer-alt"></i> 監視器儀表板</h1>
            <p style="text-align: center; color: #666;">即時監控系統狀態與統計分析</p>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回首頁</a>

        <!-- 即時更新指示器 -->
        <div class="update-indicator">
            <div class="pulse"></div>
            <span>即時更新中</span>
        </div>

        <!-- 統計面板 -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-video"></i></div>
                <div class="stat-number" id="totalCameras">載入中...</div>
                <div class="stat-label">監視器總數</div>
                <div class="stat-trend trend-up" id="totalTrend"><i class="fas fa-arrow-up"></i> +0</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-number" id="onlineCameras">載入中...</div>
                <div class="stat-label">線上監視器</div>
                <div class="stat-trend trend-up" id="onlineTrend"><i class="fas fa-arrow-up"></i> 95.2%</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-number" id="offlineCameras">載入中...</div>
                <div class="stat-label">離線監視器</div>
                <div class="stat-trend trend-down" id="offlineTrend"><i class="fas fa-arrow-down"></i> 4.8%</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-number" id="lastUpdate">載入中...</div>
                <div class="stat-label">最後更新</div>
                <div class="stat-trend trend-stable" id="updateTrend"><i class="fas fa-sync-alt"></i> 自動</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-road"></i></div>
                <div class="stat-number" id="highwayCameras">載入中...</div>
                <div class="stat-label">國道監視器</div>
                <div class="stat-trend trend-stable" id="highwayTrend"><i class="fas fa-minus"></i> 穩定</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-traffic-light"></i></div>
                <div class="stat-number" id="roadCameras">載入中...</div>
                <div class="stat-label">省道監視器</div>
                <div class="stat-trend trend-stable" id="roadTrend"><i class="fas fa-minus"></i> 穩定</div>
            </div>
        </div>

        <!-- 系統狀態表格 -->
        <div class="status-section">
            <h3><i class="fas fa-list"></i> 系統狀態概覽</h3>
            <table class="status-table">
                <thead>
                    <tr>
                        <th>系統名稱</th>
                        <th>狀態</th>
                        <th>監視器數量</th>
                        <th>可用率</th>
                        <th>最後檢查</th>
                    </tr>
                </thead>
                <tbody id="systemStatusTable">
                    <tr>
                        <td><i class="fas fa-road"></i> 國道監視器</td>
                        <td><span class="status-indicator status-online"></span>線上</td>
                        <td id="highwayCount">載入中...</td>
                        <td><span class="trend-up">98.5%</span></td>
                        <td id="highwayLastCheck">載入中...</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-traffic-light"></i> 省道監視器</td>
                        <td><span class="status-indicator status-online"></span>線上</td>
                        <td id="roadCount">載入中...</td>
                        <td><span class="trend-up">96.2%</span></td>
                        <td id="roadLastCheck">載入中...</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-tachometer-alt"></i> 快速道路監視器</td>
                        <td><span class="status-indicator status-online"></span>線上</td>
                        <td id="expresswayCount">載入中...</td>
                        <td><span class="trend-up">94.7%</span></td>
                        <td id="expresswayLastCheck">載入中...</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-droplet"></i> 水資源監控</td>
                        <td><span class="status-indicator status-warning"></span>部分</td>
                        <td id="waterCount">載入中...</td>
                        <td><span class="trend-stable">89.3%</span></td>
                        <td id="waterLastCheck">載入中...</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-mountain"></i> 土石流監測</td>
                        <td><span class="status-indicator status-online"></span>線上</td>
                        <td id="debrisCount">載入中...</td>
                        <td><span class="trend-up">92.1%</span></td>
                        <td id="debrisLastCheck">載入中...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 圖表區域 -->
        <div class="chart-section">
            <h3><i class="fas fa-chart-line"></i> 監視器狀態趨勢</h3>
            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px;">
                        <button id="chart-1h" class="chart-btn" onclick="switchChartPeriod('1h')">1小時</button>
                        <button id="chart-3h" class="chart-btn" onclick="switchChartPeriod('3h')">3小時</button>
                        <button id="chart-6h" class="chart-btn" onclick="switchChartPeriod('6h')">6小時</button>
                        <button id="chart-12h" class="chart-btn" onclick="switchChartPeriod('12h')">12小時</button>
                        <button id="chart-24h" class="chart-btn active" onclick="switchChartPeriod('24h')">24小時</button>
                        <button id="chart-7d" class="chart-btn" onclick="switchChartPeriod('7d')">7天</button>
                        <button id="chart-30d" class="chart-btn" onclick="switchChartPeriod('30d')">30天</button>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: #333; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                            <input type="checkbox" id="autoRefresh" checked> 自動更新
                        </label>
                        <button onclick="refreshChart()" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-sync-alt"></i> 更新
                        </button>
                    </div>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="availabilityChart"></canvas>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
                    <div style="color: #333; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                        <span id="chartLastUpdate">最後更新: --</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                        <span style="color: #4CAF50;">●</span> 國道監視器
                        <span style="color: #FF9800; margin-left: 15px;">●</span> 省道監視器
                        <span style="color: #2196F3; margin-left: 15px;">●</span> 快速道路
                        <span style="color: #9C27B0; margin-left: 15px;">●</span> 縣市監視器
                    </div>
                </div>
            </div>
        </div>

        <!-- API 狀態監控圖表 -->
        <div class="chart-section">
            <h3><i class="fas fa-server"></i> API 服務運行狀態</h3>
            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="api-chart-1h" class="chart-btn" onclick="switchApiChartPeriod('1h')">1小時</button>
                        <button id="api-chart-3h" class="chart-btn" onclick="switchApiChartPeriod('3h')">3小時</button>
                        <button id="api-chart-6h" class="chart-btn" onclick="switchApiChartPeriod('6h')">6小時</button>
                        <button id="api-chart-12h" class="chart-btn" onclick="switchApiChartPeriod('12h')">12小時</button>
                        <button id="api-chart-24h" class="chart-btn active" onclick="switchApiChartPeriod('24h')">24小時</button>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: #333; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                            <input type="checkbox" id="apiAutoRefresh" checked> API自動檢測
                        </label>
                        <button onclick="refreshApiChart()" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-sync-alt"></i> 檢測
                        </button>
                    </div>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="apiStatusChart"></canvas>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
                    <div style="color: #333; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                        <span id="apiChartLastUpdate">最後檢測: --</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px;">
                        <span style="color: #4CAF50;">●</span> TDX API
                        <span style="color: #FF5722; margin-left: 15px;">●</span> 水利署 API
                        <span style="color: #2196F3; margin-left: 15px;">●</span> 環保署 API
                        <span style="color: #FF9800; margin-left: 15px;">●</span> 農委會 API
                        <span style="color: #9C27B0; margin-left: 15px;">●</span> 國科會 API
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        let allSystemsData = {
            highway: { total: 0, online: 0, lastUpdate: null },
            road: { total: 0, online: 0, lastUpdate: null },
            expressway: { total: 0, online: 0, lastUpdate: null },
            water: { total: 0, online: 0, lastUpdate: null },
            debris: { total: 0, online: 0, lastUpdate: null }
        };

        // 更新時間顯示
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW');
            document.getElementById('lastUpdate').textContent = timeString;
        }

        // 載入國道監視器數據
        async function loadHighwayData() {
            try {
                console.log('載入國道監視器數據...');
                
                // 檢查 tdxApi 是否可用
                if (typeof tdxApi === 'undefined' || !tdxApi) {
                    throw new Error('TDX API 尚未初始化');
                }
                
                // 使用 TDX API 載入國道監視器
                const endpoint = '/v2/Road/Traffic/CCTV/Freeway?$format=JSON';
                const response = await tdxApi.fetchCCTV(endpoint);
                
                if (response && Array.isArray(response)) {
                    allSystemsData.highway.total = response.length;
                    allSystemsData.highway.online = response.filter(c => c.VideoImageURL || c.PictureURL).length;
                    allSystemsData.highway.lastUpdate = new Date();
                    
                    document.getElementById('highwayCameras').textContent = allSystemsData.highway.total;
                    document.getElementById('highwayCount').textContent = allSystemsData.highway.total;
                    document.getElementById('highwayLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
                    
                    console.log(`✅ 國道監視器載入成功: ${allSystemsData.highway.total} 個`);
                } else {
                    throw new Error('無效的回應格式');
                }
            } catch (error) {
                console.error('載入國道數據錯誤:', error);
                document.getElementById('highwayCameras').textContent = '載入錯誤';
                document.getElementById('highwayCount').textContent = '無法載入';
                document.getElementById('highwayLastCheck').textContent = '載入失敗';
            }
        }

        // 載入省道監視器數據
        async function loadRoadData() {
            try {
                console.log('載入省道監視器數據...');
                
                // 檢查 tdxApi 是否可用
                if (typeof tdxApi === 'undefined' || !tdxApi) {
                    throw new Error('TDX API 尚未初始化');
                }
                
                // 使用 TDX API 載入省道監視器
                const endpoint = '/v2/Road/Traffic/CCTV/Road?$format=JSON';
                const response = await tdxApi.fetchCCTV(endpoint);
                
                if (response && Array.isArray(response)) {
                    allSystemsData.road.total = response.length;
                    allSystemsData.road.online = response.filter(c => c.VideoImageURL || c.PictureURL).length;
                    allSystemsData.road.lastUpdate = new Date();
                    
                    document.getElementById('roadCameras').textContent = allSystemsData.road.total;
                    document.getElementById('roadCount').textContent = allSystemsData.road.total;
                    document.getElementById('roadLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
                    
                    console.log(`✅ 省道監視器載入成功: ${allSystemsData.road.total} 個`);
                } else {
                    throw new Error('無效的回應格式');
                }
            } catch (error) {
                console.error('載入省道數據錯誤:', error);
                document.getElementById('roadCameras').textContent = '載入錯誤';
                document.getElementById('roadCount').textContent = '無法載入';
                document.getElementById('roadLastCheck').textContent = '載入失敗';
            }
        }

        // 模擬其他系統數據（因為API可能不同）
        function loadOtherSystemsData() {
            // 快速道路
            allSystemsData.expressway = { total: 156, online: 148, lastUpdate: new Date() };
            
            // 水資源
            allSystemsData.water = { total: 200, online: 178, lastUpdate: new Date() };
            
            // 土石流
            allSystemsData.debris = { total: 89, online: 82, lastUpdate: new Date() };
            
            // 更新顯示
            document.getElementById('expresswayCount').textContent = allSystemsData.expressway.total;
            document.getElementById('expresswayLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
            
            document.getElementById('waterCount').textContent = allSystemsData.water.total;
            document.getElementById('waterLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
            
            document.getElementById('debrisCount').textContent = allSystemsData.debris.total;
            document.getElementById('debrisLastCheck').textContent = new Date().toLocaleTimeString('zh-TW');
        }

        // 更新總體統計
        function updateOverallStats() {
            const totalCameras = Object.values(allSystemsData).reduce((sum, system) => sum + system.total, 0);
            const totalOnline = Object.values(allSystemsData).reduce((sum, system) => sum + system.online, 0);
            const totalOffline = totalCameras - totalOnline;
            
            document.getElementById('totalCameras').textContent = totalCameras;
            document.getElementById('onlineCameras').textContent = totalOnline;
            document.getElementById('offlineCameras').textContent = totalOffline;
            
            // 更新可用率
            const onlineRate = totalCameras > 0 ? ((totalOnline / totalCameras) * 100).toFixed(1) : 0;
            document.getElementById('onlineTrend').innerHTML = `<i class="fas fa-arrow-up"></i> ${onlineRate}%`;
            
            const offlineRate = totalCameras > 0 ? ((totalOffline / totalCameras) * 100).toFixed(1) : 0;
            document.getElementById('offlineTrend').innerHTML = `<i class="fas fa-arrow-down"></i> ${offlineRate}%`;
        }

        // 等待 TDX API 初始化
        async function waitForTdxApi() {
            let attempts = 0;
            const maxAttempts = 30; // 最多等待30秒
            
            while (attempts < maxAttempts) {
                if (typeof tdxApi !== 'undefined' && tdxApi && typeof tdxApi.fetchCCTV === 'function') {
                    console.log('TDX API 已就緒');
                    return true;
                }
                console.log(`等待 TDX API 初始化... (${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
                attempts++;
            }
            
            console.error('TDX API 初始化超時');
            return false;
        }

        // 載入所有數據
        async function loadAllData() {
            console.log('開始載入儀表板數據...');
            
            // 等待 TDX API 初始化
            const apiReady = await waitForTdxApi();
            if (!apiReady) {
                console.error('TDX API 未就緒，無法載入數據');
                return;
            }
            
            // 並行載入所有數據
            await Promise.all([
                loadHighwayData(),
                loadRoadData()
            ]);
            
            loadOtherSystemsData();
            updateOverallStats();
            updateLastUpdateTime();
            
            console.log('儀表板數據載入完成');
        }

        // 圖表相關變數
        let availabilityChart = null;
        let apiStatusChart = null;
        let currentChartPeriod = '24h';
        let currentApiChartPeriod = '24h';
        let chartData = {
            labels: [],
            datasets: [
                {
                    label: '國道監視器',
                    data: [],
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '省道監視器',
                    data: [],
                    borderColor: '#FF9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '快速道路',
                    data: [],
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '縣市監視器',
                    data: [],
                    borderColor: '#9C27B0',
                    backgroundColor: 'rgba(156, 39, 176, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        };

        // API狀態圖表數據
        let apiChartData = {
            labels: [],
            datasets: [
                {
                    label: 'TDX API',
                    data: [],
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '水利署 API',
                    data: [],
                    borderColor: '#FF5722',
                    backgroundColor: 'rgba(255, 87, 34, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '環保署 API',
                    data: [],
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '農委會 API',
                    data: [],
                    borderColor: '#FF9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '國科會 API',
                    data: [],
                    borderColor: '#9C27B0',
                    backgroundColor: 'rgba(156, 39, 176, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        };

        // 初始化圖表
        function initChart() {
            const ctx = document.getElementById('availabilityChart').getContext('2d');
            
            availabilityChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '24小時監視器可用率趨勢',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '時間'
                            },
                            grid: {
                                color: 'rgba(200, 200, 200, 0.3)'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: '可用率 (%)'
                            },
                            min: 0,
                            max: 100,
                            grid: {
                                color: 'rgba(200, 200, 200, 0.3)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            // 生成初始數據
            generateChartData(currentChartPeriod);
        }

        // 初始化API狀態圖表
        function initApiChart() {
            const ctx = document.getElementById('apiStatusChart').getContext('2d');
            
            apiStatusChart = new Chart(ctx, {
                type: 'line',
                data: apiChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '24小時 API 服務可用率',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '時間'
                            },
                            grid: {
                                color: 'rgba(200, 200, 200, 0.3)'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'API 可用率 (%)'
                            },
                            min: 0,
                            max: 100,
                            grid: {
                                color: 'rgba(200, 200, 200, 0.3)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            // 生成初始API數據
            generateApiChartData(currentApiChartPeriod);
        }

        // 生成圖表數據
        function generateChartData(period) {
            const now = new Date();
            let labels = [];
            let dataPoints = 4; // 4個系統的數據
            
            // 根據時間週期生成標籤
            if (period === '1h') {
                // 1小時，每5分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 5 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '3h') {
                // 3小時，每15分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 15 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '6h') {
                // 6小時，每30分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 30 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '12h') {
                // 12小時，每小時一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 60 * 60 * 1000);
                    labels.push(time.getHours() + ':00');
                }
            } else if (period === '24h') {
                // 24小時，每2小時一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 2 * 60 * 60 * 1000);
                    labels.push(time.getHours() + ':00');
                }
            } else if (period === '7d') {
                // 7天，每天一個點
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(now - i * 24 * 60 * 60 * 1000);
                    labels.push((date.getMonth() + 1) + '/' + date.getDate());
                }
            } else if (period === '30d') {
                // 30天，每天一個點
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(now - i * 24 * 60 * 60 * 1000);
                    labels.push((date.getMonth() + 1) + '/' + date.getDate());
                }
            }

            // 為每個系統生成模擬數據
            chartData.labels = labels;
            
            // 國道監視器數據（高可用率）
            chartData.datasets[0].data = labels.map((_, index) => {
                const base = 95 + Math.random() * 4; // 95-99%
                const trend = Math.sin(index * 0.3) * 2; // 輕微波動
                return Math.min(100, Math.max(90, base + trend));
            });

            // 省道監視器數據
            chartData.datasets[1].data = labels.map((_, index) => {
                const base = 88 + Math.random() * 8; // 88-96%
                const trend = Math.sin(index * 0.4) * 3;
                return Math.min(100, Math.max(80, base + trend));
            });

            // 快速道路數據
            chartData.datasets[2].data = labels.map((_, index) => {
                const base = 91 + Math.random() * 6; // 91-97%
                const trend = Math.sin(index * 0.2) * 2;
                return Math.min(100, Math.max(85, base + trend));
            });

            // 縣市監視器數據（稍低可用率）
            chartData.datasets[3].data = labels.map((_, index) => {
                const base = 82 + Math.random() * 12; // 82-94%
                const trend = Math.sin(index * 0.5) * 4;
                return Math.min(100, Math.max(75, base + trend));
            });

            // 更新圖表
            if (availabilityChart) {
                availabilityChart.update();
            }

            // 更新最後更新時間
            updateChartLastUpdate();
        }

        // 切換圖表時間週期
        function switchChartPeriod(period) {
            currentChartPeriod = period;
            
            // 更新按鈕狀態
            document.querySelectorAll('[id^="chart-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`chart-${period}`).classList.add('active');
            
            // 更新圖表標題
            let title = '';
            if (period === '1h') title = '1小時監視器可用率趨勢';
            else if (period === '3h') title = '3小時監視器可用率趨勢';
            else if (period === '6h') title = '6小時監視器可用率趨勢';
            else if (period === '12h') title = '12小時監視器可用率趨勢';
            else if (period === '24h') title = '24小時監視器可用率趨勢';
            else if (period === '7d') title = '7天監視器可用率趨勢';
            else if (period === '30d') title = '30天監視器可用率趨勢';
            
            if (availabilityChart) {
                availabilityChart.options.plugins.title.text = title;
                generateChartData(period);
            }
        }

        // 刷新圖表
        function refreshChart() {
            generateChartData(currentChartPeriod);
            
            // 顯示刷新動畫
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            icon.style.animation = 'spin 1s linear';
            setTimeout(() => {
                icon.style.animation = '';
            }, 1000);
        }

        // 生成API圖表數據
        function generateApiChartData(period) {
            const now = new Date();
            let labels = [];
            
            // 根據時間週期生成標籤
            if (period === '1h') {
                // 1小時，每5分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 5 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '3h') {
                // 3小時，每15分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 15 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '6h') {
                // 6小時，每30分鐘一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 30 * 60 * 1000);
                    labels.push(time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0'));
                }
            } else if (period === '12h') {
                // 12小時，每小時一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 60 * 60 * 1000);
                    labels.push(time.getHours() + ':00');
                }
            } else if (period === '24h') {
                // 24小時，每2小時一個點
                for (let i = 11; i >= 0; i--) {
                    const time = new Date(now - i * 2 * 60 * 60 * 1000);
                    labels.push(time.getHours() + ':00');
                }
            }

            // 更新標籤
            apiChartData.labels = labels;
            
            // TDX API數據（高可用率）
            apiChartData.datasets[0].data = labels.map((_, index) => {
                const base = 96 + Math.random() * 3; // 96-99%
                const trend = Math.sin(index * 0.2) * 1;
                return Math.min(100, Math.max(90, base + trend));
            });

            // 水利署 API數據（中等可用率）
            apiChartData.datasets[1].data = labels.map((_, index) => {
                const base = 85 + Math.random() * 10; // 85-95%
                const trend = Math.sin(index * 0.3) * 3;
                return Math.min(100, Math.max(70, base + trend));
            });

            // 環保署 API數據
            apiChartData.datasets[2].data = labels.map((_, index) => {
                const base = 90 + Math.random() * 8; // 90-98%
                const trend = Math.sin(index * 0.25) * 2;
                return Math.min(100, Math.max(80, base + trend));
            });

            // 農委會 API數據
            apiChartData.datasets[3].data = labels.map((_, index) => {
                const base = 88 + Math.random() * 7; // 88-95%
                const trend = Math.sin(index * 0.4) * 4;
                return Math.min(100, Math.max(75, base + trend));
            });

            // 國科會 API數據
            apiChartData.datasets[4].data = labels.map((_, index) => {
                const base = 93 + Math.random() * 5; // 93-98%
                const trend = Math.sin(index * 0.35) * 2;
                return Math.min(100, Math.max(85, base + trend));
            });

            // 更新圖表
            if (apiStatusChart) {
                apiStatusChart.update();
            }

            // 更新最後檢測時間
            updateApiChartLastUpdate();
        }

        // 切換API圖表時間週期
        function switchApiChartPeriod(period) {
            currentApiChartPeriod = period;
            
            // 更新按鈕狀態
            document.querySelectorAll('[id^="api-chart-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`api-chart-${period}`).classList.add('active');
            
            // 更新圖表標題
            let title = '';
            if (period === '1h') title = '1小時 API 服務可用率';
            else if (period === '3h') title = '3小時 API 服務可用率';
            else if (period === '6h') title = '6小時 API 服務可用率';
            else if (period === '12h') title = '12小時 API 服務可用率';
            else if (period === '24h') title = '24小時 API 服務可用率';
            
            if (apiStatusChart) {
                apiStatusChart.options.plugins.title.text = title;
                generateApiChartData(period);
            }
        }

        // 刷新API圖表
        function refreshApiChart() {
            generateApiChartData(currentApiChartPeriod);
            
            // 顯示刷新動畫
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            icon.style.animation = 'spin 1s linear';
            setTimeout(() => {
                icon.style.animation = '';
            }, 1000);
        }

        // 更新API圖表最後檢測時間
        function updateApiChartLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW');
            const element = document.getElementById('apiChartLastUpdate');
            if (element) {
                element.textContent = `最後檢測: ${timeString}`;
            }
        }

        // 自動更新API圖表（如果啟用）
        function autoUpdateApiChart() {
            const autoRefresh = document.getElementById('apiAutoRefresh');
            if (autoRefresh && autoRefresh.checked) {
                generateApiChartData(currentApiChartPeriod);
            }
        }

        // 更新圖表最後更新時間
        function updateChartLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW');
            const element = document.getElementById('chartLastUpdate');
            if (element) {
                element.textContent = `最後更新: ${timeString}`;
            }
        }

        // 自動更新圖表（如果啟用）
        function autoUpdateChart() {
            const autoRefresh = document.getElementById('autoRefresh');
            if (autoRefresh && autoRefresh.checked) {
                generateChartData(currentChartPeriod);
            }
        }

        // 添加旋轉動畫CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // 定期更新數據
        function startAutoUpdate() {
            setInterval(() => {
                loadAllData();
                autoUpdateChart(); // 更新監視器可用率圖表
                autoUpdateApiChart(); // 更新API狀態圖表
            }, 60000); // 每分鐘更新一次
            
            setInterval(() => {
                updateLastUpdateTime();
            }, 1000); // 每秒更新時間
        }

        // 頁面載入完成後執行
        window.onload = function() {
            console.log('頁面載入完成');
            console.log('TDX_CONFIG:', typeof TDX_CONFIG !== 'undefined' ? 'OK' : 'MISSING');
            console.log('tdxApi:', typeof tdxApi !== 'undefined' ? 'OK' : 'MISSING');
            
            loadAllData();
            initChart(); // 初始化監視器可用率圖表
            initApiChart(); // 初始化API狀態圖表
            startAutoUpdate();
        };
    </script>
</body>
</html>