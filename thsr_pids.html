<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THSR Dual PIDS Modern</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --text-white: #ffffff;
            --text-blue: #00e5ff;
            --text-yellow: #ffcc00;
            --dim-gray: #444;
            --header-north: #cc0000;
            --header-south: #009933;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-white);
            font-family: 'Segoe UI', 'Roboto', 'Helvetica', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .split-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
        }

        .board-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid #222;
            overflow: hidden;
        }

        .header {
            padding: 5px 20px;
            font-size: 2rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .header.north { background-color: var(--header-north); }
        .header.south { background-color: var(--header-south); }
        
        .station-name { font-size: 1.8rem; }
        .clock { font-family: 'Consolas', monospace; font-size: 2rem; letter-spacing: 2px; }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        thead {
            background-color: #1a1a1a;
            border-bottom: 1px solid #555;
        }

        th {
            color: #ccc;
            font-size: 1rem;
            text-align: left;
            padding: 8px 15px;
            font-weight: normal;
        }
        
        td {
            padding: 8px 15px;
            vertical-align: middle;
            font-size: 1.8rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-bottom: 1px solid #222;
        }

        .th-no { width: 9%; } 
        .th-dest { width: 10%; } 
        .th-time { width: 10%; }
        .th-plat { width: 7%; text-align: center; } 
        .th-free { width: 14%; }
        .th-status { width: 12%; } 
        .th-map { width: 38%; }

        .col-train-no { color: #fff; font-family: 'Consolas', monospace; }
        
        .col-dest { 
            color: var(--text-blue); 
            font-size: 2.2rem;
            font-weight: 900;
            text-shadow: 0 0 5px rgba(0, 229, 255, 0.3);
        }
        
        .col-time { color: #fff; font-family: 'Consolas', monospace; letter-spacing: 1px; }
        .col-plat { color: #fff; text-align: center; font-family: 'Consolas', monospace; }
        .col-free { color: #fff; font-size: 1.4rem; }
        
        .status-ok { color: var(--text-yellow); font-size: 1.4rem; }
        .status-delay { color: #ff3333; font-size: 1.4rem; animation: blink 1s infinite; }

        .station-map {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            padding: 0 5px;
            height: 40px;
        }

        .map-line {
            position: absolute;
            top: 14px;
            left: 10px;
            right: 10px;
            height: 2px;
            background-color: var(--dim-gray);
            z-index: 0;
        }

        .dot-wrapper {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #000;
            border: 2px solid var(--dim-gray);
            margin-bottom: 4px;
            transition: all 0.3s;
        }

        .dot.active {
            background-color: var(--text-blue);
            border-color: #fff;
            box-shadow: 0 0 8px var(--text-blue);
            transform: scale(1.2);
        }

        .dot-name {
            font-size: 0.65rem;
            color: #666;
            font-family: 'Arial', sans-serif;
            font-weight: normal;
            transform: scale(0.9);
        }

        .dot.active + .dot-name { color: #fff; font-weight: bold; }

        .marquee {
            background-color: #220000;
            color: #ff3333;
            padding: 8px 0;
            font-size: 1.5rem;
            white-space: nowrap;
            overflow: hidden;
            border-top: 2px solid #ff0000;
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        .marquee span {
            display: inline-block;
            padding-left: 100%;
            animation: scroll 30s linear infinite;
        }

        .marquee.normal {
            background-color: #000;
            color: var(--text-yellow);
            border-top: 1px solid #333;
        }

        @keyframes scroll { 
            0% { transform: translateX(0); } 
            100% { transform: translateX(-100%); } 
        }

        @keyframes blink { 
            50% { opacity: 0.5; } 
        }
    </style>
</head>
<body>
    <div id="app" class="split-container">
        
        <div class="board-section">
            <div class="header north">
                <div>北上 Northbound</div>
                <div class="clock">{{ currentTime }}</div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="th-no">車次 Train</th>
                        <th class="th-dest">開往 Dest.</th>
                        <th class="th-time">時間 Time</th>
                        <th class="th-plat">月台 Plat.</th>
                        <th class="th-free">自由座 Non-Reserved</th>
                        <th class="th-status">行車資訊 Status</th>
                        <th class="th-map">停靠站 Stopping Stations</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="train in northboundTrains" :key="train.train_no">
                        <td class="col-train-no">{{ train.train_no }}</td>
                        <td class="col-dest">{{ train.destination.zh }}</td>
                        <td class="col-time">{{ train.departure_time }}</td>
                        <td class="col-plat">{{ train.platform }}</td>
                        <td class="col-free">Car {{ train.free_seating_cars }}</td>
                        <td class="col-status"><span class="status-ok">準點 On Time</span></td>
                        <td class="col-map">
                            <div class="station-map">
                                <div class="map-line"></div>
                                <div v-for="st in allStationsReversed" :key="st.id" class="dot-wrapper">
                                    <div class="dot" :class="{ 'active': train.stopping_stations.includes(st.id) }"></div>
                                    <div class="dot-name">{{ st.code }}</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr v-if="northboundTrains.length === 0">
                        <td colspan="7" style="text-align:center; color:#555; padding: 40px;">無北上班次 No Northbound Trains</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="board-section">
            <div class="header south">
                <div>南下 Southbound</div>
                <div class="station-name">{{ currentStationName.zh }} {{ currentStationName.code }}</div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th class="th-no">車次 Train</th>
                        <th class="th-dest">開往 Dest.</th>
                        <th class="th-time">時間 Time</th>
                        <th class="th-plat">月台 Plat.</th>
                        <th class="th-free">自由座 Non-Reserved</th>
                        <th class="th-status">行車資訊 Status</th>
                        <th class="th-map">停靠站 Stopping Stations</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="train in southboundTrains" :key="train.train_no">
                        <td class="col-train-no">{{ train.train_no }}</td>
                        <td class="col-dest">{{ train.destination.zh }}</td>
                        <td class="col-time">{{ train.departure_time }}</td>
                        <td class="col-plat">{{ train.platform }}</td>
                        <td class="col-free">Car {{ train.free_seating_cars }}</td>
                        <td class="col-status"><span class="status-ok">準點 On Time</span></td>
                        <td class="col-map">
                            <div class="station-map">
                                <div class="map-line"></div>
                                <div v-for="st in allStations" :key="st.id" class="dot-wrapper">
                                    <div class="dot" :class="{ 'active': train.stopping_stations.includes(st.id) }"></div>
                                    <div class="dot-name">{{ st.code }}</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr v-if="southboundTrains.length === 0">
                        <td colspan="7" style="text-align:center; color:#555; padding: 40px;">無南下班次 No Southbound Trains</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="marquee" :class="{ 'normal': alerts.length === 0 }">
            <span>
                <span v-if="alerts.length > 0">
                    <span v-for="alert in alerts" :key="alert.AlertID" style="margin-right: 150px;">
                        ⚠ 【{{ alert.Title }}】{{ alert.Description }}
                    </span>
                </span>
                <span v-else>
                    {{ trainDetailMarquee }}
                </span>
            </span>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const API_URL = "https://thsr-proxy.xiaoyouwu5-fd3.workers.dev";
                
                const urlParams = new URLSearchParams(window.location.search);
                const stationID = ref(urlParams.get('station') || "1000"); 

                const trains = ref([]);
                const alerts = ref([]);
                const currentTime = ref("");

                const allStations = [
                    { id: "0990", name: "南港", code: "NAK" }, { id: "1000", name: "台北", code: "TPE" },
                    { id: "1010", name: "板橋", code: "BAC" }, { id: "1020", name: "桃園", code: "TAY" },
                    { id: "1030", name: "新竹", code: "HSC" }, { id: "1035", name: "苗栗", code: "MIL" },
                    { id: "1040", name: "台中", code: "TAC" }, { id: "1043", name: "彰化", code: "CHA" },
                    { id: "1047", name: "雲林", code: "YUL" }, { id: "1050", name: "嘉義", code: "CHY" },
                    { id: "1060", name: "台南", code: "TNN" }, { id: "1070", name: "左營", code: "ZUY" }
                ];
                
                const stationNameMap = {};
                allStations.forEach(s => stationNameMap[s.id] = s.name);

                const allStationsReversed = [...allStations].reverse();

                const southboundTrains = computed(() => trains.value.filter(t => t.direction === 0).slice(0, 4));
                const northboundTrains = computed(() => trains.value.filter(t => t.direction === 1).slice(0, 4));

                const currentStationName = computed(() => {
                    const st = allStations.find(s => s.id === stationID.value);
                    return st ? { zh: st.name, code: st.code } : { zh: "", code: "" };
                });

                const trainDetailMarquee = computed(() => {
                    const targetTrains = [...northboundTrains.value, ...southboundTrains.value];
                    if (targetTrains.length === 0) return "歡迎搭乘台灣高鐵 Welcome to Taiwan High Speed Rail";

                    return targetTrains.map(t => {
                        const currentIndex = t.stopping_stations.indexOf(stationID.value);
                        let futureStops = t.stopping_stations;
                        if (currentIndex !== -1 && currentIndex < t.stopping_stations.length - 1) {
                            futureStops = t.stopping_stations.slice(currentIndex + 1);
                        }
                        
                        const stopsText = futureStops.map(id => stationNameMap[id]).join("、");
                        return `第 ${t.train_no} 車次 ${t.departure_time} 開往 ${t.destination.zh}，沿途停靠：${stopsText}。`;
                    }).join("          ");
                });

                const fetchData = async () => {
                    try {
                        const res = await fetch(`${API_URL}/?station=${stationID.value}`);
                        const data = await res.json();
                        const now = new Date();
                        const currentHm = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
                        trains.value = data.trains.filter(t => t.departure_time >= currentHm);
                        alerts.value = data.alerts || [];
                    } catch (e) { console.error(e); }
                };

                setInterval(() => {
                    const now = new Date();
                    currentTime.value = now.toLocaleTimeString('en-US', {hour12: false});
                }, 1000);

                setInterval(fetchData, 60000);

                onMounted(() => {
                    fetchData();
                    const now = new Date();
                    currentTime.value = now.toLocaleTimeString('en-US', {hour12: false});
                });

                return {
                    stationID, northboundTrains, southboundTrains, alerts, currentTime,
                    allStations, allStationsReversed, currentStationName, trainDetailMarquee
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
