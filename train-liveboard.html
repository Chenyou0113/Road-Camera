<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµå³æ™‚çœ‹æ¿ - æ™ºæ…§åˆ—è»ŠæŸ¥è©¢ç³»çµ± V10</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="assets/config.js"></script>
    <script src="assets/train-line-classification.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background: linear-gradient(135deg, #3575ff 0%, #15bbd8 100%); min-height: 100vh; padding-bottom: 80px; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #D84315; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #016d68; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; transition: background 0.3s; }
        .back-btn:hover { background: #034d64; }
        .control-panel { background: linear-gradient(135deg, rgba(53, 134, 255, 0.9) 0%, rgba(21, 144, 216, 0.9) 100%); margin: 20px 0; padding: 25px; border-radius: 15px; }
        .control-panel h3 { color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .selector-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 15px; align-items: end; }
        .selector-group { display: flex; flex-direction: column; }
        .selector-group label { margin-bottom: 8px; font-weight: 600; color: white; }
        .selector-group select, .selector-group input { padding: 12px 15px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.3); background: white; color: #333; font-size: 1rem; }
        .query-btn { padding: 12px 30px; background: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; }
        .query-btn:hover { background: #45a049; }
        .train-container { background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; margin: 20px 0; }
        .board-header { background: linear-gradient(135deg, #FF6B35 0%, #D84315 100%); color: white; padding: 20px; }
        .board-title h2 { font-size: 1.5rem; margin-bottom: 5px; }
        .pids-btn { display: inline-flex; align-items: center; gap: 8px; background: #212121; color: #ffb74d; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-weight: bold; }
        .direction-section { border-bottom: 2px solid #eee; }
        .direction-header { background: #f5f5f5; padding: 15px 20px; font-weight: 600; color: #333; border-left: 4px solid #FF6B35; }
        .train-card { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; }
        .train-info { display: flex; align-items: center; gap: 12px; }
        .train-type-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; color: white; font-size: 0.85rem; font-weight: bold; min-width: 90px; text-align: center; }
        .type-è‡ªå¼· { background-color: #FF5722; }
        .type-æŸ´è‡ªå¼· { background-color: #D84315; }
        .type-æ–°è‡ªå¼· { background: linear-gradient(135deg, #000000 0%, #333333 100%); }
        .type-æ™®æ‚ ç‘ª { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); }
        .type-å¤ªé­¯é–£ { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .type-è’å…‰ { background-color: #FF9800; }
        .type-å€é–“å¿« { background-color: #3F51B5; }
        .type-å€é–“ { background-color: #2196F3; }
        .type-å°ˆè»Š { background: linear-gradient(135deg, #673AB7 0%, #512DA8 100%); }
        .type-å¾©èˆˆ { background-color: #00BCD4; }
        .type-æ™®å¿« { background-color: #009688; }
        .no-data { text-align: center; padding: 60px 20px; color: #999; }
        .no-data i { font-size: 3rem; margin-bottom: 20px; }
        .delay-badge { display: inline-block; padding: 6px 10px; border-radius: 6px; font-weight: bold; }
        .delay-ok { background-color: #E8F5E9; color: #2E7D32; }
        .delay-warn { background-color: #FFEBEE; color: #C62828; }
        .marquee-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: #212121; display: flex; align-items: center; z-index: 9999; border-top: 4px solid #ff9800; }
        .marquee-info { display: none !important; }
        .marquee-train-no { display: none; }
        .marquee-dest { display: none; }
        .marquee-content-wrapper { flex: 1; overflow: hidden; position: relative; height: 100%; background: #212121; display: flex; align-items: center; }
        .marquee-content { position: absolute; white-space: nowrap; font-size: 1.4rem; font-weight: bold; line-height: 60px; padding-left: 100%; color: #fff; }
        .marquee-close { background: #222; border: none; color: #999; width: 50px; height: 100%; cursor: pointer; }
        .station-stop { color: #ffeb3b; }
        .station-arrow { color: #aaa; margin: 0 5px; }
        @keyframes marquee-scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @media (max-width: 900px) { .selector-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é </a>
            <h1><i class="fas fa-train"></i> å°éµå³æ™‚çœ‹æ¿</h1>
        </div>
    </div>

    <div class="container">
        <div class="control-panel">
            <h3><i class="fas fa-search"></i> æŸ¥è©¢å³æ™‚çœ‹æ¿</h3>
            <div class="selector-row">
                <div class="selector-group">
                    <label>è·¯ç·šåˆ†é¡</label>
                    <select id="lineSelect" onchange="filterStations()"><option value="all">å…¨éƒ¨è·¯ç·š</option></select>
                </div>
                <div class="selector-group">
                    <label>æœå°‹è»Šç«™</label>
                    <input type="text" id="stationSearch" placeholder="è¼¸å…¥ç«™å" oninput="filterStations()">
                </div>
                <div class="selector-group">
                    <label>é¸æ“‡è»Šç«™</label>
                    <select id="stationSelect"><option value="">è«‹é¸æ“‡è»Šç«™...</option></select>
                </div>
                <div class="selector-group">
                    <label>æ–¹å‘</label>
                    <select id="directionFilter">
                        <option value="">å…¨éƒ¨</option>
                        <option value="0">é †è¡Œ</option>
                        <option value="1">é€†è¡Œ</option>
                    </select>
                </div>
                <button class="query-btn" id="queryBtn" onclick="fetchTrainLiveBoard()"><i class="fas fa-sync-alt"></i> æŸ¥è©¢</button>
            </div>
        </div>

        <div id="trainContainer" class="train-container" style="display: none;">
            <div class="board-header">
                <h2 id="stationTitle">åˆ—è»Šå‹•æ…‹</h2>
                <div><span id="stationInfo"></span> | <span id="updateTime">--:--:--</span></div>
            </div>
            <div id="trainsBoard">
                <div class="no-data"><p>è«‹é¸æ“‡è»Šç«™æŸ¥è©¢</p></div>
            </div>
        </div>
    </div>

    <div id="trainMarqueeBar" class="marquee-bar" style="display: none;">
        <div class="marquee-info"><div class="marquee-train-no" id="mqTrainNo"></div><div class="marquee-dest" id="mqDest"></div></div>
        <div class="marquee-content-wrapper"><div class="marquee-content" id="mqContent"></div></div>
        <button class="marquee-close" onclick="closeMarquee()">Ã—</button>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        // ============ å…¨å±€è®Šæ•¸ ============
        let currentStationID = '';
        let currentStationName = '';
        let allStationsFlat = []; 
        const trainDataCache = {}; 
        const TRA_WORKER_URL = "https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev";

        // ============ è³‡æ–™åº«ï¼šåˆ—è»Šç¨®é¡ ============
        const TRAIN_TYPE_DB = [
          { "id": "1100", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1101", "name": "å¤ªé­¯é–£", "code": "1" },
          { "id": "1102", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1103", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1107", "name": "æ™®æ‚ ç‘ª", "code": "2" },
          { "id": "1108", "name": "è‡ªå¼·", "code": "3" },
          { "id": "110G", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "110H", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "110K", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "110M", "name": "è‡ªå¼·(3000)", "code": "11" },
          { "id": "1110", "name": "è’å…‰", "code": "4" },
          { "id": "1111", "name": "è’å…‰", "code": "4" },
          { "id": "1114", "name": "è’å…‰", "code": "4" },
          { "id": "1115", "name": "è’å…‰", "code": "4" },
          { "id": "1120", "name": "å¾©èˆˆ", "code": "5" },
          { "id": "1131", "name": "å€é–“", "code": "6" },
          { "id": "1132", "name": "å€é–“å¿«", "code": "6" },
          { "id": "1140", "name": "æ™®å¿«", "code": "7" }
        ];
        const trainTypeMap = new Map();
        TRAIN_TYPE_DB.forEach(item => trainTypeMap.set(item.id, item.name));

        document.addEventListener('DOMContentLoaded', () => {
            initStationControls();
        });

        // ============ å‡½å¼ï¼šè»Šç«™ç¯©é¸èˆ‡åˆå§‹åŒ– ============
        function initStationControls() {
            const lineSelect = document.getElementById('lineSelect');
            for (const [key, data] of Object.entries(trainLineClassification)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = data.name;
                data.stations.forEach(station => {
                    const option = document.createElement('option');
                    option.value = station.code;
                    option.textContent = `${station.code} - ${station.name}`;
                    optgroup.appendChild(option);
                    if (!allStationsFlat.find(s => s.code === station.code)) {
                        allStationsFlat.push({ code: station.code, name: station.name });
                    }
                });
                lineSelect.appendChild(optgroup);
            }
            filterStations();
        }

        function filterStations() {
            const keyword = document.getElementById('stationSearch').value.toLowerCase().trim();
            let filtered = allStationsFlat;
            if (keyword) filtered = filtered.filter(s => s.name.includes(keyword) || s.code.includes(keyword));
            
            const select = document.getElementById('stationSelect');
            select.innerHTML = `<option value="">è«‹é¸æ“‡è»Šç«™ (${filtered.length})</option>`;
            filtered.forEach(s => {
                const option = document.createElement('option');
                option.value = s.code;
                option.textContent = `${s.code} - ${s.name}`;
                select.appendChild(option);
            });
        }

        // ============ ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šæ•´åˆæ™‚åˆ»è¡¨ (Today+Tomorrow) + LiveBoard ============
        async function fetchTrainLiveBoard() {
            const stationSelect = document.getElementById('stationSelect');
            const queryBtn = document.getElementById('queryBtn');
            currentStationID = stationSelect.value;
            if (!currentStationID) { alert('è«‹å…ˆé¸æ“‡è»Šç«™'); return; }
            
            const selectedOption = stationSelect.options[stationSelect.selectedIndex];
            currentStationName = selectedOption.text.split(' - ')[1];
            queryBtn.disabled = true;
            document.getElementById('trainContainer').style.display = 'block';
            document.getElementById('trainsBoard').innerHTML = '<div class="no-data"><i class="fas fa-spinner fa-spin"></i><p>æ­£åœ¨æ•´åˆæ™‚åˆ»è¡¨èˆ‡å³æ™‚è³‡è¨Š...</p></div>';

            try {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];

                // å¹³è¡Œè«‹æ±‚
                const [todaySchedule, tomorrowSchedule, liveBoardData] = await Promise.all([
                    tdxApi.fetch(`/v3/Rail/TRA/DailyTimetable/Station/${currentStationID}/${todayStr}?$format=JSON`),
                    tdxApi.fetch(`/v3/Rail/TRA/DailyTimetable/Station/${currentStationID}/${tomorrowStr}?$format=JSON`),
                    tdxApi.fetch(`/v2/Rail/TRA/LiveBoard?$filter=StationID eq '${currentStationID}'&$format=JSON`).catch(() => [])
                ]);

                // èª¤é» Map
                const delayMap = {};
                if (Array.isArray(liveBoardData)) {
                    liveBoardData.forEach(t => delayMap[t.TrainNo] = t.DelayTime || 0);
                }

                let allTrains = [];
                const currentTimeStr = now.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' });

                // è™•ç†ä»Šæ—¥
                if (todaySchedule && todaySchedule[0]?.StationTimetables) {
                    todaySchedule[0].StationTimetables.forEach(t => {
                        const time = t.DepartureTime || t.ArrivalTime;
                        if (time >= currentTimeStr) allTrains.push(processTrainData(t, delayMap, false));
                    });
                }
                // è™•ç†æ˜æ—¥
                if (tomorrowSchedule && tomorrowSchedule[0]?.StationTimetables) {
                    tomorrowSchedule[0].StationTimetables.forEach(t => {
                        allTrains.push(processTrainData(t, delayMap, true));
                    });
                }

                // åˆ†çµ„èˆ‡åˆ‡ç‰‡ (å‰ 6 ç­)
                let trains0 = allTrains.filter(t => t.Direction === 0).slice(0, 6);
                let trains1 = allTrains.filter(t => t.Direction === 1).slice(0, 6);
                
                renderBoard([...trains0, ...trains1]);

            } catch (error) {
                console.error(error);
                showError('æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                queryBtn.disabled = false;
            }
        }

        function processTrainData(t, delayMap, isTomorrow) {
            return {
                TrainNo: t.TrainNo,
                Direction: t.Direction,
                TrainTypeName: t.TrainTypeName?.Zh_tw || t.TrainTypeName,
                TrainTypeID: t.TrainTypeID,
                EndingStationName: t.DestinationStationName?.Zh_tw || t.DestinationStationName,
                ScheduledDepartureTime: t.DepartureTime || t.ArrivalTime,
                DelayTime: delayMap[t.TrainNo] !== undefined ? delayMap[t.TrainNo] : 0,
                IsTomorrow: isTomorrow
            };
        }

        function renderBoard(trains) {
            const trainsBoard = document.getElementById('trainsBoard');
            const directionFilter = document.getElementById('directionFilter').value;
            const pidsLink = `pids-live.html?station=${currentStationID}&name=${encodeURIComponent(currentStationName)}`;
            
            document.getElementById('stationTitle').innerHTML = `${currentStationName} å³æ™‚çœ‹æ¿ <a href="${pidsLink}" target="_blank" class="pids-btn"><i class="fas fa-desktop"></i> é–‹å•Ÿ PIDS æ¨¡æ“¬</a>`;
            document.getElementById('stationInfo').textContent = `è»Šç«™ä»£ç¢¼ï¼š${currentStationID}`;
            
            let filteredTrains = trains;
            if (directionFilter !== '') filteredTrains = trains.filter(t => String(t.Direction) === directionFilter);

            const grouped = {
                '0': { title: 'é †è¡Œ (å—ä¸‹/è¥¿è¡Œ)', trains: [] },
                '1': { title: 'é€†è¡Œ (åŒ—ä¸Š/æ±ä¸Š)', trains: [] }
            };
            filteredTrains.forEach(train => {
                const dir = String(train.Direction);
                if (grouped[dir]) grouped[dir].trains.push(train);
            });

            let html = '';
            Object.entries(grouped).forEach(([dir, data]) => {
                if (data.trains.length === 0) return;
                html += `<div class="direction-section"><div class="direction-header"><i class="fas fa-arrow-right"></i> ${data.title}</div>`;
                data.trains.forEach(train => {
                    const timeText = formatTime(train.ScheduledDepartureTime);
                    const delayStatus = getDelayStatus(train);
                    const endStation = train.EndingStationName || 'æœªçŸ¥';
                    const trainInfo = getTrainDisplayInfo(train);
                    
                    let timeDisplay = timeText;
                    if (train.IsTomorrow) timeDisplay += ' <span style="font-size:0.7em; color:#999;">(æ˜æ—¥)</span>';

                    html += `<div class="train-card" style="cursor: pointer;" onclick="showTrainStops('${train.TrainNo}', '${currentStationID}', '${endStation}')">
                            <div class="train-info">
                                <span class="train-type-badge type-${trainInfo.class}">${trainInfo.name}</span>
                                <div><div>${train.TrainNo} æ¬¡</div><div>å¾€ ${endStation}</div></div>
                            </div>
                            <div>${timeDisplay}</div>
                            <div>${delayStatus}</div>
                        </div>`;
                });
                html += '</div>';
            });

            if (html === '') showNoData('è©²æ–¹å‘ç›®å‰ç„¡åˆ—è»Š');
            else trainsBoard.innerHTML = html;
        }

        // ============ è¼”åŠ©å‡½å¼ ============
        function getTrainDisplayInfo(train) {
            let name = train.TrainTypeName || 'åˆ—è»Š';
            let cssClass = 'å…¶ä»–';
            const typeID = train.TrainTypeID;
            if (typeID && trainTypeMap.has(typeID)) name = trainTypeMap.get(typeID);
            else {
                if (name.includes('æ™®æ‚ ç‘ª')) name = 'æ™®æ‚ ç‘ª';
                else if (name.includes('å¤ªé­¯é–£')) name = 'å¤ªé­¯é–£';
                else if (name.includes('3000')) name = 'è‡ªå¼·(3000)';
                else if (name.includes('å€é–“å¿«')) name = 'å€é–“å¿«';
                else if (name.includes('å€é–“')) name = 'å€é–“';
                else if (name.includes('è‡ªå¼·')) name = 'è‡ªå¼·';
                else if (name.includes('è’å…‰')) name = 'è’å…‰';
                else if (name.includes('å¾©èˆˆ')) name = 'å¾©èˆˆ';
            }
            if (name.includes('3000')) cssClass = 'è‡ªå¼·3000';
            else if (name.includes('æ™®æ‚ ç‘ª')) cssClass = 'æ™®æ‚ ç‘ª';
            else if (name.includes('å¤ªé­¯é–£')) cssClass = 'å¤ªé­¯é–£';
            else if (name.includes('è‡ªå¼·')) cssClass = 'è‡ªå¼·';
            else if (name.includes('è’å…‰')) cssClass = 'è’å…‰';
            else if (name.includes('å€é–“å¿«')) cssClass = 'å€é–“å¿«';
            else if (name.includes('å€é–“')) cssClass = 'å€é–“';
            else if (name.includes('å¾©èˆˆ')) cssClass = 'å¾©èˆˆ';
            else if (name.includes('è§€å…‰')) cssClass = 'è§€å…‰';
            return { name, class: cssClass };
        }

        function formatTime(t) { return (t && t.length >= 5) ? t.substring(0, 5) : '--:--'; }
        
        function getDelayStatus(train) {
            const d = parseInt(train.DelayTime || 0);
            if (d === 0) return '<span class="delay-badge delay-ok"><i class="fas fa-check"></i> æº–é»</span>';
            return `<span class="delay-badge delay-warn"><i class="fas fa-clock"></i> æ™š ${d} åˆ†</span>`;
        }

        function showNoData(msg) {
            document.getElementById('trainsBoard').innerHTML = `<div class="no-data"><i class="fas fa-inbox"></i><p>${msg}</p></div>`;
            document.getElementById('trainContainer').style.display = 'block';
        }
        function showError(msg) {
            document.getElementById('trainsBoard').innerHTML = `<div class="no-data"><i class="fas fa-exclamation-triangle" style="color: #f44336;"></i><p style="color: #f44336;">${msg}</p></div>`;
            document.getElementById('trainContainer').style.display = 'block';
        }

        function updateTime() {
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        setInterval(updateTime, 1000);

        // ============ ğŸ”¥ è·‘é¦¬ç‡ˆåŠŸèƒ½ (Worker å„ªå…ˆ) ============
        function addMinutesToTime(timeStr, minutesToAdd) {
            if (!timeStr) return '--:--';
            if (minutesToAdd === 0) return timeStr;
            const [hours, minutes] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(hours);
            date.setMinutes(minutes + minutesToAdd);
            return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        }

        async function fetchSchedule(trainNo) {
            try {
                const r = await fetch(`${TRA_WORKER_URL}/api/schedule?trainNo=${trainNo}`);
                const d = await r.json();
                if (d?.[0]?.StopTimes) return d[0].StopTimes;
            } catch(e) {}
            try {
                const r = await tdxApi.fetch(`/v2/Rail/TRA/DailyTrainInfo/TrainNo/${trainNo}?$format=JSON`);
                if (r?.[0]?.StopTimes) return r[0].StopTimes;
            } catch(e) {}
            return [];
        }

        async function showTrainStops(trainNo, currentStationID, destName) {
            const bar = document.getElementById('trainMarqueeBar');
            const content = document.getElementById('mqContent');
            bar.style.display = 'flex';
            content.innerHTML = '<span style="color:#aaa; font-size:1.2rem;"><i class="fas fa-satellite-dish fa-pulse"></i> è®€å–ä¸­...</span>';
            content.style.animation = 'none'; 
            
            try {
                const liveWorkerPromise = fetch(`${TRA_WORKER_URL}/api/live?trainNo=${trainNo}`).then(r=>r.json()).catch(()=>null);
                const schedulePromise = fetchSchedule(trainNo);
                
                let [stopTimes, liveRawData] = await Promise.all([schedulePromise, liveWorkerPromise]);
                
                let liveData = null;
                if (liveRawData) {
                    if (liveRawData.TrainLiveBoards?.length > 0) liveData = liveRawData.TrainLiveBoards[0];
                    else if (Array.isArray(liveRawData) && liveRawData.length > 0) liveData = liveRawData[0];
                    else if (liveRawData.StationName) liveData = liveRawData;
                }
                if (!liveData) {
                    try {
                        const tdxResp = await tdxApi.fetch(`/v3/Rail/TRA/TrainLiveBoard/TrainNo/${trainNo}?$format=JSON`);
                        if (tdxResp?.TrainLiveBoards?.length > 0) liveData = tdxResp.TrainLiveBoards[0];
                    } catch(e){}
                }

                let html = '';
                const delayTime = parseInt(liveData?.DelayTime || 0);
                
                html += `<span style="color: #ffeb3b; font-size: 1.5rem; margin-right: 10px;">${trainNo} æ¬¡</span>`;
                html += `<span style="color: #fff; margin-right: 15px;">å¾€ ${destName}</span>`;
                
                if (stopTimes.length > 0) {
                    const idx = stopTimes.findIndex(s => s.StationID === currentStationID);
                    if (idx !== -1) {
                        const tableTime = stopTimes[idx].ArrivalTime || stopTimes[idx].DepartureTime;
                        const predicted = addMinutesToTime(tableTime, delayTime);
                        const color = delayTime > 0 ? '#ff5252' : '#00e676';
                        html += `<span style="border-left: 2px solid #555; margin: 0 15px;"></span>æœ¬ç«™é è¨ˆ <span style="color:${color}; font-size: 1.3rem;">${predicted}</span> æŠµé”`;
                    }
                }

                html += `<span style="border-left: 2px solid #555; margin: 0 15px;"></span>`;
                if (liveData?.StationName) {
                    const stName = liveData.StationName.Zh_tw || liveData.StationName;
                    const delayText = delayTime <= 0 ? `<span style="color:#00e676;">(æº–é»)</span>` : `<span style="color:#ff5252;">(æ™š ${delayTime} åˆ†)</span>`;
                    let nextSt = "";
                    if (stopTimes.length > 0) {
                        const idx = stopTimes.findIndex(s => s.StationName.Zh_tw === stName);
                        if (idx !== -1 && idx < stopTimes.length-1) nextSt = stopTimes[idx+1].StationName.Zh_tw;
                    }
                    html += nextSt ? `ç›®å‰ä½ç½®ï¼š<span style="color: #4fc3f7;">${stName} â¡ ${nextSt}</span> ${delayText}` : `ç›®å‰ä½ç½®ï¼š<span style="color: #4fc3f7;">${stName}</span> ${delayText}`;
                } else {
                    html += `<span style="color:#aaa;">(æš«ç„¡å³æ™‚ä½ç½®è¨Šè™Ÿ)</span>`;
                }

                if (stopTimes.length > 0) {
                    const idx = stopTimes.findIndex(s => s.StationID === currentStationID);
                    const showStops = (idx !== -1) ? stopTimes.slice(idx + 1) : stopTimes;
                    if (showStops.length > 0) {
                        html += `<span style="border-left: 2px solid #555; margin: 0 15px;"></span><span style="color:#ddd;">æ²¿é€”åœé ï¼š</span>`;
                        html += showStops.map(s => `<span class="station-stop">${s.StationName.Zh_tw}</span>`).join('<span class="station-arrow">â–¶</span>');
                    }
                }

                content.innerHTML = html;
                void content.offsetHeight;
                const duration = Math.max(10, content.innerText.length * 0.25);
                content.style.animation = `marquee-scroll ${duration}s linear infinite`;

            } catch (error) {
                console.error(error);
                content.innerHTML = '<span style="color:#ff5252;">ç„¡æ³•å–å¾—è©³ç´°è³‡è¨Š</span>';
            }
        }

        function closeMarquee() { document.getElementById('trainMarqueeBar').style.display = 'none'; }
    </script>
</body>
</html>
