<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½å¤©æ°£é å ± | Pro Version</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS è®Šæ•¸ç³»çµ± --- */
        :root {
            --primary: #009688;
            --primary-dark: #00796b;
            --bg-body: #f0f4f8;
            --bg-card: #ffffff;
            --bg-card-night: #e8eaed;
            --text-main: #333333;
            --text-sub: #666666;
            --border-color: #e0e0e0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --rain-bg: #e3f2fd;
            --rain-text: #1976d2;
        }

        body.dark-mode {
            --primary: #2dd4bf;
            --primary-dark: #14b8a6;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-card-night: #0f172a;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --border-color: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --rain-bg: rgba(30, 58, 138, 0.4);
            --rain-text: #60a5fa;
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 40px; }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 1rem 1.5rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky; top: 0; z-index: 100;
        }
        h1 { margin: 0; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .back-btn { color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 50px; font-size: 0.9rem; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        /* --- Container & Controls --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .control-panel {
            background: var(--bg-card); padding: 20px; border-radius: 16px;
            box-shadow: var(--shadow); display: flex; flex-wrap: wrap; gap: 20px;
            margin-bottom: 30px; border: 1px solid var(--border-color);
        }
        
        .input-group { flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 8px; }
        .input-group label { font-weight: 600; color: var(--primary); font-size: 0.9rem; }
        
        select {
            padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--bg-body); color: var(--text-main); font-size: 1rem; outline: none;
            cursor: pointer; width: 100%;
        }
        select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0, 150, 136, 0.2); }

        /* --- Grid Layout --- */
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }

        /* --- Weather Card --- */
        .card {
            background: var(--bg-card); border-radius: 16px; padding: 20px 15px;
            text-align: center; position: relative; overflow: hidden;
            box-shadow: var(--shadow); border: 1px solid var(--border-color);
            display: flex; flex-direction: column; justify-content: space-between;
            animation: fadeIn 0.5s ease forwards;
        }
        
        .card.is-night { background: var(--bg-card-night); }
        .card.is-night::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: #64748b;
        }

        .card::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: var(--primary);
        }

        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        .card-date { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 4px; }
        .card-time { font-size: 1rem; font-weight: bold; margin-bottom: 15px; height: 1.2em; }
        .card-icon { font-size: 3rem; margin: 10px 0; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        .card-desc { 
            font-size: 0.9rem; color: var(--text-sub); margin-bottom: 10px; 
            height: 2.4em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .card-temp { font-size: 1.4rem; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .card-rain {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--rain-bg); color: var(--rain-text);
            padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
        }

        /* --- Status & Loading --- */
        .status-msg { grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-sub); font-size: 1.2rem; }
        .footer-info { text-align: center; margin-top: 30px; font-size: 0.85rem; color: var(--text-sub); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @media (max-width: 600px) {
            .forecast-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .card { padding: 15px 10px; }
            .card-icon { font-size: 2.2rem; }
            .card-temp { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-cloud-sun-rain"></i> å¤©æ°£é å ± Pro</h1>
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> å›é¦–é </a>
    </header>

    <div class="container">
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="input-group">
                <label><i class="fas fa-layer-group"></i> é å ±æ¨¡å¼</label>
                <select id="datasetSelect">
                    <!-- å°‡é è¨­å€¼è¨­ç‚ºæ‚¨æä¾›çš„é€™å€‹è³‡æ–™é›† -->
                    <option value="F-D0047-091" selected>ğŸ“† æœªä¾†ä¸€é€±é å ± (é„‰é® 12h)</option>
                    <option value="F-D0047-089">ğŸ•’ æœªä¾†ä¸‰å¤© (æ¯3å°æ™‚)</option>
                    <option value="F-C0032-001">ğŸ‡¹ğŸ‡¼ 36 å°æ™‚é å ± (ç¸£å¸‚)</option>
                </select>
            </div>
            <div class="input-group">
                <label><i class="fas fa-map-marker-alt"></i> åœ°é»é¸æ“‡</label>
                <select id="locationSelect" disabled>
                    <option>è³‡æ–™è¼‰å…¥ä¸­...</option>
                </select>
            </div>
        </div>

        <!-- å¡ç‰‡é¡¯ç¤ºå€ -->
        <div id="forecastGrid" class="forecast-grid">
            <div class="status-msg"><i class="fas fa-circle-notch fa-spin"></i> æ­£åœ¨é€£ç·šæ°£è±¡è³‡æ–™åº«...</div>
        </div>

        <div id="lastUpdate" class="footer-info"></div>
    </div>

    <script>
        const WORKER_URL = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev';
        
        let App = {};
        
        // ====================================================================
        // é‡é»ä¿®æ­£ï¼šå°æ‡‰è¡¨ (Matching Logic)
        // ====================================================================
        
        /**
         * ä¾æ“š Dataset ID ç²¾ç¢ºæŸ¥æ‰¾ ElementName
         * ä¿®æ­£é»ï¼šåŠ å…¥äº† F-D0047-091 ç‰¹æœ‰çš„ä¸­æ–‡æ¬„ä½åç¨±
         */
        function findEl(elements, candidates) {
            if(!elements) return null;
            
            // å°‡æˆ‘å€‘æƒ³æ‰¾çš„ candidates (ä¾‹å¦‚ MinT) æ“´å±•æˆè³‡æ–™åº«è£¡å¯¦éš›å¯èƒ½çš„åç¨±
            const realNamesMap = {
                // æœ€ä½æº«ï¼šF-D0047-091 ç”¨ "æœ€ä½æº«åº¦", F-C0032 ç”¨ "MinT"
                'MinT': ['æœ€ä½æº«åº¦', 'MinTemperature', 'MinT'],
                // æœ€é«˜æº«ï¼šF-D0047-091 ç”¨ "æœ€é«˜æº«åº¦", F-C0032 ç”¨ "MaxT"
                'MaxT': ['æœ€é«˜æº«åº¦', 'MaxTemperature', 'MaxT'],
                // å¤©æ°£ç¾è±¡ï¼šF-D0047-091 ç”¨ "å¤©æ°£ç¾è±¡", F-C0032 ç”¨ "Wx"
                'Wx': ['å¤©æ°£ç¾è±¡', 'Weather', 'Wx', 'WeatherDescription'],
                // é™é›¨æ©Ÿç‡ï¼šF-D0047-091 ç”¨ "12å°æ™‚é™é›¨æ©Ÿç‡", F-C0032 ç”¨ "PoP"
                'PoP': ['12å°æ™‚é™é›¨æ©Ÿç‡', '3å°æ™‚é™é›¨æ©Ÿç‡', 'ProbabilityOfPrecipitation', 'PoP', 'PoP12h', 'PoP6h']
            };

            for (const key of candidates) {
                const searchList = realNamesMap[key] || [key];
                for (const searchName of searchList) {
                    const found = elements.find(e => e.elementName === searchName);
                    if (found) return found;
                }
            }
            return null;
        }

        /**
         * é‡é»ä¿®æ­£ï¼šå–å€¼é‚è¼¯ (Value Extraction)
         * ä¿®æ­£é»ï¼šF-D0047-091 çš„ ElementValue æ˜¯ä¸€å€‹é™£åˆ—ï¼Œè£¡é¢æ˜¯ç‰©ä»¶ï¼Œä¾‹å¦‚ [{"Temperature": "17"}]
         * æˆ‘å€‘éœ€è¦å¿½ç•¥ "Code", "Unit" ç­‰å¾Œç¶´ï¼ŒæŠ“å‡ºçœŸæ­£çš„æ•¸å€¼ã€‚
         */
        function getValue(timeObj) {
            if (!timeObj) return '--';
            
            // 1. è™•ç† ElementValue (F-D0047 ç³»åˆ—)
            if (timeObj.elementValue && Array.isArray(timeObj.elementValue)) {
                const valObj = timeObj.elementValue[0]; // å–ç¬¬ä¸€å€‹ç‰©ä»¶
                if (valObj && typeof valObj === 'object') {
                    for (const key in valObj) {
                        // éæ¿¾æ‰ä¸é¡¯ç¤ºçš„ metadata
                        if (key.endsWith('Code') || key.endsWith('Unit') || key.endsWith('Measures')) continue;
                        if (valObj[key]) return valObj[key]; // æ‰¾åˆ°ç¬¬ä¸€å€‹æœ‰æ•ˆå€¼å°±å›å‚³ (ä¾‹å¦‚ "17")
                    }
                }
            }
            
            // 2. è™•ç† Parameter (F-C0032 ç³»åˆ—)
            if (timeObj.parameter) {
                return timeObj.parameter.parameterName || '--';
            }
            
            return '--';
        }

        // ====================================================================
        // App Controller
        // ====================================================================
        
        App = {
            API_URL: WORKER_URL,
            currentData: [],

            init() {
                if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
                this.bindEvents();
                this.fetchData();
            },

            bindEvents() {
                document.getElementById('datasetSelect').addEventListener('change', () => this.fetchData());
                document.getElementById('locationSelect').addEventListener('change', () => this.renderForecast());
            },

            async fetchData() {
                const datasetId = document.getElementById('datasetSelect').value;
                const grid = document.getElementById('forecastGrid');
                const locSelect = document.getElementById('locationSelect');

                grid.innerHTML = '<div class="status-msg"><i class="fas fa-spinner fa-spin"></i> è³‡æ–™è®€å–ä¸­...</div>';
                locSelect.innerHTML = '<option>è¼‰å…¥ä¸­...</option>';
                locSelect.disabled = true;

                try {
                    const response = await fetch(`${this.API_URL}?dataset=${datasetId}`);
                    const json = await response.json();
                    
                    if (!json || (typeof json === 'object' && Object.keys(json).length === 0)) {
                        throw new Error("API å›å‚³ç©ºè³‡æ–™");
                    }

                    // ä½¿ç”¨è§£æå™¨è™•ç†åŸå§‹çµæ§‹
                    this.currentData = DataParser.parse(json);

                    if (this.currentData.length === 0) {
                        console.error("è§£æå¾Œè³‡æ–™é•·åº¦ç‚º 0", json);
                        throw new Error("è³‡æ–™è§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™ä¾†æºæ ¼å¼");
                    }

                    console.log(`âœ… æˆåŠŸå–å¾— ${this.currentData.length} ç­†åœ°é»è³‡æ–™`);
                    this.populateLocations();
                    this.renderForecast();

                } catch (error) {
                    console.error("API Error:", error);
                    grid.innerHTML = `<div class="status-msg" style="color:#ef4444"><i class="fas fa-exclamation-circle"></i> è®€å–å¤±æ•—: ${error.message}</div>`;
                    locSelect.innerHTML = '<option>ç„¡è³‡æ–™</option>';
                }
            },

            populateLocations() {
                const locSelect = document.getElementById('locationSelect');
                locSelect.innerHTML = '';
                
                this.currentData.forEach((loc, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = loc.name;
                    locSelect.appendChild(option);
                });

                // é è¨­é¸å–å°åŒ—
                let defaultIdx = 0;
                const foundIdx = this.currentData.findIndex(l => l.name.includes('è‡ºåŒ—å¸‚') || l.name.includes('å°åŒ—'));
                if (foundIdx !== -1) defaultIdx = foundIdx;

                locSelect.value = defaultIdx;
                locSelect.disabled = false;
            },

            renderForecast() {
                const index = document.getElementById('locationSelect').value;
                const location = this.currentData[index];
                const grid = document.getElementById('forecastGrid');

                if (!location || !location.rawElements) { 
                    grid.innerHTML = '<div class="status-msg">è³‡æ–™éºå¤±</div>';
                    return;
                }

                let html = '';
                const elements = location.rawElements;

                // é€™è£¡ä½¿ç”¨æ›´å¯¬é¬†çš„æŸ¥æ‰¾é‚è¼¯
                const wx = findEl(elements, ['Wx']);
                const minT = findEl(elements, ['MinT']); 
                const maxT = findEl(elements, ['MaxT']);
                const pop = findEl(elements, ['PoP']);

                // æª¢æŸ¥æ˜¯å¦æŠ“åˆ°è³‡æ–™
                if (!wx || !minT || !wx.time || wx.time.length === 0) {
                     console.log("Missing elements:", {wx, minT});
                     grid.innerHTML = '<div class="status-msg"><i class="fas fa-exclamation-triangle"></i> æ‰¾ä¸åˆ°è©³ç´°å¤©æ°£å…ƒç´  (å¯èƒ½æ˜¯æ¬„ä½åç¨±ä¸åŒ¹é…)</div>';
                     return;
                }
                
                // éæ­·æ™‚é–“æ®µ
                for(let i=0; i < wx.time.length; i++) {
                    const timeItem = wx.time[i];
                    
                    const startTime = timeItem.startTime || timeItem.dataTime;
                    const endTime = timeItem.endTime;
                    
                    const weatherDesc = getValue(timeItem);
                    const valMinT = getValue(minT.time[i]);
                    const valMaxT = maxT ? getValue(maxT.time[i]) : valMinT;
                    const valPoP = pop ? getValue(pop.time[i]) : null;

                    // è‹¥æ•¸æ“šç„¡æ•ˆï¼Œè·³é
                    if (valMinT === '--') continue;

                    html += this.createCardHTML(startTime, endTime, weatherDesc, valMinT, valMaxT, valPoP);
                }
                
                grid.innerHTML = html || '<div class="status-msg">ç„¡æœ‰æ•ˆé å ±è³‡æ–™</div>';
                document.getElementById('lastUpdate').textContent = `æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`;
            },

            createCardHTML(startTimeStr, endTimeStr, weather, minT, maxT, pop) {
                const start = new Date(startTimeStr);
                const dateStr = `${start.getMonth()+1}/${start.getDate()}`;
                const dayName = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'][start.getDay()];
                
                // ç°¡å–®çš„åœ–ç¤ºåˆ¤æ–·
                let icon = '<i class="fas fa-cloud"></i>';
                if (weather.includes('æ™´')) icon = '<i class="fas fa-sun" style="color:orange"></i>';
                if (weather.includes('å¤šé›²')) icon = '<i class="fas fa-cloud-sun" style="color:#f9a825"></i>';
                if (weather.includes('é™°')) icon = '<i class="fas fa-cloud" style="color:#90a4ae"></i>';
                if (weather.includes('é›¨')) icon = '<i class="fas fa-cloud-showers-heavy" style="color:#42a5f5"></i>';
                
                let timeDesc = dayName;
                let isNight = false;
                
                // æ™‚é–“æè¿°è™•ç†
                if (endTimeStr) {
                    const end = new Date(endTimeStr);
                    const h1 = start.getHours();
                    const h2 = end.getHours();
                    
                    // åˆ¤æ–·æ˜¯å¦ç‚ºæ™šä¸Š (18é»ä»¥å¾Œ æˆ– 6é»ä»¥å‰)
                    if (h1 >= 18 || h1 < 6) isNight = true;
                    
                    timeDesc = `${dayName} <span style="font-size:0.85em">${h1}:00 - ${h2}:00</span>`;
                }

                // é™é›¨æ©Ÿç‡è™•ç†
                let popHtml = '<div style="height:24px;"></div>';
                if (pop && pop !== '--' && pop !== ' ') {
                    popHtml = `<div class="card-rain"><i class="fas fa-umbrella"></i> ${pop}%</div>`;
                }

                // æº«åº¦é¡¯ç¤º
                let tempHtml = `<div class="card-temp">${minT}Â° - ${maxT}Â°</div>`;
                if (minT === maxT) {
                    tempHtml = `<div class="card-temp">${minT}Â°</div>`;
                }

                return `
                    <div class="card ${isNight ? 'is-night' : ''}">
                        <div>
                            <div class="card-date">${dateStr}</div>
                            <div class="card-time">${timeDesc}</div>
                            <div class="card-icon">${icon}</div>
                            <div class="card-desc">${weather}</div>
                        </div>
                        <div>
                            ${tempHtml}
                            ${popHtml}
                        </div>
                    </div>
                `;
            }
        };

        /**
         * DataParser: çµæ§‹è§£æå™¨ (å¼·åŒ–ç‰ˆ)
         * å°ˆé–€è™•ç† CWA API å„ç¨®å¥‡æ€ªçš„åµŒå¥—çµæ§‹
         */
        const DataParser = {
            parse(json) {
                let rawLocations = null;
                
                // 1. è™•ç† Datastore API çµæ§‹
                if (json?.records) {
                    // ä¸€èˆ¬çµæ§‹
                    if (json.records.location) {
                        rawLocations = json.records.location;
                    }
                    // ç¸£å¸‚é„‰é®çµæ§‹ (F-D0047 ç³»åˆ—é€šå¸¸åœ¨é€™è£¡)
                    else if (json.records.Locations && Array.isArray(json.records.Locations)) {
                        // æœ‰äº›å›å‚³æœƒæœ‰å¤šå€‹ Locations (ä¾‹å¦‚åˆ†å°ç£ã€é›¢å³¶)ï¼Œæˆ‘å€‘é€™è£¡ç°¡å–®å–ç¬¬ä¸€å€‹æˆ–åˆä½µ
                        // é€šå¸¸ Locations[0].Location å°±æ˜¯æˆ‘å€‘è¦çš„åˆ—è¡¨
                        const set1 = json.records.Locations[0].Location || json.records.Locations[0].location;
                        rawLocations = set1;
                    }
                }
                
                // 2. è™•ç† File API çµæ§‹ (cwaopendata)
                if (!rawLocations && json?.cwaopendata?.dataset) {
                    if (json.cwaopendata.dataset.location) {
                        rawLocations = json.cwaopendata.dataset.location;
                    }
                }
                
                if (!rawLocations) return [];
                if (!Array.isArray(rawLocations)) rawLocations = [rawLocations];

                // 3. çµ±ä¸€è½‰æ›
                return rawLocations.map(loc => {
                    return {
                        name: loc.locationName || loc.LocationName,
                        rawElements: loc.weatherElement || loc.WeatherElement
                    };
                });
            }
        };

        // å•Ÿå‹•
        App.init();
    </script>
</body>
</html>