<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THSR PIDS V5 (Debug Mode)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        /* === V5.0 強制對齊版樣式 === */
        * { box-sizing: border-box; }
        body, html {
            background-color: #000;
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Arial', 'Microsoft JhengHei', sans-serif;
            overflow: hidden;
            color: #fff;
        }
        #app { display: flex; flex-direction: column; height: 100%; }

        /* 分割畫面 */
        .board-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid #333;
            overflow: hidden;
        }

        /* 標題列 */
        .header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-weight: 900;
            font-size: 2.5rem;
            text-transform: uppercase;
        }
        .header.north { background-color: #D50000; color: #fff; } /* 北上紅 */
        .header.south { background-color: #009933; color: #fff; } /* 南下綠 */
        .clock { font-family: 'Consolas', monospace; }

        /* === Grid 排版系統 (保證對齊) === */
        /* 定義 7 個欄位的寬度比例 */
        .grid-row {
            display: grid;
            grid-template-columns: 10% 12% 12% 8% 18% 12% 28%; 
            align-items: center;
            padding-left: 20px;
        }

        /* 表頭 */
        .thead {
            background-color: #111;
            height: 45px;
            font-size: 1.2rem;
            color: #ccc;
            border-bottom: 1px solid #444;
        }
        
        /* 資料列 */
        .data-list { flex: 1; overflow: hidden; }
        .data-row {
            height: 25%; /* 4行填滿 */
            border-bottom: 1px solid #222;
            font-weight: bold;
            font-size: 2.2rem;
            white-space: nowrap;
        }

        /* 欄位樣式調整 */
        .col-plat { text-align: center; }
        .col-dest { letter-spacing: 5px; font-size: 2.6rem; }
        
        /* 北上配色 */
        .north-section .col-dest { color: #FFCC00; } /* 橘黃 */
        .north-section .status-ok { color: #FFFF00; }
        .north-section .dot.active { background-color: #FFCC00; box-shadow: 0 0 10px #FFCC00; border-color: #fff; }

        /* 南下配色 */
        .south-section .col-dest { color: #00FF00; } /* 亮綠 */
        .south-section .status-ok { color: #FFFF00; }
        .south-section .dot.active { background-color: #00FF00; box-shadow: 0 0 10px #00FF00; border-color: #fff; }

        /* 地圖微調 */
        .map-container { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: space-between; padding-right: 20px; }
        .map-line { position: absolute; width: 95%; height: 4px; background: #444; top: 50%; transform: translateY(-50%); z-index: 0; }
        .dot-wrapper { z-index: 1; display: flex; flex-direction: column; align-items: center; }
        .dot { width: 14px; height: 14px; border-radius: 50%; background: #000; border: 2px solid #555; margin-bottom: 4px; }
        .dot-code { font-size: 0.8rem; color: #666; font-family: 'Consolas', sans-serif; }
        .dot.active + .dot-code { color: #fff; font-weight: bold; }

        /* === Debug 區塊 (關鍵) === */
        .debug-bar {
            background-color: #330000;
            color: #ffcccc;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            padding: 5px 10px;
            border-top: 2px solid red;
            height: 60px;
            overflow: hidden;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>

<div id="app">

    <div class="board-section north-section">
        <div class="header north">
            <div>北上 NORTHBOUND</div>
            <div class="clock">{{ currentTime }}</div>
        </div>
        <div class="grid-row thead">
            <div>車次 Train</div>
            <div>開往 Dest.</div>
            <div>時間 Time</div>
            <div class="col-plat">月台 Plat.</div>
            <div>自由座 Non-Reserved</div>
            <div>狀態 Status</div>
            <div>停靠站 Stopping Stations</div>
        </div>
        <div class="data-list">
            <div v-for="t in northboundList" :key="t.uid" class="grid-row data-row">
                <div style="font-family: Consolas;">{{ t.displayTrainNo }}</div>
                <div class="col-dest">{{ t.destinationName }}</div>
                <div style="font-family: Consolas;">{{ t.displayTime }}</div>
                <div class="col-plat" style="font-family: Consolas;">{{ t.platform }}</div>
                <div style="font-size: 1.6rem;">Car {{ t.freeCars }}</div>
                <div class="status-ok">準點 On Time</div>
                <div class="col-map">
                    <div class="map-container">
                        <div class="map-line"></div>
                        <div v-for="s in stationsReversed" :key="s.id" class="dot-wrapper">
                            <div class="dot" :class="{ 'active': t.stops.includes(s.id) }"></div>
                            <span class="dot-code">{{ s.code }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="board-section south-section">
        <div class="header south">
            <div>南下 SOUTHBOUND</div>
            <div class="clock">{{ currentStationName }} {{ currentStationCode }}</div>
        </div>
        <div class="grid-row thead">
            <div>車次 Train</div>
            <div>開往 Dest.</div>
            <div>時間 Time</div>
            <div class="col-plat">月台 Plat.</div>
            <div>自由座 Non-Reserved</div>
            <div>狀態 Status</div>
            <div>停靠站 Stopping Stations</div>
        </div>
        <div class="data-list">
            <div v-for="t in southboundList" :key="t.uid" class="grid-row data-row">
                <div style="font-family: Consolas;">{{ t.displayTrainNo }}</div>
                <div class="col-dest">{{ t.destinationName }}</div>
                <div style="font-family: Consolas;">{{ t.displayTime }}</div>
                <div class="col-plat" style="font-family: Consolas;">{{ t.platform }}</div>
                <div style="font-size: 1.6rem;">Car {{ t.freeCars }}</div>
                <div class="status-ok">準點 On Time</div>
                <div class="col-map">
                    <div class="map-container">
                        <div class="map-line"></div>
                        <div v-for="s in stationsNormal" :key="s.id" class="dot-wrapper">
                            <div class="dot" :class="{ 'active': t.stops.includes(s.id) }"></div>
                            <span class="dot-code">{{ s.code }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="debug-bar">
        [DEBUG] 當前站點: {{ currentStationName }} (ID: {{ stationID }}, Index: {{ currentStationIndex }}) | 抓到資料筆數: {{ rawTrains.length }}
        <br>
        [RAW DATA SAMPLE] {{ debugRawData }}
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // === 設定區 ===
            const API_URL = "https://thsr-proxy.xiaoyouwu5-fd3.workers.dev";
            // 預設台北 (1000)
            const urlParams = new URLSearchParams(window.location.search);
            const stationID = ref(urlParams.get('station') || "1000"); 

            const rawTrains = ref([]);
            const currentTime = ref("00:00:00");
            const debugRawData = ref("Waiting for data...");

            // 站點定義 (ID 必須是字串以防比對錯誤)
            const stations = [
                { id: "0990", name: "南港", code: "NAK" },
                { id: "1000", name: "台北", code: "TPE" },
                { id: "1010", name: "板橋", code: "BAC" },
                { id: "1020", name: "桃園", code: "TAY" },
                { id: "1030", name: "新竹", code: "HSC" },
                { id: "1035", name: "苗栗", code: "MIL" },
                { id: "1040", name: "台中", code: "TAC" },
                { id: "1043", name: "彰化", code: "CHA" },
                { id: "1047", name: "雲林", code: "YUL" },
                { id: "1050", name: "嘉義", code: "CHY" },
                { id: "1060", name: "台南", code: "TNN" },
                { id: "1070", name: "左營", code: "ZUY" }
            ];

            const currentStationObj = computed(() => stations.find(s => s.id === stationID.value));
            const currentStationName = computed(() => currentStationObj.value ? currentStationObj.value.name : "未知站點");
            const currentStationCode = computed(() => currentStationObj.value ? currentStationObj.value.code : "ERR");
            const currentStationIndex = computed(() => stations.findIndex(s => s.id === stationID.value));

            // 輔助：遞迴找 Key (專門對付藏很深的欄位)
            const findValue = (obj, keyPart) => {
                if(!obj) return null;
                if(typeof obj !== 'object') return null;
                // 1. 直接找
                for(let k in obj) {
                    if(k.toLowerCase().includes(keyPart)) return obj[k];
                }
                // 2. 進第一層子物件找
                for(let k in obj) {
                    if(typeof obj[k] === 'object') {
                        for(let subK in obj[k]) {
                            if(subK.toLowerCase().includes(keyPart)) return obj[k][subK];
                        }
                    }
                }
                return null;
            };

            const processedTrains = computed(() => {
                const now = new Date();
                const nowStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
                const curIdx = currentStationIndex.value;

                return rawTrains.value.map((t, idx) => {
                    // === 1. 暴力抓車次 (UNK 修復) ===
                    // 優先順序：直接欄位 -> 遞迴搜尋 -> 隨便抓個數字 -> 真的沒有
                    let tNo = t.TrainNo || t.train_no || t.trainNo || findValue(t, 'trainno') || "UNK";
                    
                    // === 2. 暴力抓時間 ===
                    let tTime = t.DepartureTime || t.departure_time || t.time || findValue(t, 'time') || "00:00";
                    if(typeof tTime === 'string' && tTime.length > 5) tTime = tTime.substring(0, 5);

                    // === 3. 抓目的地 ===
                    let destRaw = t.DestinationStationName || t.destination || t.EndingStationName;
                    let destName = "未知";
                    if(typeof destRaw === 'object') destName = destRaw.Zh_tw || destRaw.zh || destRaw.name;
                    else if(typeof destRaw === 'string') destName = destRaw;
                    
                    // 修正常見名稱差異 (南港站 -> 南港)
                    destName = destName.replace('站', '');

                    // === 4. 方向判斷邏輯 (修復南下列車跑去北上的問題) ===
                    let dir = 0; // 預設南下
                    
                    // 找出目的地的 index
                    let destIdx = stations.findIndex(s => s.name === destName);

                    if (curIdx === -1) {
                        // 如果找不到當前站點，可能 stationID 錯了，暫時用 API 的 direction
                        let apiDir = findValue(t, 'direction');
                        if(apiDir !== null) dir = parseInt(apiDir);
                    } else if (destIdx !== -1) {
                        // 正常邏輯：比較 Index
                        if (destIdx < curIdx) dir = 1; // 往北 (目的地在當前站上方)
                        else dir = 0; // 往南
                    } else {
                        // 找不到目的地 Index (例如回廠車)，回退 API
                        let apiDir = findValue(t, 'direction');
                        if(apiDir !== null) dir = parseInt(apiDir);
                    }

                    return {
                        uid: idx,
                        displayTrainNo: tNo,
                        displayTime: tTime,
                        destinationName: destName,
                        platform: t.Platform || t.platform || "2",
                        freeCars: "10-12",
                        stops: t.stopping_stations || [], // 停靠站 ID 陣列
                        direction: dir // 0=南下, 1=北上
                    };
                })
                .filter(t => t.displayTime >= nowStr)
                .sort((a, b) => a.displayTime.localeCompare(b.displayTime));
            });

            const northboundList = computed(() => processedTrains.value.filter(t => t.direction === 1).slice(0, 4));
            const southboundList = computed(() => processedTrains.value.filter(t => t.direction === 0).slice(0, 4));

            const fetchData = async () => {
                try {
                    const res = await fetch(`${API_URL}/?station=${stationID.value}`);
                    const json = await res.json();
                    
                    // 處理各種 API 回傳結構
                    let list = [];
                    if(Array.isArray(json)) list = json;
                    else if(json.trains) list = json.trains;
                    else if(json.data) list = json.data;
                    
                    rawTrains.value = list;

                    // DEBUG: 抓第一筆資料顯示在紅框框
                    if(list.length > 0) {
                        debugRawData.value = JSON.stringify(list[0]);
                    } else {
                        debugRawData.value = "API 回傳空陣列 []";
                    }

                } catch (e) {
                    console.error(e);
                    debugRawData.value = "Fetch Error: " + e.message;
                }
            };

            setInterval(() => {
                const now = new Date();
                currentTime.value = now.toLocaleTimeString('en-US', { hour12: false });
            }, 1000);
            
            setInterval(fetchData, 30000); // 30秒更新

            onMounted(() => {
                fetchData();
            });

            return {
                stationID, currentStationName, currentStationCode, currentStationIndex, currentTime,
                northboundList, southboundList,
                stationsNormal: stations, 
                stationsReversed: [...stations].reverse(),
                rawTrains, debugRawData
            };
        }
    }).mount('#app');
</script>
</body>
</html>