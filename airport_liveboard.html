<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣機場航班動態</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === 基礎變數與設定 === */
        :root {
            --primary-color: #0056b3; /* 航空藍 */
            --primary-gradient: linear-gradient(135deg, #0056b3 0%, #003d80 100%);
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            
            --status-green: #28a745;
            --status-red: #dc3545;
            --status-yellow: #ffc107;
            --status-gray: #6c757d;
        }

        body.dark-mode {
            --primary-color: #375a7f;
            --primary-gradient: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #aaa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }

        /* === Header === */
        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-theme {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* === 控制面板 === */
        .control-panel {
            background: var(--card-bg);
            padding: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .airport-selector {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 12px;
            background-color: var(--bg-color);
            color: var(--text-main);
            outline: none;
            font-weight: bold;
        }
        body.dark-mode .airport-selector { border-color: #444; }

        /* === 頁籤 (Tabs) === */
        .tabs {
            display: flex;
            background: var(--card-bg);
            padding: 0 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 15px 0;
            border: none;
            background: transparent;
            color: var(--text-sub);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .tab-btn.active {
            color: var(--primary-color);
        }
        body.dark-mode .tab-btn.active { color: #4fa3ff; }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            width: 60%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }
        body.dark-mode .tab-btn.active::after { background-color: #4fa3ff; }

        /* === 列表區域 === */
        .flight-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* 航班卡片 */
        .flight-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 5px solid transparent;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s;
        }
        
        /* 狀態顏色邊框 */
        .flight-card.status-ontime { border-left-color: var(--status-green); }
        .flight-card.status-delayed { border-left-color: var(--status-red); }
        .flight-card.status-boarding { border-left-color: var(--status-yellow); }
        .flight-card.status-arrived, .flight-card.status-departed { border-left-color: var(--status-gray); }

        /* 左側：時間 */
        .col-time {
            text-align: center;
            min-width: 60px;
        }
        .time-main {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
        }
        .time-sub {
            font-size: 0.8rem;
            color: var(--text-sub);
            margin-top: 4px;
        }
        .time-delayed { color: var(--status-red); text-decoration: line-through; }
        .time-new { color: var(--status-red); font-weight: bold; }

        /* 中間：航班資訊 */
        .col-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .flight-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .airline-tag {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #eee;
            color: #555;
            font-weight: bold;
        }
        .flight-no {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        body.dark-mode .flight-no { color: #6db3ff; }

        .dest-row {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .dest-cn { font-size: 1.25rem; font-weight: bold; }
        .dest-en { font-size: 0.9rem; color: var(--text-sub); }

        /* 右側：狀態 */
        .col-status {
            text-align: right;
            min-width: 80px;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }
        .gate-info {
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        /* 狀態背景色 */
        .bg-ontime { background-color: var(--status-green); }
        .bg-delayed { background-color: var(--status-red); }
        .bg-boarding { background-color: var(--status-yellow); color: #333; }
        .bg-arrived, .bg-departed { background-color: var(--status-gray); }

        /* 載入中 */
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-sub);
        }
        .loading i { font-size: 2rem; margin-bottom: 10px; }

        /* 標籤 (國內/國際) */
        .route-type-tag {
            font-size: 0.7rem;
            padding: 1px 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            color: #888;
            margin-left: auto;
        }

        /* 手機適配微調 */
        @media (max-width: 480px) {
            .dest-en { display: none; } /* 手機版隱藏英文地名以防擁擠 */
            .flight-card { padding: 12px; gap: 10px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">
            <i class="fas fa-plane"></i> 航班動態 Liveboard
        </div>
        <button class="btn-theme" id="themeToggle">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <div class="control-panel">
        <select class="airport-selector" id="airportSelect" onchange="fetchData()">
            <optgroup label="北部 North">
                <option value="TSA" selected>臺北松山 TSA</option>
            </optgroup>
            <optgroup label="中部 Central">
                <option value="RMQ">臺中清泉崗 RMQ</option>
            </optgroup>
            <optgroup label="南部 South">
                <option value="KHH">高雄小港 KHH</option>
                <option value="TNN">臺南 TNN</option>
                <option value="CYI">嘉義 CYI</option>
            </optgroup>
            <optgroup label="東部 East">
                <option value="HUN">花蓮 HUN</option>
                <option value="TTT">臺東 TTT</option>
            </optgroup>
            <optgroup label="離島 Offshore Islands">
                <option value="MZG">澎湖 MZG</option>
                <option value="KNH">金門 KNH</option>
                <option value="LZN">馬祖南竿 LZN</option>
                <option value="MFK">馬祖北竿 MFK</option>
            </optgroup>
        </select>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('DEP')" id="tabDep">出發 Departures</button>
        <button class="tab-btn" onclick="switchTab('ARR')" id="tabArr">抵達 Arrivals</button>
    </div>

    <div class="flight-list" id="flightList">
        <!-- 內容由 JS 插入 -->
        <div class="loading">
            <i class="fas fa-circle-notch fa-spin"></i>
            <p>資料載入中...</p>
        </div>
    </div>

    <div style="text-align: center; padding: 10px; font-size: 0.8rem; color: #888;">
        資料來源：TDX | 更新時間：<span id="updateTime">--:--</span>
    </div>

    <script>
        // === 設定區 ===
        const WORKER_URL = "https://airport.xiaoyouwu5-fd3.workers.dev/"; 
        
        let currentData = null;
        let currentTab = 'DEP'; // 'DEP' or 'ARR'

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 深色模式
            const toggle = document.getElementById('themeToggle');
            toggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                toggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                localStorage.setItem('airport_theme', isDark ? 'dark' : 'light');
            });
            if(localStorage.getItem('airport_theme') === 'dark') {
                document.body.classList.add('dark-mode');
                toggle.innerHTML = '<i class="fas fa-sun"></i>';
            }

            // 載入資料
            fetchData();
        });

        async function fetchData() {
            const airport = document.getElementById('airportSelect').value;
            const list = document.getElementById('flightList');
            
            list.innerHTML = `
                <div class="loading">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <p>正在連線至 ${airport}...</p>
                </div>
            `;

            try {
                const res = await fetch(`${WORKER_URL}?airport=${airport}`);
                if(!res.ok) throw new Error("API Error");
                currentData = await res.json();
                
                // 更新時間
                const now = new Date();
                document.getElementById('updateTime').innerText = 
                    now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });

                renderList();

            } catch (e) {
                console.error(e);
                list.innerHTML = `<div class="loading" style="color:var(--status-red)"><i class="fas fa-exclamation-triangle"></i><p>無法取得資料，請稍後再試</p></div>`;
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            // 更新 Tab 樣式
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab === 'DEP' ? 'tabDep' : 'tabArr').classList.add('active');
            
            renderList();
        }

        function renderList() {
            if (!currentData) return;

            const list = document.getElementById('flightList');
            let flights = [];

            // 合併國內與國際線資料，統一顯示
            if (currentTab === 'DEP') {
                // 標記來源
                const dom = (currentData.DOMESTIC_DEPARTURES || []).map(f => ({...f, routeType: '國內'}));
                const int = (currentData.INTERNATIONAL_DEPARTURES || []).map(f => ({...f, routeType: '國際'}));
                flights = [...dom, ...int];
            } else {
                const dom = (currentData.DOMESTIC_ARRIVALS || []).map(f => ({...f, routeType: '國內'}));
                const int = (currentData.INTERNATIONAL_ARRIVALS || []).map(f => ({...f, routeType: '國際'}));
                flights = [...dom, ...int];
            }

            // 排序：依時間 (time)
            flights.sort((a, b) => a.time.localeCompare(b.time));

            if (flights.length === 0) {
                list.innerHTML = `<div class="loading"><i class="fas fa-plane-slash"></i><p>目前無航班資訊</p></div>`;
                return;
            }

            let html = '';
            flights.forEach(f => {
                // 處理目的地顯示 (分離中英文)
                let destName = f.dest;
                let destEn = "";
                // 簡單判斷：如果有空格，假設格式為 "Code Name" 或 "Name Name"
                // 這裡假設 Worker 回傳的是 "TPE 桃園 Taoyuan" 或 "Penghu" 格式
                // 為了保險，我們做簡單處理
                let destDisplay = f.dest;
                if (f.dest.match(/[a-zA-Z]/) && f.dest.match(/[\u4e00-\u9fa5]/)) {
                    // 同時有中文英文
                    destDisplay = f.dest; 
                }

                // 處理延誤時間顯示
                let timeHtml = `<div class="time-main">${f.time}</div>`;
                // 如果預計時間存在且不同於表定時間 (且不是取消)
                if (f.est && f.est !== f.time && !f.status.includes('取消') && !f.status.includes('準時') && f.est.includes(':')) {
                    timeHtml = `
                        <div class="time-main time-delayed" style="font-size:1rem; color:#999;">${f.time}</div>
                        <div class="time-main time-new">${f.est}</div>
                    `;
                }

                // 狀態樣式
                let badgeClass = "bg-ontime";
                if(f.type === 'delayed') badgeClass = "bg-delayed";
                if(f.type === 'boarding') badgeClass = "bg-boarding";
                if(f.type === 'arrived' || f.type === 'departed') badgeClass = "bg-arrived";

                // 狀態文字簡化 (移除英文，手機版空間有限)
                let statusText = f.status.split(' ')[0]; 
                if (f.status.includes("Check-in")) statusText = "報到中";

                html += `
                <div class="flight-card status-${f.type}">
                    <div class="col-time">
                        ${timeHtml}
                    </div>
                    <div class="col-info">
                        <div class="flight-row">
                            <span class="airline-tag">${f.airline}</span>
                            <span class="flight-no">${f.flight.split('-')[1] || f.flight}</span>
                            <span class="route-type-tag">${f.routeType}</span>
                        </div>
                        <div class="dest-row">
                            <span class="dest-cn">${destDisplay}</span>
                        </div>
                    </div>
                    <div class="col-status">
                        <span class="status-badge ${badgeClass}">${statusText}</span>
                        <div class="gate-info">
                            ${f.gate && f.gate !== '-' ? '<i class="fas fa-door-open"></i> '+f.gate : ''}
                        </div>
                    </div>
                </div>
                `;
            });

            list.innerHTML = html;
        }
    </script>
</body>
</html>
