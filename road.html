<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>省道監視器 - 即時路況監控</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>window.CURRENT_PAGE = 'road';</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', 'Noto Sans TC', Arial, sans-serif;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 50%, #FDB44B 100%);
            min-height: 100vh;
            padding-bottom: 40px;
        }

        /* 頁首區域 */
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            color: #FF6B35;
            text-align: center;
            font-size: 2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .header-subtitle {
            text-align: center;
            color: #666;
            font-size: 0.95rem;
            margin-top: 5px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* 返回按鈕 */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255,107,53,0.3);
        }

        .back-btn:hover {
            background: linear-gradient(135deg, #F7931E, #FF6B35);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,107,53,0.4);
        }

        /* 資訊面板 */
        .info-panel {
            background: linear-gradient(135deg, #fff8f0 0%, #ffe8d6 100%);
            border-left: 5px solid #FF6B35;
            padding: 20px 25px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .info-panel h3 {
            color: #E65100;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .info-panel h3 i {
            transition: transform 0.3s ease;
        }

        .info-content {
            color: #444;
            line-height: 1.8;
            display: none;
        }

        .info-content.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .info-links {
            margin: 15px 0;
            padding-left: 20px;
        }

        .info-links a {
            color: #FF6B35;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .info-links a:hover {
            color: #E65100;
            text-decoration: underline;
        }

        /* 篩選控制區 */
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .filter-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #FFE0B2;
            border-radius: 8px;
            font-size: 1rem;
            color: #333;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .filter-select:hover {
            border-color: #FF6B35;
        }

        .filter-select:focus {
            outline: none;
            border-color: #FF6B35;
            box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
        }

        .clear-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(255,107,53,0.3);
        }

        .clear-btn:hover {
            background: linear-gradient(135deg, #F7931E, #FF6B35);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,107,53,0.4);
        }

        /* 統計面板 */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-card:nth-child(1) .stat-value { color: #FF6B35; }
        .stat-card:nth-child(2) .stat-value { color: #4CAF50; }
        .stat-card:nth-child(3) .stat-value { color: #2196F3; }
        .stat-card:nth-child(4) .stat-value { color: #9C27B0; }
        .stat-card:nth-child(5) .stat-value { color: #795548; }

        /* 監視器網格 */
        .cameras-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        /* 監視器卡片 */
        .camera-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .camera-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .camera-image-container {
            position: relative;
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            overflow: hidden;
        }

        .camera-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .camera-card:hover .camera-image-container img {
            transform: scale(1.1);
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            color: white;
        }

        .camera-card:hover .image-overlay {
            opacity: 1;
        }

        .image-overlay i {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .no-image {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
        }

        .no-image i {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .source-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .badge-tdx {
            background: rgba(76,175,80,0.9);
        }

        .badge-backup {
            background: rgba(121,85,72,0.9);
        }

        .camera-info {
            padding: 15px;
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .camera-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FF6B35;
            margin: 0;
        }

        .camera-location {
            color: #FF6B35;
            font-weight: 600;
            font-size: 0.95rem;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-details {
            color: #666;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .camera-details p {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-details i {
            width: 16px;
            color: #999;
        }

        /* Modal 彈窗 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: relative;
            margin: 2% auto;
            width: 90%;
            max-width: 1200px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-close {
            position: absolute;
            top: -15px;
            right: 15px;
            font-size: 50px;
            color: white;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
            background: rgba(255,107,53,0.8);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .modal-close:hover {
            background: rgba(255,107,53,1);
            transform: rotate(90deg);
        }

        .modal-image {
            width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 12px;
            background: #000;
        }

        .modal-info {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .modal-info h2 {
            color: #FF6B35;
            margin-bottom: 15px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item i {
            color: #FF6B35;
            margin-top: 2px;
        }

        .info-item strong {
            color: #333;
            min-width: 80px;
        }

        .info-item span {
            color: #666;
        }

        .stream-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #FF6B35;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            background: #fff8f0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .stream-link:hover {
            background: #FF6B35;
            color: white;
            transform: translateX(5px);
        }

        /* 載入動畫 */
        .loading {
            text-align: center;
            padding: 80px 20px;
            color: white;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .filter-controls {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
                min-width: auto;
            }

            .cameras-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            .modal-info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 空狀態 */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: white;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 1rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- 頁首 -->
    <div class="header">
        <div class="header-content">
            <h1>
                <i class="fas fa-road"></i>
                省道監視器
                <i class="fas fa-video"></i>
            </h1>
            <p class="header-subtitle">即時省道路況監控 • 全台監視器一覽</p>
        </div>
    </div>

    <div class="container">
        <!-- 返回按鈕 -->
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            返回首頁
        </a>

        <!-- 資訊面板 -->
        <div class="info-panel">
            <h3 onclick="toggleInfo()">
                <span>
                    <i class="fas fa-info-circle"></i>
                    省道監視器資料說明
                </span>
                <i id="toggleIcon" class="fas fa-chevron-down"></i>
            </h3>
            <div id="infoContent" class="info-content">
                <p>本系統整合<strong>交通部 TDX 交通資料流通服務平台</strong>與<strong>公路總局</strong>資料，提供全台省道及主要道路監視器即時影像。</p>
                
                <div class="info-links">
                    <p>
                        <i class="fas fa-link"></i>
                        <a href="https://tdx.transportdata.tw" target="_blank">TDX 交通資料流通服務平台 <i class="fas fa-external-link-alt"></i></a>
                    </p>
                    <p>
                        <i class="fas fa-link"></i>
                        <a href="https://thb.gov.tw" target="_blank">交通部公路總局 <i class="fas fa-external-link-alt"></i></a>
                    </p>
                </div>
                
                <p style="font-size: 0.9rem; color: #666; font-style: italic; margin-top: 15px;">
                    <i class="fas fa-check-circle"></i>
                    系統採用雙重資料源，確保監視器資訊的完整性與即時性。
                </p>
            </div>
        </div>

        <!-- 篩選控制 -->
        <div class="filter-section">
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="roadSelect">
                        <i class="fas fa-road"></i> 選擇路線
                    </label>
                    <select id="roadSelect" class="filter-select" onchange="applyFilters()">
                        <option value="">全部路線</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="citySelect">
                        <i class="fas fa-map-marker-alt"></i> 選擇縣市
                    </label>
                    <select id="citySelect" class="filter-select" onchange="applyFilters()">
                        <option value="">全部縣市</option>
                    </select>
                </div>
                <button class="clear-btn" onclick="clearFilters()">
                    <i class="fas fa-sync-alt"></i>
                    清除篩選
                </button>
            </div>
        </div>

        <!-- 統計面板 -->
        <div class="stats-panel">
            <div class="stat-card">
                <div id="totalCount" class="stat-value">0</div>
                <div class="stat-label">總監視器</div>
            </div>
            <div class="stat-card">
                <div id="filteredCount" class="stat-value">0</div>
                <div class="stat-label">篩選結果</div>
            </div>
            <div class="stat-card">
                <div id="roadCount" class="stat-value">0</div>
                <div class="stat-label">涵蓋路線</div>
            </div>
            <div class="stat-card">
                <div id="cityCount" class="stat-value">0</div>
                <div class="stat-label">涵蓋縣市</div>
            </div>
            <div class="stat-card">
                <div id="dataSourceInfo" class="stat-value" style="font-size: 0.9rem; color: #666;">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">資料來源</div>
            </div>
        </div>

        <!-- 監視器容器 -->
        <div id="camerasContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">載入監視器資料中...</div>
            </div>
        </div>
    </div>

    <!-- Modal 彈窗 -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-close" onclick="closeModal()">&times;</div>
            <img id="modalImage" class="modal-image" src="" alt="監視器影像">
            <div class="modal-info">
                <h2 id="modalTitle">
                    <i class="fas fa-video"></i>
                    監視器詳細資訊
                </h2>
                <div id="modalDetails" class="modal-info-grid"></div>
            </div>
        </div>
    </div>

    <script src="navbar.js"></script>
    <script src="config.js"></script>
    <script src="tdx-api.js"></script>
    <script>
        let allCameras = [];
        let currentFilters = {
            road: '',
            city: ''
        };

        // 切換資訊面板
        function toggleInfo() {
            const content = document.getElementById('infoContent');
            const icon = document.getElementById('toggleIcon');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('show');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        // 根據經緯度判斷縣市
        function getCityFromCoordinates(lon, lat) {
            if (!lon || !lat) return '未知';
            
            const cityRanges = [
                { name: '台北市', lonMin: 121.45, lonMax: 121.65, latMin: 24.95, latMax: 25.20 },
                { name: '基隆市', lonMin: 121.65, lonMax: 121.85, latMin: 25.10, latMax: 25.25 },
                { name: '新北市', lonMin: 121.30, lonMax: 121.80, latMin: 24.60, latMax: 25.30 },
                { name: '桃園市', lonMin: 121.00, lonMax: 121.50, latMin: 24.80, latMax: 25.10 },
                { name: '新竹市', lonMin: 120.90, lonMax: 121.05, latMin: 24.75, latMax: 24.85 },
                { name: '新竹縣', lonMin: 120.70, lonMax: 121.30, latMin: 24.50, latMax: 25.00 },
                { name: '苗栗縣', lonMin: 120.60, lonMax: 121.20, latMin: 24.20, latMax: 24.80 },
                { name: '台中市', lonMin: 120.50, lonMax: 121.20, latMin: 24.00, latMax: 24.50 },
                { name: '彰化縣', lonMin: 120.40, lonMax: 120.80, latMin: 23.80, latMax: 24.20 },
                { name: '南投縣', lonMin: 120.60, lonMax: 121.30, latMin: 23.50, latMax: 24.20 },
                { name: '雲林縣', lonMin: 120.20, lonMax: 120.70, latMin: 23.50, latMax: 23.90 },
                { name: '嘉義市', lonMin: 120.40, lonMax: 120.50, latMin: 23.45, latMax: 23.52 },
                { name: '嘉義縣', lonMin: 120.10, lonMax: 120.80, latMin: 23.30, latMax: 23.70 },
                { name: '台南市', lonMin: 120.00, lonMax: 120.50, latMin: 22.90, latMax: 23.40 },
                { name: '高雄市', lonMin: 120.20, lonMax: 120.50, latMin: 22.50, latMax: 23.10 },
                { name: '屏東縣', lonMin: 120.40, lonMax: 120.90, latMin: 22.00, latMax: 22.80 },
                { name: '宜蘭縣', lonMin: 121.50, lonMax: 122.10, latMin: 24.50, latMax: 25.05 },
                { name: '花蓮縣', lonMin: 121.30, lonMax: 121.80, latMin: 23.30, latMax: 24.50 },
                { name: '台東縣', lonMin: 120.90, lonMax: 121.50, latMin: 22.30, latMax: 23.50 }
            ];
            
            for (const city of cityRanges) {
                if (lon >= city.lonMin && lon <= city.lonMax && lat >= city.latMin && lat <= city.latMax) {
                    return city.name;
                }
            }
            
            return '其他地區';
        }

        // 提取路線編號
        function getRoadNumber(roadName) {
            if (!roadName) return '未知';
            // 如果有空格，只取空格前的部分
            if (roadName.includes(' ')) {
                return roadName.split(' ')[0];
            }
            // 嘗試匹配台XX線格式
            const match = roadName.match(/台\d+[甲乙丙丁]?線/);
            if (match) {
                return match[0];
            }
            return roadName;
        }

        // 解析 XML 資料
        async function parseXMLCameras(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            const cameras = [];
            const items = xmlDoc.querySelectorAll('CCTV');
            
            items.forEach(item => {
                const camera = {
                    CCTVID: item.querySelector('cctvid')?.textContent || '',
                    RoadName: item.querySelector('roadname')?.textContent || '',
                    SurveillanceDescription: item.querySelector('roadname')?.textContent || '',
                    PositionLon: parseFloat(item.querySelector('px')?.textContent) || 0,
                    PositionLat: parseFloat(item.querySelector('py')?.textContent) || 0,
                    VideoStreamURL: item.querySelector('videourl')?.textContent || '',
                    VideoImageURL: item.querySelector('picurl')?.textContent || '',
                    LocationMile: item.querySelector('locationmile')?.textContent || '',
                    source: 'backup'
                };
                
                if (camera.CCTVID) {
                    cameras.push(camera);
                }
            });
            
            return cameras;
        }

        // 載入監視器資料
        async function loadCameras() {
            const container = document.getElementById('camerasContainer');
            let allCamerasFromSources = [];
            
            try {
                // 載入 TDX API
                console.log('載入 TDX API...');
                const response = await tdxApi.fetchCCTV('/v2/Road/Traffic/CCTV/Provincial?$format=JSON');
                
                let cameras = [];
                if (response && response.CCTVs && Array.isArray(response.CCTVs)) {
                    cameras = response.CCTVs.map(camera => ({...camera, source: 'tdx'}));
                } else if (Array.isArray(response)) {
                    cameras = response.map(camera => ({...camera, source: 'tdx'}));
                }
                
                if (cameras.length > 0) {
                    allCamerasFromSources = cameras;
                    console.log(`TDX API 載入成功: ${cameras.length} 筆資料`);
                }
            } catch (error) {
                console.warn('TDX API 載入失敗:', error.message);
            }
            
            try {
                // 載入備援 XML API
                console.log('載入備援 XML API...');
                const xmlResponse = await fetch('https://cctv-maintain.thb.gov.tw/opendataCCTVs.xml');
                
                if (xmlResponse.ok) {
                    const xmlText = await xmlResponse.text();
                    const xmlCameras = await parseXMLCameras(xmlText);
                    
                    if (xmlCameras.length > 0) {
                        allCamerasFromSources = [...allCamerasFromSources, ...xmlCameras];
                        console.log(`備援 XML API 載入成功: ${xmlCameras.length} 筆資料`);
                    }
                }
            } catch (error) {
                console.warn('備援 XML API 載入失敗:', error.message);
            }
            
            if (allCamerasFromSources.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>無法載入資料</h3>
                        <p>請檢查網路連線或稍後再試</p>
                    </div>
                `;
                return;
            }
            
            // 資料去重並添加縣市資訊
            const uniqueCameras = {};
            allCamerasFromSources.forEach(camera => {
                const id = camera.CCTVID || camera.cctvid || `${camera.PositionLon}_${camera.PositionLat}`;
                if (!uniqueCameras[id] || camera.source === 'tdx') {
                    uniqueCameras[id] = {
                        ...camera,
                        City: getCityFromCoordinates(camera.PositionLon, camera.PositionLat),
                        RoadNumber: getRoadNumber(camera.RoadName)
                    };
                }
            });
            
            allCameras = Object.values(uniqueCameras);
            console.log(`處理後總計: ${allCameras.length} 筆監視器`);
            
            populateFilters();
            updateStats();
            displayCameras(allCameras);
        }

        // 填充篩選選單
        function populateFilters() {
            // 路線選單
            const roads = [...new Set(allCameras.map(c => c.RoadNumber).filter(Boolean))].sort();
            const roadSelect = document.getElementById('roadSelect');
            roadSelect.innerHTML = '<option value="">全部路線</option>' + 
                roads.map(road => `<option value="${road}">${road}</option>`).join('');
            
            // 縣市選單
            const cities = [...new Set(allCameras.map(c => c.City).filter(Boolean))].sort();
            const citySelect = document.getElementById('citySelect');
            citySelect.innerHTML = '<option value="">全部縣市</option>' + 
                cities.map(city => `<option value="${city}">${city}</option>`).join('');
        }

        // 更新統計資訊
        function updateStats() {
            const filtered = getFilteredCameras();
            const roads = [...new Set(filtered.map(c => c.RoadNumber).filter(Boolean))];
            const cities = [...new Set(filtered.map(c => c.City).filter(Boolean))];
            const tdxCount = allCameras.filter(c => c.source === 'tdx').length;
            const backupCount = allCameras.filter(c => c.source === 'backup').length;
            
            document.getElementById('totalCount').textContent = allCameras.length;
            document.getElementById('filteredCount').textContent = filtered.length;
            document.getElementById('roadCount').textContent = roads.length;
            document.getElementById('cityCount').textContent = cities.length;
            
            const dataSourceInfo = document.getElementById('dataSourceInfo');
            if (tdxCount > 0) {
                dataSourceInfo.innerHTML = `<i class="fas fa-check-circle" style="color: #4CAF50;"></i> TDX: ${tdxCount}`;
            } else {
                dataSourceInfo.innerHTML = `<i class="fas fa-database" style="color: #795548;"></i> 備援: ${backupCount}`;
            }
        }

        // 獲取篩選後的監視器
        function getFilteredCameras() {
            let filtered = allCameras;
            
            if (currentFilters.road) {
                filtered = filtered.filter(c => c.RoadNumber === currentFilters.road);
            }
            if (currentFilters.city) {
                filtered = filtered.filter(c => c.City === currentFilters.city);
            }
            
            return filtered;
        }

        // 應用篩選
        function applyFilters() {
            currentFilters.road = document.getElementById('roadSelect').value;
            currentFilters.city = document.getElementById('citySelect').value;
            
            const filtered = getFilteredCameras();
            updateStats();
            displayCameras(filtered);
        }

        // 清除篩選
        function clearFilters() {
            document.getElementById('roadSelect').value = '';
            document.getElementById('citySelect').value = '';
            currentFilters = { road: '', city: '' };
            
            updateStats();
            displayCameras(allCameras);
        }

        // 顯示監視器
        function displayCameras(cameras) {
            const container = document.getElementById('camerasContainer');
            
            if (cameras.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>無符合條件的監視器</h3>
                        <p>請調整篩選條件後重試</p>
                    </div>
                `;
                return;
            }
            
            const displayCameras = cameras.slice(0, 100);
            const html = displayCameras.map(camera => {
                const sourceBadgeClass = camera.source === 'tdx' ? 'badge-tdx' : 'badge-backup';
                const sourceLabel = camera.source === 'tdx' ? 'TDX' : '備援';
                
                return `
                    <div class="camera-card" onclick="showModal('${camera.CCTVID}')">
                        <div class="camera-image-container">
                            ${camera.VideoImageURL ? 
                                `<img src="${camera.VideoImageURL}" alt="${camera.RoadNumber}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'no-image\\'><i class=\\'fas fa-exclamation-triangle\\'></i><span>影像載入失敗</span></div>'">
                                 <div class="image-overlay">
                                    <i class="fas fa-search-plus"></i>
                                    <span>點擊查看詳細資訊</span>
                                 </div>` :
                                `<div class="no-image">
                                    <i class="fas fa-video-slash"></i>
                                    <span>無影像資料</span>
                                 </div>`
                            }
                            <div class="source-badge ${sourceBadgeClass}">${sourceLabel}</div>
                        </div>
                        <div class="camera-info">
                            <h3 class="camera-title">${camera.RoadNumber}</h3>
                            <div class="camera-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${camera.City} - ${camera.LocationMile || camera.SurveillanceDescription || '監視器'}</span>
                            </div>
                            <div class="camera-details">
                                ${camera.SurveillanceDescription ? `<p><i class="fas fa-info-circle"></i>${camera.SurveillanceDescription}</p>` : ''}
                                <p><i class="fas fa-compass"></i>經度 ${camera.PositionLon.toFixed(4)}, 緯度 ${camera.PositionLat.toFixed(4)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            let resultText = cameras.length > 100 ? 
                `顯示前 100 筆結果（共 ${cameras.length} 筆）` : 
                `顯示 ${cameras.length} 筆結果`;
            
            container.innerHTML = `
                <div style="text-align: center; margin: 20px 0; color: white; font-size: 1.1rem; font-weight: 500;">
                    <i class="fas fa-camera"></i> ${resultText}
                </div>
                <div class="cameras-grid">${html}</div>
            `;
        }

        // 顯示 Modal
        function showModal(cctvId) {
            const camera = allCameras.find(c => c.CCTVID === cctvId);
            if (!camera) return;
            
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalTitle');
            const modalDetails = document.getElementById('modalDetails');
            
            modalTitle.innerHTML = `<i class="fas fa-video"></i> ${camera.RoadNumber} - ${camera.City}`;
            
            if (camera.VideoImageURL) {
                modalImage.src = camera.VideoImageURL;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }
            
            const sourceLabel = camera.source === 'tdx' ? 'TDX API' : '備援 XML API';
            const sourceColor = camera.source === 'tdx' ? '#4CAF50' : '#795548';
            
            modalDetails.innerHTML = `
                <div class="info-item">
                    <i class="fas fa-id-card"></i>
                    <div>
                        <strong>監視器 ID：</strong>
                        <span>${camera.CCTVID}</span>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-road"></i>
                    <div>
                        <strong>路線：</strong>
                        <span>${camera.RoadName || camera.RoadNumber}</span>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <div>
                        <strong>位置：</strong>
                        <span>${camera.City} ${camera.LocationMile || ''}</span>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>說明：</strong>
                        <span>${camera.SurveillanceDescription || '無'}</span>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-crosshairs"></i>
                    <div>
                        <strong>座標：</strong>
                        <span>經度 ${camera.PositionLon}, 緯度 ${camera.PositionLat}</span>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-database"></i>
                    <div>
                        <strong>資料來源：</strong>
                        <span style="color: ${sourceColor}; font-weight: bold;">${sourceLabel}</span>
                    </div>
                </div>
                ${camera.VideoStreamURL ? `
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <i class="fas fa-video"></i>
                        <div style="width: 100%;">
                            <strong>影像串流：</strong>
                            <a href="${camera.VideoStreamURL}" target="_blank" class="stream-link">
                                開啟即時影像 <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    </div>
                ` : ''}
            `;
            
            modal.style.display = 'block';
        }

        // 關閉 Modal
        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // 鍵盤事件
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // 載入資料
        loadCameras();
    </script>
</body>
</html>
