<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›£æ¸¬ç«™åˆ†é¡èª¿è©¦å·¥å…·</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; }
        .debug-card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .debug-btn { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
        .debug-btn:hover { background: #1976D2; }
        .debug-btn.water { background: #00BCD4; }
        .debug-btn.debris { background: #FF5722; }
        .result { margin-top: 20px; }
        .station-item { padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #ccc; }
        .station-item.water { border-left-color: #00BCD4; background: #e0f7fa; }
        .station-item.debris { border-left-color: #FF5722; background: #fbe9e7; }
        .station-item.excluded { border-left-color: #9E9E9E; background: #f5f5f5; }
        .highlight { background: #ffeb3b !important; border-left-color: #FF9800 !important; }
        .loading { text-align: center; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-search"></i> ç›£æ¸¬ç«™åˆ†é¡èª¿è©¦å·¥å…·</h1>
        
        <div class="debug-card">
            <h2>ğŸ” æŸ¥è©¢ç‰¹å®šç›£æ¸¬ç«™</h2>
            <p>è¼¸å…¥ç›£æ¸¬ç«™IDä¾†æŸ¥è©¢å…¶åˆ†é¡ç‹€æ³</p>
            <input type="text" id="stationIdInput" placeholder="è¼¸å…¥ç›£æ¸¬ç«™ID" style="width: 300px; padding: 8px; margin-right: 10px;" value="007d029e-2adc-4012-8602-7d69796cbcc8">
            <button class="debug-btn" onclick="searchStation()">æœå°‹ç›£æ¸¬ç«™</button>
            <div id="searchResult" class="result"></div>
        </div>

        <div class="debug-card">
            <h2>ğŸ“Š ç³»çµ±åˆ†é¡æ¸¬è©¦</h2>
            <p>æ¸¬è©¦å„å€‹ç³»çµ±çš„ç›£æ¸¬ç«™åˆ†é¡é‚è¼¯</p>
            <button class="debug-btn water" onclick="testWaterSystem()">æ°´è³‡æºç³»çµ±åˆ†é¡</button>
            <button class="debug-btn debris" onclick="testDebrisSystem()">åœŸçŸ³æµç³»çµ±åˆ†é¡</button>
            <button class="debug-btn" onclick="compareClassification()">æ¯”è¼ƒåˆ†é¡çµæœ</button>
            <div id="classificationResult" class="result"></div>
        </div>

        <div class="debug-card">
            <h2>ğŸ“‹ æ°´åˆ©ç½²ç›£æ¸¬ç«™åˆ—è¡¨</h2>
            <p>é¡¯ç¤ºæ‰€æœ‰æ°´åˆ©ç½²ï¼ˆèˆ‡ç¸£å¸‚æ”¿åºœåˆå»ºï¼‰çš„ç›£æ¸¬ç«™</p>
            <button class="debug-btn" onclick="loadAllWaterStations()">è¼‰å…¥æ°´åˆ©ç½²ç›£æ¸¬ç«™</button>
            <div id="waterStationsList" class="result"></div>
        </div>
    </div>

    <script>
        async function searchStation() {
            const stationId = document.getElementById('stationIdInput').value.trim();
            const result = document.getElementById('searchResult');
            
            if (!stationId) {
                result.innerHTML = '<div style="color: red;">è«‹è¼¸å…¥ç›£æ¸¬ç«™ID</div>';
                return;
            }
            
            result.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> æœå°‹ä¸­...</div>';
            
            try {
                // æŸ¥è©¢è©²ç›£æ¸¬ç«™
                const response = await fetch(`https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/stationID%20eq%20%27${stationId}%27`);
                const data = await response.json();
                
                if (data.value && data.value.length > 0) {
                    const station = data.value[0];
                    const thing = station.Thing || {};
                    const props = thing.properties || {};
                    
                    result.innerHTML = `
                        <div class="station-item highlight">
                            <h4><i class="fas fa-video"></i> ${thing.name || 'æœªå‘½å'}</h4>
                            <p><strong>ID:</strong> ${props.stationID || 'N/A'}</p>
                            <p><strong>ç›£æ¸¬ç«™åç¨±:</strong> ${props.stationName || 'N/A'}</p>
                            <p><strong>ä¸»ç®¡æ©Ÿé—œ:</strong> ${props.authority || 'N/A'}</p>
                            <p><strong>æ©Ÿé—œé¡å‹:</strong> ${props.authority_type || 'N/A'}</p>
                            <p><strong>èªªæ˜:</strong> ${thing.description || 'N/A'}</p>
                            <p><strong>ä½ç½®:</strong> ${props.location || 'N/A'}</p>
                            
                            <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                                <strong>åˆ†é¡åˆ¤æ–·:</strong><br>
                                â€¢ åŒ…å«æ’æ°´é—œéµå­—: ${(props.stationName || '').includes('æ’æ°´') ? 'æ˜¯' : 'å¦'}<br>
                                â€¢ åŒ…å«æ©‹æ¢é—œéµå­—: ${(props.stationName || '').includes('æ©‹') ? 'æ˜¯' : 'å¦'}<br>
                                â€¢ åŒ…å«åœŸçŸ³æµé—œéµå­—: ${(props.stationName || '').includes('åœŸçŸ³æµ') ? 'æ˜¯' : 'å¦'}<br>
                                â€¢ <strong>æ¨è–¦ç³»çµ±: ${getRecommendedSystem(props.stationName || '', props.stationID || '')}</strong>
                            </div>
                        </div>
                    `;
                } else {
                    result.innerHTML = '<div style="color: red;">æœªæ‰¾åˆ°è©²ç›£æ¸¬ç«™</div>';
                }
                
            } catch (error) {
                result.innerHTML = `<div style="color: red;">æŸ¥è©¢å¤±æ•—: ${error.message}</div>`;
            }
        }
        
        function getRecommendedSystem(stationName, stationID) {
            // æ’é™¤æ˜ç¢ºçš„æ°´åˆ©ç›£æ§ç«™é»
            const excludeKeywords = ['æ’æ°´', 'æ©‹', 'å °', 'å£©', 'æºªå·', 'æ²³å·', 'å ¤é˜²', 'æŠ½æ°´ç«™', 'é–˜é–€', 'æ°´ä½ç«™'];
            const isWaterManagement = excludeKeywords.some(keyword => stationName.includes(keyword));
            
            // æ’é™¤ç‰¹å®šID
            const isSpecificExcluded = stationID === '007d029e-2adc-4012-8602-7d69796cbcc8';
            
            // åŒ…å«åœŸçŸ³æµç›¸é—œé—œéµå­—
            const debrisKeywords = ['åœŸçŸ³æµ', 'å±±å€', 'å´©å¡Œ', 'å¡åœ°', 'è§€æ¸¬ç«™'];
            const isDebrisRelated = debrisKeywords.some(keyword => stationName.includes(keyword));
            
            if (isWaterManagement || isSpecificExcluded) {
                return 'ğŸ’§ æ°´è³‡æºç›£æ§ç³»çµ±';
            } else if (isDebrisRelated || stationName.includes('å±±')) {
                return 'ğŸ”ï¸ åœŸçŸ³æµç›£æ§ç³»çµ±';
            } else {
                return 'â“ éœ€è¦é€²ä¸€æ­¥åˆ¤æ–·';
            }
        }

        async function testWaterSystem() {
            const result = document.getElementById('classificationResult');
            result.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> æ¸¬è©¦æ°´è³‡æºç³»çµ±...</div>';
            
            try {
                const response = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%EF%BC%88%E8%88%87%E7%B8%A3%E5%B8%82%E6%94%BF%E5%BA%9C%E5%90%88%E5%BB%BA%EF%BC%89%27&$count=true&$top=20');
                const data = await response.json();
                
                let html = `<h3>ğŸ’§ æ°´è³‡æºç³»çµ± - è¼‰å…¥ ${data.value?.length || 0} ç­†è³‡æ–™</h3>`;
                
                if (data.value) {
                    data.value.forEach(station => {
                        const thing = station.Thing || {};
                        const props = thing.properties || {};
                        const stationName = props.stationName || '';
                        const stationID = props.stationID || '';
                        
                        html += `
                            <div class="station-item water">
                                <strong>${thing.name || 'æœªå‘½å'}</strong><br>
                                ID: ${stationID}<br>
                                ç›£æ¸¬ç«™: ${stationName}<br>
                                æ¨è–¦: ${getRecommendedSystem(stationName, stationID)}
                            </div>
                        `;
                    });
                }
                
                result.innerHTML = html;
                
            } catch (error) {
                result.innerHTML = `<div style="color: red;">æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
            }
        }

        async function loadAllWaterStations() {
            const result = document.getElementById('waterStationsList');
            result.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥æ‰€æœ‰æ°´åˆ©ç½²ç›£æ¸¬ç«™...</div>';
            
            try {
                const response = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%EF%BC%88%E8%88%87%E7%B8%A3%E5%B8%82%E6%94%BF%E5%BA%9C%E5%90%88%E5%BB%BA%EF%BC%89%27&$count=true');
                const data = await response.json();
                
                let html = `<h3>ğŸ“Š æ°´åˆ©ç½²ï¼ˆèˆ‡ç¸£å¸‚æ”¿åºœåˆå»ºï¼‰ç›£æ¸¬ç«™ç¸½è¦½</h3>`;
                html += `<p>ç¸½è¨ˆ: ${data['@iot.count'] || data.value?.length || 0} ç­†</p>`;
                
                // åˆ†é¡çµ±è¨ˆ
                const stations = data.value || [];
                const waterStations = stations.filter(station => {
                    const stationName = station.Thing?.properties?.stationName || '';
                    const stationID = station.Thing?.properties?.stationID || '';
                    const excludeKeywords = ['æ’æ°´', 'æ©‹', 'å °', 'å£©', 'æºªå·', 'æ²³å·', 'å ¤é˜²', 'æŠ½æ°´ç«™', 'é–˜é–€', 'æ°´ä½ç«™'];
                    const isWaterManagement = excludeKeywords.some(keyword => stationName.includes(keyword));
                    const isSpecificExcluded = stationID === '007d029e-2adc-4012-8602-7d69796cbcc8';
                    return isWaterManagement || isSpecificExcluded;
                });
                
                const debrisStations = stations.filter(station => {
                    const stationName = station.Thing?.properties?.stationName || '';
                    const stationID = station.Thing?.properties?.stationID || '';
                    const excludeKeywords = ['æ’æ°´', 'æ©‹', 'å °', 'å£©', 'æºªå·', 'æ²³å·', 'å ¤é˜²', 'æŠ½æ°´ç«™', 'é–˜é–€', 'æ°´ä½ç«™'];
                    const isWaterManagement = excludeKeywords.some(keyword => stationName.includes(keyword));
                    const isSpecificExcluded = stationID === '007d029e-2adc-4012-8602-7d69796cbcc8';
                    const debrisKeywords = ['åœŸçŸ³æµ', 'å±±å€', 'å´©å¡Œ', 'å¡åœ°', 'è§€æ¸¬ç«™'];
                    const isDebrisRelated = debrisKeywords.some(keyword => stationName.includes(keyword));
                    return !isWaterManagement && !isSpecificExcluded && (isDebrisRelated || stationName.includes('å±±'));
                });
                
                html += `
                    <div style="margin: 15px 0; padding: 15px; background: #e8f5e8; border-radius: 5px;">
                        <strong>åˆ†é¡çµ±è¨ˆ:</strong><br>
                        ğŸ’§ æ‡‰æ­¸é¡ç‚ºæ°´è³‡æº: ${waterStations.length} ç­†<br>
                        ğŸ”ï¸ æ‡‰æ­¸é¡ç‚ºåœŸçŸ³æµ: ${debrisStations.length} ç­†<br>
                        â“ å…¶ä»–/æœªåˆ†é¡: ${stations.length - waterStations.length - debrisStations.length} ç­†
                    </div>
                `;
                
                // é¡¯ç¤ºå‰20ç­†è©³ç´°è³‡æ–™
                html += '<h4>å‰20ç­†ç›£æ¸¬ç«™è©³ç´°è³‡æ–™:</h4>';
                stations.slice(0, 20).forEach(station => {
                    const thing = station.Thing || {};
                    const props = thing.properties || {};
                    const stationName = props.stationName || '';
                    const stationID = props.stationID || '';
                    const recommendedSystem = getRecommendedSystem(stationName, stationID);
                    
                    let itemClass = 'station-item';
                    if (recommendedSystem.includes('æ°´è³‡æº')) itemClass += ' water';
                    else if (recommendedSystem.includes('åœŸçŸ³æµ')) itemClass += ' debris';
                    else itemClass += ' excluded';
                    
                    if (stationID === '007d029e-2adc-4012-8602-7d69796cbcc8') itemClass += ' highlight';
                    
                    html += `
                        <div class="${itemClass}">
                            <strong>${thing.name || 'æœªå‘½å'}</strong><br>
                            <small>ID: ${stationID}</small><br>
                            ç›£æ¸¬ç«™: ${stationName}<br>
                            <strong>æ¨è–¦ç³»çµ±: ${recommendedSystem}</strong>
                        </div>
                    `;
                });
                
                result.innerHTML = html;
                
            } catch (error) {
                result.innerHTML = `<div style="color: red;">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>