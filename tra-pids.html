<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµ PIDS å…¨è¢å¹•æ™‚åˆ»è¡¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #111;
            color: white;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 0;
        }

        /* === å…¨å±€ä½ˆå±€èª¿æ•´ === */

        /* 1. çµ±ä¸€é ‚éƒ¨ (Header) - ä¿®æ”¹ç‰ˆ */
        .unified-header {
            width: 100%;
            height: 110px;
            background-color: #000;
            border: 4px solid #333;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        .station-branding { 
            display: flex; 
            align-items: center; 
            gap: 25px;
            flex: 1;
        }

        .tra-logo-img { 
            height: 70px;
            width: auto; 
            border: 2px solid #fff; 
            border-radius: 50%; 
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
        }

        .station-name-block {
            display: flex;
            flex-direction: row;
            align-items: baseline;
            gap: 15px;
        }

        .station-name { 
            font-size: 4rem;
            font-weight: 900; 
            color: #fff; 
            line-height: 1; 
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255,255,255,0.6);
        }

        .station-sub { 
            font-size: 1.8rem;
            font-weight: bold; 
            color: #4fc3f7;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-family: Consolas, "Arial Black", sans-serif;
        }

        .datetime-block { 
            display: flex;
            align-items: baseline;
            gap: 20px;
            text-align: right;
        }

        .time-text { 
            font-size: 3.5rem;
            font-weight: bold; 
            font-family: Consolas, monospace; 
            color: #ffeb3b; 
            line-height: 1; 
        }

        .date-text { 
            font-size: 2rem;
            color: #ccc; 
            font-weight: bold;
            font-family: Consolas, monospace;
        }

        /* 2. çµ±ä¸€è·‘é¦¬ç‡ˆ (Top Marquee) - ä¿®æ”¹ç‰ˆ */
        .unified-marquee-container {
            width: 100%;
            height: 70px;
            background-color: #e3f2fd;
            border: 4px solid #333;
            border-top: 1px solid #555;
            border-bottom: 4px solid #333;
            display: flex;
            align-items: center;
            overflow: hidden;
            position: relative;
            margin-bottom: 10px;
            color: #01579b;
            flex-shrink: 0;
        }

        .unified-marquee-container .marquee-text {
            height: 70px;
            line-height: 70px;
            font-size: 2.5rem;
            font-weight: 900;
            position: absolute;
            white-space: nowrap;
            will-change: transform;
        }

        /* 3. åˆ†å‰²ç•«é¢å®¹å™¨ */
        .split-screen-container {
            display: flex;
            width: 100%;
            flex: 1;
            gap: 15px;
            overflow: hidden;
        }

        /* å·¦å³æ¬„ä½ */
        .pids-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            border: 4px solid #333;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }

        /* åˆ—è¡¨å€å¡Š */
        .screen-body { 
            flex: 1; 
            display: flex;
            flex-direction: column;
            background: #000;
            overflow: auto;
        }

        .direction-header-1 {
            background: linear-gradient(to right, #000080, #0d47a1);
            color: white;
            padding: 12px 20px;
            font-size: 1.6rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #fff;
            flex-shrink: 0;
        }

        .direction-header-0 {
            background: linear-gradient(to right, #bf360c, #e65100);
            color: white;
            padding: 12px 20px;
            font-size: 1.6rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #fff;
            flex-shrink: 0;
        }

        /* === è¡¨æ ¼æ¨£å¼ä¿®æ­£ === */
        .train-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            table-layout: fixed; /* å›ºå®šè¡¨æ ¼ä½ˆå±€ */
        }

        .train-table th {
            padding: 10px;
            font-size: 1.4rem;
            color: #fff;
            border-bottom: 2px solid #fff;
            height: 50px; /* æ¨™é¡Œå›ºå®šé«˜åº¦ */
        }
        
        .table-1 th { background-color: #000080; }
        .table-1 tr:nth-child(odd) { background-color: #000; }
        .table-1 tr:nth-child(even) { background-color: #002f4b; }

        .table-0 th { background-color: #bf360c; }
        .table-0 tr:nth-child(odd) { background-color: #000; }
        .table-0 tr:nth-child(even) { background-color: #3e2723; }

        /* ğŸ”¥ [ä¿®æ”¹] å›ºå®šæ¯ä¸€åˆ—çš„é«˜åº¦ */
        .train-table tbody tr {
            height: 85px; /* è¨­å®šå›ºå®šé«˜åº¦ */
            max-height: 85px;
        }

        .train-table td { 
            padding: 0 5px; /* æ¸›å°‘ä¸Šä¸‹ paddingï¼Œé  Flex ç½®ä¸­ */
            vertical-align: middle;
            color: #fff;
            white-space: nowrap; /* ä¸æ›è¡Œ */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ğŸ”¥ [æ–°å¢] èª¤é»æ™‚é–“å®¹å™¨ - å·¦å³æ’åˆ— */
        .time-delay-container {
            display: flex;
            flex-direction: row; /* å·¦å³æ’åˆ— */
            align-items: center;
            justify-content: center;
            gap: 10px; /* ä¸­é–“é–“è· */
            height: 100%;
        }

        .original-time {
            text-decoration: line-through; 
            color: #777; 
            font-size: 1.2rem;
        }

        .expected-time {
            color: #4fc3f7; 
            font-weight: bold; 
            font-size: 1.8rem; /* ä¿æŒå¤§å­—é«” */
        }
        
        /* æ­£å¸¸æ™‚é–“ */
        .normal-time {
            font-size: 1.8rem;
        }

        .highlight-row {
            background-color: rgba(255, 255, 255, 0.15) !important;
            box-shadow: inset 0 0 15px rgba(255, 235, 59, 0.15);
            border: 2px solid #ffeb3b !important;
        }

        /* è»Šç¨®æ¨™ç±¤æ¨£å¼ */
        .train-type-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 4px;
            color: white;
            font-size: 1.6rem;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            min-width: 140px;
        }

        .type-è‡ªå¼· { background-color: #FF5722; }
        .type-è‡ªå¼·3000 { background: linear-gradient(135deg, #222 0%, #444 100%); border: 1px solid #999; }
        .type-æ™®æ‚ ç‘ª { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); }
        .type-å¤ªé­¯é–£ { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .type-è’å…‰ { background-color: #FF9800; }
        .type-è§€å…‰ { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); border: 1px dashed #fff; }
        .type-å€é–“å¿« { background-color: #3F51B5; }
        .type-å€é–“ { background-color: #2196F3; }
        .type-å¾©èˆˆ { background-color: #00BCD4; }
        .type-æ™®å¿« { background-color: #009688; }
        .type-å…¶ä»– { background-color: #607D8B; }

        .status-ontime { color: #ffffff !important; text-shadow: none; }
        .status-delay { color: #ff1744 !important; }
        .status-future { color: #ccc !important; font-style: italic; }
        .status-cancelled { background-color: #212121; color: #FF5252; border: 1px solid #FF5252; padding: 2px 6px; border-radius: 3px; }
        .train-cancelled-row { opacity: 0.6; filter: grayscale(100%); background-color: #1a1a1a !important; }

        /* å®£å°åœ–ç‰‡å€ */
        .media-zone {
            height: 120px;
            overflow: hidden;
            background: #222;
            border-top: 1px solid #333;
        }

        .media-zone img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.6;
        }

        /* åº•éƒ¨å‹•æ…‹è·‘é¦¬ç‡ˆ */
        .marquee-footer {
            background-color: #212121;
            color: #ffeb3b;
            height: 60px;
            position: relative;
            overflow: hidden;
            display: block;
            border-top: 4px solid #ff9800;
            padding: 0;
            flex-shrink: 0;
        }

        .marquee-footer .marquee-text {
            position: absolute;
            white-space: nowrap;
            top: 0;
            left: 0;
            height: 60px;
            line-height: 60px;
            font-size: 1.5rem;
            font-weight: bold;
            will-change: transform;
            transform: translateX(100vw);
        }

        @keyframes dynamic-marquee {
            from { transform: translateX(var(--start-pos)); }
            to { transform: translateX(var(--end-pos)); }
        }

        /* éš±è—èˆŠå…ƒç´  */
        .marquee-header { display: none; }
        .pids-top-bar { display: none; }
        .pids-screen { display: none; }

        /* æ‰‹æ©Ÿç‰ˆé©é… */
        /* === æ‰‹æ©Ÿç‰ˆé©é… (å¼·åˆ¶é–‹å•Ÿæ²å‹•) === */
        @media (max-width: 900px) {
            body { 
                padding: 5px; 
                /* ğŸ”¥ é—œéµä¿®æ­£ 1ï¼šé«˜åº¦æ”¹ç‚ºè‡ªå‹•ï¼Œå…è¨±é•·é«˜ */
                height: auto !important; 
                min-height: 100vh;
                /* ğŸ”¥ é—œéµä¿®æ­£ 2ï¼šå¼·åˆ¶é–‹å•Ÿå‚ç›´æ²å‹• */
                overflow-y: auto !important; 
                -webkit-overflow-scrolling: touch; /* iOS æ»‘å‹•é †æš¢å„ªåŒ– */
            }

            .unified-header { height: 70px; padding: 0 10px; }
            .station-branding { gap: 10px; }
            .tra-logo-img { height: 40px; }
            .station-name-block { flex-direction: column; align-items: flex-start; gap: 0; }
            .station-name { font-size: 1.8rem; }
            .station-sub { font-size: 0.8rem; }
            
            .datetime-block { flex-direction: column; gap: 0; align-items: flex-end; }
            .time-text { font-size: 1.6rem; }
            .date-text { font-size: 0.8rem; }

            .unified-marquee-container { height: 40px; margin-bottom: 5px; }
            .unified-marquee-container .marquee-text { height: 40px; line-height: 40px; font-size: 1rem; }

            /* ğŸ”¥ é—œéµä¿®æ­£ 3ï¼šè§£é–‹ç‰ˆé¢é–å®šï¼Œè®“å®ƒè‡ªç„¶å †ç–Š */
            .split-screen-container { 
                flex-direction: column; 
                height: auto !important; /* è§£é™¤é«˜åº¦é™åˆ¶ */
                overflow: visible !important; /* è§£é™¤æº¢å‡ºéš±è— */
                display: block; /* æ”¹ç‚ºå€å¡Šé¡¯ç¤ºï¼Œé¿å… flex æ“ å£“ */
            }

            .pids-column { 
                min-height: 400px;
                margin-bottom: 20px; /* ä¸Šä¸‹å€å¡Šä¿æŒè·é›¢ */
                height: auto !important; /* è®“å…§å®¹æ’é–‹é«˜åº¦ */
                display: flex;
                flex-direction: column;
            }

            .screen-body {
                flex: none; /* ä¸å†è‡ªå‹•ä¼¸ç¸® */
                height: auto; /* ä¾è¡¨æ ¼å…§å®¹é•·é«˜ */
            }

            /* èª¿æ•´æ‰‹æ©Ÿç‰ˆå­—é«”å¤§å° */
            .direction-header-1, .direction-header-0 { font-size: 1.2rem; padding: 8px 10px; }
            .train-table { font-size: 1.1rem; }
            .train-table th { font-size: 0.9rem; padding: 6px 2px; }
            .train-table td { padding: 6px 2px; }
            .train-type-badge { min-width: unset; padding: 2px 4px; font-size: 0.9rem; }
            
            .marquee-footer { height: 40px; }
            .marquee-footer .marquee-text { height: 40px; line-height: 40px; font-size: 1rem; }

            /* æ‰‹æ©Ÿç‰ˆæ™‚é–“å­—é«”ç¸®å° */
            .original-time { font-size: 0.9rem; }
            .expected-time { font-size: 1.1rem; }
            .normal-time { font-size: 1.1rem; }

            /* æ‰‹æ©Ÿç‰ˆè¡¨æ ¼è¡Œé«˜èª¿æ•´ */
            .train-table tbody tr { height: 60px; }
        }
        
        /* é è¨ˆæ™‚é–“æ¨£å¼ï¼ˆPIDS è¡¨æ ¼ç‰ˆæœ¬ï¼‰ */
        .expected-time-pids {
            font-size: 0.8rem;
            color: #4fc3f7;
            font-weight: 600;
            display: block;
        }
    </style>
    <script src="assets/station-code-mapping.js"></script>
</head>
<body>

    <div class="unified-header">
        <div class="station-branding">
            <img src="https://www.railway.gov.tw/tra-tip-web/static/images/TRA_logo.jpg" class="tra-logo-img" alt="å°éµ">
            <div class="station-name-block">
                <div class="station-name" id="unifiedStationName">è‡ºéµè»Šç«™</div>
                <div class="station-sub" id="station-en">TRA STATION</div>
            </div>
        </div>
        <div class="datetime-block">
            <div class="date-text" id="unifiedDate">2025/12/04</div>
            <div class="time-text" id="unifiedTime">12:00:00</div>
        </div>
    </div>

    <div class="unified-marquee-container">
        <div class="marquee-text" id="unifiedTopMarquee">
            åœ¨é€šéå¹³äº¤é“å‰ï¼Œåœã€çœ‹ã€è½é›™å‘æœ‰ç„¡ä¾†è»Šã€‚&nbsp;&nbsp;&nbsp;åœ¨å°šæœªç¢ºå®šåˆ—è»Šå·²å®Œå…¨é€šéå‰ï¼Œä¸å¯è©¦åœ–é€šéå¹³äº¤é“ã€‚&nbsp;&nbsp;&nbsp;å¹³äº¤é“é®æ–·æ¡¿é–‹å§‹æ”¾ä¸‹å¾Œå³æ‡‰åœæ­¢é€šè¡Œã€‚&nbsp;&nbsp;&nbsp;è«‹å‹¿è·¨è¶Šè»Œé“æˆ–åœ¨æœˆå°ä¸Šå¥”è·‘ã€‚
        </div>
    </div>

    <div class="split-screen-container">
        
        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-1">
                    <span id="dirTitle1"><i class="fas fa-arrow-left"></i> é€†è¡Œ (Counter-Clockwise)</span>
                    <span style="font-size: 1rem;" id="destList1">è¼‰å…¥ä¸­...</span>
                </div>
                <table class="train-table table-1">
                    <thead>
                        <tr>
                            <th style="width:18%">è»Šæ¬¡</th>
                            <th style="width:22%">è»Šç¨®</th>
                            <th style="width:25%">é–‹å¾€</th>
                            <th style="width:22%">æ™‚é–“</th>
                            <th style="width:13%">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="body1"></tbody>
                </table>
            </div>
            <div class="marquee-footer">
                <div class="marquee-text" id="marquee1">âš ï¸ è³‡æ–™è®€å–ä¸­...</div>
            </div>
        </div>

        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-0">
                    <span id="dirTitle0"><i class="fas fa-arrow-right"></i> é †è¡Œ (Clockwise)</span>
                    <span style="font-size: 1rem;" id="destList0">è¼‰å…¥ä¸­...</span>
                </div>
                <table class="train-table table-0">
                    <thead>
                        <tr>
                            <th style="width:18%">è»Šæ¬¡</th>
                            <th style="width:22%">è»Šç¨®</th>
                            <th style="width:25%">é–‹å¾€</th>
                            <th style="width:22%">æ™‚é–“</th>
                            <th style="width:13%">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="body0"></tbody>
                </table>
            </div>
            <div class="marquee-footer">
                <div class="marquee-text" id="marquee0">âš ï¸ è³‡æ–™è®€å–ä¸­...</div>
            </div>
        </div>

    </div>

    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script>
        // ============ 0. è¨­å®šï¼šCloudflare Worker ============
        const TRA_WORKER_URL = "https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev";
        let GLOBAL_STATION_ID = ""; // ç”¨ä¾†å­˜ç›®å‰çš„ç«™è™Ÿ

        // ============ 1. å…¨å±€é…ç½®èˆ‡è³‡æ–™åº« ============
        const TRAIN_TYPE_DB = [
          { "id": "1100", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1101", "name": "å¤ªé­¯é–£", "code": "1" },
          { "id": "1102", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1103", "name": "è‡ªå¼·", "code": "3" },
          { "id": "1107", "name": "æ™®æ‚ ç‘ª", "code": "2" },
          { "id": "1108", "name": "è‡ªå¼·", "code": "3" },
          { "id": "110B", "name": "æ–°è‡ªå¼·", "code": "11" },
          { "id": "110G", "name": "æ–°è‡ªå¼·", "code": "11" },
          { "id": "110H", "name": "æ–°è‡ªå¼·", "code": "11" },
          { "id": "110K", "name": "æ–°è‡ªå¼·", "code": "11" },
          { "id": "110M", "name": "æ–°è‡ªå¼·", "code": "11" },
          { "id": "1110", "name": "è’å…‰", "code": "4" },
          { "id": "1111", "name": "è’å…‰", "code": "4" },
          { "id": "1114", "name": "è’å…‰", "code": "4" },
          { "id": "1115", "name": "è’å…‰", "code": "4" },
          { "id": "1120", "name": "å¾©èˆˆ", "code": "5" },
          { "id": "1131", "name": "å€é–“", "code": "6" },
          { "id": "1132", "name": "å€é–“å¿«", "code": "6" },
          { "id": "1140", "name": "æ™®å¿«", "code": "7" }
        ];

        const trainTypeMap = new Map();
        TRAIN_TYPE_DB.forEach(item => trainTypeMap.set(item.id, item.name));

        // ğŸ”¥ 1. å¼·åŠ›ç‰ˆæ¨ç´å°æ‡‰è¡¨ï¼šå°‡æ‰€æœ‰çµ‚é»ç«™å¼·åˆ¶æ­¸ç´åˆ°ã€Œé„°è¿‘å¤§ç«™ã€æˆ–ã€Œç¸£å¸‚ã€
        const majorHubMap = {
            // === åŒ—éƒ¨å€åŸŸ ===
            "åŸºéš†": "åŸºéš†", "ä¸ƒå µ": "åŸºéš†", "ç™¾ç¦": "åŸºéš†", "å…«å µ": "åŸºéš†", "æš–æš–": "åŸºéš†",
            "ç‘èŠ³": "ç‘èŠ³", "èæ¡": "å¹³æºªç·š", "å¹³æºª": "å¹³æºªç·š", "æ·±æ¾³": "æ·±æ¾³",
            "å—æ¸¯": "è‡ºåŒ—", "æ¾å±±": "è‡ºåŒ—", "è‡ºåŒ—": "è‡ºåŒ—", "è¬è¯": "è‡ºåŒ—", "æ¿æ©‹": "è‡ºåŒ—",
            "æ¨¹æ—": "è‡ºåŒ—", "é¶¯æ­Œ": "æ–°åŒ—", "ç¦éš†": "æ±åŒ—è§’", "è²¢å¯®": "æ±åŒ—è§’",
            
            // === æ¡ƒç«¹è‹— ===
            "æ¡ƒåœ’": "æ¡ƒåœ’", "ä¸­å£¢": "æ¡ƒåœ’", "åŸ”å¿ƒ": "æ¡ƒåœ’", "æ¥Šæ¢…": "æ¡ƒåœ’", "å¯Œå²¡": "æ¡ƒåœ’",
            "åŒ—æ¹–": "æ–°ç«¹", "æ¹–å£": "æ–°ç«¹", "æ–°è±": "æ–°ç«¹", "ç«¹åŒ—": "æ–°ç«¹",
            "æ–°ç«¹": "æ–°ç«¹", "ç«¹ä¸­": "æ–°ç«¹", "å…­å®¶": "æ–°ç«¹", "å…§ç£": "å…§ç£ç·š",
            "ç«¹å—": "è‹—æ —", "è‹—æ —": "è‹—æ —", "éŠ…é‘¼": "è‹—æ —", "ä¸‰ç¾©": "è‹—æ —", "è‹‘è£¡": "è‹—æ —", "å¾Œé¾": "è‹—æ —",
            
            // === ä¸­éƒ¨å€åŸŸ ===
            "è±åŸ": "è‡ºä¸­", "è‡ºä¸­": "è‡ºä¸­", "æ–°çƒæ—¥": "è‡ºä¸­", "æˆåŠŸ": "è‡ºä¸­", "å¤§ç”²": "è‡ºä¸­æµ·ç·š", "æ¸…æ°´": "è‡ºä¸­æµ·ç·š", "æ²™é¹¿": "è‡ºä¸­æµ·ç·š",
            "å½°åŒ–": "å½°åŒ–", "å“¡æ—": "å½°åŒ–", "ç”°ä¸­": "å½°åŒ–", "äºŒæ°´": "å½°åŒ–", "é›†é›†": "é›†é›†ç·š", "è»ŠåŸ•": "é›†é›†ç·š",
            "æ–—å…­": "é›²æ—", "æ–—å—": "é›²æ—", "æ—å…§": "é›²æ—",
            "å˜‰ç¾©": "å˜‰ç¾©", "æ°‘é›„": "å˜‰ç¾©", "å¤§æ—": "å˜‰ç¾©", "æ°´ä¸Š": "å˜‰ç¾©",
            
            // === å—éƒ¨å€åŸŸ ===
            "æ–°ç‡Ÿ": "è‡ºå—", "å–„åŒ–": "è‡ºå—", "æ°¸åº·": "è‡ºå—", "è‡ºå—": "è‡ºå—", "æ²™å´™": "è‡ºå—", "ä¸­æ´²": "è‡ºå—",
            "å¤§æ¹–": "é«˜é›„", "è·¯ç«¹": "é«˜é›„", "å²¡å±±": "é«˜é›„", "æ¥ æ¢“": "é«˜é›„",
            "æ–°å·¦ç‡Ÿ": "é«˜é›„", "é«˜é›„": "é«˜é›„", "é³³å±±": "é«˜é›„", "ä¹æ›²å ‚": "é«˜é›„",
            "å±æ±": "å±æ±", "æ½®å·": "å±æ±", "æ‹å¯®": "å±æ±", "æ—é‚Š": "å±æ±", "å—å·": "å±æ±",
            
            // === æ±éƒ¨å€åŸŸ ===
            "å®œè˜­": "å®œè˜­", "ç¾…æ±": "å®œè˜­", "è˜‡æ¾³": "å®œè˜­", "è˜‡æ¾³æ–°": "å®œè˜­", "é ­åŸ": "å®œè˜­", "ç¤æºª": "å®œè˜­",
            "èŠ±è“®": "èŠ±è“®", "ç‰é‡Œ": "èŠ±è“®", "å¿—å­¸": "èŠ±è“®", "å£½è±": "èŠ±è“®", "é³³æ—": "èŠ±è“®", "å…‰å¾©": "èŠ±è“®", "ç‘ç©—": "èŠ±è“®", "å’Œå¹³": "èŠ±è“®",
            "è‡ºæ±": "è‡ºæ±", "çŸ¥æœ¬": "è‡ºæ±", "å¤ªéº»é‡Œ": "è‡ºæ±", "é—œå±±": "è‡ºæ±", "æ± ä¸Š": "è‡ºæ±"
        };

        const stopsCache = {};

        // ============ è‹±æ–‡ç«™åè‡ªå‹•æ›´æ–° ============
        function updateEnglishStationName(stationID) {
            // å–å¾— HTML å…ƒç´ 
            const enElement = document.getElementById('station-en');
            if (!enElement) return;

            // æª¢æŸ¥æ˜¯å¦æœ‰ stationDataMap è³‡æ–™ (ä¾†è‡ª station-code-mapping.js)
            if (typeof stationDataMap !== 'undefined' && stationDataMap[stationID]) {
                // å–å¾—è‹±æ–‡å (ä¾‹å¦‚: "Zhongli_Taoyuan" æˆ– "Taipei")
                let rawName = stationDataMap[stationID].ename;

                // ğŸ”¥ ä¿®æ”¹ï¼šåªå–åº•ç·šå‰çš„åå­—
                // ä¾‹å¦‚ "Zhongli_Taoyuan" è®Šæˆ "Zhongli"
                let formattedName = rawName.split('_')[0].toUpperCase();

                // æ›´æ–°ç•«é¢ï¼šé¡¯ç¤º "ZHONGLI STATION"
                enElement.innerText = `${formattedName} STATION`;
                console.log(`âœ… æ›´æ–°è‹±æ–‡ç«™å: ${formattedName} STATION`);
            } else {
                // æ‰¾ä¸åˆ°è³‡æ–™æ™‚çš„å‚™æ¡ˆ
                console.warn("æ‰¾ä¸åˆ°è»Šç«™è³‡æ–™ ID:", stationID);
                enElement.innerText = "TRA STATION";
            }
        }

        // ============ è·‘é¦¬ç‡ˆæ™ºæ…§æª¢æŸ¥æ©Ÿåˆ¶ (Marquee Polling) ============
        let currentDisplayText = "";

        async function checkMarqueeUpdate() {
            try {
                // å‘¼å« API è®€å–æœ€æ–°è¨­å®š
                const res = await fetch(`${TRA_WORKER_URL}/api/pids/marquee`);
                const data = await res.json();
                const newText = data.text;

                // ã€é—œéµé‚è¼¯ã€‘åªæœ‰ç•¶ã€Œæ–°æŠ“åˆ°çš„æ–‡å­—ã€è·Ÿã€Œç›®å‰é¡¯ç¤ºçš„æ–‡å­—ã€ä¸ä¸€æ¨£æ™‚ï¼Œæ‰æ›´æ–° DOM
                if (newText && newText !== currentDisplayText) {
                    console.log("ğŸ”„ æ”¶åˆ°æ–°æŒ‡ä»¤ï¼Œæ›´æ–°é ‚éƒ¨è·‘é¦¬ç‡ˆå…§å®¹...");
                    
                    const marqueeEl = document.getElementById('unifiedTopMarquee');
                    if (marqueeEl) {
                        marqueeEl.innerHTML = newText; // æ›´æ–° HTML
                        currentDisplayText = newText;  // æ›´æ–°ç´€éŒ„
                        
                        // é‡æ–°åˆå§‹åŒ–è·‘é¦¬ç‡ˆå‹•ç•«
                        initHeaderMarquee('unifiedTopMarquee');
                    }
                }
            } catch (e) {
                console.error("âš ï¸ è·‘é¦¬ç‡ˆæª¢æŸ¥å¤±æ•—ï¼Œä¿æŒç›®å‰é¡¯ç¤ºå…§å®¹", e);
            }
        }
        
        // ============ 2. æ ¸å¿ƒé‚è¼¯å‡½å¼ ============
        
        function getTrainDisplayInfo(train) {
            let name = train.TrainTypeName?.Zh_tw || train.TrainTypeName || 'åˆ—è»Š';
            const typeID = train.TrainTypeID || train.TrainType;
            let cssClass = 'å…¶ä»–';

            if (typeID && trainTypeMap.has(typeID)) {
                name = trainTypeMap.get(typeID);
            } else {
                if (name.includes('æ™®æ‚ ç‘ª')) name = 'æ™®æ‚ ç‘ª';
                else if (name.includes('å¤ªé­¯é–£')) name = 'å¤ªé­¯é–£';
                else if (name.includes('3000')) name = 'æ–°è‡ªå¼·'; // ğŸ”¥ ä¿®æ­£ï¼šè‡ªå¼·(3000) â†’ æ–°è‡ªå¼·
                else if (name.includes('å€é–“å¿«')) name = 'å€é–“å¿«';
                else if (name.includes('å€é–“')) name = 'å€é–“';
                else if (name.includes('è‡ªå¼·')) name = 'è‡ªå¼·';
                else if (name.includes('è’å…‰')) name = 'è’å…‰';
                else if (name.includes('å¾©èˆˆ')) name = 'å¾©èˆˆ';
            }

            if (name.includes('æ–°è‡ªå¼·') || name.includes('3000') || name.includes('EMU3000')) cssClass = 'è‡ªå¼·3000'; // ğŸ”¥ ä¿®æ­£ï¼šä¹Ÿæ¶µè“‹æ–°è‡ªå¼·
            else if (name.includes('æ™®æ‚ ç‘ª')) cssClass = 'æ™®æ‚ ç‘ª';
            else if (name.includes('å¤ªé­¯é–£')) cssClass = 'å¤ªé­¯é–£';
            else if (name.includes('è‡ªå¼·')) cssClass = 'è‡ªå¼·';
            else if (name.includes('è’å…‰')) cssClass = 'è’å…‰';
            else if (name.includes('å€é–“å¿«')) cssClass = 'å€é–“å¿«';
            else if (name.includes('å€é–“')) cssClass = 'å€é–“';
            else if (name.includes('å¾©èˆˆ')) cssClass = 'å¾©èˆˆ';
            else if (name.includes('è§€å…‰') || name.includes('éƒµè¼ª')) cssClass = 'è§€å…‰';
            else if (name.includes('æ™®å¿«')) cssClass = 'æ™®å¿«';

            return { name: name, class: cssClass };
        }

        async function fetchTrainStops(trainNo) {
            if (stopsCache[trainNo]) return stopsCache[trainNo];
            try {
                const response = await fetch(`${TRA_WORKER_URL}/api/schedule?trainNo=${trainNo}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0 && data[0].StopTimes) {
                        stopsCache[trainNo] = data[0].StopTimes;
                        return data[0].StopTimes;
                    }
                }
            } catch (e) {}
            
            try {
                const url = `/v2/Rail/TRA/DailyTrainInfo/TrainNo/${trainNo}?$format=JSON`;
                const data = await tdxApi.fetch(url);
                if (data && data.length > 0 && data[0].StopTimes) {
                    return data[0].StopTimes;
                }
            } catch(e) {}

            return [];
        }

        function addMinutesToTime(timeStr, minutesToAdd) {
            if (!timeStr) return '--:--';
            if (minutesToAdd === 0) return timeStr;
            const [hours, minutes] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(hours);
            date.setMinutes(minutes + minutesToAdd);
            const newHours = String(date.getHours()).padStart(2, '0');
            const newMinutes = String(date.getMinutes()).padStart(2, '0');
            return `${newHours}:${newMinutes}`;
        }

        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            const s = String(now.getSeconds()).padStart(2,'0');
            const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;
            document.getElementById('unifiedTime').textContent = `${h}:${m}:${s}`;
            document.getElementById('unifiedDate').textContent = dateStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // è¨ˆç®—é è¨ˆæ™‚é–“
        function getExpectedTime(timeStr, delayMins) {
            if (!timeStr || delayMins === 0) return timeStr;
            const [h, m] = timeStr.split(':').map(Number);
            const totalMins = h * 60 + m + delayMins;
            const newH = Math.floor(totalMins / 60) % 24;
            const newM = totalMins % 60;
            return `${String(newH).padStart(2, '0')}:${String(newM).padStart(2, '0')}`;
        }

        function formatTime(timeStr) {
            if (!timeStr) return '--:--';
            return timeStr.slice(0, 5);
        }

        // ============ 3. åˆå§‹åŒ–èˆ‡è³‡æ–™æ›´æ–° ============
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const stationID = params.get('station');
            
            GLOBAL_STATION_ID = stationID; // ğŸ”¥ åŠ å…¥é€™è¡Œï¼ŒæŠŠç«™è™Ÿå­˜èµ·ä¾†çµ¦å¾Œé¢ç”¨
            
            // ä¿®æ”¹é€™è£¡ï¼šå–å¾—ç«™åä¸¦è™•ç†å¾Œç¶´
            let rawName = params.get('name') || 'è‡ºéµ';
            
            // 1. å…ˆæŠŠå¯èƒ½å·²ç¶“å­˜åœ¨çš„ã€Œç«™ã€æˆ–æ˜¯ã€Œè»Šç«™ã€å­—çœ¼å»æ‰ (é¿å…è®Šæˆ é³³é³´ç«™è»Šç«™)
            rawName = rawName.replace(/è»Šç«™$|ç«™$/g, '');
            
            // 2. çµ±ä¸€åŠ ä¸Šã€Œè»Šç«™ã€
            const finalName = rawName + 'è»Šç«™';

            // 3. è¨­å®šåˆ°ç•«é¢ä¸Š
            document.getElementById('unifiedStationName').textContent = finalName;
            
            // ğŸ”¥ è‡ªå‹•æ›´æ–°è‹±æ–‡ç«™å (æ ¹æ“š station åƒæ•¸å’Œ station-code-mapping.js)
            updateEnglishStationName(stationID);
            
            initHeaderMarquee('unifiedTopMarquee');

            // ğŸ”¥ å•Ÿå‹•è·‘é¦¬ç‡ˆæª¢æŸ¥æ©Ÿåˆ¶
            // 1. é é¢è¼‰å…¥æ™‚é¦¬ä¸Šæª¢æŸ¥ä¸€æ¬¡
            checkMarqueeUpdate();
            
            // 2. è¨­å®šå®šæ™‚æª¢æŸ¥ (æ¯ 30000 æ¯«ç§’ = 30ç§’ æª¢æŸ¥ä¸€æ¬¡)
            // å¯ä¾éœ€æ±‚èª¿æ•´æ™‚é–“ï¼Œä¾‹å¦‚ 10000 (10ç§’) æˆ– 60000 (1åˆ†é˜)
            setInterval(checkMarqueeUpdate, 30000);

            if (stationID) {
                updatePidsData(stationID);
                setInterval(() => updatePidsData(stationID), 60000);
            } else {
                renderScreen('1', [], 'é€†è¡Œ');
                renderScreen('0', [], 'é †è¡Œ');
            }
        });

        function initHeaderMarquee(elementId) {
            const el = document.getElementById(elementId);
            if(!el) return;
            const container = el.parentElement;
            el.style.animation = 'none';
            void el.offsetWidth;
            const containerWidth = container.clientWidth;
            const textWidth = el.scrollWidth;
            el.style.setProperty('--start-pos', `${containerWidth}px`);
            el.style.setProperty('--end-pos', `-${textWidth}px`);
            const duration = (containerWidth + textWidth) / 200; // åŠ å¿«é€Ÿåº¦ï¼šå¾ /150 æ”¹ç‚º /200
            el.style.animation = `dynamic-marquee ${duration}s linear infinite`;
        }

        async function updatePidsData(stationID) {
            try {
                const workerApiUrl = `${TRA_WORKER_URL}/api/liveboard/station?station=${stationID}`;
                const response = await fetch(workerApiUrl);

                if (!response.ok) throw new Error(`Worker Error: ${response.status}`);
                
                let trains = await response.json();

                const seenTrains = new Set();
                trains = trains.filter(t => {
                    if (seenTrains.has(t.TrainNo)) return false;
                    seenTrains.add(t.TrainNo);
                    return true;
                });

                // ğŸ”¥ [çµ‚æ¥µä¿®æ­£ç‰ˆ] PIDS è·¨æ—¥æ’åºé‚è¼¯ - åŠ å…¥ã€Œæ—¥æœŸ/è·¨æ—¥ã€åˆ¤æ–·
                // è§£æ±ºå•é¡Œï¼šAPI å¯èƒ½ä¸€æ¬¡å›å‚³ã€Œä»Šå¤©+æ˜å¤©ã€çš„ç­æ¬¡ï¼Œéœ€è¦æ™ºæ…§åˆ¤æ–·æ˜æ—¥ç­æ¬¡
                const now = new Date();
                const currentHour = now.getHours();
                const currentMin = now.getMinutes();
                const currentTimeVal = currentHour * 60 + currentMin;

                // é è™•ç†ï¼šè¨ˆç®—æ¯ä¸€ç­è»Šçš„ã€Œçµ•å°åˆ†é˜æ•¸ã€ï¼Œä¸¦è‡ªå‹•åˆ¤æ–·è·¨æ—¥
                trains = trains.map(train => {
                    const timeStr = train.ScheduledDepartureTime || train.DepartureTime || "00:00";
                    const [h, m] = timeStr.split(':').map(Number);
                    let minutes = h * 60 + m;

                    // ğŸ”¥ é—œéµä¿®æ­£ï¼šè‡ªå‹•è·¨æ—¥åˆ¤æ–· (ä¸ä¾è³´ API çš„ IsTomorrow æ¬„ä½)
                    // ç­–ç•¥ï¼šå¦‚æœç­æ¬¡æ™‚é–“æ¯”ç¾åœ¨æ—©è¶…é 12 å°æ™‚ï¼Œè¦–ç‚ºæ˜å¤©çš„ç­æ¬¡
                    // ä¾‹å¦‚ï¼šç¾åœ¨ 20:00 (1200åˆ†é˜)ï¼Œå‡ºç¾ 06:00 (360åˆ†é˜) â†’ å·®è· 840 åˆ†é˜ = 14 å°æ™‚ â†’ æ˜¯æ˜å¤©
                    // æˆ–ï¼šç¾åœ¨ 09:00 (540åˆ†é˜)ï¼Œå‡ºç¾ 05:00 (300åˆ†é˜) â†’ å·®è· 240 åˆ†é˜ = 4 å°æ™‚ â†’ æ˜¯ä»Šå¤©
                    // æˆ–ï¼šç¾åœ¨ 22:00 (1320åˆ†é˜)ï¼Œå‡ºç¾ 05:00 (300åˆ†é˜) â†’ å·®è· 1020 åˆ†é˜ = 17 å°æ™‚ â†’ æ˜¯æ˜å¤©
                    
                    const timeDiff = currentTimeVal - minutes;
                    const TOMORROW_THRESHOLD = 720; // 12 å°æ™‚ = 720 åˆ†é˜
                    
                    if (timeDiff > TOMORROW_THRESHOLD) {
                        // ç­æ¬¡æ™‚é–“æ¯”ç¾åœ¨æ—©è¶…é 12 å°æ™‚ â†’ è‚¯å®šæ˜¯æ˜å¤©
                        minutes += 1440; // åŠ  24 å°æ™‚
                    }
                    
                    // å‚™ç”¨åˆ¤æ–·ï¼šå¦‚æœ API æœ‰æä¾› IsTomorrow æ¨™è¨˜ï¼Œä¹Ÿè¦å°Šé‡
                    if (train.IsTomorrow) {
                        if (minutes < 1440) minutes += 1440; // é¿å…é‡è¤‡åŠ 
                    }

                    // 2. åŠ ä¸Šèª¤é»æ™‚é–“ï¼ˆåœé§›åˆ—è»Šä¸è¨ˆç®—èª¤é»ï¼‰
                    const isCancelled = (String(train.TrainStatus) === '2' || train.TrainStatus === 2);
                    if (!isCancelled) {
                        minutes += parseInt(train.DelayTime || train.Delay || 0);
                    }

                    return { ...train, _sortTime: minutes };
                });

                // æ’åºï¼šä¾ç…§è¨ˆç®—å‡ºçš„çµ•å°åˆ†é˜æ•¸æ’åº
                trains.sort((a, b) => a._sortTime - b._sortTime);

                // å¯é¸ï¼šéæ¿¾æ‰å¾ˆä¹…ä»¥å¾Œçš„ç­æ¬¡ (ä¾‹å¦‚åªé¡¯ç¤º 6 å°æ™‚å…§çš„ç­è»Š)
                // é€™æ¨£ç‰ˆé¢æœƒæ›´ä¹¾æ·¨ï¼Œä¸æœƒæœ‰ã€Œæ˜å¤©æ—©ä¸Š 05:50ã€è·‘ä¾†äº‚å…¥çš„æƒ…æ³
                // const MAX_DISPLAY_HOURS = 6;
                // const maxSortTime = currentTimeVal + (MAX_DISPLAY_HOURS * 60);
                // trains = trains.filter(t => t._sortTime <= maxSortTime);
                
                // æš«æ™‚ä¸éæ¿¾ï¼Œä¿ç•™æ‰€æœ‰è³‡æ–™
                // ğŸ”¥ [çµæŸ] çµ‚æ¥µæ’åºé‚è¼¯

                if (!trains || trains.length === 0) {
                    const noDataMsg = "ç›®å‰ç„¡åˆ—è»Šè³‡è¨Š (æˆ– Worker æ•¸æ“šåº«æ­£åœ¨åŒæ­¥)";
                    renderScreen('1', [], 'é€†è¡Œ');
                    renderScreen('0', [], 'é †è¡Œ');
                    updateBottomMarquee('marquee1', null, noDataMsg, stationID);
                    updateBottomMarquee('marquee0', null, noDataMsg, stationID);
                    return;
                }

                const trains1 = trains.filter(t => String(t.Direction) === '1');
                const trains0 = trains.filter(t => String(t.Direction) === '0');

                renderScreen('1', trains1, 'é€†è¡Œ');
                renderScreen('0', trains0, 'é †è¡Œ');
                updateBottomMarquee('marquee1', trains1, null, stationID);
                updateBottomMarquee('marquee0', trains0, null, stationID);

            } catch (e) {
                console.error("PIDS Worker Error", e);
                const errorMsg = "âš ï¸ é€£ç·š Worker ç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯...";
                updateBottomMarquee('marquee1', null, errorMsg, stationID);
                updateBottomMarquee('marquee0', null, errorMsg, stationID);
            }
        }

        // ==========================================
        // ğŸ”¥ V5.0 æ±è¥¿éƒ¨åˆ†æµé‚è¼¯ï¼šè§£æ±ºèŠ±æ±ç·šæ–¹å‘å®šç¾©ç›¸åçš„å•é¡Œ
        // ==========================================
        function generateDirectionTitle(trains, defaultTitle) {
            if (!trains || trains.length === 0) return defaultTitle;

            const currentStationID = parseInt(GLOBAL_STATION_ID || "1000");
            const currentStationName = document.getElementById('unifiedStationName').textContent.replace('è»Šç«™','');

            // åˆ¤æ–·ç›®å‰æ˜¯å¦ä½æ–¼ã€Œæ±éƒ¨å¹¹ç·šã€ (å®œè˜­ 1820 ~ è‡ºæ± 6000+)
            // å®œè˜­ç·šã€åŒ—è¿´ç·šã€è‡ºæ±ç·šå¤§è‡´ç¯„åœ
            const isEastCoast = (currentStationID >= 1800 && currentStationID <= 7000);

            let northTargets = [];
            let southTargets = [];

            if (isEastCoast) {
                // ğŸ”ï¸ã€æ±éƒ¨è¦–è§’ã€‘(èŠ±è“®ã€è‡ºæ±ã€å®œè˜­)
                // å¾€åŒ—/ä¸Šè¡Œï¼šæ˜¯å» å°åŒ—ã€åŸºéš†ã€å®œè˜­ã€è˜‡æ¾³
                northTargets = ["è‡ºåŒ—", "å°åŒ—", "åŸºéš†", "ä¸ƒå µ", "ç‘èŠ³", "å®œè˜­", "ç¾…æ±", "è˜‡æ¾³", "æ¾å±±", "å—æ¸¯", "æ¨¹æ—", "å’Œå¹³"];
                // å¾€å—/ä¸‹è¡Œï¼šæ˜¯å» å°æ±ã€ç‰é‡Œã€å£½è±ã€é³³æ—ã€æ½®å·ã€é«˜é›„
                southTargets = ["è‡ºæ±", "å°æ±", "ç‰é‡Œ", "å£½è±", "é³³æ—", "å…‰å¾©", "ç‘ç©—", "é—œå±±", "æ± ä¸Š", "çŸ¥æœ¬", "å±æ±", "é«˜é›„", "æ–°å·¦ç‡Ÿ", "æ½®å·", "æ‹å¯®", "å¿—å­¸"];
            } else {
                // ğŸ™ï¸ã€è¥¿éƒ¨è¦–è§’ã€‘(å°åŒ—ã€å°ä¸­ã€é«˜é›„)
                // å¾€åŒ—/ä¸Šè¡Œï¼šæ˜¯å» åŸºéš†ã€å®œè˜­ã€èŠ±è“® (è¥¿éƒ¨çœ‹èŠ±æ±æ˜¯åŒ—/æ±å‘)
                northTargets = ["åŸºéš†", "ä¸ƒå µ", "ç‘èŠ³", "å®œè˜­", "èŠ±è“®", "è‡ºæ±", "è˜‡æ¾³", "ç¦éš†", "å—æ¸¯", "æ¾å±±", "è‡ºåŒ—", "æ¿æ©‹", "æ±æ­¢"];
                // å¾€å—/ä¸‹è¡Œï¼šæ˜¯å» æ–°ç«¹ã€å°ä¸­ã€é«˜é›„
                southTargets = ["æ¡ƒåœ’", "ä¸­å£¢", "æ–°ç«¹", "è‹—æ —", "è‡ºä¸­", "å½°åŒ–", "å˜‰ç¾©", "è‡ºå—", "é«˜é›„", "å±æ±", "æ½®å·", "æ–°å·¦ç‡Ÿ", "é¶¯æ­Œ", "å¯Œå²¡", "åŒ—æ¹–", "æ¹–å£"];
            }

            let scoreNorth = 0;
            let scoreSouth = 0;

            trains.slice(0, 5).forEach(t => {
                const dest = t.EndingStationName;
                // æ’é™¤æœ¬ç«™çµ‚é»çš„å¹²æ“¾
                if (dest === currentStationName) return;

                if (northTargets.some(k => dest.includes(k))) scoreNorth++;
                if (southTargets.some(k => dest.includes(k))) scoreSouth++;
            });

            // åˆ¤æ–·çµæœ
            let isNorthBound = scoreNorth >= scoreSouth;

            // ä¿éšªæ©Ÿåˆ¶ï¼šå¦‚æœå…©é‚Šéƒ½æ²’åˆ†ï¼Œä¾ç…§é è¨­æ–‡å­—çŒœæ¸¬
            if (scoreNorth === 0 && scoreSouth === 0) {
                if (defaultTitle.includes("é€†è¡Œ") || defaultTitle.includes("Counter")) isNorthBound = true; // æ±éƒ¨é€†è¡Œé€šå¸¸æ˜¯åŒ—ä¸Š(å¾€å°åŒ—)
                else isNorthBound = false;
            }

            console.log(`[V5æ–¹å‘] ${isEastCoast?'æ±éƒ¨':'è¥¿éƒ¨'}è¦–è§’ | åŒ—åˆ†:${scoreNorth} å—åˆ†:${scoreSouth} | åˆ¤å®šå¾€åŒ—? ${isNorthBound}`);

            return getNearbyHubs(currentStationID, isNorthBound);
        }

        // ğŸ“ åœ°ç†ä½ç½®å°ç…§è¡¨ V5.0 (é‡å°èŠ±è“®ä¿®æ­£)
        function getNearbyHubs(stationID, isNorthBound) {
            if (!stationID) return isNorthBound ? "å¾€ åŒ—ä¸Š/æ±è¡Œ" : "å¾€ å—ä¸‹/è¥¿è¡Œ";
            
            const id = parseInt(stationID);

            // === 1. èŠ±è“®/è‡ºæ±ç·š (æ±éƒ¨å¹¹ç·š) ===
            // åŒ…å« å®œè˜­(1820) ~ èŠ±è“®(6000) ~ è‡ºæ±(7000)
            if (id >= 1800 && id <= 7200) {
                if (isNorthBound) {
                    // å¾€åŒ—ï¼šå»å°åŒ—ã€å®œè˜­
                    if (id >= 6000) return "é–‹å¾€ï¼šå®œè˜­ã€è‡ºåŒ—"; // åœ¨èŠ±è“®/å°æ±ï¼Œå¾€åŒ—æ˜¯å®œè˜­
                    return "é–‹å¾€ï¼šç‘èŠ³ã€è‡ºåŒ—";             // åœ¨å®œè˜­ï¼Œå¾€åŒ—æ˜¯ç‘èŠ³
                } else {
                    // å¾€å—ï¼šå»å°æ±ã€èŠ±è“®
                    if (id < 6000) return "é–‹å¾€ï¼šèŠ±è“®ã€è‡ºæ±";  // åœ¨å®œè˜­ï¼Œå¾€å—æ˜¯èŠ±è“®
                    if (id < 7000) return "é–‹å¾€ï¼šç‰é‡Œã€è‡ºæ±";  // åœ¨èŠ±è“®ï¼Œå¾€å—æ˜¯å°æ±
                    return "é–‹å¾€ï¼šå±æ±ã€é«˜é›„";             // åœ¨å°æ±ï¼Œå¾€å—æ˜¯å»é«˜é›„
                }
            }

            // === 2. æ¨¹æ—ç«™å°ˆç”¨ (ID 1040) ===
            if (id === 1040) {
                if (isNorthBound) return "é–‹å¾€ï¼šæ¿æ©‹ã€è‡ºåŒ—";
                return "é–‹å¾€ï¼šé¶¯æ­Œã€æ¡ƒåœ’";
            }

            // === 3. åŒ—éƒ¨å€é–“ (åŸºéš† - æ–°ç«¹) ===
            if (id < 1250) {
                if (isNorthBound) {
                    if (id >= 1020) return "é–‹å¾€ï¼šæ¿æ©‹ã€è‡ºåŒ—";
                    return "é–‹å¾€ï¼šå—æ¸¯ã€åŸºéš†";
                } else {
                    if (id <= 1000) return "é–‹å¾€ï¼šæ¿æ©‹ã€æ¡ƒåœ’";
                    return "é–‹å¾€ï¼šä¸­å£¢ã€æ–°ç«¹";
                }
            }

            // === 4. ä¸­éƒ¨å€é–“ (ç«¹å— - å½°åŒ–) ===
            if (id >= 1250 && id <= 3360) {
                if (isNorthBound) return "é–‹å¾€ï¼šæ–°ç«¹ã€è‡ºåŒ—";
                else return "é–‹å¾€ï¼šå½°åŒ–ã€å˜‰ç¾©";
            }

            // === 5. å—éƒ¨å€é–“ (å“¡æ— - å±æ±) ===
            if (id > 3360) {
                if (isNorthBound) return "é–‹å¾€ï¼šå˜‰ç¾©ã€è‡ºä¸­";
                else return "é–‹å¾€ï¼šé«˜é›„ã€å±æ±";
            }

            return isNorthBound ? "é–‹å¾€ï¼šåŒ—ä¸Š" : "é–‹å¾€ï¼šå—ä¸‹";
        }

        function renderScreen(dirCode, trains, dirName) {
            const tbody = document.getElementById(`body${dirCode}`);
            const destLabel = document.getElementById(`destList${dirCode}`);
            tbody.innerHTML = '';
            
            destLabel.textContent = generateDirectionTitle(trains, dirName === 'é€†è¡Œ' ? 'åŒ—ä¸Š' : 'å—ä¸‹');

            const maxRows = 8;
            trains.forEach((train, index) => {
                const isCancelled = (String(train.TrainStatus) === '2' || train.TrainStatus === 2);
                const delay = parseInt(train.DelayTime || train.Delay || 0);
                let delayText = 'æº–é»';
                let statusClass = 'status-ontime';

                if (isCancelled) {
                    delayText = 'åœé§›';
                    statusClass = 'status-cancelled';
                } else if (train.IsTomorrow) {
                    delayText = 'æœªç™¼è»Š';
                    statusClass = 'status-future';
                } 
                else if (delay > 0) {
                    delayText = `æ™š ${delay} åˆ†`;
                    statusClass = 'status-delay';
                }

                const trainInfo = getTrainDisplayInfo(train);
                const row = document.createElement('tr');
                if (index === 0) row.classList.add('highlight-row');
                if (isCancelled) row.classList.add('train-cancelled-row');
                
                const timeStr = formatTime(train.ScheduledDepartureTime || train.DepartureTime);
                
                // ğŸ”¥ [ä¿®æ”¹] èª¤é»é¡¯ç¤ºé‚è¼¯ï¼šå·¦å³ä¸¦æ’ï¼Œä¸å½±éŸ¿é«˜åº¦
                let timeDisplayHtml = `<span class="normal-time" style="font-family: Consolas;">${timeStr}</span>`;
                
                if (delay > 0 && !train.IsTomorrow && statusClass !== 'status-cancelled') {
                    const estTime = getExpectedTime(timeStr, delay);
                    // ä½¿ç”¨ Flex å®¹å™¨å·¦å³æ’åˆ—
                    timeDisplayHtml = `
                        <div class="time-delay-container">
                            <span class="original-time" style="font-family: Consolas;">${timeStr}</span>
                            <span class="expected-time" style="font-family: Consolas;">${estTime}</span>
                        </div>
                    `;
                }

                row.innerHTML = `
                    <td style="color:#fff; font-family:Consolas;">${train.TrainNo}</td>
                    <td><span class="train-type-badge type-${trainInfo.class}">${trainInfo.name}</span></td>
                    <td style="color:#fff;">${train.EndingStationName}</td>
                    
                    <td style="color:#fff; vertical-align: middle;">
                        ${timeDisplayHtml}
                    </td>
                    
                    <td class="${statusClass}">${delayText}</td>
                `;
                tbody.appendChild(row);
            });

            for(let i=trains.length; i<maxRows; i++) {
                const emptyRow = tbody.insertRow();
                emptyRow.innerHTML = '<td>&nbsp;</td><td></td><td></td><td></td><td></td>';
            }
        }

        function isLocationReasonable(currentStationID, reportedStationName, stopTimes) {
            if (!stopTimes || stopTimes.length === 0) return true;

            const pidsIndex = stopTimes.findIndex(s => String(s.StationID) === String(currentStationID));
            const nameStr = (typeof reportedStationName === 'object') ? reportedStationName.Zh_tw : reportedStationName;
            const trainIndex = stopTimes.findIndex(s => s.StationName.Zh_tw === nameStr);

            if (pidsIndex === -1 || trainIndex === -1) return true;

            const gap = Math.abs(pidsIndex - trainIndex);

            if (gap > 10) {
                console.warn(`[PIDSé˜²å‘†] éš±è—ç•°å¸¸ä½ç½®: ${nameStr} (è·é›¢æœ¬ç«™ ${gap} ç«™)`);
                return false;
            }

            return true;
        }

        async function updateBottomMarquee(elementId, trains, customMsg, currentStationID) {
            const el = document.getElementById(elementId);
            const container = el.parentElement;
            let textHTML = "";

            if (customMsg) {
                textHTML = customMsg;
            } else if (!trains || trains.length === 0) {
                textHTML = "ç›®å‰ç„¡åˆ—è»Šè³‡è¨Š";
            } else {
                const train = trains[0];
                const isCancelled = (String(train.TrainStatus) === '2' || train.TrainStatus === 2);
                const trainNo = train.TrainNo;
                const trainInfo = getTrainDisplayInfo(train);
                const delayTime = parseInt(train.DelayTime || train.Delay || 0);
                
                // å¦‚æœåˆ—è»Šåœé§›ï¼Œæå‰è¿”å›è­¦å‘Šè¨Šæ¯
                if (isCancelled) {
                    textHTML = `<span style="color: #ff5252; font-weight:bold; font-size: 1.1em;">ğŸš« ${trainNo} æ¬¡ å¾€ ${train.EndingStationName} æœ¬æ—¥åœé§›</span> <span style="margin: 0 15px; color: #555;">|</span> <span style="color: #ffeb3b;">è«‹æ”¹æ­å…¶ä»–ç­æ¬¡åˆ—è»Š</span>`;
                } else {
                    let stopTimes = [];
                    let liveData = null;

                    try {
                        const liveWorkerPromise = fetch(`${TRA_WORKER_URL}/api/live?trainNo=${trainNo}`).then(r=>r.json()).catch(()=>null);
                        const schedulePromise = fetchTrainStops(trainNo);
                        let liveRawData;
                        [stopTimes, liveRawData] = await Promise.all([schedulePromise, liveWorkerPromise]);

                        if (liveRawData) {
                            if (liveRawData.TrainLiveBoards && liveRawData.TrainLiveBoards.length > 0) liveData = liveRawData.TrainLiveBoards[0];
                            else if (Array.isArray(liveRawData) && liveRawData.length > 0) liveData = liveRawData[0];
                            else if (liveRawData.StationName) liveData = liveRawData;
                        }
                        
                        if (!liveData) {
                            try {
                                const tdxResp = await tdxApi.fetch(`/v3/Rail/TRA/TrainLiveBoard/TrainNo/${trainNo}?$format=JSON`);
                                if (tdxResp?.TrainLiveBoards?.length > 0) liveData = tdxResp.TrainLiveBoards[0];
                            } catch(e){}
                        }
                    } catch (e) {}

                    textHTML += `<span style="color: #ffeb3b; font-weight:bold;">${trainNo} æ¬¡ ${trainInfo.name} å¾€ ${train.EndingStationName}</span> `;
                    textHTML += `<span style="margin: 0 15px; color: #555;">|</span> `;

                    let locationText = "";
                    if (liveData && liveData.StationName) {
                        const lastStationName = liveData.StationName.Zh_tw || liveData.StationName;
                        
                        if (isLocationReasonable(currentStationID, lastStationName, stopTimes)) {
                            let nextStopName = "";
                            if (stopTimes && stopTimes.length > 0) {
                                const passedIndex = stopTimes.findIndex(s => s.StationName.Zh_tw === lastStationName);
                                if (passedIndex !== -1 && passedIndex < stopTimes.length - 1) nextStopName = stopTimes[passedIndex + 1].StationName.Zh_tw;
                            }
                            locationText = nextStopName ? `åˆ—è»Šç›®å‰ä½ç½®ï¼š${lastStationName} â¡ ${nextStopName}` : `åˆ—è»Šç›®å‰ä½ç½®ï¼š${lastStationName}`;
                            const liveDelay = liveData.DelayTime ? parseInt(liveData.DelayTime) : 0;
                            if (liveDelay > 0) locationText += ` (æ™š ${liveDelay} åˆ†)`;
                        } else {
                            locationText = "(è¨Šè™Ÿåµæ¸¬ä¸­...)";
                        }
                    } else {
                        if (train.IsTomorrow) {
                            locationText = "åˆ—è»Šå°šæœªç™¼è»Š (æ˜æ—¥ç­æ¬¡)";
                        } else {
                            let isStarted = true;
                        
                        if (stopTimes && stopTimes.length > 0) {
                            const originTime = stopTimes[0].DepartureTime || stopTimes[0].ArrivalTime;
                            const now = new Date();
                            const nowStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                            
                            if (originTime && nowStr < originTime) {
                                isStarted = false;
                            }
                        }

                        locationText = isStarted ? "åˆ—è»Šè¡Œé§›ä¸­ (æˆ–è¨Šè™Ÿå¾®å¼±)" : "åˆ—è»Šå°šæœªç™¼è»Š";
                    }
                }
                textHTML += `<span style="color: #4fc3f7;">${locationText}</span>`;
                textHTML += `<span style="margin: 0 15px; color: #555;">|</span> `;

                if (stopTimes && stopTimes.length > 0) {
                    const currentIdStr = String(currentStationID);
                    const currentStationIndex = stopTimes.findIndex(s => String(s.StationID) === currentIdStr);
                    if (currentStationIndex !== -1) {
                        const myStation = stopTimes[currentStationIndex];
                        const tableTime = train.ScheduledDepartureTime || train.DepartureTime || ((myStation.ArrivalTime && myStation.ArrivalTime !== "") ? myStation.ArrivalTime : myStation.DepartureTime);
                        const predictedTime = addMinutesToTime(tableTime, delayTime);
                        const timeColor = delayTime > 0 ? '#ff5252' : '#ffffff';
                        
                        if (delayTime > 0) {
                            textHTML += `æœ¬ç«™é è¨ˆï¼š<span style="color: ${timeColor}; font-weight:bold; font-size: 1.1em;">${predictedTime} æŠµé” (æ™š ${delayTime} åˆ†)</span>`;
                        } else {
                            textHTML += `æœ¬ç«™é è¨ˆï¼š<span style="color: ${timeColor}; font-weight:bold; font-size: 1.1em;">${predictedTime} æŠµé” (æº–é»)</span>`;
                        }
                        
                        const futureStops = stopTimes.slice(currentStationIndex + 1);
                        if (futureStops.length > 0) {
                            textHTML += `<span style="margin: 0 15px; color: #555;">|</span> æ²¿é€”åœé ï¼š${futureStops.map(s => s.StationName.Zh_tw).join('ã€')}`;
                        }
                    } else {
                        textHTML += `æœ¬åˆ—è»Šä¸åœé æœ¬ç«™ (é€šé)`;
                    }
                }

                if (['è‡ªå¼·3000','æ™®æ‚ ç‘ª','å¤ªé­¯é–£'].includes(trainInfo.class)) {
                    textHTML += ` <span style="color: #ff5252; margin-left: 20px;">âš  æœ¬åˆ—æ¬¡é ˆæŒæœ‰è»Šç¥¨å§‹å¾—æ­ä¹˜</span>`;
                }
                } // çµæŸéåœé§›åˆ—è»Šçš„ else åˆ†æ”¯
            }
            
            el.innerHTML = textHTML;
            el.style.animation = 'none';
            void el.offsetWidth;
            const containerWidth = container.clientWidth;
            const textWidth = el.scrollWidth;
            el.style.setProperty('--start-pos', `${containerWidth}px`);
            el.style.setProperty('--end-pos', `-${textWidth}px`);
            const duration = Math.max(8, el.innerText.length * 0.25); // èª¿æ•´é€Ÿåº¦ï¼šå¾ 0.15 æ”¹ç‚º 0.25ï¼Œæ›´å¹³è¡¡çš„é¡¯ç¤ºé€Ÿåº¦
            el.style.animation = `dynamic-marquee ${duration}s linear infinite`;
        }
    </script>
</body>
</html>
