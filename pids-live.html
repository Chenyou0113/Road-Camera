<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台鐵 PIDS 全螢幕時刻表</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #111;
            color: white;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }

        .pids-screen {
            flex: 1;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            border: 8px solid #333;
            border-radius: 8px;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        /* === 1. 頂部站名與時間列 === */
        .pids-top-bar {
            background-color: #000;
            color: #fff;
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #333;
        }

        .station-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tra-logo {
            width: 45px;
            height: 45px;
            background: #0d47a1;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid #fff;
            box-shadow: 0 0 10px rgba(13, 71, 161, 0.8);
        }

        .station-name {
            font-size: 2.2rem;
            font-weight: 900;
            letter-spacing: 2px;
            color: #fff;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }

        .datetime-info {
            text-align: right;
            line-height: 1.1;
        }

        .date-text { font-size: 1rem; color: #ccc; }
        .time-text { font-size: 2rem; font-weight: bold; font-family: Consolas, monospace; color: #ffeb3b; }

        /* === 2. 公告跑馬燈 === */
        .marquee-header {
            background-color: #e3f2fd;
            color: #01579b;
            height: 45px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 1.3rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
        }

        /* === 3. 時刻表區域 (滿版) === */
        .screen-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            overflow: auto;
        }

        /* 北上 Header */
        .north-header {
            background: linear-gradient(to right, #000080, #0d47a1);
            color: white;
            padding: 12px 20px;
            font-size: 1.8rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #fff;
        }

        /* 南下 Header */
        .south-header {
            background: linear-gradient(to right, #bf360c, #e65100);
            color: white;
            padding: 12px 20px;
            font-size: 1.8rem;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #fff;
        }

        /* 表格設定 */
        .train-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .train-table th {
            padding: 10px;
            font-size: 1.4rem;
            color: #fff;
            border-bottom: 2px solid #fff;
        }
        
        /* 北上配色 */
        .north-table th { background-color: #000080; }
        .north-table tr:nth-child(odd) { background-color: #000; color: #4fc3f7; }
        .north-table tr:nth-child(even) { background-color: #002f4b; color: #fff; }

        /* 南下配色 */
        .south-table th { background-color: #bf360c; }
        .south-table tr:nth-child(odd) { background-color: #000; color: #ffcc80; }
        .south-table tr:nth-child(even) { background-color: #3e2723; color: #fff; }

        .train-table td { padding: 15px 5px; }

        /* === 4. 底部動態跑馬燈 === */
        .marquee-footer {
            background-color: #212121;
            color: #ffeb3b;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 1.5rem;
            font-weight: bold;
            border-top: 4px solid #ff9800;
            white-space: nowrap;
            overflow: hidden;
        }

        .marquee-text {
            display: inline-block;
            animation: scroll-left 25s linear infinite;
            padding-left: 100%;
        }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .status-ontime { color: #00e676 !important; }
        .status-delay { color: #ff1744 !important; }
        .type-tze { color: #ffeb3b; } 
        .type-local { color: #fff; }

        @media (max-width: 1024px) { 
            body { flex-direction: column; height: auto; overflow-y: auto; } 
            .pids-screen { width: 100%; height: 700px; margin-bottom: 20px; } 
        }
    </style>
</head>
<body>

    <!-- 左螢幕：北上 -->
    <div class="pids-screen">
        <!-- 1. 頂部站名時間列 -->
        <div class="pids-top-bar">
            <div class="station-info">
                <div class="tra-logo"><i class="fas fa-train"></i></div>
                <div class="station-name" id="stationNameN">臺鐵車站</div>
            </div>
            <div class="datetime-info">
                <div class="date-text" id="dateN">2025/11/24</div>
                <div class="time-text" id="timeN">12:08</div>
            </div>
        </div>

        <!-- 2. 公告跑馬燈 -->
        <div class="marquee-header">
            <div class="marquee-text">[北上公告] 本站北上列車運轉正常，感謝您的搭乘。</div>
        </div>

        <!-- 3. 時刻表內容 (滿版) -->
        <div class="screen-body">
            <div class="north-header">
                <span><i class="fas fa-arrow-up"></i> 北上</span>
                <span style="font-size: 1.2rem;">North Bound</span>
            </div>
            <table class="train-table north-table">
                <thead>
                    <tr>
                        <th style="width:15%">車次</th>
                        <th style="width:20%">車種</th>
                        <th style="width:25%">開往</th>
                        <th style="width:20%">時間</th>
                        <th style="width:20%">備註</th>
                    </tr>
                </thead>
                <tbody id="northBody">
                    <!-- JS 自動填入 -->
                </tbody>
            </table>
        </div>

        <!-- 4. 底部即時動態 -->
        <div class="marquee-footer">
            <div class="marquee-text" id="marqueeN">⚠️ 連線異常，請稍候...</div>
        </div>
    </div>

    <!-- 右螢幕：南下 -->
    <div class="pids-screen">
        <!-- 1. 頂部站名時間列 -->
        <div class="pids-top-bar">
            <div class="station-info">
                <div class="tra-logo"><i class="fas fa-train"></i></div>
                <div class="station-name" id="stationNameS">臺鐵車站</div>
            </div>
            <div class="datetime-info">
                <div class="date-text" id="dateS">2025/11/24</div>
                <div class="time-text" id="timeS">12:08</div>
            </div>
        </div>

        <!-- 2. 公告跑馬燈 -->
        <div class="marquee-header">
            <div class="marquee-text">[南下公告] 本站南下列車運轉正常，感謝您的搭乘。</div>
        </div>

        <!-- 3. 時刻表內容 (滿版) -->
        <div class="screen-body">
            <div class="south-header">
                <span><i class="fas fa-arrow-down"></i> 南下</span>
                <span style="font-size: 1.2rem;">South Bound</span>
            </div>
            <table class="train-table south-table">
                <thead>
                    <tr>
                        <th style="width:15%">車次</th>
                        <th style="width:20%">車種</th>
                        <th style="width:25%">開往</th>
                        <th style="width:20%">時間</th>
                        <th style="width:20%">備註</th>
                    </tr>
                </thead>
                <tbody id="southBody">
                    <!-- JS 自動填入 -->
                </tbody>
            </table>
        </div>

        <!-- 4. 底部即時動態 -->
        <div class="marquee-footer">
            <div class="marquee-text" id="marqueeS">⚠️ 連線異常，請稍候...</div>
        </div>
    </div>

    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script>
        // 1. 時鐘功能
        function updateClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            const y = now.getFullYear();
            const mo = String(now.getMonth()+1).padStart(2,'0');
            const d = String(now.getDate()).padStart(2,'0');
            const dateStr = `${y}/${mo}/${d}`;
            
            document.getElementById('timeN').textContent = `${h}:${m}`;
            document.getElementById('timeS').textContent = `${h}:${m}`;
            document.getElementById('dateN').textContent = dateStr;
            document.getElementById('dateS').textContent = dateStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // 2. 工具函式
        function getTrainTypeName(trainType) {
            const typeMap = {
                '1100': '普悠瑪', '1200': '太魯閣', '2100': '自強', 
                '2200': '莒光', '2300': '復興', '3100': '區間'
            };
            return typeMap[trainType] || '未知';
        }

        function formatTime(timeStr) {
            if (!timeStr) return '--:--';
            return timeStr.slice(0, 5);
        }

        function getDelayStatus(delay) {
            if (!delay || delay === 0) return { text: '準點', class: 'status-ontime' };
            return { text: `晚${delay}分`, class: 'status-delay' };
        }

        // 3. 初始化：從網址取得車站 ID
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const stationID = params.get('station');
            const stationName = params.get('name') || '臺鐵車站';

            // 設定站名
            document.getElementById('stationNameN').textContent = stationName + " 時刻表";
            document.getElementById('stationNameS').textContent = stationName + " 時刻表";

            if (stationID) {
                updatePidsData(stationID);
                setInterval(() => updatePidsData(stationID), 60000); // 每分鐘更新
            } else {
                renderScreen('north', []);
                renderScreen('south', []);
            }
        });

        // 4. 資料更新 (使用 D1 Worker API)
        async function updatePidsData(stationID) {
            try {
                const response = await fetch(`https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev/api/schedule?stationId=${stationID}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (!data.Infos || !Array.isArray(data.Infos)) {
                    document.getElementById('marqueeN').textContent = "目前無列車資訊";
                    document.getElementById('marqueeS').textContent = "目前無列車資訊";
                    return;
                }

                const northTrains = data.Infos
                    .filter(t => t.Direction === 1)
                    .sort((a, b) => a.DepartureTime.localeCompare(b.DepartureTime));
                
                const southTrains = data.Infos
                    .filter(t => t.Direction === 0)
                    .sort((a, b) => a.DepartureTime.localeCompare(b.DepartureTime));

                renderScreen('north', northTrains);
                renderScreen('south', southTrains);

                if (northTrains.length > 0) updateLiveMarquee('marqueeN', northTrains[0]);
                else document.getElementById('marqueeN').textContent = "目前無北上列車";

                if (southTrains.length > 0) updateLiveMarquee('marqueeS', southTrains[0]);
                else document.getElementById('marqueeS').textContent = "目前無南下列車";

            } catch (e) {
                console.error("API Error", e);
                document.getElementById('marqueeN').textContent = "⚠️ 連線異常，請稍候...";
                document.getElementById('marqueeS').textContent = "⚠️ 連線異常，請稍候...";
            }
        }

        // 5. 渲染表格 (顯示 6 列以填滿畫面)
        function renderScreen(dir, trains) {
            const tbody = document.getElementById(`${dir}Body`);
            tbody.innerHTML = '';
            const maxRows = 6;

            trains.slice(0, maxRows).forEach(train => {
                const delay = train.Delay || 0;
                let delayText = '準點';
                let statusClass = 'status-ontime';

                if (delay > 0) {
                    delayText = `晚${delay}分`;
                    statusClass = 'status-delay';
                }

                const typeName = getTrainTypeName(train.TrainType);
                const typeClass = (typeName.includes('自強') || typeName.includes('普悠瑪') || typeName.includes('太魯閣')) ? 'type-tze' : 'type-local';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="color:#fff;">${train.TrainNo}</td>
                    <td class="${typeClass}">${typeName}</td>
                    <td style="color:#fff;">${train.EndingStationName}</td>
                    <td style="color:#ffb74d;">${formatTime(train.DepartureTime)}</td>
                    <td class="${statusClass}">${delayText}</td>
                `;
                tbody.appendChild(row);
            });

            // 補空行
            for(let i=trains.length; i<maxRows; i++) {
                const emptyRow = tbody.insertRow();
                emptyRow.innerHTML = '<td>&nbsp;</td><td></td><td></td><td></td><td></td>';
            }
        }

        // 6. 跑馬燈邏輯 - 即時位置顯示
        async function updateLiveMarquee(elementId, train) {
            const el = document.getElementById(elementId);
            const trainNo = train.TrainNo;
            
            try {
                let locationText = "(定位中...)";
                
                if (typeof tdxApi !== 'undefined') {
                    try {
                        const liveData = await tdxApi.fetch(`/v3/Rail/TRA/TrainLiveBoard/TrainNo/${trainNo}?$format=JSON`);
                        if (liveData && liveData.length > 0) {
                            const live = liveData[0];
                            const stationName = live.StationName?.Zh_tw || '未知';
                            const status = live.TrainStationStatus === 0 ? '進站中' : '已離開';
                            locationText = `${status} ${stationName}`;
                        }
                    } catch (e) {
                        console.warn('V3 API 失敗', e);
                    }
                }

                const delay = train.Delay === 0 ? "準點" : `晚 ${train.Delay} 分`;
                const text = `本班列車：${trainNo} 次 往 ${train.EndingStationName} (${delay}) | 目前位置：${locationText} | 本站預計 ${formatTime(train.DepartureTime)} 開車`;
                
                el.textContent = text;
                const duration = Math.max(15, text.length * 0.6);
                el.style.animationDuration = `${duration}s`;

            } catch (e) {
                console.warn("Marquee Error", e);
                const delay = train.Delay === 0 ? "準點" : `晚 ${train.Delay} 分`;
                el.textContent = `${trainNo} 次 往 ${train.EndingStationName} (${delay}) | 連線中...`;
            }
        }
    </script>
</body>
</html>
