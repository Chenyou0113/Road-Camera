<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THSR PIDS V6 (Modern UI)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        /* === ç¾ä»£åŒ– UI è¨­è¨ˆè¦ç¯„ === */
        :root {
            --bg-color: #0c0c0c; /* æ·±ç°é»‘ï¼Œæ¯”ç´”é»‘æ›´æœ‰è³ªæ„Ÿ */
            --header-north-start: #8a0000;
            --header-north-end: #b71c1c;
            --header-south-start: #004d26;
            --header-south-end: #006030;
            
            --text-amber: #ffca28; /* åŒ—ä¸Š LED ç¥ç€è‰² */
            --text-emerald: #00e676; /* å—ä¸‹ LED å¯¶çŸ³ç¶  */
            --text-gray: #b0bec5;
            --divider: #262626;
        }

        * { box-sizing: border-box; }
        body, html {
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Roboto', 'Helvetica Neue', 'Arial', sans-serif;
            overflow: hidden;
            color: #fff;
            -webkit-font-smoothing: antialiased; /* å­—é«”å¹³æ»‘ */
        }

        #app { display: flex; flex-direction: column; height: 100%; }

        /* === å€åŸŸå®¹å™¨ === */
        .board-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-bottom: 4px solid var(--divider);
        }

        /* === æ¨™é¡Œåˆ— (Header) === */
        .header {
            height: 65px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            /* æ¼¸å±¤èƒŒæ™¯æå‡è³ªæ„Ÿ */
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .header.north { background: linear-gradient(90deg, var(--header-north-start), var(--header-north-end)); }
        .header.south { background: linear-gradient(90deg, var(--header-south-start), var(--header-south-end)); }

        .header-title {
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .clock {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        /* === Grid ä½ˆå±€ (ç²¾ç¢ºå°é½Š) === */
        .grid-row {
            display: grid;
            /* å®šç¾©æ¬„ä½æ¯”ä¾‹ï¼šè»Šæ¬¡ | ç›®çš„åœ° | æ™‚é–“ | æœˆå° | è‡ªç”±åº§ | ç‹€æ…‹ | åœé ç«™ */
            grid-template-columns: 10% 12% 10% 8% 15% 12% 33%;
            align-items: center;
            padding-left: 25px;
        }

        /* === è¡¨é ­ (Thead) === */
        .thead {
            height: 45px;
            background-color: #1a1a1a;
            color: #757575;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 1px solid #333;
            letter-spacing: 0.5px;
        }

        /* === è³‡æ–™åˆ— (Rows) === */
        .data-list { flex: 1; display: flex; flex-direction: column; }
        .data-row {
            flex: 1; /* è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ */
            border-bottom: 1px solid #222;
            font-size: 2rem; /* ä¸»å­—é«”å¤§å° */
            font-weight: 700;
            transition: background 0.2s;
        }
        .data-row:nth-child(even) { background-color: rgba(255,255,255,0.02); } /* éš”è¡Œå¾®äº® */

        /* === æ¬„ä½ç´°ç¯€ === */
        .col-mono { font-family: 'Consolas', monospace; letter-spacing: -1px; }
        .col-dest { font-size: 2.4rem; letter-spacing: 5px; } /* ç›®çš„åœ°å­—é«”åŠ å¤§ */
        .col-plat { text-align: center; color: #fff; }
        .col-free { font-size: 1.4rem; color: var(--text-gray); }
        .col-status { font-size: 1.5rem; }

        /* === ç‹€æ…‹é¡è‰² === */
        .status-ok { color: #ffeb3b; } /* é®®é»ƒè‰² */
        .status-delay { color: #f44336; animation: blink 1.5s infinite; }

        /* === åŒ—ä¸Šå°ˆå±¬æ¨£å¼ (Amber Theme) === */
        .north-section .col-dest { color: var(--text-amber); text-shadow: 0 0 5px rgba(255, 202, 40, 0.4); }
        .north-section .col-mono { color: #fff; }

        /* === å—ä¸‹å°ˆå±¬æ¨£å¼ (Emerald Theme) === */
        .south-section .col-dest { color: var(--text-emerald); text-shadow: 0 0 5px rgba(0, 230, 118, 0.4); }
        .south-section .col-mono { color: #fff; }

        /* === åœé ç«™åœ°åœ– (ç²¾ç°¡ç‰ˆ) === */
        .map-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between; /* å¹³å‡åˆ†æ•£ */
            height: 100%;
            padding-right: 30px;
            position: relative;
        }
        .map-line {
            position: absolute;
            top: 50%; left: 0; right: 30px;
            height: 2px;
            background: #424242;
            z-index: 0;
        }
        .station-node {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: #212121;
            border: 2px solid #616161;
            margin-bottom: 4px;
            transition: all 0.3s;
        }
        .st-code { font-size: 0.75rem; color: #616161; font-family: 'Consolas', monospace; font-weight: bold; }

        /* åœé äº®ç‡ˆé‚è¼¯ */
        .north-section .dot.active { background: var(--text-amber); border-color: #fff; box-shadow: 0 0 8px var(--text-amber); transform: scale(1.2); }
        .north-section .dot.active + .st-code { color: #fff; }

        .south-section .dot.active { background: var(--text-emerald); border-color: #fff; box-shadow: 0 0 8px var(--text-emerald); transform: scale(1.2); }
        .south-section .dot.active + .st-code { color: #fff; }

        @keyframes blink { 50% { opacity: 0.3; } }

        /* === åº•éƒ¨ Debug æ¢ (ä½èª¿ç‰ˆ) === */
        .footer-bar {
            height: 30px;
            background: #111;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 0.8rem;
            color: #555;
            font-family: monospace;
            overflow: hidden;
            white-space: nowrap;
        }
        .debug-hl { color: #ff5252; margin-left: 10px; }
    </style>
</head>
<body>

<div id="app">
    
    <div class="board-section north-section">
        <div class="header north">
            <div class="header-title">åŒ—ä¸Š Northbound</div>
            <div class="clock">{{ currentTime }}</div>
        </div>
        <div class="grid-row thead">
            <div>è»Šæ¬¡ Train</div>
            <div>é–‹å¾€ Dest.</div>
            <div>æ™‚é–“ Time</div>
            <div class="col-plat">æœˆå° Plat.</div>
            <div>è‡ªç”±åº§ Non-Res.</div>
            <div>ç‹€æ…‹ Status</div>
            <div>åœé ç«™ Stopping Stations</div>
        </div>
        <div class="data-list">
            <div v-for="i in 4" :key="'n'+i" class="grid-row data-row">
                <template v-if="northboundList[i-1]">
                    <div class="col-mono">{{ northboundList[i-1].trainNo }}</div>
                    <div class="col-dest">{{ northboundList[i-1].dest }}</div>
                    <div class="col-mono">{{ northboundList[i-1].time }}</div>
                    <div class="col-plat col-mono">{{ northboundList[i-1].plat }}</div>
                    <div class="col-free">{{ northboundList[i-1].free }}</div>
                    <div class="col-status status-ok">æº–é» On Time</div>
                    <div class="col-map">
                        <div class="map-wrapper">
                            <div class="map-line"></div>
                            <div v-for="s in stationsReversed" :key="s.id" class="station-node">
                                <div class="dot" :class="{ 'active': northboundList[i-1].stops.includes(s.id) }"></div>
                                <span class="st-code">{{ s.code }}</span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <div class="board-section south-section">
        <div class="header south">
            <div class="header-title">å—ä¸‹ Southbound</div>
            <div class="clock">{{ currentStationName }} {{ currentStationCode }}</div>
        </div>
        <div class="grid-row thead">
            <div>è»Šæ¬¡ Train</div>
            <div>é–‹å¾€ Dest.</div>
            <div>æ™‚é–“ Time</div>
            <div class="col-plat">æœˆå° Plat.</div>
            <div>è‡ªç”±åº§ Non-Res.</div>
            <div>ç‹€æ…‹ Status</div>
            <div>åœé ç«™ Stopping Stations</div>
        </div>
        <div class="data-list">
            <div v-for="i in 4" :key="'s'+i" class="grid-row data-row">
                <template v-if="southboundList[i-1]">
                    <div class="col-mono">{{ southboundList[i-1].trainNo }}</div>
                    <div class="col-dest">{{ southboundList[i-1].dest }}</div>
                    <div class="col-mono">{{ southboundList[i-1].time }}</div>
                    <div class="col-plat col-mono">{{ southboundList[i-1].plat }}</div>
                    <div class="col-free">{{ southboundList[i-1].free }}</div>
                    <div class="col-status status-ok">æº–é» On Time</div>
                    <div class="col-map">
                        <div class="map-wrapper">
                            <div class="map-line"></div>
                            <div v-for="s in stationsNormal" :key="s.id" class="station-node">
                                <div class="dot" :class="{ 'active': southboundList[i-1].stops.includes(s.id) }"></div>
                                <span class="st-code">{{ s.code }}</span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <div class="footer-bar">
        System Status: Normal | Data Source: Live API
        <span v-if="lastError" class="debug-hl">Last Error: {{ lastError }}</span>
        <span class="debug-hl" style="margin-left:auto;">[DEBUG] RAW KEYS: {{ debugKeys }}</span>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // === è¨­å®šå€ ===
            const API_URL = "https://thsr-proxy.xiaoyouwu5-fd3.workers.dev"; // ç¢ºèªæ‚¨çš„ Worker ä½å€
            const urlParams = new URLSearchParams(window.location.search);
            const stationID = ref(urlParams.get('station') || "1000"); // é è¨­å°åŒ—

            // === è®Šæ•¸ ===
            const rawData = ref([]);
            const currentTime = ref("00:00:00");
            const lastError = ref("");
            const debugKeys = ref("-");

            // === ç«™é»è³‡æ–™åº« (Index ç”¨æ–¼åˆ¤æ–·æ–¹å‘) ===
            // é †åºï¼šåŒ— -> å—
            const stations = [
                { id: "0990", name: "å—æ¸¯", code: "NAK", idx: 0 },
                { id: "1000", name: "å°åŒ—", code: "TPE", idx: 1 },
                { id: "1010", name: "æ¿æ©‹", code: "BAC", idx: 2 },
                { id: "1020", name: "æ¡ƒåœ’", code: "TAY", idx: 3 },
                { id: "1030", name: "æ–°ç«¹", code: "HSC", idx: 4 },
                { id: "1035", name: "è‹—æ —", code: "MIL", idx: 5 },
                { id: "1040", name: "å°ä¸­", code: "TAC", idx: 6 },
                { id: "1043", name: "å½°åŒ–", code: "CHA", idx: 7 },
                { id: "1047", name: "é›²æ—", code: "YUL", idx: 8 },
                { id: "1050", name: "å˜‰ç¾©", code: "CHY", idx: 9 },
                { id: "1060", name: "å°å—", code: "TNN", idx: 10 },
                { id: "1070", name: "å·¦ç‡Ÿ", code: "ZUY", idx: 11 }
            ];

            // å–å¾—ç•¶å‰ç«™é»è³‡è¨Š
            const curSt = computed(() => stations.find(s => s.id === stationID.value));
            const currentStationName = computed(() => curSt.value ? curSt.value.name : "æœªçŸ¥");
            const currentStationCode = computed(() => curSt.value ? curSt.value.code : "UNK");
            const currentStationIdx = computed(() => curSt.value ? curSt.value.idx : -1);

            // === è¼”åŠ©å‡½å¼ï¼šæ·±åº¦æœå°‹ (æš´åŠ›æ‰¾ Key) ===
            const findKey = (obj, keyword) => {
                if(!obj || typeof obj !== 'object') return null;
                const lowerKey = keyword.toLowerCase();
                
                // 1. æ·ºå±¤æœå°‹
                for(let k in obj) {
                    if(k.toLowerCase().includes(lowerKey)) return obj[k];
                }
                // 2. æ·±å±¤æœå°‹ (åŒ…åœ¨ GeneralTimetable æˆ–æ˜¯ DailyTrainInfo è£¡)
                for(let k in obj) {
                    if(typeof obj[k] === 'object') {
                        const res = findKey(obj[k], keyword);
                        if(res) return res;
                    }
                }
                return null;
            };

            // === æ ¸å¿ƒè³‡æ–™è™•ç† ===
            const processedTrains = computed(() => {
                const now = new Date();
                // æ ¼å¼åŒ– HH:MM (ç”¨æ–¼éæ¿¾éæœŸè»Šæ¬¡)
                const nowTime = now.toLocaleTimeString('en-GB', { hour12: false }).substring(0, 5);

                return rawData.value.map(t => {
                    // 1. æŠ“è»Šæ¬¡ (ä¿®æ­£ UNK)
                    let tNo = findKey(t, 'trainno') || "UNK";
                    
                    // 2. æŠ“æ™‚é–“
                    let tTime = findKey(t, 'departuretime') || findKey(t, 'time') || "00:00";
                    if(typeof tTime === 'string' && tTime.length > 5) tTime = tTime.substring(0, 5);

                    // 3. æŠ“ç›®çš„åœ°èˆ‡æ–¹å‘
                    // å˜—è©¦å¾å„å€‹å¯èƒ½æ¬„ä½æŠ“ç›®çš„åœ°åç¨±
                    let destRaw = t.DestinationStationName || t.destination || t.EndingStationName;
                    let destName = "";
                    
                    if(typeof destRaw === 'object') destName = destRaw.Zh_tw || destRaw.name || "æœªçŸ¥";
                    else if(typeof destRaw === 'string') destName = destRaw;
                    
                    // æ¸…ç†å­—ä¸² (å—æ¸¯ç«™ -> å—æ¸¯)
                    destName = destName.replace('ç«™', '').trim();

                    // === ğŸ”¥ æ–¹å‘åˆ¤æ–·é‚è¼¯ (Math Logic) ğŸ”¥ ===
                    // æ¯”è¼ƒã€Œç›®çš„åœ° Indexã€èˆ‡ã€Œç•¶å‰ Indexã€
                    let dir = -1; // -1: æœªçŸ¥, 0: å—ä¸‹, 1: åŒ—ä¸Š
                    
                    const destObj = stations.find(s => s.name === destName);
                    const curIdx = currentStationIdx.value;

                    if (destObj && curIdx !== -1) {
                        if (destObj.idx > curIdx) dir = 0; // ç›®çš„åœ°(6) > ç•¶å‰(1) = å¾€ä¸‹èµ° = å—ä¸‹
                        else if (destObj.idx < curIdx) dir = 1; // ç›®çš„åœ°(0) < ç•¶å‰(1) = å¾€ä¸Šèµ° = åŒ—ä¸Š
                    } else {
                        // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœæ‰¾ä¸åˆ° Index (ä¾‹å¦‚å›å» è»Š)ï¼Œç”¨ API çµ¦çš„ direction
                        let apiDir = findKey(t, 'direction');
                        if(apiDir !== null) dir = parseInt(apiDir);
                    }

                    // 4. å…¶ä»–
                    let plat = findKey(t, 'platform') || "1";
                    let stops = findKey(t, 'stopping_stations') || []; // é€™æ˜¯ ID é™£åˆ—

                    return {
                        trainNo: tNo,
                        time: tTime,
                        dest: destName,
                        plat: plat,
                        free: "10-12", // æš«æ™‚å¯«æ­»ï¼ŒAPI æœ‰çµ¦å†æ”¹
                        stops: stops,
                        dir: dir
                    };
                })
                .filter(t => t.time >= nowTime) // éæ¿¾å·²ç™¼è»Š
                .sort((a, b) => a.time.localeCompare(b.time));
            });

            // åˆ†æµ
            const northboundList = computed(() => processedTrains.value.filter(t => t.dir === 1));
            const southboundList = computed(() => processedTrains.value.filter(t => t.dir === 0));

            // API æŠ“å–
            const fetchData = async () => {
                try {
                    const res = await fetch(`${API_URL}/?station=${stationID.value}`);
                    const json = await res.json();
                    
                    let data = [];
                    if(Array.isArray(json)) data = json;
                    else if(json.trains) data = json.trains;
                    else if(json.data) data = json.data;

                    rawData.value = data;
                    lastError.value = "";

                    // Debug: å°å‡ºç¬¬ä¸€ç­†è³‡æ–™çš„ Key çµ¦ä½ çœ‹
                    if(data.length > 0) {
                        debugKeys.value = Object.keys(data[0]).join(", ");
                    }

                } catch (e) {
                    console.error(e);
                    lastError.value = e.message;
                }
            };

            // æ™‚é˜èˆ‡æ’ç¨‹
            setInterval(() => {
                currentTime.value = new Date().toLocaleTimeString('en-GB', { hour12: false });
            }, 1000);

            setInterval(fetchData, 30000);

            onMounted(() => {
                fetchData();
                currentTime.value = new Date().toLocaleTimeString('en-GB', { hour12: false });
            });

            return {
                currentTime, currentStationName, currentStationCode,
                northboundList, southboundList,
                stationsNormal: stations,
                stationsReversed: [...stations].reverse(),
                lastError, debugKeys
            };
        }
    }).mount('#app');
</script>

</body>
</html>