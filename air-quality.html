<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>空品測站影像</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); min-height: 100vh; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #9C27B0; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #9C27B0; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
        .back-btn:hover { background: #7B1FA2; }
        .loading { text-align: center; padding: 50px; color: white; font-size: 1.2rem; }
        .cameras-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        @media (max-width: 1200px) { .cameras-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .cameras-grid { grid-template-columns: 1fr; } }
        .camera-card { 
            background: white; 
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            cursor: pointer; 
            transition: transform 0.3s; 
            position: relative; 
        }
        .camera-card:hover { transform: translateY(-5px); }
        .camera-card h3 { color: #9C27B0; margin-bottom: 10px; font-size: 1.1rem; }
        .camera-card p { color: #666; margin: 5px 0; font-size: 0.9rem; }
        .station-image { 
            width: 100%; 
            height: 200px; 
            background: #f0f0f0; 
            border-radius: 8px; 
            overflow: hidden; 
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .station-image img { width: 100%; height: 100%; object-fit: cover; }
        .no-image { color: #999; text-align: center; padding: 60px 20px; }
        .status-badge { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            font-weight: bold; 
            color: white; 
        }
        .status-demo { background: #FF9800; }
        .status-live { background: #4CAF50; }
        .aqi-value { 
            display: inline-block; 
            padding: 8px 12px; 
            border-radius: 20px; 
            font-weight: bold; 
            min-width: 50px; 
            text-align: center; 
        }
        .pollutant-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            margin-top: 8px; 
        }
        .pollutant-item { 
            background: #f8f9fa; 
            padding: 6px 8px; 
            border-radius: 4px; 
            text-align: center; 
            font-size: 0.75rem; 
        }
        .pollutant-item .label { color: #666; font-weight: bold; }
        .pollutant-item .value { color: #333; font-weight: bold; margin-top: 2px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-wind"></i> 空品測站影像</h1>
            <p style="text-align: center; color: #666;">環境部空氣品質監測站影像</p>
        </div>
    </div>
    <div class="container">
        <!-- 快速切換導航列 -->
        <div style="background: white; padding: 15px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <a href="index.html" style="padding: 8px 16px; background: #9C27B0; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px;">
                    <i class="fas fa-home"></i> 首頁
                </a>
                <span style="color: #ddd;">|</span>
                <a href="road.html" style="padding: 8px 16px; background: #FF9800; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem;">
                    <i class="fas fa-road"></i> 公路監視器
                </a>
                <a href="highway.html" style="padding: 8px 16px; background: #2196F3; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem;">
                    <i class="fas fa-highway"></i> 高速公路
                </a>
                <a href="city.html" style="padding: 8px 16px; background: #4CAF50; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem;">
                    <i class="fas fa-city"></i> 市區監視器
                </a>
                <a href="debris-flow.html" style="padding: 8px 16px; background: #795548; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem;">
                    <i class="fas fa-mountain"></i> 土石流監測
                </a>
                <a href="air-quality.html" style="padding: 8px 16px; background: #7B1FA2; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem; border: 2px solid #9C27B0;">
                    <i class="fas fa-wind"></i> 空品測站 ✓
                </a>
            </div>
        </div>
        
        <!-- 資料來源說明 -->
        <div style="background: white; padding: 15px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="color: #9C27B0; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> 空品測站資料說明</h3>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="flex: 1;">
                    <p style="margin: 5px 0; color: #FF9800; font-weight: bold;" id="dataSourceInfo">
                        • 載入模擬資料中...
                    </p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="window.location.reload()" style="padding: 8px 16px; background: #9C27B0; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-sync-alt"></i> 重新載入
                    </button>
                </div>
            </div>
        </div>
        
        <div id="cameras-container" class="loading">載入中...</div>
    </div>

    <script>
        let isUsingRealData = false;
        
        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面載入完成，開始載入空品資料...');
            loadAirQualityData();
        });
        
        async function loadAirQualityData() {
            const container = document.getElementById('cameras-container');
            container.innerHTML = '<div class="loading">載入中...</div>';
            
            try {
                // 載入空品資料 API
                const aqResponse = await fetch('https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=e75b1660-e564-4107-aad5-a8be1f905dd9&limit=1000&sort=ImportDate%20desc&format=JSON');
                
                // 載入測站影像 API
                const imageResponse = await fetch('https://data.moenv.gov.tw/api/v2/aqx_p_548?api_key=846e44e1-8cc5-4893-ad87-c79d2d383706&limit=1000&sort=ImportDate%20desc&format=JSON');
                
                if (!aqResponse.ok || !imageResponse.ok) {
                    throw new Error('API 回應錯誤');
                }
                
                const aqData = await aqResponse.json();
                const imageData = await imageResponse.json();
                
                if (aqData && aqData.records && imageData && imageData.records) {
                    isUsingRealData = true;
                    document.getElementById('dataSourceInfo').innerHTML = '• 顯示即時空品資料（API 連線成功）';
                    document.getElementById('dataSourceInfo').style.color = '#4CAF50';
                    
                    // 合併空品資料和影像資料
                    const imageMap = {};
                    imageData.records.forEach(img => {
                        if (img.sitename) {
                            imageMap[img.sitename] = img.photourl || img.PhotoUrl || '';
                        }
                    });
                    
                    const mergedData = aqData.records.map(station => ({
                        ...station,
                        imageUrl: imageMap[station.sitename] || ''
                    }));
                    
                    console.log('真實資料載入成功:', mergedData.length, '個測站');
                    processAirQualityData(mergedData, container);
                    return;
                }
                
                throw new Error('無法獲取資料');
                
            } catch (error) {
                console.error('載入真實資料失敗:', error);
                loadMockData();
            }
        }
        
        function loadMockData() {
            console.log('載入模擬空品資料...');
            const container = document.getElementById('cameras-container');
            isUsingRealData = false;
            
            // 更新資料來源說明
            document.getElementById('dataSourceInfo').innerHTML = '• 顯示模擬空品資料（API 連線失敗）';
            document.getElementById('dataSourceInfo').style.color = '#FF9800';
            
            // 模擬空品監測站資料
            const mockStations = [
                {
                    sitename: '中山',
                    county: '臺北市',
                    aqi: '42',
                    status: '良好',
                    publishtime: new Date().toISOString(),
                    pm2_5: '15',
                    pm10: '28',
                    o3: '45',
                    co: '0.3',
                    so2: '2',
                    no2: '18',
                    siteid: 'TPE001',
                    imageUrl: 'https://images.unsplash.com/photo-1519501025264-65ba15a82390?w=800&h=600&fit=crop&auto=format'
                },
                {
                    sitename: '萬華',
                    county: '臺北市',
                    aqi: '58',
                    status: '普通',
                    publishtime: new Date(Date.now() - 1000*60*30).toISOString(),
                    pm2_5: '22',
                    pm10: '35',
                    o3: '38',
                    co: '0.4',
                    so2: '3',
                    no2: '25',
                    siteid: 'TPE002',
                    imageUrl: 'https://images.unsplash.com/photo-1513002749550-c59d786b8e6c?w=800&h=600&fit=crop&auto=format'
                },
                {
                    sitename: '古亭',
                    county: '臺北市',
                    aqi: '35',
                    status: '良好',
                    publishtime: new Date(Date.now() - 1000*60*15).toISOString(),
                    pm2_5: '12',
                    pm10: '22',
                    o3: '52',
                    co: '0.2',
                    so2: '1',
                    no2: '15',
                    siteid: 'TPE003',
                    imageUrl: 'https://images.unsplash.com/photo-1514565131-fce0801e5785?w=800&h=600&fit=crop&auto=format'
                },
                {
                    sitename: '松山',
                    county: '臺北市',
                    aqi: '48',
                    status: '良好',
                    publishtime: new Date().toISOString(),
                    pm2_5: '18',
                    pm10: '30',
                    o3: '42',
                    co: '0.3',
                    so2: '2',
                    no2: '20',
                    siteid: 'TPE004',
                    imageUrl: 'https://images.unsplash.com/photo-1496568816309-51d7c20e3b21?w=800&h=600&fit=crop&auto=format'
                },
                {
                    sitename: '板橋',
                    county: '新北市',
                    aqi: '61',
                    status: '普通',
                    publishtime: new Date(Date.now() - 1000*60*10).toISOString(),
                    pm2_5: '25',
                    pm10: '38',
                    o3: '37',
                    co: '0.4',
                    so2: '3',
                    no2: '28',
                    siteid: 'NTP001',
                    imageUrl: 'https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=800&h=600&fit=crop&auto=format'
                },
                {
                    sitename: '新莊',
                    county: '新北市',
                    aqi: '45',
                    status: '良好',
                    publishtime: new Date().toISOString(),
                    pm2_5: '16',
                    pm10: '28',
                    o3: '48',
                    co: '0.3',
                    so2: '2',
                    no2: '18',
                    siteid: 'NTP002',
                    imageUrl: 'https://images.unsplash.com/photo-1480714378408-67cf0d13bc1f?w=800&h=600&fit=crop&auto=format'
                }
            ];
            
            console.log('模擬資料包含', mockStations.length, '個測站');
            
            // 處理並顯示資料
            processAirQualityData(mockStations, container);
        }
        
        function processAirQualityData(stations, container) {
            console.log('開始處理空品資料:', stations.length, '個測站');
            
            const html = stations.map(station => {
                const name = station.sitename || '未命名測站';
                const county = station.county || '';
                const aqi = station.aqi || 'N/A';
                
                // 獲取 AQI 狀態顏色
                let aqiColor = '#999';
                let aqiStatus = '無資料';
                
                if (aqi && aqi !== 'N/A' && aqi !== '') {
                    const aqiNum = parseInt(aqi);
                    if (aqiNum <= 50) {
                        aqiColor = '#4CAF50';
                        aqiStatus = '良好';
                    } else if (aqiNum <= 100) {
                        aqiColor = '#FFEB3B';
                        aqiStatus = '普通';
                    } else if (aqiNum <= 150) {
                        aqiColor = '#FF9800';
                        aqiStatus = '對敏感族群不健康';
                    } else {
                        aqiColor = '#F44336';
                        aqiStatus = '不健康';
                    }
                }
                
                // 建立影像區塊
                const imageHtml = station.imageUrl ? 
                    `<div class="station-image">
                        <img src="${station.imageUrl}" alt="${name}測站影像" onerror="this.parentElement.innerHTML='<div class=\\'no-image\\'><i class=\\'fas fa-camera-slash\\'></i><br>影像載入失敗</div>'">
                    </div>` :
                    `<div class="station-image">
                        <div class="no-image">
                            <i class="fas fa-camera-slash"></i><br>
                            無影像資料
                        </div>
                    </div>`;
                
                // 建立污染物資訊
                const pollutantItems = [];
                if (station.pm2_5) pollutantItems.push(`<div class="pollutant-item"><div class="label">PM2.5</div><div class="value">${station.pm2_5}</div></div>`);
                if (station.pm10) pollutantItems.push(`<div class="pollutant-item"><div class="label">PM10</div><div class="value">${station.pm10}</div></div>`);
                if (station.o3) pollutantItems.push(`<div class="pollutant-item"><div class="label">O₃</div><div class="value">${station.o3}</div></div>`);
                
                return `
                    <div class="camera-card">
                        <div class="status-badge ${isUsingRealData ? 'status-live' : 'status-demo'}">${isUsingRealData ? '即時' : '模擬'}</div>
                        <h3><i class="fas fa-map-marker-alt"></i> ${name}</h3>
                        <p><i class="fas fa-map"></i> ${county}</p>
                        
                        ${imageHtml}
                        
                        <div style="margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 0.85rem; color: #666;">空氣品質指標</div>
                                    <div class="aqi-value" style="background: ${aqiColor}; color: white;">${aqi}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: ${aqiColor};">${aqiStatus}</div>
                                </div>
                            </div>
                            
                            ${pollutantItems.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                    <div style="font-size: 0.8rem; color: #666; margin-bottom: 6px;"><strong>污染物濃度</strong></div>
                                    <div class="pollutant-grid">
                                        ${pollutantItems.join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="cameras-grid">${html}</div>`;
            console.log('空品資料顯示完成');
        }
    </script>
</body>
</html>
