# ğŸŒ¤ï¸ ç©ºå“ API éƒ¨ç½²å®ŒæˆæŒ‡å—

**å®Œæˆæ—¥æœŸï¼š** 2025å¹´11æœˆ22æ—¥  
**ç‹€æ…‹ï¼š** âœ… å¾Œç«¯ç¨‹å¼ç¢¼å°±ç·’ï¼Œç­‰å¾… Cloudflare è¨­å®š

---

## ğŸ“‹ å·²å®Œæˆé …ç›®

### âœ… å‰ç«¯é é¢
- `air.html` - å®Œæ•´çš„ç©ºå“æˆ°æƒ…å®¤é é¢ (820 è¡Œ)
  - Leaflet åœ°åœ– + 400+ æ¸¬ç«™æ¨™è¨˜
  - å³æ™‚çµ±è¨ˆå„€è¡¨æ¿
  - æœå°‹å’Œç¯©é¸åŠŸèƒ½
  - å®Œå…¨éŸ¿æ‡‰å¼è¨­è¨ˆ

### âœ… å¾Œç«¯ API
- `functions/api/air-quality.js` - æ–°å»º
  - ç’°å¢ƒéƒ¨è³‡æ–™æ•´åˆ
  - 10 åˆ†é˜é‚Šç·£å¿«å–
  - è³‡æ–™æ¸…æ´— (éæ¿¾æ‰ç„¡æ•ˆæ¸¬ç«™)
  - CORS æ”¯æ´
  - è©³ç´°çš„éŒ¯èª¤è™•ç†

---

## ğŸš€ éƒ¨ç½²å‰çš„ä¸‰å€‹é—œéµæ­¥é©Ÿ

### Step 1ï¸âƒ£: è¨­å®šç’°å¢ƒè®Šæ•¸ (åœ¨ Cloudflare Dashboard)

**é€™æ˜¯å¿…è¦çš„ï¼ä¸åšé€™ä¸€æ­¥ API æœƒå ± 500 éŒ¯èª¤ã€‚**

1. é€²å…¥ **Cloudflare Pages** â†’ ä½ çš„å°ˆæ¡ˆ
2. é»é¸ **Settings** â†’ **Environment variables**
3. **æ–°å¢ç’°å¢ƒè®Šæ•¸ï¼š**
   ```
   è®Šæ•¸åç¨±: MOENV_API_KEY
   å€¼: [ä½ å¾ç’°å¢ƒéƒ¨ç”³è«‹çš„ API é‡‘é‘°]
   ```
4. **ç¢ºä¿é¸ä¸­ Production ç’°å¢ƒ**ï¼ˆä¸åªæ˜¯ Previewï¼‰
5. æŒ‰ **Save**

âœ… ç’°å¢ƒè®Šæ•¸ç¾åœ¨å·²è¨­å®šå®Œæˆã€‚

---

### Step 2ï¸âƒ£: å¾Œç«¯ç¨‹å¼ç¢¼å·²æº–å‚™å°±ç·’

æª”æ¡ˆè·¯å¾‘ï¼š`functions/api/air-quality.js`

ç¨‹å¼ç¢¼å·²ç¶“åŒ…å«ï¼š
- âœ… ç’°å¢ƒè®Šæ•¸è®€å–: `env.MOENV_API_KEY`
- âœ… 10 åˆ†é˜å¿«å–æ©Ÿåˆ¶
- âœ… è³‡æ–™æ¸…æ´—å’Œéæ¿¾
- âœ… éŒ¯èª¤è™•ç†
- âœ… CORS æ”¯æ´

ç„¡éœ€ä¿®æ”¹ï¼Œç›´æ¥éƒ¨ç½²ï¼

---

### Step 3ï¸âƒ£: è§¸ç™¼é‡æ–°éƒ¨ç½² (Redeploy)

**âš ï¸ é€™ä¸€æ­¥å¾ˆå®¹æ˜“å¿˜è¨˜ï¼**

ç‚ºä»€éº¼è¦ Redeployï¼Ÿ
- ä½ å‰›å‰›åœ¨ Step 1 æ”¹äº†ç’°å¢ƒè®Šæ•¸
- Cloudflare ä¸æœƒè‡ªå‹•å¥—ç”¨åˆ°ç¾åœ¨æ­£åœ¨è·‘çš„ç¶²ç«™ä¸Š
- éœ€è¦æ‰‹å‹•é‡æ–°éƒ¨ç½²ä¾†è®“ç’°å¢ƒè®Šæ•¸ç”Ÿæ•ˆ

**å¦‚ä½•é‡æ–°éƒ¨ç½²ï¼š**

1. é€²å…¥ Cloudflare Pages â†’ ä½ çš„å°ˆæ¡ˆ â†’ **Deployments**
2. æ‰¾åˆ°æœ€ä¸Šé¢é‚£æ¬¡éƒ¨ç½² (Latest deployment)
3. é»æ“Šå³é‚Šçš„ `â‹¯` (ä¸‰å€‹é») â†’ **Retry deployment**
4. ç­‰å¾…å¹¾ç§’é˜ï¼Œçœ‹è‘— Status è®Šç¶ ç‡ˆ âœ…

```
Status: âœ… Production (success)
```

éƒ¨ç½²å®Œæˆï¼

---

## ğŸ“¡ API ä½¿ç”¨æ–¹å¼

### ç«¯é»

```
GET /api/air-quality
```

### å›æ‡‰ç¯„ä¾‹

```json
[
  {
    "name": "æ¿æ©‹",
    "county": "æ–°åŒ—å¸‚",
    "aqi": 78,
    "status": "æ™®é€š",
    "pm25": 25.5,
    "pubtime": "2025-11-22T10:30:00Z",
    "lat": 25.0092,
    "lon": 121.4605
  },
  {
    "name": "å°åŒ—",
    "county": "å°åŒ—å¸‚",
    "aqi": 65,
    "status": "æ™®é€š",
    "pm25": 18.2,
    "pubtime": "2025-11-22T10:30:00Z",
    "lat": 25.0330,
    "lon": 121.5654
  },
  ...
]
```

### æ¸¬è©¦ API

åœ¨ç€è¦½å™¨ä¸»æ§å°åŸ·è¡Œï¼š

```javascript
// æ¸¬è©¦ API æ˜¯å¦æ­£å¸¸é‹ä½œ
fetch('/api/air-quality')
  .then(r => r.json())
  .then(data => {
    console.log(`âœ… æˆåŠŸè¼‰å…¥ ${data.length} å€‹æ¸¬ç«™`);
    console.log('ç¬¬ä¸€å€‹æ¸¬ç«™:', data[0]);
    console.log('å¹³å‡ AQI:', Math.round(data.reduce((sum, s) => sum + s.aqi, 0) / data.length));
  })
  .catch(e => console.error('âŒ API å¤±æ•—:', e.message));
```

### å¿«å–æª¢æŸ¥

æŸ¥çœ‹ HTTP éŸ¿æ‡‰é ­ï¼š

```bash
# åœ¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…· (F12) â†’ Network â†’ air-quality æŸ¥çœ‹ Response Headers
X-Cache: HIT        # è¡¨ç¤ºå¾å¿«å–è®€å–
X-Cache: MISS       # è¡¨ç¤ºå¾ç’°ä¿ç½²æ‹‰å–æœ€æ–°è³‡æ–™
Cache-Control: public, max-age=600, s-maxage=600
```

---

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### è³‡æ–™æµå‘

```
Cloudflare Pages (air.html)
    â†“
[ç€è¦½å™¨ç™¼é€ fetch]
    â†“
Cloudflare Edge (functions/api/air-quality.js)
    â”œâ”€ æª¢æŸ¥å¿«å– (10 åˆ†é˜) ?
    â”‚  â”œâ”€ YES â†’ ç›´æ¥å›å‚³ (æ¥µå¿«)
    â”‚  â””â”€ NO â†’ ç¹¼çºŒ Step 2
    â”œâ”€ è®€å–ç’°å¢ƒè®Šæ•¸: MOENV_API_KEY
    â”œâ”€ å‘¼å«ç’°ä¿ç½² API
    â”œâ”€ æ¸…æ´—è³‡æ–™ (ç§»é™¤ç„¡æ•ˆæ¸¬ç«™)
    â”œâ”€ å¯«å…¥å¿«å– (10 åˆ†é˜)
    â””â”€ å›å‚³æ¸…æ´—å¾Œçš„ JSON
    â†“
[ç€è¦½å™¨æ¥æ”¶ JSON]
    â†“
air.html ä¸­çš„ JavaScript
    â”œâ”€ ç¹ªè£½ Leaflet åœ°åœ–
    â”œâ”€ é¡¯ç¤ºçµ±è¨ˆæ•¸æ“š
    â””â”€ ç¶å®šæœå°‹åŠŸèƒ½
```

### å¿«å–ç­–ç•¥

| æƒ…æ³ | å›æ‡‰æ™‚é–“ | èªªæ˜ |
|------|---------|------|
| **å¿«å–å‘½ä¸­** | < 10ms | ç›´æ¥å¾ Cloudflare é‚Šç·£å¿«å–å›å‚³ |
| **å¿«å–éæœŸ** | 200-500ms | é‡æ–°å‘¼å«ç’°ä¿ç½² API |
| **ç’°ä¿ç½² API å¤±æ•—** | ç«‹å³å›å‚³éŒ¯èª¤ | ä½†å¯èƒ½ä¿ç•™ä¸Šä¸€æ¬¡çš„å¿«å–å‰¯æœ¬ |

### API Key å®‰å…¨

âœ… **å®‰å…¨åšæ³•** (æœ¬å°ˆæ¡ˆæ¡ç”¨)
- API Key åªå„²å­˜åœ¨ Cloudflare Dashboard
- ç¨‹å¼ç¢¼ä¸­ä¸æœƒå‡ºç¾ API Key
- å¯ä»¥éš¨æ™‚åœ¨ Dashboard æ›´æ›ï¼Œç„¡éœ€é‡æ–°éƒ¨ç½²

âŒ **å±éšªåšæ³•** (ä¸è¦é€™æ¨£åš)
- æŠŠ API Key ç¡¬ç·¨ç¢¼åœ¨ç¨‹å¼ç¢¼ä¸­
- åœ¨ç’°å¢ƒéƒ¨ç½²æª”æ¡ˆä¸­å…¬é–‹ API Key
- åœ¨å‰ç«¯ JavaScript ä¸­å…¬é–‹ API Key

---

## âš ï¸ å¸¸è¦‹å•é¡Œ

### Q: API å›å‚³ 500 éŒ¯èª¤ï¼Œæ€éº¼è¾¦ï¼Ÿ

**æª¢æŸ¥æ¸…å–®ï¼š**
1. âœ… æœ‰æ²’æœ‰åœ¨ Cloudflare Dashboard è¨­å®š `MOENV_API_KEY`ï¼Ÿ
2. âœ… æœ‰æ²’æœ‰æŒ‰ **Retry deployment**ï¼Ÿ
3. âœ… Deployment ç‹€æ…‹æ˜¯ä¸æ˜¯ç¶ ç‡ˆï¼Ÿ
4. âœ… API Key æ˜¯ä¸æ˜¯æ­£ç¢ºçš„ï¼Ÿ

**è¨ºæ–·æ­¥é©Ÿï¼š**
```javascript
// æª¢æŸ¥ API å›æ‡‰
fetch('/api/air-quality')
  .then(r => {
    console.log('ç‹€æ…‹ç¢¼:', r.status);
    console.log('å¿«å–ç‹€æ…‹:', r.headers.get('X-Cache'));
    return r.json();
  })
  .then(data => console.log('å›æ‡‰:', data))
  .catch(e => console.error('éŒ¯èª¤:', e));
```

### Q: API å¾ˆæ…¢ï¼Œæ€éº¼è¾¦ï¼Ÿ

**æ­£å¸¸æƒ…æ³ï¼š**
- ç¬¬ä¸€æ¬¡å‘¼å«: ~500ms (å¾ç’°ä¿ç½²æ‹‰è³‡æ–™)
- å¾ŒçºŒå‘¼å« (10 åˆ†é˜å…§): < 10ms (å¾å¿«å–è®€å–)

**å¦‚æœéƒ½å¾ˆæ…¢ï¼š**
- æª¢æŸ¥ç¶²éš›ç¶²è·¯é€£ç·š
- æª¢æŸ¥ç’°ä¿ç½² API æ˜¯å¦åœ¨ç·š
- é‡è©¦ä¸€æ¬¡ Deployment

### Q: air.html å‰ç«¯ä¸éœ€è¦æ”¹å—ï¼Ÿ

âœ… **å®Œå…¨ä¸éœ€è¦æ”¹ï¼**

ç‚ºä»€éº¼ï¼Ÿ
- air.html å·²ç¶“å…§å»ºç’°ä¿ç½² API çš„ fallback æ–¹æ¡ˆ
- å®ƒæœƒè‡ªå‹•å„ªå…ˆå‘¼å« `/api/air-quality` (Cloudflare å‡½æ•¸)
- å¦‚æœå¤±æ•—ï¼Œæœƒè‡ªå‹•è¼‰å…¥ç¤ºç¯„è³‡æ–™
- é›¶ä¿®æ”¹ï¼Œå³æ’å³ç”¨

---

## ğŸ“Š ç›£æ§å’Œèª¿è©¦

### åœ¨ Cloudflare Dashboard æŸ¥çœ‹æ—¥èªŒ

1. é€²å…¥ **Pages** â†’ ä½ çš„å°ˆæ¡ˆ â†’ **Workers**
2. é»é¸ **air-quality** å‡½æ•¸
3. é€²å…¥ **Real-time logs**
4. å¯ä»¥çœ‹åˆ°ï¼š
   ```
   [10:30:45] Air quality API: Fetched 400 valid stations
   [10:30:47] Air quality API: Fetched 400 valid stations (from cache)
   ```

### æª¢æŸ¥å¿«å–å‘½ä¸­ç‡

åœ¨ Cloudflare Dashboard çš„ **Analytics** åˆ†é æŸ¥çœ‹ï¼š
- **Cache Ratio** - æ‡‰è©² > 90%
- **Requests** - ç©ºå“ API çš„å‘¼å«æ¬¡æ•¸
- **Error Rate** - æ‡‰è©²æ¥è¿‘ 0%

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### ç«‹å³è¦åš
1. âœ… åœ¨ Cloudflare Dashboard è¨­å®š `MOENV_API_KEY` (Step 1)
2. âœ… æŒ‰ **Retry deployment** (Step 3)
3. âœ… æ¸¬è©¦ API: æ‰“é–‹ air.htmlï¼Œçœ‹çœ‹åœ°åœ–æ˜¯å¦æ­£å¸¸è¼‰å…¥

### æ¸¬è©¦å®Œæˆå¾Œ
- `git add functions/` 
- `git commit -m "feat: æ–°å¢ç©ºå“ API (functions/api/air-quality.js)"`
- `git push` å› GitHub
- Cloudflare æœƒè‡ªå‹•åµæ¸¬åˆ°è®Šæ›´ä¸¦é‡æ–°éƒ¨ç½²

### å¯é¸æ”¹é€²
- [ ] åŠ å…¥ç’°ä¿ç½² API çš„ retry æ©Ÿåˆ¶ (ç¾åœ¨åªè©¦ä¸€æ¬¡)
- [ ] ç›£æ§ API å¥åº·ç‹€æ…‹çš„ Dashboard
- [ ] è¨­ç½®å‘Šè­¦ï¼Œç•¶ API å¤±æ•—æ™‚é€šçŸ¥
- [ ] åˆ†æå¿«å–å‘½ä¸­ç‡ï¼Œå„ªåŒ–å¿«å–æ™‚é–“

---

## ğŸ“š ç›¸é—œè³‡æº

### æ–‡æª”
- `air.html` - å‰ç«¯é é¢ (820 è¡Œ)
- `functions/api/air-quality.js` - å¾Œç«¯ API (180 è¡Œ)
- `AIR_DASHBOARD_MIGRATION.md` - ç³»çµ±é·ç§»å ±å‘Š

### å¤–éƒ¨ API
- **ç’°ä¿ç½²é–‹æ”¾è³‡æ–™å¹³å°:** https://data.moenv.gov.tw/
- **API æ–‡æª”:** https://data.moenv.gov.tw/ (AQX_P_432)

### Cloudflare æ–‡æª”
- **Pages Functions:** https://developers.cloudflare.com/pages/platform/functions/
- **å¿«å– API:** https://developers.cloudflare.com/workers/runtime-apis/cache/
- **ç’°å¢ƒè®Šæ•¸:** https://developers.cloudflare.com/pages/configuration/build-configuration/

---

## âœ¨ å®Œæˆæª¢æŸ¥æ¸…å–®

åœ¨éƒ¨ç½²å‰ï¼Œç¢ºä¿å®Œæˆä»¥ä¸‹é …ç›®ï¼š

```
â–¡ å‰ç«¯é é¢ air.html å·²å»ºç«‹
â–¡ å¾Œç«¯ API air-quality.js å·²å»ºç«‹
â–¡ å·²åœ¨ Cloudflare Dashboard è¨­å®š MOENV_API_KEY
â–¡ å·²æŒ‰ Retry deployment
â–¡ Deployment ç‹€æ…‹å·²è®Šç¶ ç‡ˆ âœ…
â–¡ åœ¨ç€è¦½å™¨ä¸»æ§å°æ¸¬è©¦äº† API
â–¡ air.html å¯ä»¥æ­£å¸¸è¼‰å…¥åœ°åœ–
â–¡ ç¨‹å¼ç¢¼å·² git push åˆ° GitHub
```

---

**éƒ¨ç½²å®Œæˆï¼ç¥ä½ çš„ç©ºå“æˆ°æƒ…å®¤é‹ç‡Ÿé †åˆ©ï¼ğŸš€**

---

**æŠ€è¡“æ£§ï¼š**
- å‰ç«¯ï¼šHTML5 + CSS3 + JavaScript + Leaflet.js
- å¾Œç«¯ï¼šCloudflare Pages Functions
- è³‡æ–™ä¾†æºï¼šç’°å¢ƒéƒ¨é–‹æ”¾è³‡æ–™å¹³å°
- å¿«å–ï¼šCloudflare Edge Cache (10 åˆ†é˜)
- éƒ¨ç½²ç’°å¢ƒï¼šCloudflare Pages (å…¨çƒé‚Šç·£ç¯€é»)

**ç¶­è­·è€…ï¼š** GitHub Copilot  
**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´11æœˆ22æ—¥
