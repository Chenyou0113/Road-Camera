<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµå³æ™‚åˆ°é›¢ç«™çœ‹æ¿ - TDX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <script>window.CURRENT_PAGE = 'train-liveboard';</script>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script src="assets/train-line-classification.js"></script>
    <script src="assets/train-data-transformer.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #1e40af 0%, #0891b2 100%); 
            min-height: 100vh; 
        }
        .header { 
            background: white; 
            padding: 20px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 0 20px; 
        }
        .header h1 { 
            color: #1e40af; 
            text-align: center; 
            margin-bottom: 10px; 
        }
        .header p {
            text-align: center;
            color: #666;
            font-size: 0.95rem;
        }
        .back-btn { 
            display: inline-block; 
            padding: 10px 20px; 
            background: #1e40af; 
            color: white; 
            text-decoration: none; 
            border-radius: 5px; 
            margin: 20px 0; 
            transition: background 0.3s;
        }
        .back-btn:hover { 
            background: #0891b2; 
        }
        .loading { 
            text-align: center; 
            padding: 50px; 
            color: white; 
            font-size: 1.2rem; 
        }
        
        /* è»Šç«™é¸æ“‡å€åŸŸ */
        .station-selector { 
            background: white; 
            margin: 20px 0; 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .station-selector h3 { 
            color: #1e40af; 
            margin-bottom: 15px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .selector-row { 
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px; 
            align-items: end;
        }
        .selector-group { 
            display: flex; 
            flex-direction: column; 
        }
        .selector-group label { 
            margin-bottom: 8px; 
            font-weight: bold; 
            color: #333; 
        }
        .selector-group select { 
            padding: 12px; 
            border-radius: 8px; 
            border: 2px solid #1e40af; 
            font-size: 1rem; 
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        .selector-group select:hover {
            border-color: #0891b2;
        }
        .selector-group select:focus {
            outline: none;
            border-color: #0891b2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }
        .selector-group button { 
            padding: 12px 25px; 
            background: #1e40af; 
            color: white; 
            cursor: pointer; 
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        .selector-group button:hover { 
            background: #0891b2; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .selector-group button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* åˆ—è»Šçœ‹æ¿å€åŸŸ */
        .liveboard-container {
            background: white;
            margin: 20px 0;
            padding: 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .liveboard-header {
            background: linear-gradient(135deg, #1e40af 0%, #0891b2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .liveboard-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .update-time {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* åˆ—è»Šè¡¨æ ¼ */
        .train-table {
            width: 100%;
            border-collapse: collapse;
        }
        .train-table thead {
            background: #f8f9fa;
        }
        .train-table th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            color: #1e40af;
            border-bottom: 2px solid #1e40af;
        }
        .train-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        .train-table tbody tr:hover {
            background: #f8f9fa;
        }
        .train-number {
            font-weight: bold;
            color: #1e40af;
            font-size: 1.1rem;
        }
        .train-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-right: 8px;
        }
        .train-type.express { background: #ff6b6b; color: white; }
        .train-type.local { background: #4ecdc4; color: white; }
        .train-type.limited { background: #ffd93d; color: #333; }
        .train-type.chu-kuang { background: #ff8c42; color: white; }
        .train-type.tze-chiang { background: #e74c3c; color: white; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .status-badge.ontime { background: #27ae60; color: white; }
        .status-badge.delayed { background: #e74c3c; color: white; }
        .status-badge.early { background: #3498db; color: white; }
        
        .direction-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            background: #1e40af;
            color: white;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        /* çµ±è¨ˆé¢æ¿ */
        .stats-panel { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .stat-number { 
            font-size: 2rem; 
            font-weight: bold; 
            color: #1e40af; 
        }
        .stat-label { 
            color: #666; 
            margin-top: 5px; 
        }
        
        /* è³‡è¨Šé¢æ¿ */
        .info-panel {
            background: #e8f5e8;
            border-left: 4px solid #1e40af;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .info-panel h3 {
            color: #1e40af;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .info-panel p {
            color: #333;
            line-height: 1.6;
            margin: 10px 0;
        }
        
        /* æ·±è‰²æ¨¡å¼ */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        body.dark-mode .header {
            background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        body.dark-mode .header h1 {
            color: #66BB6A;
        }
        body.dark-mode .header p {
            color: rgba(255,255,255,0.7);
        }
        body.dark-mode .back-btn {
            background: #66BB6A;
            color: #1a1a2e;
        }
        body.dark-mode .back-btn:hover {
            background: #81C784;
        }
        body.dark-mode .station-selector {
            background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }
        body.dark-mode .station-selector h3 {
            color: #66BB6A;
        }
        body.dark-mode .selector-group label {
            color: rgba(255,255,255,0.9);
        }
        body.dark-mode .selector-group select {
            background: rgba(255,255,255,0.1);
            color: white;
            border-color: #66BB6A;
        }
        body.dark-mode .selector-group select option {
            background: #2a2a3e;
            color: white;
        }
        body.dark-mode .selector-group button {
            background: #66BB6A;
            color: #1a1a2e;
        }
        body.dark-mode .selector-group button:hover {
            background: #81C784;
        }
        body.dark-mode .liveboard-container {
            background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }
        body.dark-mode .liveboard-header {
            background: linear-gradient(135deg, #66BB6A 0%, #81C784 100%);
            color: #1a1a2e;
        }
        body.dark-mode .train-table thead {
            background: rgba(102, 187, 106, 0.1);
        }
        body.dark-mode .train-table th {
            color: #66BB6A;
            border-bottom-color: #66BB6A;
        }
        body.dark-mode .train-table td {
            color: rgba(255,255,255,0.9);
            border-bottom-color: rgba(255,255,255,0.1);
        }
        body.dark-mode .train-table tbody tr:hover {
            background: rgba(102, 187, 106, 0.1);
        }
        body.dark-mode .train-number {
            color: #66BB6A;
        }
        body.dark-mode .stat-card {
            background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }
        body.dark-mode .stat-number {
            color: #66BB6A;
        }
        body.dark-mode .stat-label {
            color: rgba(255,255,255,0.7);
        }
        body.dark-mode .info-panel {
            background: rgba(40,40,50,0.95);
            border-left-color: #66BB6A;
        }
        body.dark-mode .info-panel h3 {
            color: #66BB6A;
        }
        body.dark-mode .info-panel p {
            color: rgba(255,255,255,0.8);
        }
        body.dark-mode .no-data {
            color: rgba(255,255,255,0.5);
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .selector-row {
                grid-template-columns: 1fr;
            }
            .train-table {
                font-size: 0.9rem;
            }
            .train-table th,
            .train-table td {
                padding: 10px 8px;
            }
            .stats-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-panel {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
    <!-- è¼‰å…¥é€²åº¦æ¢ -->
    <script src="assets/loading-progress.js"></script>
    <script>
        window.AUTO_START_LOADING = false;
        
        window.addEventListener('DOMContentLoaded', () => {
            window.startLoading({
                labelText: 'åˆå§‹åŒ–å°éµå³æ™‚çœ‹æ¿...',
                color: '#1e40af',
                showLabel: true
            });
        });
    </script>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-train"></i> å°éµå³æ™‚åˆ°é›¢ç«™çœ‹æ¿</h1>
            <p>å³æ™‚æŸ¥è©¢è»Šç«™åˆ—è»Šåˆ°é›¢ç«™è³‡è¨Šï¼ˆå‹•æ…‹å‰å¾Œ30åˆ†é˜ï¼‰</p>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é </a>
            <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode" style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #1e40af, #0891b2); color: white; border: none; cursor: pointer; margin-left: 15px; font-size: 1.2rem;">
                <i class="fas fa-moon"></i>
            </button>
        
        <!-- è³‡è¨Šé¢æ¿ -->
        <div class="info-panel" id="infoPanel">
            <h3 onclick="toggleInfoPanel()">
                <span>
                    <i class="fas fa-info-circle"></i>
                    TDX å°éµå³æ™‚çœ‹æ¿èªªæ˜
                </span>
                <i id="toggleIcon" class="fas fa-chevron-up" style="transition: transform 0.3s ease;"></i>
            </h3>
            <div id="infoContent">
                <p>
                    <strong>ğŸ“Š è³‡æ–™ä¾†æºï¼š</strong>äº¤é€šéƒ¨ TDX äº¤é€šè³‡æ–™æµé€šæœå‹™å¹³å°
                </p>
                <p>
                    <strong>ğŸ”„ æ›´æ–°é »ç‡ï¼š</strong>æ¯ 2 åˆ†é˜æ›´æ–°ä¸€æ¬¡
                </p>
                <p>
                    <strong>â° é¡¯ç¤ºç¯„åœï¼š</strong>ç•¶å‰æ™‚é–“å‰å¾Œ 30 åˆ†é˜å…§çš„åˆ—è»Šè³‡è¨Š
                </p>
                <p>
                    <strong>â„¹ï¸ æ³¨æ„äº‹é …ï¼š</strong>æœ¬è³‡æ–™å·²éæ¿¾å·²é›¢ç«™è»Šæ¬¡ï¼Œåƒ…é¡¯ç¤ºå³å°‡åˆ°ç«™åŠå°šæœªé›¢ç«™çš„åˆ—è»Š
                </p>
                <p style="margin-top: 15px;">
                    ğŸ”— <a href="https://tdx.transportdata.tw" target="_blank" style="color: #1e40af; text-decoration: none;">
                        TDX äº¤é€šè³‡æ–™æµé€šæœå‹™å¹³å° <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                    </a>
                </p>
            </div>
        </div>

        <!-- çµ±è¨ˆé¢æ¿ -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-number" id="totalTrains">0</div>
                <div class="stat-label">åˆ—è»Šç¸½æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="arrivalTrains">0</div>
                <div class="stat-label">å³å°‡åˆ°ç«™</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="departureTrains">0</div>
                <div class="stat-label">å³å°‡é›¢ç«™</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="delayedTrains">0</div>
                <div class="stat-label">å»¶èª¤åˆ—è»Š</div>
            </div>
        </div>

        <!-- è»Šç«™é¸æ“‡ -->
        <div class="station-selector">
            <h3><i class="fas fa-map-marker-alt"></i> é¸æ“‡è»Šç«™</h3>
            <div class="selector-row">
                <div class="selector-group">
                    <label for="lineSelect">è·¯ç·š</label>
                    <select id="lineSelect" onchange="onLineChange()">
                        <option value="">è«‹é¸æ“‡è·¯ç·š</option>
                        <option value="all">å…¨éƒ¨è»Šç«™</option>
                        <option value="westernMain">è¥¿éƒ¨å¹¹ç·š</option>
                        <option value="westernCoast">è¥¿éƒ¨å¹¹ç·š-æµ·ç·š</option>
                        <option value="easternMain">æ±éƒ¨å¹¹ç·š</option>
                        <option value="southLink">å±æ±-å—è¿´ç·š</option>
                        <option value="pingxiLine">å¹³æºªç·š</option>
                        <option value="neiwanLine">å…§ç£ç·š</option>
                        <option value="jijiLine">é›†é›†ç·š</option>
                        <option value="chengzhuiLine">æˆè¿½ç·š</option>
                        <option value="shalunLine">æ²™å´™ç·š</option>
                        <option value="liujiaLine">å…­å®¶ç·š</option>
                        <option value="shenaLine">æ·±æ¾³ç·š</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label for="stationSelect">è»Šç«™</label>
                    <select id="stationSelect">
                        <option value="">è«‹å…ˆé¸æ“‡è·¯ç·š</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label>&nbsp;</label>
                    <button onclick="queryLiveboard()" id="queryBtn">
                        <i class="fas fa-search"></i> æŸ¥è©¢çœ‹æ¿
                    </button>
                </div>
            </div>
        </div>

        <!-- çœ‹æ¿å®¹å™¨ -->
        <div id="liveboardContainer" style="display: none;">
            <div class="liveboard-container">
                <div class="liveboard-header">
                    <h2 id="stationTitle">
                        <i class="fas fa-train"></i>
                        <span id="stationName">é¸æ“‡è»Šç«™</span>
                    </h2>
                    <div class="update-time">
                        <i class="fas fa-clock"></i> æ›´æ–°æ™‚é–“ï¼š<span id="updateTime">--</span>
                    </div>
                </div>
                <table class="train-table">
                    <thead>
                        <tr>
                            <th>è»Šæ¬¡</th>
                            <th>è»Šç¨®</th>
                            <th>æ–¹å‘</th>
                            <th>çµ‚é»ç«™</th>
                            <th>é è¨ˆåˆ°ç«™</th>
                            <th>é è¨ˆé›¢ç«™</th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="trainTableBody">
                        <tr>
                            <td colspan="7" class="no-data">
                                <i class="fas fa-train"></i>
                                <p>è«‹é¸æ“‡è»Šç«™ä¸¦æŸ¥è©¢</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        // å°éµè»Šç«™è³‡æ–™ï¼ˆå…§åµŒï¼‰
        const stationData = {
            western: [
                {name:"åŸºéš†",code:"0900"},{name:"ä¸‰å‘",code:"0910"},{name:"å…«å µ",code:"0920"},{name:"ä¸ƒå µ",code:"0930"},{name:"ç™¾ç¦",code:"0940"},{name:"äº”å µ",code:"0950"},{name:"æ±æ­¢",code:"0960"},{name:"æ±ç§‘",code:"0970"},{name:"å—æ¸¯",code:"0980"},{name:"æ¾å±±",code:"0990"},{name:"è‡ºåŒ—",code:"1000"},{name:"è¬è¯",code:"1010"},{name:"æ¿æ©‹",code:"1020"},{name:"æµ®æ´²",code:"1030"},{name:"æ¨¹æ—",code:"1040"},{name:"å—æ¨¹æ—",code:"1050"},{name:"å±±ä½³",code:"1060"},{name:"é¶¯æ­Œ",code:"1070"},{name:"æ¡ƒåœ’",code:"1080"},{name:"å…§å£¢",code:"1090"},{name:"ä¸­å£¢",code:"1100"},{name:"åŸ”å¿ƒ",code:"1110"},{name:"æ¥Šæ¢…",code:"1120"},{name:"å¯Œå²¡",code:"1130"},{name:"æ–°å¯Œ",code:"1140"},{name:"åŒ—æ¹–",code:"1150"},{name:"æ¹–å£",code:"1160"},{name:"æ–°è±",code:"1170"},{name:"ç«¹åŒ—",code:"1180"},{name:"åŒ—æ–°ç«¹",code:"1190"},{name:"æ–°ç«¹",code:"1210"},{name:"ä¸‰å§“æ©‹",code:"1220"},{name:"é¦™å±±",code:"1230"},{name:"å´é ‚",code:"1240"},{name:"ç«¹å—",code:"1250"},{name:"é€ æ©‹",code:"3140"},{name:"è±å¯Œ",code:"3150"},{name:"è‹—æ —",code:"3160"},{name:"å—å‹¢",code:"3170"},{name:"éŠ…é‘¼",code:"3180"},{name:"ä¸‰ç¾©",code:"3190"},{name:"æ³°å®‰",code:"3210"},{name:"åé‡Œ",code:"3220"},{name:"è±åŸ",code:"3230"},{name:"æ —æ—",code:"3240"},{name:"æ½­å­",code:"3250"},{name:"é ­å®¶å",code:"3260"},{name:"æ¾ç«¹",code:"3270"},{name:"å¤ªåŸ",code:"3280"},{name:"ç²¾æ­¦",code:"3290"},{name:"è‡ºä¸­",code:"3300"},{name:"äº”æ¬Š",code:"3310"},{name:"å¤§æ…¶",code:"3320"},{name:"çƒæ—¥",code:"3330"},{name:"æ–°çƒæ—¥",code:"3340"},{name:"æˆåŠŸ",code:"3350"},{name:"å½°åŒ–",code:"3360"},{name:"èŠ±å£‡",code:"3370"},{name:"å¤§æ‘",code:"3380"},{name:"å“¡æ—",code:"3390"},{name:"æ°¸é–",code:"3400"},{name:"ç¤¾é ­",code:"3410"},{name:"ç”°ä¸­",code:"3420"},{name:"äºŒæ°´",code:"3430"},{name:"æ—å…§",code:"3450"},{name:"çŸ³æ¦´",code:"3460"},{name:"æ–—å…­",code:"3470"},{name:"æ–—å—",code:"3480"},{name:"çŸ³é¾œ",code:"3490"},{name:"å¤§æ—",code:"4050"},{name:"æ°‘é›„",code:"4060"},{name:"å˜‰åŒ—",code:"4070"},{name:"å˜‰ç¾©",code:"4080"},{name:"æ°´ä¸Š",code:"4090"},{name:"å—é–",code:"4100"},{name:"å¾Œå£",code:"4110"},{name:"æ–°ç‡Ÿ",code:"4120"},{name:"æŸ³ç‡Ÿ",code:"4130"},{name:"æ—é³³ç‡Ÿ",code:"4140"},{name:"éš†ç”°",code:"4150"},{name:"æ‹”æ—",code:"4160"},{name:"å–„åŒ–",code:"4170"},{name:"å—ç§‘",code:"4180"},{name:"æ–°å¸‚",code:"4190"},{name:"æ°¸åº·",code:"4200"},{name:"å¤§æ©‹",code:"4210"},{name:"è‡ºå—",code:"4220"},{name:"æ—æ£®",code:"4230"},{name:"å—è‡ºå—",code:"4240"},{name:"ä¿å®‰",code:"4250"},{name:"ä»å¾·",code:"4260"},{name:"ä¸­æ´²",code:"4270"},{name:"å¤§æ¹–",code:"4290"},{name:"è·¯ç«¹",code:"4300"},{name:"å²¡å±±",code:"4310"},{name:"æ©‹é ­",code:"4320"},{name:"æ¥ æ¢“",code:"4330"},{name:"æ–°å·¦ç‡Ÿ",code:"4340"},{name:"å·¦ç‡Ÿ",code:"4350"},{name:"å…§æƒŸ",code:"4360"},{name:"ç¾è¡“é¤¨",code:"4370"},{name:"é¼“å±±",code:"4380"},{name:"ä¸‰å¡Šå",code:"4390"},{name:"é«˜é›„",code:"4400"},{name:"æ°‘æ—",code:"4410"},{name:"ç§‘å·¥é¤¨",code:"4420"},{name:"æ­£ç¾©",code:"4430"},{name:"é³³å±±",code:"4440"},{name:"å¾Œåº„",code:"4450"},{name:"ä¹æ›²å ‚",code:"4460"},{name:"å…­å¡Šå",code:"4470"},{name:"å±æ±",code:"5000"}
            ],
            coastal: [
                {name:"è«‡æ–‡",code:"2110"},{name:"å¤§å±±",code:"2120"},{name:"å¾Œé¾",code:"2130"},{name:"é¾æ¸¯",code:"2140"},{name:"ç™½æ²™å±¯",code:"2150"},{name:"æ–°åŸ”",code:"2160"},{name:"é€šéœ„",code:"2170"},{name:"è‹‘è£¡",code:"2180"},{name:"æ—¥å—",code:"2190"},{name:"å¤§ç”²",code:"2200"},{name:"è‡ºä¸­æ¸¯",code:"2210"},{name:"æ¸…æ°´",code:"2220"},{name:"æ²™é¹¿",code:"2230"},{name:"é¾äº•",code:"2240"},{name:"å¤§è‚š",code:"2250"},{name:"è¿½åˆ†",code:"2260"}
            ],
            eastern: [
                {name:"å…«å µ",code:"0920"},{name:"æš–æš–",code:"7390"},{name:"å››è…³äº­",code:"7380"},{name:"ç‘èŠ³",code:"7360"},{name:"çŒ´ç¡",code:"7350"},{name:"ä¸‰è²‚å¶º",code:"7330"},{name:"ç‰¡ä¸¹",code:"7320"},{name:"é›™æºª",code:"7310"},{name:"è²¢å¯®",code:"7300"},{name:"ç¦éš†",code:"7290"},{name:"çŸ³åŸ",code:"7280"},{name:"å¤§é‡Œ",code:"7270"},{name:"å¤§æºª",code:"7260"},{name:"é¾œå±±",code:"7250"},{name:"å¤–æ¾³",code:"7240"},{name:"é ­åŸ",code:"7230"},{name:"é ‚åŸ”",code:"7220"},{name:"ç¤æºª",code:"7210"},{name:"å››åŸ",code:"7200"},{name:"å®œè˜­",code:"7190"},{name:"äºŒçµ",code:"7180"},{name:"ä¸­é‡Œ",code:"7170"},{name:"ç¾…æ±",code:"7160"},{name:"å†¬å±±",code:"7150"},{name:"æ–°é¦¬",code:"7140"},{name:"è˜‡æ¾³æ–°ç«™",code:"7130"},{name:"è˜‡æ¾³",code:"7120"},{name:"æ°¸æ¨‚",code:"7110"},{name:"æ±æ¾³",code:"7100"},{name:"å—æ¾³",code:"7090"},{name:"æ­¦å¡”",code:"7080"},{name:"æ¼¢æœ¬",code:"7070"},{name:"å’Œå¹³",code:"7060"},{name:"å’Œä»",code:"7050"},{name:"å´‡å¾·",code:"7040"},{name:"æ–°åŸ",code:"7030"},{name:"æ™¯ç¾",code:"7020"},{name:"åŒ—åŸ”",code:"7010"},{name:"èŠ±è“®",code:"7000"},{name:"å‰å®‰",code:"6250"},{name:"å¿—å­¸",code:"6240"},{name:"å¹³å’Œ",code:"6230"},{name:"å£½è±",code:"6220"},{name:"è±ç”°",code:"6210"},{name:"æ—æ¦®æ–°å…‰",code:"6200"},{name:"å—å¹³",code:"6190"},{name:"é³³æ—",code:"6180"},{name:"è¬æ¦®",code:"6170"},{name:"å…‰å¾©",code:"6160"},{name:"å¤§å¯Œ",code:"6150"},{name:"å¯Œæº",code:"6140"},{name:"ç‘ç©—",code:"6130"},{name:"ä¸‰æ°‘",code:"6120"},{name:"ç‰é‡Œ",code:"6110"},{name:"æ±é‡Œ",code:"6100"},{name:"æ±ç«¹",code:"6090"},{name:"å¯Œé‡Œ",code:"6080"},{name:"æ± ä¸Š",code:"6070"},{name:"æµ·ç«¯",code:"6060"},{name:"é—œå±±",code:"6050"},{name:"ç‘å’Œ",code:"6040"},{name:"ç‘æº",code:"6030"},{name:"é¹¿é‡",code:"6020"},{name:"å±±é‡Œ",code:"6010"},{name:"è‡ºæ±",code:"6000"}
            ],
            southLink: [
                {name:"å±æ±",code:"5000"},{name:"æ­¸ä¾†",code:"5010"},{name:"éºŸæ´›",code:"5020"},{name:"è¥¿å‹¢",code:"5030"},{name:"ç«¹ç”°",code:"5040"},{name:"æ½®å·",code:"5050"},{name:"å´é ‚",code:"5060"},{name:"å—å·",code:"5070"},{name:"é®å®‰",code:"5080"},{name:"æ—é‚Š",code:"5090"},{name:"ä½³å†¬",code:"5100"},{name:"æ±æµ·",code:"5110"},{name:"æ‹å¯®",code:"5120"},{name:"åŠ ç¥¿",code:"5130"},{name:"å…§ç…",code:"5140"},{name:"æ‹å±±",code:"5160"},{name:"å¤§æ­¦",code:"5190"},{name:"ç€§æºª",code:"5200"},{name:"é‡‘å´™",code:"5210"},{name:"å¤ªéº»é‡Œ",code:"5220"},{name:"çŸ¥æœ¬",code:"5230"},{name:"åº·æ¨‚",code:"5240"},{name:"è‡ºæ±",code:"6000"}
            ]
        };
        
        let stationsByLine = {};
        let allStations = [];
        let currentStationId = '';
        let currentStationName = '';
        let autoRefreshInterval = null;

        // è¼‰å…¥è»Šç«™ä»£ç¢¼è³‡æ–™ï¼ˆä½¿ç”¨æ–°çš„è·¯ç·šåˆ†é¡ç³»çµ±ï¼‰
        function loadStationData() {
            console.log('è¼‰å…¥è·¯ç·šåˆ†é¡è³‡æ–™');
            
            // ä½¿ç”¨æ–°çš„è·¯ç·šåˆ†é¡ç³»çµ±
            if (typeof trainLineClassification !== 'undefined') {
                // å°‡è·¯ç·šåˆ†é¡è½‰æ›ç‚ºé é¢ä½¿ç”¨çš„æ ¼å¼
                stationsByLine = {};
                for (const [lineKey, lineData] of Object.entries(trainLineClassification)) {
                    stationsByLine[lineKey] = lineData.stations.map(s => ({
                        id: s.code, 
                        name: s.name
                    }));
                }
                
                initAllStations();
                console.log('è»Šç«™è³‡æ–™è¼‰å…¥å®Œæˆï¼Œç¸½å…±', allStations.length, 'å€‹è»Šç«™');
                console.log('è·¯ç·šæ•¸é‡:', Object.keys(stationsByLine).length);
            } else {
                console.error('trainLineClassification æœªè¼‰å…¥');
            }
        }

        // åˆå§‹åŒ–æ‰€æœ‰è»Šç«™åˆ—è¡¨
        function initAllStations() {
            const stationSet = new Map(); // ä½¿ç”¨ Map ä¾†å»é‡
            
            for (const lineData of Object.values(stationsByLine)) {
                for (const station of lineData) {
                    if (!stationSet.has(station.id)) {
                        stationSet.set(station.id, station);
                    }
                }
            }
            
            allStations = Array.from(stationSet.values());
            allStations.sort((a, b) => a.id.localeCompare(b.id));
        }

        // è·¯ç·šè®Šæ›´äº‹ä»¶
        function onLineChange() {
            const lineSelect = document.getElementById('lineSelect');
            const stationSelect = document.getElementById('stationSelect');
            const selectedLine = lineSelect.value;

            if (!selectedLine) {
                stationSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡è·¯ç·š</option>';
                return;
            }

            let stations = [];
            if (selectedLine === 'all') {
                stations = allStations;
            } else if (stationsByLine[selectedLine]) {
                stations = stationsByLine[selectedLine];
            }
            
            stationSelect.innerHTML = '<option value="">è«‹é¸æ“‡è»Šç«™</option>' +
                stations.map(station => 
                    `<option value="${station.id}">${station.name}</option>`
                ).join('');
                
            console.log(`å·²è¼‰å…¥ ${stations.length} å€‹${selectedLine === 'all' ? 'å…¨éƒ¨' : trainLineClassification[selectedLine]?.name || selectedLine}è»Šç«™`);
        }

        // æŸ¥è©¢çœ‹æ¿
        async function queryLiveboard() {
            const stationSelect = document.getElementById('stationSelect');
            const selectedStationId = stationSelect.value;
            
            if (!selectedStationId) {
                alert('è«‹é¸æ“‡è»Šç«™');
                return;
            }

            currentStationId = selectedStationId;
            currentStationName = stationSelect.options[stationSelect.selectedIndex].text;

            await loadLiveboard();
            
            // å•Ÿå‹•è‡ªå‹•åˆ·æ–°ï¼ˆæ¯2åˆ†é˜ï¼‰
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(loadLiveboard, 120000);
        }

        // è¼‰å…¥çœ‹æ¿è³‡æ–™
        async function loadLiveboard() {
            const container = document.getElementById('liveboardContainer');
            const stationTitle = document.getElementById('stationName');
            const tableBody = document.getElementById('trainTableBody');
            
            stationTitle.textContent = currentStationName;
            container.style.display = 'block';
            
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="no-data">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>è¼‰å…¥çœ‹æ¿è³‡æ–™ä¸­...</p>
                    </td>
                </tr>
            `;

            try {
                // ä½¿ç”¨TDX API v2 æŸ¥è©¢åˆ—è»Šå»¶é²è³‡è¨Š
                const endpoint = `/v2/Rail/TRA/LiveTrainDelay?$format=JSON`;
                const response = await tdxApi.fetch(endpoint);
                
                console.log('APIå›æ‡‰:', response);
                
                let allTrains = [];
                if (Array.isArray(response)) {
                    allTrains = response;
                }

                // ç¯©é¸å‡ºç¶“éç•¶å‰è»Šç«™çš„åˆ—è»Š
                const stationTrains = allTrains.filter(train => {
                    if (!train.StopStations || !Array.isArray(train.StopStations)) {
                        return false;
                    }
                    return train.StopStations.some(stop => stop.StationID === currentStationId);
                });

                console.log(`æ‰¾åˆ° ${stationTrains.length} ç­ç¶“é ${currentStationName} çš„åˆ—è»Š`);

                updateUpdateTime();
                displayDelayTrains(stationTrains);
                updateStats(stationTrains);

            } catch (error) {
                console.error('è¼‰å…¥çœ‹æ¿è³‡æ–™å¤±æ•—:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>è¼‰å…¥å¤±æ•—: ${error.message}</p>
                            <button onclick="loadLiveboard()" style="margin-top: 10px; padding: 8px 16px; background: #1e40af; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-refresh"></i> é‡æ–°è¼‰å…¥
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        // é¡¯ç¤ºå»¶é²åˆ—è»Šè³‡æ–™
        function displayDelayTrains(trains) {
            const tableBody = document.getElementById('trainTableBody');
            
            if (!trains || trains.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">
                            <i class="fas fa-info-circle"></i>
                            <p>ç›®å‰æ²’æœ‰åˆ—è»Šè³‡è¨Š</p>
                            <p style="font-size: 0.85rem; margin-top: 10px; color: #999;">
                                å¯èƒ½åŸå› ï¼šæ­¤æ™‚æ®µæ²’æœ‰åˆ—è»Šç¶“éæ­¤ç«™ï¼Œæˆ–åˆ—è»Šå°šæœªç™¼è»Š
                            </p>
                        </td>
                    </tr>
                `;
                return;
            }

            const rows = trains.map(train => {
                const trainType = getTrainTypeInfo(train.TrainTypeName?.Zh_tw || train.TrainTypeID || '');
                const direction = train.Direction || 0;
                const directionIcon = direction === 0 ? 'arrow-down' : 'arrow-up';
                const directionText = direction === 0 ? 'å—ä¸‹' : 'åŒ—ä¸Š';
                
                // æ‰¾åˆ°ç•¶å‰è»Šç«™çš„åœé è³‡è¨Š
                const currentStop = train.StopStations?.find(s => s.StationID === currentStationId);
                const arrivalTime = formatTime(currentStop?.ArrivalTime);
                const departureTime = formatTime(currentStop?.DepartureTime);
                
                const status = {
                    text: train.DelayTime > 0 ? `èª¤é» ${train.DelayTime}åˆ†` : 'æº–é»',
                    class: train.DelayTime > 5 ? 'delayed' : 'ontime'
                };
                
                return `
                    <tr>
                        <td><span class="train-number">${train.TrainNo || 'æœªçŸ¥'}</span></td>
                        <td><span class="train-type ${trainType.class}">${trainType.name}</span></td>
                        <td>
                            <span class="direction-badge">
                                <i class="fas fa-${directionIcon}"></i>
                                ${directionText}
                            </span>
                        </td>
                        <td>${train.EndingStationName?.Zh_tw || train.EndingStationID || 'æœªçŸ¥'}</td>
                        <td>${arrivalTime}</td>
                        <td>${departureTime}</td>
                        <td><span class="status-badge ${status.class}">${status.text}</span></td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rows;
        }

        // é¡¯ç¤ºåˆ—è»Šè³‡æ–™
        function displayTrains(trains) {
            const tableBody = document.getElementById('trainTableBody');
            
            if (!trains || trains.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">
                            <i class="fas fa-info-circle"></i>
                            <p>ç›®å‰æ²’æœ‰åˆ—è»Šè³‡è¨Š</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // ä¾é è¨ˆåˆ°ç«™æ™‚é–“æ’åº
            trains.sort((a, b) => {
                const timeA = a.ScheduledArrivalTime || a.ScheduledDepartureTime || '';
                const timeB = b.ScheduledArrivalTime || b.ScheduledDepartureTime || '';
                return timeA.localeCompare(timeB);
            });

            const rows = trains.map(train => {
                const trainType = getTrainTypeInfo(train.TrainTypeName?.Zh_tw || train.TrainTypeCode || '');
                const direction = train.Direction || 0;
                const directionIcon = direction === 0 ? 'arrow-down' : 'arrow-up';
                const directionText = direction === 0 ? 'å—ä¸‹' : 'åŒ—ä¸Š';
                
                const arrivalTime = formatTime(train.ScheduledArrivalTime);
                const departureTime = formatTime(train.ScheduledDepartureTime);
                
                const status = getTrainStatus(train);
                
                return `
                    <tr>
                        <td><span class="train-number">${train.TrainNo || 'æœªçŸ¥'}</span></td>
                        <td><span class="train-type ${trainType.class}">${trainType.name}</span></td>
                        <td>
                            <span class="direction-badge">
                                <i class="fas fa-${directionIcon}"></i>
                                ${directionText}
                            </span>
                        </td>
                        <td>${train.EndingStationName?.Zh_tw || 'æœªçŸ¥'}</td>
                        <td>${arrivalTime}</td>
                        <td>${departureTime}</td>
                        <td><span class="status-badge ${status.class}">${status.text}</span></td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = rows;
        }

        // å–å¾—åˆ—è»Šé¡å‹è³‡è¨Š
        function getTrainTypeInfo(typeName) {
            const typeMap = {
                'è‡ªå¼·': { name: 'è‡ªå¼·è™Ÿ', class: 'tze-chiang' },
                'è’å…‰': { name: 'è’å…‰è™Ÿ', class: 'chu-kuang' },
                'å€é–“': { name: 'å€é–“è»Š', class: 'local' },
                'å€é–“å¿«': { name: 'å€é–“å¿«', class: 'express' },
                'æ™®æ‚ ç‘ª': { name: 'æ™®æ‚ ç‘ª', class: 'express' },
                'å¤ªé­¯é–£': { name: 'å¤ªé­¯é–£', class: 'express' },
                'å¾©èˆˆ': { name: 'å¾©èˆˆè™Ÿ', class: 'limited' }
            };
            
            for (const [key, value] of Object.entries(typeMap)) {
                if (typeName.includes(key)) {
                    return value;
                }
            }
            
            return { name: typeName || 'ä¸€èˆ¬è»Š', class: 'local' };
        }

        // æ ¼å¼åŒ–æ™‚é–“
        function formatTime(timeStr) {
            if (!timeStr) return '--:--';
            // æ ¼å¼: "2024-01-01 12:30:00" æˆ– "12:30:00"
            const timePart = timeStr.includes(' ') ? timeStr.split(' ')[1] : timeStr;
            return timePart.substring(0, 5); // åªå– HH:MM
        }

        // å–å¾—åˆ—è»Šç‹€æ…‹
        function getTrainStatus(train) {
            const delayTime = train.DelayTime || 0;
            
            if (delayTime > 5) {
                return { text: `èª¤é» ${delayTime}åˆ†`, class: 'delayed' };
            } else if (delayTime < -2) {
                return { text: `æ—©åˆ° ${Math.abs(delayTime)}åˆ†`, class: 'early' };
            } else {
                return { text: 'æº–é»', class: 'ontime' };
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStats(trains) {
            const total = trains.length;
            const arrivals = trains.filter(t => t.ScheduledArrivalTime).length;
            const departures = trains.filter(t => t.ScheduledDepartureTime).length;
            const delayed = trains.filter(t => (t.DelayTime || 0) > 5).length;

            document.getElementById('totalTrains').textContent = total;
            document.getElementById('arrivalTrains').textContent = arrivals;
            document.getElementById('departureTrains').textContent = departures;
            document.getElementById('delayedTrains').textContent = delayed;
        }

        // æ›´æ–°æ›´æ–°æ™‚é–“
        function updateUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('updateTime').textContent = timeStr;
        }

        // åˆ‡æ›è³‡è¨Šé¢æ¿
        function toggleInfoPanel() {
            const content = document.getElementById('infoContent');
            const icon = document.getElementById('toggleIcon');
            const panel = document.getElementById('infoPanel');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                panel.style.background = '#e8f5e8';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                panel.style.background = '#f5f5f5';
            }
        }

        // é é¢è¼‰å…¥å®Œæˆ
        window.onload = async function() {
            // å…ˆè¼‰å…¥è»Šç«™è³‡æ–™
            await loadStationData();
            
            // å®Œæˆè¼‰å…¥é€²åº¦
            setTimeout(() => {
                if (typeof window.finishLoading === 'function') {
                    window.finishLoading();
                }
            }, 300);
        };
    </script>

    <!-- Back to Top Button -->
    <div class="back-to-top" id="backToTop" style="position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: linear-gradient(135deg, #1e40af, #0891b2); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999; font-size: 1.2rem;">
        <i class="fas fa-arrow-up"></i>
    </div>
</body>
</html>
