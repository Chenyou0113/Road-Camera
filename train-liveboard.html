<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµå³æ™‚çœ‹æ¿ - çœŸå¯¦åˆ—è»Šå‹•æ…‹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <script>window.CURRENT_PAGE = 'train-liveboard';</script>
    <script src="assets/config.js"></script>
    <script src="assets/train-line-classification.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body, .header, .control-panel, .tra-marquee, .info-panel, .news-item, .train-container, .data-disclaimer {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #3575ff 0%, #15bbd8 100%); 
            min-height: 100vh; 
            padding-bottom: 80px;
        }
        
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #D84315; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #016d68; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; transition: background 0.3s; }
        .back-btn:hover { background: #034d64; }
        
        /* ç™½è‰²å¡ç‰‡å¼æŸ¥è©¢é¢æ¿ */
        .control-panel { 
            background: rgba(255, 255, 255, 0.95);
            margin: 20px 0; padding: 25px; border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
        }
        .control-panel h3 { color: #1565C0; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; font-weight: bold; }
        
        .selector-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 15px; align-items: end; }
        .selector-group { display: flex; flex-direction: column; }
        .selector-group label { margin-bottom: 8px; font-weight: 700; color: #444; font-size: 0.95rem; }
        .selector-group select, .selector-group input { padding: 12px 15px; border-radius: 8px; border: 1px solid #ccc; background: #f9f9f9; color: #333; font-size: 1rem; font-weight: 500; transition: all 0.2s; }
        .selector-group select:focus, .selector-group input:focus { border-color: #2196F3; background: #fff; box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2); outline: none; }
        
        .query-btn { padding: 12px 30px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
        .query-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); }
        .query-btn:disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; transform: none; }
        
        .train-container { background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; margin: 20px 0; }
        .board-header { background: linear-gradient(135deg, #FF6B35 0%, #D84315 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .board-title h2 { font-size: 1.5rem; margin-bottom: 5px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        .pids-btn { display: inline-flex; align-items: center; gap: 8px; background: #212121; color: #ffb74d; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-weight: bold; font-family: 'Microsoft JhengHei', sans-serif; border: 1px solid #444; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 0.9rem; cursor: pointer; }
        .pids-btn:hover { background: #000; color: #fff; box-shadow: 0 0 15px rgba(255, 183, 77, 0.3); transform: translateY(-2px); }
        
        .board-info { font-size: 0.9rem; opacity: 0.9; display: flex; gap: 20px; flex-wrap: wrap; }
        .direction-section { border-bottom: 2px solid #eee; }
        .direction-section:last-child { border-bottom: none; }
        .direction-header { background: #f5f5f5; padding: 15px 20px; font-weight: 600; color: #333; border-left: 4px solid #FF6B35; font-size: 1.05rem; }
        
        .train-card { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee; transition: background 0.3s; cursor: pointer; }
        .train-card:hover { background: #f9f9f9; }
        .train-info { display: flex; align-items: center; gap: 12px; }
        
        .train-type-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; color: white; font-size: 0.85rem; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 90px; text-align: center; }
        
        .type-è‡ªå¼· { background-color: #FF5722; }
        .type-æŸ´è‡ªå¼· { background-color: #D84315; border: 1px solid #FF5722; }
        .type-æ–°è‡ªå¼· { background: linear-gradient(135deg, #000000 0%, #333333 100%); border: 1px solid #666; }
        .type-æ™®æ‚ ç‘ª { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); }
        .type-å¤ªé­¯é–£ { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .type-è’å…‰ { background-color: #FF9800; }
        .type-å€é–“å¿« { background-color: #3F51B5; }
        .type-å€é–“ { background-color: #2196F3; }
        .type-å¾©èˆˆ { background-color: #00BCD4; }
        .type-æ™®å¿« { background-color: #009688; }
        .type-å°ˆè»Š { background-color: #607D8B; }
        .type-å…¶ä»– { background-color: #607D8B; }
        
        .train-destination { flex-grow: 1; }
        .train-no { font-weight: bold; color: #333; margin-right: 8px; }
        .destination { color: #666; font-size: 0.95rem; }
        .schedule-time { text-align: center; font-weight: 600; color: #333; font-size: 1.1rem; }
        .schedule-label { font-size: 0.75rem; color: #999; margin-top: 2px; }
        .delay-status { text-align: center; min-width: 80px; }
        .delay-badge { display: inline-block; padding: 6px 10px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .delay-ok { background-color: #E8F5E9; color: #2E7D32; }
        .delay-warn { background-color: #FFEBEE; color: #C62828; }
        .no-data { text-align: center; padding: 60px 20px; color: #999; }
        .no-data i { font-size: 3rem; margin-bottom: 20px; opacity: 0.5; }

        /* å…¬å‘Šèˆ‡è·‘é¦¬ç‡ˆ */
        .tra-marquee { background: #ffffff; color: #333333; border: 1px solid #e0e0e0; display: flex; align-items: center; padding: 0 15px; font-size: 1.1rem; font-weight: 600; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); position: relative; height: 50px; overflow: hidden; }
        .marquee-icon { margin-right: 15px; color: #e65100; font-size: 1.3rem; animation: flash 2s infinite; flex-shrink: 0; z-index: 2; background: inherit; }
        .marquee-wrapper { flex: 1; overflow: hidden; position: relative; height: 100%; display: block; }
        .marquee-content-top { display: inline-block; white-space: nowrap; position: absolute; top: 0; left: 0; line-height: 50px; padding-left: 100%; animation: marquee-announce 30s linear infinite; color: inherit; }
        @keyframes marquee-announce { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .info-panel { background: #fff3e0; border-left: 5px solid #ff9800; padding: 15px 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .info-panel h3 { color: #e65100; margin-bottom: 12px; display: flex; align-items: baseline; }
        .news-item { padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .news-item:last-child { border-bottom: none; }
        .news-title { font-weight: bold; color: #bf360c; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .news-desc { color: #5d4037; font-size: 0.95rem; line-height: 1.5; }
        .news-time { font-size: 0.85rem; color: #8d6e63; margin-top: 4px; }

        /* ğŸ”¥ å…è²¬è²æ˜ (æ‚¨è¦çš„è­¦ç¤ºæ–‡å­—ï¼) */
        .data-disclaimer {
            background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;
            padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; font-size: 0.9rem;
            display: flex; align-items: flex-start; gap: 10px; line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .data-disclaimer i { font-size: 1.2rem; color: #856404; margin-top: 2px; }

        .marquee-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: #1a1a1a; display: flex; align-items: center; z-index: 9999; border-top: 3px solid #ff9800; }
        .marquee-info { background: #000; min-width: 150px; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0 10px; border-right: 2px solid #333; z-index: 20; }
        .marquee-train-no { font-size: 1.4rem; font-weight: 800; color: #ffeb3b; }
        .marquee-dest { font-size: 1rem; color: #fff; }
        .marquee-content-wrapper { flex: 1; overflow: hidden; position: relative; height: 100%; }
        .marquee-content { position: absolute; white-space: nowrap; font-size: 1.3rem; font-weight: bold; line-height: 57px; color: #fff; }
        .marquee-close { background: #222; border: none; border-left: 1px solid #444; color: #999; width: 50px; height: 100%; font-size: 1.8rem; cursor: pointer; z-index: 20; }

        @media (max-width: 900px) { 
            .selector-row { grid-template-columns: 1fr; }
            .train-card { grid-template-columns: 1fr; gap: 10px; }
            .train-info { flex-direction: column; align-items: flex-start; }
        }
        
        /* Dark Mode */
        body.dark-mode { background: #121212; color: #e0e0e0; }
        body.dark-mode .header { background: #1e1e1e; border-bottom: 1px solid #333; }
        body.dark-mode .header h1 { color: #ffab91; }
        body.dark-mode .control-panel { background: #1e1e1e; border: 1px solid #333; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        body.dark-mode .control-panel h3 { color: #90caf9; }
        body.dark-mode .selector-group label { color: #cfd8dc; }
        body.dark-mode select, body.dark-mode input { background-color: #2c2c2c; color: #fff; border-color: #444; }
        body.dark-mode .board-header { background: linear-gradient(135deg, #bf360c 0%, #d84315 100%); }
        body.dark-mode .direction-header { background-color: #263238; color: #eceff1; border-left-color: #ff7043; }
        body.dark-mode .train-card { background-color: #1e1e1e; border-bottom: 1px solid #333; }
        body.dark-mode .train-card:hover { background-color: #2c2c2c; }
        body.dark-mode .train-no, body.dark-mode .schedule-time { color: #fff; }
        body.dark-mode .destination { color: #b0bec5; }
        body.dark-mode .info-panel { background: #3e2723; border-left-color: #ffb74d; }
        body.dark-mode .info-panel h3 { color: #ffcc80; }
        body.dark-mode .news-item { border-bottom-color: rgba(255,255,255,0.1); }
        body.dark-mode .news-title { color: #ffab91; }
        body.dark-mode .news-desc { color: #d7ccc8; }
        body.dark-mode .news-time { color: #a1887f; }
        body.dark-mode .tra-marquee { background: #212121; color: #ffeb3b; border-color: #424242; }
        body.dark-mode .marquee-icon { color: #ff9800; }
        body.dark-mode .data-disclaimer { background-color: #2c2208; color: #ffecb3; border-color: #443610; }
        body.dark-mode .data-disclaimer i { color: #ffc107; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> è¿”å›é¦–é </a>
            <h1><i class="fas fa-train"></i> å°éµå³æ™‚çœ‹æ¿</h1>
            <p style="text-align: center; color: #666; font-size: 0.95rem;">å…¨å°éµè·¯å³æ™‚åˆ—è»Šå‹•æ…‹ã€èª¤é»è³‡è¨ŠæŸ¥è©¢</p>
        </div>
    </div>

    <div class="container">
        <div class="tra-marquee">
            <div class="marquee-icon"><i class="fas fa-bell"></i></div>
            <div class="marquee-wrapper">
                <div class="marquee-content-top" id="marqueeText">æ­¡è¿ä½¿ç”¨å°éµå³æ™‚çœ‹æ¿...</div>
            </div>
        </div>

        <div class="info-panel rail-news" id="traAlertPanel" style="display: none;">
            <h3><span><i class="fas fa-bullhorn"></i> å°éµç‡Ÿé‹é€šé˜»</span></h3>
            <div id="traAlertContent" class="news-content"></div>
        </div>

        <div class="control-panel">
            <h3><i class="fas fa-search"></i> æŸ¥è©¢å³æ™‚çœ‹æ¿</h3>
            <div class="selector-row">
                <div class="selector-group">
                    <label>è·¯ç·šåˆ†é¡</label>
                    <select id="lineSelect" onchange="filterStations()"><option value="all">å…¨éƒ¨è·¯ç·š</option></select>
                </div>
                <div class="selector-group">
                    <label>æœå°‹è»Šç«™</label>
                    <input type="text" id="stationSearch" placeholder="è¼¸å…¥ç«™å (å¦‚: å°åŒ—)" oninput="filterStations()">
                </div>
                <div class="selector-group">
                    <label>é¸æ“‡è»Šç«™</label>
                    <select id="stationSelect"><option value="">è«‹é¸æ“‡è»Šç«™...</option></select>
                </div>
                <div class="selector-group">
                    <label>æ–¹å‘</label>
                    <select id="directionFilter">
                        <option value="">å…¨éƒ¨</option>
                        <option value="0">é †è¡Œ</option>
                        <option value="1">é€†è¡Œ</option>
                    </select>
                </div>
                <button class="query-btn" id="queryBtn" onclick="fetchTrainLiveBoard()"><i class="fas fa-sync-alt"></i> æŸ¥è©¢</button>
            </div>
        </div>

        <div class="data-disclaimer">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>âš ï¸ æ³¨æ„äº‹é …ï¼š</strong>
                æœ¬çœ‹æ¿è³‡æ–™ä¾†æºç‚º TDX å¹³å°åŠ å€¼é‹ç®—ï¼Œèˆ‡è‡ºéµå®˜ç¶²ä¸€è‡´ä½†ç´„æœ‰ <strong>2 åˆ†é˜å»¶é²</strong>ã€‚
                æ­¤è³‡æ–™éç›´æ¥ä»‹æ¥è»Šç«™ç¾å ´ç³»çµ±ï¼Œè«‹å‹¿ç›´æ¥èˆ‡æœˆå° TIDS çœ‹æ¿æ¯”å°ã€‚
            </div>
        </div>

        <div id="trainContainer" class="train-container" style="display: none;">
            <div class="board-header">
                <div class="board-title">
                    <h2 id="stationTitle">åˆ—è»Šå‹•æ…‹</h2>
                    <div class="board-info">
                        <span id="stationInfo"></span>
                        <span class="sync-time"><i class="fas fa-clock"></i> <span id="updateTime">--:--:--</span></span>
                    </div>
                </div>
            </div>
            <div id="trainsBoard">
                <div class="no-data"><i class="fas fa-inbox"></i><p>è«‹é¸æ“‡è»Šç«™æŸ¥è©¢</p></div>
            </div>
        </div>
    </div>

    <div id="trainMarqueeBar" class="marquee-bar" style="display: none;">
        <div class="marquee-info"><span class="marquee-train-no" id="mqTrainNo"></span><span class="marquee-dest" id="mqDest"></span></div>
        <div class="marquee-content-wrapper"><div class="marquee-content" id="mqContent"></div></div>
        <button class="marquee-close" onclick="closeMarquee()">Ã—</button>
    </div>

    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        const WORKER_URL = 'https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev';
        let currentStationID = '', currentStationName = '', allStationsFlat = []; 
        const trainDataCache = {}; 
        let prefetchTimeout = null;

        // ğŸ”¥ ç¢ºä¿å…¬å‘Šæ­£ç¢ºè¼‰å…¥
        async function loadTraAlertsToMarquee() {
            try {
                const res = await fetch(`${WORKER_URL}/api/alert`).then(r => r.json());
                const alerts = res.Alerts || res || [];
                
                // æ›´æ–°ä¸Šæ–¹è·‘é¦¬ç‡ˆ
                if (alerts.length > 0) {
                    let txt = alerts.map(a => `ã€${a.Title}ã€‘${a.Description}`).join("   ");
                    document.getElementById('marqueeText').innerHTML = txt;
                } else {
                    document.getElementById('marqueeText').innerHTML = "ç›®å‰ç„¡é‡å¤§ç‡Ÿé‹é€šé˜»äº‹ä»¶ï¼Œå…¨ç·šæ­£å¸¸é‹è¡Œã€‚";
                }

                // æ›´æ–°ä¸‹æ–¹å…¬å‘Šæ¬„
                const panel = document.getElementById('traAlertPanel');
                const content = document.getElementById('traAlertContent');
                if (alerts.length > 0) {
                    let html = '';
                    alerts.forEach(alert => {
                        let icon = 'â„¹ï¸';
                        let titleColor = '#e65100';
                        if (alert.Status === 2 || alert.Level > 1) { icon = 'ğŸš¨'; titleColor = '#d32f2f'; }
                        const timeStr = new Date(alert.PublishTime).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                        html += `<div class="news-item">
                            <div class="news-title" style="color: ${titleColor}"><span>${icon}</span><span>${alert.Title}</span></div>
                            <div class="news-desc">${(alert.Description || '').replace(/\n/g, '<br>')}</div>
                            <div class="news-time"><i class="far fa-clock"></i> ç™¼å¸ƒæ™‚é–“ï¼š${timeStr}</div>
                        </div>`;
                    });
                    content.innerHTML = html;
                    panel.style.display = 'block';
                } else {
                    panel.style.display = 'none';
                }

            } catch (e) { console.error("Alert Error", e); }
        }

        function isTrainHasNotLeft(targetTimeStr, delayMinutes, bufferMinutes) {
            if (!targetTimeStr) return true;
            const now = new Date();
            const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
            const [h, m] = targetTimeStr.split(':').map(Number);
            let targetTotalMinutes = h * 60 + m + (delayMinutes || 0);
            if (currentTotalMinutes > 18 * 60 && targetTotalMinutes < 6 * 60) targetTotalMinutes += 24 * 60;
            return (targetTotalMinutes - bufferMinutes) >= currentTotalMinutes;
        }

        function getPrettyTrainInfo(rawName, typeID) {
            let name = rawName || 'åˆ—è»Š';
            let cssClass = 'å…¶ä»–';

            if (name.includes('è‡ªå¼·(3000)') || name.includes('EMU3000')) cssClass = 'æ–°è‡ªå¼·';
            else if (name.includes('æ™®æ‚ ç‘ª')) cssClass = 'æ™®æ‚ ç‘ª';
            else if (name.includes('å¤ªé­¯é–£')) cssClass = 'å¤ªé­¯é–£';
            else if (name.includes('è‡ªå¼·')) cssClass = 'è‡ªå¼·';
            else if (name.includes('è’å…‰')) cssClass = 'è’å…‰';
            else if (name.includes('å€é–“å¿«')) cssClass = 'å€é–“å¿«';
            else if (name.includes('å€é–“')) cssClass = 'å€é–“';
            else if (name.includes('å¾©èˆˆ')) cssClass = 'å¾©èˆˆ';
            else if (name.includes('æ™®å¿«')) cssClass = 'æ™®å¿«';

            if (cssClass === 'æ–°è‡ªå¼·') name = 'æ–°è‡ªå¼·';
            else if (cssClass === 'æ™®æ‚ ç‘ª') name = 'æ™®æ‚ ç‘ª';
            else if (cssClass === 'å¤ªé­¯é–£') name = 'å¤ªé­¯é–£';
            else if (cssClass === 'è‡ªå¼·') {
                if (name.includes('æŸ´è¯') || name.includes('DMU') || (typeID && ['110D','110E','110F','1103'].includes(typeID))) {
                    name = 'æŸ´è‡ªå¼·'; cssClass = 'æŸ´è‡ªå¼·';
                } else { name = 'è‡ªå¼·è™Ÿ'; }
            }
            else if (cssClass === 'å€é–“å¿«') name = 'å€é–“å¿«';
            else if (cssClass === 'å€é–“') {
                name = 'å€é–“è»Š';
                if (typeID === '113A' || name.includes('500')) name = 'å€é–“(500å‹)';
                else if (typeID === '113B' || name.includes('700')) name = 'å€é–“(700å‹)';
                else if (typeID === '113C' || name.includes('800')) name = 'å€é–“(800å‹)';
                else if (typeID === '113D' || name.includes('900')) name = 'å€é–“(900å‹)';
            }
            else if (cssClass === 'è’å…‰') name = 'è’å…‰è™Ÿ';
            else if (cssClass === 'å¾©èˆˆ') name = 'å¾©èˆˆè™Ÿ';
            else if (cssClass === 'æ™®å¿«') name = 'æ™®å¿«è»Š';

            if (typeID && ['1104','1105','1106','1112','1113','1130'].includes(typeID)) { cssClass = 'å°ˆè»Š'; }
            return { name: name, class: cssClass };
        }

        document.addEventListener('DOMContentLoaded', () => {
            initStationControls();
            setInterval(updateTime, 1000);
            loadTraAlertsToMarquee();
        });

        async function fetchTrainLiveBoard() {
            const stationSelect = document.getElementById('stationSelect');
            currentStationID = stationSelect.value;
            if (!currentStationID) { alert('è«‹å…ˆé¸æ“‡è»Šç«™'); return; }
            
            const selectedOption = stationSelect.options[stationSelect.selectedIndex];
            currentStationName = selectedOption.text.split(' - ')[1];
            document.getElementById('queryBtn').disabled = true;
            document.getElementById('trainsBoard').innerHTML = '<div class="no-data"><i class="fas fa-spinner fa-spin"></i><p>è¼‰å…¥ä¸­...</p></div>';
            document.getElementById('trainContainer').style.display = 'block';

            try {
                const ts = Date.now();
                const [scheduleRes, liveRes] = await Promise.all([
                    fetch(`${WORKER_URL}/api/station/schedule?stationID=${currentStationID}&t=${ts}`).then(r => r.json()),
                    fetch(`${WORKER_URL}/api/station/live?stationID=${currentStationID}&t=${ts}`).then(r => r.json())
                ]);

                if (scheduleRes.error) throw new Error(scheduleRes.error);

                let allTrains = [];
                let rootData = scheduleRes.StationTimetables || scheduleRes;
                if (!Array.isArray(rootData)) rootData = [rootData];

                const getZhTw = (val) => (val && typeof val === 'object' && val.Zh_tw) ? val.Zh_tw : val;

                rootData.forEach(container => {
                    const containerDirection = container.Direction;
                    const innerList = container.TimeTables || container.StationTimetables || [];
                    
                    innerList.forEach(st => {
                        const depTime = st.DepartureTime || st.ArrivalTime;
                        if (!depTime) return;
                        const destRaw = st.DestinationStationName || st.EndingStationName;
                        const finalDirection = (st.Direction !== undefined) ? st.Direction : containerDirection;

                        allTrains.push({
                            TrainNo: st.TrainNo,
                            Direction: finalDirection, 
                            TrainTypeName: getZhTw(st.TrainTypeName) || 'åˆ—è»Š',
                            TrainTypeID: st.TrainTypeID,
                            EndingStationName: getZhTw(destRaw) || 'æœªçŸ¥',
                            ScheduledDepartureTime: depTime,
                            DelayTime: 0,
                            Status: 'future'
                        });
                    });
                });

                const liveMap = new Map();
                const liveBoardData = liveRes.StationLiveBoards || liveRes;
                const liveArray = Array.isArray(liveBoardData) ? liveBoardData : (liveBoardData ? [liveBoardData] : []);
                liveArray.forEach(t => liveMap.set(t.TrainNo, t.DelayTime));

                allTrains = allTrains.map(train => {
                    if (liveMap.has(train.TrainNo)) {
                        train.DelayTime = liveMap.get(train.TrainNo);
                        train.Status = 'live';
                    }
                    return train;
                });

                // éæ¿¾å·²é›¢ç«™ (ä¿ç•™5åˆ†é˜)
                allTrains = allTrains.filter(t => isTrainHasNotLeft(t.ScheduledDepartureTime, t.DelayTime, -5));

                allTrains.sort((a, b) => a.ScheduledDepartureTime.localeCompare(b.ScheduledDepartureTime));
                if (allTrains.length > 0) renderBoard(allTrains);
                else showNoData('ä»Šæ—¥å·²ç„¡æ›´å¤šåˆ—è»Šç­æ¬¡');

            } catch (error) {
                console.error(error);
                alert(`æŸ¥è©¢å¤±æ•—ï¼š${error.message}`);
                showNoData('ç³»çµ±ç™¼ç”ŸéŒ¯èª¤');
            } finally {
                document.getElementById('queryBtn').disabled = false;
            }
        }

        function renderBoard(trains) {
            const container = document.getElementById('trainContainer');
            const trainsBoard = document.getElementById('trainsBoard');
            const directionFilter = document.getElementById('directionFilter').value;
            const pidsLink = `pids-live.html?station=${currentStationID}&name=${encodeURIComponent(currentStationName)}`;
            
            document.getElementById('stationTitle').innerHTML = `${currentStationName} åˆ—è»Šå‹•æ…‹ <a href="${pidsLink}" target="_blank" class="pids-btn"><i class="fas fa-desktop"></i> PIDS æ¨¡æ“¬</a>`;
            document.getElementById('stationInfo').textContent = `è»Šç«™ä»£ç¢¼ï¼š${currentStationID}`;
            updateTime();

            let filteredTrains = trains;
            if (directionFilter !== '') filteredTrains = trains.filter(t => String(t.Direction) === directionFilter);

            const grouped = { '0': { title: 'é †è¡Œ (å—ä¸‹/è¥¿è¡Œ)', trains: [] }, '1': { title: 'é€†è¡Œ (åŒ—ä¸Š/æ±ä¸Š)', trains: [] } };
            filteredTrains.forEach(train => {
                const dir = String(train.Direction);
                if (grouped[dir]) grouped[dir].trains.push(train);
            });

            let html = '';
            Object.entries(grouped).forEach(([dir, data]) => {
                if (data.trains.length === 0) return;
                
                const trainsToShow = data.trains.slice(0, 15); 

                html += `<div class="direction-section"><div class="direction-header"><i class="fas fa-arrow-right"></i> ${data.title}</div>`;
                
                trainsToShow.forEach(train => {
                    const timeText = train.ScheduledDepartureTime ? train.ScheduledDepartureTime.slice(0,5) : '--:--';
                    let delayStatus = train.Status === 'live' ? getDelayStatus(train) : '<span class="delay-badge" style="background:#f5f5f5; color:#999; font-weight:normal;">è¡¨å®š</span>';
                    const trainInfo = getPrettyTrainInfo(train.TrainTypeName, train.TrainTypeID);
                    const isDeparted = !isTrainHasNotLeft(timeText, train.DelayTime, 0);
                    const rowOpacity = isDeparted ? 'opacity: 0.6; filter: grayscale(0.8);' : '';

                    html += `
                        <div class="train-card" style="${rowOpacity}"
                             onclick="showTrainStops('${train.TrainNo}', '${currentStationID}', '${train.EndingStationName}')"
                             onmouseenter="prefetchTrainData('${train.TrainNo}')"
                             title="é»æ“ŠæŸ¥çœ‹æ²¿é€”åœé ç«™">
                            <div class="train-info">
                                <span class="train-type-badge type-${trainInfo.class}">${trainInfo.name}</span>
                                <div class="train-destination">
                                    <div class="train-no">${train.TrainNo} æ¬¡</div>
                                    <div class="destination">å¾€ ${train.EndingStationName}</div>
                                </div>
                            </div>
                            <div class="schedule-time">${timeText}<div class="schedule-label">é–‹è»Š</div></div>
                            <div class="delay-status">${delayStatus}</div>
                        </div>
                    `;
                });
                
                if (data.trains.length > 15) html += `<div style="text-align:center; padding:10px; color:#999; font-size:0.9rem; background:#f9f9f9;">... å°šæœ‰æ›´å¤šåˆ—è»Š ...</div>`;
                html += '</div>';
            });

            if (html === '') showNoData('è©²æ–¹å‘ä»Šæ—¥å·²ç„¡æ›´å¤šåˆ—è»Š');
            else trainsBoard.innerHTML = html;
        }

        function getDelayStatus(train) {
            const delay = train.DelayTime || 0;
            return delay === 0 
                ? '<span class="delay-badge delay-ok"><i class="fas fa-check"></i> æº–é»</span>' 
                : `<span class="delay-badge delay-warn"><i class="fas fa-clock"></i> æ™š ${delay} åˆ†</span>`;
        }

        function updateTime() {
            const now = new Date();
            const el = document.getElementById('updateTime');
            if (el) el.textContent = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function showNoData(msg) {
            document.getElementById('trainsBoard').innerHTML = `<div class="no-data"><i class="fas fa-inbox"></i><p>${msg}</p></div>`;
            document.getElementById('trainContainer').style.display = 'block';
        }

        function prefetchTrainData(trainNo) {
            if (trainDataCache[trainNo]) return;
            if (prefetchTimeout) clearTimeout(prefetchTimeout);
            prefetchTimeout = setTimeout(() => {
                fetch(`${WORKER_URL}/api/schedule?trainNo=${trainNo}`).then(r=>r.json()).then(d => {
                    if(d && d.length > 0) trainDataCache[trainNo] = Promise.resolve([d[0].StopTimes, null]);
                });
            }, 300);
        }

        async function showTrainStops(trainNo, currentStationID, destName) {
            const bar = document.getElementById('trainMarqueeBar');
            const content = document.getElementById('mqContent');
            bar.style.display = 'flex';
            document.getElementById('mqTrainNo').textContent = `${trainNo} æ¬¡`;
            document.getElementById('mqDest').textContent = `å¾€ ${destName}`;
            content.innerHTML = '<span style="color:#aaa;">è¼‰å…¥ä¸­...</span>';
            content.style.animation = 'none';
            void content.offsetHeight; 

            try {
                const [scheduleRes, liveRes] = await Promise.all([
                    fetch(`${WORKER_URL}/api/schedule?trainNo=${trainNo}`).then(r => r.json()).catch(() => []),
                    fetch(`${WORKER_URL}/api/live?trainNo=${trainNo}`).then(r => r.json()).catch(() => ({}))
                ]);

                const stopTimes = (scheduleRes && scheduleRes.length > 0) ? scheduleRes[0].StopTimes : [];
                const liveData = (liveRes.TrainLiveBoards && liveRes.TrainLiveBoards.length > 0) ? liveRes.TrainLiveBoards[0] : null;
                const delayTime = liveData ? liveData.DelayTime : 0;
                let marqueeHTML = '';

                if (liveData && liveData.StationName) {
                    const lastStation = liveData.StationName.Zh_tw || liveData.StationName;
                    const delayText = delayTime <= 0 ? '<span style="color:#00e676;">(æº–é»)</span>' : `<span style="color:#ff5252;">(æ™š ${delayTime} åˆ†)</span>`;
                    marqueeHTML += `<span style="color:#aaa;">ç›®å‰ä½ç½®ï¼š</span><span style="color:#ffeb3b; font-weight:bold;">${lastStation}</span> ${delayText}`;
                } else {
                    marqueeHTML += `<span style="color:#aaa;">(æš«ç„¡å³æ™‚è¨Šè™Ÿ)</span>`;
                }
                
                marqueeHTML += `<span style="margin:0 20px; border-left:1px solid #555;"></span>`;

                if (stopTimes.length > 0) {
                    const idx = stopTimes.findIndex(s => s.StationID === currentStationID);
                    if (idx !== -1 && idx < stopTimes.length - 1) {
                        const nextStops = stopTimes.slice(idx + 1, idx + 6).map(s => s.StationName.Zh_tw).join('ã€');
                        marqueeHTML += `<span style="color:#aaa;">å¾ŒçºŒåœé ï¼š</span>${nextStops} ...`;
                    }
                }

                content.innerHTML = marqueeHTML;
                const duration = Math.max(10, content.innerText.length * 0.35);
                content.style.animation = `marquee-scroll ${duration}s linear infinite`;

            } catch (e) { console.error(e); content.innerHTML = 'ç„¡æ³•è¼‰å…¥'; }
        }

        function closeMarquee() { document.getElementById('trainMarqueeBar').style.display = 'none'; }

        function initStationControls() {
            const lineSelect = document.getElementById('lineSelect');
            const categories = {};
            for (const [key, data] of Object.entries(trainLineClassification)) {
                const category = data.category || 'å…¶ä»–';
                if (!categories[category]) categories[category] = [];
                categories[category].push({ key, ...data });
            }
            for (const [category, routes] of Object.entries(categories)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                routes.forEach(route => {
                    const option = document.createElement('option');
                    option.value = route.key;
                    option.textContent = route.name;
                    optgroup.appendChild(option);
                });
                lineSelect.appendChild(optgroup);
                routes.forEach(route => {
                    route.stations.forEach(station => {
                        if (!allStationsFlat.find(s => s.code === station.code)) {
                            allStationsFlat.push({ code: station.code, name: station.name, lineKey: route.key });
                        }
                    });
                });
            }
            filterStations();
        }

        function filterStations() {
            const selectedLine = document.getElementById('lineSelect').value;
            const keyword = document.getElementById('stationSearch').value.toLowerCase().trim();
            let filtered = [];
            if (selectedLine === 'all') filtered = allStationsFlat;
            else if (trainLineClassification[selectedLine]) {
                filtered = trainLineClassification[selectedLine].stations.map(s => ({ code: s.code, name: s.name }));
            }
            if (keyword) filtered = filtered.filter(s => s.name.includes(keyword) || s.code.includes(keyword));
            renderStationOptions(filtered);
        }

        function renderStationOptions(stations) {
            const select = document.getElementById('stationSelect');
            select.innerHTML = '';
            if (stations.length === 0) {
                select.add(new Option("æŸ¥ç„¡ç¬¦åˆè»Šç«™", "")); return;
            }
            select.add(new Option(`è«‹é¸æ“‡è»Šç«™ (${stations.length} å€‹çµæœ)`, ""));
            stations.forEach(s => select.add(new Option(`${s.code} - ${s.name}`, s.code)));
            if (stations.length === 1) select.selectedIndex = 1;
        }

        function addMinutesToTime(timeStr, minutesToAdd) {
            if (!timeStr) return '--:--';
            if (minutesToAdd === 0) return timeStr;
            const [h, m] = timeStr.split(':').map(Number);
            const d = new Date();
            d.setHours(h); d.setMinutes(m + minutesToAdd);
            return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }
    </script>
</body>
</html>