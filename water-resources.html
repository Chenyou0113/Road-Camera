<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水利署監視器影像系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/responsive-camera.css">
    <script src="assets/image-handler-simple.js"></script>
    <script>
        // 預載入機制 - 在頁面開始載入時就開始準備資料
        let isWaterPreloading = false;
        let waterPreloadPromise = null;
        
        function startWaterPreload() {
            if (isWaterPreloading) return waterPreloadPromise;
            
            isWaterPreloading = true;
            console.log('🚀 啟動水利監視器預載入機制');
            
            waterPreloadPromise = new Promise(async (resolve) => {
                try {
                    // 預載入 API 端點準備
                    const preloadEndpoints = [
                        'https://alerts.ncdr.nat.gov.tw/JSONAtomFeeds/waterlevelstations.json',
                        'https://data.coa.gov.tw/Service/OpenData/FromM/AgricultureiRiceFailure.aspx'
                    ];
                    
                    console.log('✅ 水利監視器 API 端點準備完成');
                    
                    // 預熱 fetch 連線
                    try {
                        await Promise.race([
                            fetch(preloadEndpoints[0], { method: 'HEAD' }).catch(() => {}),
                            new Promise(resolve => setTimeout(resolve, 1000))
                        ]);
                        console.log('✅ 預熱連線完成');
                    } catch (error) {
                        console.log('預熱連線略過:', error.message);
                    }
                    
                    resolve(true);
                } catch (error) {
                    console.error('水利監視器預載入過程發生錯誤:', error);
                    resolve(false);
                }
            });
            
            return waterPreloadPromise;
        }
        
        // 立即開始預載入
        startWaterPreload();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* 載入進度指示器樣式 */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 50px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin: 30px auto;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .loading-step {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px 0;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .loading-step i {
            margin-right: 12px;
            width: 16px;
            text-align: center;
        }

        #progress-bar {
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        .header h1 {
            text-align: center;
            color: #1976D2;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
        }

        .filter-tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 2px solid #1976D2;
            background: white;
            color: #1976D2;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .tab-btn.active,
        .tab-btn:hover {
            background: #1976D2;
            color: white;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px auto;
            max-width: 1000px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 10px;
        }

        .stat-time {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1565C0;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .search-section {
            background: white;
            margin: 30px auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            max-width: 1000px;
        }

        .search-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group select,
        .form-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #1976D2;
        }

        .search-btn {
            background: linear-gradient(45deg, #1976D2, #1565C0);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
        }

        .refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #45a049;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2rem;
        }

        .cameras-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin: 30px 0;
        }
        
        @media (max-width: 1200px) {
            .cameras-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .cameras-grid {
                grid-template-columns: 1fr;
            }
        }

        .camera-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .camera-card:hover {
            transform: translateY(-5px);
        }

        .camera-image {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.1rem;
            position: relative;
            overflow: hidden;
        }

        .camera-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-info {
            padding: 20px;
        }

        .camera-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 10px;
        }

        .camera-details {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .camera-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .back-btn {
            display: inline-block;
            padding: 12px 25px;
            background: #1976D2;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin: 20px 0;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: #1565C0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .modal-image {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 10px;
        }

        .modal-info {
            margin-top: 20px;
        }

        .modal-info h2 {
            color: #1976D2;
            margin-bottom: 15px;
        }

        .modal-info p {
            color: #666;
            margin: 8px 0;
            line-height: 1.6;
        }

        .authority-badge {
            background: linear-gradient(45deg, #1976D2, #1565C0);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-bottom: 10px;
            display: inline-block;
        }

        @media (max-width: 992px) {
            .search-form {
                grid-template-columns: 1fr 1fr auto;
            }
        }

        @media (max-width: 768px) {
            .search-form {
                grid-template-columns: 1fr;
            }
            
            .cameras-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .stats-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-panel {
                grid-template-columns: 1fr;
            }
        }

        /* 深色模式樣式 */
        body.dark-mode .loading {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(33, 150, 243, 0.1);
        }

        body.dark-mode .loading-step {
            color: rgba(255, 255, 255, 0.8);
        }

        body.dark-mode .filter-tabs {
            background: rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #64B5F6;
            border-color: #64B5F6;
        }

        body.dark-mode .tab-btn.active,
        body.dark-mode .tab-btn:hover {
            background: #64B5F6;
            color: #1a1a2e;
        }

        body.dark-mode .stat-card {
            background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }

        body.dark-mode .stat-number {
            color: #64B5F6;
        }

        body.dark-mode .stat-label {
            color: rgba(255, 255, 255, 0.7);
        }

        body.dark-mode .search-container {
            background: rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .search-input {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: #64B5F6;
        }

        body.dark-mode .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        body.dark-mode .filter-select {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: #64B5F6;
        }

        body.dark-mode .filter-select option {
            background: #2a2a3e;
            color: white;
        }

        body.dark-mode .search-btn,
        body.dark-mode .refresh-btn {
            background: #64B5F6;
            color: #1a1a2e;
        }

        body.dark-mode .search-btn:hover,
        body.dark-mode .refresh-btn:hover {
            background: #81C7F7;
        }

        body.dark-mode .camera-card {
            background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }

        body.dark-mode .camera-info h3 {
            color: #64B5F6;
        }

        body.dark-mode .camera-info p {
            color: rgba(255, 255, 255, 0.8);
        }

        body.dark-mode .camera-info a {
            color: #64B5F6;
        }

        body.dark-mode .status {
            background: rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .status.active {
            background: #64B5F6;
            color: #1a1a2e;
        }

        body.dark-mode .status.inactive {
            background: rgba(244, 67, 54, 0.2);
            color: #ef5350;
        }
    </style>
    
    <!-- 載入進度條 - 修復載入順序問題 -->
    <script src="assets/loading-progress.js"></script>
    <script>
        // 水資源監控載入設定
        window.AUTO_START_LOADING = false;
        
        // 確保 loading-progress.js 已完全載入後再調用
        if (typeof window.startLoading === 'function') {
            window.addEventListener('DOMContentLoaded', () => {
                window.startLoading({
                    labelText: '載入水資源監控系統...',
                    color: '#64B5F6',
                    showLabel: true
                });
            });
        }
    </script>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-water"></i> 水利署監視器影像系統</h1>
            <p>經濟部水利署即時監控影像系統</p>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回首頁</a>
            <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode" style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; cursor: pointer; margin-left: 15px; font-size: 1.2rem;">
                <i class="fas fa-moon"></i>
            </button>
        
        <!-- 水利署監測影像說明 -->
        <div id="infoPanel" style="background: #e3f2fd; border-left: 4px solid #1976D2; padding: 20px; margin: 20px 0; border-radius: 8px; transition: all 0.3s ease;">
            <h3 style="color: #1976D2; margin: 0 0 15px 0; display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleInfoPanel()">
                <span>
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    水利署監測影像說明
                </span>
                <i id="toggleIcon" class="fas fa-chevron-up" style="transition: transform 0.3s ease;"></i>
            </h3>
            <div id="infoContent" style="color: #333; line-height: 1.6;">
                <p style="margin: 0 0 10px 0;">
                    水利署視訊監測影格照片由<strong>經濟部水利署</strong>獨自建置管理，用於監測河川、水庫等水利設施。
                </p>
                
                <div style="margin: 15px 0;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">📍 您可以前往以下官方網站查看即時水利監測資訊：</p>
                    <div style="margin-left: 20px;">
                        <p style="margin: 5px 0;">
                            • <a href="https://fhy.wra.gov.tw" target="_blank" style="color: #1976D2; text-decoration: none;">
                                經濟部水利署防災資訊服務網 <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                        <p style="margin: 5px 0;">
                            • <a href="https://www.wra.gov.tw" target="_blank" style="color: #1976D2; text-decoration: none;">
                                經濟部水利署官網 <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>
                        </p>
                    </div>
                </div>
                
                <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: #666; font-style: italic;">
                    💡 如需整合水利署監測影像資料，請聯繫水利署申請相關 API 權限。
                </p>
            </div>
        </div>
        
        <!-- 資料源篩選標籤 -->
        <div class="filter-tabs">
            <button class="tab-btn active" onclick="switchDataSource('all')">全部監視器</button>
            <button class="tab-btn" onclick="openDebugPage()" style="background: #FF9800; margin-left: 10px;">
                <i class="fas fa-bug"></i> 除錯工具
            </button>
        </div>

        <!-- 統計面板 -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-number" id="totalCameras">0</div>
                <div class="stat-label">總監視器數</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="wraCameras">0</div>
                <div class="stat-label">水利署直轄</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cooperativeCameras">0</div>
                <div class="stat-label">地方合建</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="onlineCameras">0</div>
                <div class="stat-label">有影像監視器</div>
            </div>
            <div class="stat-card">
                <div class="stat-time" id="currentTime"></div>
                <div class="stat-label">目前時間</div>
            </div>
        </div>

        <div class="search-section">
            <div class="search-form">
                <div class="form-group">
                    <label for="filterAuthority">主管機關</label>
                    <select id="filterAuthority">
                        <option value="all">全部機關</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterStatus">影像狀態</label>
                    <select id="filterStatus">
                        <option value="all">全部監視器</option>
                        <option value="with-image">有影像</option>
                        <option value="no-image">無影像</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sortBy">排序方式</label>
                    <select id="sortBy">
                        <option value="name">名稱排序</option>
                        <option value="location">位置排序</option>
                        <option value="update-time">更新時間</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="keyword">搜尋關鍵字</label>
                    <input type="text" id="keyword" placeholder="輸入監視器名稱、位置或說明">
                </div>
                <div>
                    <button class="search-btn" onclick="filterCameras()">搜尋</button>
                    <button class="refresh-btn" onclick="loadCameras()"><i class="fas fa-sync-alt"></i> 重新載入</button>
                </div>
            </div>
        </div>

        <div id="cameras-container" class="loading">載入水利署監視器資料中...</div>
    </div>

    <!-- 監視器影像彈窗 -->
    <div id="cameraModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <img id="modalImage" class="modal-image" src="" alt="監視器影像">
            <div class="modal-info">
                <h2 id="modalTitle">監視器資訊</h2>
                <p id="modalDescription"></p>
                <p id="modalLocation"></p>
                <p id="modalAuthority"></p>
                <p id="modalStationID"></p>
                <p id="modalUpdateTime"></p>
                <p id="modalCoordinates"></p>
            </div>
        </div>
    </div>

    <script>
        let allCameras = [];
        let filteredCameras = [];
        let currentDataSource = 'all';
        
        // 處理主管機關顯示 - 從描述中提取具體的河川分署或地方政府部門
        function formatAuthority(camera) {
            const thing = camera.Thing || {};
            const authority = thing.properties?.authority || '';
            const description = thing.description || thing.properties?.description || '';
            const name = thing.name || '';
            const location = thing.properties?.location || thing.properties?.stationName || name || '';
            
            // 如果來自水利署官方API，且已經有正確的河川分署資訊，直接使用
            if (camera.source === 'wra_official' && authority && authority.includes('河川分署')) {
                return authority;
            }
            
            // 如果 authority 是「水利署」，嘗試從 description 或 name 中提取河川分署資訊
            if (authority === '水利署') {
                // 優先尋找直接提到的河川分署資訊
                const riverBureauMatch = description.match(/第[一二三四五六七八九十]+河川分署|第\d+河川分署/) || 
                                        name.match(/第[一二三四五六七八九十]+河川分署|第\d+河川分署/) ||
                                        location.match(/第[一二三四五六七八九十]+河川分署|第\d+河川分署/);
                if (riverBureauMatch) {
                    return riverBureauMatch[0];
                }
                
                // 如果沒有直接提到分署，根據地理位置推斷河川分署管轄範圍
                const locationStr = location.toLowerCase();
                
                // 第一河川分署：基隆、台北、新北、桃園、新竹
                if (locationStr.includes('基隆') || locationStr.includes('台北') || locationStr.includes('臺北') || 
                    locationStr.includes('新北') || locationStr.includes('桃園') || locationStr.includes('新竹') ||
                    locationStr.includes('淡水河') || locationStr.includes('基隆河') || locationStr.includes('新店溪') ||
                    locationStr.includes('大漢溪') || locationStr.includes('景美溪') || locationStr.includes('頭前溪') ||
                    locationStr.includes('中原') || locationStr.includes('中壢') || locationStr.includes('平鎮') ||
                    locationStr.includes('龍潭') || locationStr.includes('楊梅') || locationStr.includes('竹北') ||
                    locationStr.includes('三峽') || locationStr.includes('汴子頭') || locationStr.includes('信義') ||
                    locationStr.includes('文山')) {
                    return '第一河川分署';
                }
                
                // 第二河川分署：苗栗、台中、南投
                if (locationStr.includes('苗栗') || locationStr.includes('台中') || locationStr.includes('臺中') ||
                    locationStr.includes('南投') || locationStr.includes('後龍溪') || locationStr.includes('大安溪') ||
                    locationStr.includes('大甲溪') || locationStr.includes('烏溪') || locationStr.includes('濁水溪上游') ||
                    locationStr.includes('頭份') || locationStr.includes('竹南') || locationStr.includes('豐原') ||
                    locationStr.includes('沙鹿') || locationStr.includes('清水') || locationStr.includes('草屯') ||
                    locationStr.includes('筏子溪') || locationStr.includes('中科') || locationStr.includes('連仔橋') ||
                    locationStr.includes('圓潭') || locationStr.includes('中埔')) {
                    return '第二河川分署';
                }
                
                // 第三河川分署：雲林、嘉義
                if (locationStr.includes('雲林') || locationStr.includes('嘉義') ||
                    locationStr.includes('濁水溪') || locationStr.includes('北港溪') || locationStr.includes('朴子溪') ||
                    locationStr.includes('西螺') || locationStr.includes('虎尾') || locationStr.includes('斗六') ||
                    locationStr.includes('朴子') || locationStr.includes('民雄') || locationStr.includes('水上')) {
                    return '第三河川分署';
                }
                
                // 第四河川分署：彰化、台南、高雄、屏東
                if (locationStr.includes('彰化') || locationStr.includes('伸港') ||
                    locationStr.includes('台南') || locationStr.includes('臺南') || 
                    locationStr.includes('高雄') || locationStr.includes('屏東') ||
                    locationStr.includes('曾文溪') || locationStr.includes('鹽水溪') || locationStr.includes('二仁溪') ||
                    locationStr.includes('阿公店溪') || locationStr.includes('愛河') || locationStr.includes('高屏溪') ||
                    locationStr.includes('東港溪') || locationStr.includes('林邊溪') ||
                    locationStr.includes('大鵬') || locationStr.includes('岡山') || locationStr.includes('鳳山') ||
                    locationStr.includes('旗山') || locationStr.includes('美濃') || locationStr.includes('六龜') ||
                    locationStr.includes('湳仔溝') || locationStr.includes('山上') || locationStr.includes('菜公寮') ||
                    locationStr.includes('楠梓') || locationStr.includes('美上美')) {
                    return '第四河川分署';
                }
                
                // 第五河川分署：宜蘭、花蓮
                if (locationStr.includes('宜蘭') || locationStr.includes('花蓮') ||
                    locationStr.includes('蘭陽溪') || locationStr.includes('立霧溪') || locationStr.includes('花蓮溪') ||
                    locationStr.includes('秀姑巒溪') || locationStr.includes('嘉寶潭') || locationStr.includes('羅東') ||
                    locationStr.includes('礁溪') || locationStr.includes('壯圍') || locationStr.includes('吉安') ||
                    locationStr.includes('新城') || locationStr.includes('秀林') || locationStr.includes('玉里')) {
                    return '第五河川分署';
                }
                
                // 第六河川分署：台東
                if (locationStr.includes('台東') || locationStr.includes('臺東') ||
                    locationStr.includes('卑南溪') || locationStr.includes('太麻里溪') || locationStr.includes('知本溪') ||
                    locationStr.includes('鸞山')) {
                    return '第六河川分署';
                }
                
                // 第七河川分署：澎湖、金門、馬祖（離島）
                if (locationStr.includes('澎湖') || locationStr.includes('金門') || locationStr.includes('馬祖')) {
                    return '第七河川分署';
                }
                
                // 對於無法從地名判斷的監視器，嘗試從其他資訊推斷
                // 首先檢查是否為編號式監視器
                if (locationStr.match(/^[a-z]\d+$|^[A-Z]\d+$/)) {  // 純編號式監視器(如 C8, B6)
                    console.log(`監視器編號 ${location} 無法確定分署，暫時歸類為第一河川分署`);
                    return '第一河川分署（待確認）';
                }
                
                // 檢查是否有河川或水系相關關鍵字
                if (locationStr.includes('溪') || locationStr.includes('河') || locationStr.includes('橋') ||
                    locationStr.includes('堤防') || locationStr.includes('抽水站') || locationStr.includes('水門')) {
                    
                    // 根據常見的河川系統推斷可能的分署
                    if (locationStr.match(/[a-z]\d+|[A-Z]\d+/)) {  // 包含編號的水利設施
                        console.log(`水利設施 ${location} 無法確定分署，暫時歸類為第一河川分署`);
                        return '第一河川分署（待確認）';
                    }
                }
                
                // 如果找不到具體分署，返回「水利署」
                return '水利署';
            }
            
            // 如果 authority 是「水利署（與縣市政府合建）」，嘗試從其他欄位找出具體的地方政府部門
            if (authority.includes('水利署') && authority.includes('合建')) {
                // 嘗試從 description 中提取地方政府資訊（包含完整的縣市名稱）
                const localGovMatch = description.match(/[\u4e00-\u9fa5]+[縣市]政府[\u4e00-\u9fa5]+[局科處]/);
                if (localGovMatch) {
                    return localGovMatch[0];
                }
                
                // 從位置資訊推斷具體的地方政府水利單位
                const locationStr = location.toLowerCase();
                
                // 優先檢查特定地名和地址關鍵字
                if (locationStr.includes('花蓮')) return '花蓮縣政府水利科';
                if (locationStr.includes('台中') || locationStr.includes('臺中')) return '台中市政府水利局';
                if (locationStr.includes('新北')) return '新北市政府水利局';
                if (locationStr.includes('台北') || locationStr.includes('臺北') || locationStr.includes('中山東路')) return '台北市政府水利局';
                if (locationStr.includes('桃園') || locationStr.includes('龍潭區')) return '桃園市政府水務局';
                if (locationStr.includes('高雄')) return '高雄市政府水利局';
                if (locationStr.includes('台南') || locationStr.includes('臺南')) return '台南市政府水利局';
                if (locationStr.includes('彰化')) return '彰化縣政府水利科';
                if (locationStr.includes('雲林')) return '雲林縣政府水利科';
                if (locationStr.includes('嘉義')) return '嘉義縣政府水利科';
                if (locationStr.includes('屏東')) return '屏東縣政府水利科';
                if (locationStr.includes('宜蘭')) return '宜蘭縣政府水利科';
                if (locationStr.includes('台東') || locationStr.includes('臺東')) return '台東縣政府水利科';
                if (locationStr.includes('南投')) return '南投縣政府水利科';
                if (locationStr.includes('苗栗')) return '苗栗縣政府水利科';
                if (locationStr.includes('新竹')) return '新竹縣政府水利科';
                if (locationStr.includes('基隆')) return '基隆市政府都市發展處';
                if (locationStr.includes('澎湖')) return '澎湖縣政府水利科';
                if (locationStr.includes('金門')) return '金門縣政府建設處';
                if (locationStr.includes('連江') || locationStr.includes('馬祖')) return '連江縣政府建設局';
                
                // 根據監視器編號或特殊地標推斷
                if (locationStr.includes('c05') || locationStr.includes('山鼻橋')) {
                    // 山鼻橋通常在高雄地區
                    return '高雄市政府水利局';
                }
                if (locationStr.includes('c08') || locationStr.includes('西坡渠')) {
                    // 西坡渠可能在台中地區
                    return '台中市政府水利局';
                }
                if (locationStr.includes('士校大池')) {
                    // 士校大池可能在桃園地區
                    return '桃園市政府水務局';
                }
                if (locationStr.includes('中山路') && !locationStr.includes('中山東路')) {
                    // 一般中山路，需要更多資訊，暫時歸類為台北市
                    return '台北市政府水利局';
                }
                
                // 如果都找不到，返回原始 authority
                return authority;
            }
            
            // 其他情況直接返回 authority
            return authority || 'N/A';
        }
        
        // 切換資訊面板顯示/隱藏
        function toggleInfoPanel() {
            const content = document.getElementById('infoContent');
            const icon = document.getElementById('toggleIcon');
            const panel = document.getElementById('infoPanel');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                icon.style.transform = 'rotate(0deg)';
                panel.style.background = '#e3f2fd';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                icon.style.transform = 'rotate(180deg)';
                panel.style.background = '#f5f5f5';
            }
        }
        
        // 處理影像載入錯誤 - 簡化版本
        function handleImageError(img, originalUrl, name) {
            console.warn(`影像載入失敗: ${name} - ${originalUrl}`);
            
            // 直接顯示錯誤訊息，不再重試
            const placeholder = img.parentElement.querySelector('.image-placeholder');
            if (placeholder) {
                placeholder.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px; color: #FFB74D;"></i>
                    <span style="font-size: 0.9rem; text-align: center; padding: 0 10px;">影像載入失敗</span>
                    <span style="font-size: 0.7rem; opacity: 0.8; margin-top: 5px;">${name}</span>
                `;
                placeholder.style.background = 'linear-gradient(135deg, #FFB74D 0%, #FF8A65 100%)';
            }
            
            // 隱藏失敗的圖片元素
            img.style.display = 'none';
        }
        
        // 重新嘗試載入影像
        function retryLoadImage(url, name, button) {
            const container = button.parentElement;
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #1976D2;"></i>
                    <span style="font-size: 0.8rem; margin-top: 8px;">重新載入中...</span>
                </div>
            `;
            
            setTimeout(() => {
                const newImg = document.createElement('img');
                newImg.src = url + '?retry=' + Date.now();
                newImg.alt = name;
                newImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                newImg.crossOrigin = 'anonymous';
                newImg.onerror = () => handleImageError(newImg, url, name);
                newImg.onload = () => {
                    container.innerHTML = '';
                    container.appendChild(newImg);
                };
            }, 1000);
        }
        
        // 顯示成功載入的影像
        function showLoadedImage(img) {
            console.log('影像成功載入:', img.src);
            const placeholder = img.parentElement.querySelector('.image-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            img.style.opacity = '1';
        }
        
        // 開啟除錯工具頁面
        function openDebugPage() {
            window.open('water-test.html', '_blank');
        }
        
        // 在新頁面開啟影像
        function openImageInNewTab(url, name) {
            console.log('開啟影像:', url);
            
            // 創建一個新的頁面來顯示影像
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                <head>
                    <title>${name} - 水利署監測影像</title>
                    <style>
                        body { 
                            margin: 0; 
                            padding: 20px; 
                            background: #f0f0f0; 
                            font-family: Arial, sans-serif;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                        }
                        .header {
                            background: #1976D2;
                            color: white;
                            padding: 15px 30px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            text-align: center;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        }
                        .image-container {
                            background: white;
                            padding: 20px;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                            max-width: 90vw;
                            max-height: 80vh;
                        }
                        img {
                            max-width: 100%;
                            max-height: 70vh;
                            object-fit: contain;
                            border-radius: 8px;
                        }
                        .error-message {
                            color: #ff6b6b;
                            text-align: center;
                            padding: 40px;
                            font-size: 1.1rem;
                        }
                        .retry-btn {
                            background: #1976D2;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            margin-top: 15px;
                            font-size: 1rem;
                        }
                        .retry-btn:hover {
                            background: #1565C0;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>${name}</h2>
                        <p>經濟部水利署監測影像</p>
                    </div>
                    <div class="image-container">
                        <img src="${url}" alt="${name}" 
                             onerror="document.querySelector('.image-container').innerHTML='<div class=\\"error-message\\">影像載入失敗<br><small>${url}</small><br><button class=\\"retry-btn\\" onclick=\\"location.reload()\\">重新載入</button></div>'"
                             onload="console.log('影像載入成功')">
                    </div>
                    <div style="margin-top: 20px; text-align: center; color: #666; font-size: 0.9rem;">
                        <p>⚠️ 如果影像無法顯示，可能是因為：</p>
                        <ul style="text-align: left; display: inline-block;">
                            <li>水利署API需要特殊認證</li>
                            <li>網路連線問題</li>
                            <li>影像暫時不可用</li>
                        </ul>
                    </div>
                
    <!-- Back to Top Button -->
    <div class="back-to-top" id="backToTop" style="position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999; font-size: 1.2rem;">
        <i class="fas fa-arrow-up"></i>
    </div>
</body>
                </html>
            `);
        }

        async function loadCameras() {
            try {
                const container = document.getElementById('cameras-container');
                
                // 創建動態載入進度指示器
                function createProgressIndicator() {
                    return `
                        <div class="loading">
                            <div style="background: rgba(33, 150, 243, 0.1); border-radius: 15px; padding: 30px; max-width: 600px; margin: 0 auto;">
                                <i class="fas fa-water fa-spin" style="font-size: 3rem; margin-bottom: 1.5rem; color: #2196F3;"></i>
                                <div style="font-size: 1.4rem; font-weight: bold; margin-bottom: 1rem; color: #2196F3;">水利署監視器載入中</div>
                                
                                <!-- 進度條 -->
                                <div style="background: rgba(33, 150, 243, 0.2); border-radius: 10px; height: 8px; margin: 1rem 0; overflow: hidden;">
                                    <div id="progress-bar" style="background: linear-gradient(90deg, #2196F3, #21CBF3); height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 10px;"></div>
                                </div>
                                
                                <!-- 載入步驟 -->
                                <div id="loading-steps" style="text-align: left; margin-top: 1.5rem;">
                                    <div class="loading-step" data-step="1">
                                        <i class="fas fa-circle-notch fa-spin" style="color: #2196F3; margin-right: 8px;"></i>
                                        <span>連接水利署官方 API...</span>
                                    </div>
                                    <div class="loading-step" data-step="2" style="opacity: 0.4;">
                                        <i class="fas fa-circle" style="color: #ccc; margin-right: 8px;"></i>
                                        <span>連接 SensorThings API...</span>
                                    </div>
                                    <div class="loading-step" data-step="3" style="opacity: 0.4;">
                                        <i class="fas fa-circle" style="color: #ccc; margin-right: 8px;"></i>
                                        <span>處理監視器資料...</span>
                                    </div>
                                    <div class="loading-step" data-step="4" style="opacity: 0.4;">
                                        <i class="fas fa-circle" style="color: #ccc; margin-right: 8px;"></i>
                                        <span>生成監視器卡片...</span>
                                    </div>
                                </div>
                                
                                <!-- 統計資訊 -->
                                <div id="loading-stats" style="margin-top: 1.5rem; font-size: 0.9rem; opacity: 0.8;">
                                    <div>📊 <span id="current-count">0</span> 個監視器已載入</div>
                                    <div>⏱️ 預計完成時間：<span id="estimated-time">計算中...</span></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // 更新進度的函數
                function updateProgress(step, progress, message, count = 0) {
                    // 安全地更新全域進度條
                    try {
                        if (typeof window.setLoadingProgress === 'function') {
                            window.setLoadingProgress(progress);
                        }
                        if (message && typeof window.updateLoadingLabel === 'function') {
                            window.updateLoadingLabel(message);
                        }
                    } catch (error) {
                        console.warn('進度更新失敗:', error);
                    }
                    
                    // 更新進度條
                    const progressBar = document.getElementById('progress-bar');
                    if (progressBar) {
                        progressBar.style.width = `${progress}%`;
                    }
                    
                    // 更新當前步驟
                    const steps = document.querySelectorAll('.loading-step');
                    steps.forEach((stepEl, index) => {
                        const stepNumber = index + 1;
                        const icon = stepEl.querySelector('i');
                        const span = stepEl.querySelector('span');
                        
                        if (stepNumber < step) {
                            // 已完成的步驟
                            stepEl.style.opacity = '1';
                            icon.className = 'fas fa-check-circle';
                            icon.style.color = '#4CAF50';
                        } else if (stepNumber === step) {
                            // 當前步驟
                            stepEl.style.opacity = '1';
                            icon.className = 'fas fa-circle-notch fa-spin';
                            icon.style.color = '#2196F3';
                            if (message) span.textContent = message;
                        } else {
                            // 未開始的步驟
                            stepEl.style.opacity = '0.4';
                            icon.className = 'fas fa-circle';
                            icon.style.color = '#ccc';
                        }
                    });
                    
                    // 更新統計資訊
                    const currentCountEl = document.getElementById('current-count');
                    if (currentCountEl) currentCountEl.textContent = count;
                    
                    const estimatedTimeEl = document.getElementById('estimated-time');
                    if (estimatedTimeEl) {
                        const remaining = Math.max(0, Math.ceil((100 - progress) / 10));
                        estimatedTimeEl.textContent = remaining > 0 ? `${remaining} 秒` : '即將完成';
                    }
                }
                
                // 初始化載入指示器
                container.innerHTML = createProgressIndicator();
                updateProgress(1, 10, '連接水利署官方 API...');

                // 優先使用水利署官方 API
                let wraApiCameras = [];
                try {
                    console.log('🔄 嘗試載入水利署官方 API...');
                    await new Promise(resolve => setTimeout(resolve, 800)); // 模擬連接時間
                    
                    const wraApiResponse = await fetch('https://fmg.wra.gov.tw/swagger/api/cctv_citynew');
                    updateProgress(1, 20, '正在獲取水利署資料...');
                    
                    if (wraApiResponse.ok) {
                        const wraApiData = await wraApiResponse.json();
                        if (wraApiData.cctvs && wraApiData.cctvs.length > 0) {
                            console.log(`✅ 成功載入水利署官方 API: ${wraApiData.cctvs.length} 筆資料`);
                            updateProgress(2, 35, '處理水利署監視器資料...', wraApiData.cctvs.length);
                            
                            wraApiCameras = wraApiData.cctvs.map(camera => ({
                                '@iot.id': `wra_${camera.cctv_name}_${camera.lat}_${camera.lon}`,
                                Thing: {
                                    name: camera.cctv_name,
                                    properties: {
                                        stationName: camera.cctv_name,
                                        authority: camera.wraunit_name || '水利署',
                                        location: `${camera.city_name}${camera.town_name}`,
                                        station_name: camera.station_name
                                    },
                                    location: {
                                        coordinates: [camera.lon, camera.lat]
                                    }
                                },
                                Observations: camera.new_imgurl ? [{
                                    result: camera.new_imgurl,
                                    phenomenonTime: new Date().toISOString()
                                }] : [],
                                source: 'wra_official',
                                sourceLabel: '水利署官方API',
                                streamUrl: camera.stream_url
                            }));
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ 水利署官方 API 載入失敗，改用 STA API:', error.message);
                    updateProgress(2, 25, '水利署 API 連接失敗，切換備用 API...');
                }

                // 如果官方API無資料或失敗，使用備用的 STA API
                if (wraApiCameras.length === 0) {
                    console.log('🔄 使用 STA API 載入監視器資料...');
                    updateProgress(2, 30, '連接 SensorThings API...');
                    
                    // 先嘗試全域搜尋了解總共有多少監視器
                    try {
                        await new Promise(resolve => setTimeout(resolve, 600)); // 模擬連接時間
                        const allCamerasResponse = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$count=true&$top=0');
                        if (allCamerasResponse.ok) {
                            const allCamerasData = await allCamerasResponse.json();
                            console.log(`📊 STA 資料庫總共有 ${allCamerasData['@iot.count']} 個監視器`);
                        }
                    } catch (e) {
                        console.warn('無法獲取總監視器數量');
                    }
                    
                    // 載入水利署直轄監視器
                    updateProgress(2, 40, '載入水利署直轄監視器...');
                    const wraResponse = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%27&$count=true');
                
                    // 載入水利署與地方政府合建監視器
                    updateProgress(2, 50, '載入合作建置監視器...');
                    const cooperativeResponse = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%EF%BC%88%E8%88%87%E7%B8%A3%E5%B8%82%E6%94%BF%E5%BA%9C%E5%90%88%E5%BB%BA%EF%BC%89%27&$count=true');
                    
                    // 嘗試載入更多相關的水利單位
                    updateProgress(2, 60, '搜尋地方水利單位監視器...');
                    const extendedLocalResponses = await Promise.allSettled([
                        // 原有的查詢
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E8%8A%B1%E8%93%AE%E7%B8%A3%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%88%A9%E7%A7%91%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E8%8A%B1%E8%93%AE%E7%B8%A3%E6%94%BF%E5%BA%9C%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E8%8A%B1%E8%93%AE%E7%B8%A3%E5%BB%BA%E8%A8%AD%E8%99%95%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E5%8F%B0%E5%8C%97%E5%B8%82%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%88%A9%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E5%8F%B0%E5%8C%97%E5%B8%82%E6%94%BF%E5%BA%9C%E5%B7%A5%E5%8B%99%E5%B1%80%E6%B0%B4%E5%88%A9%E5%B7%A5%E7%A8%8B%E8%99%95%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%96%B0%E5%8C%97%E5%B8%82%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%88%A9%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E6%A1%83%E5%9C%92%E5%B8%82%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%8B%99%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E5%8F%B0%E4%B8%AD%E5%B8%82%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%88%A9%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E9%AB%98%E9%9B%84%E5%B8%82%E6%94%BF%E5%BA%9C%E6%B0%B4%E5%88%A9%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E8%87%BA%E5%8C%97%E5%B8%82%E6%94%BF%E5%BA%9C%E5%B7%A5%E5%8B%99%E5%B1%80%27&$count=true'),
                        
                        // 嘗試更廣泛的搜尋
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=contains(Thing/properties/authority,%27%E6%B0%B4%E5%88%A9%27)&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=contains(Thing/properties/authority,%27%E6%B2%B3%E5%B7%9D%27)&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=contains(Thing/properties/authority,%27%E5%88%86%E7%BD%B2%27)&$count=true'),
                        
                        // 其他可能的水利相關單位
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%B6%93%E6%BF%9F%E9%83%A8%E6%B0%B4%E5%88%A9%E7%BD%B2%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E4%B8%80%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E4%BA%8C%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E4%B8%89%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E5%9B%9B%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E4%BA%94%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true'),
                        fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations&$filter=Thing/properties/authority%20eq%20%27%E7%AC%AC%E5%85%AD%E6%B2%B3%E5%B7%9D%E5%B1%80%27&$count=true')
                    ]);
                    
                    if (!wraResponse.ok || !cooperativeResponse.ok) {
                        throw new Error('API 回應錯誤');
                    }

                    const wraData = await wraResponse.json();
                    const cooperativeData = await cooperativeResponse.json();
                    
                    updateProgress(3, 70, '處理監視器資料中...', wraData.value?.length || 0);
                    
                    // 處理地方政府水利單位的回應
                    const localCameras = [];
                    let processedCount = 0;
                    
                    for (const response of extendedLocalResponses) {
                        if (response.status === 'fulfilled' && response.value.ok) {
                            const data = await response.value.json();
                            if (data.value && data.value.length > 0) {
                                console.log(`找到地方水利單位資料: ${data.value.length} 筆`, data.value[0]?.Thing?.properties?.authority);
                                const cameras = data.value.map(camera => ({
                                    ...camera,
                                    source: 'local',
                                    sourceLabel: '地方水利單位'
                                }));
                                localCameras.push(...cameras);
                                processedCount += data.value.length;
                                
                                // 更新處理進度
                                updateProgress(3, 70 + (processedCount / 50), '處理地方水利單位資料...', processedCount);
                            }
                        }
                    }
                    
                    console.log(`STA API 載入: 水利署 ${wraData.value?.length || 0} 筆, 合建 ${cooperativeData.value?.length || 0} 筆, 地方 ${localCameras.length} 筆`);
                    
                    // 合併STA API資料並標記來源
                    const wraCameras = (wraData.value || []).map(camera => ({
                        ...camera,
                        source: 'wra',
                        sourceLabel: '水利署直轄'
                    }));

                    const cooperativeCameras = (cooperativeData.value || []).map(camera => ({
                        ...camera,
                        source: 'cooperative',
                        sourceLabel: '水利署與地方合建'
                    }));
                    
                    // 合併STA API的資料
                    const staCameras = [...wraCameras, ...cooperativeCameras, ...localCameras];
                    wraApiCameras = [...wraApiCameras, ...staCameras];
                }

                updateProgress(3, 85, '合併並去除重複資料...');
                
                // 去除重複項目並合併資料
                const allCamerasMap = new Map();
                wraApiCameras.forEach(camera => {
                    const id = camera['@iot.id'];
                    if (!allCamerasMap.has(id)) {
                        allCamerasMap.set(id, camera);
                    }
                });
                
                allCameras = Array.from(allCamerasMap.values());
                
                updateProgress(4, 90, '生成監視器卡片...', allCameras.length);
                
                if (allCameras.length === 0) {
                    container.innerHTML = '<div class="loading">無水利署監視器資料</div>';
                    return;
                }

                filteredCameras = allCameras;
                
                // 最終步驟：生成介面
                updateProgress(4, 95, '生成監視器介面...', allCameras.length);
                await new Promise(resolve => setTimeout(resolve, 300)); // 讓使用者看到進度完成
                
                updateStats();
                populateAuthorityFilter();
                applyCurrentFilter();
                
                // 載入完成
                updateProgress(4, 100, '載入完成！', allCameras.length);
                
                // 完成全域載入進度
                setTimeout(() => {
                    if (typeof window.finishLoading === 'function') {
                        window.finishLoading();
                    }
                }, 1000);
                
                // 短暫延遲後顯示完成狀態，然後顯示監視器內容
                setTimeout(() => {
                    const steps = document.querySelectorAll('.loading-step');
                    steps.forEach(stepEl => {
                        const icon = stepEl.querySelector('i');
                        stepEl.style.opacity = '1';
                        icon.className = 'fas fa-check-circle';
                        icon.style.color = '#4CAF50';
                    });
                    
                    // 0.5秒後顯示監視器內容並淡出載入畫面
                    setTimeout(() => {
                        // 先顯示監視器內容
                        displayCameras();
                        
                        // 然後淡出載入畫面
                        const loadingEl = document.querySelector('.loading');
                        if (loadingEl) {
                            loadingEl.style.transition = 'opacity 0.5s ease';
                            loadingEl.style.opacity = '0';
                            setTimeout(() => {
                                if (loadingEl.parentNode) {
                                    loadingEl.remove();
                                }
                            }, 500);
                        }
                    }, 500);
                }, 200);
                
                console.log(`成功載入 ${allCameras.length} 個水利署監視器`);
                
                // 除錯資訊：檢查影像URL
                const imagesWithUrl = allCameras.filter(c => c.Observations && c.Observations[0] && c.Observations[0].result);
                const imagesWithoutUrl = allCameras.filter(c => !c.Observations || !c.Observations[0] || !c.Observations[0].result);
                console.log(`有影像URL: ${imagesWithUrl.length}, 無影像URL: ${imagesWithoutUrl.length}`);
                
                if (imagesWithUrl.length > 0) {
                    console.log('範例影像URL:', imagesWithUrl[0].Observations[0].result);
                }
                
            } catch (error) {
                console.error('載入失敗:', error);
                document.getElementById('cameras-container').innerHTML = 
                    `<div class="loading">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        載入失敗：${error.message}<br><br>
                        <button onclick="loadCameras()" class="search-btn">重新嘗試</button>
                    </div>`;
            }
        }

        function switchDataSource(source) {
            currentDataSource = source;
            
            // 更新標籤狀態
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            applyCurrentFilter();
        }

        function applyCurrentFilter() {
            // 根據資料源篩選
            let sourceFilteredCameras = allCameras;
            
            if (currentDataSource === 'wra') {
                sourceFilteredCameras = allCameras.filter(camera => camera.source === 'wra');
            } else if (currentDataSource === 'cooperative') {
                sourceFilteredCameras = allCameras.filter(camera => camera.source === 'cooperative');
            }
            
            // 應用其他篩選條件
            const filterAuthority = document.getElementById('filterAuthority').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const sortBy = document.getElementById('sortBy').value;
            const keyword = document.getElementById('keyword').value.toLowerCase().trim();

            filteredCameras = sourceFilteredCameras.filter(camera => {
                const thing = camera.Thing || {};
                const name = (thing.name || '').toLowerCase();
                const description = (thing.properties?.authority || '').toLowerCase();
                const location = (thing.properties?.location || '').toLowerCase();
                
                // 主管機關篩選
                const cameraAuthority = formatAuthority(camera);
                const matchAuthority = filterAuthority === 'all' || cameraAuthority === filterAuthority;
                
                // 關鍵字篩選
                const matchKeyword = !keyword || 
                    name.includes(keyword) || 
                    description.includes(keyword) || 
                    location.includes(keyword);

                // 影像狀態篩選
                const latestObs = camera.Observations && camera.Observations.length > 0 ? camera.Observations[0] : null;
                const hasImage = latestObs && latestObs.result && latestObs.result.trim() !== '';
                
                let matchStatus = true;
                if (filterStatus === 'with-image') {
                    matchStatus = hasImage;
                } else if (filterStatus === 'no-image') {
                    matchStatus = !hasImage;
                }

                return matchAuthority && matchKeyword && matchStatus;
            });

            // 排序
            filteredCameras.sort((a, b) => {
                const aName = a.Thing?.name || '';
                const bName = b.Thing?.name || '';
                const aLocation = a.Thing?.properties?.location || '';
                const bLocation = b.Thing?.properties?.location || '';
                const aTime = a.Observations?.[0]?.phenomenonTime || '';
                const bTime = b.Observations?.[0]?.phenomenonTime || '';

                switch(sortBy) {
                    case 'location':
                        return aLocation.localeCompare(bLocation, 'zh-TW');
                    case 'update-time':
                        return new Date(bTime) - new Date(aTime);
                    case 'name':
                    default:
                        return aName.localeCompare(bName, 'zh-TW');
                }
            });

            displayCameras();
        }

        function updateStats() {
            const total = allCameras.length;
            const wraCount = allCameras.filter(camera => camera.source === 'wra').length;
            const cooperativeCount = allCameras.filter(camera => camera.source === 'cooperative').length;
            const withImage = allCameras.filter(camera => {
                const latestObs = camera.Observations && camera.Observations.length > 0 ? camera.Observations[0] : null;
                return latestObs && latestObs.result && latestObs.result.trim() !== '';
            }).length;

            document.getElementById('totalCameras').textContent = total;
            document.getElementById('wraCameras').textContent = wraCount;
            document.getElementById('cooperativeCameras').textContent = cooperativeCount;
            document.getElementById('onlineCameras').textContent = withImage;
        }

        // 填充主管機關篩選下拉選單
        function populateAuthorityFilter() {
            const authorities = new Set();
            allCameras.forEach(camera => {
                const authority = formatAuthority(camera);
                if (authority && authority !== 'N/A') {
                    authorities.add(authority);
                }
            });
            
            const sortedAuthorities = Array.from(authorities).sort((a, b) => a.localeCompare(b, 'zh-TW'));
            
            const select = document.getElementById('filterAuthority');
            select.innerHTML = '<option value="all">全部機關</option>';
            
            sortedAuthorities.forEach(authority => {
                const option = document.createElement('option');
                option.value = authority;
                option.textContent = `${authority} (${allCameras.filter(c => formatAuthority(c) === authority).length})`;
                select.appendChild(option);
            });
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        function filterCameras() {
            applyCurrentFilter();
        }

        function displayCameras() {
            const container = document.getElementById('cameras-container');
            
            if (filteredCameras.length === 0) {
                container.innerHTML = '<div class="loading">無符合條件的監視器</div>';
                return;
            }
            
            console.log(`準備顯示 ${filteredCameras.length} 個監視器`);
            
            // 除錯：檢查當前要顯示的監視器中有影像的數量
            const withImages = filteredCameras.filter(c => {
                const latestObs = c.Observations && c.Observations.length > 0 ? c.Observations[0] : null;
                const imageUrl = latestObs?.result || '';
                return imageUrl && imageUrl.trim() !== '';
            });
            console.log(`其中有影像URL的監視器: ${withImages.length}`);
            if (withImages.length > 0) {
                console.log('第一個影像URL範例:', withImages[0].Observations[0].result);
            }

            const html = filteredCameras.map((camera, index) => {
                const thing = camera.Thing || {};
                const name = thing.properties?.stationName || (thing.name && !thing.name.match(/^[0-9a-f-]{36}$/i) ? thing.name : '未命名監視器');
                const description = thing.properties?.authority || '無說明';
                // 位置優先使用 stationName，如果沒有則使用 location，最後才用 name
                const location = thing.properties?.stationName || thing.properties?.location || (thing.name && !thing.name.match(/^[0-9a-f-]{36}$/i) ? thing.name : '位置未知');
                const authority = formatAuthority(camera);
                
                const latestObs = camera.Observations && camera.Observations.length > 0 ? camera.Observations[0] : null;
                const imageUrl = latestObs?.result || '';
                const hasImage = imageUrl && imageUrl.trim() !== '';
                const updateTime = latestObs?.phenomenonTime || '';
                
                return `
                    <div class="camera-card" onclick="showModal(${allCameras.indexOf(camera)})">
                        <div class="camera-image">
                            ${hasImage ? 
                                `<div class="image-container" data-url="${imageUrl}" data-name="${name}" style="position: relative; cursor: pointer; transition: transform 0.3s ease;" onclick="openImageInNewTab('${imageUrl}', '${name}')" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    <div class="image-placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); color: white; height: 100%; position: relative;">
                                        <i class="fas fa-video" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.9; animation: pulse 2s infinite;"></i>
                                        <span style="font-size: 1rem; text-align: center; padding: 0 10px; font-weight: bold;">水利署官方影像</span>
                                        <span style="font-size: 0.85rem; opacity: 0.9; margin-top: 8px; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">
                                            <i class="fas fa-hand-pointer"></i> 點擊開啟
                                        </span>
                                        <div style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.3); padding: 6px 10px; border-radius: 15px;">
                                            <i class="fas fa-external-link-alt" style="font-size: 0.9rem;"></i>
                                        </div>
                                        <div style="position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.4); padding: 4px 12px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">
                                            <i class="fas fa-shield-alt"></i> 官方認證影像
                                        </div>
                                    </div>
                                    <style>
                                        @keyframes pulse {
                                            0%, 100% { opacity: 0.9; transform: scale(1); }
                                            50% { opacity: 1; transform: scale(1.1); }
                                        }
                                    </style>
                                    <img src="${imageUrl}" 
                                         alt="${name}" 
                                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s;"
                                         crossorigin="anonymous"
                                         loading="lazy"
                                         onload="showLoadedImage(this)"
                                         onerror="handleImageError(this, '${imageUrl}', '${name}')">
                                </div>` : 
                                '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; background: #f5f5f5;"><i class="fas fa-video-slash" style="font-size: 3rem; margin-bottom: 10px;"></i><span>無影像資料</span></div>'
                            }
                        </div>
                        <div class="camera-info">
                            <div class="camera-title">${name}</div>
                            <div class="camera-details">
                                <strong><i class="fas fa-building"></i> 主管機關：</strong>${authority}<br>
                                <strong><i class="fas fa-map-marker-alt"></i> 位置：</strong>${location}
                            </div>
                            <span class="camera-status ${hasImage ? 'status-online' : 'status-offline'}">
                                ${hasImage ? '● 有影像' : '● 無影像'}
                            </span>
                            ${updateTime ? `<div style="font-size: 0.8rem; color: #999; margin-top: 8px;">
                                <i class="fas fa-clock"></i> ${new Date(updateTime).toLocaleString('zh-TW')}
                            </div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="cameras-grid">${html}</div>`;
        }

        function showModal(index) {
            const camera = allCameras[index];
            const thing = camera.Thing || {};
            const latestObs = camera.Observations && camera.Observations.length > 0 ? camera.Observations[0] : null;
            const imageUrl = latestObs?.result || '';
            
            // 檢查是否為特定的監測站
            const stationID = thing.properties?.stationID || camera['@iot.id'] || '';
            const isSpecialStation = stationID === '007d029e-2adc-4012-8602-7d69796cbcc8';
            
            document.getElementById('modalImage').src = imageUrl || 'data:image/svg+xml,<svg width="400" height="300" xmlns="http://www.w3.org/2000/svg"><rect width="400" height="300" fill="%23f5f5f5"/><text x="50%" y="50%" font-family="Arial" font-size="18" fill="%23999" text-anchor="middle" dy=".3em">無影像資料</text></svg>';
            document.getElementById('modalTitle').textContent = thing.properties?.stationName || (thing.name && !thing.name.match(/^[0-9a-f-]{36}$/i) ? thing.name : '未命名監視器');
            
            let descriptionHtml = `
                <strong><i class="fas fa-tag"></i> 類型：</strong>${camera.sourceLabel || '水利署'}<br>
                <strong><i class="fas fa-info-circle"></i> 說明：</strong>${thing.properties?.authority || '無說明'}
            `;
            
            // 為特定監測站添加說明
            if (isSpecialStation) {
                descriptionHtml += `<br><div style="background: #e3f2fd; padding: 8px; border-radius: 4px; margin-top: 8px; border-left: 3px solid #2196f3;">
                    <i class="fas fa-info-circle" style="color: #2196f3;"></i> 
                    <strong>智慧防汛系統</strong> - 觀音坑溪排水監控，屬於水資源管理範疇
                </div>`;
            }
            
            document.getElementById('modalDescription').innerHTML = descriptionHtml;
            document.getElementById('modalLocation').innerHTML = `<strong><i class="fas fa-map-marker-alt"></i> 位置：</strong>${thing.properties?.stationName || thing.properties?.location || (thing.name && !thing.name.match(/^[0-9a-f-]{36}$/i) ? thing.name : '位置未知')}`;
            document.getElementById('modalAuthority').innerHTML = `<strong><i class="fas fa-building"></i> 主管機關：</strong>${formatAuthority(camera)}`;
            document.getElementById('modalStationID').innerHTML = `<strong><i class="fas fa-id-card"></i> 監測站名稱：</strong>${thing.properties?.stationName || thing.name || '未知'}`;
            
            if (latestObs?.phenomenonTime) {
                document.getElementById('modalUpdateTime').innerHTML = `<strong><i class="fas fa-clock"></i> 資料時間：</strong>${new Date(latestObs.phenomenonTime).toLocaleString('zh-TW')}`;
            } else {
                document.getElementById('modalUpdateTime').innerHTML = '';
            }

            // 顯示座標資訊（如果有的話）
            if (thing.location && thing.location.coordinates) {
                const coords = thing.location.coordinates;
                document.getElementById('modalCoordinates').innerHTML = `<strong><i class="fas fa-crosshairs"></i> 座標：</strong>經度 ${coords[0]}, 緯度 ${coords[1]}`;
            } else {
                document.getElementById('modalCoordinates').innerHTML = '';
            }
            
            document.getElementById('cameraModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('cameraModal').style.display = 'none';
        }

        // 點擊彈窗外部關閉
        window.onclick = function(event) {
            const modal = document.getElementById('cameraModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // 頁面載入
        window.onload = async function() {
            console.log('水利監視器頁面載入完成');
            
            // 等待預載入完成
            console.log('等待預載入完成...');
            await waterPreloadPromise;
            console.log('預載入完成，開始載入監視器資料...');
            
            loadCameras();
            updateTime();
            
            // 每分鐘更新時間
            setInterval(updateTime, 60000);
            
            // 每10分鐘自動重新載入資料
            setInterval(loadCameras, 600000);
        }
        
        // 如果頁面已經載入完成，立即執行
        if (document.readyState === 'complete') {
            console.log('頁面已完全載入，等待預載入後執行');
            waterPreloadPromise.then(() => {
                loadCameras();
                updateTime();
                setInterval(updateTime, 60000);
                setInterval(loadCameras, 600000);
            });
        }

        // 搜尋框即時搜尋
        document.getElementById('keyword').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(filterCameras, 300);
        });

        // 篩選條件改變時自動搜尋
        document.getElementById('filterAuthority').addEventListener('change', filterCameras);
        document.getElementById('filterStatus').addEventListener('change', filterCameras);
        document.getElementById('sortBy').addEventListener('change', filterCameras);
    </script>
    <script src="assets/dark-mode.js"></script>

    <!-- Back to Top Button -->
    <div class="back-to-top" id="backToTop" style="position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999; font-size: 1.2rem;">
        <i class="fas fa-arrow-up"></i>
    </div>
</body>
</html>
