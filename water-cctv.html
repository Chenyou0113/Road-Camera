<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´åˆ©ç½² CCTV ç›£æ§ç«™ç³»çµ± | å³æ™‚å½±åƒç›£æ§</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="assets/modern-theme.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <style>
        :root {
            --primary-blue: #2c5aa0;
            --accent-cyan: #00bcd4;
            --success-green: #4caf50;
            --warning-orange: #ff9800;
            --danger-red: #f44336;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #87ceeb 0%, #add8e6 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-content {
            flex: 1;
        }

        .back-button {
            padding: 10px 20px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            text-decoration: none;
            color: var(--primary-blue);
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .back-button:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
            transform: translateX(-3px);
        }

        h1 {
            margin: 0;
            color: var(--primary-blue);
            font-size: 2em;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        h1 i {
            color: var(--accent-cyan);
            font-size: 1.2em;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }

        .stat-card {
            background: linear-gradient(135deg, #87ceeb 0%, #add8e6 100%);
            color: #333;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card i {
            font-size: 2em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        select, input[type="text"] {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1);
        }

        .search-box {
            position: relative;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .search-box input {
            width: 100%;
            padding-right: 45px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-cyan));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 90, 160, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .panel-title {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #map {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
        }

        .station-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }

        .station-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .station-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-color: var(--accent-cyan);
        }

        .station-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #f0f0f0;
        }

        .station-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .station-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .station-info span {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .station-info i {
            width: 20px;
            color: var(--accent-cyan);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-active {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-inactive {
            background: #ffebee;
            color: #c62828;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading i {
            font-size: 3em;
            color: var(--accent-cyan);
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
            color: #333;
        }

        .modal-content p {
            color: #333;
            margin: 8px 0;
            line-height: 1.6;
        }

        .modal-content strong {
            color: #2c5aa0;
            font-weight: 600;
        }

        .modal-content h2 {
            color: #2c5aa0 !important;
        }

        .modal-content h3 {
            color: #555 !important;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close-modal {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--danger-red);
        }

        .modal-image {
            width: 100%;
            border-radius: 12px;
            margin: 20px 0;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.5em;
            }

            .station-grid {
                grid-template-columns: 1fr;
            }
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn.active {
            background: var(--accent-cyan);
            color: white;
            border-color: var(--accent-cyan);
        }

        .view-btn:hover {
            border-color: var(--accent-cyan);
        }

        /* === âœ¨ æ–°å¢ï¼šè¿”å›æŒ‰éˆ•æ¨£å¼ (çµ±ä¸€é¢¨æ ¼) === */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #016d68;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .back-btn:hover {
            background: #034d64;
            transform: translateY(-2px);
            color: white;
        }

        /* === âœ¨ æ–°å¢ï¼šæ·±è‰²æ¨¡å¼ (Dark Mode) === */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
        }

        /* å€å¡Šé»‘åŒ– */
        body.dark-mode header,
        body.dark-mode .controls,
        body.dark-mode .panel,
        body.dark-mode .station-card,
        body.dark-mode .modal-content {
            background: #252a34;
            color: #e0e0e0;
            border-color: #393e46;
        }

        /* çµ±è¨ˆå¡ç‰‡é»‘åŒ– */
        body.dark-mode .stat-card {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #fff;
        }

        /* æ–‡å­—é¡è‰²èª¿æ•´ */
        body.dark-mode h1, 
        body.dark-mode .panel-title,
        body.dark-mode .station-name {
            color: #4db6ac;
        }
        
        body.dark-mode .station-info,
        body.dark-mode .filter-group label {
            color: #b0bec5;
        }

        /* è¼¸å…¥æ¡†èˆ‡é¸å–®é»‘åŒ– */
        body.dark-mode select, 
        body.dark-mode input[type="text"] {
            background: #2e3440;
            border-color: #455a64;
            color: #fff;
        }

        /* åœ°åœ–é»‘åŒ– (åè½‰æ¿¾é¡æŠ€å·§) */
        body.dark-mode .leaflet-tile-pane {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        body.dark-mode .leaflet-popup-content-wrapper,
        body.dark-mode .leaflet-popup-tip {
            background: #252a34;
            color: #e0e0e0;
        }
        body.dark-mode .leaflet-popup-content h3 {
            color: #4db6ac !important;
        }

        /* Modal è©³ç´°è³‡æ–™é»‘åŒ– */
        body.dark-mode .modal-content h2 { color: #4db6ac !important; }
        body.dark-mode .modal-content h3 { color: #cfd8dc !important; }
        body.dark-mode .modal-content p, 
        body.dark-mode .modal-content strong { color: #e0e0e0; }
        body.dark-mode .close-modal { color: #fff; }
        
        /* Modal å…§éƒ¨çš„è³‡è¨Šå€å¡Š */
        body.dark-mode .info-box {
            background: #2e3440 !important;
            border: 1px solid #393e46;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- âœ¨ 1. æ–°å¢ï¼šç¨ç«‹çš„è¿”å›æŒ‰éˆ• -->
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> è¿”å›é¦–é 
        </a>

        <header>
            <div class="header-content">
                <h1>
                    <i class="fas fa-video"></i>
                    æ°´åˆ©ç½² CCTV ç›£æ§ç«™ç³»çµ±
                </h1>
                <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">ğŸ“· å³æ™‚å½±åƒ (æ¯ 5 åˆ†é˜æ›´æ–°) â€” æœ¬ç³»çµ±å±•ç¤ºéœæ…‹ç›£æ§å½±åƒï¼Œè‡ªå‹•å®šæ™‚é‡æ–°æ•´ç†æœ€æ–°ç•«é¢</p>
            </div>
        </header>
            <div class="stats-bar">
                <div class="stat-card">
                    <i class="fas fa-broadcast-tower"></i>
                    <div class="stat-value" id="totalStations">0</div>
                    <div class="stat-label">ç¸½ç›£æ§ç«™æ•¸</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle"></i>
                    <div class="stat-value" id="activeStations">0</div>
                    <div class="stat-label">é‹ä½œä¸­</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-water"></i>
                    <div class="stat-value" id="basinCount">0</div>
                    <div class="stat-label">æµåŸŸæ•¸</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-filter"></i>
                    <div class="stat-value" id="filteredCount">0</div>
                    <div class="stat-label">ç›®å‰é¡¯ç¤º</div>
                </div>
            </div>
        </header>

        <div class="controls">
            <div class="filter-row">
                <div class="filter-group">
                    <label><i class="fas fa-map-marker-alt"></i> ç¸£å¸‚</label>
                    <select id="cityFilter">
                        <option value="">å…¨éƒ¨ç¸£å¸‚</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-water"></i> æµåŸŸ</label>
                    <select id="basinFilter">
                        <option value="">å…¨éƒ¨æµåŸŸ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-map-pin"></i> è¡Œæ”¿å€</label>
                    <select id="districtFilter">
                        <option value="">å…¨éƒ¨è¡Œæ”¿å€</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-stream"></i> æ”¯æµ</label>
                    <select id="tributaryFilter">
                        <option value="">å…¨éƒ¨æ”¯æµ</option>
                    </select>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group search-box">
                    <label><i class="fas fa-search"></i> æœå°‹</label>
                    <input type="text" id="searchBox" placeholder="è¼¸å…¥ç«™åã€åœ°é»æˆ–æµåŸŸåç¨±...">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="applyFilters()">
                    <i class="fas fa-filter"></i> å¥—ç”¨ç¯©é¸
                </button>
                <button class="btn btn-secondary" onclick="resetFilters()">
                    <i class="fas fa-redo"></i> é‡ç½®
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="fas fa-map"></i>
                        åœ°åœ–å®šä½
                    </div>
                </div>
                <div id="map"></div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="fas fa-th-large"></i>
                        ç›£æ§ç«™åˆ—è¡¨
                    </div>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="setView('grid')">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="view-btn" onclick="setView('list')">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
                <div id="stationList" class="station-grid">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>è¼‰å…¥ç›£æ§ç«™è³‡æ–™ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è©³ç´°è³‡è¨Š Modal -->
    <div id="stationModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="assets/water-cctv-manager.js"></script>
    <script src="assets/water-cctv-data.js"></script>
    <script src="assets/dark-mode.js"></script>
    <script>
        // å…¨åŸŸè®Šæ•¸
        let map;
        let markers = [];
        let currentView = 'grid';

        // è¼‰å…¥è³‡æ–™
        async function loadData() {
            try {
                // ä½¿ç”¨ JavaScript æ¨¡çµ„è³‡æ–™ï¼ˆé¿å… JSON æª”æ¡ˆéå¤§å•é¡Œï¼‰
                const stationsData = window.waterCCTVStationsData || [];
                
                if (stationsData.length === 0) {
                    throw new Error('è³‡æ–™æª”æ¡ˆæœªæ­£ç¢ºè¼‰å…¥');
                }
                
                await waterCCTVManager.loadStations(stationsData);
                
                initializeFilters();
                updateStatistics();
                initializeMap();
                displayStations();
                
                // å•Ÿå‹•è‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶ï¼šæ¯ 5 åˆ†é˜é‡æ–°è¼‰å…¥åœ–åƒ (300,000 æ¯«ç§’)
                startAutoRefresh();
                
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                document.getElementById('stationList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f44336;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3em;"></i>
                        <p>è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>
                    </div>
                `;
            }
        }
        
        // è‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶ï¼šæ¯ 5 åˆ†é˜é‡æ–°åŠ è¼‰æ‰€æœ‰å½±åƒ
        let autoRefreshInterval = null;
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // ç«‹å³é‡æ–°åŠ è¼‰æ‰€æœ‰åœ–åƒï¼ˆé™„åŠ æ™‚é–“æˆ³é˜²æ­¢å¿«å–ï¼‰
            refreshAllImages();
            
            // æ¯ 5 åˆ†é˜ï¼ˆ300 ç§’ï¼‰é‡æ–°åŠ è¼‰ä¸€æ¬¡
            autoRefreshInterval = setInterval(() => {
                console.log('ğŸ”„ è‡ªå‹•åˆ·æ–°: é‡æ–°è¼‰å…¥æ‰€æœ‰æ°´åˆ©ç›£æ§å½±åƒ...');
                refreshAllImages();
            }, 300000); // 5 åˆ†é˜
        }
        
        // åˆ·æ–°æ‰€æœ‰åœ–åƒï¼šæ·»åŠ æ™‚é–“æˆ³åˆ° URL ä»¥ç¹éç€è¦½å™¨å¿«å–
        function refreshAllImages() {
            const images = document.querySelectorAll('img[src*="imageurl"], .modal-image');
            const timestamp = new Date().getTime();
            
            images.forEach(img => {
                if (img.src && !img.src.includes('unsplash') && !img.src.includes('placeholder')) {
                    // ç§»é™¤èˆŠæ™‚é–“æˆ³
                    let originalSrc = img.src.split('?')[0];
                    // æ·»åŠ æ–°æ™‚é–“æˆ³ä»¥å¼·åˆ¶é‡æ–°åŠ è¼‰
                    img.src = `${originalSrc}?v=${timestamp}`;
                    console.log(`ğŸ–¼ï¸ åˆ·æ–°åœ–åƒ: ${img.alt || 'Unknown'}`);
                }
            });
        }

        // åˆå§‹åŒ–ç¯©é¸å™¨
        function initializeFilters() {
            // ç¸£å¸‚
            const cities = waterCCTVManager.getCities();
            const citySelect = document.getElementById('cityFilter');
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });

            // æµåŸŸ
            const basins = waterCCTVManager.getBasins();
            const basinSelect = document.getElementById('basinFilter');
            basins.forEach(basin => {
                const option = document.createElement('option');
                option.value = basin;
                option.textContent = basin;
                basinSelect.appendChild(option);
            });

            // ç¸£å¸‚è®Šæ›´æ™‚æ›´æ–°è¡Œæ”¿å€
            citySelect.addEventListener('change', () => {
                updateDistrictFilter();
            });

            // æµåŸŸè®Šæ›´æ™‚æ›´æ–°æ”¯æµ
            basinSelect.addEventListener('change', () => {
                updateTributaryFilter();
            });

            // æœå°‹æ¡†å³æ™‚æœå°‹
            document.getElementById('searchBox').addEventListener('input', (e) => {
                waterCCTVManager.search(e.target.value);
                displayStations();
                updateMapMarkers();
                updateStatistics();
            });
        }

        // æ›´æ–°è¡Œæ”¿å€ç¯©é¸å™¨
        function updateDistrictFilter() {
            const city = document.getElementById('cityFilter').value;
            const districts = waterCCTVManager.getDistricts(city);
            const districtSelect = document.getElementById('districtFilter');
            
            districtSelect.innerHTML = '<option value="">å…¨éƒ¨è¡Œæ”¿å€</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }

        // æ›´æ–°æ”¯æµç¯©é¸å™¨
        function updateTributaryFilter() {
            const basin = document.getElementById('basinFilter').value;
            const tributaries = waterCCTVManager.getTributaries(basin);
            const tributarySelect = document.getElementById('tributaryFilter');
            
            tributarySelect.innerHTML = '<option value="">å…¨éƒ¨æ”¯æµ</option>';
            tributaries.forEach(tributary => {
                const option = document.createElement('option');
                option.value = tributary;
                option.textContent = tributary;
                tributarySelect.appendChild(option);
            });
        }

        // å¥—ç”¨ç¯©é¸
        function applyFilters() {
            const filters = {
                city: document.getElementById('cityFilter').value,
                basin: document.getElementById('basinFilter').value,
                district: document.getElementById('districtFilter').value,
                tributary: document.getElementById('tributaryFilter').value,
                status: '1'
            };
            
            waterCCTVManager.applyFilters(filters);
            displayStations();
            updateMapMarkers();
            updateStatistics();
        }

        // é‡ç½®ç¯©é¸
        function resetFilters() {
            document.getElementById('cityFilter').value = '';
            document.getElementById('basinFilter').value = '';
            document.getElementById('districtFilter').value = '';
            document.getElementById('tributaryFilter').value = '';
            document.getElementById('searchBox').value = '';
            
            waterCCTVManager.resetFilters();
            updateDistrictFilter();
            updateTributaryFilter();
            displayStations();
            updateMapMarkers();
            updateStatistics();
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStatistics() {
            const stats = waterCCTVManager.getStatistics();
            document.getElementById('totalStations').textContent = stats.total;
            document.getElementById('activeStations').textContent = stats.active;
            document.getElementById('basinCount').textContent = Object.keys(stats.byBasin).length;
            document.getElementById('filteredCount').textContent = stats.filtered;
        }

        // åˆå§‹åŒ–åœ°åœ–
        function initializeMap() {
            map = L.map('map').setView([23.5, 121], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            updateMapMarkers();
        }

        // æ›´æ–°åœ°åœ–æ¨™è¨˜
        function updateMapMarkers() {
            // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            const mapData = waterCCTVManager.getMapMarkers();
            
            mapData.forEach(station => {
                const marker = L.marker([station.lat, station.lng])
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <h3 style="margin: 0 0 10px 0; color: #2c5aa0;">${station.name}</h3>
                            <p><strong>ç¸£å¸‚ï¼š</strong>${station.city}</p>
                            <p><strong>è¡Œæ”¿å€ï¼š</strong>${station.district}</p>
                            <p><strong>æµåŸŸï¼š</strong>${station.basin || 'æœªåˆ†é¡'}</p>
                            <button onclick="showStationDetail('${station.id}')" 
                                    style="width: 100%; padding: 8px; background: #00bcd4; 
                                           color: white; border: none; border-radius: 5px; 
                                           cursor: pointer; margin-top: 10px;">
                                æŸ¥çœ‹è©³ç´°è³‡è¨Š
                            </button>
                        </div>
                    `)
                    .addTo(map);
                
                markers.push(marker);
            });
        }

        // å–å¾—æ¬„ä½å€¼ï¼ˆæ”¯æ´æ–°èˆŠæ ¼å¼ï¼‰
        function getField(station, newField, oldField) {
            return station[newField] || station[oldField] || '';
        }

        // é¡¯ç¤ºç›£æ§ç«™åˆ—è¡¨
        function displayStations() {
            const stations = waterCCTVManager.getFilteredStations();
            const container = document.getElementById('stationList');
            
            if (stations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999; grid-column: 1/-1;">
                        <i class="fas fa-inbox" style="font-size: 3em; margin-bottom: 15px;"></i>
                        <p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç›£æ§ç«™</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = stations.map(station => {
                const cameraId = getField(station, 'CameraID', 'cameraid');
                const imageUrl = getField(station, 'ImageURL', 'imageurl');
                const cameraName = getField(station, 'CameraName', 'cameraname');
                const city = getField(station, 'CountiesAndCitiesWhereTheMonitoringPointsAreLocated', 'countiesandcitieswherethemonitoringpointsarelocated');
                const district = getField(station, 'AdministrativeDistrictWhereTheMonitoringPointIsLocated', 'administrativedistrictwherethemonitoringpointislocated');
                const basin = getField(station, 'BasinName', 'basinname');
                const tributary = getField(station, 'TRIBUTARY', 'tributary');
                const status = getField(station, 'Status', 'status');
                
                return `
                    <div class="station-card" onclick="showStationDetail('${cameraId}')">
                        <img src="${imageUrl}" 
                             alt="${cameraName}" 
                             class="station-image"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'400\\' height=\\'300\\'%3E%3Crect fill=\\'%23f0f0f0\\' width=\\'400\\' height=\\'300\\'/%3E%3Ctext fill=\\'%23999\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3Eç„¡æ³•è¼‰å…¥å½±åƒ%3C/text%3E%3C/svg%3E'">
                        <div class="station-name">${cameraName}</div>
                        <div class="station-info">
                            <span>
                                <i class="fas fa-map-marker-alt"></i>
                                ${city} - ${district}
                            </span>
                            ${basin ? `
                            <span>
                                <i class="fas fa-water"></i>
                                ${basin}
                            </span>
                            ` : ''}
                            ${tributary ? `
                            <span>
                                <i class="fas fa-stream"></i>
                                ${tributary}
                            </span>
                            ` : ''}
                            <span>
                                <span class="status-badge ${status === '1' ? 'status-active' : 'status-inactive'}">
                                    ${status === '1' ? 'â— é‹ä½œä¸­' : 'â—‹ é›¢ç·š'}
                                </span>
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // é¡¯ç¤ºç›£æ§ç«™è©³ç´°è³‡è¨Š
        // âœ¨ å„ªåŒ–ç‰ˆï¼šé¡¯ç¤ºç›£æ§ç«™è©³ç´°è³‡è¨Š (å« JPG è¨»è§£)
        function showStationDetail(cameraid) {
            const station = waterCCTVManager.getStationById(cameraid);
            if (!station) return;
            
            const modal = document.getElementById('stationModal');
            const modalBody = document.getElementById('modalBody');
            
            // è™•ç†å¯èƒ½ç‚º undefined çš„æ¬„ä½
            const val = (v) => v || 'æœªçŸ¥';
            
            // åˆ¤æ–·ç‹€æ…‹é¡è‰²
            const statusHtml = station.status === '1' 
                ? '<span class="status-badge status-active">â— é‹ä½œä¸­</span>' 
                : '<span class="status-badge status-inactive">â—‹ é›¢ç·š/ç¶­è­·ä¸­</span>';

            modalBody.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <h2 style="color: #2c5aa0; margin: 0 0 15px 0;">
                        <i class="fas fa-video"></i> ${val(station.cameraname)}
                    </h2>
                </div>
                
                <img src="${val(station.imageurl)}" 
                     alt="${val(station.cameraname)}" 
                     class="modal-image"
                     style="background: #000; min-height: 200px;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <div style="display:none; text-align:center; padding:20px; background:#f0f0f0; border-radius:12px; margin-bottom:20px;">
                    <i class="fas fa-image-slash" style="font-size:2em; color:#999;"></i><br>ç„¡æ³•è¼‰å…¥å½±åƒ
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px;">
                    <!-- åŸºæœ¬è³‡è¨Š -->
                    <div>
                        <h3 style="color: #555; border-bottom: 2px solid #ddd; padding-bottom: 8px; margin-bottom: 12px;">
                            <i class="fas fa-info-circle"></i> åŸºæœ¬è³‡è¨Š
                        </h3>
                        <p><strong>ç«™é»åç¨±ï¼š</strong>${val(station.videosurveillancestationname)}</p>
                        <p><strong>ç›£æ§ç«™IDï¼š</strong>${val(station.cameraid)}</p>
                        <p><strong>ç›®å‰ç‹€æ…‹ï¼š</strong>${statusHtml}</p>
                    </div>
                    
                    <!-- åœ°ç†ä½ç½® -->
                    <div>
                        <h3 style="color: #555; border-bottom: 2px solid #ddd; padding-bottom: 8px; margin-bottom: 12px;">
                            <i class="fas fa-map-marker-alt"></i> åœ°ç†ä½ç½®
                        </h3>
                        <p><strong>ç¸£å¸‚ï¼š</strong>${val(station.countiesandcitieswherethemonitoringpointsarelocated)}</p>
                        <p><strong>è¡Œæ”¿å€ï¼š</strong>${val(station.administrativedistrictwherethemonitoringpointislocated)}</p>
                        <p><strong>ç¶“ç·¯åº¦ï¼š</strong>${Number(station.latitude_4326).toFixed(4)}, ${Number(station.longitude_4326).toFixed(4)}</p>
                    </div>
                    
                    <!-- æ°´ç³»è³‡è¨Š -->
                    <div>
                        <h3 style="color: #555; border-bottom: 2px solid #ddd; padding-bottom: 8px; margin-bottom: 12px;">
                            <i class="fas fa-water"></i> æ°´æ–‡è³‡è¨Š
                        </h3>
                        <p><strong>æ‰€å±¬æµåŸŸï¼š</strong>${val(station.basinname)}</p>
                        <p><strong>æ”¯æµåç¨±ï¼š</strong>${val(station.tributary)}</p>
                        <p><strong>æ²³å·ä»£ç¢¼ï¼š</strong>${val(station.rivercode)}</p>
                    </div>
                </div>
                
                <!-- æŠ€è¡“è¦æ ¼å€å¡Š (åŠ ä¸Š info-box æ¨£å¼èˆ‡ JPG è¨»è§£) -->
                <div class="info-box" style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <!-- âœ¨ é€™è£¡åŠ ä¸Šäº† (JPG) çš„è¨»è§£ -->
                        <div><strong>å½±åƒæ ¼å¼ï¼š</strong>${val(station.imageformat)} <span style="color: #888;">(JPG)</span></div>
                        <div><strong>åº§æ¨™ç³»çµ±ï¼š</strong>${val(station.coordinate)}</div>
                        <div><strong>è³‡æ–™ä¾†æºï¼š</strong>æ°´åˆ©ç½² Open Data</div>
                        <div><strong>æ›´æ–°æ™‚é–“ï¼š</strong>å³æ™‚ (æ¯5åˆ†é˜)</div>
                    </div>
                </div>
                
                <div style="margin-top: 25px; text-align: center;">
                    <a href="${val(station.imageurl)}" target="_blank" class="btn btn-primary" style="text-decoration:none;">
                        <i class="fas fa-external-link-alt"></i> é–‹å•ŸåŸå§‹å½±åƒé€£çµ
                    </a>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // é—œé–‰ Modal
        function closeModal() {
            document.getElementById('stationModal').style.display = 'none';
        }

        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('stationModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // åˆ‡æ›è¦–åœ–
        function setView(view) {
            currentView = view;
            const buttons = document.querySelectorAll('.view-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.closest('.view-btn').classList.add('active');
            
            // é€™è£¡å¯ä»¥æ·»åŠ åˆ—è¡¨è¦–åœ–çš„é‚è¼¯
            if (view === 'list') {
                // åˆ—è¡¨è¦–åœ–å¾…å¯¦ä½œ
                console.log('åˆ‡æ›è‡³åˆ—è¡¨è¦–åœ–');
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
    <!-- âœ¨ å¼•å…¥å¤–éƒ¨è…³æœ¬ (å•Ÿç”¨æ·±è‰²æ¨¡å¼èˆ‡å°èˆªåˆ—åŠŸèƒ½) -->
    <script src="assets/navbar.js"></script>
    <script src="assets/dark-mode.js"></script>
</body>
</html>
