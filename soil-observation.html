<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>水利署河川監控影像</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: linear-gradient(135deg, #8D6E63 0%, #5D4037 100%); min-height: 100vh; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #8D6E63; text-align: center; margin-bottom: 10px; }
        .loading { text-align: center; padding: 50px; color: white; font-size: 1.2rem; }
        .cameras-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        @media (max-width: 1200px) { .cameras-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .cameras-grid { grid-template-columns: 1fr; } }
        .camera-card { 
            background: white; 
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            cursor: pointer; 
            transition: transform 0.3s; 
            position: relative; 
        }
        .camera-card:hover { transform: translateY(-5px); }
        .camera-card h3 { color: #8D6E63; margin-bottom: 10px; font-size: 1.1rem; }
        .camera-card p { color: #666; margin: 5px 0; font-size: 0.9rem; }
        .station-image { 
            width: 100%; 
            height: 200px; 
            background: #f0f0f0; 
            border-radius: 8px; 
            overflow: hidden; 
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .station-image img { width: 100%; height: 100%; object-fit: cover; }
        .no-image { color: #999; text-align: center; padding: 60px 20px; }
        .status-badge { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            font-weight: bold; 
            color: white; 
        }
        .status-active { background: #4CAF50; }
        .status-inactive { background: #F44336; }
        .status-demo { background: #FF9800; }
        .status-live { background: #2196F3; }
        .info-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 8px; 
            margin-top: 10px; 
            font-size: 0.85rem;
        }
        .info-item { 
            background: #f8f9fa; 
            padding: 6px 8px; 
            border-radius: 4px; 
        }
        .info-label { color: #666; font-weight: bold; }
        .info-value { color: #333; margin-top: 2px; }
        .filter-select { 
            padding: 10px 15px; 
            border: 2px solid #8D6E63; 
            border-radius: 8px; 
            font-size: 1rem; 
            background: white; 
            color: #333; 
            cursor: pointer;
            transition: border-color 0.3s;
            min-width: 150px;
        }
        .filter-select:hover, .filter-select:focus { 
            border-color: #5D4037; 
            outline: none; 
        }
        .clear-button { 
            padding: 10px 15px; 
            background: #FF9800; 
            color: white; 
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        .clear-button:hover { 
            background: #F57C00; 
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-water"></i> 水利署河川分署流域監控影像</h1>
            <p style="text-align: center; color: #666;">水利署各河川分署流域與疏濬工區遠端監控影像</p>
        </div>
    </div>
    <div class="container">
        <!-- 快速切換導航列 -->
        <div style="background: white; padding: 15px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <a href="index.html" style="padding: 8px 16px; background: #9C27B0; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem;">
                    <i class="fas fa-home"></i> 首頁
                </a>
                <span style="color: #ddd;">|</span>
                <a href="road.html" style="padding: 8px 16px; background: #FF9800; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem;">
                    <i class="fas fa-road"></i> 公路監視器
                </a>
                <a href="highway.html" style="padding: 8px 16px; background: #2196F3; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem;">
                    <i class="fas fa-highway"></i> 高速公路
                </a>
                <a href="city.html" style="padding: 8px 16px; background: #4CAF50; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem;">
                    <i class="fas fa-city"></i> 市區監視器
                </a>
                <a href="air-quality.html" style="padding: 8px 16px; background: #7B1FA2; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem;">
                    <i class="fas fa-wind"></i> 空品測站
                </a>
                <a href="debris-flow.html" style="padding: 8px 16px; background: #795548; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem;">
                    <i class="fas fa-mountain"></i> 土石流監測
                </a>
                <a href="soil-observation.html" style="padding: 8px 16px; background: #5D4037; color: white; text-decoration: none; border-radius: 20px; font-size: 0.9rem; border: 2px solid #8D6E63;">
                    <i class="fas fa-water"></i> 河川監控 ✓
                </a>
            </div>
        </div>
        
        <!-- 資料來源說明 -->
        <div style="background: white; padding: 15px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="color: #8D6E63; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> 河川分署監控影像資料說明</h3>
            <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #8D6E63;">
                <p style="margin: 0; color: #555; font-size: 0.9rem; line-height: 1.5;">
                    本系統整合<strong>水利署各河川分署流域與疏濬工區遠端監控系統</strong>的影像資料，提供即時河川水位、流量、工程施作等監控影像。
                    若無法載入即時資料，系統會自動切換為示範模式以展示功能。
                </p>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="flex: 1;">
                    <p style="margin: 5px 0; color: #FF9800; font-weight: bold;" id="dataSourceInfo">
                        • 載入中...
                    </p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="window.location.reload()" style="padding: 8px 16px; background: #8D6E63; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-sync-alt"></i> 重新載入
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 篩選選項 -->
        <div style="background: white; padding: 15px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <select class="filter-select" id="countySelect" onchange="applyFilters()">
                    <option value="">選擇縣市</option>
                </select>
                <select class="filter-select" id="authoritySelect" onchange="applyFilters()">
                    <option value="">選擇提供單位</option>
                </select>
                <button class="clear-button" onclick="clearFilters()">
                    <i class="fas fa-refresh"></i> 清除篩選
                </button>
            </div>
        </div>
        
        <!-- 統計資訊 -->
        <div id="statsPanel" style="background: white; padding: 20px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="color: #8D6E63; margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> 監控站統計</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #8D6E63;" id="totalStations">0</div>
                    <div style="color: #666; font-size: 0.9rem;">總監控站數</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #4CAF50;" id="filteredStations">0</div>
                    <div style="color: #666; font-size: 0.9rem;">篩選結果</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #2196F3;" id="countyCount">0</div>
                    <div style="color: #666; font-size: 0.9rem;">涵蓋河川</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #FF9800;" id="videoStations">0</div>
                    <div style="color: #666; font-size: 0.9rem;">有影像資料</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #9C27B0;" id="authorityCount">0</div>
                    <div style="color: #666; font-size: 0.9rem;">提供單位數</div>
                </div>
            </div>
        </div>
        
        <div id="cameras-container" class="loading">載入中...</div>
    </div>

    <script>
        let isUsingRealData = false;
        let allStations = [];
        let currentStations = [];
        
        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('水利署水利防災監控頁面載入完成');
            loadWaterResourcesData();
        });
        
        async function loadWaterResourcesData() {
            console.log('開始載入水利署河川監控資料...');
            const container = document.getElementById('cameras-container');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 載入水利署河川監控資料中...</div>';
            
            try {
                // 嘗試載入水利署各河川分署流域與疏濬工區遠端監控影像 API
                console.log('正在嘗試載入水利署河川分署 API...');
                
                // 先嘗試直接連接
                let response;
                try {
                    container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 嘗試載入水利署即時資料...</div>';
                    // 使用水利署視訊監測影像監測資料 API，並使用 $top=1 只取最新一筆
                    response = await fetch('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations($top=1;$orderby=phenomenonTime%20desc)&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%27&$count=true');
                } catch (corsError) {
                    console.log('直接連接失敗，嘗試使用 CORS 代理...');
                    container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 嘗試替代連接方式...</div>';
                    // 使用 CORS 代理
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const targetUrl = encodeURIComponent('https://sta.ci.taiwan.gov.tw/STA_CCTV/v1.0/Datastreams?$expand=Thing,Observations($top=1;$orderby=phenomenonTime%20desc)&$filter=Thing/properties/authority%20eq%20%27%E6%B0%B4%E5%88%A9%E7%BD%B2%27&$count=true');
                    response = await fetch(proxyUrl + targetUrl);
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('水利署視訊監測 API 回應:', data);
                
                if (data && data.value && Array.isArray(data.value) && data.value.length > 0) {
                    isUsingRealData = true;
                    document.getElementById('dataSourceInfo').innerHTML = '• ✅ 即時資料載入成功（水利署視訊監測系統 - 最新一筆資料）';
                    document.getElementById('dataSourceInfo').style.color = '#4CAF50';
                    
                    // 轉換水利署視訊監測資料格式
                    allStations = data.value.map(datastream => {
                        const thing = datastream.Thing || {};
                        const properties = thing.properties || {};
                        const observedArea = datastream.observedArea || {};
                        const coordinates = observedArea.coordinates || [];
                        const latestObs = datastream.Observations && datastream.Observations[0] ? datastream.Observations[0] : null;
                        
                        // 從 description 提取資訊
                        const datastreamDesc = datastream.description || '';
                        const thingDesc = thing.description || '';
                        
                        return {
                            // 基本資訊
                            stationName: properties.stationName || datastream.name || '未命名監控站',
                            authority: properties.OrgName || properties.authority || '水利署',
                            ccdIdentifier: properties.stationID || properties.stationCode || datastream['@iot.id'] || '',
                            
                            // 地理位置 - 從 observedArea.coordinates 取得
                            latitude: coordinates[1] || '',
                            longitude: coordinates[0] || '',
                            coordinate: 'WGS84',
                            
                            // 河川資訊
                            riverName: properties.basin || properties.river || '',
                            riverCode: properties.riverCode || '',
                            
                            // 影像資訊 - 從最新一筆 Observation 取得
                            imageURL: latestObs ? latestObs.result : '',
                            phenomenonTime: latestObs ? latestObs.phenomenonTime : '',
                            
                            // 狀態
                            status: '正常運作',
                            
                            // 額外資訊
                            county: properties.city || properties.county || '',
                            authorityType: '水利署河川分署',
                            
                            // 監測類別
                            category: properties.ciCategory || ''
                        };
                    });
                    
                    console.log('水利署視訊監測資料載入成功:', allStations.length, '個監控站（每站最新一筆資料）');
                    if (allStations.length > 0) {
                        console.log('第一個監控站:', allStations[0]);
                    }
                    
                    currentStations = [...allStations];
                    populateFilters();
                    updateStatistics();
                    processWaterResourcesData(currentStations, container);
                    return;
                }
                
                throw new Error('無法獲取資料');
                
            } catch (error) {
                console.error('載入水利署河川監控資料失敗:', error);
                console.log('錯誤詳情:', error.message);
                
                // 嘗試使用備用資料源或載入模擬資料
                console.log('切換至備用河川監控資料...');
                loadMockWaterResourcesData();
            }
        }
        
        function loadMockWaterResourcesData() {
            console.log('載入示範水利署河川監控資料...');
            console.log('說明：由於網路連線或 CORS 政策限制，無法載入即時資料，改用示範資料顯示功能');
            
            // 示範水利署河川分署監控資料 - 基於真實監控站位置
            allStations = [
                {
                    stationName: '濁水溪-集集攔河堰',
                    authority: '第三河川分署',
                    ccdIdentifier: 'WRA-R03-001',
                    latitude: '23.8302',
                    longitude: '120.7832',
                    coordinate: 'TWD97',
                    riverName: '濁水溪',
                    riverCode: 'R0301',
                    imageURL: 'https://fhy.wra.gov.tw/ReservoirPage_2011/Images/1351002A.jpg',
                    status: '正常運作',
                    authorityType: '水利署河川分署',
                    county: '南投縣'
                },
                {
                    stationName: '大甲溪-石岡壩',
                    authority: '第三河川分署',
                    ccdIdentifier: 'WRA-R03-002',
                    latitude: '24.2572',
                    longitude: '120.7922',
                    coordinate: 'TWD97',
                    riverName: '大甲溪',
                    riverCode: 'R0401',
                    imageURL: 'https://fhy.wra.gov.tw/ReservoirPage_2011/Images/1351018A.jpg',
                    status: '正常運作',
                    authorityType: '水利署河川分署',
                    county: '台中市'
                },
                {
                    stationName: '淡水河-關渡',
                    authority: '第一河川分署',
                    ccdIdentifier: 'WRA-R01-003',
                    latitude: '25.1175',
                    longitude: '121.4627',
                    coordinate: 'TWD97',
                    riverName: '淡水河',
                    riverCode: 'R0101',
                    imageURL: 'https://fhy.wra.gov.tw/ReservoirPage_2011/Images/1401001A.jpg',
                    status: '正常運作',
                    authorityType: '水利署河川分署',
                    county: '台北市'
                },
                {
                    stationName: '高屏溪-里港大橋',
                    authority: '第七河川分署',
                    ccdIdentifier: 'WRA-R07-004',
                    latitude: '22.7781',
                    longitude: '120.4948',
                    coordinate: 'TWD97',
                    riverName: '高屏溪',
                    riverCode: 'R0701',
                    imageURL: 'https://fhy.wra.gov.tw/ReservoirPage_2011/Images/1471009A.jpg',
                    status: '正常運作',
                    authorityType: '水利署河川分署',
                    county: '屏東縣'
                },
                {
                    stationName: '蘭陽溪-員山',
                    authority: '第一河川分署',
                    ccdIdentifier: 'WRA-R01-005',
                    latitude: '24.7394',
                    longitude: '121.6622',
                    coordinate: 'TWD97',
                    riverName: '蘭陽溪',
                    riverCode: 'R0102',
                    imageURL: 'https://fhy.wra.gov.tw/ReservoirPage_2011/Images/1421001A.jpg',
                    status: '正常運作',
                    authorityType: '水利署河川分署',
                    county: '宜蘭縣'
                },
                {
                    stationName: '曾文溪-二溪大橋',
                    authority: '第六河川分署',
                    ccdIdentifier: 'WRA-R06-006',
                    latitude: '23.1953',
                    longitude: '120.3923',
                    coordinate: 'TWD97',
                    riverName: '曾文溪',
                    riverCode: 'R0601',
                    imageURL: 'https://fhy.wra.gov.tw/ReservoirPage_2011/Images/1461002A.jpg',
                    status: '正常運作',
                    authorityType: '水利署河川分署',
                    county: '台南市'
                },
                {
                    stationName: '高屏溪-斜張橋',
                    authority: '第七河川分署',
                    ccdIdentifier: 'CCD-003',
                    latitude: '22.7341',
                    longitude: '120.4892',
                    coordinate: 'TWD97',
                    riverName: '高屏溪',
                    riverCode: 'R0801',
                    imageURL: 'https://via.placeholder.com/400x300/2196F3/FFFFFF?text=高屏溪-斜張橋',
                    status: '正常',
                    authorityType: '水利署（與縣市政府合建）',
                    county: '高雄市'
                },
                {
                    stationName: '蘭陽溪-蘭陽大橋',
                    authority: '第一河川分署',
                    ccdIdentifier: 'CCD-004',
                    latitude: '24.7392',
                    longitude: '121.7892',
                    coordinate: 'TWD97',
                    riverName: '蘭陽溪',
                    riverCode: 'R0101',
                    imageURL: 'https://via.placeholder.com/400x300/4CAF50/FFFFFF?text=蘭陽溪-蘭陽大橋',
                    status: '正常',
                    authorityType: '水利署',
                    county: '宜蘭縣'
                },
                {
                    stationName: '淡水河-關渡大橋',
                    authority: '第十河川分署',
                    ccdIdentifier: 'WRA-R10-007',
                    latitude: '25.1241',
                    longitude: '121.4592',
                    coordinate: 'TWD97',
                    riverName: '淡水河',
                    riverCode: 'R0201',
                    imageURL: '',
                    status: '維護中',
                    authorityType: '水利署（與縣市政府合建）',
                    county: '新北市'
                },
                {
                    stationName: '花蓮溪-花蓮大橋',
                    authority: '第九河川分署',
                    ccdIdentifier: 'WRA-R09-008',
                    latitude: '23.9739',
                    longitude: '121.6015',
                    coordinate: 'TWD97',
                    riverName: '花蓮溪',
                    riverCode: 'R0901',
                    imageURL: 'https://fhy.wra.gov.tw/ReservoirPage_2011/Images/1481001A.jpg',
                    status: '正常運作',
                    authorityType: '水利署河川分署',
                    county: '花蓮縣'
                },
                {
                    stationName: '卑南溪-知本',
                    authority: '第八河川分署',
                    ccdIdentifier: 'WRA-R08-009',
                    latitude: '22.7216',
                    longitude: '121.0854',
                    coordinate: 'TWD97',
                    riverName: '卑南溪',
                    riverCode: 'R0801',
                    imageURL: 'https://fhy.wra.gov.tw/ReservoirPage_2011/Images/1491001A.jpg',
                    status: '正常運作',
                    authorityType: '水利署河川分署',
                    county: '台東縣'
                }
            ];
            
            isUsingRealData = false;
            document.getElementById('dataSourceInfo').innerHTML = '• 使用示範資料（無法連接官方 API，顯示河川分署監控站範例）';
            document.getElementById('dataSourceInfo').style.color = '#FF9800';
            
            currentStations = [...allStations];
            populateFilters();
            updateStatistics();
            processWaterResourcesData(currentStations, document.getElementById('cameras-container'));
        }
        
        function populateFilters() {
            // 填充縣市篩選
            // 台灣縣市標準排序 - 由北到南，直轄市優先
            const TAIWAN_CITY_ORDER = [
                '台北市', '新北市', '桃園市', '台中市', '台南市', '高雄市',
                '基隆市', '新竹市', '嘉義市',
                '新竹縣', '苗栗縣', '彰化縣', '南投縣', '雲林縣', '嘉義縣', '屏東縣',
                '宜蘭縣', '花蓮縣', '台東縣',
                '澎湖縣', '金門縣', '連江縣'
            ];
            
            const countySelect = document.getElementById('countySelect');
            const counties = [...new Set(allStations.map(s => s.county).filter(c => c))];
            
            // 按照台灣縣市標準順序排列
            const sortedCounties = counties.sort((a, b) => {
                const indexA = TAIWAN_CITY_ORDER.indexOf(a);
                const indexB = TAIWAN_CITY_ORDER.indexOf(b);
                // 如果在標準順序中找不到，則放在最後並按字母排序
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            countySelect.innerHTML = '<option value="">選擇縣市</option>';
            sortedCounties.forEach(county => {
                const option = document.createElement('option');
                option.value = county;
                option.textContent = county;
                countySelect.appendChild(option);
            });
            
            // 填充提供單位篩選
            const authoritySelect = document.getElementById('authoritySelect');
            const authorities = [...new Set(allStations.map(s => s.authority).filter(a => a))];
            
            authoritySelect.innerHTML = '<option value="">選擇提供單位</option>';
            authorities.sort().forEach(authority => {
                const option = document.createElement('option');
                option.value = authority;
                option.textContent = authority;
                authoritySelect.appendChild(option);
            });
        }
        
        function applyFilters() {
            const selectedAuthority = document.getElementById('authoritySelect').value;
            const selectedCounty = document.getElementById('countySelect').value;
            
            currentStations = allStations.filter(station => {
                let match = true;
                
                if (selectedAuthority) {
                    match = match && (station.authority === selectedAuthority);
                }
                
                if (selectedCounty) {
                    match = match && (station.county === selectedCounty);
                }
                
                return match;
            });
            
            updateStatistics();
            const container = document.getElementById('cameras-container');
            processWaterResourcesData(currentStations, container);
        }
        
        function clearFilters() {
            document.getElementById('authoritySelect').value = '';
            document.getElementById('countySelect').value = '';
            currentStations = [...allStations];
            updateStatistics();
            const container = document.getElementById('cameras-container');
            processWaterResourcesData(currentStations, container);
        }
        
        function processWaterResourcesData(stations, container) {
            console.log('開始處理水利署河川監控資料:', stations.length, '個監控站');
            
            if (stations.length === 0) {
                container.innerHTML = '<div class="loading">無符合條件的監控站</div>';
                return;
            }
            
            const html = stations.map((station, index) => {
                const stationName = station.stationName || '未命名監控站';
                const county = station.county || '';
                const riverName = station.riverName || '';
                const riverCode = station.riverCode || '';
                const status = station.status || '未知';
                const imageUrl = station.imageURL || '';
                const ccdIdentifier = station.ccdIdentifier || '';
                const authority = station.authority || '';
                const authorityType = station.authorityType || '';
                const coordinate = station.coordinate || '';
                const latitude = station.latitude || '';
                const longitude = station.longitude || '';
                
                // 狀態標籤樣式
                let statusClass = 'status-live';
                let statusText = '正常';
                
                if (status && (status.includes('異常') || status.includes('故障'))) {
                    statusClass = 'status-inactive';
                    statusText = '異常';
                } else if (status && status.includes('維護')) {
                    statusClass = 'status-inactive';
                    statusText = '維護';
                } else if (status && status.includes('正常')) {
                    statusClass = 'status-active';
                    statusText = '正常';
                }
                
                // 判斷專區類型
                let zoneType = '';
                let zoneColor = '';
                if (authorityType === '水利署') {
                    zoneType = '水利署專區';
                    zoneColor = '#2196F3';
                } else if (authorityType === '水利署（與縣市政府合建）') {
                    zoneType = '地方政府專區';
                    zoneColor = '#4CAF50';
                }
                
                // 建立影像區塊
                const imageHtml = imageUrl ? 
                    `<div class="station-image">
                        <img src="${imageUrl}" alt="${stationName}影像" 
                             onerror="handleImageError(this, '${stationName}')"
                             onload="handleImageLoad(this)"
                             style="opacity: 0; transition: opacity 0.3s ease;">
                    </div>` :
                    `<div class="station-image">
                        <div class="no-image">
                            <i class="fas fa-camera-slash"></i><br>
                            無影像資料
                        </div>
                    </div>`;
                
                return `
                    <div class="camera-card">
                        <div class="status-badge ${statusClass}">${statusText}</div>
                        <h3><i class="fas fa-water"></i> ${stationName}</h3>
                        <p><i class="fas fa-map-marker-alt"></i> ${county}</p>
                        ${zoneType ? `<p style="color: ${zoneColor}; font-weight: bold; margin: 5px 0;"><i class="fas fa-building"></i> ${zoneType}</p>` : ''}
                        
                        ${imageHtml}
                        
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">提供單位</div>
                                <div class="info-value">${authority || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">河川名稱</div>
                                <div class="info-value">${riverName || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">河川代碼</div>
                                <div class="info-value">${riverCode || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">CCD編號</div>
                                <div class="info-value">${ccdIdentifier || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">坐標系統</div>
                                <div class="info-value">${coordinate || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">經緯度</div>
                                <div class="info-value">${latitude && longitude ? `${latitude}, ${longitude}` : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="cameras-grid">${html}</div>`;
            console.log('水利署河川監控資料顯示完成');
        }
        
        function updateStatistics() {
            const total = allStations.length;
            const filtered = currentStations.length;
            const counties = new Set(currentStations.map(s => s.county).filter(c => c)).size;
            const withImage = currentStations.filter(s => s.imageURL && s.imageURL.trim() !== '').length;
            const waterAgency = currentStations.filter(s => s.authorityType === '水利署').length;
            const localGov = currentStations.filter(s => s.authorityType === '水利署（與縣市政府合建）').length;
            
            document.getElementById('totalStations').textContent = total;
            document.getElementById('filteredStations').textContent = filtered;
            document.getElementById('countyCount').textContent = counties;
            document.getElementById('videoStations').textContent = withImage;
            document.getElementById('waterAgencyStations').textContent = waterAgency;
            document.getElementById('localGovStations').textContent = localGov;
        }

        // 圖片載入成功處理
        function handleImageLoad(img) {
            img.style.opacity = '1';
            console.log('✅ 河川監控影像載入成功:', img.alt);
        }

        // 圖片載入失敗處理 - 簡化版本
        function handleImageError(img, stationName) {
            console.warn('⚠️ 河川監控影像載入失敗:', img.src, '監控站:', stationName);
            
            // 直接顯示錯誤訊息，不再重試
            img.parentElement.innerHTML = `
                <div class="no-image">
                    <i class="fas fa-exclamation-triangle" style="color: #FF5722;"></i><br>
                    <small style="color: #666; font-size: 0.8rem;">影像載入失敗</small><br>
                    <small style="color: #999; font-size: 0.7rem;">${stationName}</small>
                </div>
            `;
        }

        // 手動重試載入圖片
        function retryLoadImage(imageSrc, container, stationName) {
            container.innerHTML = `
                <div class="no-image">
                    <i class="fas fa-spinner fa-spin" style="color: #8D6E63;"></i><br>
                    <small style="color: #666; font-size: 0.8rem;">重新載入中...</small>
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = `
                    <img src="${imageSrc}?manual_retry=${Date.now()}" 
                         alt="${stationName}影像" 
                         onerror="handleImageError(this, '${stationName}')"
                         onload="handleImageLoad(this)"
                         style="opacity: 0; transition: opacity 0.3s ease; width: 100%; height: 100%; object-fit: cover;">
                `;
            }, 500);
        }
    </script>
</body>
</html>
