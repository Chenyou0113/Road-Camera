
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°éµ PIDS (V5.8 æœ€çµ‚ç‰ˆ - åç¨±çµ±ä¸€ + RWD å„ªåŒ–)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #111; color: white; font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            padding: 8px; gap: 8px;
        }

        /* Header */
        .unified-header {
            width: 100%; height: 90px; 
            background: #000; 
            border: none; /* ğŸ”¥ ä¿®æ­£: ç§»é™¤é‚Šæ¡† */
            border-radius: 0; /* ğŸ”¥ ä¿®æ­£: ç§»é™¤åœ“è§’ */
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            box-shadow: none; /* ç§»é™¤é™°å½± */
            flex-shrink: 0;
            border-bottom: 2px solid #333; /* åŠ ä¸Šåº•éƒ¨ç·šæ¢ä»¥åˆ†éš” */
        }
        
        .station-branding { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            flex: 1; 
            line-height: 1;
        }
        .tra-logo-img { height: 50px; border-radius: 50%; border: 2px solid #fff; }
        
        .station-name-block {
            display: flex;
            flex-direction: row;
            align-items: baseline;
            gap: 10px;
            line-height: 1;
        }
        .station-name { 
            font-size: 3.5rem;
            font-weight: 900; 
            line-height: 1; 
            text-shadow: 0 0 10px rgba(255,255,255,0.6); 
            margin: 0;
        }
        .station-sub { 
            font-size: 3.5rem;
            color: #4fc3f7; 
            font-family: Consolas, sans-serif; 
            letter-spacing: 0px; 
            font-weight: bold; 
            line-height: 1;
            margin: 0;
        }
        
        .datetime-block { 
            text-align: right; 
            display: flex; 
            flex-direction: row;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            line-height: 1;
        }
        .date-text { 
            font-size: 3rem;
            color: #ccc; 
            font-weight: bold; 
            font-family: Consolas, monospace; 
            line-height: 1;
            margin: 0;
        }
        .time-text { 
            font-size: 3rem;
            font-weight: bold; 
            font-family: Consolas, monospace; 
            color: #ffeb3b; 
            line-height: 1; 
            margin: 0;
        }

        /* Top Marquee */
        .unified-marquee-container {
            width: 100%; 
            height: 60px; 
            background: #e3f2fd; 
            border: none; 
            display: flex; align-items: center; overflow: hidden; position: relative; 
            color: #003366; 
            flex-shrink: 0;
            margin-top: 0; /* ä¿®æ­£: ç§»é™¤è² é‚Šè·ï¼Œè®“å®ƒç·Šè²¼ Header */
            margin-left: -8px;
            margin-right: -8px;
            padding: 0 8px;
        }
        .unified-marquee-container .marquee-text {
            position: absolute; white-space: nowrap; 
            height: 60px; 
            line-height: 60px; 
            font-size: 2.5rem; 
            font-weight: 900; left: 100%; will-change: transform;
        }
        
        /* ğŸ”¥ ç§»é™¤: ä¸å†è‡ªå‹•æ·»åŠ ç®­é ­ï¼Œå®Œå…¨ä½¿ç”¨ D1 ä¸­çš„å…§å®¹ */

        /* PIDS Section */
        .pids-section { 
            display: flex; width: 100%; gap: 10px; 
            flex: 1; min-height: 0; overflow: hidden;
        }
        .pids-column { 
            flex: 1; display: flex; flex-direction: column; background: #000; 
            border: 3px solid #333; border-radius: 8px; overflow: hidden; 
        }
        .screen-body { flex: 1; display: flex; flex-direction: column; background: #000; overflow: hidden; }

        .direction-header-1 { background: linear-gradient(to right, #000080, #0d47a1); color: white; padding: 10px 15px; font-size: 1.5rem; font-weight: 900; display: flex; justify-content: space-between; border-bottom: 2px solid #fff; flex-shrink: 0; }
        .direction-header-0 { background: linear-gradient(to right, #bf360c, #e65100); color: white; padding: 10px 15px; font-size: 1.5rem; font-weight: 900; display: flex; justify-content: space-between; border-bottom: 2px solid #fff; flex-shrink: 0; }
        .dest-list { font-size: 1.5rem; }

        /* è¡¨æ ¼è¨­å®š (5æ¬„ + 7ç­è»Š) */
        .train-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 1.6rem; font-weight: bold; table-layout: fixed; }
        .train-table th { padding: 8px; color: #fff; border-bottom: 2px solid #fff; height: 40px; font-size: 1.3rem; }
        .train-table tbody tr { border-bottom: 1px solid #333; } /* 7ç­è»Š */
        .train-table td { 
            padding: 0 5px; 
            vertical-align: middle; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            height: 60px; /* 8ç­è»Š */
        }

        .table-1 th { background: #000080; } .table-1 tr:nth-child(odd) { background: #000; } .table-1 tr:nth-child(even) { background: #002f4b; }
        .table-0 th { background: #bf360c; } .table-0 tr:nth-child(odd) { background: #000; } .table-0 tr:nth-child(even) { background: #3e2723; }

        .marquee-footer { background: #212121; color: #ffeb3b; height: 50px; position: relative; overflow: hidden; border-top: 3px solid #ff9800; flex-shrink: 0; }
        .marquee-footer .marquee-text { position: absolute; white-space: nowrap; left: 100%; height: 50px; line-height: 50px; font-size: 1.4rem; font-weight: bold; }

        /* Media Section */
        .media-section { height: 280px; display: flex; gap: 10px; flex-shrink: 0; } 
        .media-box { flex: 1; background: #000; border: 3px solid #333; border-radius: 8px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
        .media-label { position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.7); color: #fff; padding: 4px 10px; font-size: 1rem; z-index: 10; border-bottom-right-radius: 8px; }
        
        .carousel-img { width: 100%; height: 100%; object-fit: contain; position: absolute; opacity: 0; transition: opacity 1s; }
        .carousel-img.active { opacity: 1; }
        .video-iframe { width: 100%; height: 100%; border: none; }

        /* è»Šç¨®é¡è‰² */
        .train-type-badge { 
            display: inline-block; 
            padding: 2px 6px; 
            border-radius: 4px; 
            color: white; 
            font-size: 1.2rem; 
            font-weight: bold; 
            white-space: nowrap; 
            min-width: 90px;
            max-width: 130px;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        .type-è‡ªå¼· { background-color: #FF5722; }
        .type-æ–°è‡ªå¼· { background: linear-gradient(135deg, #222 0%, #444 100%); border: 1px solid #999; }
        .type-æ™®æ‚ ç‘ª { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); }
        .type-å¤ªé­¯é–£ { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .type-è’å…‰ { background-color: #FF9800; }
        .type-å€é–“å¿« { background-color: #3F51B5; }
        .type-å€é–“ { background-color: #2196F3; }
        .type-å…¶ä»– { background-color: #607D8B; }

        /* ç‹€æ…‹èˆ‡æ™‚é–“ */
        .status-ontime { color: #FFFFFF !important; } 
        .status-delay { color: #ff1744 !important; animation: blink 1s infinite alternate; }
        .status-cancelled { color: #FF5252; font-weight: 900; }
        
        /* å»¶èª¤æ™‚é–“å®¹å™¨ -> æ©«å‘ä¸¦æ’é¡¯ç¤º */
        .time-delay-container { 
            display: flex; 
            flex-direction: row; /* æ©«å‘æ’åˆ— */
            justify-content: flex-end; /* é å³å°é½Š */
            align-items: center; /* å‚ç›´ç½®ä¸­ */
            height: 100%; 
            padding-right: 5px;
            gap: 8px; /* å…©å€‹æ™‚é–“ä¹‹é–“çš„é–“éš” */
        }
        .original-time { 
            text-decoration: line-through; 
            color: #777; 
            font-size: 1.2rem;
            line-height: 1.8rem; /* èˆ‡é è¨ˆæ™‚é–“å°é½ */
        }
        .expected-time { 
            color: #4fc3f7; 
            font-weight: bold; 
            font-size: 1.8rem; 
        }
        .normal-time { font-size: 1.8rem; font-family: Consolas; text-align: right; padding-right: 5px; }
        .highlight-row { background-color: rgba(255, 255, 255, 0.15) !important; border: 2px solid #ffeb3b !important; }

        @keyframes dynamic-marquee { from { transform: translateX(var(--start-pos)); } to { transform: translateX(var(--end-pos)); } }
        
        /* ğŸ”¥ RWD ä¿®æ­£å€å¡Š (é‡å°å°è¢å¹•ï¼Œå¦‚æ‰‹æ©Ÿ/å¹³æ¿) */
        @media (max-width: 900px) {
            .unified-header { 
                height: 65px;
                padding: 0 8px; 
                gap: 8px;
            }
            .tra-logo-img { height: 42px; }
            
            .station-branding { gap: 8px; }
            .station-name-block { flex-direction: column; gap: 0; align-items: flex-start; }
            .station-name { font-size: 2.3rem; } 
            .station-sub { font-size: 2.3rem; }

            .datetime-block { gap: 8px; }
            .date-text { font-size: 2rem; }
            .time-text { font-size: 2rem; }

            .unified-marquee-container { 
                height: 45px;
                margin-left: -8px;
                margin-right: -8px;
            } 
            .unified-marquee-container .marquee-text { 
                line-height: 45px; 
                font-size: 1.4rem; 
            } 

            .pids-section { flex-direction: column; gap: 8px; overflow-y: auto; }
            .pids-column { min-height: 280px; flex-shrink: 0; }
            
            .direction-header-0, .direction-header-1 {
                font-size: 1.1rem;
                padding: 6px 10px;
            }
            .dest-list { font-size: 0.9rem; }

            .train-table { font-size: 1.1rem; }
            .train-table th { font-size: 0.95rem; padding: 4px 2px; height: 28px; }
            .train-table td { height: 55px; padding: 0 3px; } /* æ‰‹æ©Ÿç‰ˆ5ç­è»Šä½”æ»¿ç©ºé–“ */

            .train-type-badge { font-size: 0.75rem; min-width: 50px; max-width: 70px; padding: 2px 3px; }
            .normal-time, .expected-time { font-size: 1.1rem; }
            .original-time { font-size: 0.8rem; }

            .marquee-footer { height: 38px; }
            .marquee-footer .marquee-text { font-size: 0.95rem; line-height: 38px; }

            /* ğŸ”¥ ä¿®æ­£: æ‰‹æ©Ÿç‰ˆåª’é«”å€å¡Šæ”¹ç‚ºå‚ç›´å †ç–Šä¸¦å¯æ»‘å‹• */
            .media-section { 
                height: 160px; 
                flex-direction: column; 
                gap: 8px;
                overflow-y: auto; /* å•Ÿç”¨å‚ç›´æ»¾å‹• */
            }
            .media-box { height: 140px; } /* æ¯å€‹ç›’å­é«˜åº¦èª¿æ•´ */
        }
        
        @media (max-width: 480px) {
            .unified-header { height: 60px; padding: 0 5px; }
            .tra-logo-img { height: 38px; }
            .station-name-block { flex-direction: column; gap: 0; align-items: flex-start; }
            .station-name { font-size: 1.8rem; }
            .station-sub { font-size: 0.7rem; }
            .date-text { font-size: 0.65rem; }
            .time-text { font-size: 1.6rem; }
            .unified-marquee-container { height: 40px; }
            .unified-marquee-container .marquee-text { line-height: 40px; font-size: 1.2rem; }
            .direction-header-0, .direction-header-1 { font-size: 0.95rem; padding: 4px 8px; }
            .dest-list { font-size: 0.8rem; }
            .pids-section { overflow-y: auto; }
            .pids-column { min-height: 250px; flex-shrink: 0; }
            .train-table { font-size: 0.95rem; }
            .train-table th { font-size: 0.8rem; height: 26px; padding: 3px 1px; }
            .train-table td { height: 50px; padding: 0 2px; }
            .train-type-badge { font-size: 0.75rem; min-width: 48px; }
            .normal-time, .expected-time { font-size: 0.95rem; }
            .marquee-footer { height: 35px; }
            .marquee-footer .marquee-text { font-size: 0.85rem; line-height: 35px; }
            .media-section { height: 200px; }
            #videoBox { display: none; }
            #carouselBox { height: 100%; }
        }
    </style>
    <script src="assets/station-code-mapping.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="unified-header">
        <div class="station-branding">
            <img src="https://www.railway.gov.tw/tra-tip-web/static/images/TRA_logo.jpg" class="tra-logo-img">
            <div class="station-name-block">
                <div class="station-name" id="unifiedStationName">è‡ºéµè»Šç«™</div>
                <div class="station-sub" id="station-en">TRA STATION</div>
            </div>
        </div>
        <div class="datetime-block">
            <div class="date-text" id="unifiedDate">Loading...</div>
            <div class="time-text" id="unifiedTime">--:--:--</div>
        </div>
    </div>

    <!-- Top Marquee -->
    <div class="unified-marquee-container">
        <div class="marquee-text" id="unifiedTopMarquee">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- PIDS Tables -->
    <div class="pids-section">
        <!-- é€†è¡Œ -->
        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-1"><span id="dirTitle1">é€†è¡Œ</span><span id="destList1" class="dest-list"></span></div>
                <table class="train-table table-1">
                    <thead>
                        <tr>
                            <th style="width:15%">è»Šæ¬¡</th>
                            <th style="width:20%">è»Šç¨®</th>
                            <th style="width:28%">é–‹å¾€</th>
                            <th style="width:20%">å¯¦éš›é–‹è»Šæ™‚é–“</th>
                            <th style="width:17%">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="body1"></tbody>
                </table>
            </div>
            <div class="marquee-footer"><div class="marquee-text" id="marquee1">è®€å–ä¸­...</div></div>
        </div>
        <!-- é †è¡Œ -->
        <div class="pids-column">
            <div class="screen-body">
                <div class="direction-header-0"><span id="dirTitle0">é †è¡Œ</span><span id="destList0" class="dest-list"></span></div>
                <table class="train-table table-0">
                    <thead>
                        <tr>
                            <th style="width:15%">è»Šæ¬¡</th>
                            <th style="width:20%">è»Šç¨®</th>
                            <th style="width:28%">é–‹å¾€</th>
                            <th style="width:20%">å¯¦éš›é–‹è»Šæ™‚é–“</th>
                            <th style="width:17%">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="body0"></tbody>
                </table>
            </div>
            <div class="marquee-footer"><div class="marquee-text" id="marquee0">è®€å–ä¸­...</div></div>
        </div>
    </div>

    <!-- Media -->
    <div class="media-section">
        <div class="media-box" id="carouselBox">
            <div class="media-label">å®£å°è³‡è¨Š</div>
            <img src="https://www.railway.gov.tw/tra-tip-web/static/images/hero-bg-01.jpg" class="carousel-img active">
        </div>
        <div class="media-box" id="videoBox">
            <div class="media-label">å½±éŸ³å°ˆå€</div>
            <div id="videoContainer" style="width:100%;height:100%"></div>
        </div>
    </div>

    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <script>
        // --- èªè¨€å­—å…¸ ---
        const i18n = {
            zh: {
                inbound: "é€†è¡Œ", outbound: "é †è¡Œ",
                trainNo: "è»Šæ¬¡", type: "è»Šç¨®", dest: "é–‹å¾€", time: "å¯¦éš›é–‹è»Šæ™‚é–“", status: "ç‹€æ…‹",
                onTime: "æº–é»", delay: "æ™š {min} åˆ†", cancelled: "åœé§›",
                toward: "å¾€", curPos: "åˆ—è»Šç›®å‰ä½ç½®ï¼š", nextPos: " â¡ ", expected: "æœ¬ç«™é è¨ˆï¼š", arrive: " æŠµé”",
                adv: "å®£å°è³‡è¨Š", video: "å½±éŸ³å°ˆå€", noTrain: "ç›®å‰ç„¡åˆ—è»Šè³‡è¨Š",
                notDeparted: "åˆ—è»Šå°šæœªç™¼è»Š", detecting: "åˆ—è»Šè¨Šè™Ÿåµæ¸¬ä¸­",
                types: { 
                    "æ–°è‡ªå¼·": "æ–°è‡ªå¼·", "è‡ªå¼·": "è‡ªå¼·", "æ™®æ‚ ç‘ª": "æ™®æ‚ ç‘ª", 
                    "å¤ªé­¯é–£": "å¤ªé­¯é–£", "è’å…‰": "è’å…‰", "å€é–“å¿«": "å€é–“å¿«", "å€é–“": "å€é–“", "å°ˆè»Š": "å°ˆè»Š", "å…¶ä»–": "åˆ—è»Š"
                }
            },
            en: {
                inbound: "Northbound", outbound: "Southbound",
                trainNo: "Train No.", type: "Type", dest: "Destination", time: "Departure", status: "Status",
                onTime: "On Time", delay: "{min} Min Late", cancelled: "Cancelled",
                toward: "To ", curPos: "Current Location: ", nextPos: " â¡ ", expected: "ETA at Station: ", arrive: "",
                adv: "Information", video: "Media Center", noTrain: "No Train Information",
                notDeparted: "Not Yet Departed", detecting: "Signal Detecting",
                types: { 
                    "æ–°è‡ªå¼·": "New T.C.", "è‡ªå¼·": "T.C.", "æ™®æ‚ ç‘ª": "Puyuma", 
                    "å¤ªé­¯é–£": "Taroko", "è’å…‰": "C.K.", "å€é–“å¿«": "Fast Local", "å€é–“": "Local", "å°ˆè»Š": "Special Train", "å…¶ä»–": "Train"
                },
                notes: {
                    "æ¯æ—¥è¡Œé§›": "Daily",
                    "é€¢é€±äº”è‡³æ—¥è¡Œé§›": "Fri-Sun Only",
                    "é€¢é€±å…­ã€æ—¥è¡Œé§›": "Sat & Sun Only",
                    "é€¢é€±å…­æ—¥è¡Œé§›": "Weekends Only",
                    "åœ¨å½°åŒ–è·¨ç·š": "Via Changhua",
                    "è·¨ç·šåˆ—è»Š": "Cross-line",
                    "æœ¬è»Šæ¬¡ä¸ç™¼å”®ç„¡åº§ç¥¨": "Reserved Only",
                    "åƒ…åœé å¤§ç«™": "Major Stops Only",
                    "ä¸åœé éƒ¨åˆ†å°ç«™": "Express Service"
                }
            }
        };

        let currentLang = localStorage.getItem('pids_lang') || 'zh';
        let lastTrainData = []; // å¿«å–æœ€è¿‘ä¸€æ¬¡æŠ“åˆ°çš„åˆ—è»Šè³‡æ–™
        let autoSwitchTimer = null;
        let isVideoLoaded = false; // é˜²æ­¢é‡è¤‡è¼‰å…¥å½±ç‰‡
        const SWITCH_INTERVAL = 80000; // 80 ç§’è‡ªå‹•åˆ‡æ›

        const TRA_WORKER_URL = "https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev";
        let GLOBAL_STATION_ID = "";
        const MAX_ROWS = 8; 
        const RWD_MAX_ROWS = 4; // ğŸ”¥ æ‰‹æ©Ÿç‰ˆé¡¯ç¤º4ç­

        const TRAIN_TYPES = { 
            "1100":"è‡ªå¼·", "1101":"å¤ªé­¯é–£", "1102":"è‡ªå¼·", "1103":"è‡ªå¼·", "1107":"æ™®æ‚ ç‘ª", 
            "1108":"è‡ªå¼·", "110B":"æ–°è‡ªå¼·", "110G":"æ–°è‡ªå¼·", "110H":"æ–°è‡ªå¼·", "110K":"æ–°è‡ªå¼·", "110M":"æ–°è‡ªå¼·",
            "1110":"è’å…‰", "1111":"è’å…‰", "1114":"è’å…‰", "1115":"è’å…‰", "1120":"å¾©èˆˆ", 
            "1131":"å€é–“", "1132":"å€é–“å¿«", "1140":"æ™®å¿«", "1150":"æŸ´å¿«", "1270":"æ™®é€š"
        };
        const stopsCache = {};

        // å¸¸ç”¨è»Šç«™è‹±è­¯å­—å…¸ (ä½œç‚ºå‚™æ´ï¼Œç¢ºä¿ 100% æœ‰è‹±æ–‡)
        const stationEnMap = {
            "åŸºéš†": "Keelung", "ä¸ƒå µ": "Qidu", "å—æ¸¯": "Nangang", "æ¾å±±": "Songshan", "è‡ºåŒ—": "Taipei", 
            "å°åŒ—": "Taipei", "æ¿æ©‹": "Banqiao", "æ¨¹æ—": "Shulin", "æ¡ƒåœ’": "Taoyuan", "ä¸­å£¢": "Zhongli", 
            "æ–°ç«¹": "Hsinchu", "ç«¹å—": "Zhunan", "è‹—æ —": "Miaoli", "è±åŸ": "Fengyuan", "è‡ºä¸­": "Taichung", 
            "å°ä¸­": "Taichung", "å½°åŒ–": "Changhua", "å“¡æ—": "Yuanlin", "æ–—å…­": "Douliu", "å˜‰ç¾©": "Chiayi", 
            "æ–°ç‡Ÿ": "Xinying", "è‡ºå—": "Tainan", "å°å—": "Tainan", "å²¡å±±": "Gangshan", "æ–°å·¦ç‡Ÿ": "Xinzuoying", 
            "å·¦ç‡Ÿ": "Zuoying", "é«˜é›„": "Kaohsiung", "å±æ±": "Pingtung", "æ½®å·": "Chaozhou", "æ‹å¯®": "Fangliao", 
            "è‡ºæ±": "Taitung", "å°æ±": "Taitung", "ç‰é‡Œ": "Yuli", "èŠ±è“®": "Hualien", "è˜‡æ¾³æ–°": "Su'aoxin", 
            "è˜‡æ¾³": "Su'ao", "å®œè˜­": "Yilan", "ç¾…æ±": "Luodong", "ç‘èŠ³": "Ruifang", "ç¦éš†": "Fulong",
            "å…«å µ": "Badu", "æ±æ­¢": "Xizhi", "è¬è¯": "Wanhua", "é¶¯æ­Œ": "Yingge", "æ¥Šæ¢…": "Yangmei",
            "æ¹–å£": "Hukou", "ç«¹åŒ—": "Zhubei", "é¦™å±±": "Xiangshan", "å´é ‚": "Qiding", "è«‡æ–‡": "Tanwen",
            "å¤§ç”²": "Dajia", "æ¸…æ°´": "Qingshui", "æ²™é¹¿": "Shalu", "é¾äº•": "Longjing", "å¤§è‚š": "Dadu",
            "è¿½åˆ†": "Zhuifen", "çƒæ—¥": "Wuri", "æˆåŠŸ": "Chenggong", "ç”°ä¸­": "Tianzhong", "äºŒæ°´": "Ershui",
            "æ—å…§": "Linnei", "æ–—å—": "Dounan", "çŸ³æ¦´": "Shiliu", "å¤§æ—": "Dalin", "æ°‘é›„": "Minxiong",
            "æ°´ä¸Š": "Shuishang", "å—é–": "Nanjing", "å¾Œå£": "Houbi", "æ—é³³ç‡Ÿ": "Linfengying", "éš†ç”°": "Longtian",
            "æ‹”æ—": "Balin", "å–„åŒ–": "Shanhua", "æ°¸åº·": "Yongkang", "å¤§æ©‹": "Daqiao", "ä¿å®‰": "Baoan",
            "ä¸­æ´²": "Zhongzhou", "æ©‹é ­": "Qiaotou", "æ¥ æ¢“": "Nanzi", "æ–°å·¦ç‡Ÿ": "Xinzuoying", "é³³å±±": "Fengshan",
            "å¾Œåº„": "Houzhuang", "ä¹æ›²å ‚": "Jiuqutang", "å…­å¡Šå": "Liukuaicuo", "æ­¸ä¾†": "Guilai", "éºŸæ´›": "Linluo",
            "è¥¿å‹¢": "Xishi", "ç«¹ç”°": "Zhutian", "å…§ç…": "Neishi", "æ‹å±±": "Fangshan", "åŠ ç¥¿": "Jialu",
            "å¤ªéº»é‡Œ": "Taimali", "çŸ¥æœ¬": "Zhiben", "åº·æ¨‚": "Kangle", "é¹¿é‡": "Luye", "ç‘å’Œ": "Ruihe",
            "ç‘ç©—": "Ruisui", "å…‰å¾©": "Guangfu", "è¬æ¦®": "Wanrong", "é³³æ—": "Fenglin", "å—å¹³": "Nanping",
            "å£½è±": "Shoufeng", "å¿—å­¸": "Zhixue", "å¹³å’Œ": "Pinghe", "æ–°åŸ": "Xincheng", "æ™¯ç¾": "Jingmei",
            "å’Œå¹³": "Heping", "å’Œä»": "Heren", "å´‡å¾·": "Chongde", "å—æ¾³": "Nan'ao", "æ±æ¾³": "Dong'ao",
            "æ°¸æ¨‚": "Yongle", "è˜‡æ¾³æ–°ç«™": "Su'aoxin", "å†¬å±±": "Dongshan", "ä¸‰è²‚å¶º": "Sandiaolin", "ç‰¡ä¸¹": "Mudan",
            "é›™æºª": "Shuangxi", "è²¢å¯®": "Gongliao", "æµ·å±±": "Mountain Line", "å±±ç·š": "Mountain Line", "æµ·ç·š": "Coast Line"
        };

        // ç¿»è­¯è»Šç«™åç¨±çš„å‡½å¼
        function translateStation(zhName) {
            if (currentLang === 'zh') return zhName;
            
            // ç§»é™¤æ‹¬è™Ÿå…§çš„æ–‡å­— (å¦‚ å±±ã€æµ·) ç¨ç«‹ç¿»è­¯
            let cleanName = zhName.replace(/\s*\(å±±\)/g, "").replace(/\s*\(æµ·\)/g, "").replace(/è»Šç«™$/g, "").trim();
            let suffix = "";
            if (zhName.includes("(å±±)")) suffix = " (MT)";
            if (zhName.includes("(æµ·)")) suffix = " (CO)";

            // å…ˆæ‰¾ stationDataMap (å¦‚æœä½ å¼•å…¥çš„ mapping.js æœ‰è³‡æ–™)
            if (typeof stationDataMap !== 'undefined') {
                for (let code in stationDataMap) {
                    if (stationDataMap[code].name === cleanName || stationDataMap[code].name === cleanName + "ç«™") {
                        return stationDataMap[code].ename.split('_')[0] + suffix;
                    }
                }
            }

            // å†æ‰¾æ‰‹å‹•å­—å…¸
            return (stationEnMap[cleanName] || cleanName) + suffix;
        }

        // ç¿»è­¯å‚™è¨»çš„å‡½å¼
        function translateNote(note) {
            if (currentLang === 'zh' || !note || note.trim() === '') return note;
            const lang = i18n[currentLang];
            // æª¢æŸ¥æ˜¯å¦æœ‰é è¨­ç¿»è­¯ï¼Œå¦å‰‡å›å‚³åŸå­—
            return lang.notes?.[note.trim()] || note;
        }

        // --- èªè¨€åˆ‡æ›åŠŸèƒ½ ---
        function toggleLanguage(isAuto = false) {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            localStorage.setItem('pids_lang', currentLang);
            
            console.log(`[èªè¨€åˆ‡æ›] åˆ‡æ›è‡³: ${currentLang.toUpperCase()} ${isAuto ? '(è‡ªå‹•)' : '(æ‰‹å‹•)'}`);
            
            updateUIStrings();
            
            // å¦‚æœæœ‰èˆŠè³‡æ–™ï¼Œç›´æ¥é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼Œä¸éœ€è¦ç­‰ API
            if (lastTrainData.length > 0) {
                refreshDisplay();
            }

            // å¦‚æœæ˜¯æ‰‹å‹•é»æ“Šï¼Œé‡è¨­è¨ˆæ™‚å™¨
            if (!isAuto) {
                startAutoSwitch();
            }
        }

        function startAutoSwitch() {
            if (autoSwitchTimer) clearInterval(autoSwitchTimer);
            autoSwitchTimer = setInterval(() => {
                toggleLanguage(true);
            }, SWITCH_INTERVAL);
        }

        function updateUIStrings() {
            const lang = i18n[currentLang];
            
            // æ›´æ–°æ–¹å‘æ¨™é¡Œ
            const dir1Title = document.getElementById('dirTitle1');
            const dir0Title = document.getElementById('dirTitle0');
            if (dir1Title) dir1Title.innerText = lang.inbound;
            if (dir0Title) dir0Title.innerText = lang.outbound;
            
            // æ›´æ–°è¡¨é ­
            const headHtml = `
                <tr>
                    <th style="width:15%">${lang.trainNo}</th>
                    <th style="width:20%">${lang.type}</th>
                    <th style="width:28%">${lang.dest}</th>
                    <th style="width:20%">${lang.time}</th>
                    <th style="width:17%">${lang.status}</th>
                </tr>`;
            
            const table1Head = document.querySelector('.table-1 thead');
            const table0Head = document.querySelector('.table-0 thead');
            if (table1Head) table1Head.innerHTML = headHtml;
            if (table0Head) table0Head.innerHTML = headHtml;
        }

        function updateEnglishStationName(stationID) {
            const enElement = document.getElementById('station-en');
            if (enElement && typeof stationDataMap !== 'undefined' && stationDataMap[stationID]) {
                const rawName = stationDataMap[stationID].ename;
                const formattedName = rawName.split('_')[0].toUpperCase();
                enElement.innerText = `${formattedName} STATION`;
            } else {
                enElement.innerText = "TRA STATION";
            }
        }
        
        function getInfo(t) {
            // ğŸ”¥ ä¿®æ­£: ä½¿ç”¨ String() ç¢ºä¿ name çµ•å°æ˜¯å­—ä¸²ï¼Œé˜²æ­¢ null/undefined å°è‡´ .includes() æ‹‹éŒ¯
            let name = String(TRAIN_TYPES[t.TrainTypeID] || t.TrainTypeName?.Zh_tw || 'åˆ—è»Š');
            let cls = 'å…¶ä»–';
            
            if(name.includes('æ–°è‡ªå¼·') || name.includes('3000')) { 
                name='æ–°è‡ªå¼·';
                cls='æ–°è‡ªå¼·';
            }
            else if(name.includes('è‡ªå¼·') || name.includes('æ¨æ‹‰å¼è‡ªå¼·')) { 
                name='è‡ªå¼·';
                cls='è‡ªå¼·';
            }
            else if(name.includes('æ™®æ‚ ç‘ª')) { cls='æ™®æ‚ ç‘ª'; }
            else if(name.includes('å¤ªé­¯é–£')) { cls='å¤ªé­¯é–£'; }
            else if(name.includes('è’å…‰')) { cls='è’å…‰'; }
            else if(name.includes('å€é–“å¿«')) { cls='å€é–“å¿«'; }
            else if(name.includes('å€é–“')) { cls='å€é–“'; }
            else if(name.includes('å°ˆè»Š')) { cls='å°ˆè»Š'; }
            else if(name === 'åˆ—è»Š') { 
                cls = 'å€é–“';
            }
            
            // å¤šèªè¨€æ”¯æ´
            const lang = i18n[currentLang];
            const displayName = lang.types[cls] || name;
            
            return { name: displayName, cls };
        }

        async function fetchTrainStops(trainNo) {
            if (stopsCache[trainNo]) return stopsCache[trainNo];
            try {
                // å˜—è©¦æ–¹æ¡ˆ 1: å¾ Worker çš„ /api/schedule å–å¾—
                let r = await fetch(`${TRA_WORKER_URL}/api/schedule?trainNo=${trainNo}`);
                let d = await r.json();
                console.log(`[${trainNo}] Worker /api/schedule çµæœ:`, d);
                if(Array.isArray(d) && d.length && d[0].StopTimes) { 
                    console.log(`âœ… [${trainNo}] å–å¾— ${d[0].StopTimes.length} ç­†åœé ç«™ (Worker é™£åˆ—)`);
                    stopsCache[trainNo] = d[0].StopTimes; 
                    return d[0].StopTimes; 
                }
                if(d && d.StopTimes) {
                    console.log(`âœ… [${trainNo}] å–å¾— ${d.StopTimes.length} ç­†åœé ç«™ (Worker ç›´æ¥)`);
                    stopsCache[trainNo] = d.StopTimes;
                    return d.StopTimes;
                }
            } catch(e) { console.warn(`[${trainNo}] Worker API å¤±æ•—:`, e); } 
            
            try {
                // å˜—è©¦æ–¹æ¡ˆ 2: ç›´æ¥å¾ TDX V3 å–å¾—
                let r = await fetch(`https://tdx.transportdata.tw/api/basic/v3/Rail/TRA/DailyTrainTimetable/Today?$filter=TrainInfo/TrainNo eq '${trainNo}'&$format=JSON`);
                let d = await r.json();
                console.log(`[${trainNo}] TDX V3 çµæœ:`, d);
                if(d?.value?.[0]?.StopTimes) {
                    console.log(`âœ… [${trainNo}] å–å¾— ${d.value[0].StopTimes.length} ç­†åœé ç«™ (TDX V3)`);
                    stopsCache[trainNo] = d.value[0].StopTimes;
                    return d.value[0].StopTimes;
                }
            } catch(e) { console.warn(`[${trainNo}] TDX V3 API å¤±æ•—:`, e); }
            
            console.error(`âŒ [${trainNo}] ç„¡æ³•å¾ä»»ä½•ä¾†æºå–å¾—åœé ç«™è³‡æ–™`);
            return [];
        }

        function getExpectedTime(timeStr, delayMins) {
            if (!timeStr || delayMins === 0) return timeStr;
            const [h, m] = timeStr.split(':').map(Number);
            const total = h * 60 + m + delayMins;
            const newH = Math.floor(total / 60) % 24;
            const newM = total % 60;
            return `${String(newH).padStart(2,'0')}:${String(newM).padStart(2,'0')}`;
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('unifiedTime').innerText = now.toLocaleTimeString('en-GB');
            document.getElementById('unifiedDate').innerText = now.toISOString().split('T')[0].replace(/-/g,'/');
        }
        setInterval(updateClock, 1000);

        async function updateMediaAssets() {
            try {
                const res = await fetch(`${TRA_WORKER_URL}/api/pids/assets`);
                if (res.ok) {
                    const data = await res.json();
                    if(data.images && data.images.length > 0) setupCarousel(data.images);
                    
                    // é¿å…èªè¨€åˆ‡æ›æ™‚é‡è¤‡è¼‰å…¥å½±ç‰‡ï¼ˆæœƒå°è‡´å½±ç‰‡é‡æ–°é–‹å§‹ï¼‰
                    if (!isVideoLoaded) {
                        const videos = Array.isArray(data.video) ? data.video : (data.video ? [data.video] : []);
                        if(videos.length > 0) {
                            setupVideo(videos);
                            isVideoLoaded = true;
                        }
                    }
                }
            } catch(e) { console.warn("Media Load Error", e); }
        }

        let carTimer;
        function setupCarousel(imgs) {
            const box = document.getElementById('carouselBox');
            box.querySelectorAll('img').forEach(i=>i.remove());
            imgs.forEach((src,i) => {
                const img = document.createElement('img');
                img.src = src; img.className = i===0?'carousel-img active':'carousel-img';
                box.appendChild(img);
            });
            let idx = 0;
            if(carTimer) clearInterval(carTimer);
            carTimer = setInterval(() => {
                const list = box.querySelectorAll('img');
                if(list.length>1) {
                    list[idx].classList.remove('active');
                    idx = (idx+1)%list.length;
                    list[idx].classList.add('active');
                }
            }, 10000);
        }

        function setupVideo(urls) {
            const con = document.getElementById('videoContainer');
            let videoIds = [];

            // å¼·åŒ–çš„ YouTube ID æ“·å–é‚è¼¯ (æ”¯æ´ Shorts, æ‰‹æ©Ÿç‰ˆé€£çµ)
            urls.forEach(url => {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = url.match(regExp);
                if (match && match[2].length === 11) {
                    videoIds.push(match[2]);
                }
            });

            if(videoIds.length > 0) {
                const first = videoIds[0];
                const playlist = videoIds.join(',');
                const currentOrigin = window.location.origin;

                // æ ¸å¿ƒè¨­å®šï¼š
                // 1. controls=0 : å¾¹åº•éš±è—é€²åº¦æ¢ã€éŸ³é‡éµã€å…¨è¢å¹•æŒ‰éˆ•ç­‰ã€‚
                // 2. mute=1 : éœéŸ³ï¼Œç¢ºä¿ç€è¦½å™¨å…è¨± autoplayã€‚
                // 3. ç§»é™¤ pointer-events: none : è®“æ»‘é¼ é»æ“Šæœ‰æ•ˆï¼ˆå¯æš«åœ/æ’­æ”¾ï¼‰ã€‚
                // 4. disablekb=1 : ç¦ç”¨éµç›¤æ§åˆ¶ã€‚
                con.innerHTML = `
                    <iframe 
                        class="video-iframe" 
                        src="https://www.youtube-nocookie.com/embed/${first}?autoplay=1&mute=1&loop=1&playlist=${playlist}&controls=0&rel=0&enablejsapi=1&origin=${currentOrigin}&disablekb=1" 
                        allow="autoplay; encrypted-media; picture-in-picture" 
                        allowfullscreen
                        style="width:100%; height:100%; border:none;">
                    </iframe>`;
                    
                console.log(`âœ… YouTube å½±ç‰‡å·²è¼‰å…¥: ${first}`);
            } else if (urls.length > 0 && typeof urls[0] === 'string' && !urls[0].includes('youtube')) {
                // åŸç”Ÿå½±ç‰‡æª”æ¡ˆ (.mp4) ç§»é™¤ controls å±¬æ€§å³å¯éš±è—é€²åº¦æ¢
                con.innerHTML = `<video src="${urls[0]}" autoplay muted loop playsinline style="width:100%;height:100%;object-fit:contain;"></video>`;
                console.log(`âœ… æœ¬åœ°å½±ç‰‡å·²è¼‰å…¥: ${urls[0]}`);
            } else {
                // å¦‚æœæ²’æœ‰å½±ç‰‡ï¼Œé¡¯ç¤ºé è¨­è¨Šæ¯
                con.innerHTML = `<div style="padding:20px; color:#666; text-align:center; font-size:1.2rem;">ğŸ“¹ æš«ç„¡å½±éŸ³å…§å®¹</div>`;
            }
        }

        function startMarquee(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const container = el.parentElement;
            
            // æ¸…é™¤èˆŠçš„ç›£è½èˆ‡ç‹€æ…‹
            el.ontransitionend = null;
            el.style.transition = 'none';
            
            // è®“ç€è¦½å™¨æœ‰æ™‚é–“æ¸²æŸ“æ–‡å­—å¾Œå†å–å¯¬åº¦
            setTimeout(() => {
                const textWidth = el.scrollWidth;
                const containerWidth = container.clientWidth;
                
                // èµ·å§‹ä½ç½®ï¼šå®¹å™¨æœ€å³é‚Š
                el.style.left = containerWidth + 'px';
                
                // è¨ˆç®—é€Ÿåº¦ï¼šè¨­å®šæ¯åƒç´ è·‘å¤šå°‘ç§’ (æ•¸å€¼è¶Šå°è¶Šå¿«)
                // é›»è…¦ç‰ˆè¶…åŠ é€Ÿã€æ‰‹æ©Ÿç‰ˆæ­£å¸¸é€Ÿåº¦
                const isMobileScreen = window.innerWidth <= 900;
                let speed;
                if (id === 'unifiedTopMarquee') {
                    speed = isMobileScreen ? 0.010 : 0.006;  // é›»è…¦ç‰ˆå…¬å‘Šè¶…åŠ é€Ÿ
                } else {
                    speed = isMobileScreen ? 0.008 : 0.006;  // åˆ—è»Šè³‡æ–™ç¶­æŒ
                }
                const duration = Math.max(10, (textWidth + containerWidth) * speed);

                // å¼·åˆ¶é‡ç¹ª
                void el.offsetWidth;

                // é–‹å§‹å‹•ç•«ï¼šä½ç§»åˆ°æ–‡å­—å¯¬åº¦çš„è² å€¼ï¼ˆç¢ºä¿å®Œå…¨æ¶ˆå¤±ï¼‰
                el.style.transition = `left ${duration}s linear`;
                el.style.left = `-${textWidth}px`;

                // çµæŸå¾Œé‡å•Ÿ
                el.ontransitionend = () => {
                    startMarquee(id);
                };
            }, 100);
        }

        async function updatePids(id) {
            try {
                let r = await fetch(`${TRA_WORKER_URL}/api/liveboard/station?station=${id}`);
                let d = await r.json();
                
                // ğŸ”¥ æ–°å¢ï¼šç¯©é¸å·²é–‹å‡ºçš„åˆ—è»Š (é è¨ˆç™¼è»Šæ™‚é–“ < ç¾åœ¨æ™‚é–“)
                const now = new Date();
                const currentHours = now.getHours();
                const currentMins = now.getMinutes();
                const nowTotalMinutes = currentHours * 60 + currentMins;
                
                let filtered = d.filter(t => {
                    const [h, m] = (t.ScheduledDepartureTime || "00:00").split(':').map(Number);
                    const schedMins = h * 60 + m;
                    const delayMins = parseInt(t.DelayTime || 0);
                    const actualMins = schedMins + delayMins;
                    
                    // åœé§›åˆ—è»Šä¿ç•™ï¼Œæœªä¾†ç­æ¬¡ä¹Ÿä¿ç•™
                    const isCancelled = String(t.TrainStatus) === '2';
                    const shouldShow = actualMins >= nowTotalMinutes || isCancelled;
                    
                    console.log(`[${t.TrainNo}] ${t.ScheduledDepartureTime} å¯¦éš›=${actualMins}åˆ† ç¾åœ¨=${nowTotalMinutes}åˆ† åœé§›=${isCancelled} é¡¯ç¤º=${shouldShow}`);
                    return shouldShow;
                });
                
                // ğŸ”¥ ä¿®æ­£: æŒ‰ã€Œå¯¦éš›é–‹è»Šæ™‚é–“ã€æ’åºï¼ˆç´”ç²¹æŒ‰åˆ†é˜æ•¸ï¼‰
                filtered.forEach(t => {
                    let [h,m] = (t.ScheduledDepartureTime||"00:00").split(':').map(Number);
                    let delayMins = parseInt(t.DelayTime || 0);
                    // å¯¦éš›æ™‚é–“ = è¡¨å®šæ™‚é–“ + èª¤é»
                    let actualMins = (h*60+m) + delayMins;
                    // åªæŒ‰å¯¦éš›æ™‚é–“çš„ç›¸å°åˆ†é˜æ•¸æ’åºï¼ˆå– mod 1440 ç¢ºä¿å‡Œæ™¨ç­æ¬¡æ’åœ¨å‰é¢ï¼‰
                    t._sort = actualMins % 1440;
                });
                filtered.sort((a,b) => a._sort - b._sort);

                // å„²å­˜åˆ°å¿«å–
                lastTrainData = filtered;

                refreshDisplay();
                
            } catch(e) { 
                console.error("æ›´æ–°PIDSå¤±æ•—:", e);
                renderTable('1',[]); 
                renderTable('0',[]); 
            }
        }

        // è² è²¬æŠŠ lastTrainData ç•«åˆ°ç•«é¢ä¸Š
        function refreshDisplay() {
            let t1 = lastTrainData.filter(t=>t.Direction==1);
            let t0 = lastTrainData.filter(t=>t.Direction==0);

            renderTable('1', t1); 
            renderTable('0', t0);
            updateMarquee('marquee1', t1); 
            updateMarquee('marquee0', t0);
            
            // ğŸ”¥ ä¿®æ­£: é¡¯ç¤ºå‰ 3 å€‹ç›®çš„åœ°
            populateDestinationMarquee('destList1', t1, 1);
            populateDestinationMarquee('destList0', t0, 0);
        }
        
        // ğŸ”¥ æ–°å¢: è™•ç†æ–¹å‘æ¨™é¡Œä¸‹çš„ç«™ååˆ—è¡¨é¡¯ç¤º
        function populateDestinationMarquee(id, list, direction) {
            const el = document.getElementById(id);
            const lang = i18n[currentLang];
            
            if (!list || list.length === 0) {
                el.innerText = currentLang === 'zh' 
                    ? (direction === 1 ? 'åŒ—ä¸Šåˆ—è»Šè³‡è¨Šè¼‰å…¥ä¸­...' : 'å—ä¸‹åˆ—è»Šè³‡è¨Šè¼‰å…¥ä¸­...')
                    : (direction === 1 ? 'Loading Northbound...' : 'Loading Southbound...');
                return;
            }
            
            // ç²å–å‰ 3 ç­†åˆ—è»Šçš„æœ€çµ‚ç›®çš„åœ°
            let destinations = list.slice(0, 3).map(t => {
                return translateStation(t.EndingStationName);
            });
            let uniqueDestinations = [...new Set(destinations)].join(currentLang === 'zh' ? 'ã€' : ', ');

            if (uniqueDestinations.length > 0) {
                const prefix = currentLang === 'zh' ? 'é–‹å¾€: ' : 'To: ';
                el.innerText = prefix + uniqueDestinations;
            } else {
                el.innerText = currentLang === 'zh' 
                    ? (direction === 1 ? 'ç„¡è¿‘æœŸåŒ—ä¸Šåˆ—è»Š' : 'ç„¡è¿‘æœŸå—ä¸‹åˆ—è»Š')
                    : (direction === 1 ? 'No Northbound Trains' : 'No Southbound Trains');
            }
        }

        function renderTable(dir, list) {
            const tb = document.getElementById(`body${dir}`);
            const lang = i18n[currentLang];
            tb.innerHTML = '';

            // ğŸ”¥ ä¿®æ­£: æ ¹æ“šè¢å¹•å¯¬åº¦æ±ºå®š MAX_ROWS (å¦‚æœå°æ–¼ 900px, é¡¯ç¤º 5 åˆ—)
            const isMobile = window.innerWidth <= 900;
            const currentMaxRows = isMobile ? RWD_MAX_ROWS : MAX_ROWS;
            
            list.slice(0, currentMaxRows).forEach((t, i) => {
                let info = getInfo(t);
                let delay = parseInt(t.DelayTime||0);
                let isCancel = String(t.TrainStatus)==='2';
                
                // å¤šèªè¨€ç‹€æ…‹é¡¯ç¤º
                let status = isCancel ? lang.cancelled : (delay > 0 ? lang.delay.replace('{min}', delay) : lang.onTime);
                let cls = isCancel ? 'status-cancelled' : (delay > 0 ? 'status-delay' : 'status-ontime');
                
                let timeStr = (t.ScheduledDepartureTime||"").slice(0,5);
                let timeHtml = `<span class="normal-time">${timeStr}</span>`;
                
                if(delay>0 && !isCancel) {
                    let [h,m] = timeStr.split(':').map(Number);
                    let min = h*60+m+delay;
                    let newT = `${String(Math.floor(min/60)%24).padStart(2,'0')}:${String(min%60).padStart(2,'0')}`;
                    // ğŸ”¥ ä¿®æ­£: èª¤é»æ™‚åªé¡¯ç¤ºè—è‰²é è¨ˆæ™‚é–“ï¼Œä¸é¡¯ç¤ºåŸå§‹æ™‚é–“
                    timeHtml = `<span class="expected-time">${newT}</span>`;
                }

                // å¤šèªè¨€ç›®çš„åœ°é¡¯ç¤º - ä½¿ç”¨ translateStation å‡½æ•¸
                let dest = translateStation(t.EndingStationName);
                if(t.TripLine==1) dest+= currentLang === 'zh' ? ' (å±±)' : ' (MT)';
                else if(t.TripLine==2) dest+= currentLang === 'zh' ? ' (æµ·)' : ' (CO)';

                let tr = document.createElement('tr');
                if(i===0) tr.classList.add('highlight-row');
                tr.innerHTML = `
                    <td style="font-family:Consolas">${t.TrainNo}</td>
                    <td><span class="train-type-badge type-${info.cls}">${info.name}</span></td>
                    <td>${dest}</td>
                    <td>${timeHtml}</td>
                    <td class="${cls}">${status}</td>
                `;
                tb.appendChild(tr);
            });
            // ğŸ”¥ ä¿®æ­£: å¡«å……ç©ºè¡Œï¼Œç›´åˆ°é”åˆ° currentMaxRows
            for(let i=Math.min(list.length, currentMaxRows); i<currentMaxRows; i++) tb.innerHTML+='<tr><td></td><td></td><td></td><td></td><td></td></tr>';
        }

        async function updateMarquee(elId, list) {
            const el = document.getElementById(elId);
            const lang = i18n[currentLang];
            
            if(!list || list.length===0) { 
                el.innerHTML = lang.noTrain;
                startMarquee(elId); // ğŸ”¥ å³ä½¿ç„¡å…§å®¹ä¹Ÿå•Ÿå‹•ï¼Œæœƒæ»¾å‹•ã€Œç›®å‰ç„¡åˆ—è»Šè³‡è¨Šã€
                return; 
            }
            
            let t = list[0];
            let info = getInfo(t);
            let delay = parseInt(t.DelayTime||0);
            let isCancel = String(t.TrainStatus)==='2';

            if(isCancel) {
                const destName = translateStation(t.EndingStationName);
                const cancelMsg = currentLang === 'zh' 
                    ? `ğŸš« ${t.TrainNo} æ¬¡ ${info.name} å¾€ ${destName} æœ¬æ—¥åœé§›`
                    : `ğŸš« Train ${t.TrainNo} ${info.name} to ${destName} CANCELLED`;
                el.innerHTML = `<span style="color:#FF5252;font-weight:bold">${cancelMsg}</span>`;
                startMarquee(elId);
                return;
            }

            // å¤šèªè¨€ç›®çš„åœ°
            let destName = translateStation(t.EndingStationName);

            let msg = `<span style="color:#ffeb3b;font-weight:bold">${t.TrainNo} ${info.name} ${lang.toward}${destName}</span>`;
            msg += `<span style="margin:0 15px;color:#555">|</span>`;
            
            let liveData = null;
            try {
                const liveWorkerPromise = fetch(`${TRA_WORKER_URL}/api/live?trainNo=${t.TrainNo}`).then(r=>r.json()).catch(()=>null);
                liveData = await liveWorkerPromise;

                if (liveData?.TrainLiveBoards?.length > 0) liveData = liveData.TrainLiveBoards[0];
                else if (liveData?.StationName) liveData = liveData;
                else liveData = null;
            } catch (e) {}

            let locationText = "";
            let liveDelay = 0;
            if (liveData && liveData.StationName) {
                const lastStationName = liveData.StationName.Zh_tw || liveData.StationName;
                const lastStationNameTranslated = translateStation(lastStationName);
                liveDelay = liveData.DelayTime ? parseInt(liveData.DelayTime) : 0;
                
                let stops = await fetchTrainStops(t.TrainNo);
                let nextStopName = "";
                if (stops && stops.length > 0) {
                    const passedIndex = stops.findIndex(s => s.StationName.Zh_tw === lastStationName);
                    if (passedIndex !== -1 && passedIndex < stops.length - 1) {
                        nextStopName = translateStation(stops[passedIndex + 1].StationName.Zh_tw);
                    }
                }
                
                locationText = nextStopName 
                    ? `${lang.curPos}${lastStationNameTranslated}${lang.nextPos}${nextStopName}` 
                    : `${lang.curPos}${lastStationNameTranslated}`;
                if (liveDelay > 0) locationText += currentLang === 'zh' ? ` (æ™š ${liveDelay} åˆ†)` : ` (${liveDelay} min late)`;
                
            } else {
                locationText = (t.IsTomorrow) ? lang.notDeparted : lang.detecting;
            }
            
            msg += `<span style="color:#4fc3f7">${locationText}</span>`;
            msg += `<span style="margin:0 15px;color:#555">|</span>`;

            // ğŸ”¥ ä¿®æ­£: å„ªå…ˆä½¿ç”¨ Worker å›å‚³çš„ ScheduledArrivalTime (è¡¨å®šæŠµé”æ™‚é–“)
            let arrivalTime = t.ScheduledArrivalTime || t.ScheduledDepartureTime || "00:00"; 
            
            // å˜—è©¦å–å¾—æ›´ç²¾ç¢ºçš„åœé ç«™è³‡æ–™ (å¦‚æœæœ‰çš„è©±)
            let stops = await fetchTrainStops(t.TrainNo);
            if(stops && stops.length>0) {
                let stationStop = stops.find(s => String(s.StationID) === GLOBAL_STATION_ID);
                if(stationStop && stationStop.ArrivalTime) {
                    arrivalTime = stationStop.ArrivalTime.slice(0, 5);
                }
            }
            
            const predictedTime = getExpectedTime(arrivalTime, delay);
            const timeColor = delay > 0 ? '#ff5252' : '#ffffff';
            const statusText = delay > 0 ? lang.delay.replace('{min}', delay) : lang.onTime;
            
            msg += `${lang.expected}<span style="color:${timeColor};font-weight:bold;font-size:1.1em">${predictedTime}${lang.arrive} (${statusText})</span>`;

            // ğŸ”¥ æ–°å¢ï¼šé¡¯ç¤ºåˆ—è»Šå‚™è¨»ï¼ˆæ”¯æŒç¿»è¯‘ï¼‰
            if(t.Note && t.Note.trim().length > 0) {
                msg += `<span style="margin:0 15px;color:#555">|</span>`;
                const noteLabel = currentLang === 'zh' ? 'å‚™è¨»ï¼š' : 'Note: ';
                const translatedNote = translateNote(t.Note);
                msg += `<span style="color:#ff9800;font-weight:bold">${noteLabel}${translatedNote}</span>`;
            }

            if(stops && stops.length>0) {
                let idx = stops.findIndex(s => String(s.StationID) === GLOBAL_STATION_ID);
                console.log(`[${t.TrainNo}] å°‹æ‰¾æœ¬ç«™ ${GLOBAL_STATION_ID}: æ‰¾åˆ°ç´¢å¼•=${idx}, ç¸½åœé ç«™æ•¸=${stops.length}`);
                if(idx !== -1) {
                    let next = stops.slice(idx+1).map(s => translateStation(s.StationName.Zh_tw)).join(currentLang === 'zh' ? 'ã€' : ' â†’ ');
                    console.log(`[${t.TrainNo}] å¾ŒçºŒåœé ç«™ï¼š${next || 'ç„¡(çµ‚é»)'}`);
                    if(next) {
                        const stopsLabel = currentLang === 'zh' ? 'æ²¿é€”åœé ï¼š' : 'Stops: ';
                        msg += `<span style="margin:0 15px;color:#555">|</span>${stopsLabel}${next}`;
                    }
                    else {
                        const terminalLabel = currentLang === 'zh' ? 'â–¶ çµ‚é»ç«™' : 'â–¶ Terminal';
                        msg += `<span style="margin:0 15px;color:#555">|</span>${terminalLabel}`;
                    }
                } else {
                    // æ‰¾ä¸åˆ°æœ¬ç«™ï¼Œé¡¯ç¤ºé™¤äº†èµ·é»å¤–çš„æ‰€æœ‰åœé ç«™
                    let allStops = stops.slice(1).map(s => translateStation(s.StationName.Zh_tw)).join(currentLang === 'zh' ? 'ã€' : ' â†’ ');
                    console.log(`[${t.TrainNo}] æ‰¾ä¸åˆ°æœ¬ç«™ï¼Œé¡¯ç¤ºæ‰€æœ‰åœé ç«™ï¼š${allStops}`);
                    if(allStops) {
                        const stopsLabel = currentLang === 'zh' ? 'æ²¿é€”åœé ï¼š' : 'Stops: ';
                        msg += `<span style="margin:0 15px;color:#555">|</span>${stopsLabel}${allStops}`;
                    }
                }
            } else {
                console.warn(`[${t.TrainNo}] åœé ç«™è³‡æ–™ç‚ºç©ºæˆ–æœªè¼‰å…¥`);
            }
            
            el.innerHTML = msg;
            startMarquee(elId);
        }

        async function checkTopMarquee() {
            try {
                // ğŸ”¥ ä¿®æ­£: å¸¶å…¥ station åƒæ•¸ï¼Œè®“ Worker èƒ½å›å‚³æ²¿é€”åœé ç«™è³‡è¨Š
                let url = `${TRA_WORKER_URL}/api/pids/marquee`;
                if (GLOBAL_STATION_ID) url += `?station=${GLOBAL_STATION_ID}`;
                
                let r = await fetch(url);
                let d = await r.json();
                let el = document.getElementById('unifiedTopMarquee');
                
                if (d.text !== undefined && d.text !== null) { 
                    let cleanText = d.text
                        .replace(/<b>/g, "").replace(/<\/b>/g, "")
                        .replace(/<\/[^>]+>/g, "")
                        .replace(/<(?![-]{2,}>)[^>]+>/g, "")
                        .replace(/\\n/g, "     ")
                        .replace(/[\r\n]+/g, "     ")
                        .replace(/&nbsp;/g, " ")
                        .replace(/&amp;/g, "&");
                    
                    // ğŸ”¥ é—œéµå„ªåŒ–ï¼šå¦‚æœå…§å®¹è·Ÿç¾åœ¨ä¸€æ¨£ï¼Œå°±ä¸è¦é‡å•Ÿè·‘é¦¬ç‡ˆï¼Œè®“å®ƒç¹¼çºŒè·‘å®Œ
                    if (el.innerHTML === cleanText) {
                        return; 
                    }
                    
                    el.innerHTML = cleanText; 
                    startMarquee('unifiedTopMarquee'); 
                }
            } catch(e){ console.warn("Top Marquee Error:", e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const p = new URLSearchParams(location.search);
            GLOBAL_STATION_ID = p.get('station');
            let name = p.get('name')||'è‡ºéµ';
            
            document.getElementById('unifiedStationName').innerText = name.replace(/è»Šç«™$|ç«™$/,'')+'è»Šç«™';
            
            updateEnglishStationName(GLOBAL_STATION_ID);
            updateUIStrings(); // åˆå§‹åŒ–èªè¨€ä»‹é¢
            
            updateClock();
            updateMediaAssets();
            if(GLOBAL_STATION_ID) { 
                updatePids(GLOBAL_STATION_ID); 
                setInterval(()=>updatePids(GLOBAL_STATION_ID), 60000); 
            }
            
            checkTopMarquee(); 
            setTimeout(()=>startMarquee('unifiedTopMarquee'), 1500); 
            setInterval(checkTopMarquee, 300000);  // 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡

            // ğŸ”¥ å•Ÿå‹•è‡ªå‹•èªè¨€åˆ‡æ› (æ¯ 80 ç§’)
            startAutoSwitch();
            console.log('âœ… è‡ªå‹•èªè¨€åˆ‡æ›å·²å•Ÿå‹• (æ¯ 80 ç§’åˆ‡æ›ä¸€æ¬¡)');
        });
    </script>
</body>
</html>
