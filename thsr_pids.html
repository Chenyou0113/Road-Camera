<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THSR PIDS V6.2 (Chinese Map)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        /* === 現代化 UI 設計規範 === */
        :root {
            --bg-color: #000000;
            --header-north-start: #00858a;
            --header-north-end: #1cb7af;
            --header-south-start: #1db66a;
            --header-south-end: #006030;
            
            --text-amber: #ffca28; /* 北上 LED 琥珀色 */
            --text-emerald: #00e676; /* 南下 LED 寶石綠 */
            --text-gray: #b0bec5;
            --divider: #333;
        }

        * { box-sizing: border-box; }
        body, html {
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Microsoft JhengHei', 'Roboto', 'Arial', sans-serif; /* 改用正黑體 */
            overflow: hidden;
            color: #fff;
        }

        #app { display: flex; flex-direction: column; height: 100%; }

        /* === 區域容器 === */
        .board-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid var(--divider);
        }

        /* === 標題列 (Header) === */
        .header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 10;
        }
        .header.north { background: linear-gradient(90deg, var(--header-north-start), var(--header-north-end)); }
        .header.south { background: linear-gradient(90deg, var(--header-south-start), var(--header-south-end)); }

        .header-title {
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .clock {
            font-family: 'Consolas', monospace;
            font-size: 2rem;
            font-weight: 700;
        }

        /* === Grid 佈局 === */
        .grid-row {
            display: grid;
            grid-template-columns: 10% 12% 10% 8% 15% 12% 33%;
            align-items: center;
            padding-left: 20px;
        }

        /* === 表頭 (Thead) === */
        .thead {
            height: 45px;
            background-color: #1a1a1a;
            color: #999;
            font-size: 1.1rem;
            border-bottom: 1px solid #333;
        }

        /* === 資料列 (Rows) === */
        .data-list { flex: 1; display: flex; flex-direction: column; }
        .data-row {
            flex: 1;
            border-bottom: 1px solid #222;
            font-size: 2rem;
            font-weight: 700;
        }
        
        /* === 欄位細節 === */
        .col-mono { font-family: 'Consolas', monospace; }
        .col-dest { font-size: 2.5rem; letter-spacing: 5px; } 
        .col-plat { text-align: center; }
        .col-free { font-size: 1.5rem; color: var(--text-gray); }
        .col-status { font-size: 1.5rem; }

        /* === 狀態顏色 === */
        .status-ok { color: #ffff00; } 
        .status-delay { color: #00eeff; animation: blink 1s infinite; }

        /* === 北上專屬樣式 === */
        .north-section .col-dest { color: var(--text-amber); text-shadow: 0 0 10px rgba(255, 202, 40, 0.4); }
        .north-section .col-mono { color: #fff; }
        .north-section .dot.active { background: var(--text-amber); border-color: #fff; box-shadow: 0 0 8px var(--text-amber); }
        .north-section .dot.active + .st-code { color: #fff; }

        /* === 南下專屬樣式 === */
        .south-section .col-dest { color: var(--text-emerald); text-shadow: 0 0 10px rgba(0, 230, 118, 0.4); }
        .south-section .col-mono { color: #fff; }
        .south-section .dot.active { background: var(--text-emerald); border-color: #fff; box-shadow: 0 0 8px var(--text-emerald); }
        .south-section .dot.active + .st-code { color: #fff; }

        /* === 停靠站地圖 (更新為中文適配) === */
        .map-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
            padding-right: 20px;
            position: relative;
        }
        .map-line {
            position: absolute;
            top: 45%; left: 0; right: 20px; /* 線條稍微往上提，留空間給中文 */
            height: 2px;
            background: #444;
            z-index: 0;
        }
        .station-node {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .dot {
            width: 14px; height: 14px;
            border-radius: 50%;
            background: #000;
            border: 2px solid #555;
            margin-bottom: 6px; /* 增加一點點間距 */
        }
        /* 中文站名樣式 */
        .st-code { 
            font-size: 0.9rem; /* 字稍微大一點 */
            color: #666; 
            font-family: 'Microsoft JhengHei', sans-serif; 
            font-weight: bold; 
            white-space: nowrap; /* 防止換行 */
        }

        @keyframes blink { 50% { opacity: 0.5; } }
        
        .footer {
            height: 25px;
            background: #111;
            color: #444;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            padding: 0 10px;
        }
    </style>
</head>
<body>

<div id="app">
    
    <div class="board-section north-section">
        <div class="header north">
            <div class="header-title">北上 Northbound</div>
            <div class="clock">{{ currentTime }}</div>
        </div>
        <div class="grid-row thead">
            <div>車次 Train</div>
            <div>開往 Dest.</div>
            <div>時間 Time</div>
            <div class="col-plat">月台 Plat.</div>
            <div>自由座 Non-Res.</div>
            <div>狀態 Status</div>
            <div>停靠站 Stopping Stations</div>
        </div>
        <div class="data-list">
            <div v-for="t in northboundList" :key="t.uid" class="grid-row data-row">
                <div class="col-mono">{{ t.trainNo }}</div>
                <div class="col-dest">{{ t.dest }}</div>
                <div class="col-mono">{{ t.time }}</div>
                <div class="col-plat col-mono">{{ t.plat }}</div>
                <div class="col-free">{{ t.free }}</div>
                <div class="col-status status-ok">準點 On Time</div>
                <div class="col-map">
                    <div class="map-wrapper">
                        <div class="map-line"></div>
                        <div v-for="s in stationsReversed" :key="s.id" class="station-node">
                            <div class="dot" :class="{ 'active': t.stops.includes(s.id) }"></div>
                            <span class="st-code">{{ s.name }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="board-section south-section">
        <div class="header south">
            <div class="header-title">南下 Southbound</div>
            <div class="clock">{{ currentStationName }} {{ currentStationCode }}</div>
        </div>
        <div class="grid-row thead">
            <div>車次 Train</div>
            <div>開往 Dest.</div>
            <div>時間 Time</div>
            <div class="col-plat">月台 Plat.</div>
            <div>自由座 Non-Res.</div>
            <div>狀態 Status</div>
            <div>停靠站 Stopping Stations</div>
        </div>
        <div class="data-list">
            <div v-for="t in southboundList" :key="t.uid" class="grid-row data-row">
                <div class="col-mono">{{ t.trainNo }}</div>
                <div class="col-dest">{{ t.dest }}</div>
                <div class="col-mono">{{ t.time }}</div>
                <div class="col-plat col-mono">{{ t.plat }}</div>
                <div class="col-free">{{ t.free }}</div>
                <div class="col-status status-ok">準點 On Time</div>
                <div class="col-map">
                    <div class="map-wrapper">
                        <div class="map-line"></div>
                        <div v-for="s in stationsNormal" :key="s.id" class="station-node">
                            <div class="dot" :class="{ 'active': t.stops.includes(s.id) }"></div>
                            <span class="st-code">{{ s.name }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">System Status: Online | THSR PIDS V6.2 | Data Source: {{ rawData.length > 0 ? 'Connected' : 'Connecting...' }}</div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // === 設定區 ===
            const API_URL = "https://thsr-proxy.weacamm.org";
            const urlParams = new URLSearchParams(window.location.search);
            const stationID = ref(urlParams.get('station') || "1000"); // 預設台北

            const rawData = ref([]);
            const currentTime = ref("00:00:00");

            // 站點定義
            const stations = [
                { id: "0990", name: "南港", code: "NAK", idx: 0 },
                { id: "1000", name: "台北", code: "TPE", idx: 1 },
                { id: "1010", name: "板橋", code: "BAC", idx: 2 },
                { id: "1020", name: "桃園", code: "TAY", idx: 3 },
                { id: "1030", name: "新竹", code: "HSC", idx: 4 },
                { id: "1035", name: "苗栗", code: "MIL", idx: 5 },
                { id: "1040", name: "台中", code: "TAC", idx: 6 },
                { id: "1043", name: "彰化", code: "CHA", idx: 7 },
                { id: "1047", name: "雲林", code: "YUL", idx: 8 },
                { id: "1050", name: "嘉義", code: "CHY", idx: 9 },
                { id: "1060", name: "台南", code: "TNN", idx: 10 },
                { id: "1070", name: "左營", code: "ZUY", idx: 11 }
            ];

            const curSt = computed(() => stations.find(s => s.id === stationID.value));
            const currentStationName = computed(() => curSt.value ? curSt.value.name : "台北");
            const currentStationCode = computed(() => curSt.value ? curSt.value.code : "TPE");
            const currentStationIdx = computed(() => curSt.value ? curSt.value.idx : 1);

            // === 核心資料處理 ===
            const processedTrains = computed(() => {
                const now = new Date();
                const nowTime = now.toLocaleTimeString('en-GB', { hour12: false }).substring(0, 5);

                return rawData.value.map((t, idx) => {
                    let tNo = t.train_no || t.TrainNo || "UNK";
                    let tTime = t.departure_time || t.DepartureTime || "00:00";
                    if(tTime.length > 5) tTime = tTime.substring(0, 5);

                    let destName = "未知";
                    if (t.destination && t.destination.zh) destName = t.destination.zh;
                    else if (t.DestinationStationName) destName = t.DestinationStationName.Zh_tw;
                    
                    // 方向判斷
                    let dir = -1; 
                    const destObj = stations.find(s => s.name === destName);
                    const curIdx = currentStationIdx.value;

                    if (destObj) {
                        if (destObj.idx > curIdx) dir = 0; // 南下
                        else if (destObj.idx < curIdx) dir = 1; // 北上
                    } else {
                        dir = t.direction !== undefined ? parseInt(t.direction) : 0;
                    }

                    return {
                        uid: t.id || idx,
                        trainNo: tNo,
                        time: tTime,
                        dest: destName,
                        plat: t.platform || "1",
                        free: t.free_seating_cars || "10-12",
                        stops: t.stopping_stations || [],
                        dir: dir
                    };
                })
                .filter(t => t.time >= nowTime)
                .sort((a, b) => a.time.localeCompare(b.time));
            });

            const northboundList = computed(() => processedTrains.value.filter(t => t.dir === 1).slice(0, 4));
            const southboundList = computed(() => processedTrains.value.filter(t => t.dir === 0).slice(0, 4));

            const fetchData = async () => {
                try {
                    const res = await fetch(`${API_URL}/?station=${stationID.value}`);
                    const json = await res.json();
                    
                    if(Array.isArray(json)) rawData.value = json;
                    else if(json.trains) rawData.value = json.trains;
                    
                } catch (e) { console.error(e); }
            };

            setInterval(() => {
                currentTime.value = new Date().toLocaleTimeString('en-GB', { hour12: false });
            }, 1000);
            setInterval(fetchData, 30000);

            onMounted(() => {
                fetchData();
                currentTime.value = new Date().toLocaleTimeString('en-GB', { hour12: false });
            });

            return {
                currentTime, currentStationName, currentStationCode,
                northboundList, southboundList,
                stationsNormal: stations,
                stationsReversed: [...stations].reverse(),
                rawData
            };
        }
    }).mount('#app');
</script>

</body>
</html>