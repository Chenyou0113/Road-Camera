<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ºç£å³æ™‚ç©ºå“æˆ°æƒ…å®¤</title>
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === é é¢æ¨™é¡Œ === */
        .page-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .page-header h1 {
            font-size: 2.5em;
            color: #1a73e8;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .page-header .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        /* === çµ±è¨ˆåˆ— === */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            border-top: 4px solid #1a73e8;
        }

        .stat-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .stat-item .label {
            font-size: 0.9em;
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-item .value {
            font-size: 2.5em;
            font-weight: 800;
            color: #1a73e8;
        }

        .stat-item.worst .value {
            color: #d32f2f;
        }

        .stat-item.avg .value {
            color: #f57c00;
        }

        /* === æ§åˆ¶åˆ— === */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .controls input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        /* åœ–ä¾‹ */
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }

        .legend-dot.good { background: #009966; }
        .legend-dot.moderate { background: #ffde33; }
        .legend-dot.unhealthy-sensitive { background: #ff9933; }
        .legend-dot.unhealthy { background: #cc0033; }
        .legend-dot.very-unhealthy { background: #660099; }
        .legend-dot.hazardous { background: #7e0023; }

        /* === å…§å®¹å€ === */
        #air-dashboard {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 20px;
            height: 75vh;
            margin-bottom: 20px;
        }

        #air-map {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background: white;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        /* åœ°åœ–åŠ è¼‰ç‹€æ…‹ */
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
        }

        .map-loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === å¡ç‰‡åˆ—è¡¨ === */
        .air-list-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .air-list-container .list-header {
            font-size: 0.95em;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 12px;
        }

        #air-grid {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .air-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 12px;
            border-left: 5px solid #ccc;
            position: relative;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            border-left-width: 5px;
        }

        .air-card:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            background: #fff;
        }

        .air-card .card-name {
            font-weight: 700;
            font-size: 1em;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .air-card .county {
            font-size: 0.75em;
            color: #999;
            font-weight: normal;
        }

        .air-card .aqi-display {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 6px;
        }

        .air-card .aqi-val {
            font-size: 2em;
            font-weight: 800;
        }

        .air-card .status-badge {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 4px;
            background: #f0f0f0;
            color: #666;
            font-weight: 600;
        }

        .air-card .detail-item {
            font-size: 0.85em;
            color: #777;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }

        .air-card .detail-label {
            color: #999;
        }

        .air-card .detail-value {
            font-weight: 600;
            color: #333;
        }

        /* === ç©ºç‹€æ…‹ === */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        .empty-state .icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #ccc;
        }

        .empty-state p {
            margin: 5px 0;
        }

        /* === éŒ¯èª¤è¨Šæ¯ === */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #c62828;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .error-message .icon {
            font-size: 1.5em;
        }

        /* === éŸ¿æ‡‰å¼è¨­è¨ˆ === */
        @media (max-width: 1024px) {
            #air-dashboard {
                grid-template-columns: 1fr;
                height: auto;
                gap: 20px;
            }

            #air-map {
                height: 400px;
            }

            .air-list-container {
                max-height: 400px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls input {
                min-width: 100%;
            }

            .legend {
                justify-content: center;
            }

            .page-header h1 {
                font-size: 2em;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .page-header h1 {
                font-size: 1.5em;
                gap: 8px;
            }

            .stat-item {
                padding: 15px;
            }

            .stat-item .value {
                font-size: 2em;
            }

            #air-map {
                height: 300px;
            }

            .air-list-container {
                max-height: 300px;
            }

            .air-card .aqi-val {
                font-size: 1.5em;
            }
        }

        /* === æ²è»¸ç¾åŒ– === */
        #air-grid::-webkit-scrollbar {
            width: 6px;
        }

        #air-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #air-grid::-webkit-scrollbar-thumb {
            background: #1a73e8;
            border-radius: 10px;
        }

        #air-grid::-webkit-scrollbar-thumb:hover {
            background: #1557b0;
        }

        /* Leaflet è‡ªè¨‚æ¨£å¼ */
        .leaflet-control-attribution {
            font-size: 0.75em;
        }

        /* --- ç¯©é¸é¸å–®æ¨£å¼ --- */
        select#city-filter {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
            outline: none;
            min-width: 150px;
            transition: all 0.3s ease;
        }

        select#city-filter:hover {
            border-color: #1a73e8;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.2);
        }

        /* --- ç‡ˆç®± (Modal) æ¨£å¼ --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            animation: slideUp 0.3s ease-out;
        }

        .close-btn {
            position: absolute;
            top: 15px; right: 15px;
            background: none; border: none;
            font-size: 1.8rem; cursor: pointer;
            color: #666;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #000;
        }

        /* Modal å…§éƒ¨æ’ç‰ˆ */
        .modal-header { margin-bottom: 20px; text-align: center; }
        .modal-header h2 { margin: 0; font-size: 1.8rem; color: #333; }
        .badge { background: #eee; padding: 4px 10px; border-radius: 6px; font-size: 0.9rem; color: #666; margin-left: 10px; }

        .modal-body {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        /* AQI å¤§åœ“åœˆ */
        .aqi-circle-box { flex: 0 0 120px; text-align: center; }
        .aqi-circle {
            width: 110px; height: 110px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin: 0 auto;
        }
        #m-aqi { font-size: 2.8rem; line-height: 1; }
        #m-status { font-size: 0.85rem; opacity: 0.9; margin-top: 5px; }

        /* æ•¸æ“šåˆ—è¡¨ */
        .data-grid { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .data-item { border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .data-item label { display: block; font-size: 0.85rem; color: #888; font-weight: 600; margin-bottom: 5px; }
        .data-item span { font-size: 1.3rem; font-weight: bold; color: #333; }
        .data-item small { color: #999; }

        /* æŒ‰éˆ• */
        .modal-footer { text-align: center; }
        .action-btn {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .action-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
        }

        /* å‹•ç•« */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
        @media (max-width: 600px) {
            .modal-body { flex-direction: column; text-align: center; }
            .data-grid { width: 100%; }
            .aqi-circle-box { flex: 0 0 auto; }
            .data-item { display: flex; justify-content: space-between; align-items: center; border-bottom: none; border-top: 1px solid #eee; padding-top: 10px; padding-bottom: 10px; }
            .data-item label { margin: 0; }
        }

        /* =========================================
           ğŸŒ™ æ·±è‰²æ¨¡å¼æ¨£å¼ (Dark Mode)
           ========================================= */

        /* 1. åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .theme-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 1.2rem;
            transition: transform 0.3s;
        }
        .theme-btn:hover { transform: rotate(15deg) scale(1.1); }

        /* =========================================
           ğŸŒ™ æ·±è‰²æ¨¡å¼æ¨£å¼ (Dark Mode ä¿®å¾©ç‰ˆ)
           ========================================= */

        /* 1. å…¨å±€èƒŒæ™¯è®Šé»‘ */
        body.dark-mode {
            background: #121212;
            color: #e0e0e0;
        }

        /* 2. å¡ç‰‡èˆ‡å€å¡Šé»‘åŒ– */
        body.dark-mode .page-header,
        body.dark-mode .stat-item,
        body.dark-mode .controls,
        body.dark-mode .air-list-container,
        body.dark-mode #air-map,
        body.dark-mode .modal-content {
            background: #1e1e1e;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        /* 3. æ–‡å­—é¡è‰²èª¿æ•´ (ç¢ºä¿äº®è‰²) */
        body.dark-mode .page-header h1 { color: #90caf9; }
        body.dark-mode .subtitle { color: #b0bec5; }
        body.dark-mode .list-header { color: #b0bec5; border-bottom: 1px solid #333; }
        
        /* çµ±è¨ˆå¡ç‰‡ */
        body.dark-mode .stat-item .label { color: #cfd8dc; }
        body.dark-mode .stat-item .value { color: #90caf9; } /* é è¨­äº®è— */

        /* 4. è¼¸å…¥æ¡†èˆ‡é¸å–® */
        body.dark-mode input,
        body.dark-mode select {
            background: #2c2c2c;
            border: 1px solid #444;
            color: #fff;
        }

        /* 5. åˆ—è¡¨å¡ç‰‡é»‘åŒ– (é‡é»ä¿®å¾©) */
        body.dark-mode .air-card {
            background: #2c2c2c;
            border: 1px solid #444;
        }
        body.dark-mode .air-card:hover {
            background: #383838;
        }
        
        /* å¡ç‰‡å…§æ–‡å­— */
        body.dark-mode .air-card .card-name { color: #fff; }
        body.dark-mode .air-card .county { color: #b0bec5; }
        
        /* è©³ç´°æ•¸æ“šæ¨™ç±¤è®Šäº® */
        body.dark-mode .air-card .detail-label { color: #bdbdbd !important; }
        body.dark-mode .air-card .detail-value { color: #ffffff !important; font-weight: 700; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        body.dark-mode .air-card .status-badge {
            background: #424242;
            color: #fff;
            border: 1px solid #666;
        }

        /* 6. ç‡ˆç®± (Modal) ä¿®å¾© */
        body.dark-mode .modal-header h2 { color: #fff; }
        body.dark-mode .close-btn { color: #fff; }
        body.dark-mode .badge { background: #424242; color: #fff; border: 1px solid #666; }
        
        body.dark-mode .data-item { border-bottom-color: #444; }
        body.dark-mode .data-item label { color: #bbb; }
        body.dark-mode .data-item span { color: #fff; }
        body.dark-mode .data-item small { color: #888; }

        /* 7. åœ°åœ–é»‘åŒ– */
        body.dark-mode .leaflet-tile-pane {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        body.dark-mode .leaflet-popup-content-wrapper,
        body.dark-mode .leaflet-popup-tip {
            background: #1e1e1e;
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- æ·±è‰²æ¨¡å¼åˆ‡æ›æŒ‰éˆ• (æ‡¸æµ®åœ¨å³ä¸Šè§’) -->
    <button id="theme-toggle" class="theme-btn" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
    </button>

    <div class="container">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="page-header">
            <h1>
                <i class="fas fa-wind"></i>
                è‡ºç£å³æ™‚ç©ºå“æˆ°æƒ…å®¤
            </h1>
            <p class="subtitle">ä¸€è¦½å…¨å°80+åœ‹å®¶ç´šæ¸¬ç«™çš„å¯¦æ™‚ç©ºæ°£å“è³ªæŒ‡æ•¸</p>
        </div>

        <!-- çµ±è¨ˆåˆ— -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="label">ğŸ“Š å…¨å°æ¸¬ç«™</span>
                <span class="value" id="total-stations">-</span>
            </div>
            <div class="stat-item avg">
                <span class="label">ğŸŒ¡ï¸ å¹³å‡ AQI</span>
                <span class="value" id="avg-aqi">-</span>
            </div>
            <div class="stat-item worst">
                <span class="label">ğŸ’¨ ç©ºæ°£æœ€å·®</span>
                <span class="value" id="worst-station">-</span>
            </div>
            <div class="stat-item">
                <span class="label">âœ… è‰¯å¥½æ¸¬ç«™</span>
                <span class="value" id="good-count">-</span>
            </div>
        </div>

        <!-- æ§åˆ¶åˆ— -->
        <div class="controls">
            <input 
                type="text" 
                id="search-input" 
                placeholder="ğŸ” æœå°‹æ¸¬ç«™åç¨± (ä¾‹å¦‚: æ¿æ©‹ã€å°ä¸­ã€é«˜é›„)..."
            >
            <!-- âœ¨ æ–°å¢ï¼šç¸£å¸‚ç¯©é¸é¸å–® -->
            <select id="city-filter">
                <option value="">ğŸ“ æ‰€æœ‰ç¸£å¸‚</option>
                <!-- é¸é …æœƒç”± JS è‡ªå‹•ç”¢ç”Ÿ -->
            </select>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot good"></div>
                    <span>è‰¯å¥½</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot moderate"></div>
                    <span>æ™®é€š</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot unhealthy-sensitive"></div>
                    <span>æ•æ„Ÿæ—ç¾¤</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot unhealthy"></div>
                    <span>ä¸å¥åº·</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot very-unhealthy"></div>
                    <span>éå¸¸ä¸å¥åº·</span>
                </div>
            </div>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯å€ -->
        <div id="error-container" style="display: none;">
            <div class="error-message">
                <span class="icon"><i class="fas fa-exclamation-circle"></i></span>
                <span id="error-text">ç„¡æ³•è¼‰å…¥ç©ºå“è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢</span>
            </div>
        </div>

        <!-- å…§å®¹å€ -->
        <div id="air-dashboard">
            <!-- åœ°åœ– -->
            <div id="air-map">
                <div class="map-loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨è¼‰å…¥åœ°åœ–...</p>
                </div>
            </div>

            <!-- å¡ç‰‡åˆ—è¡¨ -->
            <div class="air-list-container">
                <div class="list-header">ç©ºå“æ¸¬ç«™åˆ—è¡¨</div>
                <div id="air-grid"></div>
            </div>
        </div>
    </div>

    <!-- Google Analytics (å¯é¸) -->
    <script>
        // === AQI å·¥å…·å‡½æ•¸ ===
        function getAQIColor(aqi) {
            if (aqi <= 50) return { code: '#009966', name: 'è‰¯å¥½' };
            if (aqi <= 100) return { code: '#ffde33', name: 'æ™®é€š' };
            if (aqi <= 150) return { code: '#ff9933', name: 'å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·' };
            if (aqi <= 200) return { code: '#cc0033', name: 'å°æ‰€æœ‰æ—ç¾¤ä¸å¥åº·' };
            if (aqi <= 300) return { code: '#660099', name: 'éå¸¸ä¸å¥åº·' };
            return { code: '#7e0023', name: 'å±å®³' };
        }

        function getAQIShortName(aqi) {
            if (aqi <= 50) return 'è‰¯å¥½';
            if (aqi <= 100) return 'æ™®é€š';
            if (aqi <= 150) return 'æ•æ„Ÿæ—ç¾¤';
            if (aqi <= 200) return 'ä¸å¥åº·';
            if (aqi <= 300) return 'éå¸¸ä¸å¥åº·';
            return 'å±å®³';
        }

        // === å…¨å±€è®Šæ•¸ ===
        let allStations = [];
        let map = null;
        let markers = [];
        let mapInitialized = false;

        // === åˆå§‹åŒ– ===
        async function initAirPage() {
            try {
                // åˆå§‹åŒ–åœ°åœ–
                initMap();

                // æŠ“å–è³‡æ–™
                const stations = await fetchAirQualityData();
                allStations = stations;

                // æ’åºï¼šç©ºæ°£æœ€å·®æ’æœ€å‰
                allStations.sort((a, b) => b.aqi - a.aqi);

                // ç”¢ç”Ÿç¸£å¸‚ç¯©é¸é¸å–®
                populateCityFilter(allStations);

                // æ¸²æŸ“ UI
                renderUI(allStations);
                updateStats(allStations);

                // ç¶å®šæœå°‹å’Œç¯©é¸
                bindSearchEvent();

                // éš±è—åœ°åœ–åŠ è¼‰ç‹€æ…‹
                document.querySelector('.map-loading').style.display = 'none';

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                showError(`ç„¡æ³•è¼‰å…¥ç©ºå“è³‡æ–™: ${error.message}`);
            }
        }

        // === åˆå§‹åŒ–åœ°åœ– ===
        function initMap() {
            if (mapInitialized) return;

            map = L.map('air-map').setView([23.6, 121.0], 7);

            // æ·»åŠ åœ°åœ–ç“¦ç‰‡
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: 'Â© OpenStreetMap, Â© CartoDB',
                maxZoom: 19
            }).addTo(map);

            mapInitialized = true;
        }

        // === æŠ“å–ç©ºå“è³‡æ–™ (D1 åŠ é€Ÿç‰ˆ) ===
        async function fetchAirQualityData() {
            try {
                // â˜… æŒ‡å‘æ–°çš„ Worker ç¶²å€
                const apiUrl = 'https://air-quality-api.xiaoyouwu5-fd3.workers.dev/'; 
                
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const stations = await response.json();
                
                if (!Array.isArray(stations)) throw new Error('è³‡æ–™æ ¼å¼ç•°å¸¸');

                // éæ¿¾æœ‰æ•ˆåº§æ¨™
                return stations.filter(s => s.lat && s.lon); 

            } catch (error) {
                console.error('ç©ºå“è³‡æ–™è¼‰å…¥å¤±æ•—:', error);
                showError('ç„¡æ³•è¼‰å…¥ç©ºå“è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦');
                return [];
            }
        }

        // === æ¸²æŸ“ UI ===
        function renderUI(stations) {
            const grid = document.getElementById('air-grid');
            grid.innerHTML = '';

            // æ¸…é™¤èˆŠæ¨™è¨˜
            markers.forEach(m => {
                if (map && map.hasLayer(m)) {
                    map.removeLayer(m);
                }
            });
            markers = [];

            if (stations.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ”</div>
                        <p>æ‰¾ä¸åˆ°ç¬¦åˆçš„æ¸¬ç«™</p>
                        <p style="font-size: 0.85em; color: #ccc;">è©¦è©¦å…¶ä»–æœå°‹è©å½™</p>
                    </div>
                `;
                return;
            }

            // æ¸²æŸ“å¡ç‰‡
            stations.forEach((st, index) => {
                const color = getAQIColor(st.aqi);
                const statusName = getAQIShortName(st.aqi);

                // å»ºç«‹å¡ç‰‡
                const card = document.createElement('div');
                card.className = 'air-card';
                card.style.borderLeftColor = color.code;

                const pm25Text = st.pm25 ? `${Number(st.pm25).toFixed(1)} Î¼g/mÂ³` : '-';

                card.innerHTML = `
                    <div class="card-name">
                        <span>${st.name}</span>
                        <span class="county">${st.county}</span>
                    </div>
                    <div class="aqi-display">
                        <span class="aqi-val" style="color: ${color.code};">${st.aqi}</span>
                        <span class="status-badge">${statusName}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">PM2.5:</span>
                        <span class="detail-value">${pm25Text}</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8rem; color: #aaa; text-align: right;">
                        é»æ“ŠæŸ¥çœ‹è©³æƒ… âœ
                    </div>
                `;

                // é»æ“Šå¡ç‰‡ -> æ‰“é–‹ Modal
                card.onclick = () => openModal(st);

                grid.appendChild(card);

                // å»ºç«‹åœ°åœ–æ¨™è¨˜
                if (st.lat && st.lon && map) {
                    const marker = L.circleMarker([st.lat, st.lon], {
                        radius: 6,
                        fillColor: color.code,
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    // æ¨™è¨˜é»æ“Šä¹Ÿå¯ä»¥æ‰“é–‹ Modal
                    marker.on('click', () => openModal(st));
                    markers.push(marker);
                }
            });
        }

        // === æ›´æ–°çµ±è¨ˆ ===
        function updateStats(stations) {
            if (stations.length === 0) {
                document.getElementById('total-stations').textContent = '-';
                document.getElementById('avg-aqi').textContent = '-';
                document.getElementById('worst-station').textContent = '-';
                document.getElementById('good-count').textContent = '-';
                return;
            }

            // è¨ˆç®—çµ±è¨ˆ
            const totalAQI = stations.reduce((sum, s) => sum + s.aqi, 0);
            const avgAQI = Math.round(totalAQI / stations.length);
            const worstStation = stations[0];
            const goodCount = stations.filter(s => s.aqi <= 50).length;

            document.getElementById('total-stations').textContent = stations.length;
            document.getElementById('avg-aqi').textContent = avgAQI;
            document.getElementById('worst-station').textContent = `${worstStation.name} (${worstStation.aqi})`;
            document.getElementById('good-count').textContent = goodCount;

            // æ ¹æ“šå¹³å‡å€¼è‘—è‰²
            const avgColor = getAQIColor(avgAQI);
            document.getElementById('avg-aqi').style.color = avgColor.code;

            // æ ¹æ“šæœ€å·®å€¼è‘—è‰²
            const worstColor = getAQIColor(worstStation.aqi);
            document.getElementById('worst-station').style.color = worstColor.code;
        }

        // === ç¶å®šæœå°‹å’Œç¯©é¸äº‹ä»¶ ===
        function bindSearchEvent() {
            const searchInput = document.getElementById('search-input');
            const cityFilter = document.getElementById('city-filter');

            // çµ±ä¸€çš„ç¯©é¸å‡½å¼
            const handleFilter = () => {
                const term = searchInput.value.toLowerCase();
                const city = cityFilter.value;

                const filtered = allStations.filter(s => {
                    const matchName = s.name.toLowerCase().includes(term) || s.county.toLowerCase().includes(term);
                    const matchCity = city === "" || s.county === city;
                    return matchName && matchCity;
                });
                
                renderUI(filtered);
                updateStats(filtered);
            };

            searchInput.addEventListener('input', handleFilter);
            cityFilter.addEventListener('change', handleFilter);
        }

        // âœ¨ è‡ªå‹•ç”¢ç”Ÿç¸£å¸‚é¸é …
        function populateCityFilter(stations) {
            // å–å‡ºæ‰€æœ‰ç¸£å¸‚ä¸¦å»é‡ (Unique)
            const counties = [...new Set(stations.map(s => s.county))];
            
            // æŒ‰ç­†ç•«æ’åº
            counties.sort((a, b) => a.localeCompare(b, 'zh-Hant')); 

            const select = document.getElementById('city-filter');
            counties.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                select.appendChild(option);
            });
        }

        // âœ¨ å…¨åŸŸè®Šæ•¸ï¼šç´€éŒ„ç›®å‰æ‰“é–‹è©³ç´°è³‡æ–™çš„æ¸¬ç«™
        let currentStation = null;

        // âœ¨ æ‰“é–‹è©³ç´°è³‡æ–™ç‡ˆç®±
        // âœ¨ æ‰“é–‹è©³ç´°è³‡æ–™ç‡ˆç®± (å®Œæ•´ç‰ˆ)
        function openModal(st) {
            currentStation = st;
            const colorInfo = getAQIColor(st.aqi);
            
            // 1. åŸºæœ¬è³‡è¨Š
            document.getElementById('m-name').textContent = st.name;
            document.getElementById('m-county').textContent = st.county;
            
            // 2. AQI å¤§åœ“åœˆ
            document.getElementById('m-aqi').textContent = st.aqi;
            document.getElementById('m-status').textContent = st.status || getAQIShortName(st.aqi);
            
            const circle = document.getElementById('m-aqi-bg');
            circle.style.background = colorInfo.code;
            circle.style.color = (st.aqi > 50 && st.aqi <= 100) ? '#333' : '#fff';

            // 3. è©³ç´°æ•¸æ“šåˆ—è¡¨ (å‹•æ…‹ç”Ÿæˆ HTML)
            const grid = document.querySelector('.data-grid');
            
            // å®šç¾©è¦é¡¯ç¤ºçš„æ¬„ä½èˆ‡å–®ä½
            const fields = [
                { label: 'ä¸»è¦æ±¡æŸ“ç‰©', value: st.pollutant || 'ç„¡', unit: '' },
                { label: 'PM 2.5', value: st.pm25, unit: 'Î¼g/mÂ³' },
                { label: 'PM 2.5 (å¹³å‡)', value: st.pm25_avg, unit: 'Î¼g/mÂ³' },
                { label: 'PM 10', value: st.pm10, unit: 'Î¼g/mÂ³' },
                { label: 'PM 10 (å¹³å‡)', value: st.pm10_avg, unit: 'Î¼g/mÂ³' },
                { label: 'O3 (è‡­æ°§)', value: st.o3, unit: 'ppb' },
                { label: 'O3 (8å°æ™‚)', value: st.o3_8hr, unit: 'ppb' },
                { label: 'CO (ä¸€æ°§åŒ–ç¢³)', value: st.co, unit: 'ppm' },
                { label: 'CO (8å°æ™‚)', value: st.co_8hr, unit: 'ppm' },
                { label: 'SO2 (äºŒæ°§åŒ–ç¡«)', value: st.so2, unit: 'ppb' },
                { label: 'SO2 (å¹³å‡)', value: st.so2_avg, unit: 'ppb' },
                { label: 'NO2 (äºŒæ°§åŒ–æ°®)', value: st.no2, unit: 'ppb' },
                { label: 'NOx (æ°®æ°§åŒ–ç‰©)', value: st.nox, unit: 'ppb' },
                { label: 'NO (ä¸€æ°§åŒ–æ°®)', value: st.no, unit: 'ppb' },
                { label: 'é¢¨é€Ÿ', value: st.wind_speed, unit: 'm/s' },
                { label: 'é¢¨å‘', value: st.wind_direc, unit: 'deg' },
                { label: 'ç™¼å¸ƒæ™‚é–“', value: st.publishtime, unit: '', fullWidth: true },
            ];

            // ç”Ÿæˆ HTML
            let html = '';
            fields.forEach(f => {
                const val = (f.value === undefined || f.value === null || f.value === '') ? '-' : f.value;
                const style = f.fullWidth ? 'grid-column: 1 / -1;' : '';
                
                html += `
                    <div class="data-item" style="${style}">
                        <label>${f.label}</label>
                        <span>${val}</span> <small>${f.unit}</small>
                    </div>
                `;
            });

            grid.innerHTML = html;

            // é¡¯ç¤º Modal
            document.getElementById('detail-modal').style.display = 'flex';
        }

        // âœ¨ é—œé–‰ç‡ˆç®±
        function closeModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }

        // âœ¨ åœ¨åœ°åœ–ä¸Šå®šä½ (Modal è£¡é¢çš„æŒ‰éˆ•åŠŸèƒ½)
        function locateOnMap() {
            if (currentStation && map) {
                closeModal();
                map.flyTo([currentStation.lat, currentStation.lon], 14, {
                    animate: true,
                    duration: 1.5
                });
                document.getElementById('air-map').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // é»æ“ŠèƒŒæ™¯ä¹Ÿå¯ä»¥é—œé–‰ Modal
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('detail-modal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target.id === 'detail-modal') closeModal();
                });
            }
        });
        // === é¡¯ç¤ºéŒ¯èª¤ ===
        function showError(message) {
            const container = document.getElementById('error-container');
            const textEl = document.getElementById('error-text');
            textEl.textContent = message;
            container.style.display = 'block';
        }

        // === å•Ÿå‹• ===
        document.addEventListener('DOMContentLoaded', initAirPage);

        // è‡ªå‹•æ¯ 10 åˆ†é˜åˆ·æ–°ä¸€æ¬¡è³‡æ–™
        setInterval(() => {
            console.log('è‡ªå‹•åˆ·æ–°ç©ºå“è³‡æ–™...');
            initAirPage();
        }, 600000);

        // å…¨å±€éŒ¯èª¤è™•ç†
        window.addEventListener('error', (e) => {
            console.error('å…¨å±€éŒ¯èª¤:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', e.reason);
        });
    </script>

    <!-- âœ¨ æ–°å¢ï¼šè©³ç´°è³‡æ–™ç‡ˆç®± (Modal) -->
    <div id="detail-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">Ã—</button>
            <div id="modal-header" class="modal-header">
                <h2 id="m-name">æ¸¬ç«™åç¨±</h2>
                <span id="m-county" class="badge">ç¸£å¸‚</span>
            </div>
            
            <div class="modal-body">
                <!-- å·¦å´å¤§åœ“åœˆï¼šAQI -->
                <div class="aqi-circle-box">
                    <div class="aqi-circle" id="m-aqi-bg">
                        <span id="m-aqi">--</span>
                        <small id="m-status">ç‹€æ…‹</small>
                    </div>
                </div>
                
                <!-- å³å´æ•¸æ“šåˆ—è¡¨ -->
                <div class="data-grid">
                    <div class="data-item">
                        <label>PM 2.5 (ç´°æ‡¸æµ®å¾®ç²’)</label>
                        <span id="m-pm25">--</span> <small>Î¼g/mÂ³</small>
                    </div>
                    <div class="data-item">
                        <label>ç¶“ç·¯åº¦</label>
                        <span id="m-coord" style="font-size: 0.9rem;">--</span>
                    </div>
                    <div class="data-item">
                        <label>è³‡æ–™æ›´æ–°æ™‚é–“</label>
                        <span id="m-time">--</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="action-btn" onclick="locateOnMap()">ğŸ—ºï¸ åœ¨åœ°åœ–ä¸Šé¡¯ç¤º</button>
            </div>
        </div>
    </div>

    <!-- æ·±è‰²æ¨¡å¼åˆ‡æ›é‚è¼¯ -->
    <script>
        // === æ·±è‰²æ¨¡å¼åˆ‡æ›é‚è¼¯ ===
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('theme-toggle');
            const icon = btn.querySelector('i');
            
            // åˆ‡æ› class
            body.classList.toggle('dark-mode');
            
            // åˆ‡æ›åœ–ç¤ºèˆ‡ç‹€æ…‹ä¿å­˜
            if (body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark'); // è¨˜ä½ä½¿ç”¨è€…çš„é¸æ“‡
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
        }

        // === é é¢è¼‰å…¥æ™‚æª¢æŸ¥è¨­å®š ===
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const icon = document.querySelector('#theme-toggle i');
                if(icon) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
            }
        });
    </script>
</body>
</html>
