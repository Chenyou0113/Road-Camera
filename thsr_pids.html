<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THSR PIDS Ultimate Fix</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* === å…¨å±€æ­¸é›¶ === */
        * { box-sizing: border-box; }
        body, html {
            background-color: #000;
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Arial', 'Heiti TC', 'Microsoft JhengHei', sans-serif;
            overflow: hidden;
            color: #fff;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* === å…±ç”¨å€å¡Šè¨­å®š === */
        .board-section {
            flex: 1; /* ä¸Šä¸‹å„ä½” 50% */
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid #333;
        }

        /* === æ¨™é¡Œåˆ— (Header) === */
        .header {
            height: 60px; /* çœŸå¯¦çœ‹æ¿æ¯”ä¾‹ */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            font-weight: 900;
            font-size: 2.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        /* çœŸå¯¦é«˜éµé…è‰² */
        .header.north { background-color: #BE0000; color: #FFFFFF; }
        .header.south { background-color: #009900; color: #FFFFFF; }
        
        .clock { font-family: 'Consolas', monospace; letter-spacing: 0; }

        /* === è¡¨æ ¼ (Table) === */
        .table-wrap {
            flex: 1;
            padding: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* å›ºå®šå¯¬åº¦ï¼Œé˜²æ­¢è·‘ç‰ˆ */
        }
        
        thead {
            background-color: #111;
            height: 40px;
        }
        th {
            color: #ccc;
            font-weight: normal;
            font-size: 1.2rem;
            text-align: left;
            padding-left: 20px;
            border-bottom: 1px solid #444;
        }

        /* === å…§å®¹åˆ— (Rows) === */
        tr.data-row {
            height: 18vh; /* è®“4è¡Œå¡«æ»¿ç•«é¢ */
            border-bottom: 1px solid #222;
        }

        td {
            padding-left: 20px;
            vertical-align: middle;
            font-weight: bold;
            font-size: 2.2rem; /* å¤§å­—é«” */
            white-space: nowrap;
        }

        /* === æ¬„ä½å¯¬åº¦èˆ‡å­—å‹ === */
        .col-train  { width: 10%; font-family: 'Consolas', monospace; }
        .col-dest   { width: 12%; font-size: 2.5rem; letter-spacing: 5px; } /* ç›®çš„åœ°ç‰¹å¤§ */
        .col-time   { width: 12%; font-family: 'Consolas', monospace; }
        .col-plat   { width: 8%;  text-align: center; font-family: 'Consolas', monospace; }
        .col-free   { width: 18%; font-size: 1.8rem; }
        .col-status { width: 12%; }
        .col-map    { width: 28%; }

        /* === é…è‰²é‚è¼¯ (é—œéµä¿®æ­£) === */
        /* åŒ—ä¸Šï¼šå­—é«”ç‚ºç¥ç€é»ƒ */
        .north-style .dynamic-text { color: #FFCC00; }
        .north-style .station-dot.active { background-color: #FFCC00; box-shadow: 0 0 10px #FFCC00; }
        
        /* å—ä¸‹ï¼šå­—é«”ç‚ºäº®ç¶  */
        .south-style .dynamic-text { color: #00FF00; }
        .south-style .station-dot.active { background-color: #00FF00; box-shadow: 0 0 10px #00FF00; }

        .text-white { color: #ffffff; }
        .status-ok { color: #FFFF00; } /* æº–é»çµ±ä¸€é»ƒè‰² */
        .status-delay { color: #FF0000; animation: blink 1s infinite; }

        /* === åœé ç«™åœ°åœ– (Station Map) === */
        .map-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            padding-right: 30px;
            height: 100%;
        }
        .map-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 30px;
            height: 4px;
            background-color: #444;
            z-index: 0;
            transform: translateY(-50%);
        }
        .dot-group {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .station-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: #000;
            border: 2px solid #555;
            margin-bottom: 5px;
        }
        /* åœé æ™‚çš„äº®ç‡ˆæ¨£å¼ */
        .station-dot.active {
            border-color: #fff;
        }
        .station-code {
            font-family: 'Consolas', sans-serif;
            font-size: 0.9rem;
            color: #666;
        }
        .station-dot.active + .station-code { color: #fff; font-weight: bold; }

        @keyframes blink { 50% { opacity: 0; } }

        /* === è·‘é¦¬ç‡ˆ === */
        .marquee {
            height: 40px;
            background-color: #000;
            color: #FF0000; /* è­¦ç¤ºç´… */
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            border-top: 1px solid #333;
            overflow: hidden;
            white-space: nowrap;
        }
        .marquee-content {
            padding-left: 100%;
            animation: scroll 20s linear infinite;
        }
        @keyframes scroll { 100% { transform: translateX(-100%); } }
    </style>
</head>
<body>

<div id="app">
    
    <div class="board-section">
        <div class="header north">
            <div>åŒ—ä¸Š NORTHBOUND</div>
            <div class="clock">{{ currentTime }}</div>
        </div>
        <div class="table-wrap">
            <table class="north-style">
                <thead>
                    <tr>
                        <th class="col-train">è»Šæ¬¡ Train</th>
                        <th class="col-dest">é–‹å¾€ Dest.</th>
                        <th class="col-time">æ™‚é–“ Time</th>
                        <th class="col-plat">æœˆå° Plat.</th>
                        <th class="col-free">è‡ªç”±åº§ Non-Reserved</th>
                        <th class="col-status">ç‹€æ…‹ Status</th>
                        <th class="col-map">åœé ç«™ Stopping Stations</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="t in northboundList" :key="t.uid" class="data-row">
                        <td class="col-train text-white">{{ t.displayTrainNo }}</td>
                        <td class="col-dest dynamic-text">{{ t.destinationName }}</td>
                        <td class="col-time text-white">{{ t.displayTime }}</td>
                        <td class="col-plat text-white">{{ t.platform }}</td>
                        <td class="col-free text-white">Car {{ t.freeCars }}</td>
                        <td class="col-status status-ok">æº–é» On Time</td>
                        <td class="col-map">
                            <div class="map-container">
                                <div class="map-line"></div>
                                <div v-for="s in stationsReversed" :key="s.id" class="dot-group">
                                    <div class="station-dot" :class="{ 'active': t.stops.includes(s.id) }"></div>
                                    <span class="station-code">{{ s.code }}</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="board-section">
        <div class="header south">
            <div>å—ä¸‹ SOUTHBOUND</div>
            <div class="clock">{{ currentStationName }} {{ currentStationCode }}</div>
        </div>
        <div class="table-wrap">
            <table class="south-style">
                <thead>
                    <tr>
                        <th class="col-train">è»Šæ¬¡ Train</th>
                        <th class="col-dest">é–‹å¾€ Dest.</th>
                        <th class="col-time">æ™‚é–“ Time</th>
                        <th class="col-plat">æœˆå° Plat.</th>
                        <th class="col-free">è‡ªç”±åº§ Non-Reserved</th>
                        <th class="col-status">ç‹€æ…‹ Status</th>
                        <th class="col-map">åœé ç«™ Stopping Stations</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="t in southboundList" :key="t.uid" class="data-row">
                        <td class="col-train text-white">{{ t.displayTrainNo }}</td>
                        <td class="col-dest dynamic-text">{{ t.destinationName }}</td>
                        <td class="col-time text-white">{{ t.displayTime }}</td>
                        <td class="col-plat text-white">{{ t.platform }}</td>
                        <td class="col-free text-white">Car {{ t.freeCars }}</td>
                        <td class="col-status status-ok">æº–é» On Time</td>
                        <td class="col-map">
                            <div class="map-container">
                                <div class="map-line"></div>
                                <div v-for="s in stationsNormal" :key="s.id" class="dot-group">
                                    <div class="station-dot" :class="{ 'active': t.stops.includes(s.id) }"></div>
                                    <span class="station-code">{{ s.code }}</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="marquee">
        <div class="marquee-content">
            {{ marqueeText }}
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // è«‹ç¢ºèªæ­¤ API ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œè‹¥æœ‰ CORS å•é¡Œè«‹ç¢ºèª Worker è¨­å®š
            const API_URL = "https://thsr-proxy.xiaoyouwu5-fd3.workers.dev";
            
            const urlParams = new URLSearchParams(window.location.search);
            // é è¨­å°åŒ— (1000)
            const stationID = ref(urlParams.get('station') || "1000"); 

            const rawTrains = ref([]);
            const currentTime = ref("00:00:00");

            // ç«™é»å°ç…§è¡¨ (ID -> Name/Code)
            const stations = [
                { id: "0990", name: "å—æ¸¯", code: "NAK" },
                { id: "1000", name: "å°åŒ—", code: "TPE" },
                { id: "1010", name: "æ¿æ©‹", code: "BAC" },
                { id: "1020", name: "æ¡ƒåœ’", code: "TAY" },
                { id: "1030", name: "æ–°ç«¹", code: "HSC" },
                { id: "1035", name: "è‹—æ —", code: "MIL" },
                { id: "1040", name: "å°ä¸­", code: "TAC" },
                { id: "1043", name: "å½°åŒ–", code: "CHA" },
                { id: "1047", name: "é›²æ—", code: "YUL" },
                { id: "1050", name: "å˜‰ç¾©", code: "CHY" },
                { id: "1060", name: "å°å—", code: "TNN" },
                { id: "1070", name: "å·¦ç‡Ÿ", code: "ZUY" }
            ];

            // å–å¾—ç•¶å‰ç«™é»è³‡è¨Š
            const currentStationObj = computed(() => stations.find(s => s.id === stationID.value) || stations[1]);
            const currentStationName = computed(() => currentStationObj.value.name);
            const currentStationCode = computed(() => currentStationObj.value.code);

            // åœ°åœ–æ’åº
            const stationsNormal = stations; 
            const stationsReversed = [...stations].reverse();

            // === æ ¸å¿ƒåŠŸèƒ½ï¼šè³‡æ–™æ­£è¦åŒ– (è§£æ±º UNK èˆ‡ æ–¹å‘æ··äº‚) ===
            const processedTrains = computed(() => {
                const now = new Date();
                const nowStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');

                return rawTrains.value.map((t, index) => {
                    // 1. æš´åŠ›è§£æ±º UNKï¼šå˜—è©¦æ‰€æœ‰å¯èƒ½çš„æ¬„ä½åç¨±
                    let tNo = t.TrainNo || t.train_no || t.trainNo || (t.DailyTrainInfo ? t.DailyTrainInfo.TrainNo : "???");
                    
                    // 2. æš´åŠ›è§£æ±ºæ™‚é–“
                    let tTime = t.departure_time || t.DepartureTime || t.time || "00:00";
                    if(tTime.length > 5) tTime = tTime.substring(0, 5); // æˆªæ‰ç§’æ•¸

                    // 3. æš´åŠ›è§£æ±ºç›®çš„åœ°åç¨±
                    let destName = "æœªçŸ¥";
                    if (t.destination && t.destination.zh) destName = t.destination.zh;
                    else if (t.DestinationStationName) destName = t.DestinationStationName.Zh_tw;
                    else if (t.EndingStationName) destName = t.EndingStationName.Zh_tw;

                    // 4. è§£æ±ºåœé ç«™ (å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé è¨­å…¨åœï¼Œé¿å…å ±éŒ¯)
                    let stops = t.stopping_stations || [];

                    // 5. è§£æ±ºè‡ªç”±åº§ (é è¨­ 10-12)
                    let free = t.free_seating_cars || "10-12";

                    // 6. è§£æ±ºæœˆå° (å¦‚æœæ²’æœ‰ï¼Œé¡¯ç¤º -)
                    let plat = t.platform || t.Platform || "2";

                    // 7. ğŸ”¥ é—œéµï¼šå¼·åˆ¶è½‰å‹ Directionï¼Œç¢ºä¿ 0/1 åˆ¤æ–·æ­£ç¢º ğŸ”¥
                    let dir = -1;
                    if (t.direction !== undefined) dir = parseInt(t.direction);
                    else if (t.Direction !== undefined) dir = parseInt(t.Direction);

                    return {
                        uid: tNo + index, // å”¯ä¸€éµå€¼
                        displayTrainNo: tNo,
                        displayTime: tTime,
                        destinationName: destName,
                        stops: stops,
                        freeCars: free,
                        platform: plat,
                        direction: dir // é€™è£¡ä¸€å®šæ˜¯æ•¸å­— 0 æˆ– 1
                    };
                })
                .filter(t => t.displayTime >= nowStr) // åªé¡¯ç¤ºæœªä¾†çš„è»Š
                .sort((a, b) => a.displayTime.localeCompare(b.displayTime)); // æŒ‰æ™‚é–“æ’åº
            });

            // === åˆ†æµé‚è¼¯ ===
            // å—ä¸‹ = 0 (å‰å¾€å·¦ç‡Ÿ)
            const southboundList = computed(() => {
                return processedTrains.value
                    .filter(t => t.direction === 0)
                    .slice(0, 4);
            });

            // åŒ—ä¸Š = 1 (å‰å¾€å—æ¸¯)
            const northboundList = computed(() => {
                return processedTrains.value
                    .filter(t => t.direction === 1)
                    .slice(0, 4);
            });

            const marqueeText = computed(() => {
                return `æœ¬ç³»çµ±åƒ…ä¾›æ¸¬è©¦åƒè€ƒ (Simulated Data) - Current Station: ${currentStationName.value} (${stationID.value})`;
            });

            const fetchData = async () => {
                try {
                    const res = await fetch(`${API_URL}/?station=${stationID.value}`);
                    if(!res.ok) throw new Error("API Error");
                    const json = await res.json();
                    
                    // å…¼å®¹å…©ç¨®å¯èƒ½çš„ API å›å‚³çµæ§‹ï¼šç›´æ¥é™£åˆ— æˆ– åŒ…åœ¨ trains è£¡
                    if (Array.isArray(json)) {
                        rawTrains.value = json;
                    } else if (json.trains) {
                        rawTrains.value = json.trains;
                    } else {
                        console.error("Unknown Data Structure", json);
                    }
                } catch (e) {
                    console.error("Fetch Error:", e);
                }
            };

            // æ™‚é˜
            setInterval(() => {
                const now = new Date();
                currentTime.value = now.toLocaleTimeString('en-US', { hour12: false });
            }, 1000);

            // æ¯ 30 ç§’æ›´æ–°è³‡æ–™
            setInterval(fetchData, 30000);

            onMounted(() => {
                fetchData();
                const now = new Date();
                currentTime.value = now.toLocaleTimeString('en-US', { hour12: false });
            });

            return {
                stationID, currentStationName, currentStationCode, currentTime,
                northboundList, southboundList,
                stationsNormal, stationsReversed, marqueeText
            };
        }
    }).mount('#app');
</script>

</body>
</html>