<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro PIDS - TPASS 2.0 Edition</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&family=Roboto:wght@700;900&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --theme-color: #8246af; } /* 預設為桃園捷運紫色 */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
        body { background-color: #000; height: 100vh; width: 100vw; display: flex; overflow: hidden; }
        
        .pids-wrapper { display: grid; grid-template-columns: 24% 76%; grid-template-rows: 90% 10%; width: 100%; height: 100%; background-color: #f0f0f0; }
        
        /* 側邊欄 */
        .sidebar { display: flex; flex-direction: column; border-right: 2px solid #ccc; background-color: #fff; height: 100%; overflow: hidden; }
        
        .station-header { height: 10%; min-height: 60px; background-color: var(--theme-color); color: white; display: flex; align-items: center; padding: 0 15px; gap: 12px; }
        .st-badge { background: #fff; color: var(--theme-color); font-weight: 900; padding: 4px 10px; border-radius: 6px; font-size: 1.4vw; }
        .st-name-zh { font-size: 1.8vw; font-weight: 900; }

        .arrival-info { flex: 1; padding: 1vh 1vw; display: flex; flex-direction: column; border-bottom: 2px solid #eee; justify-content: center; }
        .arrival-info.secondary { background-color: #fcfcfc; }
        .dir-label { font-size: 0.9vw; font-weight: 900; color: #555; margin-bottom: 2px; }
        .line-tag-row { display: flex; align-items: center; gap: 8px; }
        .line-badge-small { background: var(--theme-color); color: white; padding: 2px 8px; border-radius: 4px; font-size: 1vw; font-weight: 900; min-width: 45px; text-align: center; }
        .dest-zh { font-size: 2.2vw; font-weight: 900; color: #000; line-height: 1.2; }
        .dest-en { font-size: 0.8vw; color: #888; }
        
        .time-box { background-color: var(--theme-color); color: white; margin-top: 5px; text-align: center; font-size: 3.5vw; font-weight: 700; border-radius: 8px; padding: 0.5vh 0; font-family: 'Roboto', sans-serif; width: 95%; align-self: center; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .time-box.arriving { background-color: #d32f2f; animation: pulse 1s infinite; }
        .time-box.approaching { background-color: #f58220; }

        /* 氣象 */
        .weather-box { 
            height: 18%; 
            background: #fff; 
            border-top: 2px solid #ccc; 
            display: grid;
            grid-template-columns: 1fr 2.5fr;
            grid-template-rows: 1fr 1fr;
            align-items: stretch;
        }
        .w-icon-area { grid-row: 1 / span 2; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; background: #f4f7f9; border-right: 1px solid #eee; }
        .w-icon-large { font-size: 4vw; color: #607d8b; }
        .w-desc { font-size: 1.3vw; font-weight: 700; color: #555; }
        .w-top-info { display: flex; justify-content: center; align-items: center; padding: 0 1vw; border-bottom: 1px solid #eee; }
        .w-bottom-info { display: flex; justify-content: center; align-items: center; padding: 0 1vw; }
        .w-range-text { font-size: 2vw; font-weight: 900; color: #d32f2f; }
        .w-rain-text { font-size: 2vw; font-weight: 900; color: #5a9fd4; }

        /* 右側主顯示區 - 修正影片播放器 */
        .main-display { display: grid; grid-template-rows: 1fr 130px; background-color: #000; position: relative; }
        .video-container { width: 100%; height: 100%; position: relative; overflow: hidden; background: #000; }
        #video-iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: none;
            /* 讓影片盡可能填滿 */
            transform: scale(1.01); 
        }
        
        .congestion-area { background: #fff; display: flex; flex-direction: column; justify-content: center; padding: 0 30px; gap: 8px; border-top: 2px solid #ddd; }

        /* 底部 */
        .footer { grid-column: 1/3; display: grid; grid-template-columns: 24% 76%; background: #1a1a1a; color: #fff; }
        .clock-section { background: #d32f2f; display: flex; justify-content: center; align-items: center; font-size: 1.6vw; font-weight: 900; font-family: 'Roboto', sans-serif; }
        .marquee-section { overflow: hidden; display: flex; align-items: center; padding: 0 20px; }
        .marquee-text { white-space: nowrap; font-size: 1.7vw; animation: scroll 40s linear infinite; font-weight: 700; }

        @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>

    <div class="pids-wrapper">
        <div class="sidebar">
            <div class="station-header" id="ui-header">
                <div class="st-badge" id="ui-st-id">A8</div>
                <div class="st-name-zh" id="ui-st-name">長庚醫院站</div>
            </div>

            <div class="arrival-info" id="block-dir0">
                <div class="dir-label">第一月台 Platform 1</div>
                <div class="line-tag-row">
                    <div class="line-badge-small" id="ui-line-tag-1">A</div>
                    <div class="dest-zh" id="dir0-dest">台北車站</div>
                </div>
                <div class="dest-en" id="dir0-en">Taipei Main Station</div>
                <div class="time-box arriving" id="dir0-time">進站中</div>
            </div>

            <div class="arrival-info secondary" id="block-dir1">
                <div class="dir-label">第二月台 Platform 2</div>
                <div class="line-tag-row">
                    <div class="line-badge-small" id="ui-line-tag-2">A</div>
                    <div class="dest-zh" id="dir1-dest">機場第二航廈站</div>
                </div>
                <div class="dest-en" id="dir1-en">Airport Terminal 2 Station</div>
                <div class="time-box" id="dir1-time">-- : --</div>
            </div>

            <div class="weather-box">
                <div class="w-icon-area">
                    <div class="w-icon-large" id="ui-weather-icon"><i class="fas fa-cloud-sun"></i></div>
                    <div class="w-desc" id="ui-weather-text">多雲時晴</div>
                </div>
                <div class="w-top-info"><span class="w-range-text" id="ui-range-display">12°C ~ 14°C</span></div>
                <div class="w-bottom-info"><span class="w-rain-text" id="ui-rain-display"><i class="fas fa-umbrella"></i> 10%</span></div>
            </div>
        </div>

        <div class="main-display">
            <div class="video-container">
                <!-- 更新後的影片 ID：Y_siE2Wsp38 (交通部官方 TPASS 2.0 廣告) -->
                <iframe id="video-iframe" 
                    src="https://www.youtube.com/embed/Y_siE2Wsp38?autoplay=1&mute=1&loop=1&playlist=Y_siE2Wsp38&controls=0&modestbranding=1&rel=0&iv_load_policy=3&showinfo=0" 
                    allow="autoplay; encrypted-media">
                </iframe>
            </div>
            <div class="congestion-area">
                <!-- 桃捷暫不支援擁擠度，此處留白符合實況 -->
            </div>
        </div>

        <div class="footer">
            <div class="clock-section" id="clock">01/28 04:11 PM</div>
            <div class="marquee-section">
                <div class="marquee-text" id="ui-marquee">TPASS 2.0 公運常客優惠正式上線！搭越多回饋越多，最高回饋 40%！請踴躍使用電子票證搭乘大眾運輸工具...</div>
            </div>
        </div>
    </div>

    <script>
        const METRO_API = 'https://metro-api-worker.xiaoyouwu5-fd3.workers.dev/api';
        const WEATHER_API = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev';

        // 從網址讀取參數 (例如 ?system=TYMC&station=A8)
        const params = new URLSearchParams(window.location.search);
        const system = params.get('system') || 'TYMC';
        const station = params.get('station') || 'A8';

        const sysColors = { 'TRTC': '#0070bd', 'KRTC': '#f58220', 'TYMC': '#8246af', 'TMRT': '#b2d235', 'NTMC': '#0096cc' };
        let countdownSecs = { dir0: -1, dir1: -1 };

        function init() {
            // 1. 設定主題色
            document.documentElement.style.setProperty('--theme-color', sysColors[system] || '#333');
            
            // 2. 初始化畫面文字為「讀取中」
            document.getElementById('ui-st-id').innerText = station;
            document.getElementById('ui-st-name').innerText = "讀取中...";
            document.getElementById('dir0-dest').innerText = "載入中...";
            document.getElementById('dir0-en').innerText = "Loading...";
            document.getElementById('dir1-dest').innerText = "載入中...";
            document.getElementById('dir1-en').innerText = "Loading...";

            updateData();
            updateWeather();
            updateMarquee();
            setInterval(updateData, 20000);
            setInterval(updateWeather, 600000);
            setInterval(updateMarquee, 60000);
            
            // 時鐘
            setInterval(() => {
                const n = new Date();
                const d = `${String(n.getMonth()+1).padStart(2,'0')}/${String(n.getDate()).padStart(2,'0')}`;
                const t = n.toLocaleTimeString('en-US', {hour12:true, hour:'2-digit', minute:'2-digit'}).toUpperCase();
                document.getElementById('clock').innerText = `${d} ${t}`;
            }, 1000);

            // 倒數
            setInterval(() => {
                [0,1].forEach(i => {
                    if(countdownSecs[`dir${i}`] > 0) {
                        countdownSecs[`dir${i}`]--;
                        renderTime(i);
                    }
                });
            }, 1000);
        }

        async function updateData() {
            try {
                const res = await fetch(`${METRO_API}/liveboard?sys=${system}&sid=${station}`);
                const data = await res.json();
                
                // 1. 過濾出該站資料
                const sData = data.filter(t => t.StationID === station);
                
                if(sData && sData.length > 0) {
                    // 更新站名
                    if (sData[0].StationName) {
                        document.getElementById('ui-st-name').innerText = sData[0].StationName.Zh_tw;
                    }

                    // 2. 依照「方向」分組
                    // 高雄捷運通常 Direction 1 是往北(岡山)，2 是往南(小港)
                    // 找出所有不同的方向
                    const directions = [...new Set(sData.map(item => item.Direction))].sort();
                    
                    // 分配第一月台與第二月台
                    const d0_data = sData.find(t => t.Direction == directions[0]);
                    const d1_data = sData.find(t => t.Direction == directions[1]);

                    updateUI(0, d0_data);
                    updateUI(1, d1_data);
                } else {
                    // 完全沒資料時
                    updateUI(0, null);
                    updateUI(1, null);
                }
            } catch(e) { 
                console.error("API 抓取失敗:", e);
            }
        }

        function updateUI(idx, item) {
            const destZh = document.getElementById(`dir${idx}-dest`);
            const destEn = document.getElementById(`dir${idx}-en`);
            const timeBox = document.getElementById(`dir${idx}-time`);
            const lineBadge = document.getElementById(`ui-line-tag-${idx+1}`);

            if(!item) {
                destZh.innerText = "暫無列車資料";
                destEn.innerText = "No Train Service";
                timeBox.innerText = "-- : --";
                timeBox.className = "time-box";
                return;
            }

            // 更新目的地
            destZh.innerText = item.DestinationStationName.Zh_tw;
            destEn.innerText = item.DestinationStationName.En;
            
            // 更新線路顏色與文字 (高雄 R:紅線, O:橘線 / 桃園 A:機場線)
            if (system === 'KRTC') {
                lineBadge.innerText = station.startsWith('R') ? 'R' : 'O';
                lineBadge.style.background = station.startsWith('R') ? '#E3002C' : '#F28500';
            } else {
                lineBadge.innerText = item.LineID || 'A';
            }
            
            // 更新時間
            countdownSecs[`dir${idx}`] = item.EstimateTime;
            renderTime(idx);
        }

        function renderTime(idx) {
            const el = document.getElementById(`dir${idx}-time`);
            const s = countdownSecs[`dir${idx}`];
            if (s < 0) return;

            if(s <= 30) {
                el.innerText = "進站中";
                el.className = "time-box arriving";
            } else if (s <= 120) {
                const m = Math.floor(s/60);
                el.innerText = "將進站";
                el.className = "time-box approaching";
            } else {
                const m = Math.floor(s/60);
                el.innerText = `${m} : ${String(s%60).padStart(2,'0')}`;
                el.className = "time-box";
            }
        }

        async function updateWeather() {
            try {
                const res = await fetch(`${WEATHER_API}?dataset=F-C0032-001`);
                const json = await res.json();
                const county = system === 'TYMC' ? '桃園市' : '臺北市';
                const loc = json.records.location.find(l => l.locationName === county);
                if(loc) {
                    const wx = loc.weatherElement.find(e => e.elementName === 'Wx').time[0].parameter.parameterName;
                    const pop = loc.weatherElement.find(e => e.elementName === 'PoP').time[0].parameter.parameterName;
                    const minT = loc.weatherElement.find(e => e.elementName === 'MinT').time[0].parameter.parameterName;
                    const maxT = loc.weatherElement.find(e => e.elementName === 'MaxT').time[0].parameter.parameterName;
                    
                    document.getElementById('ui-weather-text').innerText = wx;
                    document.getElementById('ui-range-display').innerText = `${minT}°C ~ ${maxT}°C`;
                    document.getElementById('ui-rain-display').innerHTML = `<i class="fas fa-umbrella"></i> ${pop}%`;
                }
            } catch(e) {}
        }

        async function updateMarquee() {
            // 完整宣傳詞 (不適合跑馬燈，但保留以供未來其他用途)
            const fullTpass = "交通部公路局於114年1月起推出TPASS 2.0公共運輸常客優惠，每月搭乘公共運輸11次以上可享最高30％回饋；另為照顧搭乘國道客運返鄉遠行需求，自114年12月1日起再升級推出TPASS 2.0+公共運輸常客優惠（回饋內容說明，詳如TPASS 2.0+專屬網頁https://tpass.thb.gov.tw/），每月搭乘91條中長途國道客運路線（西部70公里以上及東部國道客運路線）2次以上可享最高30％回饋，其他公共運輸則仍依既有條件回饋金額，合先敘明。";

            // 精煉後的宣傳語 (適合跑馬燈)
            const tpassSummary = "【TPASS 2.0+ 升級】常客優惠，搭乘11次以上最高享30%回饋，國道客運遠行再享優惠。詳情請見專屬網頁。";
            
            // 系統安全提醒及環境提示
            const safetyPsas = ["遇緊急狀況請保持冷靜，使用對講機求助。", "捷運系統全面禁菸，維護公共安全與環境品質。"];

            let defaultNews = "歡迎搭乘捷運系統，請注意列車行進方向。"; 
            let finalMarquee = "";

            try {
                const res = await fetch(`${METRO_API}/news?sys=${system}`);
                const data = await res.json();
                let newsContent = "";

                if (data.Newses && data.Newses.length > 0) {
                    newsContent = data.Newses.slice(0, 3).map(n => `【最新消息】${n.Title}`).join('　　') + '　　';
                }
                
                // 組合：[新聞] + [TPASS 摘要] + [安全提醒] + [結束語]
                finalMarquee = newsContent + tpassSummary + '　　' + safetyPsas.join('　　') + '　　祝您旅途愉快！';
                
                // 如果沒有新聞，則以歡迎語開頭
                if (!newsContent) {
                    finalMarquee = defaultNews + '　　' + tpassSummary + '　　' + safetyPsas.join('　　') + '　　祝您旅途愉快！';
                }
                
                document.getElementById('ui-marquee').innerText = finalMarquee;
                
                // 由於文字變長，我們可能需要調整滾動速度
                // 計算大致滾動時間 (假設每秒 10 個字元)
                const charCount = finalMarquee.length;
                const newDuration = Math.max(25, charCount * 0.4); // 至少 25秒，每字元 0.4秒
                document.querySelector('.marquee-text').style.animationDuration = `${newDuration}s`;

            } catch (e) {
                // 連線失敗時的備用內容
                document.getElementById('ui-marquee').innerText = defaultNews + '　　' + tpassSummary + '　　' + safetyPsas.join('　　');
            }
        }

        init();
    </script>
</body>
</html>
