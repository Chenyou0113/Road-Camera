<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台鐵即時看板 - 智慧列車查詢系統 V9.4</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="assets/config.js"></script>
    <script src="assets/train-line-classification.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background: linear-gradient(135deg, #3575ff 0%, #15bbd8 100%); min-height: 100vh; padding-bottom: 80px; }
        .header { background: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header h1 { color: #D84315; text-align: center; margin-bottom: 10px; }
        .back-btn { display: inline-block; padding: 10px 20px; background: #016d68; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; transition: background 0.3s; }
        .back-btn:hover { background: #034d64; }
        .control-panel { background: linear-gradient(135deg, rgba(53, 134, 255, 0.9) 0%, rgba(21, 144, 216, 0.9) 100%); margin: 20px 0; padding: 25px; border-radius: 15px; }
        .control-panel h3 { color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .selector-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 15px; align-items: end; }
        .selector-group { display: flex; flex-direction: column; }
        .selector-group label { margin-bottom: 8px; font-weight: 600; color: white; }
        .selector-group select, .selector-group input { padding: 12px 15px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.3); background: white; color: #333; font-size: 1rem; }
        .query-btn { padding: 12px 30px; background: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; }
        .query-btn:hover { background: #45a049; }
        .train-container { background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; margin: 20px 0; }
        .board-header { background: linear-gradient(135deg, #FF6B35 0%, #D84315 100%); color: white; padding: 20px; }
        .board-title h2 { font-size: 1.5rem; margin-bottom: 5px; }
        .pids-btn { display: inline-flex; align-items: center; gap: 8px; background: #212121; color: #ffb74d; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-weight: bold; }
        .direction-section { border-bottom: 2px solid #eee; }
        .direction-header { background: #f5f5f5; padding: 15px 20px; font-weight: 600; color: #333; border-left: 4px solid #FF6B35; }
        .train-card { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; }
        .train-info { display: flex; align-items: center; gap: 12px; }
        .train-type-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; color: white; font-size: 0.85rem; font-weight: bold; min-width: 90px; text-align: center; }
        .type-自強 { background-color: #FF5722; }
        .type-柴自強 { background-color: #D84315; }
        .type-新自強 { background: linear-gradient(135deg, #000000 0%, #333333 100%); }
        .type-普悠瑪 { background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); }
        .type-太魯閣 { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .type-莒光 { background-color: #FF9800; }
        .type-區間快 { background-color: #3F51B5; }
        .type-區間 { background-color: #2196F3; }
        .type-專車 { background: linear-gradient(135deg, #673AB7 0%, #512DA8 100%); }
        .type-復興 { background-color: #00BCD4; }
        .type-普快 { background-color: #009688; }
        .no-data { text-align: center; padding: 60px 20px; color: #999; }
        .no-data i { font-size: 3rem; margin-bottom: 20px; }
        .delay-badge { display: inline-block; padding: 6px 10px; border-radius: 6px; font-weight: bold; }
        .delay-ok { background-color: #E8F5E9; color: #2E7D32; }
        .delay-warn { background-color: #FFEBEE; color: #C62828; }
        .marquee-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: #1a1a1a; display: flex; align-items: center; z-index: 9999; border-top: 3px solid #ff9800; }
        .marquee-info { background: #000; min-width: 150px; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0 10px; }
        .marquee-train-no { font-size: 1.4rem; font-weight: 800; color: #ffeb3b; }
        .marquee-dest { font-size: 1rem; color: #fff; }
        .marquee-content-wrapper { flex: 1; overflow: hidden; position: relative; }
        .marquee-content { position: absolute; white-space: nowrap; font-size: 1.3rem; font-weight: bold; line-height: 57px; color: #fff; }
        .marquee-close { background: #222; border: none; color: #999; width: 50px; height: 100%; cursor: pointer; }
        @keyframes marquee-scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @media (max-width: 900px) { .selector-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回首頁</a>
            <h1><i class="fas fa-train"></i> 台鐵即時看板</h1>
        </div>
    </div>

    <div class="container">
        <div class="control-panel">
            <h3><i class="fas fa-search"></i> 查詢即時看板</h3>
            <div class="selector-row">
                <div class="selector-group">
                    <label>路線分類</label>
                    <select id="lineSelect" onchange="filterStations()"><option value="all">全部路線</option></select>
                </div>
                <div class="selector-group">
                    <label>搜尋車站</label>
                    <input type="text" id="stationSearch" placeholder="輸入站名" oninput="filterStations()">
                </div>
                <div class="selector-group">
                    <label>選擇車站</label>
                    <select id="stationSelect"><option value="">請選擇車站...</option></select>
                </div>
                <div class="selector-group">
                    <label>方向</label>
                    <select id="directionFilter">
                        <option value="">全部</option>
                        <option value="0">順行</option>
                        <option value="1">逆行</option>
                    </select>
                </div>
                <button class="query-btn" id="queryBtn" onclick="fetchTrainLiveBoard()"><i class="fas fa-sync-alt"></i> 查詢</button>
            </div>
        </div>

        <div id="trainContainer" class="train-container" style="display: none;">
            <div class="board-header">
                <h2 id="stationTitle">列車動態</h2>
                <div><span id="stationInfo"></span> | <span id="updateTime">--:--:--</span></div>
            </div>
            <div id="trainsBoard">
                <div class="no-data"><p>請選擇車站查詢</p></div>
            </div>
        </div>
    </div>

    <div id="trainMarqueeBar" class="marquee-bar" style="display: none;">
        <div class="marquee-info"><div class="marquee-train-no" id="mqTrainNo"></div><div class="marquee-dest" id="mqDest"></div></div>
        <div class="marquee-content-wrapper"><div class="marquee-content" id="mqContent"></div></div>
        <button class="marquee-close" onclick="closeMarquee()">×</button>
    </div>

    <script>
        const WORKER_URL = "https://tra-schedule-worker.xiaoyouwu5-fd3.workers.dev";
        let currentStationID = "", currentStationName = "", allStationsFlat = [];
        const trainDataCache = {};

        function isTrainHasNotLeft(targetTimeStr, delayMinutes, bufferMinutes) {
            if (!targetTimeStr) return true;
            const now = new Date();
            const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
            const [h, m] = targetTimeStr.split(":").map(Number);
            let targetTotalMinutes = h * 60 + m + (delayMinutes || 0);
            if (currentTotalMinutes > 18 * 60 && targetTotalMinutes < 6 * 60) targetTotalMinutes += 24 * 60;
            return (targetTotalMinutes - bufferMinutes) >= currentTotalMinutes;
        }

        function getPrettyTrainInfo(rawName, typeID) {
            let name = rawName || "列車";
            let cssClass = "其他";
            if (name.includes("自強(3000)") || name.includes("EMU3000")) cssClass = "新自強";
            else if (name.includes("普悠瑪")) cssClass = "普悠瑪";
            else if (name.includes("太魯閣")) cssClass = "太魯閣";
            else if (name.includes("自強")) cssClass = "自強";
            else if (name.includes("莒光")) cssClass = "莒光";
            else if (name.includes("區間快")) cssClass = "區間快";
            else if (name.includes("區間")) cssClass = "區間";
            if (cssClass === "自強" && (name.includes("柴聯") || (typeID && ["110D","110E","110F","1103"].includes(typeID)))) {
                cssClass = "柴自強"; name = "柴自強";
            }
            return { name, class: cssClass };
        }

        document.addEventListener("DOMContentLoaded", () => {
            initStationControls();
            setInterval(updateTime, 1000);
        });

        async function fetchTrainLiveBoard() {
            currentStationID = document.getElementById("stationSelect").value;
            if (!currentStationID) return alert("請先選擇車站");
            currentStationName = document.getElementById("stationSelect").selectedOptions[0].text.split(" - ")[1];
            document.getElementById("queryBtn").disabled = true;
            document.getElementById("trainsBoard").innerHTML = "<div class=\"no-data\"><p>載入中...</p></div>";
            document.getElementById("trainContainer").style.display = "block";

            try {
                const [scheduleRes, liveRes] = await Promise.all([
                    fetch(`${WORKER_URL}/api/station/schedule?stationID=${currentStationID}`).then(r => r.json()),
                    fetch(`${WORKER_URL}/api/station/live?stationID=${currentStationID}`).then(r => r.json())
                ]);

                let allTrains = [];
                let rootData = scheduleRes.StationTimetables || scheduleRes;
                if (!Array.isArray(rootData)) rootData = [rootData];

                const getZhTw = (val) => (val && typeof val === "object" && val.Zh_tw) ? val.Zh_tw : val;

                rootData.forEach(container => {
                    const innerList = container.TimeTables || container.StationTimetables || [];
                    innerList.forEach(st => {
                        if (!st.DepartureTime && !st.ArrivalTime) return;
                        allTrains.push({
                            TrainNo: st.TrainNo,
                            Direction: st.Direction,
                            TrainTypeName: getZhTw(st.TrainTypeName) || "列車",
                            TrainTypeID: st.TrainTypeID,
                            EndingStationName: getZhTw(st.DestinationStationName || st.EndingStationName) || "未知",
                            ScheduledDepartureTime: st.DepartureTime || st.ArrivalTime,
                            DelayTime: 0
                        });
                    });
                });

                const liveMap = new Map();
                const liveArray = Array.isArray(liveRes.StationLiveBoards) ? liveRes.StationLiveBoards : [liveRes.StationLiveBoards];
                liveArray.forEach(t => liveMap.set(t.TrainNo, t.DelayTime));

                allTrains = allTrains.map(train => {
                    if (liveMap.has(train.TrainNo)) train.DelayTime = liveMap.get(train.TrainNo);
                    return train;
                });

                allTrains = allTrains.filter(t => isTrainHasNotLeft(t.ScheduledDepartureTime, t.DelayTime, -5));
                allTrains.sort((a, b) => a.ScheduledDepartureTime.localeCompare(b.ScheduledDepartureTime));
                renderBoard(allTrains);
            } catch (error) {
                console.error(error);
                document.getElementById("trainsBoard").innerHTML = "<div class=\"no-data\"><p>查詢失敗</p></div>";
            } finally {
                document.getElementById("queryBtn").disabled = false;
            }
        }

        function renderBoard(trains) {
            document.getElementById("stationTitle").innerHTML = `${currentStationName} 列車動態 <a href="pids-live.html?station=${currentStationID}&name=${encodeURIComponent(currentStationName)}" target="_blank" class="pids-btn">PIDS</a>`;
            document.getElementById("stationInfo").textContent = `車站：${currentStationID}`;

            const directionFilter = document.getElementById("directionFilter").value;
            let filteredTrains = trains;
            if (directionFilter !== "") filteredTrains = trains.filter(t => String(t.Direction) === directionFilter);

            const grouped = { "0": { title: "順行", trains: [] }, "1": { title: "逆行", trains: [] } };
            filteredTrains.forEach(train => {
                if (grouped[train.Direction]) grouped[train.Direction].trains.push(train);
            });

            let html = "";
            Object.entries(grouped).forEach(([dir, data]) => {
                if (data.trains.length === 0) return;
                html += `<div class="direction-section"><div class="direction-header">${data.title}</div>`;
                data.trains.slice(0, 15).forEach(train => {
                    const trainInfo = getPrettyTrainInfo(train.TrainTypeName, train.TrainTypeID);
                    const isDeparted = !isTrainHasNotLeft(train.ScheduledDepartureTime, train.DelayTime, 0);
                    html += `<div class="train-card" style="${isDeparted ? "opacity: 0.6;" : ""}" onclick="showTrainStops("${train.TrainNo}", "${currentStationID}", "${train.EndingStationName}")">
                        <div class="train-info"><span class="train-type-badge type-${trainInfo.class}">${trainInfo.name}</span><div><div>${train.TrainNo} 次</div><div>往 ${train.EndingStationName}</div></div></div>
                        <div>${train.ScheduledDepartureTime.slice(0, 5)}</div>
                        <div><span class="delay-badge ${train.DelayTime === 0 ? "delay-ok" : "delay-warn"}">${train.DelayTime === 0 ? "準點" : `晚 ${train.DelayTime} 分`}</span></div>
                    </div>`;
                });
                html += "</div>";
            });

            document.getElementById("trainsBoard").innerHTML = html || "<div class=\"no-data\"><p>無列車資訊</p></div>";
        }

        function updateTime() {
            const now = new Date();
            const el = document.getElementById("updateTime");
            if (el) el.textContent = now.toLocaleTimeString("zh-TW");
        }

        function showTrainStops(trainNo, stationID, destName) {
            const bar = document.getElementById("trainMarqueeBar");
            bar.style.display = "flex";
            document.getElementById("mqTrainNo").textContent = `${trainNo} 次`;
            document.getElementById("mqDest").textContent = `往 ${destName}`;
        }

        function closeMarquee() {
            document.getElementById("trainMarqueeBar").style.display = "none";
        }

        function initStationControls() {
            const lineSelect = document.getElementById("lineSelect");
            for (const [key, data] of Object.entries(trainLineClassification)) {
                const optgroup = document.createElement("optgroup");
                optgroup.label = data.name;
                data.stations.forEach(station => {
                    const option = document.createElement("option");
                    option.value = station.code;
                    option.textContent = `${station.code} - ${station.name}`;
                    optgroup.appendChild(option);
                    if (!allStationsFlat.find(s => s.code === station.code)) {
                        allStationsFlat.push({ code: station.code, name: station.name });
                    }
                });
                lineSelect.appendChild(optgroup);
            }
            filterStations();
        }

        function filterStations() {
            const lineSelect = document.getElementById("lineSelect").value;
            const keyword = document.getElementById("stationSearch").value.toLowerCase();
            let filtered = allStationsFlat;
            if (keyword) filtered = filtered.filter(s => s.name.includes(keyword) || s.code.includes(keyword));
            
            const select = document.getElementById("stationSelect");
            select.innerHTML = `<option value="">請選擇車站 (${filtered.length})</option>`;
            filtered.forEach(s => {
                const option = document.createElement("option");
                option.value = s.code;
                option.textContent = `${s.code} - ${s.name}`;
                select.appendChild(option);
            });
        }
    </script>
</body>
</html>
