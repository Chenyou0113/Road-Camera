<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地震監測中心 | Earthquake Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
        }
        
        .magnitude-default { background-color: #e5e7eb; }
        .magnitude-4 { background-color: #fef08a; }
        .magnitude-5 { background-color: #fdba74; }
        .magnitude-6 { background-color: #f87171; }

        .card-enter {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .card-enter-active {
            opacity: 1;
            transform: translateY(0);
        }

        #map {
            height: 300px;
        }
        @media (min-width: 768px) {
            #map {
                height: 400px;
            }
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            font-size: 13px;
            line-height: 1.6;
        }

        #imageModal {
            transition: opacity 0.3s ease-in-out;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .header { 
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); 
            color: white; 
            padding: 15px 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); 
            position: sticky; top: 0; z-index: 100; 
        }
        .header-content { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        .header-title { 
            font-size: 1.4rem; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .back-btn { 
            color: white; 
            text-decoration: none; 
            font-size: 1.2rem; 
            cursor: pointer; 
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</head>
<body class="bg-gray-100">
    <div class="header">
        <div class="header-content">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回</a>
            <div class="header-title"><i class="fas fa-house-damage"></i> 地震監測中心</div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6 mt-4 relative">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">地震報告資訊 (綜合顯示)</h1>

        <!-- 地圖 -->
        <div id="map" class="w-full rounded-lg mb-6 border border-gray-300"></div>

        <!-- 控制區 -->
        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
            <button id="refreshButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-sync-alt"></i> 手動更新
            </button>
            <div class="text-sm text-gray-500 text-right">
                <div>上次更新: <span id="lastUpdated">--:--:--</span></div>
                <div>現在時間: <span id="currentTime">--:--:--</span></div>
            </div>
        </div>

        <!-- 載入指示器 -->
        <div id="loadingIndicator" class="text-center text-gray-600 py-4">
            載入資料中...
        </div>

        <!-- 地震列表 -->
        <div id="earthquakeList" class="space-y-4"></div>

        <!-- 分頁控制 -->
        <div id="paginationControls" class="flex justify-center items-center space-x-2 mt-4 mb-4">
            <button id="prevPage" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-1 px-3 rounded-lg transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                &lt; 上一頁
            </button>
            <span id="pageInfo" class="text-sm text-gray-600">頁數 0 / 0</span>
            <button id="nextPage" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-1 px-3 rounded-lg transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                下一頁 &gt;
            </button>
        </div>

        <div class="mt-6 text-center text-xs text-gray-400">
            資料來源：中央氣象署 地震觀測網 (E-A0015-001 & E-A0016-001) | 地圖圖資：© OpenStreetMap contributors
        </div>

        <!-- 訊息提示 -->
        <div id="messageBox" class="fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-lg hidden transition-opacity duration-300 z-[1000]">
            <span id="messageText"></span>
        </div>

        <!-- Modal for Image -->
        <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[1100] hidden">
            <div class="bg-white p-4 rounded-lg shadow-xl max-w-3xl w-full max-h-[85vh] overflow-auto relative">
                <button id="closeModalButton" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-3xl leading-none font-semibold z-10" aria-label="關閉">×</button>
                <p class="text-center font-medium mb-2" id="modalTitle">地震報告圖</p>
                <div class="flex justify-center items-center min-h-[200px]">
                    <img id="modalImage" src="" alt="地震報告圖" class="max-w-full h-auto rounded-lg">
                </div>
                <p id="modalErrorText" class="text-center text-red-500 mt-2 hidden"></p>
            </div>
        </div>
    </div>

    <script>
        // === DOM 元素 ===
        const earthquakeList = document.getElementById('earthquakeList');
        const lastUpdated = document.getElementById('lastUpdated');
        const refreshButton = document.getElementById('refreshButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const mapContainer = document.getElementById('map');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalErrorText = document.getElementById('modalErrorText');
        const modalTitle = document.getElementById('modalTitle');
        const paginationControls = document.getElementById('paginationControls');
        const prevPageButton = document.getElementById('prevPage');
        const nextPageButton = document.getElementById('nextPage');
        const pageInfoSpan = document.getElementById('pageInfo');
        const currentTimeSpan = document.getElementById('currentTime');

        // === API 設定 ===
        // 使用 Cloudflare Functions 代理 (後端已設定 CWA_API_KEY，前端無需暴露)
        const CWA_API_URL_SIGNIFICANT = '/api/earthquake-proxy?type=significant&limit=10';
        const CWA_API_URL_MINOR = '/api/earthquake-proxy?type=minor&limit=10';

        // === 地圖相關變數 ===
        let map = null;
        let markers = [];

        // === 分頁狀態變數 ===
        let allEarthquakes = [];
        let currentPage = 1;
        const itemsPerPage = 5;
        let totalPages = 0;

        // === 計時器 ID ===
        let currentTimeIntervalId = null;
        let earthquakeDataIntervalId = null;

        // === 初始化 Leaflet 地圖 ===
        function initializeMap() {
            if (map) return;
            try {
                map = L.map(mapContainer).setView([23.7, 120.9], 7);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18,
                }).addTo(map);
                console.log("地圖初始化成功");
            } catch (error) {
                console.error("地圖初始化失敗:", error);
                mapContainer.innerHTML = '<div class="p-4 text-center text-red-500">無法載入地圖。</div>';
            }
        }

        // === 顯示訊息提示 ===
        function showMessage(text, type = 'success', duration = 3000) {
            messageText.textContent = text;
            if (type === 'error') {
                messageBox.classList.remove('bg-green-500');
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.remove('bg-red-500');
                messageBox.classList.add('bg-green-500');
            }
            messageBox.classList.remove('hidden');
            messageBox.classList.add('opacity-100');
            if (messageBox.timerId) clearTimeout(messageBox.timerId);
            messageBox.timerId = setTimeout(() => {
                messageBox.classList.add('hidden');
                messageBox.classList.remove('opacity-100');
                messageBox.timerId = null;
            }, duration);
        }

        // === 根據規模獲取顏色樣式 ===
        function getMagnitudeClass(magnitude) {
            if (magnitude >= 6.0) return 'magnitude-6';
            if (magnitude >= 5.0) return 'magnitude-5';
            if (magnitude >= 4.0) return 'magnitude-4';
            return 'magnitude-default';
        }

        // === 格式化日期時間 ===
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            try {
                const date = new Date(dateTimeString);
                return date.toLocaleString('zh-TW', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            } catch (e) {
                return dateTimeString;
            }
        }

        // === 格式化時間 (HH:MM:SS) ===
        function formatTime(date) {
            return date.toLocaleTimeString('zh-TW', { hour12: false });
        }

        // === 清除地圖上的所有標記 ===
        function clearMapMarkers() {
            if (markers.length > 0) {
                markers.forEach(marker => marker.remove());
                markers = [];
            }
        }

        // === Modal 控制函數 ===
        function openModal(imageUrl, title = "地震報告圖") {
            if (!imageUrl) {
                console.warn("嘗試開啟 Modal，但未提供圖片 URL");
                modalImage.src = 'https://placehold.co/600x400/cccccc/ffffff?text=無報告圖提供';
                modalImage.alt = '無報告圖提供';
            } else {
                modalImage.onerror = function() {
                    this.src = 'https://placehold.co/600x400/cccccc/ffffff?text=圖片載入失敗';
                    modalErrorText.textContent = '圖片載入失敗';
                    modalErrorText.classList.remove('hidden');
                };
                modalImage.alt = '地震報告圖';
                modalImage.src = imageUrl;
            }
            modalTitle.textContent = title;
            imageModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            imageModal.classList.add('hidden');
            modalImage.src = '';
            document.body.style.overflow = '';
        }

        // === 渲染當前頁面的地震列表和地圖標記 ===
        function renderEarthquakeList(dataToRender) {
            earthquakeList.innerHTML = '';
            clearMapMarkers();

            if (!dataToRender || dataToRender.length === 0) {
                earthquakeList.innerHTML = '<div class="text-center text-gray-500 py-4">此頁無地震資料。</div>';
                if (map) map.setView([23.7, 120.9], 7);
                return;
            }

            let pageMarkers = [];

            dataToRender.forEach((eqData, index) => {
                const eqInfo = eqData.EarthquakeInfo || {};
                const epicenter = eqInfo.Epicenter || {};
                const magnitudeInfo = eqInfo.EarthquakeMagnitude || {};
                const reportImageURI = eqData.ReportImageURI;

                const id = eqData.EarthquakeNo || `unknown-${index}`;
                const originTime = eqInfo.OriginTime;
                const location = epicenter.Location || '未知地點';
                const latitudeStr = epicenter.EpicenterLatitude;
                const longitudeStr = epicenter.EpicenterLongitude;
                const depth = eqInfo.FocalDepth === undefined ? 'N/A' : eqInfo.FocalDepth.toFixed(1);
                const magnitude = magnitudeInfo.MagnitudeValue || 0;
                const reportContent = eqData.ReportContent || '';
                const webLink = eqData.Web || '#';
                const reportType = eqData.ReportType || '未知類型';

                const magnitudeClass = getMagnitudeClass(magnitude);
                const formattedTime = formatDateTime(originTime);

                // 建立卡片
                const card = document.createElement('div');
                card.className = `bg-white rounded-lg shadow-md p-4 border-l-4 ${magnitudeClass} card-enter`;
                setTimeout(() => card.classList.add('card-enter-active'), 10);

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-xs font-semibold px-2 py-1 rounded ${magnitude >= 5 ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                            ${reportType}
                        </span>
                        <span class="text-xs text-gray-500">${id}</span>
                    </div>
                    <div class="flex items-center gap-4 mb-3">
                        <div class="text-3xl font-bold ${magnitude >= 5 ? 'text-red-600' : 'text-blue-600'}">
                            ${magnitude.toFixed(1)}
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">${formattedTime}</div>
                            <div class="text-sm text-gray-600 flex items-center gap-1">
                                <i class="fas fa-map-marker-alt"></i> ${location}
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
                        <div class="text-gray-600">深度：<span class="font-semibold">${depth} km</span></div>
                        <div class="text-gray-600">規模：<span class="font-semibold">${magnitude.toFixed(1)}</span></div>
                    </div>
                    ${reportContent ? `<p class="text-sm text-gray-700 mb-3">${reportContent}</p>` : ''}
                    <div class="flex gap-2">
                        ${reportImageURI ? `<button onclick="openModal('${reportImageURI}', '${id} 報告圖')" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-3 rounded transition">
                            <i class="fas fa-image"></i> 查看報告圖
                        </button>` : ''}
                        <a href="${webLink}" target="_blank" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white text-sm py-2 px-3 rounded transition text-center">
                            <i class="fas fa-external-link-alt"></i> 官方報告
                        </a>
                    </div>
                `;

                earthquakeList.appendChild(card);

                // 加入地圖標記
                if (latitudeStr && longitudeStr) {
                    const lat = parseFloat(latitudeStr);
                    const lon = parseFloat(longitudeStr);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const marker = L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background-color: ${magnitude >= 5 ? '#dc2626' : '#2563eb'}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${magnitude.toFixed(1)}</div>`,
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            })
                        }).addTo(map);

                        marker.bindPopup(`
                            <div style="min-width: 180px;">
                                <strong>${location}</strong><br>
                                規模：<strong>${magnitude.toFixed(1)}</strong><br>
                                深度：${depth} km<br>
                                時間：${formattedTime}
                            </div>
                        `);

                        pageMarkers.push(marker);
                    }
                }
            });

            markers = pageMarkers;

            // 調整地圖視圖
            if (map && markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            } else if (map && dataToRender.length > 0 && markers.length === 0) {
                map.setView([23.7, 120.9], 7);
            }
        }

        // === 更新分頁控制項狀態 ===
        function updatePaginationControls() {
            if (totalPages <= 0) {
                paginationControls.classList.add('hidden');
                return;
            }

            paginationControls.classList.remove('hidden');
            pageInfoSpan.textContent = `頁數 ${currentPage} / ${totalPages}`;
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = currentPage === totalPages;
        }

        // === 顯示當前頁面資料 ===
        function displayCurrentPage() {
            console.log(`顯示頁面: ${currentPage}`);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = allEarthquakes.slice(startIndex, endIndex);

            renderEarthquakeList(paginatedData);
            updatePaginationControls();
        }

        // === 帶重試機制的 fetch 函數 ===
        async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000, timeout = 10000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);
                    
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response;
                } catch (error) {
                    const isLastAttempt = i === retries - 1;
                    
                    if (error.name === 'AbortError') {
                        console.warn(`請求超時 (嘗試 ${i + 1}/${retries})`);
                    } else {
                        console.warn(`網路請求失敗 (嘗試 ${i + 1}/${retries}):`, error.message);
                    }
                    
                    if (isLastAttempt) {
                        throw error;
                    }
                    
                    // 等待後重試，使用指數退避
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

        // === 從 CWA API 獲取資料並處理分頁 ===
        async function fetchEarthquakeData() {
            loadingIndicator.style.display = 'block';
            refreshButton.disabled = true;
            console.log("正在從 CWA API 獲取地震資料...");
            
            try {
                // 順序獲取兩個 API 的資料（更穩定）
                console.log("獲取顯著有感地震資料...");
                const responseSignificant = await fetchWithRetry(CWA_API_URL_SIGNIFICANT);
                const dataSignificant = await responseSignificant.json();
                
                console.log("獲取小區域有感地震資料...");
                const responseMinor = await fetchWithRetry(CWA_API_URL_MINOR);
                const dataMinor = await responseMinor.json();

                // 提取地震資料
                const earthquakesSignificant = dataSignificant?.records?.Earthquake || [];
                const earthquakesMinor = dataMinor?.records?.Earthquake || [];

                // 標記類型
                earthquakesSignificant.forEach(eq => eq.ReportType = '顯著有感地震');
                earthquakesMinor.forEach(eq => eq.ReportType = '小區域有感地震');

                // 合併並按時間排序
                allEarthquakes = [...earthquakesSignificant, ...earthquakesMinor].sort((a, b) => {
                    const timeA = new Date(a.EarthquakeInfo?.OriginTime || 0);
                    const timeB = new Date(b.EarthquakeInfo?.OriginTime || 0);
                    return timeB - timeA;
                });

                if (allEarthquakes.length === 0) {
                    earthquakeList.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-info-circle fa-2x mb-2"></i><p>目前無地震資料</p></div>';
                    paginationControls.classList.add('hidden');
                    return;
                }

                // 計算總頁數並顯示第一頁
                totalPages = Math.ceil(allEarthquakes.length / itemsPerPage);
                currentPage = 1;
                displayCurrentPage();

                updateLastUpdatedTime();
                showMessage('資料更新成功！', 'success');

            } catch (error) {
                console.error('獲取地震資料失敗:', error);
                earthquakeList.innerHTML = `<div class="text-center text-red-500 py-8"><i class="fas fa-times-circle fa-2x mb-2"></i><p>無法讀取資料</p><p class="text-sm mt-2">${error.message}</p></div>`;
                showMessage('資料更新失敗', 'error');
                updateLastUpdatedTime();
            } finally {
                loadingIndicator.style.display = 'none';
                refreshButton.disabled = false;
            }
        }

        // === 更新「上次更新」時間戳 ===
        function updateLastUpdatedTime() {
            const now = new Date();
            lastUpdated.textContent = formatTime(now);
        }

        // === 更新「現在時間」 ===
        function updateCurrentTime() {
            const now = new Date();
            currentTimeSpan.textContent = formatTime(now);
        }

        // === 啟動現在時間的計時器 ===
        function startCurrentTimeClock() {
            if (currentTimeIntervalId) {
                clearInterval(currentTimeIntervalId);
            }
            updateCurrentTime();
            currentTimeIntervalId = setInterval(updateCurrentTime, 1000);
        }

        // === 啟動地震資料自動更新計時器 ===
        function startEarthquakeDataAutoUpdate(interval = 60 * 1000) {
            if (earthquakeDataIntervalId) {
                clearInterval(earthquakeDataIntervalId);
            }
            console.log(`設定地震資料自動更新間隔為 ${interval / 1000} 秒`);
            earthquakeDataIntervalId = setInterval(fetchEarthquakeData, interval);
        }

        // === 事件監聽器 ===
        refreshButton.addEventListener('click', () => {
            fetchEarthquakeData();
            startEarthquakeDataAutoUpdate(60 * 1000);
        });

        closeModalButton.addEventListener('click', closeModal);
        imageModal.addEventListener('click', (event) => {
            if (event.target === imageModal) {
                closeModal();
            }
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !imageModal.classList.contains('hidden')) {
                closeModal();
            }
        });

        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayCurrentPage();
            }
        });

        nextPageButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                displayCurrentPage();
            }
        });

        // === 初始化 ===
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            fetchEarthquakeData();
            startCurrentTimeClock();
            startEarthquakeDataAutoUpdate(60 * 1000);
        });
    </script>
</body>
</html>
