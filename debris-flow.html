<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>土石流監測監視器系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/responsive-camera.css">
    <script src="assets/image-handler-simple.js"></script>
    <!-- Leaflet 地圖庫 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1e40af 0%, #0891b2 50%, #06b6d4 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #1e40af, #0891b2);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            text-align: center;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .stat-red { color: #F44336; }
        .stat-orange { color: #1e40af; }
        .stat-green { color: #0891b2; }
        .stat-blue { color: #06b6d4; }
        .stat-purple { color: #06b6d4; }
        
        .nav-bar {
            background: white;
            padding: 15px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-links {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav-link {
            padding: 10px 16px;
            text-decoration: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .nav-link.active {
            background: #795548;
            color: white;
            border: 2px solid #8D6E63;
        }
        
        .nav-link:not(.active) {
            background: #f5f5f5;
            color: #333;
        }
        
        .nav-link:hover {
            transform: scale(1.05);
        }
        
        .filters-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-label {
            font-weight: bold;
            color: #555;
            font-size: 0.9rem;
        }
        
        .filter-select, .filter-input {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            color: #333;
            transition: border-color 0.3s ease;
        }
        
        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #795548;
        }
        
        .clear-button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #FF5722, #D84315);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 87, 34, 0.3);
        }
        
        .monitoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .station-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .station-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .station-image {
            width: 100%;
            height: 220px;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #795548, #8D6E63);
        }
        
        .station-map {
            width: 100%;
            height: 220px;
            position: relative;
            z-index: 1;
        }
        
        .leaflet-container {
            border-radius: 12px 12px 0 0;
        }
        
        .station-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s ease;
            z-index: 1;
        }
        
        .no-image-display {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border: 2px dashed #ddd;
            border-radius: 8px;
        }
        
        .status-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .status-normal { background: rgba(76, 175, 80, 0.9); }
        .status-warning { background: rgba(255, 152, 0, 0.9); }
        .status-danger { background: rgba(244, 67, 54, 0.9); }
        .status-offline { background: rgba(96, 125, 139, 0.9); }
        
        .risk-level {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .risk-low { background: rgba(76, 175, 80, 0.9); }
        .risk-medium { background: rgba(255, 193, 7, 0.9); }
        .risk-high { background: rgba(255, 87, 34, 0.9); }
        .risk-extreme { background: rgba(183, 28, 28, 0.9); }
        
        .station-info {
            padding: 20px;
        }
        
        .station-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 10px 12px;
            border-radius: 8px;
            border-left: 4px solid #795548;
        }
        
        .info-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 0.9rem;
            color: #333;
            font-weight: 500;
        }
        
        .sensor-readings {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .sensor-item {
            text-align: center;
            padding: 10px;
            background: #f1f3f4;
            border-radius: 8px;
        }
        
        .sensor-value {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .sensor-label {
            font-size: 0.75rem;
            color: #666;
        }
        
        .last-updated {
            text-align: center;
            color: #999;
            font-size: 0.8rem;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #795548, #8D6E63);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            position: relative;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .close {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #ffcdd2;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2rem;
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert-banner {
            background: linear-gradient(135deg, #F44336, #D32F2F);
            color: white;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        @media (max-width: 768px) {
            .monitoring-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-links {
                justify-content: center;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 深色模式樣式 */
        body.dark-mode .loading {
            color: rgba(255, 255, 255, 0.9);
        }

        body.dark-mode .stat-card {
            background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }

        body.dark-mode .stat-number {
            color: #FF7043;
        }

        body.dark-mode .stat-label {
            color: rgba(255, 255, 255, 0.7);
        }

        body.dark-mode .search-container {
            background: rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .filter-group label {
            color: rgba(255, 255, 255, 0.9);
        }

        body.dark-mode .filter-group select,
        body.dark-mode .filter-group input {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: #FF7043;
        }

        body.dark-mode .filter-group select option {
            background: #2a2a3e;
            color: white;
        }

        body.dark-mode .filter-group button {
            background: #FF7043;
            color: white;
        }

        body.dark-mode .filter-group button:hover {
            background: #FF8A65;
        }

        body.dark-mode .camera-card {
            background: linear-gradient(135deg, rgba(40,40,50,0.95) 0%, rgba(30,30,40,0.85) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }

        body.dark-mode .camera-info h3 {
            color: #FF7043;
        }

        body.dark-mode .camera-info p {
            color: rgba(255, 255, 255, 0.8);
        }

        body.dark-mode .camera-info a {
            color: #FF7043;
        }

        body.dark-mode .status {
            background: rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .status.active {
            background: #FF7043;
            color: white;
        }

        body.dark-mode .modal {
            background: rgba(20, 20, 30, 0.95);
        }

        body.dark-mode .modal-content {
            background: linear-gradient(135deg, rgba(40,40,50,0.98) 0%, rgba(30,30,40,0.95) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        body.dark-mode .modal-title {
            color: #FF7043;
        }
    </style>
    
    <!-- 載入進度條 -->
    <script src="assets/loading-progress.js"></script>
    <script>
        // 土石流監測載入設定
        window.AUTO_START_LOADING = false;
        
        window.addEventListener('DOMContentLoaded', () => {
            window.startLoading({
                labelText: '載入土石流監測系統...',
                color: '#FF7043',
                showLabel: true
            });
        });
    </script>
</head>
<body>
        <div class="header">
        <div class="container">
            <h1><i class="fas fa-mountain"></i> 土石流監測監視器系統</h1>
            <p>全台土石流潛勢區域監測影像與即時預警資訊</p>
            <div id="dataSource" style="text-align: center; margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">
                <i class="fas fa-database"></i> 資料來源：農業部開放資料平台
            </div>
        </div>
    </div>    
    
    <div class="container">
        <a href="index.html" style="display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #1e40af, #0891b2); color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; transition: all 0.3s ease;">
            <i class="fas fa-arrow-left"></i> 返回首頁
        </a>

        <!-- 統計資訊卡片 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number stat-blue" id="totalStations">--</div>
                <div class="stat-label">監測站總數</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-green" id="countiesCount">--</div>
                <div class="stat-label">涵蓋縣市</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-orange" id="districtsCount">--</div>
                <div class="stat-label">涵蓋鄉鎮區</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-purple" id="imagesCount">--</div>
                <div class="stat-label">有影像資料</div>
            </div>
        </div>

        <!-- 篩選控制區 -->
            <h3 style="color: #795548; margin-bottom: 15px;">
                <i class="fas fa-filter"></i> 監測站篩選與搜尋
            </h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">縣市</label>
                    <select id="countyFilter" class="filter-select" onchange="onCountyChange()">
                        <option value="">選擇縣市</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">鄉鎮區</label>
                    <select id="districtFilter" class="filter-select">
                        <option value="">選擇鄉鎮區</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">監測站搜尋</label>
                    <input type="text" id="searchInput" class="filter-input" placeholder="輸入監測站名稱或編號">
                </div>
                <div class="filter-group">
                    <button id="clearFilters" class="clear-button">
                        <i class="fas fa-refresh"></i> 清除篩選
                    </button>
                </div>
            </div>
        </div>



        <!-- 監測站網格 -->
        <div id="stationsGrid" class="monitoring-grid">
            <div class="loading">
                <i class="fas fa-spinner"></i>
                <div>載入土石流監測站資料中...</div>
            </div>
        </div>
    </div>

    <!-- 詳細資訊彈窗 -->
    <div id="stationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">監測站詳細資訊</div>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 內容將由 JavaScript 動態生成 -->
            </div>
        </div>
    </div>

    <script>
        // 農業部土石流警戒服務API - 取得觀測站監控影像
        const MOA_API_URL = 'https://data.moa.gov.tw/api/v1/DebrisAlertServices/GetStationMonitor';
        
        // 土石流監測站資料（將從API載入）
        let debrisFlowStations = [];
        let filteredStations = [];
        


        // 載入農業部監測站資料
        async function loadMOAData() {
            try {
                showLoading('正在連接農業部開放資料平台...');
                
                // 嘗試直接載入新 API
                let response;
                let apiData;
                let apiSuccess = false;
                
                try {
                    console.log('🔄 嘗試連接 API:', MOA_API_URL);
                    response = await fetch(MOA_API_URL, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    console.log('📊 API 回應狀態:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status} ${response.statusText}`);
                    }
                    
                    apiData = await response.json();
                    console.log('✅ API 回傳成功');
                    console.log('📦 API 資料結構:', Object.keys(apiData));
                    console.log('📋 API 樣本資料:', apiData.DATA?.[0] || apiData[0]);
                    apiSuccess = true;
                    
                } catch (corsError) {
                    console.warn('❌ 直接連接失敗:', corsError.message);
                    
                    try {
                        // 如果CORS失敗，使用代理服務
                        console.log('🔄 嘗試使用代理服務...');
                        response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(MOA_API_URL)}`);
                        
                        console.log('📊 代理服務回應狀態:', response.status);
                        
                        if (response.ok) {
                            const proxyData = await response.json();
                            apiData = JSON.parse(proxyData.contents);
                            console.log('✅ 代理方式成功');
                            apiSuccess = true;
                        } else {
                            throw new Error('代理服務失敗');
                        }
                    } catch (proxyError) {
                        console.error('❌ 代理方式也失敗:', proxyError.message);
                        throw corsError;
                    }
                }
                
                if (!apiData) {
                    throw new Error('無法獲取 API 資料');
                }
                
                showLoading('正在解析監測站資料...');
                
                // 新 API 回傳格式：{ DATA: [...] } 或直接是陣列
                let stationsData = apiData.DATA || apiData;
                
                // 如果是物件但沒有 DATA，嘗試找到陣列字段
                if (!Array.isArray(stationsData) && typeof stationsData === 'object') {
                    const arrayField = Object.keys(stationsData).find(key => Array.isArray(stationsData[key]));
                    if (arrayField) {
                        console.log(`📦 找到陣列字段: ${arrayField}`);
                        stationsData = stationsData[arrayField];
                    }
                }
                
                if (!Array.isArray(stationsData)) {
                    console.error('❌ API 回傳資料結構不是陣列:', apiData);
                    throw new Error(`API 回傳格式錯誤，無法找到陣列資料`);
                }
                
                console.log(`📊 成功獲取 ${stationsData.length} 個監測站資料`);
                
                // 轉換API資料為內部格式
                debrisFlowStations = stationsData.map((item, index) => {
                    const county = item['縣市'] || '';
                    const district = item['行政區'] || '';
                    const location = county && district ? `${county}${district}` : (county || district || '未知地區');
                    
                    return {
                        id: `MOA${String(index + 1).padStart(3, '0')}`,
                        name: item['攝影機名稱'] || `監測站${index + 1}`,
                        location: location,
                        county: county,
                        district: district,
                        address: item['架設或拍攝地點'] || '',
                        image: item['影像網址'] || '',
                        coordinates: { 
                            lat: parseFloat(item['緯度']) || 0,
                            lng: parseFloat(item['經度']) || 0 
                        },
                        lastUpdate: new Date().toISOString().slice(0, 19).replace('T', ' ')
                    };
                });
                
                // 過濾無效座標的資料
                debrisFlowStations = debrisFlowStations.filter(station => 
                    station.coordinates.lat !== 0 && station.coordinates.lng !== 0 && station.name
                );
                
                filteredStations = [...debrisFlowStations];
                console.log(`✅ 成功載入 ${debrisFlowStations.length} 個有效的監測站`);
                
                // 更新全域進度條
                window.setLoadingProgress(90);
                window.updateLoadingLabel('載入完成');
                
                // 更新資料來源顯示
                document.getElementById('dataSource').innerHTML = 
                    `<i class="fas fa-check-circle"></i> 資料來源：農業部開放資料平台 (${debrisFlowStations.length} 個監測站)`;
                document.getElementById('dataSource').style.color = '#4CAF50';
                
                // 更新下拉選單選項
                updateLocationOptions();
                
                // 完成載入進度
                setTimeout(() => {
                    window.finishLoading();
                }, 500);
                
            } catch (error) {
                console.error('❌ 載入農業部資料失敗:', error);
                console.error('📋 錯誤訊息:', error.message);
                console.error('🔍 錯誤堆疊:', error.stack);
                
                // 更新錯誤狀態顯示
                document.getElementById('dataSource').innerHTML = 
                    `<i class="fas fa-exclamation-triangle"></i> 無法連接農業部API，使用備用資料 (${error.message})`;
                document.getElementById('dataSource').style.color = '#FF9800';
                
                // 使用備用模擬資料
                debrisFlowStations = generateFallbackData();
                filteredStations = [...debrisFlowStations];
                console.log(`⚠️ 使用備用資料，共 ${debrisFlowStations.length} 個監測站`);
                
                // 更新下拉選單選項
                updateLocationOptions();
                
                // 完成載入進度（備用資料）
                window.setLoadingProgress(100);
                window.updateLoadingLabel('使用備用資料');
                setTimeout(() => {
                    window.finishLoading();
                }, 500);
            }
        }
        

        

        

        
        // 更新縣市和行政區選項
        function updateLocationOptions() {
            // 台灣縣市標準排序 - 由北到南，直轄市優先
            const TAIWAN_CITY_ORDER = [
                '台北市', '新北市', '桃園市', '台中市', '台南市', '高雄市',
                '基隆市', '新竹市', '嘉義市',
                '新竹縣', '苗栗縣', '彰化縣', '南投縣', '雲林縣', '嘉義縣', '屏東縣',
                '宜蘭縣', '花蓮縣', '台東縣',
                '澎湖縣', '金門縣', '連江縣'
            ];
            
            const countyFilter = document.getElementById('countyFilter');
            const counties = [...new Set(debrisFlowStations.map(s => s.county).filter(c => c))];
            
            // 按照台灣縣市標準順序排列
            const sortedCounties = counties.sort((a, b) => {
                const indexA = TAIWAN_CITY_ORDER.indexOf(a);
                const indexB = TAIWAN_CITY_ORDER.indexOf(b);
                // 如果在標準順序中找不到，則放在最後並按字母排序
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            // 清空並重新填充縣市選項
            countyFilter.innerHTML = '<option value="">選擇縣市</option>';
            
            sortedCounties.forEach(county => {
                const option = document.createElement('option');
                option.value = county;
                option.textContent = county;
                countyFilter.appendChild(option);
            });
        }

        // 縣市變更處理
        function onCountyChange() {
            const selectedCounty = document.getElementById('countyFilter').value;
            const districtFilter = document.getElementById('districtFilter');
            
            // 清空行政區選項
            districtFilter.innerHTML = '<option value="">選擇鄉鎮區</option>';
            
            if (selectedCounty) {
                // 根據選擇的縣市篩選行政區
                const districts = [...new Set(
                    debrisFlowStations
                        .filter(s => s.county === selectedCounty)
                        .map(s => s.district)
                        .filter(d => d)
                )].sort();
                
                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtFilter.appendChild(option);
                });
                
                // 顯示該縣市的監測站數量
                const countyStations = debrisFlowStations.filter(s => s.county === selectedCounty);
                console.log(`${selectedCounty} 共有 ${countyStations.length} 個監測站`);
            }
            
            // 觸發篩選
            filterStations();
        }
        
        // 備用資料（當API無法存取時） - 包含示範圖像
        function generateFallbackData() {
            return [
                {
                    id: 'FB001',
                    name: '陽明山監測站',
                    location: '台北市北投區',
                    county: '台北市',
                    district: '北投區',
                    address: '陽明山國家公園區域',
                    image: 'https://via.placeholder.com/800x600?text=陽明山監測站&bg=4a90e2&fg=fff',
                    coordinates: { lat: 25.1825, lng: 121.5481 },
                    lastUpdate: new Date().toISOString().slice(0, 19).replace('T', ' ')
                },
                {
                    id: 'FB002',
                    name: '烏來風景區監測站',
                    location: '新北市烏來區',
                    county: '新北市',
                    district: '烏來區',
                    address: '烏來風景特定區',
                    image: 'https://via.placeholder.com/800x600?text=烏來監測站&bg=7cc576&fg=fff',
                    coordinates: { lat: 24.8631, lng: 121.5509 },
                    lastUpdate: new Date().toISOString().slice(0, 19).replace('T', ' ')
                },
                {
                    id: 'FB003',
                    name: '南山監測站',
                    location: '台中市和平區',
                    county: '台中市',
                    district: '和平區',
                    address: '南山部落周邊',
                    image: 'https://via.placeholder.com/800x600?text=南山監測站&bg=f5a623&fg=fff',
                    coordinates: { lat: 24.3967, lng: 121.0633 },
                    lastUpdate: new Date().toISOString().slice(0, 19).replace('T', ' ')
                },
                {
                    id: 'FB004',
                    name: '太魯閣監測站',
                    location: '花蓮縣秀林鄉',
                    county: '花蓮縣',
                    district: '秀林鄉',
                    address: '太魯閣國家公園',
                    image: 'https://via.placeholder.com/800x600?text=太魯閣監測站&bg=bd10e0&fg=fff',
                    coordinates: { lat: 24.1440, lng: 121.1945 },
                    lastUpdate: new Date().toISOString().slice(0, 19).replace('T', ' ')
                },
                {
                    id: 'FB005',
                    name: '阿里山監測站',
                    location: '嘉義縣阿里山鄉',
                    county: '嘉義縣',
                    district: '阿里山鄉',
                    address: '阿里山森林遊樂區',
                    image: 'https://via.placeholder.com/800x600?text=阿里山監測站&bg=417505&fg=fff',
                    coordinates: { lat: 23.5089, lng: 120.8123 },
                    lastUpdate: new Date().toISOString().slice(0, 19).replace('T', ' ')
                },
                {
                    id: 'FB006',
                    name: '玉山監測站',
                    location: '南投縣信義鄉',
                    county: '南投縣',
                    district: '信義鄉',
                    address: '玉山國家公園',
                    image: 'https://via.placeholder.com/800x600?text=玉山監測站&bg=9b9b9b&fg=fff',
                    coordinates: { lat: 23.4725, lng: 120.9570 },
                    lastUpdate: new Date().toISOString().slice(0, 19).replace('T', ' ')
                },
                {
                    id: 'FB007',
                    name: '獅頭山監測站',
                    location: '苗栗縣南庄鄉',
                    county: '苗栗縣',
                    district: '南庄鄉',
                    address: '獅頭山風景區',
                    image: 'https://via.placeholder.com/800x600?text=獅頭山監測站&bg=50e3c2&fg=fff',
                    coordinates: { lat: 24.5542, lng: 120.8808 },
                    lastUpdate: new Date().toISOString().slice(0, 19).replace('T', ' ')
                },
                {
                    id: 'FB008',
                    name: '雪山監測站',
                    location: '台中市和平區',
                    county: '台中市',
                    district: '和平區',
                    address: '雪山主峰周邊',
                    image: 'https://via.placeholder.com/800x600?text=雪山監測站&bg=1a1a1a&fg=fff',
                    coordinates: { lat: 24.3624, lng: 121.0533 },
                    lastUpdate: new Date().toISOString().slice(0, 19).replace('T', ' ')
                }
            ];
        }
        
        // 顯示載入狀態
        function showLoading(message) {
            // 更新全域進度條
            if (message.includes('連接')) {
                window.setLoadingProgress(30);
                window.updateLoadingLabel(message);
            } else if (message.includes('解析')) {
                window.setLoadingProgress(60);
                window.updateLoadingLabel(message);
            }
            
            const grid = document.getElementById('stationsGrid');
            grid.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>${message}</div>
                    <div style="margin-top: 10px; font-size: 0.8rem; opacity: 0.7;">
                        正在連接農業部土石流觀測站資料庫...
                    </div>
                </div>
            `;
        }

        // 測試API連接
        async function testAPIConnection() {
            try {
                console.log('測試農業部API連接:', MOA_API_URL);
                const response = await fetch(MOA_API_URL, { 
                    method: 'HEAD',
                    mode: 'no-cors' 
                });
                return true;
            } catch (error) {
                console.log('API連接測試失敗:', error.message);
                return false;
            }
        }

        // 初始化頁面
        async function initializePage() {
            setupEventListeners();
            await loadMOAData();
            updateStatistics();
            renderStations();
        }

        // 更新統計資訊
        function updateStatistics() {
            const total = debrisFlowStations.length;
            const counties = [...new Set(debrisFlowStations.map(s => s.county).filter(c => c))].length;
            const districts = [...new Set(debrisFlowStations.map(s => s.district).filter(d => d))].length;
            const withImages = debrisFlowStations.filter(s => s.image && s.image.trim() !== '').length;

            document.getElementById('totalStations').textContent = total;
            document.getElementById('countiesCount').textContent = counties;
            document.getElementById('districtsCount').textContent = districts;
            document.getElementById('imagesCount').textContent = withImages;
        }

        // 渲染監測站
        function renderStations() {
            const grid = document.getElementById('stationsGrid');
            
            if (filteredStations.length === 0) {
                grid.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-search"></i>
                        <div>找不到符合條件的監測站</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredStations.map((station, index) => `
                <div class="station-card" onclick="showStationDetails('${station.id}')">
                    <div class="station-map" id="map-${index}"></div>
                    
                    <div class="station-info">
                        <div class="station-title">
                            <i class="fas fa-video"></i>
                            ${station.name}
                        </div>
                        
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">監測編號</div>
                                <div class="info-value">${station.id}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">縣市</div>
                                <div class="info-value">${station.county || '未知'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">行政區</div>
                                <div class="info-value">${station.district || '未知'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">架設地點</div>
                                <div class="info-value">${station.address || station.location}</div>
                            </div>
                        </div>
                        
                        <div class="coordinates-info" style="margin: 15px 0; padding: 10px; background: #f1f3f4; border-radius: 5px; text-align: center;">
                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 5px;">座標位置</div>
                            <div style="font-size: 0.9rem; font-family: monospace;">
                                ${station.coordinates.lat.toFixed(6)}, ${station.coordinates.lng.toFixed(6)}
                            </div>
                        </div>
                        
                        <div class="last-updated">
                            <i class="fas fa-clock"></i> 
                            資料更新：${formatDateTime(station.lastUpdate)}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // 在DOM更新後初始化地圖
            setTimeout(() => {
                filteredStations.forEach((station, index) => {
                    initStationMap(station, index);
                });
            }, 100);
        }
        
        // 初始化單個監測站的地圖
        function initStationMap(station, index) {
            const mapId = `map-${index}`;
            const mapElement = document.getElementById(mapId);
            
            if (!mapElement) return;
            
            // 檢查是否已初始化過
            if (mapElement._leaflet_id) {
                return;
            }
            
            try {
                // 創建地圖
                const map = L.map(mapId, {
                    zoomControl: false,
                    dragging: false,
                    scrollWheelZoom: false,
                    doubleClickZoom: false,
                    boxZoom: false,
                    keyboard: false,
                    tap: false
                }).setView([station.coordinates.lat, station.coordinates.lng], 13);
                
                // 添加 OpenStreetMap 圖層
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap',
                    maxZoom: 18
                }).addTo(map);
                
                // 創建自定義圖標
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #795548; width: 40px; height: 40px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                        <i class="fas fa-mountain" style="color: white; transform: rotate(45deg); font-size: 18px;"></i>
                    </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                });
                
                // 添加標記
                L.marker([station.coordinates.lat, station.coordinates.lng], {
                    icon: customIcon
                }).addTo(map).bindPopup(`
                    <div style="text-align: center;">
                        <strong>${station.name}</strong><br>
                        <small>${station.location}</small>
                    </div>
                `);
                
            } catch (error) {
                console.error(`初始化地圖失敗 (${mapId}):`, error);
                mapElement.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f5f5f5;">
                        <div style="text-align: center; color: #999;">
                            <i class="fas fa-map-marked-alt" style="font-size: 2rem; margin-bottom: 10px;"></i><br>
                            <span style="font-size: 0.9rem;">地圖載入失敗</span>
                        </div>
                    </div>
                `;
            }
        }

        // 圖片載入處理
        function showImage(img) {
            // 影像成功載入時直接顯示
            img.style.opacity = '1';
        }

        function handleImageError(img) {
            console.log('圖片載入失敗:', img.src);
            
            const originalSrc = img.dataset.originalSrc || img.src;
            
            // 檢查是否為農業部土石流監測影像URL
            if (originalSrc && originalSrc.includes('dfm.swcb.gov.tw') && !img.dataset.govRetried) {
                img.dataset.govRetried = 'true';
                console.log('嘗試農業部影像的替代URL...');
                
                // 嘗試不同的影像參數
                if (originalSrc.includes('ShowCCDImg-LG')) {
                    img.src = originalSrc.replace('ShowCCDImg-LG', 'ShowCCDImg');
                } else if (originalSrc.includes('ShowCCDImg')) {
                    img.src = originalSrc.replace('ShowCCDImg', 'ShowCCDImg-LG');
                }
                return;
            }
            
            // 嘗試使用圖片代理服務
            if (!img.dataset.proxyTried && originalSrc && !originalSrc.includes('images2.imgbox.com')) {
                img.dataset.proxyTried = 'true';
                console.log('嘗試使用代理服務載入影像...');
                // 嘗試使用CORS代理
                try {
                    img.src = `https://api.allorigins.win/raw?url=${encodeURIComponent(originalSrc)}`;
                    return;
                } catch (e) {
                    console.log('代理服務失敗');
                }
            }
            
            // 所有載入嘗試都失敗，隱藏影像元素
            img.style.display = 'none';
            const imageContainer = img.parentElement;
            if (imageContainer) {
                const noImageDisplay = imageContainer.querySelector('.no-image-display');
                if (noImageDisplay) {
                    noImageDisplay.style.display = 'flex';
                }
            }
        }



        // 格式化日期時間
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('zh-TW');
        }

        // 篩選功能
        function filterStations() {
            const countyFilter = document.getElementById('countyFilter').value;
            const districtFilter = document.getElementById('districtFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            filteredStations = debrisFlowStations.filter(station => {
                const matchCounty = !countyFilter || station.county === countyFilter;
                const matchDistrict = !districtFilter || station.district === districtFilter;
                const matchSearch = !searchInput || 
                    station.name.toLowerCase().includes(searchInput) || 
                    station.id.toLowerCase().includes(searchInput) ||
                    station.location.toLowerCase().includes(searchInput) ||
                    (station.address && station.address.toLowerCase().includes(searchInput));

                return matchCounty && matchDistrict && matchSearch;
            });

            renderStations();
            
            // 顯示篩選結果統計
            updateFilterStats();
        }

        // 更新篩選統計
        function updateFilterStats() {
            const totalStations = debrisFlowStations.length;
            const filteredCount = filteredStations.length;
            
            // 如果有篩選條件且結果少於總數，顯示統計
            const hasFilters = document.getElementById('countyFilter').value || 
                              document.getElementById('districtFilter').value || 
                              document.getElementById('searchInput').value;
                              
            if (hasFilters && filteredCount < totalStations) {
                console.log(`篩選結果：顯示 ${filteredCount} / ${totalStations} 個監測站`);
            }
        }

        // 清除篩選
        function clearFilters() {
            document.getElementById('countyFilter').value = '';
            document.getElementById('districtFilter').innerHTML = '<option value="">選擇鄉鎮區</option>';
            document.getElementById('searchInput').value = '';
            filteredStations = [...debrisFlowStations];
            renderStations();
        }



        // 顯示監測站詳細資訊 (修正版：點擊影像直達原始連結)
        function showStationDetails(stationId) {
            const station = debrisFlowStations.find(s => s.id === stationId);
            if (!station) return;

            const modal = document.getElementById('stationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = station.name;
            
            // 準備連結地址 (如果沒有影像連結，就設為 #)
            const linkUrl = station.image ? station.image : '#';
            const linkTarget = station.image ? 'target="_blank"' : '';
            const cursorStyle = station.image ? 'cursor: pointer;' : 'cursor: default;';

            modalBody.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- 左側：影像區 -->
                    <div>
                        <!-- ✨ 修改重點：用 <a> 包住整個影像區域，點擊直接開啟新視窗 -->
                        <a href="${linkUrl}" ${linkTarget} style="text-decoration: none; display: block;" title="點擊開啟原始影像">
                            ${station.image ? `
                            <div style="position: relative; width: 100%; height: 250px; border-radius: 8px; overflow: hidden;">
                                <img src="${station.image}" alt="${station.name}" 
                                     style="width: 100%; height: 100%; object-fit: cover;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                
                                <!-- 載入失敗時顯示的區塊 (也包含在連結內) -->
                                <div style="display:none; width: 100%; height: 100%; background: linear-gradient(135deg, #795548, #5D4037); 
                                            align-items: center; justify-content: center; color: white; flex-direction: column;">
                                    <i class="fas fa-external-link-alt" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.8;"></i>
                                    <div style="font-size: 1.1rem; font-weight: bold;">點擊前往原始頁面</div>
                                    <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.8;">(影像無法預覽)</div>
                                </div>
                            </div>
                            ` : `
                            <!-- 完全無網址時顯示 -->
                            <div style="width: 100%; height: 250px; background: #ccc; 
                                        border-radius: 8px; display: flex; align-items: center; justify-content: center; 
                                        color: #666; flex-direction: column;">
                                <i class="fas fa-video-slash" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <div>無影像連結</div>
                            </div>
                            `}
                        </a>
                        
                        <!-- 下方增加顯眼的按鈕 -->
                        ${station.image ? `
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="${station.image}" target="_blank" 
                               style="display: inline-block; background: #007bff; color: white; text-decoration: none; 
                                      padding: 10px 20px; border-radius: 5px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s;">
                                <i class="fas fa-external-link-alt"></i> 直達原始影像頁面
                            </a>
                        </div>
                        ` : ''}
                    </div>

                    <!-- 右側：資訊區 -->
                    <div>
                        <h4 style="margin-bottom: 15px; color: #795548; font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                            <i class="fas fa-info-circle"></i> 監測站資訊
                        </h4>
                        <div style="line-height: 1.8;">
                            <p><strong>監測編號：</strong>${station.id}</p>
                            <p><strong>縣市：</strong>${station.county || '未提供'}</p>
                            <p><strong>行政區：</strong>${station.district || '未提供'}</p>
                            <p><strong>架設地點：</strong>${station.address || '未提供'}</p>
                            <p><strong>座標：</strong>
                                <a href="https://www.google.com/maps?q=${station.coordinates.lat},${station.coordinates.lng}" target="_blank" style="color: #007bff; text-decoration: none;">
                                    ${station.coordinates.lat.toFixed(6)}, ${station.coordinates.lng.toFixed(6)} <i class="fas fa-map-marker-alt"></i>
                                </a>
                            </p>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 12px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #007bff;">
                            <div style="font-size: 0.9rem; color: #0c5460; font-weight: bold;">
                                <i class="fas fa-database"></i> 資料來源
                            </div>
                            <div style="font-size: 0.85rem; margin-top: 5px; color: #333;">
                                農業部土石流觀測站影像資料庫 (UDL013)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; color: #999; font-size: 0.9rem;">
                    <i class="fas fa-clock"></i> 資料更新時間：${formatDateTime(station.lastUpdate)}
                </div>
            `;

            modal.style.display = 'block';
        }



        // 設置事件監聽器
        function setupEventListeners() {
            // 篩選事件
            document.getElementById('countyFilter').addEventListener('change', onCountyChange);
            document.getElementById('districtFilter').addEventListener('change', filterStations);
            document.getElementById('searchInput').addEventListener('input', filterStations);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);

            // 彈窗關閉事件
            document.querySelector('.close').addEventListener('click', function() {
                document.getElementById('stationModal').style.display = 'none';
            });

            // 點擊彈窗外部關閉
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('stationModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // 頁面載入完成後初始化
        window.addEventListener('load', initializePage);


    </script>
    <script src="assets/dark-mode.js"></script>

    <!-- Back to Top Button -->
    <div class="back-to-top" id="backToTop" style="position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999; font-size: 1.2rem;">
        <i class="fas fa-arrow-up"></i>
    </div>
</body>
</html>
