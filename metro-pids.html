<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>捷運旅客資訊系統 (PIDS) ‧ 宣導版</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&family=Roboto:wght@700;900&display=swap">
    <style>
        :root { --p-500: #00bcd4; --surface: #ffffff; --text-main: #0f172a; --text-sub: #475569; --danger: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #000; color: var(--text-main); font-family: 'Noto Sans TC', sans-serif; height: 100vh; overflow: hidden; display: flex; }
        .pids-container { display: grid; grid-template-columns: 380px 1fr; grid-template-rows: 1fr 90px; width: 100%; height: 100%; }
        .sidebar { background: var(--surface); display: flex; flex-direction: column; border-right: 2px solid #ddd; }
        .header { background: var(--p-500); padding: 25px 20px; display: flex; align-items: center; gap: 15px; color: white; }
        .st-code { background: white; color: var(--p-500); font-weight: 900; padding: 5px 15px; border-radius: 8px; font-size: 1.8rem; }
        .st-name { font-size: 2.2rem; font-weight: 900; }
        .platform-card { padding: 25px 20px; border-bottom: 2px solid #eee; flex: 1; display: flex; flex-direction: column; }
        .platform-label { font-size: 1.1rem; font-weight: 900; color: #888; margin-bottom: 10px; }
        .train-dest { font-size: 2.8rem; font-weight: 900; color: #000; }
        .time-box { background: #2d333b; color: #4fc3f7; text-align: center; padding: 20px; border-radius: 15px; font-size: 4rem; font-family: 'Roboto'; font-weight: 900; margin-top: auto; }
        .time-box.arriving { background: var(--danger); color: white; animation: pulse 1s infinite; }
        .main-view { display: grid; grid-template-rows: 1fr 120px; background: #000; }
        #video-player { width: 100%; height: 100%; border: none; }
        .congestion-bar { background: white; display: flex; align-items: center; padding: 0 40px; gap: 20px; }
        .car { height: 50px; flex: 1; border-radius: 8px; background: #10b981; }
        .car.med { background: #f59e0b; }
        .car.high { background: #ef4444; }
        .footer { grid-column: 1 / 3; background: #111; display: grid; grid-template-columns: 380px 1fr; color: white; border-top: 4px solid #333; }
        .clock { background: var(--danger); display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: 900; }
        .marquee-wrapper { overflow: hidden; display: flex; align-items: center; background: #000; }
        .marquee-content { white-space: nowrap; font-size: 2rem; font-weight: 700; color: #fff; padding-left: 100%; animation: scroll 50s linear infinite; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="pids-container">
        <nav class="sidebar">
            <header class="header">
                <span class="st-code" id="st-id">--</span>
                <h1 class="st-name" id="st-name">載入中...</h1>
            </header>
            <section class="platform-card">
                <div class="platform-label" id="p1-label">第一月台 Platform 1</div>
                <div class="train-dest" id="p1-dest">---</div>
                <div class="time-box" id="p1-time">--:--</div>
            </section>
            <section class="platform-card" style="background:#f9f9f9">
                <div class="platform-label" id="p2-label">第二月台 Platform 2</div>
                <div class="train-dest" id="p2-dest">---</div>
                <div class="time-box" id="p2-time">--:--</div>
            </section>
        </nav>

        <main class="main-view">
            <iframe id="video-player" src=""></iframe>
            <div class="congestion-bar">
                <div style="font-weight:900; color:var(--p-500); font-size:1.5rem; margin-right:20px;">車廂擁擠度</div>
                <div class="car"></div><div class="car"></div><div class="car med"></div><div class="car"></div><div class="car high"></div><div class="car"></div>
            </div>
        </main>

        <footer class="footer">
            <div class="clock" id="clock">00:00</div>
            <div class="marquee-wrapper">
                <div class="marquee-content" id="marquee">正在初始化系統...</div>
            </div>
        </footer>
    </div>

    <script>
        const WORKER_URL = 'https://metro-api-worker.xiaoyouwu5-fd3.workers.dev/api';
        const params = new URLSearchParams(window.location.search);
        const sys = params.get('system') || 'TRTC';
        const station = params.get('station') || 'BL12';

        const psas = [
            "發現性騷擾及異常事件,協助制止、迅速通報,一同維護社會安全。",
            "遇緊急狀況保持冷靜勿驚慌,請使用對講機通知服務人員處理。",
            "提高警覺,注意身旁人、事、物,遇異常狀況,立即撥打110及通報服務人員。",
            "捷運系統全面禁止吸菸(含電子菸等類菸品),違者依法最高可處新台幣1萬元罰鍰。",
            "搭乘電扶梯兩側皆可站立、避免使用手機；電扶梯出入口請勿逗留。"
        ];

        async function refresh() {
            try {
                const [liveData, alertData] = await Promise.all([
                    fetch(`${WORKER_URL}/liveboard?sys=${sys}`).then(r => r.json()),
                    fetch(`${WORKER_URL}/liveboard?sys=${sys}&type=Alert`).then(r => r.json())
                ]);

                // 渲染看板
                const filtered = liveData.filter(t => t.StationID === station || t.StationID.endsWith(station));
                if (filtered.length > 0) {
                    document.getElementById('st-name').innerText = filtered[0].StationName?.Zh_tw || station;
                    document.getElementById('st-id').innerText = station;
                    const groups = {};
                    filtered.forEach(t => { if (!groups[t.Direction]) groups[t.Direction] = t; });
                    const keys = Object.keys(groups).sort();
                    renderPlatform(1, groups[keys[0]]);
                    renderPlatform(2, groups[keys[1]]);
                }

                // 渲染跑馬燈 (Alert + PSAs)
                let msg = alertData.map(a => `【重要通報】${a.Description || a.Title}`).join('　　');
                document.getElementById('marquee').innerText = (msg ? msg + '　　' : '') + psas.join('　　') + '　　祝您旅途愉快！';
            } catch (e) { console.error(e); }
        }

        function renderPlatform(id, t) {
            const dest = document.getElementById(`p${id}-dest`);
            const time = document.getElementById(`p${id}-time`);
            if (!t) { dest.innerText = "暫無班次"; time.innerText = "--:--"; return; }
            dest.innerText = t.DestinationStationName?.Zh_tw || "---";
            const secs = t.EstimateTime;
            if (secs <= 45) { time.innerText = "進站中"; time.classList.add('arriving'); }
            else if (secs <= 90) { time.innerText = "即將進站"; time.classList.remove('arriving'); }
            else { time.innerText = `${Math.floor(secs/60)} : 00`; time.classList.remove('arriving'); }
        }

        setInterval(refresh, 20000);
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}); }, 1000);
        
        // 延遲加載影片
        setTimeout(() => { document.getElementById('video-player').src = "https://www.youtube.com/embed/83pL6-v6_nU?autoplay=1&mute=1&loop=1&playlist=83pL6-v6_nU&controls=0"; }, 1500);
        refresh();
    </script>
</body>
</html>
