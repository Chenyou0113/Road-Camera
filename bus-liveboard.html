<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£å…¬è»Šå³æ™‚å‹•æ…‹è¿½è¹¤ç³»çµ±</title>
    <!-- Leaflet åœ°åœ–å¥—ä»¶ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            background: #f5f7fa;
        }
        
        #controls { 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        #controls strong {
            font-size: 1.3rem;
            font-weight: 900;
            margin-right: 10px;
        }
        
        #main { 
            display: flex; 
            flex: 1; 
            overflow: hidden; 
        }
        
        #stop-list { 
            width: 380px; 
            overflow-y: auto; 
            background: #ffffff;
            border-right: 2px solid #e5e7eb;
            padding: 15px;
        }
        
        #map { 
            flex: 1; 
            position: relative;
        }
        
        .stop-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 14px 16px; 
            background: white; 
            margin-bottom: 8px; 
            border-radius: 12px; 
            border-left: 5px solid #bdc3c7;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stop-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .stop-name { 
            font-weight: 700; 
            color: #1f2937;
            font-size: 1.05rem;
        }
        
        .stop-sequence {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            text-align: center;
            line-height: 26px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-right: 10px;
        }
        
        /* ç¥¨åƒ¹åˆ†æ®µæ¨£å¼ */
        .fare-info-banner {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            color: #2c3e50;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 0.95rem;
            text-align: center;
            box-shadow: 0 3px 8px rgba(241, 196, 15, 0.3);
            border: 2px solid #f39c12;
        }
        
        .fare-info-banner i {
            margin-right: 6px;
        }
        
        /* ç·©è¡å€ç«™ç‰Œç‰¹æ®Šæ¨£å¼ */
        .stop-item.in-buffer {
            border-left-color: #f1c40f;
            background: linear-gradient(to right, #fffdf0 0%, #ffffff 100%);
            box-shadow: 0 2px 10px rgba(241, 196, 15, 0.15);
        }
        
        .buffer-tag {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            color: #2c3e50;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            border: 1px solid #f39c12;
        }
        
        .fare-section-start {
            border-top: 3px dashed #f1c40f;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .fare-section-end {
            border-bottom: 3px dashed #f1c40f;
            padding-bottom: 8px;
            margin-bottom: 8px;
        }
        
        /* ç¥¨åƒ¹åˆ†æ®µæ¨£å¼ */
        .fare-info-banner {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            color: #2c3e50;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 0.95rem;
            text-align: center;
            box-shadow: 0 3px 8px rgba(241, 196, 15, 0.3);
            border: 2px solid #f39c12;
        }
        
        .fare-info-banner i {
            margin-right: 6px;
        }
        
        /* ç·©è¡å€ç«™ç‰Œç‰¹æ®Šæ¨£å¼ */
        .stop-item.in-buffer {
            border-left-color: #f1c40f;
            background: linear-gradient(to right, #fffdf0 0%, #ffffff 100%);
            box-shadow: 0 2px 10px rgba(241, 196, 15, 0.15);
        }
        
        .buffer-tag {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            color: #2c3e50;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 6px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            border: 1px solid #f39c12;
        }
        
        .fare-section-start {
            border-top: 3px dashed #f1c40f;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .fare-section-end {
            border-bottom: 3px dashed #f1c40f;
            padding-bottom: 8px;
            margin-bottom: 8px;
        }
        
        .arrival-time { 
            padding: 8px 14px; 
            border-radius: 8px; 
            font-size: 15px; 
            font-weight: 900; 
            min-width: 80px; 
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* æ™‚é–“é¡è‰² */
        .time-now { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; animation: pulse 1.5s infinite; }
        .time-soon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .time-wait { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .time-none { background: #9ca3af; color: white; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        input, select, button { 
            padding: 10px 14px; 
            border-radius: 8px; 
            border: none;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 0.95rem;
        }
        
        input, select {
            background: rgba(255,255,255,0.95);
            color: #1f2937;
            font-weight: 600;
        }
        
        button { 
            background: #10b981;
            color: white; 
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            padding: 10px 24px;
        }
        
        button:hover { 
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        #update-status {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .city-legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 0.8rem;
            align-items: center;
        }
        
        .city-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 6px;
        }
        
        .city-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: #6b7280;
        }
        
        .route-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 900;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* åœ°åœ–ä¸Šçš„å…¬è»Šåœ–æ¨™ - å‡ç´šç‰ˆå¸¶æ–¹å‘ç®­é ­ */
        .bus-marker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .bus-icon-wrapper {
            background: linear-gradient(135deg, #d63031 0%, #e17055 100%);
            color: white;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(214, 48, 49, 0.6);
            transition: all 0.3s ease;
            animation: pulse-bus 2s infinite;
        }
        
        .bus-icon-wrapper:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(214, 48, 49, 0.8);
        }
        
        .bus-icon-wrapper i {
            font-size: 20px;
        }
        
        .bus-plate-label {
            background: rgba(45, 52, 54, 0.9);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 3px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }
        
        @keyframes pulse-bus {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        /* å…¬è»Šè©³ç´°è³‡è¨Šå½ˆçª—æ¨£å¼ */
        .bus-popup {
            min-width: 200px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .bus-popup-header {
            background: linear-gradient(135deg, #d63031 0%, #e17055 100%);
            color: white;
            padding: 12px;
            border-radius: 8px 8px 0 0;
            font-weight: 900;
            text-align: center;
            margin: -16px -20px 12px -20px;
            font-size: 1.1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .bus-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .bus-info-row:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .bus-info-label {
            color: #6b7280;
            font-size: 13px;
            font-weight: 600;
        }
        
        .bus-info-value {
            font-weight: 700;
            color: #1f2937;
            font-size: 14px;
        }
        
        .bus-popup-footer {
            font-size: 11px;
            color: #9ca3af;
            text-align: center;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        
        /* Leaflet Popup è‡ªè¨‚æ¨£å¼ */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content {
            margin: 16px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .popup-stop-title {
            font-size: 1.2rem;
            font-weight: 900;
            color: #667eea;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .popup-routes-container {
            max-height: 180px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            padding: 4px;
        }
        
        .popup-routes-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .popup-routes-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .popup-route-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .popup-route-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .popup-loading {
            text-align: center;
            padding: 20px;
            color: #9ca3af;
        }
        
        .popup-error {
            text-align: center;
            padding: 20px;
            color: #ef4444;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            #main { flex-direction: column; }
            #stop-list { width: 100%; max-height: 40%; }
            #controls { padding: 12px; }
            #controls strong { display: block; width: 100%; margin-bottom: 8px; }
        }
    </style>
</head>
<body>

<div id="controls">
    <strong><i class="fas fa-bus"></i> å…¬è»Šå³æ™‚è¿½è¹¤ç³»çµ±</strong>
    <div class="city-legend">
        <span style="opacity: 0.8;">åŸå¸‚ï¼š</span>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #667eea;"></div>
            <span>å°åŒ—</span>
        </div>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #10b981;"></div>
            <span>æ–°åŒ—</span>
        </div>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #f59e0b;"></div>
            <span>å°ä¸­</span>
        </div>
        <div class="city-legend-item">
            <div class="city-legend-color" style="background: #ef4444;"></div>
            <span>é«˜é›„</span>
        </div>
    </div>
    <select id="category">
        <option value="CityBus">å¸‚å€å…¬è»Š</option>
        <option value="InterCity">å…¬è·¯å®¢é‹</option>
    </select>
    <select id="city">
        <option value="Taipei">å°åŒ—å¸‚</option>
        <option value="NewTaipei">æ–°åŒ—å¸‚</option>
        <option value="Taoyuan">æ¡ƒåœ’å¸‚</option>
        <option value="Taichung">å°ä¸­å¸‚</option>
        <option value="Tainan">å°å—å¸‚</option>
        <option value="Kaohsiung">é«˜é›„å¸‚</option>
        <option value="Keelung">åŸºéš†å¸‚</option>
        <option value="Hsinchu">æ–°ç«¹å¸‚</option>
        <option value="HsinchuCounty">æ–°ç«¹ç¸£</option>
        <option value="MiaoliCounty">è‹—æ —ç¸£</option>
        <option value="ChanghwaCounty">å½°åŒ–ç¸£</option>
        <option value="NantouCounty">å—æŠ•ç¸£</option>
        <option value="YunlinCounty">é›²æ—ç¸£</option>
        <option value="ChiayiCounty">å˜‰ç¾©ç¸£</option>
        <option value="Chiayi">å˜‰ç¾©å¸‚</option>
        <option value="PingtungCounty">å±æ±ç¸£</option>
        <option value="YilanCounty">å®œè˜­ç¸£</option>
        <option value="HualienCounty">èŠ±è“®ç¸£</option>
        <option value="TaitungCounty">å°æ±ç¸£</option>
        <option value="KinmenCounty">é‡‘é–€ç¸£</option>
        <option value="PenghuCounty">æ¾æ¹–ç¸£</option>
        <option value="LienchiangCounty">é€£æ±Ÿç¸£</option>
    </select>
    <div style="position: relative; flex: 1;">
        <input type="text" id="routeNum" placeholder="ğŸ“ è¼¸å…¥è·¯ç·š (å¦‚ 307ã€æ•¦åŒ–...)" style="width: 100%;" oninput="filterRoutes()">
        <!-- æœå°‹å»ºè­°ä¸‹æ‹‰èœå–® -->
        <div id="route-suggestions" style="
            position: absolute; 
            width: 100%; 
            max-height: 200px; 
            overflow-y: auto; 
            background: white; 
            z-index: 2000; 
            display: none; 
            border: 2px solid #667eea; 
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        "></div>
    </div>
    <select id="direction">
        <option value="0">å»ç¨‹</option>
        <option value="1">è¿”ç¨‹</option>
    </select>
    <button onclick="startTracking()"><i class="fas fa-search"></i> è¿½è¹¤è·¯ç·š</button>
    <span id="update-status"></span>
</div>

<div id="main">
    <div id="stop-list">
        <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <h3>ğŸŒ æ¢ç´¢æ¨¡å¼</h3>
            <p>æ­£åœ¨è¼‰å…¥å…¨å°ç†±é–€è·¯ç·šè»Šè¼›...</p>
            <div style="margin-top: 15px; font-size: 0.85rem; color: #9ca3af;">
                <p>ğŸ’¡ <strong>æç¤ºï¼š</strong></p>
                <p>â€¢ åœ°åœ–æœƒè‡ªå‹•é¡¯ç¤ºå„åŸå¸‚è»Šè¼›</p>
                <p>â€¢ é»æ“Šè»Šè¼›æŸ¥çœ‹è©³ç´°è³‡è¨Š</p>
                <p>â€¢ è¼¸å…¥è·¯ç·šè™Ÿå¯åˆ‡æ›å–®ä¸€è·¯ç·šæ¨¡å¼</p>
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>

<script>
    /*
     * ============================================
     * å°ç£å…¬è»Šå³æ™‚è¿½è¹¤ç³»çµ± - æŠ€è¡“èªªæ˜
     * ============================================
     * 
     * ã€åº§æ¨™æ ¼å¼èªªæ˜ã€‘
     * TDX API æä¾›å…©ç¨®è·¯ç·šåº§æ¨™æ ¼å¼ï¼š
     * 
     * 1. Geometry (WKTæ ¼å¼) âœ… ç›®å‰ä½¿ç”¨
     *    ç¯„ä¾‹: "LINESTRING (121.565 25.065, 121.566 25.066, ...)"
     *    - å„ªé»ï¼šäººé¡å¯è®€ï¼Œå®¹æ˜“é™¤éŒ¯ï¼Œç„¡éœ€é¡å¤–å¥—ä»¶
     *    - ç¼ºé»ï¼šè³‡æ–™é‡è¼ƒå¤§ï¼ˆç´„ 5-10KBï¼‰
     * 
     * 2. EncodedPolyline (Googleå£“ç¸®æ ¼å¼) ğŸ”§ å·²å¯¦ä½œä½†æœªå•Ÿç”¨
     *    ç¯„ä¾‹: "afpVwCwahdV~iB..." (çœ‹èµ·ä¾†åƒäº‚ç¢¼)
     *    - å„ªé»ï¼šè³‡æ–™é‡æ¥µå°ï¼ˆç´„ 1-2KBï¼‰ï¼Œç¯€çœ 80% æµé‡
     *    - ç¼ºé»ï¼šéœ€è¦è§£ç¢¼æ¼”ç®—æ³•ï¼ˆå·²å…§å»ºæ‰‹å‹•è§£ç¢¼å‡½å¼ï¼‰
     * 
     * ğŸ’¡ å¦‚éœ€å•Ÿç”¨ EncodedPolyline æ”¯æ´ï¼š
     *    åªéœ€ç¢ºä¿ Worker å›å‚³çš„è³‡æ–™åŒ…å« EncodedPolyline æ¬„ä½å³å¯ï¼Œ
     *    ç³»çµ±æœƒè‡ªå‹•åµæ¸¬ä¸¦ä½¿ç”¨æ‰‹å‹•è§£ç¢¼å‡½å¼è™•ç†ã€‚
     * 
     * ============================================
     */
    
    const WORKER_URL = 'https://bus-worker.weacamm.org/';
    let map, stopMarkers = [], busMarkers = [];
    let pollingTimer = null;
    let currentStops = [];
    let currentRouteLine = null; // è·¯ç·šç·šå‹åœ–å±¤
    let allBusMarkers = []; // æ‰€æœ‰è·¯ç·šçš„è»Šè¼›æ¨™è¨˜
    let isExploreMode = true; // æ¢ç´¢æ¨¡å¼ï¼ˆé¡¯ç¤ºæ‰€æœ‰è»Šè¼›ï¼‰
    let bufferStops = []; // å„²å­˜ç·©è¡å€ç«™ç‰Œ UID
    let fareBufferZones = []; // å„²å­˜å®Œæ•´ç¥¨åƒ¹åˆ†æ®µè³‡è¨Š
    let currentZoomLevel = 12; // ç•¶å‰åœ°åœ–ç¸®æ”¾ç´šåˆ¥
    let vehicleCache = {}; // è»Šè¼›è¦æ ¼å¿«å–ï¼ˆé¿å…é‡è¤‡æŸ¥è©¢ï¼‰
    
    // ğŸ†• æœå°‹å»ºè­°ç³»çµ±
    let allRoutesCache = []; // æ‰€æœ‰è·¯ç·šçš„æœ¬åœ°å¿«å–
    const ROUTE_CACHE_KEY = 'tdx_routes_cache'; // localStorage éµå
    const ROUTE_CACHE_EXPIRE = 24 * 60 * 60 * 1000; // 24 å°æ™‚éæœŸ
    let searchTimer = null; // â±ï¸ Debounce è¨ˆæ™‚å™¨ï¼ˆé˜²æ­¢é »ç¹æŸ¥è©¢ D1ï¼‰

    // ç†±é–€è·¯ç·šé…ç½®ï¼ˆæœƒè‡ªå‹•è¼‰å…¥é€™äº›è·¯ç·šçš„è»Šè¼›ï¼‰
    const POPULAR_ROUTES = [
        { city: 'Taipei', routes: ['307', 'ç´…5', 'æ£•1', 'è—5', '617', 'æ•¦åŒ–å¹¹ç·š', 'ä¿¡ç¾©å¹¹ç·š'] },
        { city: 'NewTaipei', routes: ['è—37', 'ç¶ 2', 'æ©˜20', '842'] },
        { city: 'Taichung', routes: ['300', '301', '302', '303', '304', '305'] },
        { city: 'Kaohsiung', routes: ['ç´…51', 'ç´…52', 'ç´…53', 'æ©˜1', 'æ©˜7'] }
    ];

    // åˆå§‹åŒ–åœ°åœ–ï¼ˆä¿®å¤ SSL è¯ä¹¦é”™è¯¯ï¼šä½¿ç”¨ç¨³å®šçš„ OpenStreetMap æ ‡å‡†æœåŠ¡å™¨ï¼‰
    map = L.map('map').setView([25.0475, 121.5173], 12); // é è¨­å°åŒ—å¸‚
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | TDX',
        maxZoom: 19,
        crossOrigin: true
    }).addTo(map);
    
    // ç›£è½åœ°åœ–ç¸®æ”¾ç´šåˆ¥è®ŠåŒ–ï¼Œæ§åˆ¶ç«™ç‰Œé¡¯ç¤º
    map.on('zoomend', function() {
        currentZoomLevel = map.getZoom();
        console.log('ğŸ” ç•¶å‰ç¸®æ”¾ç´šåˆ¥:', currentZoomLevel);
        updateStopMarkersVisibility();
    });

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•é¡¯ç¤ºç†±é–€è·¯ç·šçš„è»Šè¼›
    window.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸš€ å•Ÿå‹•æ¢ç´¢æ¨¡å¼ï¼šè¼‰å…¥ç†±é–€è·¯ç·šè»Šè¼›...');
        // ğŸ†• éåŒæ­¥è¼‰å…¥æ‰€æœ‰è·¯ç·šä¾›æœå°‹å»ºè­°ä½¿ç”¨ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
        loadAllRoutes();
        loadPopularRoutesBuses();
        // æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡æ‰€æœ‰è»Šè¼›ä½ç½®
        setInterval(loadPopularRoutesBuses, 30000);
    });

    /**
     * è¼‰å…¥ç†±é–€è·¯ç·šçš„æ‰€æœ‰è»Šè¼›ï¼ˆæ¢ç´¢æ¨¡å¼ï¼‰
     */
    async function loadPopularRoutesBuses() {
        // â›” å¦‚æœå·²é€²å…¥å–®ä¸€è·¯ç·šè¿½è¹¤æ¨¡å¼ï¼Œå‰‡ä¸åŸ·è¡Œæ›´æ–°ï¼ˆé¿å…è·³å›æ¢ç´¢æ¨¡å¼ï¼‰
        if (!isExploreMode) {
            console.log('â„¹ï¸ æ­£åœ¨è¿½è¹¤è·¯ç·šä¸­ï¼Œè·³éæ¢ç´¢æ¨¡å¼æ›´æ–°');
            return;
        }
        
        console.log('ğŸ”„ æ›´æ–°æ¢ç´¢æ¨¡å¼è»Šè¼›ä½ç½®...');
        document.getElementById('update-status').innerHTML = '<i class="fas fa-sync fa-spin"></i> è¼‰å…¥å…¨å°è»Šè¼›...';
        
        // æ›´æ–°å´é‚Šæ¬„ç‹€æ…‹
        document.getElementById('stop-list').innerHTML = `
            <div class="route-header">
                <i class="fas fa-globe"></i> æ¢ç´¢æ¨¡å¼
                <div style="font-size: 0.9rem; font-weight: 600; margin-top: 4px; opacity: 0.9;">
                    æ­£åœ¨è¼‰å…¥ç†±é–€è·¯ç·š...
                </div>
            </div>
        `;
        
        // æ¸…é™¤èˆŠçš„è»Šè¼›æ¨™è¨˜
        allBusMarkers.forEach(m => map.removeLayer(m));
        allBusMarkers = [];
        
        let totalBuses = 0;
        const promises = [];
        const routeStats = {}; // è¨˜éŒ„æ¯æ¢è·¯ç·šçš„è»Šè¼›æ•¸
        
        // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰åŸå¸‚çš„ç†±é–€è·¯ç·š
        for (const cityGroup of POPULAR_ROUTES) {
            for (const route of cityGroup.routes) {
                promises.push(
                    fetchRouteBuses('CityBus', cityGroup.city, route)
                        .then(buses => {
                            if (buses && buses.length > 0) {
                                const key = `${cityGroup.city}-${route}`;
                                routeStats[key] = buses.length;
                                buses.forEach(bus => {
                                    createBusMarker(bus, route, cityGroup.city, true);
                                    totalBuses++;
                                });
                            }
                        })
                        .catch(err => console.warn(`âš ï¸ ${cityGroup.city} ${route} è¼‰å…¥å¤±æ•—:`, err))
                );
            }
        }
        
        await Promise.all(promises);
        
        // æ›´æ–°å´é‚Šæ¬„é¡¯ç¤ºè·¯ç·šçµ±è¨ˆ
        updateExploreSidebar(routeStats, totalBuses);
        
        document.getElementById('update-status').innerHTML = 
            `<i class="fas fa-globe"></i> æ¢ç´¢æ¨¡å¼ | ğŸšŒ ${totalBuses} å°è»Šè¼›é‹è¡Œä¸­ | ${new Date().toLocaleTimeString('zh-TW')}`;
        
        console.log(`âœ… æ¢ç´¢æ¨¡å¼ï¼šå·²é¡¯ç¤º ${totalBuses} å°è»Šè¼›`);
    }

    /**
     * æ›´æ–°æ¢ç´¢æ¨¡å¼å´é‚Šæ¬„
     */
    function updateExploreSidebar(routeStats, totalBuses) {
        const container = document.getElementById('stop-list');
        
        let html = `
            <div class="route-header">
                <i class="fas fa-globe"></i> æ¢ç´¢æ¨¡å¼
                <div style="font-size: 0.9rem; font-weight: 600; margin-top: 4px; opacity: 0.9;">
                    å…± ${totalBuses} å°è»Šè¼›é‹è¡Œä¸­
                </div>
            </div>
            <div style="padding: 10px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px;">
                <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 8px;">
                    <i class="fas fa-info-circle"></i> <strong>å¦‚ä½•ä½¿ç”¨ï¼š</strong>
                </div>
                <ul style="font-size: 0.85rem; color: #6b7280; margin-left: 20px;">
                    <li>é»æ“Šåœ°åœ–ä¸Šçš„è»Šè¼›æŸ¥çœ‹è©³æƒ…</li>
                    <li>ä¸åŒé¡è‰²ä»£è¡¨ä¸åŒåŸå¸‚</li>
                    <li>è¼¸å…¥è·¯ç·šè™Ÿå¯åˆ‡æ›å–®ä¸€è·¯ç·š</li>
                </ul>
            </div>
        `;
        
        // æŒ‰åŸå¸‚åˆ†çµ„é¡¯ç¤ºè·¯ç·š
        const cityGroups = {};
        for (const [key, count] of Object.entries(routeStats)) {
            const [city, route] = key.split('-');
            if (!cityGroups[city]) cityGroups[city] = [];
            cityGroups[city].push({ route, count });
        }
        
        for (const [city, routes] of Object.entries(cityGroups)) {
            const cityColors = {
                'Taipei': '#667eea',
                'NewTaipei': '#10b981',
                'Taichung': '#f59e0b',
                'Kaohsiung': '#ef4444'
            };
            const color = cityColors[city] || '#9ca3af';
            const cityName = getCityName(city);
            
            html += `
                <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${color};">
                    <div style="font-weight: 700; color: ${color}; margin-bottom: 8px; font-size: 1rem;">
                        ${cityName}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            `;
            
            routes.forEach(({ route, count }) => {
                html += `
                    <span style="background: ${color}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">
                        ${route} (${count})
                    </span>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }

    /**
     * ç²å–æŒ‡å®šè·¯ç·šçš„è»Šè¼›è³‡æ–™
     */
    async function fetchRouteBuses(category, city, route) {
        try {
            const url = `${WORKER_URL}?category=${category}&city=${city}&route=${encodeURIComponent(route)}`;
            const res = await fetch(url);
            if (!res.ok) return [];
            const data = await res.json();
            return data.buses || [];
        } catch (e) {
            return [];
        }
    }

    /**
     * å‰µå»ºè»Šè¼›æ¨™è¨˜ï¼ˆå¯ç”¨æ–¼å–®ä¸€è·¯ç·šæˆ–æ¢ç´¢æ¨¡å¼ï¼‰
     */
    function createBusMarker(bus, routeName, cityName, isExploreMode = false) {
        const azimuth = bus.azi || 0;
        const cityColors = {
            'Taipei': '#667eea',
            'NewTaipei': '#10b981',
            'Taichung': '#f59e0b',
            'Kaohsiung': '#ef4444'
        };
        const markerColor = isExploreMode ? (cityColors[cityName] || '#d63031') : '#d63031';
        
        const busIcon = L.divIcon({
            className: '',
            html: `
                <div class="bus-marker-container">
                    <div class="bus-icon-wrapper" style="transform: rotate(${azimuth}deg); background: linear-gradient(135deg, ${markerColor} 0%, ${markerColor}dd 100%);">
                        <i class="fas fa-location-arrow"></i>
                    </div>
                    ${isExploreMode ? `<div class="bus-plate-label" style="background: ${markerColor};">${routeName}</div>` : `<div class="bus-plate-label">${bus.plate || 'æœªçŸ¥'}</div>`}
                </div>
            `,
            iconSize: [45, 60],
            iconAnchor: [22, 30]
        });
        
        const marker = L.marker([bus.lat, bus.lon], { icon: busIcon }).addTo(map);
        
        // åˆå§‹ Popupï¼ˆé»æ“Šå¾Œæ‰è¼‰å…¥è©³ç´°è³‡è¨Šï¼‰
        const statusColor = (bus.status === 0 || bus.status === undefined) ? '#10b981' : '#ef4444';
        const statusText = (bus.status === 0 || bus.status === undefined) ? 'æ­£å¸¸è¡Œé§›' : 'ç‹€æ…‹ç•°å¸¸';
        const directionText = bus.dir == 0 ? 'å»ç¨‹ â¡ï¸' : 'è¿”ç¨‹ â¬…ï¸';
        const directionName = getDirectionName(azimuth);
        
        const basicPopupHtml = `
            <div class="bus-popup">
                <div class="bus-popup-header" style="background: linear-gradient(135deg, ${markerColor} 0%, ${markerColor}dd 100%);">
                    <i class="fas fa-bus"></i> ${routeName} ${bus.plate ? '(' + bus.plate + ')' : ''}
                </div>
                <div class="bus-info-row">
                    <span class="bus-info-label"><i class="fas fa-map-marked-alt"></i> åŸå¸‚</span>
                    <span class="bus-info-value">${getCityName(cityName)}</span>
                </div>
                <div class="bus-info-row">
                    <span class="bus-info-label"><i class="fas fa-route"></i> è¡Œé§›æ–¹å‘</span>
                    <span class="bus-info-value">${directionText}</span>
                </div>
                <div class="bus-info-row">
                    <span class="bus-info-label"><i class="fas fa-compass"></i> è»Šé ­æœå‘</span>
                    <span class="bus-info-value">${directionName} (${azimuth}Â°)</span>
                </div>
                <div class="bus-info-row">
                    <span class="bus-info-label"><i class="fas fa-circle-check"></i> é‹è¡Œç‹€æ…‹</span>
                    <span class="bus-info-value" style="color: ${statusColor};">${statusText}</span>
                </div>
                <div style="text-align:center; padding:10px; color:#667eea; font-size:0.85rem;">
                    <i class="fas fa-hand-pointer"></i> é»æ“ŠæŸ¥çœ‹è»Šè¼›è©³ç´°è¦æ ¼
                </div>
            </div>
        `;
        
        marker.bindPopup(basicPopupHtml);
        
        // ç¶å®šé»æ“Šäº‹ä»¶ï¼šå‹•æ…‹è¼‰å…¥è»Šè¼›è©³ç´°è³‡è¨Š
        marker.on('popupopen', () => {
            // åªåœ¨ popup æ‰“é–‹æ™‚æ‰æŸ¥è©¢è©³ç´°è³‡è¨Šï¼ˆé¿å…é‡è¤‡æŸ¥è©¢ï¼‰
            if (!marker._detailsLoaded) {
                getBusDetailHtml(bus, marker, routeName, cityName, markerColor);
                marker._detailsLoaded = true; // æ¨™è¨˜å·²è¼‰å…¥
            }
        });
        
        if (isExploreMode) {
            allBusMarkers.push(marker);
        } else {
            busMarkers.push(marker);
        }
        
        return marker;
    }

    /**
     * ç²å–åŸå¸‚ä¸­æ–‡åç¨±
     */
    function getCityName(cityCode) {
        const cityNames = {
            'Taipei': 'å°åŒ—å¸‚',
            'NewTaipei': 'æ–°åŒ—å¸‚',
            'Taichung': 'å°ä¸­å¸‚',
            'Tainan': 'å°å—å¸‚',
            'Kaohsiung': 'é«˜é›„å¸‚',
            'Taoyuan': 'æ¡ƒåœ’å¸‚'
        };
        return cityNames[cityCode] || cityCode;
    }
    
    /**
     * ç²å–è»Šè¼›è©³ç´°è¦æ ¼è³‡è¨Šä¸¦æ›´æ–° Popup
     * @param {Object} bus - è»Šè¼›åŸºæœ¬è³‡æ–™
     * @param {Object} marker - Leaflet æ¨™è¨˜ç‰©ä»¶
     * @param {string} routeName - è·¯ç·šåç¨±
     * @param {string} cityName - åŸå¸‚ä»£ç¢¼
     * @param {string} markerColor - æ¨™è¨˜é¡è‰²
     */
    async function getBusDetailHtml(bus, marker, routeName, cityName, markerColor) {
        const statusColor = (bus.status === 0 || bus.status === undefined) ? '#10b981' : '#ef4444';
        const statusText = (bus.status === 0 || bus.status === undefined) ? 'æ­£å¸¸è¡Œé§›' : 'ç‹€æ…‹ç•°å¸¸';
        const directionText = bus.dir == 0 ? 'å»ç¨‹ â¡ï¸' : 'è¿”ç¨‹ â¬…ï¸';
        const directionName = getDirectionName(bus.azi || 0);
        
        // 1. å…ˆé¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        const loadingHtml = `
            <div class="bus-popup">
                <div class="bus-popup-header" style="background: linear-gradient(135deg, ${markerColor} 0%, ${markerColor}dd 100%);">
                    <i class="fas fa-bus"></i> ${routeName} ${bus.plate ? '(' + bus.plate + ')' : ''}
                </div>
                <div class="bus-info-row">
                    <span class="bus-info-label"><i class="fas fa-map-marked-alt"></i> åŸå¸‚</span>
                    <span class="bus-info-value">${getCityName(cityName)}</span>
                </div>
                <div class="bus-info-row">
                    <span class="bus-info-label"><i class="fas fa-route"></i> è¡Œé§›æ–¹å‘</span>
                    <span class="bus-info-value">${directionText}</span>
                </div>
                <div style="padding:15px; text-align:center; color:#667eea;">
                    <i class="fas fa-spinner fa-spin" style="font-size:1.5rem;"></i>
                    <div style="margin-top:8px; font-size:0.9rem;">æŸ¥è©¢è»Šè¼›è¦æ ¼...</div>
                </div>
            </div>`;
        marker.setPopupContent(loadingHtml);
        
        try {
            // 2. æª¢æŸ¥å¿«å–
            let vehicleData = vehicleCache[bus.plate];
            
            if (!vehicleData) {
                // å‘ Worker æŸ¥è©¢è»Šè¼›è¦æ ¼
                const category = document.getElementById('category').value;
                const city = document.getElementById('city').value;
                const res = await fetch(`${WORKER_URL}?action=vehicle&plate=${bus.plate}&category=${category}&city=${city}`);
                vehicleData = await res.json();
                
                // å¿«å–çµæœ
                if (vehicleData && vehicleData.length > 0) {
                    vehicleCache[bus.plate] = vehicleData;
                    console.log('âœ… å·²å¿«å–è»Šè¼›è¦æ ¼:', bus.plate);
                }
            } else {
                console.log('ğŸ“¦ ä½¿ç”¨å¿«å–çš„è»Šè¼›è¦æ ¼:', bus.plate);
            }
            
            let details = "";
            if (vehicleData && vehicleData.length > 0) {
                const v = vehicleData[0];
                
                // è§£æå‡ºå» å¹´ä»½
                const buyYear = v.PurchaseTime ? new Date(v.PurchaseTime).getFullYear() : 'æœªçŸ¥';
                
                // è½‰æ›è»Šè¼›ç­‰ç´š (åƒè€ƒ PDF ç¬¬ 156 é )
                const vClassMap = { 
                    1: "å¤§å‹å·´å£«", 
                    2: "ä¸­å‹å·´å£«", 
                    3: "å°å‹å·´å£«", 
                    4: "é›™å±¤å·´å£«", 
                    5: "é›™ç¯€å·´å£«" 
                };
                const vClass = vClassMap[v.VehicleClass] || "ä¸€èˆ¬å·´å£«";
                
                // ç‡Ÿé‹æ¥­è€…åç¨±å°ç…§
                const operatorName = v.OperatorName?.Zh_tw || v.OperatorCode || 'æœªçŸ¥æ¥­è€…';
                
                // æº–å‚™é…å‚™åœ–ç¤º
                const features = [];
                if (v.IsElectric === 1) features.push('<span style="background:#2ecc71; color:white; padding:3px 8px; border-radius:4px; font-size:0.8rem; display:inline-block; margin:2px;">âš¡ é›»å‹•è»Š</span>');
                if (v.IsLowFloor === 1) features.push('<span style="background:#3498db; color:white; padding:3px 8px; border-radius:4px; font-size:0.8rem; display:inline-block; margin:2px;">â™¿ ä½åœ°æ¿</span>');
                if (v.HasLiftOrRamp === 1) features.push('<span style="background:#9b59b6; color:white; padding:3px 8px; border-radius:4px; font-size:0.8rem; display:inline-block; margin:2px;">ğŸ¦½ å‡é™è¨­å‚™</span>');
                if (v.HasWifi === 1) features.push('<span style="background:#f1c40f; color:#2c3e50; padding:3px 8px; border-radius:4px; font-size:0.8rem; display:inline-block; margin:2px; font-weight:700;">ğŸ“¶ WiFi</span>');
                
                details = `
                    <hr style="border:none; border-top:2px solid #e5e7eb; margin:10px 0;">
                    <div style="padding:0 5px;">
                        <div class="bus-info-row">
                            <span class="bus-info-label"><i class="fas fa-building"></i> ç‡Ÿé‹æ¥­è€…</span>
                            <span class="bus-info-value">${operatorName}</span>
                        </div>
                        <div class="bus-info-row">
                            <span class="bus-info-label"><i class="fas fa-bus-simple"></i> è»Šè¼›é¡å‹</span>
                            <span class="bus-info-value">${vClass}</span>
                        </div>
                        <div class="bus-info-row">
                            <span class="bus-info-label"><i class="fas fa-calendar-alt"></i> å‡ºå» å¹´ä»½</span>
                            <span class="bus-info-value">${buyYear} å¹´</span>
                        </div>
                        ${features.length > 0 ? `
                        <div style="margin-top:10px; padding:8px; background:#f8f9fa; border-radius:6px;">
                            <div style="font-size:0.85rem; color:#6b7280; margin-bottom:5px; font-weight:600;">
                                <i class="fas fa-star"></i> è»Šè¼›é…å‚™
                            </div>
                            <div style="line-height:1.8;">${features.join(' ')}</div>
                        </div>` : ''}
                    </div>
                `;
            } else {
                details = `
                    <hr style="border:none; border-top:2px solid #e5e7eb; margin:10px 0;">
                    <div style="text-align:center; color:#9ca3af; padding:15px; font-size:0.9rem;">
                        <i class="fas fa-info-circle"></i> æš«ç„¡æ­¤è»Šè¼›çš„è©³ç´°è¦æ ¼è³‡æ–™
                    </div>
                `;
            }
            
            // 3. çµ„åˆæœ€çµ‚ Popup å…§å®¹
            const finalHtml = `
                <div class="bus-popup">
                    <div class="bus-popup-header" style="background: linear-gradient(135deg, ${markerColor} 0%, ${markerColor}dd 100%);">
                        <i class="fas fa-bus"></i> ${routeName} ${bus.plate ? '(' + bus.plate + ')' : ''}
                    </div>
                    <div class="bus-info-row">
                        <span class="bus-info-label"><i class="fas fa-map-marked-alt"></i> åŸå¸‚</span>
                        <span class="bus-info-value">${getCityName(cityName)}</span>
                    </div>
                    <div class="bus-info-row">
                        <span class="bus-info-label"><i class="fas fa-route"></i> è¡Œé§›æ–¹å‘</span>
                        <span class="bus-info-value">${directionText}</span>
                    </div>
                    <div class="bus-info-row">
                        <span class="bus-info-label"><i class="fas fa-compass"></i> è»Šé ­æœå‘</span>
                        <span class="bus-info-value">${directionName} (${bus.azi || 0}Â°)</span>
                    </div>
                    <div class="bus-info-row">
                        <span class="bus-info-label"><i class="fas fa-circle-check"></i> é‹è¡Œç‹€æ…‹</span>
                        <span class="bus-info-value" style="color: ${statusColor};">${statusText}</span>
                    </div>
                    ${details}
                    <div class="bus-popup-footer" style="background:#f8f9fa; padding:8px; text-align:center; font-size:0.75rem; color:#9ca3af; border-top:1px solid #e5e7eb;">
                        <i class="fas fa-database"></i> è³‡æ–™ä¾†æºï¼šTDX | <i class="fas fa-clock"></i> ${new Date().toLocaleTimeString('zh-TW')}
                    </div>
                </div>
            `;
            marker.setPopupContent(finalHtml);
            
        } catch (e) {
            console.error('âŒ ç²å–è»Šè¼›è©³ç´°è³‡è¨Šå¤±æ•—:', e);
            marker.setPopupContent(`
                <div class="bus-popup">
                    <div class="bus-popup-header" style="background: #e74c3c;">
                        <i class="fas fa-exclamation-triangle"></i> è®€å–å¤±æ•—
                    </div>
                    <div style="padding:15px; text-align:center; color:#e74c3c;">
                        <i class="fas fa-times-circle" style="font-size:2rem;"></i>
                        <div style="margin-top:8px;">ç„¡æ³•è¼‰å…¥è»Šè¼›è©³ç´°è³‡è¨Š</div>
                        <div style="font-size:0.8rem; color:#95a5a6; margin-top:5px;">${e.message}</div>
                    </div>
                </div>
            `);
        }
    }

    async function startTracking() {
        // åˆ‡æ›åˆ°å–®ä¸€è·¯ç·šæ¨¡å¼
        isExploreMode = false;
        
        // æ¸…é™¤æ¢ç´¢æ¨¡å¼çš„è»Šè¼›
        allBusMarkers.forEach(m => map.removeLayer(m));
        allBusMarkers = [];
        
        // æ¸…é™¤æ¢ç´¢æ¨¡å¼çš„ç«™é»æ¨™è¨˜
        stopMarkers.forEach(m => map.removeLayer(m));
        stopMarkers = [];
        
        const category = document.getElementById('category').value;
        const city = document.getElementById('city').value;
        const route = document.getElementById('routeNum').value.trim();
        const direction = document.getElementById('direction').value;

        if (!route) {
            alert('âš ï¸ è«‹è¼¸å…¥è·¯ç·šè™Ÿç¢¼');
            // é‡æ–°å•Ÿå‹•æ¢ç´¢æ¨¡å¼
            isExploreMode = true;
            loadPopularRoutesBuses();
            return;
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        document.getElementById('stop-list').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <h3>æ­£åœ¨è¼‰å…¥è·¯ç·šè³‡è¨Š...</h3>
            </div>
        `;

        try {
            // 1. å…ˆæŸ¥è©¢ç¥¨åƒ¹è³‡è¨Šï¼ˆå¦‚æœæœ‰åˆ†æ®µæ”¶è²»ï¼‰
            await fetchFareInfo(category, city, route, direction);
            
            // 2. æŠ“å–ç«™ç‰Œåˆ—è¡¨ (éœæ…‹è³‡æ–™)
            const stopListInfo = await fetchStops(category, city, route, direction);
            if (!stopListInfo || stopListInfo.length === 0) {
                document.getElementById('stop-list').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>æŸ¥ç„¡æ­¤è·¯ç·š</h3>
                        <p>è«‹ç¢ºèªè·¯ç·šè™Ÿç¢¼æ˜¯å¦æ­£ç¢º</p>
                    </div>
                `;
                return;
            }

            // 3. æª¢æŸ¥æ˜¯å¦æœ‰å¦ä¸€å€‹æ–¹å‘
            let hasBothDirections = false;
            let otherDirectionStops = null;
            try {
                const otherDir = direction === '0' ? '1' : '0';
                otherDirectionStops = await fetchStops(category, city, route, otherDir);
                if (otherDirectionStops && otherDirectionStops.length > 0) {
                    hasBothDirections = true;
                }
            } catch (e) {
                hasBothDirections = false;
            }

            // 4. ä¿å­˜å…©å€‹æ–¹å‘çš„è³‡è¨Šä¾›å¾ŒçºŒä½¿ç”¨
            window.route_directions = {
                current: direction,
                stops0: direction === '0' ? stopListInfo : otherDirectionStops,
                stops1: direction === '1' ? stopListInfo : otherDirectionStops,
                hasBoth: hasBothDirections,
                route: route,
                category: category,
                city: city
            };

            currentStops = stopListInfo;
            renderStops(stopListInfo, route, direction, category, city, hasBothDirections, otherDirectionStops);
            
            // å˜—è©¦ç¹ªè£½è·¯ç·šç·šå‹ï¼ˆå¯é¸åŠŸèƒ½ï¼‰
            try {
                await drawRouteShape(city, route, category);

            } catch (e) {
                console.log('ç„¡æ³•ç¹ªè£½è·¯ç·šç·šå‹:', e);
            }

            // 2. å•Ÿå‹•å®šæ™‚è¼ªè©¢ (æ¯ 20 ç§’å‘¼å«ä¸€æ¬¡ Worker)
            if (pollingTimer) clearInterval(pollingTimer);
            fetchDynamicData(category, city, route, direction);
            pollingTimer = setInterval(() => fetchDynamicData(category, city, route, direction), 20000);
        } catch (err) {
            console.error('å•Ÿå‹•è¿½è¹¤å¤±æ•—:', err);
            document.getElementById('stop-list').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-times-circle"></i>
                    <h3>è¼‰å…¥å¤±æ•—</h3>
                    <p>${err.message}</p>
                </div>
            `;
        }
    }

    // æŠ“å–å‹•æ…‹è³‡æ–™ (å‘¼å« Worker)
    async function fetchDynamicData(category, city, route, direction) {
        document.getElementById('update-status').innerHTML = '<i class="fas fa-sync fa-spin"></i> æ›´æ–°ä¸­...';
        try {
            const url = `${WORKER_URL}?category=${category}&city=${city}&route=${encodeURIComponent(route)}`;
            console.log('ğŸ“¡ æ­£åœ¨ç²å–å‹•æ…‹è³‡æ–™:', url);
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            
            const data = await res.json();
            console.log('ğŸ“¦ æ”¶åˆ°çš„æ•¸æ“š:', data);
            console.log('ğŸšŒ è»Šè¼›æ•¸æ“š:', data.buses);
            console.log('â° åˆ°ç«™æ™‚é–“:', data.estimates);

            // æ›´æ–°åˆ°ç«™æ™‚é–“
            if (data.estimates) {
                updateArrivalTimes(data.estimates, direction);
            } else {
                console.warn('âš ï¸ æ²’æœ‰åˆ°ç«™æ™‚é–“è³‡æ–™');
            }

            // æ›´æ–°è»Šè¼›ä½ç½®
            if (data.buses && data.buses.length > 0) {
                console.log(`âœ… æ‰¾åˆ° ${data.buses.length} å°è»Šè¼›`);
                updateBusPositions(data.buses, direction);
            } else {
                console.warn('âš ï¸ ç›®å‰æ²’æœ‰è»Šè¼›åœ¨ç·šä¸Šé‹è¡Œ');
                document.getElementById('update-status').innerHTML = 
                    `<i class="fas fa-info-circle"></i> ç›®å‰ç„¡è»Šè¼›è³‡æ–™ - ${new Date().toLocaleTimeString('zh-TW')}`;
            }
            
            const now = new Date();
            if (data.buses && data.buses.length > 0) {
                document.getElementById('update-status').innerHTML = 
                    `<i class="fas fa-check-circle"></i> æœ€å¾Œæ›´æ–°: ${now.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit', second: '2-digit'})} | ğŸšŒ ${data.buses.length} å°è»Š`;
            }
        } catch (err) {
            console.error('âŒ å‹•æ…‹è³‡æ–™å–å¾—å¤±æ•—:', err);
            document.getElementById('update-status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> é€£ç·šå¤±æ•—';
        }
    }

    function renderStops(stops, routeName, direction, category, city, hasBothDirections = false, otherDirectionStops = null) {
        const container = document.getElementById('stop-list');
        const directionText = direction === '0' ? 'å»ç¨‹' : 'è¿”ç¨‹';
        
        // ç¥¨åƒ¹åˆ†æ®µæ©«å¹…
        let fareInfoHTML = '';
        if (fareBufferZones.length > 0) {
            const zone = fareBufferZones[0];
            // å„ªå…ˆä½¿ç”¨æ–°çš„ startName/endNameï¼Œå†é€€è€Œæ±‚å…¶æ¬¡ç”¨åµŒå¥—çµæ§‹
            const originName = zone.startName || 
                              zone.FareBufferZoneOrigin?.OriginStopName?.Zh_tw || 
                              zone.FareBufferZoneOrigin?.OriginStopName?.En ||
                              'èµ·é»';
            const destName = zone.endName ||
                            zone.FareBufferZoneDestination?.DestinationStopName?.Zh_tw ||
                            zone.FareBufferZoneDestination?.DestinationStopName?.En ||
                            'çµ‚é»';
            fareInfoHTML = `
                <div class="fare-info-banner">
                    <i class="fas fa-coins"></i> åˆ†æ®µæ”¶è²»è·¯ç·š
                    <div style="font-size: 0.85rem; margin-top: 4px; opacity: 0.9;">
                        ç·©è¡å€ï¼š<strong>${originName}</strong> â†” <strong>${destName}</strong>
                    </div>
                </div>
            `;
        }
        
        // å»ºç«‹æ–¹å‘é¸æ“‡å¡ï¼ˆå¦‚æœæœ‰ä¸¡å€‹æ–¹å‘ï¼‰
        let directionTabsHTML = '';
        if (hasBothDirections) {
            directionTabsHTML = `
                <div style="display: flex; gap: 8px; margin-bottom: 12px; padding: 0;">
                    <button class="direction-tab" id="tab-dir0" 
                            onclick="switchDirectionTab('0')" 
                            style="flex: 1; padding: 10px; background: ${direction === '0' ? '#667eea' : '#e5e7eb'}; color: ${direction === '0' ? 'white' : '#6b7280'}; border: none; border-radius: 6px; cursor: pointer; font-weight: ${direction === '0' ? '700' : '600'}; font-size: 0.95rem; transition: all 0.2s;">
                        â¡ï¸ å»ç¨‹
                    </button>
                    <button class="direction-tab" id="tab-dir1" 
                            onclick="switchDirectionTab('1')" 
                            style="flex: 1; padding: 10px; background: ${direction === '1' ? '#667eea' : '#e5e7eb'}; color: ${direction === '1' ? 'white' : '#6b7280'}; border: none; border-radius: 6px; cursor: pointer; font-weight: ${direction === '1' ? '700' : '600'}; font-size: 0.95rem; transition: all 0.2s;">
                        â¬…ï¸ è¿”ç¨‹
                    </button>
                </div>
            `;
        }
        
        container.innerHTML = `
            ${fareInfoHTML}
            ${directionTabsHTML}
            <div class="route-header">
                <i class="fas fa-route"></i> ${routeName} ${directionText}
                <div style="font-size: 0.9rem; font-weight: 600; margin-top: 4px; opacity: 0.9;">
                    å…± ${stops.length} ç«™
                </div>
            </div>
        `;
        
        // æ¸…é™¤åœ°åœ–èˆŠ Marker
        stopMarkers.forEach(m => map.removeLayer(m));
        stopMarkers = [];

        stops.forEach((stop, index) => {
            // åˆ¤æ–·æ˜¯å¦ç‚ºç·©è¡å€å…§ç«™ç‰Œ
            const isInBuffer = bufferStops.includes(stop.uid);
            const isBufferStart = isInBuffer && bufferStops.indexOf(stop.uid) === 0;
            const isBufferEnd = isInBuffer && bufferStops.indexOf(stop.uid) === bufferStops.length - 1;
            
            const div = document.createElement('div');
            div.className = 'stop-item' + (isInBuffer ? ' in-buffer' : '');
            if (isBufferStart) div.classList.add('fare-section-start');
            if (isBufferEnd) div.classList.add('fare-section-end');
            div.id = `stop-${stop.uid}`;
            div.style.cursor = 'pointer'; // âœ¨ é¡¯ç¤ºå¯é»æ“Šæ¸¸æ¨™
            div.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <span class="stop-sequence">${stop.sequence || (index + 1)}</span>
                    <span class="stop-name">${stop.name}</span>
                    ${isInBuffer ? '<span class="buffer-tag">ç·©è¡å€</span>' : ''}
                </div>
                <span class="arrival-time time-none">è®€å–ä¸­</span>
            `;
            
            // âœ¨ é»æ“Šç«™ç‰Œæ™‚è·³è½‰åˆ°åœ°åœ–ä¸Šçš„è©²ç«™é»
            div.addEventListener('click', () => {
                centerToStop(stop);
            });
            div.addEventListener('mouseenter', () => {
                div.style.backgroundColor = '#f0f0ff';
            });
            div.addEventListener('mouseleave', () => {
                div.style.backgroundColor = '';
            });
            
            container.appendChild(div);

            // åŠ åˆ°åœ°åœ– - ä½¿ç”¨ L.divIcon é¡¯ç¤ºæ•¸å­—æ¨™è¨˜
            const markerColor = isInBuffer ? '#f1c40f' : '#667eea';
            const stopNumber = stop.sequence || (index + 1);
            
            const busIcon = L.divIcon({
                html: `
                    <div style="
                        background: ${markerColor};
                        color: white;
                        border: 3px solid white;
                        border-radius: 50%;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 700;
                        font-size: 14px;
                        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                    ">${stopNumber}</div>
                `,
                className: '',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            
            const marker = L.marker([stop.lat, stop.lon], { icon: busIcon })
                .bindPopup(`
                    <b>${stopNumber}. ${stop.name}</b>
                    ${isInBuffer ? '<br><span style="color: #f39c12; font-weight: 700;">ğŸ« åˆ†æ®µç·©è¡å€</span>' : ''}
                    <br><small>é»æ“ŠæŸ¥çœ‹ç¶“éè·¯ç·š</small>
                `);
            
            // è¨˜éŒ„ç«™ç‰Œç´¢å¼•ï¼Œç”¨æ–¼ç¸®æ”¾æ§åˆ¶
            marker._stopIndex = index;
            marker._isBufferStop = isInBuffer;
            
            // ç¶å®šé»æ“Šäº‹ä»¶ï¼šæŸ¥è©¢ç¶“éæ­¤ç«™çš„æ‰€æœ‰è·¯ç·š
            marker.on('click', async () => {
                marker.bindPopup('<div class="popup-loading"><i class="fas fa-spinner fa-spin"></i><br>æŸ¥è©¢è·¯ç·šä¸­...</div>').openPopup();
                
                const city = document.getElementById('city').value;
                const category = document.getElementById('category').value;
                
                try {
                    const routes = await fetchStopRoutes(city, stop.name, category);
                    
                    let popupContent = `
                        <div style="min-width: 220px;">
                            <div class="popup-stop-title">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${stop.name}</span>
                            </div>
                            <hr style="margin: 10px 0; border: none; border-top: 2px solid #e5e7eb;">
                            <div style="font-weight: 700; font-size: 0.95rem; color: #6b7280; margin-bottom: 6px;">
                                <i class="fas fa-bus"></i> ç¶“éçš„è·¯ç·š (${routes.length})
                            </div>
                            <div class="popup-routes-container">
                    `;
                    
                    if (routes.length === 0) {
                        popupContent += `
                            <div style="color: #9ca3af; text-align: center; padding: 20px; width: 100%;">
                                <i class="fas fa-info-circle"></i><br>
                                æš«ç„¡è·¯ç·šè³‡æ–™
                            </div>
                        `;
                    } else {
                        routes.forEach(routeName => {
                            popupContent += `
                                <span class="popup-route-badge" 
                                      onclick="switchToRoute('${routeName.replace(/'/g, "\\'")}')"
                                      title="é»æ“Šåˆ‡æ›åˆ° ${routeName} è·¯ç·š">
                                    ${routeName}
                                </span>
                            `;
                        });
                    }
                    
                    popupContent += `
                            </div>
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 0.75rem; color: #9ca3af; text-align: center;">
                                ğŸ’¡ é»æ“Šè·¯ç·šè™Ÿç¢¼å¯å¿«é€Ÿåˆ‡æ›
                            </div>
                        </div>
                    `;
                    
                    marker.setPopupContent(popupContent);
                } catch (e) {
                    console.error('æŸ¥è©¢è·¯ç·šå¤±æ•—:', e);
                    marker.setPopupContent(`
                        <div class="popup-error">
                            <i class="fas fa-times-circle"></i><br>
                            ç„¡æ³•å–å¾—è·¯ç·šè³‡è¨Š<br>
                            <small>${e.message}</small>
                        </div>
                    `);
                }
            });
            
            // å°‡æ¨™è¨˜åŠ åˆ°åœ°åœ–ä¸Šï¼ˆåˆå§‹å¯èƒ½éš±è—ï¼Œç”±ç¸®æ”¾ç´šåˆ¥æ§åˆ¶ï¼‰
            marker.addTo(map);
            stopMarkers.push(marker);
        });

        // èª¿æ•´åœ°åœ–è¦–è§’ä»¥é¡¯ç¤ºæ‰€æœ‰ç«™ç‰Œ
        if (stops.length > 0) {
            const bounds = L.latLngBounds(stops.map(s => [s.lat, s.lon]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        // åˆå§‹åŒ–ç«™ç‰Œå¯è¦‹æ€§ï¼ˆåŸºæ–¼ç•¶å‰ç¸®æ”¾ç´šåˆ¥ï¼‰
        updateStopMarkersVisibility();
    }

    /**
     * ğŸ¯ é»æ“Šç«™ç‰Œæ™‚è·³è½‰åˆ°åœ°åœ–ä¸Šçš„è©²ä½ç½®
     */
    function centerToStop(stop) {
        if (!stop || !stop.lat || !stop.lon) {
            console.warn('âŒ ç«™é»åº§æ¨™ä¸å®Œæ•´:', stop);
            return;
        }
        
        // åœ°åœ–å¹³æ»‘ç§»å‹•åˆ°è©²ç«™é»ï¼Œç¸®æ”¾ç´šåˆ¥è¨­ç‚º 17ï¼ˆé©åˆæŸ¥çœ‹å–®å€‹ç«™é»ï¼‰
        map.setView([stop.lat, stop.lon], 17, { animate: true, duration: 0.8 });
        
        // å°‹æ‰¾ä¸¦æ‰“é–‹è©²ç«™çš„ Popup
        stopMarkers.forEach(marker => {
            if (marker.getLatLng().lat === stop.lat && marker.getLatLng().lng === stop.lon) {
                marker.openPopup();
            }
        });
        
        console.log(`ğŸ“ è·³è½‰åˆ°ç«™é»: ${stop.name}`);
    }
    
    /**
     * åˆ‡æ›è·¯ç·šæ–¹å‘é¸é …å¡
     */
    async function switchDirectionTab(newDirection) {
        if (!window.route_directions) return;
        
        const dir = window.route_directions;
        
        // æ›´æ–°ç•¶å‰æ–¹å‘æ¨™è¨˜
        dir.current = newDirection;
        
        // ç²å–æ–°æ–¹å‘çš„ç«™é»
        const stops = newDirection === '0' ? dir.stops0 : dir.stops1;
        
        // æ›´æ–°ç•¶å‰ç«™é»
        currentStops = stops;
        
        // é‡æ–°æŸ¥è©¢ç¥¨åƒ¹è³‡è¨Šï¼ˆé‡å°æ–°æ–¹å‘ï¼‰
        try {
            await fetchFareInfo(dir.category, dir.city, dir.route, newDirection);
        } catch (e) {
            console.log('ç„¡æ³•å–å¾—æ–°æ–¹å‘çš„ç¥¨åƒ¹è³‡è¨Š:', e);
        }
        
        // é‡æ–°æ¸²æŸ“ç«™é»é¡¯ç¤º
        renderStops(stops, dir.route, newDirection, dir.category, dir.city, dir.hasBoth, null);
        
        // å•Ÿå‹•æ–°æ–¹å‘çš„å‹•æ…‹è³‡æ–™æ›´æ–°
        if (pollingTimer) clearInterval(pollingTimer);
        fetchDynamicData(dir.category, dir.city, dir.route, newDirection);
        pollingTimer = setInterval(() => fetchDynamicData(dir.category, dir.city, dir.route, newDirection), 20000);
        
        console.log(`ğŸ”„ åˆ‡æ›è‡³ ${newDirection === '0' ? 'å»ç¨‹' : 'è¿”ç¨‹'}`);
    }
    
    /**
     * æ ¹æ“šåœ°åœ–ç¸®æ”¾ç´šåˆ¥æ§åˆ¶ç«™ç‰Œæ¨™è¨˜çš„é¡¯ç¤º/éš±è—
     * 
     * åœ¨å–®ä¸€è·¯ç·šæ¨¡å¼ä¸‹ï¼šç¸®æ”¾ç´šåˆ¥ >= 15 æ™‚é¡¯ç¤ºæ‰€æœ‰ç«™ç‰Œ
     * åœ¨æ¢ç´¢æ¨¡å¼ä¸‹ï¼šä¸é¡¯ç¤ºç«™ç‰Œæ¨™è¨˜ï¼ˆé¿å…åœ°åœ–æ“æ“ ï¼‰
     */
    function updateStopMarkersVisibility() {
        const SHOW_ALL_STOPS_ZOOM = 15; // é¡¯ç¤ºæ‰€æœ‰ç«™ç‰Œçš„æœ€å°ç¸®æ”¾ç´šåˆ¥
        
        stopMarkers.forEach(marker => {
            const isBufferStop = marker._isBufferStop || false;
            
            // åœ¨å–®ä¸€è·¯ç·šæ¨¡å¼ä¸‹ï¼šæ ¹æ“šç¸®æ”¾ç´šåˆ¥æ±ºå®šæ˜¯å¦é¡¯ç¤º
            if (!isExploreMode) {
                // åªåœ¨ç¸®æ”¾ç´šåˆ¥ >= 15 æ™‚é¡¯ç¤º
                if (currentZoomLevel >= SHOW_ALL_STOPS_ZOOM) {
                    if (!map.hasLayer(marker)) {
                        marker.addTo(map);
                    }
                } else {
                    if (map.hasLayer(marker)) {
                        map.removeLayer(marker);
                    }
                }
            } else {
                // æ¢ç´¢æ¨¡å¼ä¸‹ï¼Œç¸½æ˜¯ä¸é¡¯ç¤ºç«™ç‰Œæ¨™è¨˜ï¼ˆä¸è¦æ“æ“ åœ°åœ–ï¼‰
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            }
        });
        
        console.log(`ğŸ—ºï¸ ç¸®æ”¾ç´šåˆ¥ ${currentZoomLevel}: ${!isExploreMode && currentZoomLevel >= SHOW_ALL_STOPS_ZOOM ? 'é¡¯ç¤ºæ‰€æœ‰ç«™ç‰Œ' : 'éš±è—ç«™ç‰Œ'}`);
    }

    function updateArrivalTimes(estimates, direction) {
        // å…ˆå°‡æ‰€æœ‰ç«™ç‰Œè¨­ç‚ºç„¡è³‡æ–™
        currentStops.forEach(stop => {
            const el = document.querySelector(`#stop-${stop.uid} .arrival-time`);
            if (el) {
                el.innerText = 'æœªç™¼è»Š';
                el.className = 'arrival-time time-none';
            }
        });

        // æ›´æ–°æœ‰è³‡æ–™çš„ç«™ç‰Œ
        for (const [key, value] of Object.entries(estimates)) {
            const [dir, stopUID] = key.split('_');
            if (dir !== direction) continue;

            const el = document.querySelector(`#stop-${stopUID} .arrival-time`);
            if (!el) continue;

            let text = '';
            let statusClass = 'time-wait';

            if (value.sec === null || value.sec === undefined) {
                text = (value.status === 1) ? 'æœªç™¼è»Š' : 'æœ«ç­å·²é';
                statusClass = 'time-none';
            } else if (value.sec < 60) {
                text = 'é€²ç«™ä¸­';
                statusClass = 'time-now';
            } else if (value.sec < 180) {
                text = 'å°‡åˆ°ç«™';
                statusClass = 'time-soon';
            } else {
                const mins = Math.floor(value.sec / 60);
                text = `${mins} åˆ†`;
                statusClass = 'time-wait';
            }

            el.innerText = text;
            el.className = `arrival-time ${statusClass}`;
        }
    }

    /**
     * æ›´æ–°å…¬è»Šä½ç½®ï¼ˆå‡ç´šç‰ˆï¼‰- ç”¨æ–¼å–®ä¸€è·¯ç·šæ¨¡å¼
     * 
     * æ–°åŠŸèƒ½ï¼š
     * - å¸¶æ–¹å‘ç®­é ­çš„æ—‹è½‰åœ–æ¨™ï¼ˆæ ¹æ“šæ–¹ä½è§’ azi è‡ªå‹•æ—‹è½‰ï¼‰
     * - è»Šç‰Œæ¨™ç±¤é¡¯ç¤ºåœ¨åœ–æ¨™ä¸‹æ–¹
     * - ç²¾ç¾çš„è©³ç´°è³‡è¨Šå½ˆçª—
     * 
     * @param {Array} buses - å…¬è»Šä½ç½®é™£åˆ—
     * @param {string} direction - ç•¶å‰é¸æ“‡çš„æ–¹å‘ï¼ˆå»ç¨‹/è¿”ç¨‹ï¼‰
     */
    function updateBusPositions(buses, direction) {
        // åªåœ¨å–®ä¸€è·¯ç·šæ¨¡å¼ä¸‹é‹ä½œ
        if (isExploreMode) return;
        
        console.log('ğŸšŒ é–‹å§‹æ›´æ–°è»Šè¼›ä½ç½®ï¼ˆå–®ä¸€è·¯ç·šæ¨¡å¼ï¼‰');
        console.log('   ç¸½è»Šè¼›æ•¸:', buses ? buses.length : 0);
        console.log('   ç¯©é¸æ–¹å‘:', direction === '0' ? 'å»ç¨‹' : 'è¿”ç¨‹');
        
        // æ¸…é™¤èˆŠçš„è»Šè¼›æ¨™è¨˜
        busMarkers.forEach(m => map.removeLayer(m));
        busMarkers = [];

        if (!buses || buses.length === 0) {
            console.warn('âš ï¸ æ²’æœ‰è»Šè¼›è³‡æ–™');
            return;
        }

        // ç¯©é¸ç¬¦åˆæ–¹å‘çš„è»Šè¼›
        const filteredBuses = buses.filter(b => b.dir == direction);
        console.log(`   ç¬¦åˆæ–¹å‘çš„è»Šè¼›: ${filteredBuses.length} å°`);

        if (filteredBuses.length === 0) {
            console.warn('âš ï¸ è©²æ–¹å‘ç›®å‰æ²’æœ‰è»Šè¼›é‹è¡Œ');
            return;
        }

        // ç²å–ç•¶å‰è·¯ç·šå’ŒåŸå¸‚
        const route = document.getElementById('routeNum').value.trim();
        const city = document.getElementById('city').value;

        filteredBuses.forEach((bus, index) => {
            console.log(`   è»Šè¼› ${index + 1}:`, {
                è»Šç‰Œ: bus.plate,
                ç·¯åº¦: bus.lat,
                ç¶“åº¦: bus.lon,
                æ–¹ä½è§’: bus.azi,
                æ–¹å‘: bus.dir === 0 ? 'å»ç¨‹' : 'è¿”ç¨‹'
            });

            createBusMarker(bus, route, city, false);
        });

        console.log(`âœ… å·²åœ¨åœ°åœ–ä¸Šæ¨™è¨˜ ${filteredBuses.length} å°è»Šè¼›`);
    }
    
    /**
     * å°‡æ–¹ä½è§’è½‰æ›ç‚ºæ–¹å‘æ–‡å­—
     * @param {number} azimuth - æ–¹ä½è§’ (0-360åº¦)
     * @returns {string} æ–¹å‘æ–‡å­—
     */
    function getDirectionName(azimuth) {
        const directions = [
            { name: 'æ­£åŒ— â¬†ï¸', min: 0, max: 22.5 },
            { name: 'æ±åŒ— â†—ï¸', min: 22.5, max: 67.5 },
            { name: 'æ­£æ± â¡ï¸', min: 67.5, max: 112.5 },
            { name: 'æ±å— â†˜ï¸', min: 112.5, max: 157.5 },
            { name: 'æ­£å— â¬‡ï¸', min: 157.5, max: 202.5 },
            { name: 'è¥¿å— â†™ï¸', min: 202.5, max: 247.5 },
            { name: 'æ­£è¥¿ â¬…ï¸', min: 247.5, max: 292.5 },
            { name: 'è¥¿åŒ— â†–ï¸', min: 292.5, max: 337.5 },
            { name: 'æ­£åŒ— â¬†ï¸', min: 337.5, max: 360 }
        ];
        
        for (const dir of directions) {
            if (azimuth >= dir.min && azimuth < dir.max) {
                return dir.name;
            }
        }
        
        return 'æœªçŸ¥æ–¹å‘';
    }

    /**
     * æŸ¥è©¢è·¯ç·šç¥¨åƒ¹åˆ†æ®µè³‡è¨Š
     */
    async function fetchFareInfo(category, city, route, direction) {
        try {
            const url = `${WORKER_URL}?action=fare&category=${category}&city=${city}&route=${encodeURIComponent(route)}`;
            console.log('ğŸ’° æŸ¥è©¢ç¥¨åƒ¹è³‡è¨Š:', url);
            const res = await fetch(url);
            
            if (!res.ok) {
                console.log('âš ï¸ ç„¡ç¥¨åƒ¹è³‡è¨Š');
                bufferStops = [];
                fareBufferZones = [];
                return;
            }
            
            const data = await res.json();
            console.log('ğŸ’° ç¥¨åƒ¹è³‡æ–™:', data);
            
            bufferStops = [];
            fareBufferZones = [];

            if (data && data.length > 0 && data[0].SectionFares) {
                const section = data[0].SectionFares;
                
                // ä½¿ç”¨ .find() ç²¾ç¢ºå®šä½ç•¶å‰æ–¹å‘çš„ç·©è¡å€
                const currentZone = section.BufferZones && section.BufferZones.find(z => z.Direction == direction);

                if (currentZone) {
                    try {
                        const startName = currentZone.FareBufferZoneOrigin?.OriginStopName?.Zh_tw || 
                                        currentZone.FareBufferZoneOrigin?.OriginStopName?.En ||
                                        'èµ·é»';
                        const endName = currentZone.FareBufferZoneDestination?.DestinationStopName?.Zh_tw ||
                                       currentZone.FareBufferZoneDestination?.DestinationStopName?.En ||
                                       'çµ‚é»';
                        
                        // å­˜å…¥å…¨åŸŸè®Šæ•¸ï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“ç«™ç‰Œæ¸…å–®æ™‚å°æ‡‰é¡è‰²
                        if (currentZone.FareBufferZoneOrigin?.OriginStopUID) {
                            bufferStops.push(currentZone.FareBufferZoneOrigin.OriginStopUID);
                        }
                        if (currentZone.FareBufferZoneDestination?.DestinationStopUID) {
                            bufferStops.push(currentZone.FareBufferZoneDestination.DestinationStopUID);
                        }
                        fareBufferZones.push({
                            startName: startName,
                            endName: endName,
                            ...currentZone
                        });
                        
                        console.log(`âœ… ç¥¨åƒ¹ç·©è¡å€: ${startName} â†” ${endName}`);
                        console.log('ğŸ« ç·©è¡å€ UID:', bufferStops);
                    } catch (e) {
                        console.error('âŒ è§£æç«™åå¤±æ•—:', e);
                    }
                } else {
                    console.log('â„¹ï¸ æ­¤æ–¹å‘ç„¡åˆ†æ®µæ”¶è²»');
                }
            } else {
                console.log('â„¹ï¸ æŸ¥ç„¡åˆ†æ®µç¥¨åƒ¹è³‡æ–™ï¼Œå¯èƒ½ç‚ºä¸€æ®µç¥¨');
            }
        } catch (e) {
            console.error('âŒ ç¥¨åƒ¹è³‡è¨ŠæŸ¥è©¢å¤±æ•—:', e);
            bufferStops = [];
            fareBufferZones = [];
        }
    }
    
    // è¼”åŠ©å‡½å¼ï¼šæŠ“å–ç«™ç‰Œ (é€é Worker) - çµ‚æ¥µé™¤éŒ¯ç‰ˆ
    async function fetchStops(category, city, route, direction) {
        const url = `${WORKER_URL}?action=info&category=${category}&city=${city}&route=${encodeURIComponent(route)}`;
        try {
            console.log('ğŸ“ æ­£åœ¨è«‹æ±‚ç«™ç‰Œè³‡è¨Š:', url);
            const res = await fetch(url);
            const data = await res.json();
            
            console.log('ğŸ“¦ Worker å›å‚³åŸå§‹è³‡æ–™:', data); // é—œéµé™¤éŒ¯è³‡è¨Š
            
            // ğŸš¨ é—œéµï¼šæª¢æŸ¥ Worker æ˜¯å¦å›å‚³äº†å°è£éçš„éŒ¯èª¤è¨Šæ¯
            if (data.error) {
                throw new Error(`Worker éŒ¯èª¤: ${data.message || data.error}`);
            }

            // æª¢æŸ¥æ˜¯å¦ç‚ºç©ºé™£åˆ—ï¼ˆæ‰¾ä¸åˆ°è·¯ç·šï¼‰
            if (!Array.isArray(data) || data.length === 0) {
                throw new Error(`TDX æ‰¾ä¸åˆ°è·¯ç·šã€Œ${route}ã€çš„è³‡æ–™ï¼Œè«‹ç¢ºèªè™Ÿç¢¼æ˜¯å¦æ­£ç¢ºã€‚\nğŸ’¡ å»ºè­°æ¸¬è©¦ï¼šå°åŒ—å¸‚ 307ã€262ã€æ•¦åŒ–å¹¹ç·š`);
            }

            // å°‹æ‰¾å°æ‡‰æ–¹å‘
            let routeInfo = data.find(r => r.Direction == direction);
            
            if (!routeInfo) {
                // å¦‚æœæ‰¾ä¸åˆ°è©²æ–¹å‘ï¼Œå¯èƒ½è©²è·¯ç·šæ˜¯å¾ªç’°ç·šï¼ˆåªæœ‰å»ç¨‹ï¼‰
                console.warn(`âš ï¸ æ‰¾ä¸åˆ°æ–¹å‘ ${direction}ï¼Œå˜—è©¦è‡ªå‹•è¼‰å…¥ç¬¬ä¸€ç­†è³‡æ–™`);
                console.log('ğŸ“‹ å¯ç”¨æ–¹å‘åˆ—è¡¨:', data.map(d => `æ–¹å‘${d.Direction}: ${d.RouteName?.Zh_tw || 'æœªçŸ¥è·¯ç·š'}`));
                
                if (data[0] && data[0].Stops) {
                    routeInfo = data[0];
                    // åŒæ­¥ä¿®æ­£ä»‹é¢ä¸Šçš„ä¸‹æ‹‰é¸å–®ï¼Œé¿å…èª¤å°
                    document.getElementById('direction').value = data[0].Direction;
                    console.log(`âœ… å·²è‡ªå‹•åˆ‡æ›è‡³æ–¹å‘ ${data[0].Direction}`);
                } else {
                    throw new Error('è·¯ç·šè³‡æ–™æ ¼å¼ç•°å¸¸ï¼Œç„¡æ³•è§£æç«™ç‰Œè³‡è¨Š');
                }
            }
            
            if (!routeInfo.Stops || routeInfo.Stops.length === 0) {
                throw new Error('æ­¤è·¯ç·šåœ¨ TDX è³‡æ–™åº«ä¸­ç„¡ç«™ç‰Œè³‡æ–™');
            }
            
            console.log(`âœ… æˆåŠŸè¼‰å…¥ ${routeInfo.Stops.length} å€‹ç«™ç‰Œ`);
            
            return routeInfo.Stops.map(s => ({
                uid: s.StopUID,
                name: s.StopName?.Zh_tw || s.StopName || 'æœªå‘½åç«™ç‰Œ',
                lat: s.StopPosition?.PositionLat || s.StopPosition?.Lat,
                lon: s.StopPosition?.PositionLon || s.StopPosition?.Lon,
                sequence: s.StopSequence // å®˜æ–¹ç«™åº
            }));
        } catch (e) {
            console.error('âŒ fetchStops å¤±æ•—:', e);
            throw e; // ä¸Ÿå‡ºçµ¦ startTracking çš„ UI é¡¯ç¤º
        }
    }

    // æŸ¥è©¢ç«™ç‰Œæœ‰å“ªäº›è·¯ç·šç¶“é
    async function fetchStopRoutes(city, stopName, category) {
        try {
            const url = `${WORKER_URL}?action=stop_info&city=${city}&name=${encodeURIComponent(stopName)}`;
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            
            const data = await res.json();
            return data.routes || [];
        } catch (e) {
            console.error('å–å¾—ç«™ç‰Œè·¯ç·šå¤±æ•—:', e);
            return [];
        }
    }
    
    /**
     * ç¹ªè£½è·¯ç·šç·šå‹åœ¨åœ°åœ–ä¸Š
     * 
     * æœƒè‡ªå‹•è™•ç†ä»¥ä¸‹æƒ…æ³ï¼š
     * - TDX å›å‚³å¤šå€‹æ–¹å‘ï¼ˆå»ç¨‹/è¿”ç¨‹ï¼‰æ™‚ï¼Œè‡ªå‹•é¸æ“‡ç•¶å‰æ–¹å‘
     * - æ”¯æ´ Geometry (WKT) å’Œ EncodedPolyline å…©ç¨®æ ¼å¼
     * - ç”¨æ¼¸å±¤è—ç´«è‰²ç¹ªè£½è·¯ç·šï¼Œå¢åŠ è™›ç·šæ•ˆæœæå‡è¾¨è­˜åº¦
     * 
     * @param {string} city - åŸå¸‚ä»£ç¢¼ (å¦‚ 'Taipei')
     * @param {string} route - è·¯ç·šç·¨è™Ÿ (å¦‚ '307')
     * @param {string} category - é¡åˆ¥ ('CityBus' æˆ– 'InterCity')
     */
    async function drawRouteShape(city, route, category) {
        // æ¸…é™¤èˆŠçš„è·¯ç·š
        if (currentRouteLine) {
            map.removeLayer(currentRouteLine);
            currentRouteLine = null;
        }
        
        try {
            const url = `${WORKER_URL}?action=shape&city=${city}&route=${encodeURIComponent(route)}&category=${category}`;
            const res = await fetch(url);
            
            if (!res.ok) {
                console.log('âš ï¸ ç„¡æ³•å–å¾—è·¯ç·šç·šå‹è³‡æ–™ (HTTP ' + res.status + ')');
                return;
            }
            
            const data = await res.json();
            
            if (!data || data.length === 0) {
                console.log('âš ï¸ æ­¤è·¯ç·šæ²’æœ‰æä¾›ç·šå‹è³‡æ–™');
                return;
            }
            
            // è™•ç†å¯èƒ½æœ‰å¤šå€‹æ–¹å‘çš„ç·šå‹ï¼ˆå»/è¿”ç¨‹ï¼‰
            const direction = document.getElementById('direction').value;
            let targetRoute = null;
            
            // å˜—è©¦æ‰¾åˆ°å°æ‡‰æ–¹å‘çš„ç·šå‹
            if (data.length > 1) {
                targetRoute = data.find(item => item.Direction == direction) || data[0];
            } else {
                targetRoute = data[0];
            }
            
            if (!targetRoute) return;
            
            // ä½¿ç”¨æ™ºèƒ½è§£æå™¨ï¼ˆè‡ªå‹•åˆ¤æ–·æ˜¯ Geometry é‚„æ˜¯ EncodedPolylineï¼‰
            const coordinates = parseRouteGeometry(targetRoute);
            
            if (coordinates.length > 0) {
                console.log(`âœ… æˆåŠŸè§£æè·¯ç·šç·šå‹ï¼Œå…± ${coordinates.length} å€‹åº§æ¨™é»`);
                
                currentRouteLine = L.polyline(coordinates, { 
                    color: '#667eea',        // è—ç´«è‰²
                    weight: 5,               // ç·šæ¢ç²—ç´°
                    opacity: 0.7,            // é€æ˜åº¦
                    dashArray: '10, 5',      // è™›ç·šæ¨£å¼
                    lineJoin: 'round',       // åœ“è§’
                    lineCap: 'round'         // ç«¯é»åœ“è§’
                }).addTo(map);
                
                console.log('ğŸ—ºï¸ è·¯ç·šå·²ç¹ªè£½åˆ°åœ°åœ–ä¸Š');
            } else {
                console.warn('âš ï¸ åº§æ¨™è§£æçµæœç‚ºç©º');
            }
        } catch (e) {
            console.error('âŒ ç¹ªè£½è·¯ç·šå¤±æ•—:', e);
        }
    }
    
    // ============================================
    // ğŸ“ åº§æ¨™æ ¼å¼è§£æå™¨
    // ============================================
    
    /**
     * è§£æ TDX API å›å‚³çš„è·¯ç·šåº§æ¨™
     * 
     * TDX æä¾›å…©ç¨®åº§æ¨™æ ¼å¼ï¼š
     * 1. Geometry (WKTæ ¼å¼): "LINESTRING (121.5 25.0, 121.51 25.01, ...)"
     *    - å„ªé»ï¼šäººé¡å¯è®€ï¼Œå®¹æ˜“é™¤éŒ¯
     *    - ç¼ºé»ï¼šè³‡æ–™é‡è¼ƒå¤§
     * 
     * 2. EncodedPolyline (Googleå£“ç¸®æ ¼å¼): "afpVwCwahdV..."
     *    - å„ªé»ï¼šè³‡æ–™é‡å°ï¼Œç¯€çœæµé‡
     *    - ç¼ºé»ï¼šéœ€è¦è§£ç¢¼ï¼Œçœ‹èµ·ä¾†åƒäº‚ç¢¼
     * 
     * æœ¬å‡½å¼å„ªå…ˆä½¿ç”¨ Geometryï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å˜—è©¦è§£ç¢¼ EncodedPolyline
     */
    function parseRouteGeometry(routeData) {
        // å„ªå…ˆä½¿ç”¨ Geometry (WKT æ ¼å¼)
        if (routeData.Geometry) {
            return parseWktLineString(routeData.Geometry);
        }
        
        // å‚™ç”¨æ–¹æ¡ˆï¼šè§£ç¢¼ EncodedPolyline
        if (routeData.EncodedPolyline) {
            return decodePolyline(routeData.EncodedPolyline);
        }
        
        console.warn('è·¯ç·šè³‡æ–™ä¸­æ²’æœ‰æ‰¾åˆ° Geometry æˆ– EncodedPolyline');
        return [];
    }
    
    /**
     * è§£æ WKT LINESTRING æ ¼å¼ï¼ˆå„ªåŒ–ç‰ˆï¼‰
     * 
     * WKT ç¯„ä¾‹: "LINESTRING (121.565 25.065, 121.566 25.066, ...)"
     * æ¯å€‹åº§æ¨™å°æ˜¯ "ç¶“åº¦ ç·¯åº¦" çš„æ ¼å¼
     */
    function parseWktLineString(wkt) {
        try {
            if (!wkt || typeof wkt !== 'string') return [];
            
            // æ”¯æ´å¤šç¨® WKT æ ¼å¼: LINESTRING, MULTILINESTRING
            let coordString = wkt;
            
            // è™•ç† LINESTRING
            if (wkt.toUpperCase().includes('LINESTRING')) {
                coordString = wkt.replace(/.*LINESTRING\s*\(/i, "").replace(/\)[^)]*$/, "").trim();
            }
            
            // è™•ç† MULTILINESTRING (å–ç¬¬ä¸€æ®µ)
            if (wkt.toUpperCase().includes('MULTILINESTRING')) {
                const match = wkt.match(/\(\(([^)]+)\)\)/);
                if (match) coordString = match[1];
            }
            
            // è§£æåº§æ¨™å°
            const pairs = coordString.split(",").map(p => p.trim()).filter(p => p);
            
            return pairs.map(pair => {
                // æ”¯æ´ç©ºæ ¼æˆ– tab åˆ†éš”
                const coords = pair.trim().split(/\s+/);
                if (coords.length >= 2) {
                    const lon = parseFloat(coords[0]);
                    const lat = parseFloat(coords[1]);
                    // é©—è­‰ç¶“ç·¯åº¦ç¯„åœï¼ˆå°ç£å€åŸŸï¼šåŒ—ç·¯21-26åº¦ï¼Œæ±ç¶“119-122åº¦ï¼‰
                    if (!isNaN(lat) && !isNaN(lon) && 
                        lat >= 21 && lat <= 26 && 
                        lon >= 119 && lon <= 122) {
                        return [lat, lon]; // Leaflet ä½¿ç”¨ [ç·¯åº¦, ç¶“åº¦] é †åº
                    }
                }
                return null;
            }).filter(coord => coord !== null);
        } catch (e) {
            console.error('âŒ è§£æ WKT å¤±æ•—:', e);
            console.log('ğŸ“„ åŸå§‹è³‡æ–™å‰100å­—:', wkt?.substring(0, 100));
            return [];
        }
    }
    
    /**
     * è§£ç¢¼ Google EncodedPolyline æ ¼å¼ï¼ˆé¸ç”¨ï¼‰
     * 
     * EncodedPolyline ç¯„ä¾‹: "afpVwCwahdV~iB..." (çœ‹èµ·ä¾†åƒäº‚ç¢¼)
     * é€™æ˜¯ Google Maps çš„åº§æ¨™å£“ç¸®æ¼”ç®—æ³•ï¼Œå¯å¤§å¹…æ¸›å°‘è³‡æ–™å‚³è¼¸é‡
     * 
     * å¦‚æœéœ€è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè«‹åœ¨ HTML head ä¸­å¼•å…¥è§£ç¢¼åº«ï¼š
     * <script src="https:\/\/unpkg.com\/@mapbox\/polyline@1.1.1\/src\/polyline.js"><\/script>
     */
    function decodePolyline(encoded) {
        try {
            // æª¢æŸ¥æ˜¯å¦æœ‰å¼•å…¥ polyline è§£ç¢¼åº«
            if (typeof polyline !== 'undefined' && polyline.decode) {
                const decoded = polyline.decode(encoded);
                console.log('âœ… æˆåŠŸè§£ç¢¼ EncodedPolylineï¼Œå…±', decoded.length, 'å€‹åº§æ¨™é»');
                return decoded; // å·²ç¶“æ˜¯ [lat, lon] æ ¼å¼
            }
            
            // æ‰‹å‹•è§£ç¢¼å¯¦ä½œï¼ˆç°¡åŒ–ç‰ˆï¼‰
            console.warn('âš ï¸ æœªæ‰¾åˆ° polyline è§£ç¢¼åº«ï¼Œä½¿ç”¨æ‰‹å‹•è§£ç¢¼');
            return decodePolylineManual(encoded);
        } catch (e) {
            console.error('âŒ è§£ç¢¼ EncodedPolyline å¤±æ•—:', e);
            return [];
        }
    }
    
    /**
     * æ‰‹å‹•å¯¦ä½œ EncodedPolyline è§£ç¢¼ï¼ˆä¸ä¾è³´å¤–éƒ¨åº«ï¼‰
     * åŸºæ–¼ Google Polyline Algorithm
     */
    function decodePolylineManual(encoded) {
        const coordinates = [];
        let index = 0;
        let lat = 0;
        let lng = 0;

        while (index < encoded.length) {
            let shift = 0;
            let result = 0;
            let byte;

            // è§£ç¢¼ç·¯åº¦
            do {
                byte = encoded.charCodeAt(index++) - 63;
                result |= (byte & 0x1f) << shift;
                shift += 5;
            } while (byte >= 0x20);
            const deltaLat = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lat += deltaLat;

            shift = 0;
            result = 0;

            // è§£ç¢¼ç¶“åº¦
            do {
                byte = encoded.charCodeAt(index++) - 63;
                result |= (byte & 0x1f) << shift;
                shift += 5;
            } while (byte >= 0x20);
            const deltaLng = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lng += deltaLng;

            coordinates.push([lat / 1e5, lng / 1e5]);
        }

        return coordinates;
    }
    
    // ============================================================
    // ğŸ†• æœå°‹å»ºè­°ç³»çµ± - æ ¸å¿ƒå‡½å¼
    // ============================================================
    
    /**
     * å¾ Worker è¼‰å…¥æ‰€æœ‰è·¯ç·šä¸¦ä½¿ç”¨ localStorage å¿«å–
     */
    async function loadAllRoutes() {
        try {
            // 1. æª¢æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰æœ‰æ•ˆçš„å¿«å–
            const cachedData = localStorage.getItem(ROUTE_CACHE_KEY);
            if (cachedData) {
                const { timestamp, data } = JSON.parse(cachedData);
                if (Date.now() - timestamp < ROUTE_CACHE_EXPIRE) {
                    allRoutesCache = data;
                    console.log(`ğŸ“š å¾ localStorage è¼‰å…¥ ${allRoutesCache.length} æ¢è·¯ç·šå¿«å–`);
                    return;
                }
            }
            
            // 2. å¦‚æœå¿«å–éæœŸæˆ–ä¸å­˜åœ¨ï¼Œå¾ Worker ç²å–
            console.log('ğŸ“¡ æ­£åœ¨å¾ Worker ç²å–æ‰€æœ‰è·¯ç·š...');
            const startTime = Date.now();
            const res = await fetch(`${WORKER_URL}?action=list_all`);
            
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const routes = await res.json();
            allRoutesCache = routes;
            
            // 3. å„²å­˜åˆ° localStorage
            localStorage.setItem(ROUTE_CACHE_KEY, JSON.stringify({
                timestamp: Date.now(),
                data: routes
            }));
            
            const loadTime = Date.now() - startTime;
            console.log(`âœ… æˆåŠŸåŠ è¼‰ ${routes.length} æ¢è·¯ç·š (è€—æ™‚ ${loadTime}ms)`);
        } catch (e) {
            console.error(`âŒ loadAllRoutes å¤±æ•—: ${e.message}`);
            // é™ç´šï¼šä½¿ç”¨ç¾æœ‰çš„ POPULAR_ROUTES ä½œç‚ºå‚™ç”¨
            allRoutesCache = [];
            POPULAR_ROUTES.forEach(item => {
                item.routes.forEach(name => {
                    allRoutesCache.push({
                        n: name,
                        c: item.city,
                        t: 'CityBus'
                    });
                });
            });
            console.log(`âš ï¸ ä½¿ç”¨å‚™ç”¨è·¯ç·šåˆ—è¡¨ (${allRoutesCache.length} æ¢)`);
        }
    }
    
    /**
     * ğŸŒ åŸå¸‚ä»£ç¢¼è½‰ä¸­æ–‡åç¨±
     */
    function translateCity(cityCode) {
        const cityMap = {
            'Taipei': 'å°åŒ—å¸‚',
            'NewTaipei': 'æ–°åŒ—å¸‚',
            'Taoyuan': 'æ¡ƒåœ’å¸‚',
            'Taichung': 'å°ä¸­å¸‚',
            'Tainan': 'å°å—å¸‚',
            'Kaohsiung': 'é«˜é›„å¸‚',
            'Keelung': 'åŸºéš†å¸‚',
            'Hsinchu': 'æ–°ç«¹å¸‚',
            'HsinchuCounty': 'æ–°ç«¹ç¸£',
            'MiaoliCounty': 'è‹—æ —ç¸£',
            'ChanghwaCounty': 'å½°åŒ–ç¸£',
            'NantouCounty': 'å—æŠ•ç¸£',
            'YunlinCounty': 'é›²æ—ç¸£',
            'ChiayiCounty': 'å˜‰ç¾©ç¸£',
            'Chiayi': 'å˜‰ç¾©å¸‚',
            'PingtungCounty': 'å±æ±ç¸£',
            'YilanCounty': 'å®œè˜­ç¸£',
            'HualienCounty': 'èŠ±è“®ç¸£',
            'TaitungCounty': 'å°æ±ç¸£',
            'KinmenCounty': 'é‡‘é–€ç¸£',
            'PenghuCounty': 'æ¾æ¹–ç¸£',
            'LienchiangCounty': 'é€£æ±Ÿç¸£',
            'InterCity': 'è·¨ç¸£å¸‚'
        };
        return cityMap[cityCode] || cityCode;
    }

    /**
     * ğŸ” æ™ºæ…§æœå°‹ï¼šä¼æ¥­ç´šè·¯ç·šæ¨è–¦ç³»çµ±
     * âœ¨ ç‰¹è‰²ï¼š
     *   1. âœ… å®Œå…¨è§£æ±º 429 éŒ¯èª¤ - æœå°‹ç”± D1 æä¾›ï¼Œé›¶ TDX API æ¶ˆè€—
     *   2. âš¡ Debounce å„ªåŒ– - å»¶é² 300ms æŸ¥è©¢ï¼Œæ¸›è¼•ä¼ºæœå™¨è² è·
     *   3. ğŸ“Š å…¨å°ç„¡ç¸£å¸‚é™åˆ¶ - ä¸€æ¬¡æœå°‹éæ­·å…¨å°ç£æ‰€æœ‰è·¯ç·š
     *   4. ğŸ¯ æ™ºæ…§çµæœæ’åº - è‡ªå‹•é¡¯ç¤ºèµ·è¨–ç«™è³‡è¨ŠåŠ©ç”¨æˆ¶å¿«é€Ÿè­˜åˆ¥
     */
    async function filterRoutes() {
        const input = document.getElementById('routeNum').value.trim();
        const suggestionsContainer = document.getElementById('route-suggestions');
        
        if (input.length < 1) {
            suggestionsContainer.style.display = 'none';
            return;
        }

        // â±ï¸ Debounceï¼šä½¿ç”¨è€…åœæ­¢è¼¸å…¥ 300ms å¾Œæ‰æŸ¥è©¢ D1
        // é€™æ¨£èƒ½æœ‰æ•ˆé™ä½é »ç¹æŸ¥è©¢å°ä¼ºæœå™¨çš„è² æ“”
        clearTimeout(searchTimer);
        searchTimer = setTimeout(async () => {
            // é¡¯ç¤ºæœå°‹ç‹€æ…‹
            suggestionsContainer.innerHTML = `
                <div style="padding: 12px 16px; text-align: center; color: #667eea;">
                    <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æŸ¥è©¢å…¨å°è·¯ç·š...
                </div>
            `;
            suggestionsContainer.style.display = 'block';

            try {
                // ğŸ” å¾ D1 è³‡æ–™åº«æœå°‹ (æ¯«ç§’ç´šéŸ¿æ‡‰ï¼Œä¸æ¶ˆè€— TDX API quota)
                const response = await fetch(`${WORKER_URL}?action=list_all&search=${encodeURIComponent(input)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const matches = await response.json();

                if (matches && matches.length > 0) {
                    // âœ¨ ç”Ÿæˆå»ºè­°é¸å–® - æœ€å¤š 4 å€‹ï¼Œå‚ç›´å †ç–Š
                    suggestionsContainer.innerHTML = matches.slice(0, 4).map((route, idx) => {
                        const cityName = translateCity(route.city);
                        const departure = route.departure || 'èµ·ç«™';
                        const arrival = route.destination || 'çµ‚ç«™';
                        const typeIcon = route.type === 'InterCity' ? 'ğŸšŒ è·¨ç¸£å¸‚' : 'ğŸšŒ å…¬è»Š';
                        
                        return `
                        <div class="suggest-item" 
                             style="
                                padding: 12px 15px; 
                                cursor: pointer; 
                                border-bottom: 1px solid #f0f0f0;
                                transition: background 0.2s;
                                display: block;
                             "
                             onmouseover="this.style.background='#f8f9fa'"
                             onmouseout="this.style.background='white'"
                             onclick="selectRoute('${route.name}', '${route.city}', '${route.type}')">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                                <strong style="font-size: 1.1rem; color: #2c3e50;">${route.name}</strong>
                                <span style="font-size: 0.75rem; background: #667eea; color: white; padding: 2px 8px; border-radius: 10px; margin-left: 8px; white-space: nowrap;">
                                    ${cityName}
                                </span>
                            </div>
                            <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 4px;">
                                <i class="fas fa-map-marker-alt" style="margin-right: 4px; font-size: 0.75rem;"></i>
                                ${departure} <span style="color: #bdc3c7;">â”</span> ${arrival}
                            </div>
                            <div style="font-size: 0.75rem; color: #95a5a6;">
                                ${typeIcon}
                            </div>
                        </div>
                        `;
                    }).join('');
                    suggestionsContainer.style.display = 'block';
                    console.log(`âœ… æ‰¾åˆ° ${matches.length} æ¢ç¬¦åˆçš„è·¯ç·š`);
                } else {
                    suggestionsContainer.innerHTML = `
                        <div style="padding: 20px 15px; text-align: center; color: #9ca3af;">
                            <i class="fas fa-search" style="font-size: 1.5rem; margin-bottom: 8px; display: block;"></i>
                            <div style="font-size: 0.95rem; margin-bottom: 8px;">
                                æ‰¾ä¸åˆ°ç¬¦åˆã€Œ<strong>${input}</strong>ã€çš„è·¯ç·š
                            </div>
                            <div style="font-size: 0.80rem; opacity: 0.8;">
                                ğŸ’¡ è©¦è©¦çœ‹è¼¸å…¥å…¶ä»–è·¯ç·šè™Ÿæˆ–ç«™å
                            </div>
                        </div>
                    `;
                    suggestionsContainer.style.display = 'block';
                }
            } catch (e) {
                console.error('âŒ D1 æœå°‹å¤±æ•—:', e.message);
                suggestionsContainer.innerHTML = `
                    <div style="padding: 20px 15px; text-align: center; color: #e74c3c;">
                        <i class="fas fa-exclamation-circle" style="font-size: 1.5rem; margin-bottom: 8px; display: block;"></i>
                        <div style="font-size: 0.95rem; margin-bottom: 8px;">
                            æœå°‹æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨
                        </div>
                        <div style="font-size: 0.80rem; opacity: 0.8;">
                            ğŸ”§ è«‹ç¢ºä¿å·²åŸ·è¡Œåˆå§‹åŒ–: <code>?action=sync_db</code>
                        </div>
                    </div>
                `;
                suggestionsContainer.style.display = 'block';
            }
        }, 300); // â±ï¸ å»¶é² 300ms åŸ·è¡ŒæŸ¥è©¢
    }
    
    /**
     * é¸æ“‡è·¯ç·šæ™‚è§¸ç™¼
     */
    function selectRoute(name, city, category) {
        // å¡«å…¥æœå°‹æ¡†
        document.getElementById('routeNum').value = name;
        document.getElementById('city').value = city;
        
        // è™•ç† category è½‰æ› (InterCity -> InterCity, CityBus -> CityBus)
        const categorySelect = document.getElementById('category');
        if (category === 'InterCity') {
            categorySelect.value = 'InterCity';
        } else {
            categorySelect.value = 'CityBus';
        }
        
        // éš±è—å»ºè­°èœå–®
        document.getElementById('route-suggestions').style.display = 'none';
        
        console.log(`âœ¨ å·²é¸æ“‡è·¯ç·š: ${name} (${translateCity(city)} - ${category})`);
        
        // è§¸ç™¼è¿½è¹¤
        startTracking();
    }
    
    /**
     * æ¸…é™¤ localStorage å¿«å–ï¼ˆç”¨æ–¼æ‰‹å‹•é‡æ–°æ•´ç†ï¼‰
     */
    window.clearRouteCache = function() {
        localStorage.removeItem(ROUTE_CACHE_KEY);
        allRoutesCache = [];
        console.log('âœ… è·¯ç·šå¿«å–å·²æ¸…é™¤');
        loadAllRoutes();
        alert('âœ… è·¯ç·šå¿«å–å·²æ¸…é™¤ï¼Œç³»çµ±å°‡é‡æ–°åŠ è¼‰');
    };
    
    // éš±è—å»ºè­°èœå–®æ™‚çš„äº‹ä»¶å§”æ´¾
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.suggestion-item') && 
            e.target.id !== 'routeNum') {
            document.getElementById('route-suggestions').style.display = 'none';
        }
    });
    
    // åˆ‡æ›åˆ°æŒ‡å®šè·¯ç·šï¼ˆå¾ç«™ç‰Œ popup é»æ“Šè·¯ç·šæ™‚è§¸ç™¼ï¼‰
    window.switchToRoute = function(routeName) {
        document.getElementById('routeNum').value = routeName;
        startTracking();
    };
    
    // é é¢è¼‰å…¥å®Œæˆå¾Œçš„è™•ç†
    window.addEventListener('beforeunload', () => {
        if (pollingTimer) clearInterval(pollingTimer);
    });
</script>

</body>
</html>
