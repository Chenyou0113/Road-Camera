# 市區監視器地圖功能 - 測試指南

## 快速測試步驟

### 步驟 1: 打開頁面
1. 在瀏覽器中打開 `city.html`
2. 頁面應該顯示加載進度條
3. 等待「縣市選擇」介面出現

### 步驟 2: 驗證地圖按鈕隱藏
- 在縣市選擇介面時，「地圖檢視」按鈕應該**隱藏**（display: none）
- 篩選列中只應該看到「返回縣市列表」按鈕

### 步驟 3: 選擇城市並加載監視器
1. 點擊任意縣市按鈕（例如：台北市）
2. 等待監視器列表加載
3. 監視器應該以網格形式顯示

### 步驟 4: 驗證地圖按鈕出現
- 加載完成後，篩選列中應該出現「🗺️ 地圖檢視」按鈕
- 按鈕應該是青色 (#0891b2)
- 按鈕可以點擊

### 步驟 5: 切換到地圖視圖
1. 點擊「🗺️ 地圖檢視」按鈕
2. 驗證：
   - ✅ 按鈕變為橙色 (#FF9800)
   - ✅ 監視器列表消失
   - ✅ 分頁控制消失
   - ✅ 地圖容器顯示
   - ✅ 地圖加載完成

### 步驟 6: 驗證地圖標記
1. 觀察地圖上的標記
2. 驗證：
   - ✅ 所有標記都是圓形 (L.circleMarker)
   - ✅ TDX 資料源標記是藍色 (#1e40af)
   - ✅ 其他來源標記是橙色 (#FF9800)
   - ✅ 標記集中在台灣地區
   - ✅ 標記數量與列表中的監視器數相符

### 步驟 7: 測試標記彈窗
1. 在地圖上點擊任意標記
2. 驗證彈窗顯示：
   - ✅ 監視器名稱/路名
   - ✅ 位置描述
   - ✅ 縣市和鄉鎮區（如有）
   - ✅ 經緯度坐標（格式：X.XXXX, Y.XXXX）

### 步驟 8: 測試地圖交互
1. 在地圖上拖動：應該平移
2. 使用滾輪縮放：應該放大/縮小
3. 按鈕應該保持可見

### 步驟 9: 返回列表視圖
1. 再次點擊「🗺️ 地圖檢視」按鈕（現在是橙色）
2. 驗證：
   - ✅ 按鈕變回青色 (#0891b2)
   - ✅ 地圖消失
   - ✅ 監視器列表重新出現
   - ✅ 分頁控制重新出現

### 步驟 10: 測試篩選條件
1. 保持在列表視圖
2. 應用篩選條件（例如：選擇特定路段）
3. 監視器列表應該更新
4. 切換到地圖視圖
5. 驗證地圖標記已更新以反映篩選結果
6. 地圖應該自動調整視野以顯示篩選後的標記

## 預期行為清單

### 初始化階段
- [ ] 頁面加載時，所有地圖相關變數都初始化為空/false
- [ ] 地圖容器 div 初始化為 `display: none`
- [ ] 地圖按鈕初始化為 `display: none`

### 監視器加載後
- [ ] 地圖按鈕變為 `display: inline-block` 或 `display: block`
- [ ] 按鈕開始為青色（#0891b2）
- [ ] `mapViewActive` 變數為 `false`

### 第一次點擊地圖按鈕
- [ ] Leaflet 地圖被初始化
- [ ] OpenStreetMap 圖層被加載
- [ ] 所有監視器標記被添加到地圖
- [ ] 地圖視野調整以顯示所有標記
- [ ] 控制台顯示 "✅ 地圖已初始化"
- [ ] 控制台顯示 "✅ 已在地圖上標記 XXX 個監視器"

### 篩選條件變更時
- [ ] 如果地圖視圖激活，標記自動更新
- [ ] 如果列表視圖激活，列表更新，按鈕保持可見
- [ ] 地圖視野自動調整（如果在地圖視圖中）

## 常見問題排查

### 地圖按鈕未出現
- [ ] 檢查 `allCameras.length > 0`
- [ ] 查看控制台是否有錯誤
- [ ] 確認監視器已成功加載

### 地圖無法加載
- [ ] 檢查 Leaflet.js CDN 連接
- [ ] 查看控制台中的 L.map() 是否報錯
- [ ] 確認 mapContainer 元素存在且有正確的 ID

### 標記不顯示
- [ ] 檢查監視器數據中是否有 PositionLat 和 PositionLon
- [ ] 在控制台檢查 cameraMarkers 陣列長度
- [ ] 驗證 updateMapMarkersGlobal() 被正確調用

### 標記顏色不正確
- [ ] 檢查 camera.source 值
- [ ] 驗證顏色代碼：
  - TDX: #1e40af (藍色)
  - 其他: #FF9800 (橙色)

### 彈窗未出現
- [ ] 檢查標記是否正確綁定 popup
- [ ] 驗證彈窗內容是否正確構建
- [ ] 檢查是否有 JavaScript 錯誤

## 控制台輸出預期

當正確運行時，控制台應該顯示：

```
✅ 所有依賴已就緒
🚀 市區道路監視器頁面 DOM 載入完成
✅ 顯示縣市選擇介面
🔄 開始填充篩選器和顯示監視器...
📊 allCameras 長度: 50, filteredCameras 長度: 50
✅ 地圖已初始化     （點擊地圖按鈕時）
✅ 已在地圖上標記 50 個監視器   （點擊地圖按鈕時）
```

## 性能基準

- **地圖初始化時間**：< 1 秒
- **標記加載時間**（50個）：< 500ms
- **標記加載時間**（500個）：< 2 秒
- **視野調整時間**：< 200ms
- **篩選後標記更新**：< 1 秒

## 移動設備測試

### iOS Safari
- [ ] 地圖加載正常
- [ ] 觸控放大縮小有效
- [ ] 彈窗可正確顯示

### Android Chrome
- [ ] 地圖加載正常
- [ ] 觸控交互正常
- [ ] 性能可接受

---

**測試日期**: ___________
**測試人**: ___________
**通過情況**: ☐ 通過 ☐ 部分通過 ☐ 失敗

**備註**: ___________________________________________________________
