<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan Domestic Airports PIDS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        * { box-sizing: border-box; }
        body { 
            /* èƒŒæ™¯è¨­ç‚ºæ·ºç°ï¼Œæ¨¡æ“¬ç‰†é¢ï¼Œå°æ¯”çœ‹æ¿çš„æ·±ç° */
            background-color: #dcdcdc; 
            margin: 0; 
            padding: 0; 
            font-family: "Microsoft JhengHei", "Heiti TC", Arial, sans-serif; 
            min-height: 100vh; 
            display: flex;
            flex-direction: column;
        }

        /* --- ç‹€æ…‹ 1: é¦–é é¸å–® --- */
        #selection-screen {
            display: flex;
            flex: 1;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #4b6cb7, #182848); /* æ”¹ç‚ºè¼ƒæ·±æ²ˆç©©çš„è—è‰² */
            color: white;
            height: 100vh;
        }

        .menu-title {
            font-size: 3rem;
            margin-bottom: 30px;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .menu-buttons {
            display: flex;
            gap: 30px;
        }

        .btn-select {
            padding: 30px 50px;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-width: 250px;
        }

        .btn-select:hover {
            background: white;
            color: #333;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn-select i { font-size: 2.5rem; }

        /* --- ç‹€æ…‹ 2: PIDS çœ‹æ¿å®¹å™¨ --- */
        #pids-view {
            display: none; /* é è¨­éš±è— */
            padding: 20px;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
            justify-content: center;
        }

        /* è¿”å›æŒ‰éˆ• */
        .btn-back {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #555;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .btn-back:hover { background: #777; }
        
        /* --- å–®ä¸€çœ‹æ¿æ¨£å¼ (ä¿®æ”¹ç‚ºç°è‰²åº•) --- */
        .pids-screen { 
            flex: 1;
            min-width: 45%; /* å·¦å³å„ä¸€å€‹ */
            max-width: 1000px;
            /* å°‡åŸæœ¬çš„é»‘è‰² #000 æ”¹ç‚ºæ·±ç°è‰² */
            background: #3e3e3e; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); 
            display: flex; 
            flex-direction: column; 
            height: 90vh;
            border: 1px solid #555;
            border-radius: 8px;
            overflow: hidden;
            color: #f0f0f0; /* æ–‡å­—æ”¹ç‚ºäº®ç°ç™½ */
        }

        /* Header (æ¨™é¡Œæ¬„) */
        .pids-header { 
            height: 90px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 30px; 
            font-weight: bold; 
            color: #fff;
            flex-shrink: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .pids-header-title { 
            font-size: 2rem; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .header-icon { font-size: 2.4rem; }
        .pids-clock { font-size: 2.8rem; font-family: 'Arial', sans-serif; letter-spacing: 2px; }

        /* ä¸»é¡Œé¡è‰² */
        .theme-yellow .pids-header { 
            background: linear-gradient(to bottom, #f0ad4e, #ec971f); 
            border-bottom: 4px solid #d58512; 
        }
        .theme-blue .pids-header { 
            background: linear-gradient(to bottom, #337ab7, #2e6da4); 
            border-bottom: 4px solid #204d74; 
        }
        .theme-green .pids-header { 
            background: linear-gradient(to bottom, #5cb85c, #449d44); 
            border-bottom: 4px solid #398439; 
        }

        /* è¡¨æ ¼å®¹å™¨ */
        .table-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background-color: #3e3e3e; /* è¡¨æ ¼èƒŒæ™¯æ·±ç° */
        }

        /* è¡¨æ ¼æ¨£å¼ */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            table-layout: fixed;
        }
        
        thead tr { 
            border-bottom: 2px solid #666; 
            height: 55px;
            position: sticky;
            top: 0;
            background-color: #2c2c2c; /* è¡¨é ­æ¯”èƒŒæ™¯æ›´æ·±ä¸€é» */
            z-index: 10;
        }

        thead th { 
            font-size: 1.1rem; 
            color: #bbb; 
            font-weight: normal; 
            text-align: left; 
            padding: 0 15px;
        }
        
        thead th span { 
            display: block; 
            font-size: 0.8rem; 
            color: #888;
        }

        tbody tr { 
            height: 80px;
            border-bottom: 1px solid #555; /* åˆ†éš”ç·šé¡è‰²è®Šæ·º */
        }

        tbody tr:nth-child(even) {
            background-color: #444; /* éš”è¡Œè®Šè‰²ï¼Œç¨å¾®äº®ä¸€é»çš„ç° */
        }

        td { 
            padding: 0 15px; 
            vertical-align: middle;
            font-size: 1.6rem;
            color: #fff;
        }

        /* ç›®çš„åœ°æ¨£å¼ */
        .dest-cn { display: block; font-size: 1.5rem; font-weight: bold; margin-bottom: 2px; }
        .dest-en { display: block; font-size: 1rem; color: #aaa; font-family: Arial, sans-serif; }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge { 
            display: inline-block; 
            padding: 8px 16px; 
            border-radius: 6px; 
            font-size: 1rem;
            min-width: 120px;
            text-align: center; 
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .status-departed, .status-arrived { background-color: #5cb85c; color: #fff; }
        .status-delayed { background-color: #d9534f; color: #fff; }
        .status-early { background-color: #f0ad4e; color: #fff; }
        .status-boarding { background-color: #f0ad4e; color: #000; animation: blink 1s infinite; }
        .status-ontime { color: #5cb85c; font-weight: normal; font-size: 1.4rem; }

        @keyframes blink { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.6; } 
        }

        /* åº•éƒ¨è·‘é¦¬ç‡ˆ */
        .pids-footer { 
            height: 60px; 
            background-color: #2c2c2c; 
            border-top: 2px solid #555; 
            display: flex; 
            align-items: center; 
            padding: 0 20px; 
            font-size: 1.3rem; 
            color: #ffd700; /* é»ƒè‰²æ–‡å­— */
            overflow: hidden;
        }
        
        .marquee { 
            white-space: nowrap;
            animation: marquee 25s linear infinite; 
        }

        @keyframes marquee { 
            0% { transform: translateX(100%); } 
            100% { transform: translateX(-100%); } 
        }

        /* æ‰‹æ©Ÿç‰ˆé©é… */
        @media (max-width: 1200px) {
            .pids-screen { min-width: 100%; height: auto; min-height: 80vh; }
            #pids-view { flex-direction: column; }
        }
    </style>
</head>
<body>

    <!-- ç‹€æ…‹ 1: é¦–é é¸å–® -->
    <div id="selection-screen">
        <div class="menu-title">âœˆï¸ å°ç£æ©Ÿå ´èˆªç­çœ‹æ¿</div>
        
        <!-- æ©Ÿå ´é¸æ“‡ (åƒ…ä¿ç•™åœ‹å…§æ©Ÿå ´) -->
        <div style="margin-bottom: 40px; text-align: center;">
            <label style="display: block; margin-bottom: 10px; font-size: 1.2rem; color: #ccc;">è«‹é¸æ“‡æ©Ÿå ´ Select Airport</label>
            <select id="airport-select" style="padding: 15px 30px; font-size: 1.3rem; border-radius: 12px; border: none; background: rgba(255,255,255,0.9); cursor: pointer; min-width: 300px;">
                <optgroup label="åŒ—éƒ¨ North">
                    <option value="TSA">è‡ºåŒ—æ¾å±± (TSA)</option>
                </optgroup>
                <optgroup label="ä¸­éƒ¨ Central">
                    <option value="RMQ">è‡ºä¸­æ¸…æ³‰å´— (RMQ)</option>
                </optgroup>
                <optgroup label="å—éƒ¨ South">
                    <option value="KHH">é«˜é›„å°æ¸¯ (KHH)</option>
                    <option value="TNN">è‡ºå— (TNN)</option>
                    <option value="CYI">å˜‰ç¾© (CYI)</option>
                </optgroup>
                <optgroup label="æ±éƒ¨ East">
                    <option value="HUN">èŠ±è“® (HUN)</option>
                    <option value="TTT">è‡ºæ± (TTT)</option>
                </optgroup>
                <optgroup label="é›¢å³¶ Offshore Islands">
                    <option value="MZG">æ¾æ¹– (MZG)</option>
                    <option value="KNH">é‡‘é–€ (KNH)</option>
                    <option value="LZN">é¦¬ç¥–å—ç«¿ (LZN)</option>
                    <option value="MFK">é¦¬ç¥–åŒ—ç«¿ (MFK)</option>
                </optgroup>
            </select>
        </div>

        <div class="menu-buttons">
            <button class="btn-select" onclick="showSystem('DOMESTIC')">
                <i class="fas fa-flag"></i>
                åœ‹å…§ç·š<br><span style="font-size:0.6em">Domestic</span>
            </button>
            <button class="btn-select" onclick="showSystem('INTERNATIONAL')">
                <i class="fas fa-globe-asia"></i>
                åœ‹éš›ç·š<br><span style="font-size:0.6em">International</span>
            </button>
        </div>
        <div style="margin-top: 15px; color: #aaa; font-size: 0.9rem;">
            *è¨»ï¼šè‹¥é¸æ“‡ç´”åœ‹å…§æ©Ÿå ´(å¦‚æ¾æ¹–)ï¼Œé»æ“Šåœ‹éš›ç·šå°‡ç„¡è³‡æ–™é¡¯ç¤ºã€‚
        </div>
    </div>

    <!-- ç‹€æ…‹ 2: PIDS é¡¯ç¤ºå€ -->
    <div id="pids-view">
        <button class="btn-back" onclick="goBack()">
            <i class="fas fa-arrow-left"></i> è¿”å›é¸å–®
        </button>
        <div id="pids-container" style="display:contents;">
            <!-- JS å‹•æ…‹æ’å…¥çœ‹æ¿ -->
        </div>
    </div>

    <script>
        // ===== è¨­å®šå€ =====
        const WORKER_URL = "https://airport.xiaoyouwu5-fd3.workers.dev/"; 

        let CurrentFlightData = {
            DOMESTIC_DEPARTURES: [],
            DOMESTIC_ARRIVALS: [],
            INTERNATIONAL_DEPARTURES: [],
            INTERNATIONAL_ARRIVALS: []
        };

        // ===== ç³»çµ±é‚è¼¯ =====

        async function showSystem(type) {
            const airportSelect = document.getElementById('airport-select');
            const airportCode = airportSelect.value;
            const airportName = airportSelect.options[airportSelect.selectedIndex].text;
            const container = document.getElementById('pids-container');
            
            // 1. åˆ‡æ›ç•«é¢
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('pids-view').style.display = 'flex';
            
            // 2. é¡¯ç¤ºè¼‰å…¥ä¸­
            container.innerHTML = `
                <div style="color:white; font-size:2rem; width:100%; text-align:center; margin-top:150px;">
                    <i class="fas fa-circle-notch fa-spin"></i> 
                    <div style="margin-top:20px; font-size:1.5rem;">${airportName} è³‡æ–™è¼‰å…¥ä¸­...</div>
                </div>
            `;

            // 3. å‘¼å« Worker
            await fetchAirportData(airportCode);

            // 4. é–‹å§‹æ¸²æŸ“
            container.innerHTML = ''; 

            if (type === 'DOMESTIC') {
                // æ¸²æŸ“åœ‹å…§ç·š
                renderPIDS("åœ‹å…§ç·šåˆ°ç«™", "Domestic Arrivals", 'blue', 'ğŸ›¬', CurrentFlightData.DOMESTIC_ARRIVALS, 'D_ARR', 'æ­¡è¿å…‰è‡¨ï¼Œç¥æ‚¨æ—…é€”æ„‰å¿«ã€‚Welcome to airport.');
                renderPIDS("åœ‹å…§ç·šé›¢ç«™", "Domestic Departures", 'yellow', 'ğŸ›«', CurrentFlightData.DOMESTIC_DEPARTURES, 'D_DEP', 'ç¥æ‚¨é£›è¡Œæ„‰å¿«ï¼Œæ„Ÿè¬æ‚¨çš„æ­ä¹˜ã€‚Thank you for flying.');
            } else {
                // æ¸²æŸ“åœ‹éš›ç·š (è‹¥è©²æ©Ÿå ´ç„¡åœ‹éš›ç·šï¼Œæœƒé¡¯ç¤ºç„¡èˆªç­è³‡è¨Š)
                renderPIDS("åœ‹éš›ç·šåˆ°ç«™", "International Arrivals", 'green', 'ğŸ›¬', CurrentFlightData.INTERNATIONAL_ARRIVALS, 'I_ARR', 'æ­¡è¿ä¾†å°ç£ï¼Œç¥æ‚¨æ—…é€”æ„‰å¿«ã€‚Welcome to Taiwan.');
                renderPIDS("åœ‹éš›ç·šé›¢ç«™", "International Departures", 'green', 'ğŸ›«', CurrentFlightData.INTERNATIONAL_DEPARTURES, 'I_DEP', 'ç¥æ‚¨é£›è¡Œæ„‰å¿«ï¼Œæ„Ÿè¬æ‚¨çš„æ­ä¹˜ã€‚Thank you for flying.');
            }
        }

        async function fetchAirportData(airportCode) {
            try {
                const res = await fetch(`${WORKER_URL}?airport=${airportCode}`);
                if (!res.ok) throw new Error("API Error");
                const data = await res.json();
                CurrentFlightData = data;
            } catch (e) {
                console.error(e);
                alert("ç„¡æ³•å–å¾—èˆªç­è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
                CurrentFlightData = {
                    DOMESTIC_DEPARTURES: [], DOMESTIC_ARRIVALS: [],
                    INTERNATIONAL_DEPARTURES: [], INTERNATIONAL_ARRIVALS: []
                };
            }
        }

        function goBack() {
            document.getElementById('pids-view').style.display = 'none';
            document.getElementById('selection-screen').style.display = 'flex';
        }

        function getColumns(type) {
            const isDeparture = type.includes('DEP');
            const isInternational = type.includes('I_');

            let columns = [];
            
            if (isInternational) {
                columns.push({ header: "èˆªç©ºå…¬å¸", sub: "Airline", dataKey: "airline", width: "12%" });
            }

            columns.push({ header: "ç­æ¬¡", sub: "Flight", dataKey: "flight", width: isInternational ? "13%" : "18%" });
            
            if (isDeparture) {
                columns.push({ header: "ç›®çš„åœ°", sub: "Destination", dataKey: "dest", width: isInternational ? "30%" : "32%" });
                columns.push({ header: "æ™‚é–“", sub: "Time", dataKey: "time", width: "10%" });
                columns.push({ header: "ç™»æ©Ÿé–€", sub: "Gate", dataKey: "gate", width: "10%" });
                columns.push({ header: "ç‹€æ…‹", sub: "Status", dataKey: "status", width: "20%" });
            } else {
                columns.push({ header: "å‡ºç™¼åœ°", sub: "Origin", dataKey: "dest", width: isInternational ? "30%" : "32%" });
                columns.push({ header: "æ™‚é–“", sub: "Time", dataKey: "time", width: "10%" });
                columns.push({ header: "å‚™è¨»", sub: "Remarks", dataKey: "est", width: "10%" }); 
                columns.push({ header: "ç‹€æ…‹", sub: "Status", dataKey: "status", width: "20%" });
            }

            return columns;
        }

        function renderPIDS(titleCn, titleEn, theme, icon, data, dataType, marqueeText) {
            if (!data || data.length === 0) data = [];

            const columns = getColumns(dataType);
            const screenDiv = document.createElement('div');
            screenDiv.className = `pids-screen theme-${theme}`;
            const screenId = `screen-${Date.now()}-${Math.random()}`;

            // Header
            const headerHtml = `
                <div class="pids-header">
                    <div class="pids-header-title">
                        <span class="header-icon">${icon}</span>
                        <div>${titleCn}<br><span style="font-size: 0.6em; opacity: 0.8;">${titleEn}</span></div>
                    </div>
                    <div class="pids-clock" id="clock-${screenId}">--:--</div>
                </div>
            `;

            // Table Header
            let tableHeaderHtml = '<thead><tr>';
            columns.forEach(col => {
                tableHeaderHtml += `<th style="width: ${col.width};">${col.header}<span>${col.sub}</span></th>`;
            });
            tableHeaderHtml += '</tr></thead>';

            // Table Body
            let tableBodyHtml = '<tbody>';
            
            if (data.length === 0) {
                 tableBodyHtml += `<tr><td colspan="${columns.length}" style="text-align:center; color:#aaa; padding:40px;">ç›®å‰ç„¡èˆªç­è³‡è¨Š No Flight Information</td></tr>`;
            } else {
                data.forEach(flight => {
                    tableBodyHtml += '<tr>';
                    columns.forEach(col => {
                        let cellData = flight[col.dataKey] || "-";
                        let cellHtml = '';

                        if (col.dataKey === 'status') {
                            if(flight.type === 'ontime') {
                                 cellHtml = `<span style="color:#5cb85c; font-weight:bold; font-size:1.3rem;">${cellData}</span>`;
                            } else {
                                 cellHtml = `<span class="status-badge status-${flight.type}">${cellData}</span>`;
                            }
                        } else if (col.dataKey === 'dest') {
                            let parts = cellData.split(' ');
                            let cn = parts.length > 1 ? parts[1] : parts[0]; 
                            let en = parts.length > 1 ? parts[0] : ""; 
                            if (cellData.match(/^[A-Z]{3}/)) {
                                 en = parts[0];
                                 cn = parts.slice(1).join(' ');
                            }
                            cellHtml = `<span class="dest-cn">${cn}</span><span class="dest-en">${en}</span>`;

                        } else if (col.dataKey === 'airline') {
                            let color = '#fff';
                            if(['CI','AE'].includes(cellData)) color='#e0a0ff';
                            if(['BR','B7'].includes(cellData)) color='#00a651';
                            if(['CX','KA'].includes(cellData)) color='#006442';
                            if(['JX'].includes(cellData)) color='#cda45e';
                            if(['IT'].includes(cellData)) color='#f68b1f';
                            cellHtml = `<div style="text-align: center; font-weight: bold; color:${color}; font-size: 1.2em;">${cellData}</div>`;
                        } else {
                            const align = (col.dataKey === 'dest') ? 'left' : 'center';
                            cellHtml = `<div style="text-align: ${align};">${cellData}</div>`;
                        }

                        tableBodyHtml += `<td>${cellHtml}</td>`;
                    });
                    tableBodyHtml += '</tr>';
                });
            }
            tableBodyHtml += '</tbody>';

            const footerHtml = `
                <div class="pids-footer">
                    <div class="marquee">${marqueeText}</div>
                </div>
            `;

            screenDiv.innerHTML = `
                ${headerHtml}
                <div class="table-container">
                    <table>${tableHeaderHtml}${tableBodyHtml}</table>
                </div>
                ${footerHtml}
            `;

            document.getElementById('pids-container').appendChild(screenDiv);

            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
                const clockEl = document.getElementById(`clock-${screenId}`);
                if (clockEl) clockEl.innerText = timeString;
            }
            setInterval(updateClock, 1000);
            updateClock();
        }
    </script>
</body>
</html>