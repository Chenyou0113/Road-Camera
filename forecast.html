<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½å¤©æ°£é å ± | å°ç£å³æ™‚ç›£æ§</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <link rel="stylesheet" href="assets/mobile-responsive.css">
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f0f4f8; color: #333; }
        body.dark-mode { background: #0f172a; color: #e0e0e0; }

        .header { background: linear-gradient(135deg, #009688, #004d40); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .back-btn { color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; transition: 0.3s; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        .container { max-width: 1400px; margin: 20px auto; padding: 0 15px; }

        /* æ§åˆ¶åˆ— */
        .controls { 
            display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; 
            background: white; padding: 20px; border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px;
        }
        body.dark-mode .controls { background: #1e293b; }

        .control-group { display: flex; flex-direction: column; gap: 5px; min-width: 200px; }
        .control-group label { font-weight: bold; color: #00796b; font-size: 0.9rem; }
        body.dark-mode .control-group label { color: #2dd4bf; }

        select {
            padding: 10px 15px; font-size: 1rem; border-radius: 10px; border: 2px solid #009688;
            background: white; color: #333; outline: none; cursor: pointer;
        }
        body.dark-mode select { background: #334155; color: white; border-color: #2dd4bf; }

        /* é å ±å¡ç‰‡ç¶²æ ¼ */
        .forecast-grid {
            display: grid; 
            /* æ‰‹æ©Ÿç‰ˆä¸€è¡Œ2å€‹ï¼Œé›»è…¦ç‰ˆè‡ªå‹•å¡«æ»¿ */
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 15px;
        }

        .forecast-card {
            background: white; border-radius: 15px; padding: 15px 10px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s;
            border-top: 5px solid #009688; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        /* å¤œé–“å¡ç‰‡ç‰¹åˆ¥æ¨£å¼ */
        .forecast-card.night-card {
            background: #eef2f6;
            border-top-color: #546e7a;
        }

        body.dark-mode .forecast-card { background: #1e293b; border-top-color: #2dd4bf; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        body.dark-mode .forecast-card.night-card { background: #0f172a; border-top-color: #64748b; }
        
        .forecast-card:hover { transform: translateY(-5px); }

        .date { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .day-name { font-size: 1rem; font-weight: bold; margin-bottom: 10px; color: #333; height: 40px; display: flex; align-items: center; justify-content: center; line-height: 1.2;}
        .weather-icon { font-size: 2.8rem; margin: 10px 0; color: #f9a825; }
        .weather-desc { font-size: 0.9rem; margin-bottom: 5px; color: #555; height: 36px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .temp { font-size: 1.3rem; font-weight: bold; color: #009688; }
        .rain { font-size: 0.9rem; color: #1976d2; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 5px; background: #e3f2fd; border-radius: 10px; padding: 2px 8px; width: fit-content; margin: 8px auto 0;}
        
        body.dark-mode .date { color: #aaa; }
        body.dark-mode .day-name { color: #fff; }
        body.dark-mode .weather-desc { color: #ccc; }
        body.dark-mode .temp { color: #2dd4bf; }
        body.dark-mode .rain { color: #64b5f6; background: rgba(30, 58, 138, 0.5); }

        .loading { text-align: center; padding: 50px; font-size: 1.2rem; color: #666; width: 100%; grid-column: 1 / -1; }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-calendar-alt"></i> å…¨æ–¹ä½å¤©æ°£é å ±</h1>
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> å›é¦–é </a>
    </div>

    <div class="container">
        <div class="controls">
            <div class="control-group">
                <label><i class="fas fa-filter"></i> é å ±é¡å‹</label>
                <select id="typeSelect" onchange="changeDataset()">
                    <option value="F-C0032-001">ğŸ‡¹ğŸ‡¼ 36 å°æ™‚ (æ¯12å°æ™‚)</option>
                    <option value="F-C0032-003">ğŸ—“ï¸ ä¸€å‘¨ç¸£å¸‚ (æ¯12å°æ™‚)</option>
                    <option value="F-D0047-091">ğŸ¡ é„‰é®è©³ç´° (æ¯3~12å°æ™‚)</option>
                    <option value="F-C0032-007">ğŸŒ å…¨çƒéƒ½å¸‚ (æ¯æ—¥)</option>
                </select>
            </div>
            <div class="control-group">
                <label><i class="fas fa-map-marker-alt"></i> åœ°é»é¸æ“‡</label>
                <select id="locationSelect" onchange="renderCards()">
                    <option value="">è¼‰å…¥ä¸­...</option>
                </select>
            </div>
        </div>

        <div id="forecastContainer" class="forecast-grid">
            <div class="loading"><i class="fas fa-spinner fa-spin"></i> è³‡æ–™è®€å–ä¸­...</div>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://cwa-weather-proxy.xiaoyouwu5-fd3.workers.dev';
        
        let currentData = null; 
        
        async function init() {
            if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
            document.getElementById('typeSelect').value = 'F-C0032-001';
            await changeDataset();
        }

        async function changeDataset() {
            const datasetId = document.getElementById('typeSelect').value;
            const container = document.getElementById('forecastContainer');
            const locSelect = document.getElementById('locationSelect');

            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> è³‡æ–™è®€å–ä¸­...</div>';
            locSelect.innerHTML = '<option>è¼‰å…¥ä¸­...</option>';
            locSelect.disabled = true;

            try {
                console.log(`ğŸ“¡ æ­£åœ¨è«‹æ±‚: ${datasetId}`);
                const res = await fetch(`${WORKER_URL}?dataset=${datasetId}`);
                const json = await res.json();
                
                // é˜²å‘†
                if (!json || Object.keys(json).length === 0) {
                    throw new Error("æ­¤é å ±è³‡æ–™åº«å°šæœªåŒæ­¥ (ç©ºè³‡æ–™)");
                }

                // ğŸ”¥ å‘¼å«æš´åŠ›è§£æå™¨
                const locations = findLocations(json);
                
                if (locations && locations.length > 0) {
                    console.log(`âœ… æˆåŠŸè§£æ ${locations.length} ç­†åœ°é»è³‡æ–™`);
                    currentData = locations;
                    populateSelect();
                    renderCards();
                } else {
                    console.error("âŒ çµæ§‹è§£æå¤±æ•—ï¼ŒåŸå§‹è³‡æ–™:", json);
                    throw new Error("ç„¡æ³•è§£ææ°£è±¡è³‡æ–™çµæ§‹ (è«‹çœ‹ Console)");
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = `<div class="loading" style="color:red; font-size:1rem;">
                    <i class="fas fa-exclamation-triangle"></i> ${e.message}
                </div>`;
                locSelect.innerHTML = '<option>ç„¡è³‡æ–™</option>';
            }
        }

        // ğŸ”¥ V5.0 æš´åŠ›è§£æå™¨ï¼šçª®èˆ‰æ‰€æœ‰å¯èƒ½çš„è·¯å¾‘ (å¤§å°å¯«é€šç”¨ç‰ˆ)
        function findLocations(json) {
            // ğŸ”¥ çµ±ä¸€å¤§å°å¯«è™•ç†ï¼šCWA API å¤§å°å¯«ä¸ä¸€è‡´
            
            // è·¯å¾‘ 1: cwaopendata.Dataset.Locations (CWA File API çœŸå¯¦æ ¼å¼)
            // é©ç”¨: F-C0032-003, F-C0032-007
            if (json?.cwaopendata?.Dataset?.Locations) {
                const locs = json.cwaopendata.Dataset.Locations;
                if (Array.isArray(locs)) return flattenLocations(locs);
                if (locs?.location) return locs.location;
            }

            // è·¯å¾‘ 2: cwaopendata.dataset.location (File API å°å¯«ç‰ˆæœ¬)
            if (json?.cwaopendata?.dataset?.location) return json.cwaopendata.dataset.location;

            // è·¯å¾‘ 3: cwaopendata.dataset.locations.location
            if (json?.cwaopendata?.dataset?.locations?.location) return json.cwaopendata.dataset.locations.location;

            // è·¯å¾‘ 4: records.location (DataStore æ¨™æº–æ ¼å¼)
            if (json?.records?.location) return json.records.location;

            // è·¯å¾‘ 5: records.Locations (å¤§å¯«ç‰ˆ - F-D0047-091)
            if (json?.records?.Locations) {
                const locs = json.records.Locations;
                if (Array.isArray(locs) && locs[0]?.location) return locs[0].location;
                if (locs?.location) return locs.location;
            }

            // è·¯å¾‘ 6: records.locations.location (å°å¯«ç‰ˆ)
            if (json?.records?.locations?.location) return json.records.locations.location;

            return null;
        }

        // ğŸ”¥ è¼”åŠ©å‡½å¼ï¼šå±•é–‹ Locations é™£åˆ—ç‚ºå–®ä¸€ location é™£åˆ—
        function flattenLocations(locationsArray) {
            if (!Array.isArray(locationsArray)) return null;
            const result = [];
            for (const item of locationsArray) {
                if (item.location && Array.isArray(item.location)) {
                    result.push(...item.location);
                } else if (item.location) {
                    result.push(item.location);
                }
            }
            return result.length > 0 ? result : null;
        }

        function populateSelect() {
            const locSelect = document.getElementById('locationSelect');
            locSelect.innerHTML = '';
            
            currentData.forEach((loc, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = loc.locationName;
                locSelect.appendChild(option);
            });

            // é è¨­é¸å°åŒ—
            let defaultIdx = 0;
            const targetCity = 'è‡ºåŒ—å¸‚'; 
            const foundIdx = currentData.findIndex(l => l.locationName === targetCity);
            if (foundIdx !== -1) defaultIdx = foundIdx;

            locSelect.value = defaultIdx;
            locSelect.disabled = false;
        }

        function renderCards() {
            const index = document.getElementById('locationSelect').value;
            const location = currentData[index];
            const container = document.getElementById('forecastContainer');
            const datasetType = document.getElementById('typeSelect').value;

            if (!location) return;

            let html = '';
            const elements = location.weatherElement;
            const isDailyMode = (datasetType === 'F-C0032-007'); 

            // æ‰¾å‡ºé—œéµå› å­ (æ”¯æ´å¤šç¨®å‘½å)
            const wx = getEl(elements, ['Wx', 'WeatherDescription']);
            const minT = getEl(elements, ['MinT', 'MinTemperature']); 
            const maxT = getEl(elements, ['MaxT', 'MaxTemperature']);
            const pop = getEl(elements, ['PoP12h', 'PoP6h', 'PoP', 'ProbabilityOfPrecipitation']);

            if (!wx || !wx.time) {
                container.innerHTML = '<div class="loading">æ­¤åœ°é»æš«ç„¡è©³ç´°é å ±æ•¸æ“š</div>';
                return;
            }

            for(let i=0; i<wx.time.length; i++) {
                const time = wx.time[i];
                if (isDailyMode) {
                    const startH = new Date(time.startTime).getHours();
                    if (startH >= 18 || startH < 6) continue; 
                }

                html += createCard(
                    time.startTime, 
                    time.endTime, 
                    getVal(wx, i), 
                    getVal(minT, i), 
                    getVal(maxT, i), 
                    pop ? getVal(pop, i) : null,
                    isDailyMode
                );
            }
            container.innerHTML = html;
            const updateTime = new Date().toLocaleString('zh-TW');
            document.getElementById('updateTime').innerHTML = `æœ€å¾Œæ›´æ–°ï¼š${updateTime}`;
        }

        function createCard(startTimeStr, endTimeStr, weather, minT, maxT, pop, isDailyMode) {
            const start = new Date(startTimeStr);
            const dateStr = `${start.getMonth()+1}/${start.getDate()}`;
            const dayName = getDayName(start.getDay());
            
            let icon = '<i class="fas fa-cloud"></i>';
            if (weather.includes('æ™´')) icon = '<i class="fas fa-sun" style="color:orange"></i>';
            if (weather.includes('å¤šé›²')) icon = '<i class="fas fa-cloud-sun" style="color:#f9a825"></i>';
            if (weather.includes('é™°')) icon = '<i class="fas fa-cloud" style="color:#90a4ae"></i>';
            if (weather.includes('é›¨')) icon = '<i class="fas fa-cloud-showers-heavy" style="color:#42a5f5"></i>';
            if (weather.includes('é›·')) icon = '<i class="fas fa-bolt" style="color:#ffeb3b"></i>';
            if (weather.includes('é›ª')) icon = '<i class="fas fa-snowflake" style="color:#81d4fa"></i>';
            
            let timeDesc = dayName;
            let isNight = false;

            if (!isDailyMode && endTimeStr) {
                const end = new Date(endTimeStr);
                const h1 = start.getHours();
                const h2 = end.getHours();
                if (h1 >= 18 || h1 < 6) isNight = true;
                const h1Str = h1.toString().padStart(2, '0');
                const h2Str = h2.toString().padStart(2, '0');
                timeDesc = `${dayName}<br><span style="font-size:0.85em; font-weight:normal;">${h1Str}:00 - ${h2Str}:00</span>`;
            }

            let popHtml = '<div class="rain" style="opacity:0;">-</div>';
            if (pop && pop !== ' ' && pop !== 'null' && pop !== '--') {
                popHtml = `<div class="rain"><i class="fas fa-umbrella"></i> ${pop}%</div>`;
            }

            return `
                <div class="forecast-card ${isNight ? 'night-card' : ''}">
                    <div class="date">${dateStr}</div>
                    <div class="day-name">${timeDesc}</div>
                    <div class="weather-icon">${icon}</div>
                    <div class="weather-desc">${weather}</div>
                    <div class="temp">${minT}Â° - ${maxT}Â°</div>
                    ${popHtml}
                </div>
            `;
        }

        function getEl(elements, names) {
            if(!elements) return null;
            for (const name of names) {
                const found = elements.find(e => e.elementName === name);
                if (found) return found;
            }
            return null;
        }

        // å¢å¼·ç‰ˆæ•¸å€¼è®€å– (æ”¯æ´ parameterName, value, parameterValue)
        function getVal(element, index) {
            if (!element || !element.time || !element.time[index]) return '--';
            const valObj = element.time[index].elementValue || element.time[index].parameter;
            
            if (Array.isArray(valObj)) {
                return valObj[0].value || valObj[0].parameterName;
            }
            // å…¨çƒé å ±æœ‰æ™‚å€™ç”¨ parameterValue
            return valObj?.parameterName || valObj?.value || valObj?.parameterValue || '--';
        }

        function getDayName(idx) {
            return ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'][idx];
        }

        init();
    </script>
</body>
</html>