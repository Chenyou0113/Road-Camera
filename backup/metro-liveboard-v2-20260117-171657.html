<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å°æ·é‹æ™ºæ…§çœ‹æ¿ â€§ æ•¸ä½å„€è¡¨æ¿</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/dark-mode.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Roboto:wght@700;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; background: #f4f7f9; color: #333; min-height: 100vh; padding-bottom: 50px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        /* --- ğŸš€ ä¸ŠåŠéƒ¨ï¼šå‹•æ…‹å„€è¡¨æ¿å€åŸŸ --- */
        .hero-section {
            background: linear-gradient(135deg, #1a237e 0%, #00bcd4 100%);
            padding: 40px 0 100px 0;
            color: white;
            text-align: center;
            clip-path: ellipse(150% 100% at 50% 0%);
        }
        .hero-section h1 { font-size: 2.5rem; font-weight: 900; letter-spacing: 2px; margin-bottom: 10px; text-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .hero-section p { opacity: 0.9; font-size: 1.1rem; margin-bottom: 30px; }

        .stats-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: -60px;
            position: relative;
            z-index: 10;
        }
        .stat-badge {
            background: white;
            color: #333;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 150px;
        }
        .stat-badge .val { display: block; font-size: 1.8rem; font-weight: 900; color: #00bcd4; font-family: 'Roboto'; }
        .stat-badge .label { font-size: 0.8rem; color: #888; font-weight: 700; }

        /* --- ğŸš‡ ç³»çµ±é¸æ“‡ç¶²æ ¼ --- */
        .system-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 80px 0 30px 0;
        }
        .sys-card {
            background: white;
            padding: 20px 10px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .sys-card i { font-size: 2rem; margin-bottom: 10px; display: block; }
        .sys-card span { font-weight: 900; font-size: 1rem; }
        
        .sys-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        
        /* ç³»çµ±ä»£è¡¨è‰² */
        .sys-trtc { color: #0070bd; } .sys-card.active.sys-trtc { border-color: #0070bd; background: #e3f2fd; }
        .sys-krtc { color: #e3002c; } .sys-card.active.sys-krtc { border-color: #e3002c; background: #ffebee; }
        .sys-tmrt { color: #b2d235; } .sys-card.active.sys-tmrt { border-color: #b2d235; background: #f9fbe7; }
        .sys-tymc { color: #8246af; } .sys-card.active.sys-tymc { border-color: #8246af; background: #f3e5f5; }
        .sys-klrt { color: #008010; } .sys-card.active.sys-klrt { border-color: #008010; background: #e8f5e9; }
        .sys-ntmc { color: #0096cc; } .sys-card.active.sys-ntmc { border-color: #0096cc; background: #e1f5fe; }

        /* --- ğŸ” æ™ºæ…§æ§åˆ¶åˆ— --- */
        .control-panel {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        .control-panel select { flex: 1; min-width: 200px; padding: 12px; border-radius: 10px; border: 2px solid #edf2f7; font-weight: 700; outline: none; transition: border-color 0.3s; }
        .control-panel select:focus { border-color: #00bcd4; }
        .btn-query { background: #00bcd4; color: white; padding: 12px 30px; border: none; border-radius: 10px; font-weight: 900; cursor: pointer; transition: all 0.3s; }
        .btn-query:hover { background: #0097a7; transform: scale(1.05); }
        .btn-pids { background: #9c27b0; color: white; padding: 12px 20px; border: none; border-radius: 10px; font-weight: 900; cursor: pointer; }

        /* --- ğŸ“Š çœ‹æ¿å€åŸŸæ¨£å¼ --- */
        .arrival-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .platform-group { background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; }
        .platform-header { padding: 15px 20px; color: white; font-weight: 900; font-size: 1.2rem; display: flex; justify-content: space-between; }
        .train-card { display: flex; align-items: center; padding: 20px; border-bottom: 1px solid #f8f9fa; }
        .train-card:last-child { border-bottom: none; }
        .train-card.imminent { background: #fff5f5; border-left: 5px solid #d32f2f; }
        .train-info-main { flex: 1; }
        .train-dest { font-size: 1.3rem; font-weight: 900; color: #333; margin-bottom: 4px; }
        .train-meta { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #777; }
        .time-val { font-size: 2.2rem; font-weight: 900; color: #00bcd4; font-family: 'Roboto'; }
        .status-arriving { color: #d32f2f; font-weight: 900; animation: pulse 1.5s infinite; }

        /* --- ğŸšª å‡ºå£èˆ‡è¨­æ–½ --- */
        .exits-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; padding: 20px; }
        .exit-card { background: #fcfcfc; border-radius: 12px; padding: 15px; border: 1px solid #eee; border-left: 5px solid #607d8b; }
        .exit-title { font-weight: 900; color: #333; margin-bottom: 5px; }
        .exit-desc { font-size: 0.85rem; color: #666; margin-bottom: 10px; }
        .equip-badge { font-size: 0.75rem; background: #e0e0e0; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        
        /* éŸ¿æ‡‰å¼å¾®èª¿ */
        @media (max-width: 768px) {
            .hero-section h1 { font-size: 1.8rem; }
            .stats-container { gap: 10px; }
            .stat-badge { min-width: 100px; padding: 10px; }
            .control-panel { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <div class="hero-section">
        <div class="container">
            <h1><i class="fas fa-satellite-dish"></i> å…¨å°æ·é‹æ™ºæ…§å„€è¡¨æ¿</h1>
            <p>å¯¦æ™‚ç›£æ¸¬å…¨å°å…­å¤§æ·é‹ç³»çµ±é‹è¡Œç‹€æ…‹</p>
        </div>
    </div>

    <div class="container">
        <!-- çµ±è¨ˆæ•¸æ“šåˆ— -->
        <div class="stats-container">
            <div class="stat-badge">
                <span class="val" id="stat-trains">--</span>
                <span class="label">é‹è¡Œä¸­åˆ—è»Š</span>
            </div>
            <div class="stat-badge">
                <span class="val" id="stat-stations">--</span>
                <span class="label">å·²é€£ç·šè»Šç«™</span>
            </div>
            <div class="stat-badge">
                <span class="val" id="stat-alerts">OK</span>
                <span class="label">ç³»çµ±ç‡Ÿé‹ç‹€æ…‹</span>
            </div>
        </div>

        <!-- ç³»çµ±é¸æ“‡ç¶²æ ¼ -->
        <div class="system-grid">
            <div class="sys-card sys-trtc" data-sys="TRTC" onclick="selectSystem('TRTC')">
                <i class="fas fa-subway"></i><span>å°åŒ—æ·é‹</span>
            </div>
            <div class="sys-card sys-krtc" data-sys="KRTC" onclick="selectSystem('KRTC')">
                <i class="fas fa-train-subway"></i><span>é«˜é›„æ·é‹</span>
            </div>
            <div class="sys-card sys-tmrt" data-sys="TMRT" onclick="selectSystem('TMRT')">
                <i class="fas fa-train-tram"></i><span>å°ä¸­æ·é‹</span>
            </div>
            <div class="sys-card sys-tymc" data-sys="TYMC" onclick="selectSystem('TYMC')">
                <i class="fas fa-plane-departure"></i><span>æ¡ƒåœ’æ·é‹</span>
            </div>
            <div class="sys-card sys-klrt" data-sys="KLRT" onclick="selectSystem('KLRT')">
                <i class="fas fa-train"></i><span>é«˜é›„è¼•è»Œ</span>
            </div>
            <div class="sys-card sys-ntmc" data-sys="NTMC" onclick="selectSystem('NTMC')">
                <i class="fas fa-road"></i><span>æ–°åŒ—æ·é‹</span>
            </div>
        </div>

        <!-- æ™ºæ…§æ§åˆ¶åˆ— -->
        <div class="control-panel" id="stationSelector" style="display:none;">
            <select id="lineSelect" onchange="onLineChange()"><option>è¼‰å…¥ä¸­...</option></select>
            <select id="stationSelect"><option>é¸æ“‡è»Šç«™</option></select>
            <button class="btn-query" onclick="queryLiveboard()"><i class="fas fa-bolt"></i> ç›£æ¸¬å³æ™‚çœ‹æ¿</button>
            <button class="btn-pids" onclick="openPIDS()"><i class="fas fa-desktop"></i> PIDS</button>
        </div>

        <!-- çœ‹æ¿è¼¸å‡ºå€åŸŸ -->
        <div id="liveboardContainer" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
                <h2 id="stationHeader" style="font-weight:900; font-size:1.8rem; display:flex; align-items:center; gap:15px;">
                    <span id="ui-sys-name">ç³»çµ±</span> <span id="ui-st-name">è»Šç«™</span>
                    <div id="mainMapContainer"></div>
                </h2>
                <div id="updateTime" style="font-weight:700; color:#00bcd4;">--</div>
            </div>

            <div id="arrivalGrid" class="arrival-grid"></div>

            <!-- è»Šç«™è©³æƒ…é¢æ¿ -->
            <div id="extraArea" style="margin-top:40px;">
                <div class="platform-group">
                    <div class="platform-header" style="background:#607d8b;">è»Šç«™å°è¦½èˆ‡è¨­æ–½æœå‹™</div>
                    <div id="exitsList" class="exits-grid"></div>
                    <div id="facilitiesList" class="exits-grid" style="border-top:1px solid #eee; background:white;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://metro-api-worker.xiaoyouwu5-fd3.workers.dev';
        let currentSystem = '', currentStationId = '', allStationData = [];
        const sysNames = { TRTC:'å°åŒ—æ·é‹', KRTC:'é«˜é›„æ·é‹', TMRT:'å°ä¸­æ·é‹', TYMC:'æ¡ƒåœ’æ·é‹', KLRT:'é«˜é›„è¼•è»Œ', NTMC:'æ–°åŒ—æ·é‹', TRTCMG:'è²“ç©ºçºœè»Š' };

        // ğŸš€ 1. é¸æ“‡ç³»çµ±
        async function selectSystem(sys) {
            currentSystem = sys;
            document.querySelectorAll('.sys-card').forEach(c => c.classList.toggle('active', c.dataset.sys === sys));
            document.getElementById('stationSelector').style.display = 'flex';
            
            // æŠ“å–è»Šç«™
            const res = await fetch(`${WORKER_URL}/api/stations?sys=${sys}`);
            allStationData = await res.json();
            
            // æ›´æ–°å„€è¡¨æ¿çµ±è¨ˆ
            document.getElementById('stat-stations').textContent = allStationData.length;
            
            // æ¸²æŸ“è·¯ç·šé¸å–® (åŒ…å«æ’åºé‚è¼¯)
            const lineSelect = document.getElementById('lineSelect');
            const lines = Array.from(new Set(allStationData.map(s => s.line.name)));
            const order = { 'TRTC': { 'æ–‡æ¹–ç·š': 1, 'æ·¡æ°´ä¿¡ç¾©ç·š': 2, 'æ¾å±±æ–°åº—ç·š': 3, 'ä¸­å’Œæ–°è˜†ç·š': 4, 'æ¿å—ç·š': 5, 'ç’°ç‹€ç·š': 6 } };
            lines.sort((a, b) => (order[sys]?.[a] || 99) - (order[sys]?.[b] || 99));
            
            lineSelect.innerHTML = '<option value="">é¸æ“‡è·¯ç·š</option>' + lines.map(l => `<option value="${l}">${l}</option>`).join('');
            document.getElementById('stationSelect').innerHTML = '<option>é¸æ“‡è»Šç«™</option>';
        }

        // ğŸš€ 2. è·¯ç·šè®Šæ›´
        function onLineChange() {
            const line = document.getElementById('lineSelect').value;
            const stations = allStationData.filter(s => s.line.name === line);
            document.getElementById('stationSelect').innerHTML = stations.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('');
        }

        // ğŸš€ 3. æŸ¥è©¢çœ‹æ¿
        async function queryLiveboard() {
            const sel = document.getElementById('stationSelect');
            currentStationId = sel.value;
            const stationName = sel.options[sel.selectedIndex].text.split(' (')[0];
            
            // æŠ“å–å³æ™‚è³‡æ–™
            const res = await fetch(`${WORKER_URL}/api/liveboard?sys=${currentSystem}`);
            const data = await res.json();
            
            // æŠ“å–ç¸½é‹è¡Œåˆ—è»Šæ•¸çµ±è¨ˆ
            document.getElementById('stat-trains').textContent = data.length;

            // åš´æ ¼éæ¿¾è»Šç«™
            const currentLineId = allStationData.find(s => s.id === currentStationId)?.line.id;
            const filtered = data.filter(t => (t.StationID === currentStationId || t.StationID.endsWith(currentStationId)) && (!currentLineId || t.LineID === currentLineId));
            
            renderçœ‹æ¿(filtered, stationName);
            renderæ·±åº¦è³‡è¨Š(currentSystem, currentStationId);
        }

        // ğŸš€ 4. æ¸²æŸ“çœ‹æ¿å¡ç‰‡
        function renderçœ‹æ¿(trains, stName) {
            document.getElementById('liveboardContainer').style.display = 'block';
            document.getElementById('ui-sys-name').textContent = sysNames[currentSystem];
            document.getElementById('ui-st-name').textContent = stName;
            document.getElementById('updateTime').textContent = `æœ€å¾Œæ›´æ–°: ${new Date().toLocaleTimeString()}`;

            const grid = document.getElementById('arrivalGrid');
            const groups = {};
            trains.forEach(t => {
                const dir = t.Direction !== undefined ? t.Direction : t.TripHeadSign;
                if (!groups[dir]) groups[dir] = [];
                groups[dir].push(t);
            });

            grid.innerHTML = Object.entries(groups).map(([dir, ts]) => {
                ts.sort((a,b) => a.EstimateTime - b.EstimateTime);
                const first = ts[0];
                const dest = first.DestinationStationName?.Zh_tw || first.TripHeadSign || "æœªçŸ¥";
                return `
                    <div class="platform-group">
                        <div class="platform-header" style="background:${first.LineColor || '#455a64'}">å¾€ ${dest}</div>
                        ${ts.slice(0,3).map(t => {
                            const secs = t.EstimateTime;
                            const mins = Math.floor(secs / 60);
                            let timeHtml = secs <= 45 ? '<span class="status-arriving">â— é€²ç«™ä¸­</span>' : 
                                           secs <= 90 ? '<span style="color:#f58220; font-weight:900;">å³å°‡é€²ç«™</span>' : 
                                           `<span class="time-val">${mins}</span><span style="font-weight:700; color:#888; margin-left:5px;">åˆ†</span>`;
                            return `
                                <div class="train-card ${secs <= 45 ? 'imminent' : ''}">
                                    <div class="train-info-main">
                                        <div class="train-dest">${t.DestinationStationName?.Zh_tw || 'æ·é‹åˆ—è»Š'}</div>
                                        <div class="train-meta"><span style="color:${t.LineColor}; font-weight:900;">${t.LineID}ç·š</span> â€§ ${t.TrainTypeName?.Zh_tw || 'æ™®é€šè»Š'}</div>
                                    </div>
                                    <div class="train-time-area">${timeHtml}</div>
                                </div>`;
                        }).join('')}
                    </div>`;
            }).join('') || '<div style="grid-column:1/-1; text-align:center; padding:50px; background:white; border-radius:20px;">ç›®å‰è©²ç«™ç„¡å³æ™‚åˆ—è»Šè³‡è¨Š</div>';
        }

        // ğŸš€ 5. æ¸²æŸ“æ·±åº¦è³‡è¨Š (å‡ºå£ã€è¨­æ–½ã€åœ°åœ–)
        async function renderæ·±åº¦è³‡è¨Š(sys, sid) {
            // è»Šç«™åœ°åœ–
            const resMap = await fetch(`${WORKER_URL}/api/transfer?sys=${sys}&sid=${sid}`);
            const mapData = await resMap.json();
            document.getElementById('mainMapContainer').innerHTML = mapData.maps?.[0] ? 
                `<a href="${mapData.maps[0].MapURL}" target="_blank" style="background:#ff9800; color:white; padding:5px 12px; border-radius:8px; font-size:0.8rem; text-decoration:none;"><i class="fas fa-map"></i> å¹³é¢åœ–</a>` : '';

            // å‡ºå£è³‡è¨Š
            const resExit = await fetch(`${WORKER_URL}/api/exits?sys=${sys}&sid=${sid}`);
            const exits = await resExit.json();
            document.getElementById('exitsList').innerHTML = exits.map(ex => `
                <div class="exit-card">
                    <div class="exit-title">${ex.name} ${ex.floor?`<small>[${ex.floor}]</small>`:''}</div>
                    <div class="exit-desc">${ex.desc || 'ç„¡æè¿°'}</div>
                    <div style="display:flex;">
                        ${ex.equip.elevator ? '<span class="equip-badge">â™¿é›»æ¢¯</span>' : ''}
                        ${ex.equip.escalator ? '<span class="equip-badge">ğŸªœæ‰‹æ‰¶æ¢¯</span>' : ''}
                    </div>
                </div>`).join('') || '<p style="padding:20px; color:#999;">æš«ç„¡å‡ºå£è©³ç´°è³‡æ–™</p>';

            // è¨­æ–½è³‡è¨Š
            const resFac = await fetch(`${WORKER_URL}/api/facilities?sys=${sys}&sid=${sid}`);
            const facs = await resFac.json();
            document.getElementById('facilitiesList').innerHTML = facs.map(f => `
                <div class="exit-card" style="border-left-color:#009688;">
                    <div class="exit-title">${f.FacilityName?.Zh_tw || f.FacilityType}</div>
                    <div class="exit-desc">${f.LocationDescription}</div>
                </div>`).join('') || '<p style="padding:20px; color:#999;">æš«ç„¡ç«™å…§è¨­æ–½è³‡è¨Š</p>';
        }

        function openPIDS() {
            if(!currentStationId) return alert('è«‹å…ˆé¸æ“‡è»Šç«™');
            window.open(`metro-pids.html?system=${currentSystem}&station=${currentStationId}`, '_blank');
        }
    </script>
</body>
</html>
