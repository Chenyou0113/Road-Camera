<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METRO PIDS - Universal PC Edition</title>
    <script src="assets/config.js"></script>
    <script src="assets/tdx-api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700;900&family=Roboto+Condensed:wght@700&display=swap');

        :root {
            --bg-black: #000000;
            --row-bg: #3d4348;
            --text-main: #ffffff;
            --text-en: #b0b0b0;
            --marquee-yellow: #ffeb3b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* ç§»é™¤äº† cursor: noneï¼Œä¿ç•™æ»‘é¼ æŒ‡æ¨™ */
        }

        body {
            background-color: var(--bg-black);
          width: 100vw;
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .pids-wrapper {
            width: 100%;
            height: 100%;
            padding: 1.5vh 2.5vw;
            display: flex;
            flex-direction: column;
        }

        /* ------------------ é ‚éƒ¨èˆ‡ä¸­é–“è³‡è¨Šå€ ------------------ */
        .section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding-bottom: 1.5vh;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1.6fr 3.2fr 2.4fr 1fr;
            align-items: center;
        }

        .header {
            padding: 0.5vh 0;
            align-items: end;
        }

        .dir-title { font-size: 3.5vh; font-weight: 900; color: #fff; }
        .label { font-size: 2.8vh; font-weight: 700; color: #fff; text-align: center; }
        .en-sm { font-size: 0.6em; color: var(--text-en); margin-left: 8px; font-weight: 700; }

        .row {
            background-color: var(--row-bg);
            border-radius: 0.8vh;
            height: 17.5vh;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
        }

        .time-cell {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 11vh;
            font-weight: 700;
            color: #fff;
            padding-left: 2.5vw;
        }

        .dest-cell {
            display: flex;
            align-items: center;
            gap: 1.5vw;
        }

        .st-id {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 11vh;
            font-weight: 700;
            color: #fff;
        }

        .st-names { display: flex; flex-direction: column; line-height: 1.1; }
        .zh { font-size: 5.2vh; font-weight: 900; color: #fff; }
        .en-st { font-size: 2.4vh; font-weight: 700; color: var(--text-en); }

        /* è»Šç¨®æ¨™ç±¤æ¨£å¼ */
        .badge {
            width: 19vw;
            height: 11.5vh;
            border-radius: 0.5vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }
        .badge .zh-t { font-size: 3.8vh; font-weight: 900; color: #fff; }
        .badge .en-t { font-size: 2.2vh; font-weight: 700; color: #fff; }

        /* æœˆå°æ–¹å¡Šæ¨£å¼ */
        .plat-box {
            background-color: #7a7e83;
            width: 8vw;
            height: 14vh;
            border-radius: 1.8vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 11vh;
            font-weight: 900;
            color: #fff;
            margin: 0 auto;
        }

        /* ------------------ åº•éƒ¨è·‘é¦¬ç‡ˆèˆ‡æ™‚é˜ ------------------ */
        .footer {
            height: 10vh;
            display: flex;
            align-items: center;
            background-color: var(--bg-black);
            border-top: 2px solid #333;
            padding: 0 1.5vw;
            position: relative;
        }

        .marquee-window {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .marquee-text {
            display: inline-block;
            font-size: 5.5vh;
            font-weight: 700;
            color: var(--marquee-yellow);
            padding-left: 100%;
            animation: scroll-text 30s linear infinite;
        }

        .clock {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 7vh;
            color: #fff;
            font-weight: 700;
            padding-left: 40px;
            flex-shrink: 0;
            background-color: var(--bg-black);
            position: relative;
            z-index: 5;
        }

        .clock span { animation: blink 2s step-end infinite; }

        @keyframes scroll-text {
            0% { transform: translateX(0); }
            100% { transform: translateX(-200%); }
        }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div class="pids-wrapper" id="pids-content">
        <!-- è³‡æ–™ç”±ä¸‹æ–¹ JavaScript å‹•æ…‹ç”¢ç”Ÿ -->
    </div>

    <script>
        /**
         * TDX API æ•´åˆ - å‹•æ…‹ç²å–å³æ™‚åˆ°ç«™è³‡æ–™
         * tdxApi å·²åœ¨ tdx-api.js ä¸­åˆå§‹åŒ–
         */
        let autoUpdateInterval = null;

        // PIDS é…ç½® - åŒ…å«éœæ…‹è³‡æ–™å’Œ API è¨­å®š
        const pidsConfig = {
            TRTC: {
                name: 'å°åŒ—æ·é‹',
                cityCode: 'TRTC',
                tdxCityName: 'Taipei',  // TDX API ä½¿ç”¨çš„åŸå¸‚åç¨±
                stationId: '08',  // é è¨­å°åŒ—è»Šç«™
                stationName: 'å°åŒ—è»Šç«™',
                lineColor: '#005ab5',
                marquee: "ã€å°åŒ—æ·é‹ã€‘æœ¬ç«™å„é …è¨­æ–½å‡æ­£å¸¸ä½¿ç”¨ã€‚ç¥æ‚¨æ—…é€”æ„‰å¿«ã€‚"
            },
            TYMC: {
                name: 'æ¡ƒåœ’æ·é‹',
                cityCode: 'TYMC',
                tdxCityName: 'Taoyuan',
                stationId: 'A18',  // é è¨­é«˜éµæ¡ƒåœ’ç«™
                stationName: 'é«˜éµæ¡ƒåœ’',
                lineColor: '#a855f7',
                marquee: "ã€ç³»çµ±è¨Šæ¯ã€‘æ¡ƒåœ’æ·é‹å…¨ç·šç‡Ÿé‹æ­£å¸¸ã€‚ Passenger Information: All lines are operating normally. ã€ä¹˜è»Šæé†’ã€‘è«‹å‹¿åœ¨è»Šç«™åŠè»Šå»‚å…§é£²é£Ÿã€‚"
            },
            NTDLRT: {
                name: 'æ–°åŒ—æ·é‹',
                cityCode: 'NTDLRT',
                tdxCityName: 'NewTaipei',
                stationId: 'F03',  // é è¨­é ­å‰åº„ç«™
                stationName: 'é ­å‰åº„',
                lineColor: '#fbbf24',
                marquee: "ã€æ–°åŒ—æ·é‹ã€‘ä¸‰é¶¯ç·šèˆ‡æ·¡æµ·è¼•è»Œç«­èª ç‚ºæ‚¨æœå‹™ã€‚"
            },
            TMRT: {
                name: 'å°ä¸­æ·é‹',
                cityCode: 'TMRT',
                tdxCityName: 'Taichung',
                stationId: 'G08',  // é è¨­å¸‚æ”¿åºœç«™
                stationName: 'å¸‚æ”¿åºœ',
                lineColor: '#10b981',
                marquee: "ã€å°ä¸­æ·é‹ã€‘ç¶ ç·šå…¨ç·šæ­£å¸¸ç‡Ÿé‹ï¼Œæ„Ÿè¬æ‚¨çš„æ­ä¹˜ã€‚"
            },
            KRTC: {
                name: 'é«˜é›„æ·é‹',
                cityCode: 'KRTC',
                tdxCityName: 'Kaohsiung',
                stationId: 'R11',  // é è¨­é«˜é›„è»Šç«™
                stationName: 'é«˜é›„è»Šç«™',
                lineColor: '#ef4444',
                marquee: "ã€é«˜é›„æ·é‹ã€‘ç´…æ©˜ç·šå…¨ç·šæ­£å¸¸ç‡Ÿé‹ã€‚Kaohsiung MRT services are operating normally."
            },
            KLRT: {
                name: 'é«˜é›„è¼•è»Œ',
                cityCode: 'KLRT',
                tdxCityName: 'Kaohsiung',
                stationId: 'C1',  // é è¨­ç±¬ä»”å…§ç«™
                stationName: 'ç±¬ä»”å…§',
                lineColor: '#f97316',
                marquee: "ã€é«˜é›„è¼•è»Œã€‘ç’°ç‹€è¼•è»Œç‚ºæ‚¨æœå‹™ã€‚è«‹æ³¨æ„è¼•è»Œå„ªå…ˆè™ŸèªŒã€‚"
            }
        };

        // ç•¶å‰ç³»çµ±è¨­å®š
        let currentSystem = 'KRTC';
        let currentConfig = pidsConfig[currentSystem];

        /**
         * å¾ TDX API ç²å–å³æ™‚åˆ°ç«™è³‡æ–™
         */
        async function fetchLiveData() {
            try {
                const token = await tdxApi.getAccessToken();
                const config = pidsConfig[currentSystem];
                
                // ä½¿ç”¨ tdxCityName è€Œé cityCode
                const cityName = config.tdxCityName || config.cityCode;
                const url = `https://tdx.transportdata.tw/api/basic/v2/Rail/Metro/LiveBoard/${cityName}/${config.stationId}?%24format=JSON`;
                
                console.log(`ğŸš‡ API è«‹æ±‚: ${cityName} ç«™å° ${config.stationId}`);

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`TDX API éŒ¯èª¤: ${response.status}`);
                }

                const data = await response.json();
                console.log('âœ… å³æ™‚è³‡æ–™ç²å–æˆåŠŸ:', data);
                return data;

            } catch (error) {
                console.error('âŒ ç²å–å³æ™‚è³‡æ–™å¤±æ•—:', error);
                return null;
            }
        }

        /**
         * å°‡ TDX è³‡æ–™è½‰æ›ç‚º PIDS é¡¯ç¤ºæ ¼å¼
         */
        function transformTDXData(tdxData) {
            if (!tdxData || tdxData.length === 0) {
                return null;
            }

            const sections = {};
            const now = new Date();

            tdxData.forEach(train => {
                const destId = train.DestinationStationID;
                const destName = train.DestinationStaionName || train.DestinationStationID;
                const direction = train.TripHeadSign || 'æœªçŸ¥æ–¹å‘';
                const arrivalTime = train.EstimateTime;

                // è¨ˆç®—åˆ°ç«™æ™‚é–“
                let displayTime = '--:--';
                if (arrivalTime) {
                    const arrivalDate = new Date(arrivalTime);
                    const hours = String(arrivalDate.getHours()).padStart(2, '0');
                    const minutes = String(arrivalDate.getMinutes()).padStart(2, '0');
                    displayTime = `${hours}:${minutes}`;
                }

                // æŒ‰æ–¹å‘åˆ†çµ„
                if (!sections[direction]) {
                    sections[direction] = {
                        dirZh: direction,
                        dirEn: direction,
                        trains: []
                    };
                }

                sections[direction].trains.push({
                    time: displayTime,
                    id: destId || 'N/A',
                    zh: destName,
                    en: destName,
                    typeZh: 'æ™®é€šè»Š',
                    typeEn: 'Commuter',
                    typeColor: currentConfig.lineColor,
                    plat: train.Platform || '?'
                });
            });

            return {
                sections: Object.values(sections),
                marquee: currentConfig.marquee
            };
        }

        /**
         * æ¸²æŸ“ PIDS é¡¯ç¤ºç•«é¢
         */
        function renderPIDS(data) {
            const container = document.getElementById('pids-content');
            let html = '';

            if (!data || !data.sections || data.sections.length === 0) {
                html = '<div style="color: white; text-align: center; padding: 50px; font-size: 3vh;">è¼‰å…¥ä¸­...</div>';
                container.innerHTML = html;
                return;
            }

            data.sections.forEach(sec => {
                // åªé¡¯ç¤ºå‰ 2 ç­è»Š
                const trains = sec.trains.slice(0, 2);

                html += `
                <div class="section">
                    <div class="grid-layout header">
                        <div class="dir-title">${sec.dirZh} <span class="en-sm">${sec.dirEn}</span></div>
                        <div class="label">ç›®çš„åœ° <span class="en-sm">Destn.</span></div>
                        <div class="label">è»Šç¨® <span class="en-sm">Train</span></div>
                        <div class="label">æœˆå° <span class="en-sm">Plat.</span></div>
                    </div>`;
                
                trains.forEach(t => {
                    html += `
                    <div class="grid-layout row">
                        <div class="time-cell">${t.time}</div>
                        <div class="dest-cell">
                            <div class="st-id">${t.id}</div>
                            <div class="st-names">
                                <span class="zh">${t.zh}</span>
                                <span class="en-st">${t.en}</span>
                            </div>
                        </div>
                        <div class="cell-type">
                            <div class="badge" style="background-color: ${t.typeColor}">
                                <span class="zh-t">${t.typeZh}</span>
                                <span class="en-t">${t.typeEn}</span>
                            </div>
                        </div>
                        <div class="cell-plat"><div class="plat-box">${t.plat}</div></div>
                    </div>`;
                });
                html += `</div>`;
            });

            // åº•éƒ¨è·‘é¦¬ç‡ˆ
            html += `
            <div class="footer">
                <div class="marquee-window">
                    <div class="marquee-text">${data.marquee}</div>
                </div>
                <div class="clock" id="clock-display">00<span>:</span>00</div>
            </div>`;

            container.innerHTML = html;
        }

        /**
         * æ›´æ–° PIDS è³‡æ–™
         */
        async function updatePIDS() {
            console.log('ğŸ”„ æ›´æ–° PIDS è³‡æ–™...');
            const tdxData = await fetchLiveData();
            
            if (tdxData) {
                const displayData = transformTDXData(tdxData);
                if (displayData) {
                    renderPIDS(displayData);
                }
            }
        }

        /**
         * æ™‚é˜æ›´æ–°
         */
        function updateClock() {
            const el = document.getElementById('clock-display');
            if (!el) return;
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            el.innerHTML = `${h}<span>:</span>${m}`;
        }

        /**
         * å•Ÿå‹•è‡ªå‹•æ›´æ–°
         */
        function startAutoUpdate() {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
            }
            // æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡
            autoUpdateInterval = setInterval(updatePIDS, 30000);
        }

        /**
         * å¾ URL åƒæ•¸è®€å–è¨­å®š
         */
        function loadConfigFromURL() {
            const params = new URLSearchParams(window.location.search);
            const system = params.get('system');
            const station = params.get('station');

            if (system && pidsConfig[system.toUpperCase()]) {
                currentSystem = system.toUpperCase();
                currentConfig = pidsConfig[currentSystem];
                console.log(`âœ… åˆ‡æ›åˆ°ç³»çµ±: ${currentConfig.name} (${currentSystem})`);
            } else if (system) {
                console.warn(`âš ï¸ æœªçŸ¥çš„ç³»çµ±ä»£ç¢¼: ${system}ï¼Œä½¿ç”¨é è¨­ç³»çµ±`);
            }

            if (station) {
                currentConfig.stationId = station;
                console.log(`âœ… è¨­å®šè»Šç«™ ID: ${station}`);
            }

            console.log('ğŸ“ ç•¶å‰é…ç½®:', currentConfig);
        }

        /**
         * åˆå§‹åŒ–
         */
        document.addEventListener('DOMContentLoaded', async () => {
            loadConfigFromURL();
            await updatePIDS();
            startAutoUpdate();
            setInterval(updateClock, 1000);
            updateClock();
        });

        /**
         * èˆŠç‰ˆéœæ…‹è³‡æ–™é…ç½®ï¼ˆå‚™ç”¨ï¼‰
         */
        /**
         * èˆŠç‰ˆéœæ…‹è³‡æ–™é…ç½®ï¼ˆå‚™ç”¨ï¼‰
         */
        const legacyConfig = {
            // æ¡ƒåœ’æ·é‹ç¯„ä¾‹
            TYMC: {
                sections: [
                    {
                        dirZh: "å¾€ä¸­å£¢", dirEn: "To Zhongli",
                        trains: [
                            { time: "10:18", id: "A22", zh: "è€è¡—æºª", en: "Laojie River", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#0076e4", plat: "2" },
                            { time: "10:25", id: "A13", zh: "æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ", en: "Airport Terminal 2", typeZh: "ç›´é”è»Š", typeEn: "Express", typeColor: "#d85fb6", plat: "2" }
                        ]
                    },
                    {
                        dirZh: "å¾€å°åŒ—", dirEn: "To Taipei",
                        trains: [
                            { time: "10:17", id: "A1", zh: "å°åŒ—è»Šç«™", en: "Taipei Main Station", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#0076e4", plat: "3" },
                            { time: "10:26", id: "A1", zh: "å°åŒ—è»Šç«™", en: "Taipei Main Station", typeZh: "ç›´é”è»Š", typeEn: "Express", typeColor: "#d85fb6", plat: "3" }
                        ]
                    }
                ],
                marquee: "ã€ç³»çµ±è¨Šæ¯ã€‘æ¡ƒåœ’æ·é‹å…¨ç·šç‡Ÿé‹æ­£å¸¸ã€‚ Passenger Information: All lines are operating normally. ã€ä¹˜è»Šæé†’ã€‘è«‹å‹¿åœ¨è»Šç«™åŠè»Šå»‚å…§é£²é£Ÿã€‚"
            },
            // å°åŒ—æ·é‹æ¿å—ç·šç¯„ä¾‹
            TRTC_BL: {
                sections: [
                    {
                        dirZh: "å¾€å—æ¸¯å±•è¦½é¤¨", dirEn: "To Nangang",
                        trains: [
                            { time: "14:32", id: "BL24", zh: "å—æ¸¯å±•è¦½é¤¨", en: "Nangang Exhib. Center", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#005ab5", plat: "1" },
                            { time: "14:38", id: "BL24", zh: "å—æ¸¯å±•è¦½é¤¨", en: "Nangang Exhib. Center", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#005ab5", plat: "1" }
                        ]
                    },
                    {
                        dirZh: "å¾€é ‚åŸ”", dirEn: "To Dingpu",
                        trains: [
                            { time: "14:30", id: "BL01", zh: "é ‚åŸ”", en: "Dingpu", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#005ab5", plat: "2" },
                            { time: "14:35", id: "BL01", zh: "é ‚åŸ”", en: "Dingpu", typeZh: "æ™®é€šè»Š", typeEn: "Commuter", typeColor: "#005ab5", plat: "2" }
                        ]
                    }
                ],
                marquee: "ã€å°åŒ—æ·é‹ã€‘æœ¬ç«™å„é …è¨­æ–½å‡æ­£å¸¸ä½¿ç”¨ã€‚ç¥æ‚¨æ—…é€”æ„‰å¿«ã€‚"
            }
        };

        // èˆŠç‰ˆéœæ…‹åˆå§‹åŒ–å‡½æ•¸ï¼ˆå·²åœç”¨ï¼‰
        /*
        function initPIDS(systemKey) {
            const data = legacyConfig[systemKey];
            renderPIDS(data);
        }
        */
    </script>
</body>
</html>
